/* >>> file start: js/node_modules/angular-route/angular-route.js */
/**
 * @license AngularJS v1.5.8
 * (c) 2010-2016 Google, Inc. http://angularjs.org
 * License: MIT
 */
(function (window, angular) {
  'use strict';

  /* global shallowCopy: true */

  /**
   * Creates a shallow copy of an object, an array or a primitive.
   *
   * Assumes that there are no proto properties for objects.
   */

  function shallowCopy(src, dst) {
    if (isArray(src)) {
      dst = dst || [];

      for (var i = 0, ii = src.length; i < ii; i++) {
        dst[i] = src[i];
      }
    } else if (isObject(src)) {
      dst = dst || {};

      for (var key in src) {
        if (!(key.charAt(0) === '$' && key.charAt(1) === '$')) {
          dst[key] = src[key];
        }
      }
    }

    return dst || src;
  }

  /* global shallowCopy: false */

  // There are necessary for `shallowCopy()` (included via `src/shallowCopy.js`).
  // They are initialized inside the `$RouteProvider`, to ensure `window.angular` is available.
  var isArray,
      isObject,
      ngRouteModule = angular.module('ngRoute', ['ng']).provider('$route', $RouteProvider),
      $routeMinErr = angular.$$minErr('ngRoute');

  /**
   * @ngdoc module
   * @name ngRoute
   * @description
   *
   * # ngRoute
   *
   * The `ngRoute` module provides routing and deeplinking services and directives for angular apps.
   *
   * ## Example
   * See {@link ngRoute.$route#example $route} for an example of configuring and using `ngRoute`.
   *
   *
   * <div doc-module-components="ngRoute"></div>
   */
  /* global -ngRouteModule */


  /**
   * @ngdoc provider
   * @name $routeProvider
   *
   * @description
   *
   * Used for configuring routes.
   *
   * ## Example
   * See {@link ngRoute.$route#example $route} for an example of configuring and using `ngRoute`.
   *
   * ## Dependencies
   * Requires the {@link ngRoute `ngRoute`} module to be installed.
   */
  function $RouteProvider() {
    isArray = angular.isArray;
    isObject = angular.isObject;

    function inherit(parent, extra) {
      return angular.extend(Object.create(parent), extra);
    }

    var routes = {};

    /**
     * @ngdoc method
     * @name $routeProvider#when
     *
     * @param {string} path Route path (matched against `$location.path`). If `$location.path`
     *    contains redundant trailing slash or is missing one, the route will still match and the
     *    `$location.path` will be updated to add or drop the trailing slash to exactly match the
     *    route definition.
     *
     *    * `path` can contain named groups starting with a colon: e.g. `:name`. All characters up
     *        to the next slash are matched and stored in `$routeParams` under the given `name`
     *        when the route matches.
     *    * `path` can contain named groups starting with a colon and ending with a star:
     *        e.g.`:name*`. All characters are eagerly stored in `$routeParams` under the given `name`
     *        when the route matches.
     *    * `path` can contain optional named groups with a question mark: e.g.`:name?`.
     *
     *    For example, routes like `/color/:color/largecode/:largecode*\/edit` will match
     *    `/color/brown/largecode/code/with/slashes/edit` and extract:
     *
     *    * `color: brown`
     *    * `largecode: code/with/slashes`.
     *
     *
     * @param {Object} route Mapping information to be assigned to `$route.current` on route
     *    match.
     *
     *    Object properties:
     *
     *    - `controller` – `{(string|function()=}` – Controller fn that should be associated with
     *      newly created scope or the name of a {@link angular.Module#controller registered
     *      controller} if passed as a string.
     *    - `controllerAs` – `{string=}` – An identifier name for a reference to the controller.
     *      If present, the controller will be published to scope under the `controllerAs` name.
     *    - `template` – `{string=|function()=}` – html template as a string or a function that
     *      returns an html template as a string which should be used by {@link
     *      ngRoute.directive:ngView ngView} or {@link ng.directive:ngInclude ngInclude} directives.
     *      This property takes precedence over `templateUrl`.
     *
     *      If `template` is a function, it will be called with the following parameters:
     *
     *      - `{Array.<Object>}` - route parameters extracted from the current
     *        `$location.path()` by applying the current route
     *
     *    - `templateUrl` – `{string=|function()=}` – path or function that returns a path to an html
     *      template that should be used by {@link ngRoute.directive:ngView ngView}.
     *
     *      If `templateUrl` is a function, it will be called with the following parameters:
     *
     *      - `{Array.<Object>}` - route parameters extracted from the current
     *        `$location.path()` by applying the current route
     *
     *    - `resolve` - `{Object.<string, function>=}` - An optional map of dependencies which should
     *      be injected into the controller. If any of these dependencies are promises, the router
     *      will wait for them all to be resolved or one to be rejected before the controller is
     *      instantiated.
     *      If all the promises are resolved successfully, the values of the resolved promises are
     *      injected and {@link ngRoute.$route#$routeChangeSuccess $routeChangeSuccess} event is
     *      fired. If any of the promises are rejected the
     *      {@link ngRoute.$route#$routeChangeError $routeChangeError} event is fired.
     *      For easier access to the resolved dependencies from the template, the `resolve` map will
     *      be available on the scope of the route, under `$resolve` (by default) or a custom name
     *      specified by the `resolveAs` property (see below). This can be particularly useful, when
     *      working with {@link angular.Module#component components} as route templates.<br />
     *      <div class="alert alert-warning">
     *        **Note:** If your scope already contains a property with this name, it will be hidden
     *        or overwritten. Make sure, you specify an appropriate name for this property, that
     *        does not collide with other properties on the scope.
     *      </div>
     *      The map object is:
     *
     *      - `key` – `{string}`: a name of a dependency to be injected into the controller.
     *      - `factory` - `{string|function}`: If `string` then it is an alias for a service.
     *        Otherwise if function, then it is {@link auto.$injector#invoke injected}
     *        and the return value is treated as the dependency. If the result is a promise, it is
     *        resolved before its value is injected into the controller. Be aware that
     *        `ngRoute.$routeParams` will still refer to the previous route within these resolve
     *        functions.  Use `$route.current.params` to access the new route parameters, instead.
     *
     *    - `resolveAs` - `{string=}` - The name under which the `resolve` map will be available on
     *      the scope of the route. If omitted, defaults to `$resolve`.
     *
     *    - `redirectTo` – `{(string|function())=}` – value to update
     *      {@link ng.$location $location} path with and trigger route redirection.
     *
     *      If `redirectTo` is a function, it will be called with the following parameters:
     *
     *      - `{Object.<string>}` - route parameters extracted from the current
     *        `$location.path()` by applying the current route templateUrl.
     *      - `{string}` - current `$location.path()`
     *      - `{Object}` - current `$location.search()`
     *
     *      The custom `redirectTo` function is expected to return a string which will be used
     *      to update `$location.path()` and `$location.search()`.
     *
     *    - `[reloadOnSearch=true]` - `{boolean=}` - reload route when only `$location.search()`
     *      or `$location.hash()` changes.
     *
     *      If the option is set to `false` and url in the browser changes, then
     *      `$routeUpdate` event is broadcasted on the root scope.
     *
     *    - `[caseInsensitiveMatch=false]` - `{boolean=}` - match routes without being case sensitive
     *
     *      If the option is set to `true`, then the particular route can be matched without being
     *      case sensitive
     *
     * @returns {Object} self
     *
     * @description
     * Adds a new route definition to the `$route` service.
     */
    this.when = function (path, route) {
      //copy original route object to preserve params inherited from proto chain
      var routeCopy = shallowCopy(route);
      if (angular.isUndefined(routeCopy.reloadOnSearch)) {
        routeCopy.reloadOnSearch = true;
      }
      if (angular.isUndefined(routeCopy.caseInsensitiveMatch)) {
        routeCopy.caseInsensitiveMatch = this.caseInsensitiveMatch;
      }
      routes[path] = angular.extend(routeCopy, path && pathRegExp(path, routeCopy));

      // create redirection for trailing slashes
      if (path) {
        var redirectPath = path[path.length - 1] == '/' ? path.substr(0, path.length - 1) : path + '/';

        routes[redirectPath] = angular.extend({ redirectTo: path }, pathRegExp(redirectPath, routeCopy));
      }

      return this;
    };

    /**
     * @ngdoc property
     * @name $routeProvider#caseInsensitiveMatch
     * @description
     *
     * A boolean property indicating if routes defined
     * using this provider should be matched using a case insensitive
     * algorithm. Defaults to `false`.
     */
    this.caseInsensitiveMatch = false;

    /**
     * @param path {string} path
     * @param opts {Object} options
     * @return {?Object}
     *
     * @description
     * Normalizes the given path, returning a regular expression
     * and the original path.
     *
     * Inspired by pathRexp in visionmedia/express/lib/utils.js.
     */
    function pathRegExp(path, opts) {
      var insensitive = opts.caseInsensitiveMatch,
          ret = {
        originalPath: path,
        regexp: path
      },
          keys = ret.keys = [];

      path = path.replace(/([().])/g, '\\$1').replace(/(\/)?:(\w+)(\*\?|[\?\*])?/g, function (_, slash, key, option) {
        var optional = option === '?' || option === '*?' ? '?' : null,
            star = option === '*' || option === '*?' ? '*' : null;

        keys.push({ name: key, optional: !!optional });
        slash = slash || '';
        return '' + (optional ? '' : slash) + '(?:' + (optional ? slash : '') + (star && '(.+?)' || '([^/]+)') + (optional || '') + ')' + (optional || '');
      }).replace(/([\/$\*])/g, '\\$1');

      ret.regexp = new RegExp('^' + path + '$', insensitive ? 'i' : '');
      return ret;
    }

    /**
     * @ngdoc method
     * @name $routeProvider#otherwise
     *
     * @description
     * Sets route definition that will be used on route change when no other route definition
     * is matched.
     *
     * @param {Object|string} params Mapping information to be assigned to `$route.current`.
     * If called with a string, the value maps to `redirectTo`.
     * @returns {Object} self
     */
    this.otherwise = function (params) {
      if (typeof params === 'string') {
        params = { redirectTo: params };
      }
      this.when(null, params);
      return this;
    };

    this.$get = ['$rootScope', '$location', '$routeParams', '$q', '$injector', '$templateRequest', '$sce', function ($rootScope, $location, $routeParams, $q, $injector, $templateRequest, $sce) {

      /**
       * @ngdoc service
       * @name $route
       * @requires $location
       * @requires $routeParams
       *
       * @property {Object} current Reference to the current route definition.
       * The route definition contains:
       *
       *   - `controller`: The controller constructor as defined in the route definition.
       *   - `locals`: A map of locals which is used by {@link ng.$controller $controller} service for
       *     controller instantiation. The `locals` contain
       *     the resolved values of the `resolve` map. Additionally the `locals` also contain:
       *
       *     - `$scope` - The current route scope.
       *     - `$template` - The current route template HTML.
       *
       *     The `locals` will be assigned to the route scope's `$resolve` property. You can override
       *     the property name, using `resolveAs` in the route definition. See
       *     {@link ngRoute.$routeProvider $routeProvider} for more info.
       *
       * @property {Object} routes Object with all route configuration Objects as its properties.
       *
       * @description
       * `$route` is used for deep-linking URLs to controllers and views (HTML partials).
       * It watches `$location.url()` and tries to map the path to an existing route definition.
       *
       * Requires the {@link ngRoute `ngRoute`} module to be installed.
       *
       * You can define routes through {@link ngRoute.$routeProvider $routeProvider}'s API.
       *
       * The `$route` service is typically used in conjunction with the
       * {@link ngRoute.directive:ngView `ngView`} directive and the
       * {@link ngRoute.$routeParams `$routeParams`} service.
       *
       * @example
       * This example shows how changing the URL hash causes the `$route` to match a route against the
       * URL, and the `ngView` pulls in the partial.
       *
       * <example name="$route-service" module="ngRouteExample"
       *          deps="angular-route.js" fixBase="true">
       *   <file name="index.html">
       *     <div ng-controller="MainController">
       *       Choose:
       *       <a href="Book/Moby">Moby</a> |
       *       <a href="Book/Moby/ch/1">Moby: Ch1</a> |
       *       <a href="Book/Gatsby">Gatsby</a> |
       *       <a href="Book/Gatsby/ch/4?key=value">Gatsby: Ch4</a> |
       *       <a href="Book/Scarlet">Scarlet Letter</a><br/>
       *
       *       <div ng-view></div>
       *
       *       <hr />
       *
       *       <pre>$location.path() = {{$location.path()}}</pre>
       *       <pre>$route.current.templateUrl = {{$route.current.templateUrl}}</pre>
       *       <pre>$route.current.params = {{$route.current.params}}</pre>
       *       <pre>$route.current.scope.name = {{$route.current.scope.name}}</pre>
       *       <pre>$routeParams = {{$routeParams}}</pre>
       *     </div>
       *   </file>
       *
       *   <file name="book.html">
       *     controller: {{name}}<br />
       *     Book Id: {{params.bookId}}<br />
       *   </file>
       *
       *   <file name="chapter.html">
       *     controller: {{name}}<br />
       *     Book Id: {{params.bookId}}<br />
       *     Chapter Id: {{params.chapterId}}
       *   </file>
       *
       *   <file name="script.js">
       *     angular.module('ngRouteExample', ['ngRoute'])
       *
       *      .controller('MainController', function($scope, $route, $routeParams, $location) {
       *          $scope.$route = $route;
       *          $scope.$location = $location;
       *          $scope.$routeParams = $routeParams;
       *      })
       *
       *      .controller('BookController', function($scope, $routeParams) {
       *          $scope.name = "BookController";
       *          $scope.params = $routeParams;
       *      })
       *
       *      .controller('ChapterController', function($scope, $routeParams) {
       *          $scope.name = "ChapterController";
       *          $scope.params = $routeParams;
       *      })
       *
       *     .config(function($routeProvider, $locationProvider) {
       *       $routeProvider
       *        .when('/Book/:bookId', {
       *         templateUrl: 'book.html',
       *         controller: 'BookController',
       *         resolve: {
       *           // I will cause a 1 second delay
       *           delay: function($q, $timeout) {
       *             var delay = $q.defer();
       *             $timeout(delay.resolve, 1000);
       *             return delay.promise;
       *           }
       *         }
       *       })
       *       .when('/Book/:bookId/ch/:chapterId', {
       *         templateUrl: 'chapter.html',
       *         controller: 'ChapterController'
       *       });
       *
       *       // configure html5 to get links working on jsfiddle
       *       $locationProvider.html5Mode(true);
       *     });
       *
       *   </file>
       *
       *   <file name="protractor.js" type="protractor">
       *     it('should load and compile correct template', function() {
       *       element(by.linkText('Moby: Ch1')).click();
       *       var content = element(by.css('[ng-view]')).getText();
       *       expect(content).toMatch(/controller\: ChapterController/);
       *       expect(content).toMatch(/Book Id\: Moby/);
       *       expect(content).toMatch(/Chapter Id\: 1/);
       *
       *       element(by.partialLinkText('Scarlet')).click();
       *
       *       content = element(by.css('[ng-view]')).getText();
       *       expect(content).toMatch(/controller\: BookController/);
       *       expect(content).toMatch(/Book Id\: Scarlet/);
       *     });
       *   </file>
       * </example>
       */

      /**
       * @ngdoc event
       * @name $route#$routeChangeStart
       * @eventType broadcast on root scope
       * @description
       * Broadcasted before a route change. At this  point the route services starts
       * resolving all of the dependencies needed for the route change to occur.
       * Typically this involves fetching the view template as well as any dependencies
       * defined in `resolve` route property. Once  all of the dependencies are resolved
       * `$routeChangeSuccess` is fired.
       *
       * The route change (and the `$location` change that triggered it) can be prevented
       * by calling `preventDefault` method of the event. See {@link ng.$rootScope.Scope#$on}
       * for more details about event object.
       *
       * @param {Object} angularEvent Synthetic event object.
       * @param {Route} next Future route information.
       * @param {Route} current Current route information.
       */

      /**
       * @ngdoc event
       * @name $route#$routeChangeSuccess
       * @eventType broadcast on root scope
       * @description
       * Broadcasted after a route change has happened successfully.
       * The `resolve` dependencies are now available in the `current.locals` property.
       *
       * {@link ngRoute.directive:ngView ngView} listens for the directive
       * to instantiate the controller and render the view.
       *
       * @param {Object} angularEvent Synthetic event object.
       * @param {Route} current Current route information.
       * @param {Route|Undefined} previous Previous route information, or undefined if current is
       * first route entered.
       */

      /**
       * @ngdoc event
       * @name $route#$routeChangeError
       * @eventType broadcast on root scope
       * @description
       * Broadcasted if any of the resolve promises are rejected.
       *
       * @param {Object} angularEvent Synthetic event object
       * @param {Route} current Current route information.
       * @param {Route} previous Previous route information.
       * @param {Route} rejection Rejection of the promise. Usually the error of the failed promise.
       */

      /**
       * @ngdoc event
       * @name $route#$routeUpdate
       * @eventType broadcast on root scope
       * @description
       * The `reloadOnSearch` property has been set to false, and we are reusing the same
       * instance of the Controller.
       *
       * @param {Object} angularEvent Synthetic event object
       * @param {Route} current Current/previous route information.
       */

      var forceReload = false,
          preparedRoute,
          preparedRouteIsUpdateOnly,
          $route = {
        routes: routes,

        /**
         * @ngdoc method
         * @name $route#reload
         *
         * @description
         * Causes `$route` service to reload the current route even if
         * {@link ng.$location $location} hasn't changed.
         *
         * As a result of that, {@link ngRoute.directive:ngView ngView}
         * creates new scope and reinstantiates the controller.
         */
        reload: function reload() {
          forceReload = true;

          var fakeLocationEvent = {
            defaultPrevented: false,
            preventDefault: function fakePreventDefault() {
              this.defaultPrevented = true;
              forceReload = false;
            }
          };

          $rootScope.$evalAsync(function () {
            prepareRoute(fakeLocationEvent);
            if (!fakeLocationEvent.defaultPrevented) commitRoute();
          });
        },

        /**
         * @ngdoc method
         * @name $route#updateParams
         *
         * @description
         * Causes `$route` service to update the current URL, replacing
         * current route parameters with those specified in `newParams`.
         * Provided property names that match the route's path segment
         * definitions will be interpolated into the location's path, while
         * remaining properties will be treated as query params.
         *
         * @param {!Object<string, string>} newParams mapping of URL parameter names to values
         */
        updateParams: function updateParams(newParams) {
          if (this.current && this.current.$$route) {
            newParams = angular.extend({}, this.current.params, newParams);
            $location.path(interpolate(this.current.$$route.originalPath, newParams));
            // interpolate modifies newParams, only query params are left
            $location.search(newParams);
          } else {
            throw $routeMinErr('norout', 'Tried updating route when with no current route');
          }
        }
      };

      $rootScope.$on('$locationChangeStart', prepareRoute);
      $rootScope.$on('$locationChangeSuccess', commitRoute);

      return $route;

      /////////////////////////////////////////////////////

      /**
       * @param on {string} current url
       * @param route {Object} route regexp to match the url against
       * @return {?Object}
       *
       * @description
       * Check if the route matches the current url.
       *
       * Inspired by match in
       * visionmedia/express/lib/router/router.js.
       */
      function switchRouteMatcher(on, route) {
        var keys = route.keys,
            params = {};

        if (!route.regexp) return null;

        var m = route.regexp.exec(on);
        if (!m) return null;

        for (var i = 1, len = m.length; i < len; ++i) {
          var key = keys[i - 1],
              val = m[i];

          if (key && val) {
            params[key.name] = val;
          }
        }
        return params;
      }

      function prepareRoute($locationEvent) {
        var lastRoute = $route.current;

        preparedRoute = parseRoute();
        preparedRouteIsUpdateOnly = preparedRoute && lastRoute && preparedRoute.$$route === lastRoute.$$route && angular.equals(preparedRoute.pathParams, lastRoute.pathParams) && !preparedRoute.reloadOnSearch && !forceReload;

        if (!preparedRouteIsUpdateOnly && (lastRoute || preparedRoute)) {
          if ($rootScope.$broadcast('$routeChangeStart', preparedRoute, lastRoute).defaultPrevented) {
            if ($locationEvent) {
              $locationEvent.preventDefault();
            }
          }
        }
      }

      function commitRoute() {
        var lastRoute = $route.current,
            nextRoute = preparedRoute;


        if (preparedRouteIsUpdateOnly) {
          lastRoute.params = nextRoute.params;
          angular.copy(lastRoute.params, $routeParams);
          $rootScope.$broadcast('$routeUpdate', lastRoute);
        } else if (nextRoute || lastRoute) {
          forceReload = false;
          $route.current = nextRoute;
          if (nextRoute) {
            if (nextRoute.redirectTo) {
              if (angular.isString(nextRoute.redirectTo)) {
                $location.path(interpolate(nextRoute.redirectTo, nextRoute.params)).search(nextRoute.params).replace();
              } else {
                $location.url(nextRoute.redirectTo(nextRoute.pathParams, $location.path(), $location.search())).replace();
              }
            }
          }

          $q.when(nextRoute).then(resolveLocals).then(function (locals) {
            // after route change
            if (nextRoute == $route.current) {
              if (nextRoute) {
                nextRoute.locals = locals;
                angular.copy(nextRoute.params, $routeParams);
              }
              $rootScope.$broadcast('$routeChangeSuccess', nextRoute, lastRoute);
            }
          }, function (error) {
            if (nextRoute == $route.current) {
              $rootScope.$broadcast('$routeChangeError', nextRoute, lastRoute, error);
            }
          });
        }
      }

      function resolveLocals(route) {
        if (route) {
          var locals = angular.extend({}, route.resolve);
          angular.forEach(locals, function (value, key) {
            locals[key] = angular.isString(value) ? $injector.get(value) : $injector.invoke(value, null, null, key);
          });
          var template = getTemplateFor(route);
          if (angular.isDefined(template)) {
            locals['$template'] = template;
          }
          return $q.all(locals);
        }
      }

      function getTemplateFor(route) {
        var template, templateUrl;
        if (angular.isDefined(template = route.template)) {
          if (angular.isFunction(template)) {
            template = template(route.params);
          }
        } else if (angular.isDefined(templateUrl = route.templateUrl)) {
          if (angular.isFunction(templateUrl)) {
            templateUrl = templateUrl(route.params);
          }
          if (angular.isDefined(templateUrl)) {
            route.loadedTemplateUrl = $sce.valueOf(templateUrl);
            template = $templateRequest(templateUrl);
          }
        }
        return template;
      }

      /**
       * @returns {Object} the current active route, by matching it against the URL
       */
      function parseRoute() {
        // Match a route
        var params, match;
        angular.forEach(routes, function (route, path) {
          if (!match && (params = switchRouteMatcher($location.path(), route))) {
            match = inherit(route, {
              params: angular.extend({}, $location.search(), params),
              pathParams: params });
            match.$$route = route;
          }
        });
        // No route matched; fallback to "otherwise" route
        return match || routes[null] && inherit(routes[null], { params: {}, pathParams: {} });
      }

      /**
       * @returns {string} interpolation of the redirect path with the parameters
       */
      function interpolate(string, params) {
        var result = [];
        angular.forEach((string || '').split(':'), function (segment, i) {
          if (i === 0) {
            result.push(segment);
          } else {
            var segmentMatch = segment.match(/(\w+)(?:[?*])?(.*)/),
                key = segmentMatch[1];

            result.push(params[key]);
            result.push(segmentMatch[2] || '');
            delete params[key];
          }
        });
        return result.join('');
      }
    }];
  }

  ngRouteModule.provider('$routeParams', $RouteParamsProvider);

  /**
   * @ngdoc service
   * @name $routeParams
   * @requires $route
   *
   * @description
   * The `$routeParams` service allows you to retrieve the current set of route parameters.
   *
   * Requires the {@link ngRoute `ngRoute`} module to be installed.
   *
   * The route parameters are a combination of {@link ng.$location `$location`}'s
   * {@link ng.$location#search `search()`} and {@link ng.$location#path `path()`}.
   * The `path` parameters are extracted when the {@link ngRoute.$route `$route`} path is matched.
   *
   * In case of parameter name collision, `path` params take precedence over `search` params.
   *
   * The service guarantees that the identity of the `$routeParams` object will remain unchanged
   * (but its properties will likely change) even when a route change occurs.
   *
   * Note that the `$routeParams` are only updated *after* a route change completes successfully.
   * This means that you cannot rely on `$routeParams` being correct in route resolve functions.
   * Instead you can use `$route.current.params` to access the new route's parameters.
   *
   * @example
   * ```js
   *  // Given:
   *  // URL: http://server.com/index.html#/Chapter/1/Section/2?search=moby
   *  // Route: /Chapter/:chapterId/Section/:sectionId
   *  //
   *  // Then
   *  $routeParams ==> {chapterId:'1', sectionId:'2', search:'moby'}
   * ```
   */
  function $RouteParamsProvider() {
    this.$get = function () {
      return {};
    };
  }

  ngRouteModule.directive('ngView', ngViewFactory);
  ngRouteModule.directive('ngView', ngViewFillContentFactory);

  /**
   * @ngdoc directive
   * @name ngView
   * @restrict ECA
   *
   * @description
   * # Overview
   * `ngView` is a directive that complements the {@link ngRoute.$route $route} service by
   * including the rendered template of the current route into the main layout (`index.html`) file.
   * Every time the current route changes, the included view changes with it according to the
   * configuration of the `$route` service.
   *
   * Requires the {@link ngRoute `ngRoute`} module to be installed.
   *
   * @animations
   * | Animation                        | Occurs                              |
   * |----------------------------------|-------------------------------------|
   * | {@link ng.$animate#enter enter}  | when the new element is inserted to the DOM |
   * | {@link ng.$animate#leave leave}  | when the old element is removed from to the DOM  |
   *
   * The enter and leave animation occur concurrently.
   *
   * @knownIssue If `ngView` is contained in an asynchronously loaded template (e.g. in another
   *             directive's templateUrl or in a template loaded using `ngInclude`), then you need to
   *             make sure that `$route` is instantiated in time to capture the initial
   *             `$locationChangeStart` event and load the appropriate view. One way to achieve this
   *             is to have it as a dependency in a `.run` block:
   *             `myModule.run(['$route', function() {}]);`
   *
   * @scope
   * @priority 400
   * @param {string=} onload Expression to evaluate whenever the view updates.
   *
   * @param {string=} autoscroll Whether `ngView` should call {@link ng.$anchorScroll
   *                  $anchorScroll} to scroll the viewport after the view is updated.
   *
   *                  - If the attribute is not set, disable scrolling.
   *                  - If the attribute is set without value, enable scrolling.
   *                  - Otherwise enable scrolling only if the `autoscroll` attribute value evaluated
   *                    as an expression yields a truthy value.
   * @example
      <example name="ngView-directive" module="ngViewExample"
               deps="angular-route.js;angular-animate.js"
               animations="true" fixBase="true">
        <file name="index.html">
          <div ng-controller="MainCtrl as main">
            Choose:
            <a href="Book/Moby">Moby</a> |
            <a href="Book/Moby/ch/1">Moby: Ch1</a> |
            <a href="Book/Gatsby">Gatsby</a> |
            <a href="Book/Gatsby/ch/4?key=value">Gatsby: Ch4</a> |
            <a href="Book/Scarlet">Scarlet Letter</a><br/>
  
            <div class="view-animate-container">
              <div ng-view class="view-animate"></div>
            </div>
            <hr />
  
            <pre>$location.path() = {{main.$location.path()}}</pre>
            <pre>$route.current.templateUrl = {{main.$route.current.templateUrl}}</pre>
            <pre>$route.current.params = {{main.$route.current.params}}</pre>
            <pre>$routeParams = {{main.$routeParams}}</pre>
          </div>
        </file>
  
        <file name="book.html">
          <div>
            controller: {{book.name}}<br />
            Book Id: {{book.params.bookId}}<br />
          </div>
        </file>
  
        <file name="chapter.html">
          <div>
            controller: {{chapter.name}}<br />
            Book Id: {{chapter.params.bookId}}<br />
            Chapter Id: {{chapter.params.chapterId}}
          </div>
        </file>
  
        <file name="animations.css">
          .view-animate-container {
            position:relative;
            height:100px!important;
            background:white;
            border:1px solid black;
            height:40px;
            overflow:hidden;
          }
  
          .view-animate {
            padding:10px;
          }
  
          .view-animate.ng-enter, .view-animate.ng-leave {
            transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 1.5s;
  
            display:block;
            width:100%;
            border-left:1px solid black;
  
            position:absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            padding:10px;
          }
  
          .view-animate.ng-enter {
            left:100%;
          }
          .view-animate.ng-enter.ng-enter-active {
            left:0;
          }
          .view-animate.ng-leave.ng-leave-active {
            left:-100%;
          }
        </file>
  
        <file name="script.js">
          angular.module('ngViewExample', ['ngRoute', 'ngAnimate'])
            .config(['$routeProvider', '$locationProvider',
              function($routeProvider, $locationProvider) {
                $routeProvider
                  .when('/Book/:bookId', {
                    templateUrl: 'book.html',
                    controller: 'BookCtrl',
                    controllerAs: 'book'
                  })
                  .when('/Book/:bookId/ch/:chapterId', {
                    templateUrl: 'chapter.html',
                    controller: 'ChapterCtrl',
                    controllerAs: 'chapter'
                  });
  
                $locationProvider.html5Mode(true);
            }])
            .controller('MainCtrl', ['$route', '$routeParams', '$location',
              function($route, $routeParams, $location) {
                this.$route = $route;
                this.$location = $location;
                this.$routeParams = $routeParams;
            }])
            .controller('BookCtrl', ['$routeParams', function($routeParams) {
              this.name = "BookCtrl";
              this.params = $routeParams;
            }])
            .controller('ChapterCtrl', ['$routeParams', function($routeParams) {
              this.name = "ChapterCtrl";
              this.params = $routeParams;
            }]);
  
        </file>
  
        <file name="protractor.js" type="protractor">
          it('should load and compile correct template', function() {
            element(by.linkText('Moby: Ch1')).click();
            var content = element(by.css('[ng-view]')).getText();
            expect(content).toMatch(/controller\: ChapterCtrl/);
            expect(content).toMatch(/Book Id\: Moby/);
            expect(content).toMatch(/Chapter Id\: 1/);
  
            element(by.partialLinkText('Scarlet')).click();
  
            content = element(by.css('[ng-view]')).getText();
            expect(content).toMatch(/controller\: BookCtrl/);
            expect(content).toMatch(/Book Id\: Scarlet/);
          });
        </file>
      </example>
   */

  /**
   * @ngdoc event
   * @name ngView#$viewContentLoaded
   * @eventType emit on the current ngView scope
   * @description
   * Emitted every time the ngView content is reloaded.
   */
  ngViewFactory.$inject = ['$route', '$anchorScroll', '$animate'];
  function ngViewFactory($route, $anchorScroll, $animate) {
    return {
      restrict: 'ECA',
      terminal: true,
      priority: 400,
      transclude: 'element',
      link: function link(scope, $element, attr, ctrl, $transclude) {
        var currentScope,
            currentElement,
            previousLeaveAnimation,
            autoScrollExp = attr.autoscroll,
            onloadExp = attr.onload || '';

        scope.$on('$routeChangeSuccess', update);
        update();

        function cleanupLastView() {
          if (previousLeaveAnimation) {
            $animate.cancel(previousLeaveAnimation);
            previousLeaveAnimation = null;
          }

          if (currentScope) {
            currentScope.$destroy();
            currentScope = null;
          }
          if (currentElement) {
            previousLeaveAnimation = $animate.leave(currentElement);
            previousLeaveAnimation.then(function () {
              previousLeaveAnimation = null;
            });
            currentElement = null;
          }
        }

        function update() {
          var locals = $route.current && $route.current.locals,
              template = locals && locals.$template;

          if (angular.isDefined(template)) {
            var newScope = scope.$new(),
                current = $route.current,
                clone = $transclude(newScope, function (clone) {
              $animate.enter(clone, null, currentElement || $element).then(function onNgViewEnter() {
                if (angular.isDefined(autoScrollExp) && (!autoScrollExp || scope.$eval(autoScrollExp))) {
                  $anchorScroll();
                }
              });
              cleanupLastView();
            });

            // Note: This will also link all children of ng-view that were contained in the original
            // html. If that content contains controllers, ... they could pollute/change the scope.
            // However, using ng-view on an element with additional content does not make sense...
            // Note: We can't remove them in the cloneAttchFn of $transclude as that
            // function is called before linking the content, which would apply child
            // directives to non existing elements.


            currentElement = clone;
            currentScope = current.scope = newScope;
            currentScope.$emit('$viewContentLoaded');
            currentScope.$eval(onloadExp);
          } else {
            cleanupLastView();
          }
        }
      }
    };
  }

  // This directive is called during the $transclude call of the first `ngView` directive.
  // It will replace and compile the content of the element with the loaded template.
  // We need this directive so that the element content is already filled when
  // the link function of another directive on the same element as ngView
  // is called.
  ngViewFillContentFactory.$inject = ['$compile', '$controller', '$route'];
  function ngViewFillContentFactory($compile, $controller, $route) {
    return {
      restrict: 'ECA',
      priority: -400,
      link: function link(scope, $element) {
        var current = $route.current,
            locals = current.locals;

        $element.html(locals.$template);

        var link = $compile($element.contents());

        if (current.controller) {
          locals.$scope = scope;
          var controller = $controller(current.controller, locals);
          if (current.controllerAs) {
            scope[current.controllerAs] = controller;
          }
          $element.data('$ngControllerController', controller);
          $element.children().data('$ngControllerController', controller);
        }
        scope[current.resolveAs || '$resolve'] = locals;

        link(scope);
      }
    };
  }
})(window, window.angular);
/* <<< file end: js/node_modules/angular-route/angular-route.js */

//# map link was there [angular-route.js.map]
/* >>> file start: js/node_modules/ng-infinite-scroll/build/ng-infinite-scroll.js */
/* ng-infinite-scroll - v1.0.0 - 2013-02-23 */
var mod;

mod = angular.module('infinite-scroll', []);

mod.directive('infiniteScroll', ['$rootScope', '$window', '$timeout', function ($rootScope, $window, $timeout) {
  return {
    link: function link(scope, elem, attrs) {
      var checkWhenEnabled, handler, scrollDistance, scrollEnabled;
      $window = angular.element($window);
      scrollDistance = 0;
      if (attrs.infiniteScrollDistance != null) {
        scope.$watch(attrs.infiniteScrollDistance, function (value) {
          return scrollDistance = parseInt(value, 10);
        });
      }
      scrollEnabled = true;
      checkWhenEnabled = false;
      if (attrs.infiniteScrollDisabled != null) {
        scope.$watch(attrs.infiniteScrollDisabled, function (value) {
          scrollEnabled = !value;
          if (scrollEnabled && checkWhenEnabled) {
            checkWhenEnabled = false;
            return handler();
          }
        });
      }
      handler = function handler() {
        var elementBottom, remaining, shouldScroll, windowBottom;
        windowBottom = $window.height() + $window.scrollTop();
        elementBottom = elem.offset().top + elem.height();
        remaining = elementBottom - windowBottom;
        shouldScroll = remaining <= $window.height() * scrollDistance;
        if (shouldScroll && scrollEnabled) {
          if ($rootScope.$$phase) {
            return scope.$eval(attrs.infiniteScroll);
          } else {
            return scope.$apply(attrs.infiniteScroll);
          }
        } else if (shouldScroll) {
          return checkWhenEnabled = true;
        }
      };
      $window.on('scroll', handler);
      scope.$on('$destroy', function () {
        return $window.off('scroll', handler);
      });
      return $timeout(function () {
        if (attrs.infiniteScrollImmediateCheck) {
          if (scope.$eval(attrs.infiniteScrollImmediateCheck)) {
            return handler();
          }
        } else {
          return handler();
        }
      }, 0);
    }
  };
}]);
/* <<< file end: js/node_modules/ng-infinite-scroll/build/ng-infinite-scroll.js */

//# map link was there [ng-infinite-scroll.js.map]
/* >>> file start: js/core/angular/ref.js */
/**
 * Define ref in HTML:
 *   <div lj-ref="my-target" />
 *
 * Scroll to ref:
 *   Ref.scrollTo('ref', { onlyUp: true });
 */

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Ref', []).factory('Ref', function () {
    var refs = {};

    function add(id, element) {
      if (refs[id]) {
        console.error('Ref element with id `%s` has been registered before.', id);
        return;
      }

      refs[id] = element;
    }

    function remove(id) {
      if (refs[id]) {
        delete refs[id];
      }
    }

    function get(id) {
      var ref = refs[id];

      if (!ref) {
        console.error('Ref `%s` not found.', id);
      }

      return ref;
    }

    /**
     * Scroll to ref element
     * @param {String} ref                        Ref id
     * @param {Object} [options]                  Scroll options
     * @param {Boolean} [options.onlyUp]          Scroll to the up only. Prevent scrolling down
     * @param {Boolean} [options.onlyOutOfScreen] Scroll to ref if it displays out of viewport
     * @param {Boolean} [options.toParent]        Scroll parent element instead of <body> to ref.
     */
    function _scrollTo(ref, options) {
      if (typeof options === 'undefined') {
        options = {};
      }

      var element = get(ref),
          rootElement = angular.element('html, body');

      if (!element) {
        console.error('Could not scroll to the ref `%s` that has not been already defined.', ref);
        return;
      }

      var top = element.offset().top;

      // do not scroll down if it is restricted
      if (options.onlyUp && angular.element(window).scrollTop() <= top) {
        return;
      }

      if (options.onlyOutOfScreen && !outOfScreen(element)) {
        return;
      }

      if (options.toParent) {
        rootElement = element.parent();
        top = 0;
      }

      rootElement.animate({
        scrollTop: top
      });
    }

    function outOfScreen(element) {
      var _window = angular.element(window),
          screenTop = _window.scrollTop(),
          screenBottom = screenTop + _window.height(),
          elementTop = element.offset().top;

      return elementTop > screenBottom - 100 || elementTop < screenTop;
    }

    return {
      add: add,
      remove: remove,
      get: get,

      scrollTo: _scrollTo
    };
  }).directive('ljRef', ['Ref', function (Ref) {
    return {
      restrict: 'A',
      scope: true,
      link: function link($scope, $element, $attrs) {
        var id = $attrs.ljRef;

        Ref.add(id, $element);

        $scope.$on('$destroy', function () {
          Ref.remove(id);
        });
      }
    };
  }]);
})();
/* <<< file end: js/core/angular/ref.js */

//# map link was there [ref.js.map]
/* >>> file start: js/core/angular/bubble.js */
/* global JSON */

//= require js/core/angular/ref.js

Site.page.template['Widgets/ljBubble.tmpl'] = '<div\n    class=\"\n        b-popup\n        bubble-node\n        b-popup-withclosecontrol\n        b-bubble-{{bubble.name}}\n        \"\n    ng-show=\"show\"\n    lj-switch-off=\"show\"\n    lj-switch-off-action=\"bubble.close()\"\n    lj-switch-off-ignore-sticky=true\n    ng-style=\"{ left: position.x, top: position.y, visibility: visibility }\"\n    ng-class=\"{\n        \'b-popup-noclosecontrol\': !bubble.options.closeControl\n    }\"\n    lj-switch-off-skip>\n    <div class=\"b-popup-outer\">\n        <div class=\"b-popup-inner\">\n            <i class=\"i-popup-arr\" ng-class=\"arrowClass()\">\n                <i class=\"i-popup-arr-brdr-outer\">\n                    <i class=\"i-popup-arr-brdr-inner\">\n                        <i class=\"i-popup-arr-bg\"></i>\n                    </i>\n                </i>\n            </i>\n            <div ng-include src=\"template\"></div>\n            <i class=\"i-popup-close\" ng-click=\"bubble.close()\"></i>\n        </div>\n    </div>\n</div>\n';
Site.page.template['angular/confirm.bubble.ng.tmpl'] = '<div class=\"b-popup-content b-popup-options-centered\">\n  <div class=\"b-popup-content-header\">\n    <span>{{ bubble.options.header }}</span>\n  </div>\n  <div class=\"b-popup-content-confirm\" ng-bind-html=\"bubble.options.text\"></div>\n  <div class=\"b-popup-submit-options\">\n    <button class=\"b-popup-btn b-flatbutton b-flatbutton-simple\" ng-click=\"bubble.options.confirm()\">{{ bubble.options.yes }}</button>\n    <button class=\"b-popup-cancel b-flatbutton b-flatbutton-simple b-flatbutton-neutral\" ng-click=\"bubble.close()\">{{ bubble.options.no }}</button>\n  </div>\n</div>\n';

//= require_ml confirm.bubble.yes
//= require_ml confirm.bubble.no

/**
 * LJ bubble directive
 *
 * Options:
 *   - closeControl: show close control or not. Default: true
 *   - alwaysLeft / alwaysRight:  always place bubble left / right. Default: false
 *   - alwaysTop / alwaysBottom:  always place bubble top / bottom. Default: false
 *   - eventType: open bubble event. Default: 'click'
 *   - autoClose: auto close timer in milliseconds. Default: 0
 *   - arrowInitialVertical: default vertical arrow position on bubble. Default: 't'
 *   - arrowInitialHorizontal: default horizontal arrow position on bubble. Default: 'l'
 *   - aside: place bubble aside, so the arrow is on the left or right side edges. Default: false
 *   - tryAsideIfNoHorizSpace: will place itself aside if out of screen bounds regardless of horizontal arrow position.
         Works when `aside` is OFF (not set). Default: false
 *
 * @example
 *   html:
 *     <!--
 *       Following will add click handler to button
 *       and include myBubble.tmpl inside bubble.
 *     -->
 *     <button lj-bubble="{
 *         name: 'myBubble',
 *         template: 'settings.ng.tmpl',
 *         closeControl: false
 *       }"
 *       >Show bubble!</button>
 *
 *   js:
 *     angular.module('MyModule', ['LJ.Bubble'])
 *     .controller('MyCtrl', ['$scope', 'Bubble', function($scope, Bubble) {
 *
 *       // Use Bubble.open to control bubble from JS.
 *       // You can pass jQuery node to reposition the bubble from the original placement.
 *       Bubble.open('myBubble', { 'some-stuff': 'optional' }, jQuery('.b-some-other-block'));
 *     }]);
 *
 * @todo
 *   Refactor detection of current bubble open
 *   Refactor disableClick option of directive
 *
 * @author
 *   Artem Tyurin (artem.tyurin@sup.com)
 *   Valeriy Vasin (valeriy.vasin@sup.com)
 */

(function () {
  'use strict';

  angular.module('LJ.Bubble', ['LJ.Templates', 'LJ.Directives', 'LJ.Ref']);

  angular.module('LJ.Bubble').factory('Bubble', bubbleFactoryFn).directive('ljBubble', ljBubbleDirective);

  // body className flag
  var bubbleOpenClass = 'p-openpopup';

  ljBubbleDirective.$inject = ['Bubble', '$parse', '$compile', '$timeout', '$templateCache'];
  /**
   * ljBubbleDirective
   *
   * @name ljBubbleDirective
   * @function
   * @public
   * @param {object} Bubble - buuble object
   * @param {function} $parse - parse function
   * @param {function} $compile - ng compiler
   * @param {function} $timeout - setTimeout
   * @param {object} $templateCache  - template cache service
   * @return {object} directive fabric object
   */
  function ljBubbleDirective(Bubble, $parse, $compile, $timeout, $templateCache) {
    return {
      scope: true,
      /**
       * link
       *
       * @name link
       * @function
       * @public
       * @param {object} scope - local scope
       * @param {object} element - html element
       * @param {object} attrs - html attributes
       */
      link: function link(scope, element, attrs) {
        var options = $parse(attrs.ljBubble)(scope),
            name = options.name,
            bubble = $compile($templateCache.get('ljBubble.tmpl'))(scope),
            setPosition = LJ.Function.throttle(_setPosition, 50),
            arrow = bubble.find('.i-popup-arr'),
            $window = angular.element(window),
            eventType = options.eventType || 'click',
            autoClose = Number(options.autoClose || 0),
            autoCloseTimeoutPromise;

        scope.show = false;

        Bubble._register(name, options);

        scope.template = options.template || name + '.html';
        scope.bubble = {
          name: name,
          close: Bubble.close,
          options: Bubble.options(name)
        };

        /**
         * clear
         *
         * @name clear
         * @function
         * @public
         */
        scope.clear = function () {
          scope.arrow = {
            vertical: options.arrowInitialVertical || 't', /* top  (t) or bottom (b) */
            horizontal: options.arrowInitialHorizontal || 'l' /* left (l) or right  (r) */
          };
        };

        scope.position = {
          x: -9999,
          y: -9999
        };

        scope.visibility = 'hidden';

        /**
         * arrowClass
         *
         * @name arrowClass
         * @function
         * @public
         * @return {string} arrow class
         */
        scope.arrowClass = function () {
          var opts = scope.bubble.options,
              vertical = scope.arrow.vertical,
              horizontal = scope.arrow.horizontal;

          return opts.aside || options.aside ? 'i-popup-arr' + horizontal + vertical : 'i-popup-arr' + vertical + horizontal;
        };

        scope.$watch(function () {
          return Bubble.current;
        }, function (value) {
          hideFromViewport();

          $timeout(function () {
            scope.show = value === name;

            if (value && scope.show) {
              scope.clear();
              $timeout(setPosition);
            }
          });
        }, true);

        /**
         * _setPosition
         *
         * @name _setPosition
         * @function
         * @private
         */
        function _setPosition() {
          // try to use top/left coords
          var vertical = scope.arrow.vertical,
              horizontal = scope.arrow.horizontal,
              aside = options.aside,
              isModal = $window.innerWidth <= 650 ? true : false; // bubble fix, shoud be like - angular.element('body').hasClass(bubbleOpenClass);

          scope.visibility = 'hidden';

          if (options.keepInitialWidth && !options.widthSaved) {
            options.widthSaved = true;
            bubble.width(bubble.width());
          }

          // calculate positions initially
          recalculatePositions();

          if (isOutOfViewportY() && !isModal) {
            // we are out of vertical space
            scope.arrow.vertical = vertical === 'b' ? _isOption('alwaysTop') ? 'b' : 't' : _isOption('alwaysBottom') ? 't' : 'b';

            recalculatePositions();
            // We prefer to put bubble below target
            // if both options `t`/`b` work poorly.
            // That happens in case of a very small height of `window`
            if (notEnoughSpaceOnTop() && !_isOption('alwaysTop')) {
              scope.arrow.vertical = 't';
              recalculatePositions();
            }
          }

          if (isOutOfViewportX() && !isModal) {
            // we are out of horizontal space
            scope.arrow.horizontal = horizontal === 'l' ? _isOption('alwaysRight') || notEnoughSpaceOnTheLeft() ? 'l' : 'r' : _isOption('alwaysLeft') || notEnoughSpaceOnTheRight() ? 'r' : 'l';
          }

          if (!isModal && isOutOfViewportX()
          // if we did not do anything on previous stage
          && scope.arrow.horizontal === horizontal && canSwitchToAside()) {
            options.aside = true;
          }

          // top/left coords can't be used
          if (!isModal && (scope.arrow.horizontal !== horizontal || scope.arrow.vertical !== vertical || options.aside !== aside)) {
            $timeout(showRecalculatedPosition);
          } else {
            scope.visibility = 'visible';
          }
        }

        /**
         * showRecalculatedPosition
         * positions should be recalculated
         * timeout is needed to apply arrow positions
         *
         * @name showRecalculatedPosition
         * @function
         * @public
         */
        function showRecalculatedPosition() {
          recalculatePositions();

          if (isOutOfViewportX() && canSwitchToAside()) {

            options.aside = true;
            // force DOM to update for correct measurements
            scope.$apply();
            showRecalculatedPosition();
            return;
          }

          // if out of screen yet set arrow  to center
          if (isOutOfViewportX() && !_isOption('aside') && scope.arrow.horizontal) {
            scope.arrow.horizontal = '';
            showRecalculatedPosition();
            return;
          }

          scope.visibility = 'visible';
        }

        function canSwitchToAside() {
          return !_isOption('aside') && _isOption('tryAsideIfNoHorizSpace');
        }

        /**
         * _isOption
         *
         * @name _isOption
         * @function
         * @private
         * @param {string} option - bubble option name
         * @return {*} option value
         */
        function _isOption(option) {
          return scope.bubble.options[option] || options[option];
        }

        /**
         * recalculatePositions
         *
         * @name recalculatePositions
         * @function
         * @public
         */
        function recalculatePositions() {
          var el = Bubble.node || element,
              centerX = el.offset().left + Math.floor(el.outerWidth() / 2),
              forceX = scope.bubble.options.forceX || 0,
              forceY = scope.bubble.options.forceY || 0;

          if (_isOption('aside')) {
            scope.position.x = scope.arrow.horizontal === 'r' ? el.offset().left - bubble.outerWidth() - arrow.outerWidth() + forceX : el.offset().left + el.outerWidth() + arrow.outerWidth() + forceX;

            scope.position.y = el.offset().top - arrow.position().top + (el.outerHeight() - arrow.outerHeight()) / 2 + forceY;
          } else {
            scope.position.x = scope.arrow.horizontal ? centerX - arrow.position().left - Math.floor(arrow.outerWidth() / 2) - 2 + forceX : centerX - bubble.outerWidth() / 2 - Math.floor(arrow.outerWidth() / 4) - 2 + forceX;

            scope.position.y = scope.arrow.vertical === 't' ? el.offset().top + el.outerHeight() + arrow.outerHeight() + forceY : el.offset().top - arrow.outerHeight() - bubble.outerHeight() + forceY;
          }
        }

        /**
         * hideFromViewport
         *
         * @name hideFromViewport
         * @function
         * @public
         */
        function hideFromViewport() {
          scope.position.x = -9999;
        }

        /**
         * isOutOfViewportY
         *
         * @name isOutOfViewportY
         * @function
         * @public
         * @return {boolean} is out of viewport Y
         */
        function isOutOfViewportY() {

          if (notEnoughSpaceOnTop()) return true;

          return scope.position.y + bubble.outerHeight() > $window.scrollTop() + $window.outerHeight();
        }

        function notEnoughSpaceOnTop() {
          return scope.position.y < $window.scrollTop();
        }

        /**
         * isOutOfViewportX
         *
         * @name isOutOfViewportX
         * @function
         * @public
         * @return {boolean} is out of viewport X
         */
        function isOutOfViewportX() {
          return notEnoughSpaceOnTheLeft() || notEnoughSpaceOnTheRight();
        }

        function notEnoughSpaceOnTheLeft() {
          return scope.position.x < $window.scrollLeft();
        }

        function notEnoughSpaceOnTheRight() {
          return scope.position.x + bubble.outerWidth() > $window.scrollLeft() + $window.outerWidth();
        }

        /**
         * Bubble target click handler
         * @param  {jQuery.Event} event Click event object
         */
        function onTargetClick(event) {
          event.preventDefault();

          if (Bubble.current === options.name) {
            return;
          }

          $timeout(function () {
            Bubble.open(options.name);
          });
        }

        /**
         * startTimeoutToClose
         *
         * @name startTimeoutToClose
         * @function
         * @public
         */
        function startTimeoutToClose() {
          stopTimeoutToClose();

          if (autoClose) {
            autoCloseTimeoutPromise = $timeout(Bubble.close, autoClose);
          }
        }

        /**
         * stopTimeoutToClose
         *
         * @name stopTimeoutToClose
         * @function
         * @public
         */
        function stopTimeoutToClose() {
          $timeout.cancel(autoCloseTimeoutPromise);
        }

        /**
         * finishTimeoutAndClose
         *
         * @name finishTimeoutAndClose
         * @function
         * @public
         */
        function finishTimeoutAndClose() {
          var bubbleToClose = options.name,
              openedBubble = Bubble.current;
          if (bubbleToClose !== openedBubble) {
            return;
          }
          stopTimeoutToClose();
          Bubble.close();
          scope.$apply();
        }

        /**
         * onResize
         *
         * @name onResize
         * @function
         * @public
         */
        function onResize() {
          if (scope.show) {
            $timeout(setPosition);
          }
        }

        if (!options.disableClick) {
          element.on(eventType, onTargetClick);
        }

        // android view triggers resize on opening soft keyboard
        if (!options.disableResizeListener) {
          $window.on('resize', onResize);
        }

        if (options.recalculateOnOrientationChange) {
          $window.on('orientationchange', function () {
            onResize();
            $window.on('resize', onResize);
            $timeout(function () {
              $window.off('resize', onResize);
            }, 1000);
          });
        }

        if (options.recalculateOnScroll) {
          $window.on('scroll', onResize);
        }

        if (options.closeOnScroll) {
          $window.on('scroll', finishTimeoutAndClose);
        }

        angular.element('body').append(bubble);

        element.on('mouseleave', startTimeoutToClose);
        bubble.on('mouseenter', stopTimeoutToClose);
        bubble.on('mouseleave', startTimeoutToClose);

        scope.clear();
        scope.$on('$destroy', function () {
          element.off(eventType, onTargetClick);
          $window.off('resize', onResize);
          $window.off('scroll', onResize);
          $window.off('scroll', Bubble.close);
          element.off('mouseleave', startTimeoutToClose);
          bubble.off('mouseenter', stopTimeoutToClose);
          bubble.off('mouseleave', startTimeoutToClose);
          Bubble._unregister(name);
          bubble.remove();
        });
      }
    };
  }

  bubbleFactoryFn.$inject = ['$rootScope', '$compile', 'Ref', '$timeout', '$window', '$log'];
  /**
   * bubbleFactoryFn
   *
   * @name bubbleFactoryFn
   * @function
   * @public
   * @param {object} $rootScope - scope root
   * @param {function} $compile - compiler ng
   * @param {object} Ref - ??
   * @param {function} $timeout - settimeout
   * @param {object} $window - global
   * @param {object} $log - console
   * @return {object} service instance
   */
  function bubbleFactoryFn($rootScope, $compile, Ref, $timeout, $window, $log) {
    var factory = {},


    // bubbles options
    _options = {};

    // currently opened bubble name
    factory.current = null;

    // we can change bubble node while opening bubble
    factory.node = null;

    /**
     * Register bubble from service
     * @example
     *   Bubble.register({ name: 'share', template: 'share.ng.tmpl' });
     */
    factory.register = function () {
      // cache for registerd from service bubbles
      var cache = {};

      /**
       * register
       *
       * @name register
       * @function
       * @public
       * @param {object} opts - ??
       * @param {object} scope - ??
       * @return {function} unregister fn
       */
      function register(opts, scope) {
        var name, bubbleNode, isScopeCreated;

        if (!opts || !opts.name || !opts.template) {
          $log.error('Incorrect bubble options. You should provide name and template.', opts);
          return;
        }

        name = opts.name;

        // click is always disabled when register from factory
        opts.disableClick = true;

        // bubble has been registered before - increase counter
        if (cache[name]) {
          cache[name].count += 1;
          return unregister.bind(null, name);
        }

        // create lj-bubble node with params
        bubbleNode = angular.element('<div />').attr('lj-bubble', angular.toJson(opts));

        // create new isolated scope for the bubble if we not provided it
        isScopeCreated = typeof scope === 'undefined';

        if (isScopeCreated) {
          scope = $rootScope.$new(true);
        }

        bubbleNode.appendTo('body');
        $compile(bubbleNode)(scope);

        cache[name] = {
          count: 1,
          node: bubbleNode,
          scope: scope,
          isScopeCreated: isScopeCreated
        };

        // unregistration function
        return unregister.bind(null, name);
      }

      /**
       * unregister
       *
       * @name unregister
       * @function
       * @public
       * @param {string} name - ??
       */
      function unregister(name) {
        var opts = cache[name];

        if (!opts) {
          // nothing to unregister
          return;
        }

        opts.count -= 1;

        // perform remove
        if (opts.count === 0) {
          // do not destroy scope we have not created
          if (!opts.isScopeCreated) {
            opts.scope.$destroy();
          }

          opts.node.remove();
          delete cache[name];
        }
      }

      return register;
    }();

    /**
     * exists
     *
     * @name exists
     * @function
     * @public
     * @param {string} name - bubble name
     * @return {boolean} has it been registered before
     */
    factory.exists = function exists(name) {
      return _options.hasOwnProperty(name);
    };

    /**
     * Register bubble and copy options as prototype.
     * @param {String} name Bubble name
     * @param {object} options - ??
     */
    factory._register = function (name, options) {
      var opts;

      if (_options.hasOwnProperty(name)) {
        throw 'Warning: bubble with name ' + name + ' has been registered before!';
      }

      opts = angular.isDefined(options) ? angular.copy(options) : {};

      // extend with default options
      opts = angular.extend({
        closeControl: true
      }, opts);

      _options[name] = Object.create(opts);
    };

    /**
     * _unregister
     *
     * @name _unregister
     * @function
     * @private
     * @param {string} name - ??
     */
    factory._unregister = function (name) {
      delete _options[name];

      if (factory.current === name) {
        factory.current = null;
      }
    };

    /**
     * confirmBubble
     *
     * @name confirmBubble
     * @function
     * @public
     * @param {object} options - {confirm:function text,header: string}
     */
    factory.confirm = function confirmBubble(options) {
      var yes = LJ.ml('confirm.bubble.yes'),
          no = LJ.ml('confirm.bubble.no'),
          params = {
        closeControl: false,
        confirm: options.confirm,
        header: options.header,
        text: options.text,
        yes: options.yes || yes,
        no: options.no || no
      };

      factory.open(options.id, params);

      $timeout(scrollHack);
      $timeout(scrollHack, 1e2);
      $timeout(scrollHack, 2e2);
      $timeout(scrollHack, 3e2);
      /**
       * scrollHack // this @hack is to recalculate bubble position correctly
       *
       * @name scrollHack
       * @function
       * @public
       */
      function scrollHack() {
        $window.scrollBy(0, 1);
        $window.scrollBy(0, -1);
      }
    };

    /**
     * Open bubble with provided name
     * @param {String}        name       Bubble name
     * @param {Object}        [options]  Options that will be available for bubble
     * @param {jQuery|String} [node]     jQuery: Node relative to which bubble will be positioned
     *                                   String: Registered ref id
     */
    factory.open = function (name, options, node) {
      if (!_options.hasOwnProperty(name)) {
        $log.error('Bubble `' + name + '` can\'t be opened, it has not been registered yet.');
        return;
      }

      if (options instanceof jQuery) {
        node = options;
        options = {};
      }

      if (angular.isString(options)) {
        node = Ref.get(options);
        options = {};
      }

      if (angular.isObject(options)) {
        factory.options(name, options);
      }

      if (node instanceof jQuery) {
        factory.node = node;
      }

      if (angular.isString(node)) {
        factory.node = Ref.get(node);
      }

      factory.current = name;
      $rootScope.$broadcast('bubble:open', name, options, node);
      $rootScope.$broadcast('bubble:open:' + name, name, options, node);
      angular.element('body').addClass(bubbleOpenClass);
    };

    /**
     * Close all opened bubbles
     * @param {String} [name] Close bubble
     */
    factory.close = function () {
      var name = factory.current,
          options = _options[name],
          option;

      $rootScope.$broadcast('bubble:close', name, options, factory.node);
      $rootScope.$broadcast('bubble:close:' + name, name, options, factory.node);

      // clear current bubble options
      for (option in options) {
        if (options.hasOwnProperty(option)) {
          delete options[option];
        }
      }

      factory.current = null;
      factory.node = null;
      angular.element('body').removeClass(bubbleOpenClass);
    };

    /**
     * Set context for opened bubble
     * @param  {String} name    Bubble name
     * @param  {Object} options Opening context (arguments)
     * @return {Object}         Bubble options
     */
    factory.options = function (name, options) {
      if (typeof options === 'undefined' || options === _options[name]) {
        return _options[name];
      }

      angular.copy(options, _options[name]);
    };

    return factory;
  }
})();
/* <<< file end: js/core/angular/bubble.js */

//# map link was there [bubble.js.map]
/* >>> file start: js/core/angular/activity.js */
(function () {
  'use strict';

  /**
   * @ngdoc
   * @module LJ.Activity
   * @description provides Activity service
   */

  angular.module('LJ.Activity', []);

  angular.module('LJ.Activity').factory('Activity', Activity);

  /**
   * @ngdoc
   * @service Activity
   * @requires $document
   * @requires $timeout
   */
  Activity.$inject = ['$document', '$timeout'];
  /**
   * Activity
   *
   * @name Activity
   * @function
   * @public
   * @param {object} $document - document ng wrapper
   * @param {function} $timeout - setTimeout ng service
   * @return {object} service instance
   */
  function Activity($document, $timeout) {
    var active, timer;

    /**
     * isActive
     *
     * @name isActive
     * @function
     * @public
     * @return {boolean} activity status
     */
    function isActive() {
      return active;
    }

    /**
     * setActive
     *
     * @name setActive
     * @function
     * @public
     * @param {boolean|*} value - activity status
     */
    function setActive(value) {
      active = value;
    }

    refresh();

    $document.on('click touchstart touchend keydown mousemove mousewheel', LJ.Function.debounce(refresh, 1e2, true)); // call on event every 100ms

    /**
     * refresh timer
     * @description set activity on user interaction
     * @name refresh
     * @function
     * @public
     */
    function refresh() {
      $timeout.cancel(timer);
      setActive(true);

      timer = $timeout(setActive.bind(this, false), 15 * 60 * 1e3); // call in 15min
    }

    return {
      isActive: isActive
    };
  }
})();
/* <<< file end: js/core/angular/activity.js */

//# map link was there [activity.js.map]
/* >>> file start: js/core/angular/api.js */
// jscs:disable jsDoc

//!= require js/core/angular/messages.js
//= require js/core/angular/activity.js

/**
 * @description Angular wrapper of LJ.Api
 * @author Valeriy Vasin (valeriy.vasin@sup.com)
 *
 * @method call
 * @description
 * Available options:
 *  - cache: turn on/off caching for the request
 *  - silent: turn on/off messages (error/info etc)
 *  - meta: result will be returned with meta information
 *          is needed to determine is response from cache or not at the moment
 *          If provided promise will be resolved with object that contains fields:
 *          - response:  {*}       - server response
 *          - fromCache: {Boolean} - is response from cache or not
 *
 * @example Fetch without caching
 *   Api.call('rpc.method', {param: 'value'});
 *
 * @example Fetch with caching
 *   Api.call('rpc.method', { param: 'value' }, { cache: true });
 *
 * @example Usage of meta information
 *   Api.call('ratings.journals_top', params, { cache: true, meta: true })
 *     .then(function (result) {
 *       var response = result.response;
 *
 *       // cache users if result is from server
 *       if ( !result.fromCache ) {
 *
 *         Users.Cache.add(
 *           response.journals.map( LJ.Function.get('user') )
 *         );
 *       }
 *     });
 *
 * @example Turn off messages for the request
 *   Api.call('rpc.method', {param: 'value'}, {silent: true});
 *
 *
 * @method  invalidate
 * @example Cache invalidation
 *   Api.invalidate('rpc.method', {some: 'params'});
 */

(function () {
  'use strict';

  /**
   * @module LJ.Api
   */

  angular.module('LJ.Api', ['LJ.Messages', 'LJ.Activity']).factory('Api', Api);

  /**
   * @factory Api
   */
  Api.$inject = ['$timeout', '$cacheFactory', '$rootScope', '$q', 'Messages', 'Activity'];
  function Api($timeout, $cacheFactory, $rootScope, $q, Messages, Activity) {
    var factory = {
      call: call,
      invalidate: invalidate
    },
        cachePromises = $cacheFactory('LJApiPromises');

    /**
     * Get cache key for method and params
     * @param  {String} method   Method name
     * @param  {Object} [params] Method params
     */
    function getCacheKey(method, params) {
      return typeof params === 'undefined' ? method : method + angular.toJson(_sortedByKeys(params));
    }

    /**
     * Get newly greated object with properties that added in sorted order
     *
     * Notice:
     *   If not object provided - it will be returned without changes
     *
     * @param  {Object} obj Object to sort properties of
     * @return {Object}     Object with sorted properties
     */
    function _sortedByKeys(obj) {
      var sorted;

      if (!angular.isObject(obj)) {
        return obj;
      }

      sorted = {};

      Object.keys(obj).sort().forEach(function (key) {
        sorted[key] = _sortedByKeys(obj[key]);
      });

      return sorted;
    }

    /**
     * Invalidate cached data
     *
     * @param  {String} method    Methods for which we should invalidate cache
     * @param  {Object} [params]  Params for which we should invalicate cache
     */
    function invalidate(method, params) {
      cachePromises.remove(getCacheKey(method, params));
    }

    /**
     * Call JSON Rpc API
     *
     * @param {String}    method            JSON Rpc method
     * @param {Object}    [params]          JSON Rpc method params
     * @param {Function}  [callback]        Callback to call after data recieved
     * @param {Object}    [options]         Additional api options
     * @param {Boolean}   [options.cache]   Cache options: turn on/off cache for request
     * @param {Boolean}   [options.silent]  Turn on/off messages (error/info etc)
     * @param {Boolean}   [options.meta]    If set to `true` - result will be returned with meta
     *                                      information, e.g. { response, fromCache }
     *
     * @return {Promise}   Promise that will be resolved when data received
     */
    function call(method, params, callback, options) {
      var defer = $q.defer(),
          defaults = { cache: false, silent: false, meta: false },
          fromCache = false,
          promise,
          cacheKey;

      if (!Activity.isActive()) {
        defer.reject();
        return defer.promise;
      }

      // only `Object` and `null` are allowed, otherwise - empty object
      if (!angular.isObject(params) || params === null) {
        params = {};
      }

      if (angular.isObject(callback)) {
        options = callback;
        callback = null;
      }

      options = angular.extend(defaults, options || {});

      cacheKey = getCacheKey(method, params);

      if (options.cache) {
        promise = cachePromises.get(cacheKey);

        if (promise) {
          fromCache = true;
        }
      }

      if (!fromCache) {
        promise = defer.promise;

        LJ.Api.call(method, params, function (response) {
          $timeout(function () {
            // using $timeout service to mitigate inprog errors: https://goo.gl/sYX3QL
            if (response.error) {
              defer.reject(response.error);
            } else {
              defer.resolve(response);
            }
            $rootScope.$apply();
          }, 0);
          // return response;
        });

        // save original promise
        if (options.cache) {
          cachePromises.put(cacheKey, promise);
        }
      }

      // trigger events
      LJ.Event.trigger('api:request:change', method, true);
      promise.then(function () {
        LJ.Event.trigger('api:request:change', method, false);
      });

      // show errors/messages
      if (!options.silent) {
        promise.then(function showMessage(response) {
          var message = {};

          if (typeof response.message === 'undefined') {
            return;
          }

          if (angular.isString(response.message)) {
            message.body = response.message;
            message.type = 'success';
          } else {
            message.body = response.message.content;
            message.type = 'success';
          }

          Messages.add(message);
        }, function showErrorMessage(error) {
          // no error message provided
          if (typeof error.message === 'undefined') {
            return;
          }

          // Do not show internal api error
          // See: lj.api.js#handleError
          if (error.code === 1) {
            return;
          }

          Messages.error({ body: error.message });
        });
      }

      // add meta information
      if (options.meta) {
        promise = promise.then(function (response) {
          return {
            response: response,
            fromCache: fromCache
          };
        });
      }

      if (angular.isFunction(callback)) {
        promise.then(callback);
      }

      return promise;
    }

    return factory;
  }
})();
/* <<< file end: js/core/angular/api.js */

//# map link was there [api.js.map]
/* >>> file start: js/core/angular/ljMemories.js */
//= require js/core/angular/bubble.js
//= require js/core/angular/api.js

Site.page.template['angular/memories.ng.tmpl'] = '<div ng-controller=\"MemoriesCtrl\">\n\n    <div\n        class=\"b-addtomemories\"\n        ng-class=\"{ \'b-addtomemories-loading\': loading }\"\n        >\n\n        <!-- head -->\n        <h3\n            class=\"b-addtomemories-head\"\n            lj-ml=\"memories.title\"\n            ></h3>\n\n        <!-- intro -->\n        <p class=\"b-addtomemories-intro\">\n            <span\n                ng-show=\"!security\"\n                lj-ml=\"memories.title.add\"\n                ></span>\n            <span\n                ng-show=\"security\"\n                lj-ml=\"memories.title.edit\"\n                ></span>\n        </p>\n\n        <!-- items -->\n        <ul class=\"b-addtomemories-items\">\n\n            <li class=\"b-addtomemories-item\">\n                <label class=\"b-addtomemories-label\">\n                    <input\n                        type=\"radio\"\n                        name=\"security\"\n                        class=\"b-addtomemories-radio\"\n                        value=\"public\"\n                        ng-model=\"security\"\n                        ng-change=\"update()\"\n                        >\n                    <span\n                        class=\"b-addtomemories-title\"\n                        lj-ml=\"memories.security.public\"\n                        ></span>\n                </label>\n            </li>\n\n            <li class=\"b-addtomemories-item\">\n                <label class=\"b-addtomemories-label\">\n                    <input\n                        type=\"radio\"\n                        name=\"security\"\n                        class=\"b-addtomemories-radio\"\n                        value=\"friends\"\n                        ng-model=\"security\"\n                        ng-change=\"update()\"\n                        >\n                    <span\n                        class=\"b-addtomemories-title\"\n                        lj-ml=\"memories.security.friends\"\n                        ></span>\n                </label>\n            </li>\n\n            <li class=\"b-addtomemories-item\">\n                <label class=\"b-addtomemories-label\">\n                    <input\n                        type=\"radio\"\n                        name=\"security\"\n                        class=\"b-addtomemories-radio\"\n                        value=\"private\"\n                        ng-model=\"security\"\n                        ng-change=\"update()\"\n                        >\n                    <span\n                        class=\"b-addtomemories-title\"\n                        lj-ml=\"memories.security.private\"\n                        ></span>\n                </label>\n            </li>\n\n        </ul><!-- /items -->\n\n        <!-- footer -->\n        <div\n            class=\"b-addtomemories-footer\"\n            ng-show=\"removeButton\"\n            >\n            \n            <lj-flatbutton lj-flatbutton=\"[\'button\', \'memories.remove\', \'b-flatbutton b-flatbutton-simple b-flatbutton-red\', \'ng-click\', \'remove()\']\"></lj-flatbutton>\n        </div><!-- /footer -->\n\n        <p class=\"b-addtomemories-options\">\n            <a\n                ng-href=\"{{siteroot}}/tools/memadd.bml?journal={{bubble.options.journal}}&amp;itemid={{bubble.options.ditemid}}\"\n                target=\"_blank\"\n                lj-ml=\"memories.options\"\n                ></a>\n        </p>\n\n    </div><!-- /addtomemories -->\n\n</div>\n';

LJ.injectStyle('/* >>> file start: stc/popup/popup-memories.css */\n/* LJSUP-17006: [S1 entry, memories] Popup in S1 entries */\n/* Add to Memories */\n.b-addtomemories {\n    width: 150px;\n    margin: 0;\n    padding: 0;\n    text-align: left;\n    }\n.b-addtomemories-head {\n        margin: 0 0 0.5em;\n        padding: 0;\n        font: bold 1.13em/1.1 Arial,sans-serif;\n        color: #000;\n        }\n.b-addtomemories-intro {\n        margin: 0 0 0.3em;\n        }\n.b-addtomemories-items {\n        margin: 0;\n        padding: 0;\n        list-style: none;\n        }\n.b-addtomemories-item {\n            margin: 0;\n            padding: 0;\n            }\n.b-addtomemories-label {\n                display: block;\n                margin: 0 -5px;\n                padding: 5px;\n                cursor: pointer;\n                }\n.b-addtomemories-item:hover .b-addtomemories-label {\n                background: #C8E6FF;\n                }\n.b-addtomemories-footer {\n        margin: 1em 0;\n        }\n.b-addtomemories-options {\n        margin: 0.3em -5px 0;\n        padding: 0.3em 5px 0;\n        border-top: 1px solid #DAE3E6;\n        }\n.b-addtomemories-loading {\n    background: url(/img/preloader/preloader-blue-gray.gif?v=16423) no-repeat 50% 50%;\n    }\n.b-addtomemories-loading .b-addtomemories-head,\n    .b-addtomemories-loading .b-addtomemories-intro,\n    .b-addtomemories-loading .b-addtomemories-items,\n    .b-addtomemories-loading .b-addtomemories-footer,\n    .b-addtomemories-loading .b-addtomemories-options {\n        visibility: hidden;\n        }\n\n\n/* <<< file end: stc/popup/popup-memories.css */\n\n/*# sourceMappingURL=popup-memories.css.map */\n');

(function ($) {

  angular.module('LJ.Memories', ['LJ.Bubble', 'LJ.Api'])

  /**
  * Directive build memories popup
  *
  * Usage:
  *   <a
  *     href="#"
  *     lj-memories="{}"
  *     >
  *   </a>
  *
  * or
  *
  *   <a
  *     href="#"
  *     lj-memories="getOptions(element)"
  *     >
  *   </a>
  *
  * @authors
  *   Georgii Kats (g.kats@sup.com)
  */
  .directive('ljMemories', ['$parse', '$timeout', 'Bubble', function ($parse, $timeout, Bubble) {
    return {
      scope: {
        ljMemories: '&'
      },
      link: function link(scope, element) {
        var options = typeof scope.ljMemories === 'function' ? scope.ljMemories({ element: element }) : scope.ljMemories;

        if (!Bubble.exists('memories')) {
          // try to register in case it was not already in template, see LJSUP-23773
          Bubble.register({
            name: 'memories',
            template: 'memories.ng.tmpl',
            disableClick: true,
            closeOnScroll: options.closeOnScroll
          });
        }

        function clickHandler(event) {
          event.preventDefault();

          Bubble.open('memories', options, $(element));
          scope.$apply();
        }

        element.on('click', clickHandler);

        scope.$on('$destroy', function () {
          element.off('click', clickHandler);
        });
      }
    };
  }]).controller('MemoriesCtrl', ['$scope', 'Api', function ($scope, Api) {

    var bubble = $scope.bubble;

    $scope.security = null;

    // bubble size could change because of button, reposition
    $scope.$watch('removeButton', function () {
      $(window).trigger('resize');
    });

    $scope.$on('bubble:open:memories', function () {
      Api.call('memories.get', bubble.options, function (result) {
        $scope.security = result.result ? result.result.security : null;

        $scope.removeButton = Boolean($scope.security);
      });
    });

    $scope.$on('bubble:close:memories', function () {
      $scope.removeButton = false;
    });

    $scope.siteroot = LJ.get('siteroot');

    $scope.update = function () {
      Api.call('memories.set', {
        journal: bubble.options.journal,
        ditemid: bubble.options.ditemid,
        description: bubble.options.journal + ': ' + bubble.options.title.decodeHTML(),

        security: $scope.security
      }, function (result) {
        $scope.security = result;
        bubble.close();
        $scope.removeButton = true;
      });
    };

    $scope.remove = function () {
      Api.call('memories.remove', {
        journal: bubble.options.journal,
        ditemid: bubble.options.ditemid
      }, function () {
        $scope.security = null;
        bubble.close();
        $scope.removeButton = false;
      });
    };

    LJ.Event.on('api:request:change', function (method, state) {
      if (/^memories/.test(method)) {
        $scope.loading = state;
      }
    });
  }]);
})(jQuery);
/* <<< file end: js/core/angular/ljMemories.js */

//# map link was there [ljMemories.js.map]
/* >>> file start: js/core/angular/ljEmbed.js */
//= require js/core/angular/api.js
Site.page.template['angular/embed.ng.tmpl'] = '<!-- Bubble -->\n<div ng-if=\"embed.show\" class=\"ljembed-bubble\">\n    <button class=\"ljembed-bubble__close\" ng-click=\"embed.close()\" lj-svg-icon=\"flaticon--cross-2\" tabindex=\"1\"></button>\n    <header class=\"ljembed-bubble__header\">\n        <h4 class=\"ljembed-bubble__title\" lj-ml=\"embed.post.title\"></h4>\n        <span class=\"ljembed-bubble__desc\" lj-ml=\"embed.post.desc\"></span>\n        <input\n            class=\"ljembed-bubble__code\"\n            tabindex=\"2\"\n            ng-value=\"embed.code\"\n            onclick=\"this.select()\"\n        />\n        <button class=\"ljembed-bubble-copy\" ng-click=\"embed.copy()\" tabindex=\"3\">\n            <span class=\"ljembed-bubble-copy__icon\" lj-svg-icon=\"flaticon--copy\"></span>\n            <span class=\"ljembed-bubble-copy__text\" lj-ml=\"embed.post.btn.copy\"></span>\n        </button>\n    </header>\n    <div class=\"ljembed-bubble__body\">\n        <div\n            ng-if=\"embed.spinner\"\n            class=\"ljembed-bubble__spinner svgpreloader svgpreloader-pseudo svgpreloader-30\"\n            ng-class=\"{\'ljembed-bubble__spinner--show\': embed.spinner}\">\n        </div>\n        <iframe\n            ng-if=\"!embed.pre\"\n            class=\"ljembed-bubble__preview\"\n            ng-src=\"{{embed.url}}\"\n            width=\"{{embed.width}}\"\n            height=\"{{embed.height}}\"\n            ng-style=\"{ height: embed.height }\"\n        >\n        </iframe>\n    </div>\n</div>\n<!-- /Bubble -->';

//= require_ml embed.post.btn.copy
//= require_ml embed.post.title
//= require_ml embed.post.desc

(function () {

  embedCtrl.$inject = ['$scope', '$timeout', '$window', '$sce'];
  angular.module('LJ.Embed', ['LJ.Directives', 'LJ.Api']).run(function () {
    angular.element('body').addClass('j-p-embed');
    angular.element('[ng-app]').append('<div lj-embed-share></div>');
  }).directive('ljEmbedShare', ljEmbed);

  function ljEmbed() {
    return {
      scope: true,
      templateUrl: 'embed.ng.tmpl',
      controllerAs: 'embed',
      controller: embedCtrl
    };
  }

  function embedCtrl($scope, $timeout, $window, $sce) {
    var vm = this,
        klass = 'ljembed-bubble--full',
        body = angular.element('body');


    vm.show = false;
    vm.spinner = true;
    vm.width = 500 + 2;
    vm.height = 250 + 2;

    // Hide modal window after click on backdrop
    vm.fader = angular.element('[lj-embed-share]');
    vm.fader.on('click', function (e) {
      if (e.target !== e.currentTarget) return false;
      vm.close(e);
      $scope.$apply();
    });

    vm.close = function (e) {
      e && e.preventDefault();
      body.removeClass(klass);
      vm.show = false;
      vm.spinner = true;
      vm.width = 500 + 2;
      vm.height = 250 + 2;
      $window.removeEventListener('message', messageHandler);
    };

    vm.copy = function (e) {
      e && e.preventDefault();
      var code = angular.element('.ljembed-bubble__code')[0];
      code.select();
      try {
        // eslint-disable-next-line
        return document.execCommand('copy');
      } catch (ex) {
        // eslint-disable-next-line
        console.warn('Copy to clipboard failed.', ex);
        return false;
      }
    };

    LJ.Event.on('lj:embed', function (url) {
      body.addClass(klass);
      vm.show = true;
      vm.pre = true;
      vm.plainUrl = url;
      vm.url = $sce.trustAsResourceUrl(url);
      vm.code = tmpl(vm.plainUrl, vm.width, vm.height);

      // add iframe in next tick
      $timeout(function () {
        vm.pre = false;
        $window.addEventListener('message', messageHandler);
      }, 0);
    });

    function messageHandler(e) {
      if (!e.data || !e.data.height) return;

      vm.height = e.data.height;
      vm.spinner = false;
      vm.code = tmpl(vm.plainUrl, vm.width, vm.height);

      if (!$scope.$$phase) {
        $scope.$apply();
      }
    }

    function tmpl(url, width, height) {
      return '<iframe style="max-width: 100%" src="' + url + '" width="' + width + '" height="' + height + '" frameborder="0"></iframe>';
    }
  }
})(jQuery);
/* <<< file end: js/core/angular/ljEmbed.js */

//# map link was there [ljEmbed.js.map]
/* >>> file start: js/core/string.js */
(function (a) {
    return a;
})();

(function () {
    'use strict';

    LJ.define('LJ.String');

    /**
      * Add leading zeros to number until it will have correct length
      * @param  {*}      str     Any string or value that will be stringified
      * @param  {Number} length  Needed length
      * @param  {String} symbol  Symbol for padding
      * @return {String}         Padded value
      *
      * @example
      * var padded = LJ.string.pad('hello', 8, ' '); // => '   hello';
      */
    LJ.String.pad = function (str, length, symbol) {
        str = str.toString();

        if (typeof length === 'undefined') {
            throw new Error('You should provide padding string length');
        }

        if (typeof symbol === 'undefined') {
            throw new Error('You should provide padding symbol');
        }

        if (str.length >= length) {
            return str;
        }

        while (str.length < length) {
            str = symbol + str;
        }

        return str.length === length ? str : str.slice(-length);
    };

    /**
     * Capitalize string
     * @param  {String} str String to be capitalized
     * @return {String}     Capitalized string
     *
     * @example
     * LJ.String.capitalize('HELLO'); // => "Hello"
     */
    LJ.String.capitalize = function (str) {
        var length;

        if (typeof str !== 'string') {
            throw new Error('You should provide string as argument');
        }

        length = str.length;

        if (length === 0) {
            return str;
        } else if (length === 1) {
            return str.toUpperCase();
        } else {
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }
    };

    /**
     * Add https:// if not present
     * @param  {String} str Input string
     *
     * @return {String}     Link with default protocol (https://) if needed
     */
    LJ.String.linkify = function (str) {
        var rxLink = new RegExp('^(?:([a-zA-Z]+):)?//'),
            alternative = /^[a-zA-Z]+:/,
            // mailto:
        rxEmptyProtocol = /^:\/\//,
            defaultProtocol = alternative.test(str) ? '' : 'https://'; // ://yandex.ru

        return rxLink.test(str) ? str : defaultProtocol + (rxEmptyProtocol.test(str) ? str.replace('://', '') : str);
    };

    /**
     * Split by char(s), trim all values, remove empty elements
     *
     * @param  {String} str       String to split
     * @param  {String} separator Separator to use for splitting
     * @return {Array}            Array of splitted values
     */
    LJ.String.smartSplit = function (str, separator) {
        if (typeof separator === 'undefined') {
            separator = ',';
        }

        return str.split(separator).map(function (item) {
            return item.trim();
        }).filter(Boolean);
    };

    LJ.String.encodeHTML = function (str) {
        var encodeMap = {
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            '\'': '&apos;'
        };

        return str.replace(/([<>&\"\'])/g, function (m, c) {
            return encodeMap[c] ? encodeMap[c] : c;
        });
    };
})();
/* <<< file end: js/core/string.js */

//# map link was there [string.js.map]
/* >>> file start: js/core/angular/share.js */

//= require js/core/angular/bubble.js
//= require js/core/string.js

Site.page.template['angular/share.ng.tmpl'] = '<p\n        class=\"b-sharethis-head\"\n        lj-ml=\"sharing.popup.title\"\n></p>\n\n<ul\n        ng-controller=\"ShareBubbleCtrl as share\"\n        class=\"\n        b-sharethis-services\n        b-sharethis-services-{{ share.version }}\n        \"\n>\n    <li\n            ng-if=\"share.ljRepostFlag\"\n            ng-repeat=\"service in share.services\"\n            class=\"\n                b-sharethis-services-item\n                b-sharethis-{{ service.name }}\n                \"\n    >\n        <a\n                ng-if=\"service.name !== \'livejournal\'\"\n                class=\"b-sharethis-services-link\"\n                ng-class=\"{\'b-sharethis-services__open\': isAdvState}\"\n                ng-click=\"share.openPopup($event, service.name, bubble.options.params);\"\n                ng-href=\"{{ service.link }}\"\n                ng-bind=\"service.title\"\n        >\n        </a>\n        <a  ng-if=\"service.name == \'livejournal\'\"\n            class=\"b-sharethis-services-link b-sharethis-services-link--adv\"\n            ng-class=\"{\'b-sharethis-services-link--open\': isAdvState}\"\n            ng-click=\"isToogleAdv()\"\n        >\n            <span class=\"b-sharethis-services-link__title\">{{service.title}}</span>\n            <span class=\"b-sharethis-services-link__dropdown\" lj-svg-icon=\"flaticon--arrow-dropdown\"></span>\n        </a>\n        <div class=\"b-sharethis-services-adv\" ng-if=\"service.name == \'livejournal\'\">\n            <div class=\"b-sharethis-services-adv__wrap\">\n                <a class=\"b-sharethis-services-adv__link\" href=\"#\">Поделиться мнгновенно</a>\n                <a class=\"b-sharethis-services-adv__link\" href=\"#\">Поделиться</a>\n            </div>\n        </div>\n    </li>\n\n    <li\n            ng-if=\"!share.ljRepostFlag\"\n            ng-repeat=\"service in share.services\"\n            class=\"\n                b-sharethis-services-item\n                b-sharethis-{{ service.name }}\n                \"\n    >\n        <div\n            ng-if=\"service.name === \'livejournal\'\"\n            lj-share-button=\"{{share.entryUrl}}\"\n            lj-share-button-title=\"{{service.title}}\"\n        ></div>\n        <a\n            target=\"_blank\"\n            class=\"b-sharethis-services-link\"\n            ng-click=\"share.openPopup($event, service.name, bubble.options.params);\"\n            ng-href=\"{{ service.link }}\"\n            ng-if=\"service.name !== \'livejournal\'\"\n        >\n            <span class=\"b-sharethis-services-link__icon-wrap\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"svgicon flaticon flaticon--{{service.name}} b-sharethis-services-link__icon\">\n                    <use ng-href=\"#flaticon--{{service.name}}\" xlink:href=\"\"></use>\n                </svg>\n            </span>\n            <span class=\"b-sharethis-services-link__title\" ng-bind=\"service.title\"></span>\n        </a>\n    </li>\n</ul>';

//= require_ml sharing.popup.title

(function (a) {
  return a;
})();

(function () {
  'use strict';

  /**
   * Options:
   *   [lj-share-scrollable] - position of bubble will be recalculated on scroll if provided.
   *                           It's actual bubble setting - `recalculateOnScroll`
   *   [lj-share-services] - services to show. If not provided - services from server config will be shown
   *   [lj-share-services-exclude] - exclude services from bubble
   *
   *
   * @example
   *   <a
   *     href="javascript:void(0)"
   *     lj-share="{
   *       url: item.url,
   *       title: item.subject,
   *       text: item.lead,
   *       hashtags: item.hashtags
   *     }"
   *     lj-share-services-exclude="'facebook,twitter,google'"
   *     lj-share-scrollable
   *   >Share me</a>
   */

  angular.module('LJ.Share', ['LJ.Directives', 'LJ.Templates', 'LJ.Bubble']).config(['$compileProvider', function ($compileProvider) {
    $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|viber):/);
  }]).directive('ljShare', ['Bubble', function (Bubble) {
    return {
      restrict: 'A',
      scope: true,
      link: function link($scope, element, $attrs) {
        var params = $scope.$eval($attrs.ljShare),
            services = $scope.$eval($attrs.ljShareServices),
            exclude = $scope.$eval($attrs.ljShareServicesExclude);

        // string with comma separated services to show in the bubble


        // string with comma separated services to exclude from bubble


        services = services ? LJ.String.smartSplit(services) : LJ.Social.Share.services();
        exclude = exclude ? LJ.String.smartSplit(exclude) : [];

        if (exclude.length) {
          services = services.filter(function (service) {
            return exclude.indexOf(service) === -1;
          });
        }

        function share() {
          Bubble.open('share', {
            params: params,
            services: services
          }, element);
          $scope.$evalAsync();
        }

        // no services to show - do nothing
        if (!services.length) {
          return;
        }

        var unregisterBubble = Bubble.register({
          name: 'share',
          template: 'share.ng.tmpl',
          alwaysBottom: params.alwaysBottom,
          recalculateOnScroll: $attrs.hasOwnProperty('ljShareScrollable')
        });

        element.on('click', share);
        $scope.$on('$destroy', function () {
          element.off('click', share);
          unregisterBubble();
        });
      }
    };
  }]).controller('ShareBubbleCtrl', ['$scope', 'Bubble', function ($scope, Bubble) {
    var vm = this,
        that = vm;


    this.ljRepostFlag = LJ.Flags.isEnabled('lj_repost');

    $scope.isAdvState = false;

    $scope.$on('bubble:open:share', function () {
      that.version = LJ.Flags.isEnabled('adaptive_lj_mobile') ? 'v4' : 'v3';
      that.services = $scope.bubble.options.services.map(function (service) {
        return {
          name: service,
          link: LJ.Social.Share.getUrl(service, $scope.bubble.options.params),
          title: LJ.Social.Share.getTitle(service)
        };
      });
      vm.entryUrl = $scope.bubble.options.params.url;
    });

    $scope.isToogleAdv = function () {
      $scope.isAdvState = !$scope.isAdvState;
    };

    that.openPopup = function (event, service, params) {
      if (LJ.Social.Share.isTab(service)) {
        Bubble.close('share');
        return;
      }

      event.preventDefault();
      LJ.Social.Share.openPopup(service, params);
      Bubble.close('share');
    };
  }]);
})();
/* <<< file end: js/core/angular/share.js */

//# map link was there [share.js.map]
/* >>> file start: js/core/angular/options.js */
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/**
 * Base implementation for services options
 *
 * @example
 *
 * var options = Options.create({
 *   counter: 25
 * });
 * console.log(options.counter); // => 25
 *
 * options.set('counter', 15);
 * console.log( options.raw().counter ); // => 15
 *
 * options.set({ counter: 10 });
 * console.log( options.counter ); // => 10
 *
 */
angular.module('LJ.Options', []).factory('Options', [function () {
  return {
    create: function create(options) {
      if (typeof options === 'undefined') {
        options = {};
      }

      if ((typeof options === 'undefined' ? 'undefined' : _typeof(options)) !== 'object') {
        throw new TypeError('Options should be an object.');
      }

      /**
       * @name set
       * @description sets options value by key or merge opts object into options
       * @param {(string|number)|object} opts - key to extend by or extend object
       * @param {*} [value] - value to set in options
       */
      function set(opts, value) {
        if (typeof value === 'undefined') {
          angular.extend(options, opts);
        } else {
          options[opts] = value;
        }
      }

      /**
       * @name get
       * @description get value from options by given key
       * @param {string|number} key
       * @return {*} value from options object
       */
      function get(key) {
        return options[key];
      }

      /**
       * @name raw
       * @description get options object
       * @returns {object} options
       */
      function raw() {
        return options;
      }

      return {
        set: set,
        get: get,
        raw: raw
      };
    }
  };
}]);
/* <<< file end: js/core/angular/options.js */

//# map link was there [options.js.map]
/* >>> file start: js/core/angular/ljTour.js */

//= require js/core/angular/bubble.js
//= require js/core/angular/api.js
//= require js/core/angular/ref.js

Site.page.template['angular/bubbletour.ng.tmpl'] = '<div class=\"b-helptour\">\n    <header class=\"b-helptour-header\" ng-hide=\"current.length < 2\">\n        <span class=\"b-helptour-stage\">\n            <span class=\"b-helptour-stage-prev\" ng-bind=\"index\"></span>\n            <span class=\"b-helptour-stage-hr\">/</span>\n            <span class=\"b-helptour-stage-next\" ng-bind=\"current.length\"></span>\n        </span>\n    </header>\n    <div class=\"b-helptour-content b-text\">\n        <span lj-ml=\"{{step.tourText}}\" lj-ml-dynamic=\"index\"></span>\n    </div>\n    <footer class=\"b-helptour-footer\">\n        <ul class=\"b-helptour-controls b-helptour-state\">\n            <li class=\"b-helptour-control b-helptour-control-skip\"\n                ng-hide=\"step.tourNoSkip || index === current.length\">\n                <a class=\"b-helptour-skip-link b-helptour-link\" href=\"javascript:void(0)\" lj-ml=\"tour.steps.skip\"\n                   ng-click=\"end()\"></a>\n            </li>\n        </ul>\n        <ul class=\"b-helptour-controls b-helptour-step\">\n            <li class=\"b-helptour-control b-helptour-control-prev\"\n                ng-hide=\"step.tourNoBack || index === 1\">\n                <a class=\"b-helptour-prev-link b-helptour-link\" href=\"javascript:void(0)\" lj-ml=\"tour.steps.prev\"\n                   ng-click=\"prev()\"></a>\n            </li>\n            <li class=\"b-helptour-control b-helptour-control-next\"\n                ng-hide=\"step.tourNoNext || index === current.length\">\n                <a class=\"b-helptour-next-link b-helptour-link\" href=\"javascript:void(0)\" lj-ml=\"tour.steps.next\"\n                   ng-click=\"next()\"></a>\n            </li>\n            <li class=\"b-helptour-control b-helptour-control-done\"\n                ng-hide=\"index !== current.length\">\n                <a class=\"b-helptour-done-link b-helptour-link\" href=\"javascript:void(0)\" lj-ml=\"tour.steps.done\"\n                   ng-click=\"end()\"></a>\n            </li>\n        </ul>\n    </footer>\n</div>\n';
LJ.injectStyle('/* >>> file start: stc/tour/ljtour.css */\n/*  LJ tour\n    LJSUP-20481 Create tour for Air [DF:air_tour]\n    LJSUP-18759 Friends Feed Tour\n */\n\n.b-bubble-tour {\n    z-index: 5001;\n    }\n\n.b-bubble-tour .b-popup-inner {\n        padding: 0;\n        }\n\n.b-helptour {\n    width: 350px;\n    }\n\n.b-helptour-header {\n    margin: 0 0 .3em;\n    padding: 10px 16px 0;\n    }\n\n.b-helptour-header:after,\n    .b-helptour-footer:after {\n        display: table;\n        width: 100%;\n        clear: both;\n        content: \"\";\n        }\n\n.b-helptour-stage-title {\n    margin-right: 10px;\n    }\n\n.b-helptour P:first-child {\n    margin: 0 0 .3em;\n    }\n\n.b-helptour-content {\n    margin: 10px 0 .6em;\n    padding: 0 16px;\n    }\n\n.b-helptour-content P {\n        margin: .3em 0;\n        }\n\n.b-helptour-content UL,\n    .b-helptour-content LI {\n        margin: 0;\n        padding: 0;\n        list-style: none;\n        }\n\n.b-helptour-footer {\n    padding: 6px 15px;\n    border-radius: 0 0 5px 5px;\n    background-color: #DAE3E6;\n    }\n\n.b-helptour-controls {\n        margin: 0;\n        padding: 0;\n        }\n\n.b-helptour-state {\n        float: left;\n        }\n\n.b-helptour-step {\n        float: right;\n        }\n\n.b-helptour-control {\n            display: inline;\n            margin-right: 4px;\n            cursor: pointer;\n            }\n\n.b-helptour-control-done:after {\n            display: inline-block;\n            content: \"\";\n            width: 14px;\n            height: 12px;\n            background-image: url(/img/icons/unit_v3.png?v=42878);\n            background-repeat: no-repeat;\n            background-position: 0 -223px;\n            }\n\n.b-helptour-control-done A {\n                padding-left: 8px;\n                }\n\n.b-helptour-control-next A:link,\n        .b-helptour-control-prev A:link,\n        .b-helptour-control-done A:link,\n        .b-helptour-control-done A:visited {\n            color: #00A3D9;\n            }\n\n.b-helptour-control-skip A:link,\n        .b-helptour-control-skip A:visited {\n            color: #7A9199;\n            }\n\n.b-helptour-control A {\n            font-size: 13px;\n            }\n\n.b-helptour-control A:hover,\n        .b-helptour-control A:active,\n        .b-helptour-control A:focus {\n            color: #0086b3;\n            }\n\n/* LJ Tour Bubble Fix (LJSUP-19404) */\n\n.p-ljtour .b-lenta .l-flatslide-container {\n    position: static;\n    }\n\n.p-ljtour .l-flatslide-menu-controls {\n    position: absolute;\n    top: auto !important;\n    }\n\n/* tour fader journal fix (LJSUP-21075) */\n\n.p-ljtour.p-openpopup .w-cs {\n    overflow: visible;\n    }\n\n@media all and (max-width: 650px) {\n\n    .p-ljtour.p-openpopup .b-fader {\n        display: none !important;\n        }\n\n    .b-bubble-tour {\n        display: none;\n        }\n\n}\n\n\n\n\n/* <<< file end: stc/tour/ljtour.css */\n\n/*# sourceMappingURL=ljtour.css.map */\n');

//= require_ml tour.steps.prev
//= require_ml tour.steps.next
//= require_ml tour.steps.skip
//= require_ml tour.steps.done

/**
 * Tour Module.
 *
 * Create tour for new users.
 * Use Bubbles module and data-attributes for steps set.
 *
 * data attributes:
 *    data-tour     - Tour name/id
 *    data-tour-step     - Step of this tour
 *    data-tour-step-discard-duplicates - Won't add this step second time
 *    data-tour-no-skip  - Hide 'skip' link
 *    data-tour-no-back  - Hide 'back' link
 *    data-tour-title    - ML variable for step title
 *    data-tour-text     - ML variable for step text
 *    data-tour-owner    - Tour only starts on user domain
 *    data-tour-skip-if  - Skip this step if LJ.get('data-tour-skip-if value') returns true
 *                          can be multiple (comma separated)
 *                    eg. data-tour-skip-if="remote.is_friend"
 *                    eg. data-tour-skip-if="!remote.is_sup, !flags.some_flag"
 *    data-tour-force-x  - force bubble position by x
 *    data-tour-force-y  - force bubble position by y
 *
 *    data-tour-bubble   - Bubble options JSON
 *    data-tour-start-page      - Starts only on page url matches the pattern.
 *                                ( e.g. data-tour-page='^/feed' )
 *
 * Example:
 *
 *  <span
 *      data-tour="friendsFeedTour"
 *      data-tour-step="3"
 *      data-tour-no-skip="true"
 *      data-tour-no-back="true"
 *      data-tour-owner="true"
 *      data-tour-bubble='{
 *        "alwaysBottom": true,
 *        "alwaysRight": true,
 *        "forceY": 10,
 *        "aside": true
 *      }'
 *      data-tour-skip-if="remote_is_sup, !flags.regionalrating_tour"
 *      data-tour-title="tour.friendsfeed.title"
 *      data-tour-text="tour.friendsfeed.step3.filter.tip"
 *      >Menu</span>
 *
 *
 * Need registered bubble with name 'tour'
 * with default bubble options
 *
 * e.g.: <div lj-bubble="{ name: 'tour', template: 'bubbletour.ng.tmpl', closeControl: false, disableClick: false
 * }"></div>
 *
 */

(function (a) {
  return a;
})();

(function ($) {
  'use strict';

  angular.module('LJ.Tour', ['LJ.Bubble', 'LJ.Templates', 'LJ.Directives', 'LJ.Api']).factory('Tour', ['Api', function (Api) {
    var factory = {};

    factory.queue = {};

    factory.checkAvailable = function () {
      var names = Object.keys(factory.queue);
      return Api.call('tour.is_available', {
        tours: names
      }).then(function (response) {

        names.forEach(function (name) {
          if (response.states[name] === 0) {
            delete factory.queue[name];
          }
        });
      });
    };

    factory.setDone = function (tour) {
      return Api.call('tour.set_done', { tour: tour });
    };

    return factory;
  }]).directive('ljTour', ['$timeout', '$document', 'Bubble', 'Ref', 'Tour', function ($timeout, $document, Bubble, Ref, Tour) {
    return {
      scope: true,
      link: function link($scope) {
        var queue = Tour.queue,
            fader = angular.element(document.querySelector('.b-fader')),
            isSearchDone = false,
            destroyBubble;

        /**
         * @todo Remove scope dependency inside of the bubble.
         *       Do it using controller and factory
         */
        destroyBubble = Bubble.register({
          name: 'tour',
          template: 'bubbletour.ng.tmpl',
          closeControl: false
        }, $scope);

        // Flag name 'friendsfeed_tour' is historical fail
        if (LJ.Flags.isEnabled('friendsfeed_tour') && !LJ.Support.isMobile() && !isSearchDone) {
          isSearchDone = true;
          $timeout(function () {
            search();
            Tour.checkAvailable().then(nextTour);
          });
        }

        $scope.next = next;
        $scope.prev = prev;
        $scope.end = endTour;

        function search() {
          $('body').find('[data-tour]').each(function () {
            var element = $(this),
                data = angular.extend({ element: element }, element.data());
            if (!Array.isArray(queue[data.tour])) {
              queue[data.tour] = [];
            }
            if (data.tourStepDiscardDuplicates && queue[data.tour].some(function (t) {
              return t.tourStep === data.tourStep;
            })) return;
            queue[data.tour].push(data);
          });
        }

        function startTour() {
          var firstFiltered = Object.keys(queue)[0],
              current = queue[firstFiltered];

          $scope.current = current.filter(function (step) {
            return _isOwner(step) && _isSkipped(step);
          }).sort(function (step1, step2) {
            if (step1.tourStep > step2.tourStep) {
              return 1;
            } else if (step1.tourStep < step2.tourStep) {
              return -1;
            } else {
              return 0;
            }
            (function (a) {
              return a;
            })();
          });

          $scope.current.forEach(function (step) {
            Ref.add(step.tour + step.tourStep, step.element);
          });

          delete queue[firstFiltered];

          // start tour on start page / from first step
          if (_isStartPage($scope.current[0])) {
            firstStep();
          } else {
            nextTour();
          }
        }

        function nextTour() {
          // if queue is not empty
          if (Object.keys(queue).length) {
            startTour();
          }
        }

        function endTour() {
          Bubble.close();
          fader.fadeOut();
          angular.element('body').removeClass('p-ljtour').off('ljsale-load', _fakeResize);

          Tour.setDone($scope.step.tour);
          fader.off('click', endTour);
          $scope.current = null;
          $scope.step = null;
          nextTour();
        }

        function firstStep() {
          angular.element('body').addClass('p-ljtour').on('ljsale-load', function (event) {
            if (event.originalEvent.data.slot) {
              _fakeResize();
            }
          });

          // Check for layers using fader, tour has lower priority.
          if (fader.is(':visible')) {
            $timeout(firstStep, 300);
            return;
          }

          next();
          fader.on('click', endTour).fadeIn();

          $scope.current = $scope.current.filter(function (step) {
            return _isVisible(step.element);
          });
        }

        function next() {
          var index = $scope.current.indexOf($scope.step);

          if (index < $scope.current.length - 1) {
            $scope.step = $scope.current[++index];
            $scope.index = ++index;

            openBubble();
          } else {
            endTour();
          }
        }

        function prev() {
          var index = $scope.current.indexOf($scope.step);

          if (index > 0) {
            $scope.step = $scope.current[--index];
            $scope.index = ++index;
            openBubble();
          }
        }

        function _isOwner(data) {
          return data.hasOwnProperty('tourOwner') ? LJ.get('remote.username') === LJ.get('journal.username') : true;
        }

        // Check skip-if value
        function _isSkipped(data) {

          if (!data.hasOwnProperty('tourSkipIf')) {
            return true;
          } else {
            return data.tourSkipIf.split(',').every(function (expression) {
              expression = expression.trim();

              return expression.charAt(0) === '!' ? LJ.get(expression.slice(1)) : !LJ.get(expression);
            });
          }
        }

        function _isVisible(element) {
          return element.is(':visible') && element.css('opacity') !== 0 && element.css('visibility') !== 'hidden';
        }

        // check start page of tour
        function _isStartPage(step) {
          return !step ? false : step.hasOwnProperty('tourStartPage') ? new RegExp(step.tourStartPage, 'i').test(location.pathname) : step.tourStep === 1;
        }

        function _fakeResize() {
          angular.element(window).trigger('resize');
          _scrollToCurrent();
        }

        function openBubble() {

          if (!$scope.step) {
            return;
          }

          if (!$scope.step.element.is(':visible')) {
            return next();
          }

          if (Bubble.current) {
            Bubble.close();
          }

          //wait for angular directives render
          $timeout(function () {
            var options = Bubble.options('tour') || {};
            Bubble.open('tour', angular.extend(options, $scope.step.tourBubble), $scope.step.element);
            _scrollToCurrent();
          });

          LJ.Event.once('visual_editor_ready', function () {
            $timeout(_fakeResize);
          });
        }

        function _scrollToCurrent() {
          Ref.scrollTo($scope.step.tour + $scope.step.tourStep, { onlyOutOfScreen: true });
        }

        function keydown(event) {
          if (!$scope.current || !$scope.current.length) {
            return;
          }

          switch (event.which) {
            case 27:
              endTour();
              break;
            case 37:
              prev();
              break;
            case 39:
              next();
              break;
          }

          $scope.$apply();
        }

        $document.on('keydown', keydown);
        $scope.$on('$destroy', function () {
          $document.off('keydown', keydown);
          destroyBubble();
        });
      }
    };
  }]);
})(jQuery);
/* <<< file end: js/core/angular/ljTour.js */

//# map link was there [ljTour.js.map]
/* >>> file start: js/core/angular/ljRemoveRepost.js */
//= require js/core/angular/api.js
//= require js/core/angular/bubble.js

Site.page.template['angular/ljRemoveRepost.ng.tmpl'] = '<div ng-controller=\"RemoveRepostCtrl as remove\">\n\n    <div\n        class=\"b-removerepost\"\n        ng-class=\"{ \'b-removerepost-loading\': loading }\"\n        >\n        <!-- intro -->\n        <p class=\"b-removerepost-intro\">\n            <span\n                lj-ml=\"repost.confirm.delete\"\n                ></span>\n        </p>\n\n        <!-- footer -->\n         <div\n            class=\"b-removerepost-footer\"\n            >\n            <div class=\"b-popup-submit-options\">\n                <span class=\"b-popup-preloader\">\n                    <span\n                        class=\"b-popup-preloader-inner\"\n                        >\n                        <button\n                            class=\"\n                                b-flatbutton\n                                b-flatbutton-simple\n                                \"\n                            type=\"button\"\n                            ng-click=\"remove.submit()\"\n                            lj-ml=\"confirm.bubble.yes\"\n                            ></button>\n                        <i class=\"preloader\"></i>\n                    </span>\n                    <button\n                        href=\"\"\n                        class=\"\n                            b-flatbutton\n                            b-flatbutton-simple\n                            b-flatbutton-neutral\n                            \"\n                        ng-click=\"remove.cancel()\"\n                        lj-ml=\"confirm.bubble.no\"\n                        ></button>\n                </span>\n            </div>\n        </div>\n    </div>\n</div>\n';

//= require_ml repost.confirm.delete
//= require_ml confirm.bubble.yes
//= require_ml confirm.bubble.no

LJ.injectStyle('/* >>> file start: stc/popup/popup-delete-repost.css */\n.b-removerepost {\n    width: 200px;\n    margin: 0;\n    padding: 0;\n    text-align: left;\n    }\n    .b-removerepost-head {\n        margin: 0 0 0.5em;\n        padding: 0;\n        font: bold 1.13em/1.1 Arial,sans-serif;\n        color: #000;\n        }\n    .b-removerepost-intro {\n        margin: 0 0 0.3em;\n        }\n    .b-removerepost-footer {\n        margin: 1em 0 0;\n        }\n    .b-removerepost-loading {\n    background: url(/img/preloader/preloader-blue-gray.gif?v=16423) no-repeat 50% 50%;\n    }\n    .b-removerepost-loading .b-removerepost-head,\n    .b-removerepost-loading .b-removerepost-intro,\n    .b-removerepost-loading .b-removerepost-footer {\n        visibility: hidden;\n        }\n\n\n/* <<< file end: stc/popup/popup-delete-repost.css */\n\n/*# sourceMappingURL=popup-delete-repost.css.map */\n');


(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.RemoveRepost', ['LJ.Bubble', 'LJ.Api']).run(['Bubble', function (Bubble) {
    Bubble.register({
      name: 'removeRepost',
      template: 'ljRemoveRepost.ng.tmpl',
      recalculateOnScroll: true,
      alwaysBottom: true
    });
  }])

  /**
  * Directive build memories popup
  *
  * Usage:
  *   <button
  *     lj-remove-post="post"
  *     >
  *   </button>
  *
  * @authors
  *   Georgii Kats (g.kats@sup.com)
  */
  .directive('ljRemoveRepost', ['Api', 'Bubble', function (Api, Bubble) {
    return {
      scope: {
        post: '=ljRemoveRepost'
      },
      link: function link($scope, $element) {
        function onClick(event) {
          event.preventDefault();

          Bubble.open('removeRepost', { post: $scope.post }, $element);
          $scope.$evalAsync();
        }

        $element.on('click', onClick);

        $scope.$on('$destroy', function () {
          $element.off('click', onClick);
        });
      }
    };
  }]).controller('RemoveRepostCtrl', ['$scope', '$rootScope', 'Api', '$window', function ($scope, $rootScope, Api, $window) {
    var bubble = $scope.bubble,
        post;


    $scope.$on('bubble:open:removeRepost', function (event, name, params) {
      post = params.post;
    });

    this.submit = function () {
      Api.call('repost.delete', { url: post.permalink_url }).then(function () {
        $rootScope.$emit('feed:item:remove', post.itemid);
        bubble.close();
        // If in own journal,
        // refreshing to its new state without repost
        if (LJ.get('journal.id') === LJ.get('remote.id')) {
          $window.location.reload();
        }
      });
    };

    this.cancel = function () {
      bubble.close();
    };
  }]);
})(jQuery);
/* <<< file end: js/core/angular/ljRemoveRepost.js */

//# map link was there [ljRemoveRepost.js.map]
/* >>> file start: js/discovery/directives.js */

//= require js/core/angular/api.js
Site.page.template['angular/ljImage.ng.tmpl'] = '<a ng-href=\"{{link}}\">\n    <figure class=\"b-journalpicture\">\n        <img\n            class=\"b-journalpicture-image\"\n            title=\"{{textContent}}\"\n            alt=\"{{textContent}}\"\n            ng-src=\"{{source}}\"\n            ng-style=\"dimensions\"\n            >\n        <figcaption class=\"b-journalpicture-caption\" lj-html=\"content\"></figcaption>\n    </figure>\n</a>\n';
Site.page.template['angular/ljGallery.ng.tmpl'] = '<div\n    class=\"b-journalgallery\"\n    ng-style=\"galleryDimensions\"\n    ng-class=\"{\n        \'b-journalgallery-hightpriority\': isTall\n    }\"\n    >\n    <div\n        class=\"b-journalgallery-container\"\n        ng-style=\"containersDimensions\"\n        >\n        <figure\n            class=\"b-journalgallery-picture\"\n            ng-repeat=\"item in items\"\n            ng-style=\"containersDimensions\"\n            ng-if=\"isNearby($index)\"\n            ng-class=\"{\n                \'b-journalgallery-picture-prev\': $index < state.index,\n                \'b-journalgallery-picture-current\': $index === state.index,\n                \'b-journalgallery-picture-next\': $index > state.index\n            }\"\n            >\n            <span\n                class=\"\n                    b-journalgallery-preloader\n                    svgpreloader\n                    svgpreloader-tag\n                    svgpreloader-16\n                    \"\n                    ></span>\n            <div class=\"b-journalgallery-wrapper\"\n                style=\"background-image: url({{item.src}}); max-width: {{item.width}}; max-height: {{item.height}}\">\n                <img\n                    ng-src=\"{{item.src}}\"\n                    class=\"b-journalgallery-image\"\n                    lj-gallery-load\n                    >\n            </div>\n            <figcaption class=\"b-journalgallery-caption\">\n                <span\n                    class=\"b-journalgallery-caption-title\"\n                    lj-html=\"item.content\"></span>\n            </figcaption>\n        </figure>\n    </div>\n    <span\n        class=\"b-journalgallery-counter\"\n        ng-bind=\"(state.index + 1) + \'/\' + (state.total+1)\"\n        ></span>\n    <span\n        class=\"b-journalgallery-nav b-journalgallery-nav-prev\"\n        ng-show=\"state.index !== 0\"\n        ng-click=\"prev()\"\n        ></span>\n    <span\n        class=\"b-journalgallery-nav b-journalgallery-nav-next\"\n        ng-show=\"state.index < state.total\"\n        ng-click=\"next()\"\n        ></span>\n</div>\n';
Site.page.template['angular/discovery/ljSuggest.ng.tmpl'] = '<div\n    class=\"b-mainpage-seealso\"\n    ng-if=\"suggest\"\n    >\n\n    <!-- head -->\n    <h3\n        class=\"b-mainpage-seealso-head\"\n        lj-ml=\"discovery.article.seealso\"\n        ></h3>\n\n    <!-- items -->\n    <ul class=\"b-mainpage-seealso-items\">\n        <li\n            class=\"b-mainpage-seealso-item\"\n            ng-repeat=\"suggested in suggest\"\n            >\n            <a\n                ng-href=\"{{suggested.url}}\"\n                class=\"b-mainpage-seealso-link\"\n                data-track-event=\"LJMag:Post:OpenSeeAlso\"\n                >\n                <span\n                    class=\"b-mainpage-seealso-pic\"\n                    ng-if=\"suggested.image\"\n                    ng-style=\"{ backgroundImage: \'url({{suggested.image}})\' }\"\n                    ></span>\n                <span\n                    class=\"b-mainpage-seealso-title\"\n                    lj-html=\"suggested.subject\"\n                    ></span>\n            </a>\n            <span class=\"b-mainpage-seealso-user\" ng-if=\"suggested.user\">\n                <span\n                    lj-user-dynamic=\"suggested.user.username\"\n                    lj-user-dynamic-options=\"{target: \'_blank\'}\"\n                    ></span>\n            </span>\n        </li>\n    </ul><!-- /items -->\n\n</div>\n';
Site.page.template['angular/widgets/authors/posts.ng.tmpl'] = '<!-- author\'s posts -->\n\n<div\n    class=\"\n        b-authorsposts\n        l-flatslide-aside-block\n        \"\n    ng-class=\"{\n        \'b-authorsposts-loading\': state.isLoading,\n        \'b-authorsposts-empty\': !posts.length\n    }\"\n    >\n\n    <!-- head -->\n    <header class=\"b-authorsposts-head\">\n        <h3\n            class=\"b-authorsposts-title\"\n            lj-ml=\"main.authorsposts.head\"\n            >\n        </h3>\n    </header>\n\n    <!-- body -->\n    <div class=\"b-authorsposts-body\">\n\n        <!-- items -->\n        <ul class=\"b-authorsposts-items\">\n\n            <!-- item -->\n            <li class=\"b-authorsposts-item\"\n                ng-repeat=\"post in posts\">\n\n                <!-- link -->\n                <a\n                    class=\"b-authorsposts-link\"\n                    data-track-event=\"LJMag:Post:OpenAnotherPostByAuthor:{{post.user.username}}\"\n                    ng-href=\"{{ post.url }}\"\n                    >\n                    <!-- pic -->\n                    <span\n                        class=\"b-authorsposts-pic\"\n                        style=\"background-image: url({{post.image}});\"\n                        ng-if=\"post.image\"\n                        ></span>\n                    <!-- subject -->\n                    <span\n                        class=\"b-authorsposts-subject\"\n                        lj-html=\"post.subject\"\n                        ></span>\n                </a>\n\n            </li>\n\n        </ul>\n\n        <!-- dummy loader -->\n        <div class=\"b-authorsposts-dummy\">\n            <div class=\"b-authorsposts-dummy-item\">\n                <span class=\"b-authorsposts-dummy-pic\"></span>\n                <div class=\"b-authorsposts-dummy-caption\">\n                    <span class=\"b-authorsposts-dummy-subject\"></span>\n                </div>\n            </div>\n            <div class=\"b-authorsposts-dummy-item\">\n                <span class=\"b-authorsposts-dummy-pic\"></span>\n                <div class=\"b-authorsposts-dummy-caption\">\n                    <span class=\"b-authorsposts-dummy-subject\"></span>\n                </div>\n            </div>\n            <div class=\"b-authorsposts-dummy-item\">\n                <span class=\"b-authorsposts-dummy-pic\"></span>\n                <div class=\"b-authorsposts-dummy-caption\">\n                    <span class=\"b-authorsposts-dummy-subject\"></span>\n                </div>\n            </div>\n        </div>\n\n    </div><!-- /body -->\n\n</div><!-- /authorsposts -->\n\n\n';

LJ.injectStyle('/* >>> file start: stc/lj_gallery.css */\n/* Journal Gallery\n----------------------------------- */\n/*\n<lj-gallery height=\"[x]\" width=\"[x]\">\n    <lj-gallery-item src=\"[image url]\" href=\"[link url]\"> подпись </lj-gallery-item>\n    <lj-gallery-item src=\"[image url]\" href=\"[link url]\"> подпись </lj-gallery-item>\n    <lj-gallery-item src=\"[image url]\" href=\"[link url]\"> подпись </lj-gallery-item>\n</lj-gallery>\n*/\n.b-journalgallery {\n    overflow: hidden;\n    display: block;\n    position: relative;\n    width: 100%;\n    margin: 0 auto;\n    padding: 0 0 70px;\n    font: 600 13px/1.1 \'ProximaNova\', Tahoma, Arial, sans-serif;\n    font: 600 .8125rem/1.1 \'ProximaNova\', Tahoma, Arial, sans-serif;\n    }\n/* container */\n.b-journalgallery-container {\n        position: relative;\n        margin: 0 auto;\n        background: #FFF;\n        }\n/* picture */\n.b-journalgallery-picture {\n            position: absolute;\n            top: 0;\n            width: 100%;\n            margin: 0 !important;\n            transition: 500ms cubic-bezier(0.250, 0.250, 0.750, 0.750) all;\n            display: -webkit-flex;\n            display: -ms-flexbox;\n            display: flex;\n            text-align: center;\n            }\n.b-journalgallery-picture::after {\n                content: \'\';\n                display: inline-block;\n                height: 100%;\n                margin: 0 0 0 -0.05em; /* To offset spacing. May vary by font */\n                vertical-align: middle;\n                }\n.b-journalgallery-preloader.svgpreloader {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                margin: -8px 0 0 -8px;\n                }\n.b-journalgallery-wrapper {\n                position: absolute;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                left: 0;\n                margin: auto;\n                background-size: contain;\n                background-repeat: no-repeat;\n                background-position: 50% 50%;\n                }\n.b-journalgallery-hightpriority .b-journalgallery-wrapper {\n                display: inline;\n                }\n.b-journalgallery-image {\n                    display: none;\n                    }\n.b-journalgallery.b-journalgallery-hightpriority .b-journalgallery-picture .b-journalgallery-wrapper .b-journalgallery-image {\n                    width: auto;\n                    max-height: 100%;\n                    }\n.b-journalgallery-caption {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                height: 70px; /* eq to b-journalgallery padding-bottom */\n                margin: 0;\n                padding: 0;\n                border: 0;\n                text-align: center;\n                background: #FFF;\n                color: #829399;\n                }\n.b-journalgallery-caption-title {\n                    overflow: hidden;\n                    position: absolute;\n                    top: 0;\n                    right: 40px;\n                    left: 40px;\n                    height: 3.3em;\n                    margin: 0;\n                    padding: 10px 2px 0;\n                    line-height: 1.1;\n                    }\n.b-journalgallery-picture-loaded {\n            background-image: none;\n            }\n.b-journalgallery-picture-loaded .b-journalgallery-image {\n                opacity: 1;\n                }\n.b-journalgallery-picture-prev {\n            -webkit-transform: translate3d(-100%, 0, 0);\n                    transform: translate3d(-100%, 0, 0);\n            opacity: 0;\n            }\n.b-journalgallery-picture-next {\n            -webkit-transform: translate3d(100%, 0, 0);\n                    transform: translate3d(100%, 0, 0);\n            opacity: 0;\n            }\n.b-journalgallery-picture-current {\n            -webkit-transform: translate3d(0, 0, 0);\n                    transform: translate3d(0, 0, 0);\n            }\n/* counter */\n.b-journalgallery-counter {\n        position: absolute;\n        bottom: 44px;\n        right: 0;\n        margin: 0;\n        padding: 2px;\n        border: 0;\n        text-align: right;\n        color: #829399;\n        }\n/* prev-next arrows */\n.b-journalgallery-nav {\n        position: absolute;\n        top: 0;\n        bottom: 70px; /* .b-journalgallery {padding-bottom} */\n        margin: 0;\n        padding: 0;\n        border: 0;\n        cursor: pointer;\n        font: 0/0 a;\n        }\n.b-journalgallery-nav:before {\n        content: \" \";\n        position: absolute;\n        top: 50%;\n        width: 50px;\n        height: 50px;\n        margin: -25px 0 0;\n        padding: 0;\n        border: 0;\n        border-radius: 3px;\n        background: #839399;\n        }\n.b-journalgallery-nav:hover:before {\n        background: #09C;\n        }\n.b-discoveryarticle .b-journalgallery-nav:hover:before {\n        background: #39BF71;\n        }\n.b-journalgallery-nav:after {\n        content: \" \";\n        position: absolute;\n        top: 50%;\n        width: 9px;\n        height: 16px;\n        margin: -8px 0 0;\n        padding: 0;\n        background: url(/img/icons/journalgallery.png?v=39648) no-repeat 0 0;\n        }\n/* prev */\n.b-journalgallery-nav-prev {\n        left: 0;\n        width: 30%;\n        }\n.b-journalgallery-nav-prev::before {\n        left: 20px;\n        }\n.b-journalgallery-nav-prev::after {\n        left: 40px;\n        }\n/* next */\n.b-journalgallery-nav-next {\n        right: 0;\n        width: 70%;\n        }\n.b-journalgallery-nav-next::before {\n        right: 20px;\n        }\n.b-journalgallery-nav-next::after {\n        right: 40px;\n        background-position: 0 -17px;\n        }\n@media all and (max-width: 480px) {\n\n    /* prev */\n    .b-journalgallery-nav-prev::before {\n        left: 0;\n        }\n    .b-journalgallery-nav-prev::after {\n        left: 20px;\n        }\n    /* next */\n    .b-journalgallery-nav-next::before {\n        right: 0;\n        }\n    .b-journalgallery-nav-next::after {\n        right: 20px;\n        }\n\n}\n\n/* <<< file end: stc/lj_gallery.css */\n\n/*# sourceMappingURL=lj_gallery.css.map */\n');

angular.module('Discovery.Tags', ['LJ.Templates', 'LJ.Api'])
/**
 * Discovery tags bootstrap. Should be used in conjunction with lj-html directive
 */
.directive('ljDiscoveryTags', ['$compile', function ($compile) {
  var TAGS = ['lj-gallery', '[lj-memories]', '[lj-lazy]', '[lj-share]', '[lj-likus]', '[lj-cut]', '[lj-screenable]', '[feed-promo-control]', '[feed-promo-click]', '[lj-remove-repost]', '[lj-quick-comments]', '[ng-bind]', '[ng-show]', '[lj-sticky]'];

  return {
    restrict: 'A',
    terminal: true,
    link: function link(scope, element) {
      $compile(element.find(TAGS.join(',')))(scope);
    }
  };
}]).directive('ljGallery', ['$templateCache', '$compile', function ($templateCache, $compile) {
  return {
    restrict: 'E',
    scope: true,
    link: function link(scope, element, attrs) {
      scope.paddingTop = 75;
      scope.maxWidth = attrs.width || 2000;
      scope.maxHeight = attrs.height || 350;

      scope.containersDimensions = {
        paddingTop: scope.paddingTop + '%'
      };
      scope.galleryDimensions = {
        maxWidth: scope.maxWidth + 'px',
        maxHeight: scope.maxHeight + 'px'
      };

      scope.items = element.find('lj-gallery-item').map(function () {
        var image = angular.element(this).find('img'),
            link = angular.element(this).find('a'),
            capture = angular.element(this).find('lj-gallery-item-capture'),
            output = {
          content: capture.html(),
          src: image.attr('src'),
          href: link.attr('href')
        },
            imageHeight = void 0,
            imageWidth = void 0,
            ratio = void 0,
            paddingTop = void 0,
            remeasure = function remeasure() {
          imageHeight = image[0].naturalHeight, imageWidth = image[0].naturalWidth, ratio = imageHeight / imageWidth, paddingTop = ratio * 100;

          // Find the longest horizontal image
          if (paddingTop < scope.paddingTop) {
            scope.paddingTop = paddingTop;
            scope.containersDimensions.paddingTop = scope.paddingTop + '%';

            // If widget has no width, need to limit it
            if (!attrs.width && imageWidth < scope.maxWidth) {
              scope.galleryDimensions.maxWidth = Math.round(scope.maxHeight / ratio) + 'px';
            }
          }

          output.width = imageWidth + 'px', output.height = imageHeight + 'px';
        };


        remeasure();
        // Element will be removed out of DOM
        // and jQuery listener fails in that case
        image[0].addEventListener('load', function () {
          remeasure();
        });

        return output;
      }).toArray();

      scope.isTall = typeof attrs.tall !== 'undefined';

      scope.next = function () {
        scope.state.index += 1;
      };

      scope.prev = function () {
        scope.state.index -= 1;
      };

      scope.state = {
        index: 0,
        total: scope.items.length - 1
      };

      scope.isNearby = function (index) {
        return Math.abs(scope.state.index - index) <= 1;
      };

      // replace existed content with our template
      element.html($compile($templateCache.get('ljGallery.ng.tmpl'))(scope));
    }
  };
}]).directive('ljSuggest', ['Api', function (Api) {
  return {
    templateUrl: 'ljSuggest.ng.tmpl',
    scope: {
      itemId: '@ljSuggest'
    },
    link: function link(scope) {
      Api.call('discovery.suggest', { itemid: scope.itemId }, { cache: true }).then(function (response) {
        scope.suggest = response.items;
      });
    }
  };
}]).directive('ljWidgetAuthorsPosts', ['Api', function (Api) {
  return {
    templateUrl: 'posts.ng.tmpl',
    scope: {
      userId: '@ljWidgetAuthorsPosts',
      itemId: '@ljWidgetAuthorsPostsExclude'
    },
    link: function link(scope) {
      scope.state = {
        isLoading: true
      };

      Api.call('discovery.author_posts', {
        itemid: scope.itemId,
        userid: scope.userId
      }, {
        cache: true
      }).then(function (response) {
        scope.state.isLoading = false;
        scope.posts = response.items;
      });
    }
  };
}]);
/* <<< file end: js/discovery/directives.js */

//# map link was there [directives.js.map]
/* >>> file start: js/discovery/menu.js */
(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Discovery.Menu', []).directive('ljScrollMenu', ['$document', '$timeout', function ($document, $timeout) {
    return {
      scope: {
        positions: '=ljScrollMenu',
        initialized: '=ljScrollMenuInitialized',

        // menu can be viewable (all items could be on the screen at the moment)
        isViewable: '=ljScrollMenuViewable',
        isDisabled: '=ljScrollMenuDisabled'
      },
      link: function link(scope, element, attrs) {
        var $window = angular.element(window),
            footer = angular.element('.s-footer'),
            header = angular.element('.l-flatslide-body'),
            layoutHeader = angular.element('.s-header'),
            layoutHeaderHeight = layoutHeader.height(),
            ljliveHeight = LJ.get('ljlive.is_enabled') ? 50 : 0,
            menuItems = element.find('ul > li'),
            menuItemHeight = menuItems.eq(0).outerHeight(),
            menuHeight = menuItems.length * menuItemHeight,


        // is more functionality enabled
        isMoreEnabled = typeof attrs.ljScrollMenuMore !== 'undefined',
            moreButton = angular.element('.l-flatslide-menu-item-more'),
            movable,
            clonedMovable,
            body = angular.element('body'),
            UNMOVABLE_CLASS = 'l-flatslide-menu-unmovable',
            unmovable = void 0;

        // Elements which should not get inside of "MORE" hidden list,
        // but should be included in calculations.
        // These may be static elements like header of the menu
        // or special/important elements like "Latest" element on Ratings page


        function refreshMovableData() {
          var moreBtnContainer = element.find('.l-flatslide-menu-subitems').eq(0);
          moreBtnContainer.children().remove();

          // items that could be moved
          movable = element.find('ul > li.l-flatslide-menu-movable');
          unmovable = element.find('ul > li.' + UNMOVABLE_CLASS);

          // Clone movable elements w/ data & events and move them into MORE container
          clonedMovable = movable.clone(true).appendTo(moreBtnContainer);
        }
        LJ.Event.on('movableDataRefreshed', refreshMovableData);

        if (isMoreEnabled) {
          refreshMovableData();
        }

        // detect sticky menu
        function isMenuFixed() {
          return layoutHeader.css('position') === 'fixed';
        }

        // update state when menu is enabled
        scope.$watch('isDisabled', function (isDisabled, old) {
          if (isDisabled !== old && !isDisabled) {
            $timeout(onScroll);
          }
        });

        if (isMoreEnabled) {
          // check menu position changes
          scope.$watch('positions', moveItems, true);

          /**
           * @listens {module:Shop~event:menuItemToggle}
           */
          LJ.Event.on('menuItemToggle', onMenuItemToggle);
        }

        /**
         * @hack
         * @function onMenuItemToggle
         * @description sets menu list overflow based on menu item toggle state
         * @param {object} menuItem - HTMLElement wrapped in angular's jqLite
         */
        function onMenuItemToggle(menuItem) {
          var menu = angular.element('ul.l-flatslide-menu-items-expandable'),
              opened = menuItem.hasClass('l-flatslide-menu-opened');

          if (menuItem.parent().hasClass('l-flatslide-menu-subitems')) {
            // @panic we toggled inner menu;
            return;
          }

          if (opened) {
            // increase scope.opened menu items counter
            scope.opened = scope.opened ? scope.opened + 1 : 1;
          } else {
            // at this moment we should already have scope.opened counter
            scope.opened--;
          }

          menu.css('overflow', scope.opened ? 'auto' : 'visible');

          if (scope.opened) {
            moreButton.hide();
            movable.show();
            clonedMovable.hide();
          } else {
            moveItems();
          }
        }

        function onScroll() {
          if (scope.isDisabled) {
            return;
          }

          var windowScrollTop = $window.scrollTop(),
              windowScrollBottom = windowScrollTop + $window.height(),
              documentHeight = $document.height(),
              headerScrollTop = header.offset() ? header.offset().top : 0,
              footerScrollTop = footer.offset() ? footer.offset().top : documentHeight,
              top,
              bottom,
              height;

          // top coordinate should not be less then 0
          // Notice: it happens when you are trying to scroll top even after
          //         you are at the top of the page
          if (windowScrollTop < 0) {
            windowScrollTop = 0;
          }

          // bottom coordinate should not be greater then document height
          // Notice: it happens when you are trying to scroll bottom even after
          //         you are at the bottom of the page
          if (windowScrollBottom > documentHeight) {
            windowScrollBottom = documentHeight;
          }

          // current menu positions
          top = Math.max(headerScrollTop - windowScrollTop, isMenuFixed() ? layoutHeaderHeight : 0);
          bottom = Math.max(ljliveHeight, windowScrollBottom - footerScrollTop);
          height = Math.max($window.height() - top - bottom);

          // update scope properties only if they have been changed
          if (top !== scope.positions.top || bottom !== scope.positions.bottom || height !== scope.positions.height) {
            scope.positions.top = top;
            scope.positions.bottom = bottom;
            scope.positions.height = height;

            scope.$apply();
          }
        }

        function onResize() {
          // block fixed navigation for mobiles
          if (LJ.Support.isMobile()) {
            scope.isViewable = false;
            moveItems();
            return;
          }

          // check if menu can be viewable (all items could be on the screen at the moment)
          if (menuHeight > $window.height() - layoutHeaderHeight - ljliveHeight) {
            // height of menu is greater than the users screen
            scope.isViewable = false;
            moveItems();
          } else {
            scope.isViewable = true;
          }

          // recalculate menu positions
          // timeout is used because digest loop could be in progress at the moment
          $timeout(onScroll);
        }

        function onLjSaleEvent(event) {
          if (event.originalEvent.data.slot) {
            onScroll();
          }
        }

        function moveItems() {
          if (!isMoreEnabled || scope.opened) {
            // functionality is disabled or we still have some menu items expanded
            return;
          }

          // items that could be displayed inside of the current menu
          var itemsToDisplay = Math.floor(($window.height() - scope.positions.top - scope.positions.bottom - menuItemHeight) / menuItemHeight),


          // if we have movable elements, try them first or count all menu items
          // -1 is bacause MORE item is listed inside of menuItems
          itemsToHide = (movable.length + unmovable.length || menuItems.length) - 1 - itemsToDisplay;

          // show all menu items and hide MORE button
          if (itemsToHide <= 0) {
            movable.show();
            moreButton.hide();
            return;
          }

          // bacause MORE item should be shown as well
          itemsToHide += 1;
          moreButton.show();

          if (itemsToHide >= movable.length) {
            // hide all items that could be moved
            movable.hide();
            clonedMovable.show();
            return;
          }

          // hide last `itemsToHide` items
          movable.show().filter(':gt(' + (movable.length - itemsToHide - 1) + ')').hide();
          clonedMovable.hide().filter(':gt(' + (movable.length - itemsToHide - 1) + ')').show();
        }

        // Sometimes when window height changes position of menu is incorrect,
        // e.g. switching menu when we are more then 1 page down. We should update
        // it when document height changed
        // Notice: for mobile we have different view of menu
        if (!LJ.Support.isMobile()) {

          // update is debounced to prevent updates in same digest loop
          scope.$watch(function () {
            return angular.element(document).height();
          }, LJ.Function.debounce(onScroll, 100));
        }

        angular.element('iframe, img, object, embed').one('load', onResize);
        body.on('ljsale-load', onLjSaleEvent);
        $window.on('scroll orientationchange', function () {
          $timeout(onScroll, 150);
        });
        $window.on('resize', onResize);
        LJ.Event.on('discovery:menu:resize', onResize);
        scope.$on('$destroy', function () {
          $window.off('scroll orientationchange', onScroll);
          $window.off('resize', onResize);
          LJ.Event.off('discovery:menu:resize', onResize);
          LJ.Event.off('menuItemToggle', onMenuItemToggle);
          body.off('ljsale-load', onLjSaleEvent);
        });

        LJ.Event.on('ljlive:close', function () {
          ljliveHeight = 0;
        });

        $timeout(function () {
          onResize();
          onScroll();
          scope.initialized = true;
        });
      }
    };
  }]);
})();
/* <<< file end: js/discovery/menu.js */

//# map link was there [menu.js.map]
/* >>> file start: js/color.js */
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

//= require js/core/string.js

/**
 * @author Valeriy Vasin (valeriy.vasin@sup.com)
 * @description Color object that will allow us perform interactions
 *              with colors. Base part for colorpicker
 */
(function (a) {
    return a;
})();

(function ($) {
    'use strict';

    var _Color,
        defaultRGBColor = { red: 0, green: 0, blue: 0 },
        ERRORS = {
        rgb: 'You should provide correct RGB color hash.',
        hsv: 'You should provide correct HSV color hash.',
        hex: 'You should provide correct HEX color string.'
    };

    _Color = function Color(color) {
        if (!(this instanceof _Color)) {
            throw new Error('Missing `new` prefix when invoking constructor function.');
        }

        this._changeCallbacks = [];

        if (typeof color === 'undefined') {
            this.RGB(defaultRGBColor);
        } else if (this.isRGB(color)) {
            this.RGB(color);
        } else if (this.isHSV(color)) {
            this.HSV(color);
        } else if (this.isHEX(color)) {
            this.HEX(color);
        }
    };

    /**
     * Color getters/setters
     */

    /**
     * RGB color getter/setter
     * @param {Object} color RGB Color object
     * @param {Number} color.red The red color value [0..255]
     * @param {Number} color.green The green color value [0..255]
     * @param {Number} color.blue The blue color value [0..255]
     * @return {Object} Color object instance
     */
    _Color.prototype.RGB = function (color) {
        if (typeof color === 'undefined') {
            // getter
            return $.extend({}, this._RGB);
        } else {
            // setter
            if (!this.isRGB(color)) {
                throw new Error(ERRORS.rgb);
            }
            this._RGB = $.extend({}, color);
            this._HSV = this.rgbToHsv(this._RGB);
            this._triggerChange();
            return this;
        }
    };

    /**
     * HSV color getter/setter
     * @param {Object} color HSV Color object
     * @param {Number} color.hue The hue value [0..359]
     * @param {Number} color.saturation The saturation value [0..100]
     * @param {Number} color.value The value value [0..100]
     * @return {Object} Color object instance
     */
    _Color.prototype.HSV = function (color) {
        if (typeof color === 'undefined') {
            // getter
            return $.extend({}, this._HSV);
        } else {
            // setter
            if (!this.isHSV(color)) {
                throw new Error(ERRORS.hsv);
            }
            this._HSV = $.extend({}, color);
            this._RGB = this.hsvToRgb(this._HSV);
            this._triggerChange();
            return this;
        }
    };

    /**
     * Hex color getter/setter
     * @param  {String} HEXColor Hex color representation
     * @return {Object} Color object instance
     */
    _Color.prototype.HEX = function (color) {
        if (typeof color === 'undefined') {
            // getter
            return this.rgbToHex(this._RGB);
        } else {
            // setter
            if (!this.isHEX(color)) {
                throw new Error(ERRORS.hex);
            }
            this._RGB = this.hexToRgb(color);
            this._HSV = this.rgbToHsv(this._RGB);
            this._triggerChange();
            return this;
        }
    };

    /**
     * Set some part of the palette. It's possible to update parts
     * of RGB palette or HSV palette
     *
     * @param {Object} color Color hash
     *
     * @example
     * var color = new LJ.Color({ red: 255, green: 255, blue: 255 });
     * color.set({ red: 0 }); // now color is { red: 0, green: 255, blue: 255 }
     */
    _Color.prototype.set = function (color) {
        var palette;

        if ((typeof color === 'undefined' ? 'undefined' : _typeof(color)) !== 'object') {
            throw new Error('Color argument should be an object.');
        }

        if (color.hasOwnProperty('red') || color.hasOwnProperty('green') || color.hasOwnProperty('blue')) {
            palette = $.extend(this.RGB(), LJ.Object.pick(color, 'red', 'green', 'blue'));
            this.RGB(palette);
        } else if (color.hasOwnProperty('hue') || color.hasOwnProperty('saturation') || color.hasOwnProperty('value')) {
            palette = $.extend(this.HSV(), LJ.Object.pick(color, 'hue', 'saturation', 'value'));
            this.HSV(palette);
        }

        return this;
    };

    /**
     * Converters
     */

    /**
     * Converts an RGB color value to HSV. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSV_color_space.
     *
     * @param {Object} RGBColor RGB Color object
     * @param {Number} RGBColor.red The red color value [0..255]
     * @param {Number} RGBColor.green The green color value [0..255]
     * @param {Number} RGBColor.blue The blue color value [0..255]
     *
     * @return {Object} HSVColor HSV Color object
     * @return {Number} HSVColor.hue The hue value [0..359]
     * @return {Number} HSVColor.saturation The saturation value [0..100]
     * @return {Number} HSVColor.value The value value [0..100]
     */
    _Color.prototype.rgbToHsv = function (RGBColor) {
        var r, g, b, max, min, h, s, v, diff;

        if (!this.isRGB(RGBColor)) {
            throw new Error(ERRORS.rgb);
        }

        r = RGBColor.red / 255;
        g = RGBColor.green / 255;
        b = RGBColor.blue / 255;

        max = Math.max(r, g, b);
        min = Math.min(r, g, b);

        h = s = v = max;

        diff = max - min;
        s = max === 0 ? 0 : diff / max;

        if (max === min) {
            h = 0; // achromatic
        } else {
            switch (max) {
                case r:
                    h = (g - b) / diff + (g < b ? 6 : 0);
                    break;
                case g:
                    h = (b - r) / diff + 2;
                    break;
                case b:
                    h = (r - g) / diff + 4;
                    break;
            }
            h /= 6;
        }

        return {
            hue: Math.round(h * 360),
            saturation: Math.round(s * 100),
            value: Math.round(v * 100)
        };
    };

    /**
     * HSV to RGB color conversion
     * Ported from the excellent java algorithm by Eugene Vishnevsky at:
     * http://www.cs.rit.edu/~ncs/color/t_convert.html
     *
     * @param {Object} HSVColor HSV color object
     * @param {Number} HSVColor.hue The hue value [0..359]
     * @param {Number} HSVColor.saturation The saturation value [0..100]
     * @param {Number} HSVColor.value The value value [0..100]
     *
     * @return {Object} RGBColor RGB color object
     * @return {Number} RGBColor.red The red color value [0..255]
     * @return {Number} RGBColor.green The green color value [0..255]
     * @return {Number} RGBColor.blue The blue color value [0..255]
     */
    _Color.prototype.hsvToRgb = function (HSVColor) {
        var h, s, v, r, g, b, i, f, p, q, t;

        if (!this.isHSV(HSVColor)) {
            throw new Error(ERRORS.hsv);
        }

        h = Math.max(0, Math.min(360, HSVColor.hue));
        s = Math.max(0, Math.min(100, HSVColor.saturation));
        v = Math.max(0, Math.min(100, HSVColor.value));

        // We accept saturation and value arguments from 0 to 100 because that's
        // how Photoshop represents those values. Internally, however, the
        // saturation and value are calculated from a range of 0 to 1. We make
        // That conversion here.
        s /= 100;
        v /= 100;

        if (s === 0) {
            // Achromatic (grey)
            r = g = b = v;
            return {
                red: Math.round(r * 255),
                green: Math.round(g * 255),
                blue: Math.round(b * 255)
            };
        }

        h /= 60; // sector 0 to 5
        i = Math.floor(h);
        f = h - i; // factorial part of h
        p = v * (1 - s);
        q = v * (1 - s * f);
        t = v * (1 - s * (1 - f));

        switch (i) {
            case 0:
                r = v;
                g = t;
                b = p;
                break;

            case 1:
                r = q;
                g = v;
                b = p;
                break;

            case 2:
                r = p;
                g = v;
                b = t;
                break;

            case 3:
                r = p;
                g = q;
                b = v;
                break;

            case 4:
                r = t;
                g = p;
                b = v;
                break;

            default:
                // case 5:
                r = v;
                g = p;
                b = q;
        }

        return {
            red: Math.round(r * 255),
            green: Math.round(g * 255),
            blue: Math.round(b * 255)
        };
    };

    _Color.prototype.hexToRgbString = function (hex) {
        var temp = LJ.Color.prototype.hexToRgb(hex);

        return Object.keys(temp).map(function (color) {
            return temp[color];
        }).join(',');
    };

    /**
     * Convert number to HEX representation
     * @param  {Number} number Number to be converted
     * @return {String}        Hex representation of the number
     */
    _Color.prototype._numberToHex = function (number) {
        return number.toString(16);
    };

    /**
     * Convert RGB color to HEX string
     * @param {Object} RGBColor RGB color object
     * @param {Number} RGBColor.red The red value [0..255]
     * @param {Number} RGBColor.green The green value [0..255]
     * @param {Number} RGBColor.blue The blue value [0..255]
     *
     * @return {String}  HEX String, e.g. "#0f0f0f"
     */
    _Color.prototype.rgbToHex = function (RGBColor) {
        if (!this.isRGB(RGBColor)) {
            throw new Error(ERRORS.rgb);
        }

        return '#' + [LJ.String.pad(this._numberToHex(RGBColor.red), 2, '0'), LJ.String.pad(this._numberToHex(RGBColor.green), 2, '0'), LJ.String.pad(this._numberToHex(RGBColor.blue), 2, '0')].join('');
    };

    /**
     * Convert Hex string to RGB array
     * @param  {String} HEXColor Hex color representation
     * @return {Object} RGBColor RGB color object
     * @return {Number} RGBColor.red The red color value [0..255]
     * @return {Number} RGBColor.green The green color value [0..255]
     * @return {Number} RGBColor.blue The blue color value [0..255]
     */
    _Color.prototype.hexToRgb = function (HEXColor) {
        if (!this.isHEX(HEXColor)) {
            throw new Error(ERRORS.hex);
        }

        HEXColor = HEXColor.slice(1);

        return {
            red: parseInt(HEXColor.slice(0, 2), 16),
            green: parseInt(HEXColor.slice(2, 4), 16),
            blue: parseInt(HEXColor.slice(-2), 16)
        };
    };

    /**
     * Matchers
     */

    /**
     * Check is provided color valid RGB color hash or not
     * @param  {Object}  color Value to check
     * @return {Boolean} Result of the check
     */
    _Color.prototype.isRGB = function (color) {
        var result;

        if ((typeof color === 'undefined' ? 'undefined' : _typeof(color)) !== 'object') {
            return false;
        }

        if (!color.hasOwnProperty('red') || !color.hasOwnProperty('green') || !color.hasOwnProperty('blue')) {
            return false;
        }

        result = [color.red, color.green, color.blue].every(function (c) {
            return typeof c === 'number' && c >= 0 && c <= 255;
        });

        return result;
    };

    /**
     * Check is provided color valid HSV color hash or not
     * @param  {Object}  color Value to check
     * @return {Boolean}       Result of the check
     */
    _Color.prototype.isHSV = function (color) {
        var result;

        if ((typeof color === 'undefined' ? 'undefined' : _typeof(color)) !== 'object') {
            return false;
        }

        if (!color.hasOwnProperty('hue') || !color.hasOwnProperty('saturation') || !color.hasOwnProperty('value')) {
            return false;
        }

        if (typeof color.hue !== 'number' || color.hue < 0 || color.hue > 359) {
            return false;
        }

        result = [color.saturation, color.value].every(function (c) {
            return typeof c === 'number' && c >= 0 && c <= 100;
        });

        return result;
    };

    /**
     * Check is provided color valid hex color string
     * @param  {String}  color Value to check
     * @return {Boolean}       Result of the check
     */
    _Color.prototype.isHEX = function (color) {
        var regex = /^#[\da-f]{6}$/i;

        return typeof color === 'string' && regex.test(color);
    };

    // override toString
    _Color.prototype.toString = function () {
        return this.rgbToHex(this._RGB);
    };

    /**
     * Add change callback
     * @param  {Function} fn Function that should react to color changes
     * @return {Object}      Color instance
     */
    _Color.prototype.change = function (fn) {
        if (typeof fn !== 'function') {
            throw new TypeError('Color change callback should be a function.');
        }

        if (this._changeCallbacks.indexOf(fn) === -1) {
            this._changeCallbacks.push(fn);
        }

        return this;
    };

    /**
     * This function will react on color changing and run callbacks
     */
    _Color.prototype._triggerChange = function () {
        var hex, that;

        if (this._changeCallbacks.length) {
            that = this;
            hex = this.toString();
            this._changeCallbacks.forEach(function (callback) {
                callback.call(that, hex);
            });
        }
    };

    // export object into global namespace
    LJ.Color = _Color;
})(jQuery);
/* <<< file end: js/color.js */

//# map link was there [color.js.map]
/* >>> file start: js/lib/jquery-ui/jquery.ui.mouse.min.js */
/*! jQuery UI - v1.8.24 - 2012-09-28
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.mouse.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function (a, b) {
  var c = !1;a(document).mouseup(function (a) {
    c = !1;
  }), a.widget("ui.mouse", { options: { cancel: ":input,option", distance: 1, delay: 0 }, _mouseInit: function _mouseInit() {
      var b = this;this.element.bind("mousedown." + this.widgetName, function (a) {
        return b._mouseDown(a);
      }).bind("click." + this.widgetName, function (c) {
        if (!0 === a.data(c.target, b.widgetName + ".preventClickEvent")) return a.removeData(c.target, b.widgetName + ".preventClickEvent"), c.stopImmediatePropagation(), !1;
      }), this.started = !1;
    }, _mouseDestroy: function _mouseDestroy() {
      this.element.unbind("." + this.widgetName), this._mouseMoveDelegate && a(document).unbind("mousemove." + this.widgetName, this._mouseMoveDelegate).unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
    }, _mouseDown: function _mouseDown(b) {
      if (c) return;this._mouseStarted && this._mouseUp(b), this._mouseDownEvent = b;var d = this,
          e = b.which == 1,
          f = typeof this.options.cancel == "string" && b.target.nodeName ? a(b.target).closest(this.options.cancel).length : !1;if (!e || f || !this._mouseCapture(b)) return !0;this.mouseDelayMet = !this.options.delay, this.mouseDelayMet || (this._mouseDelayTimer = setTimeout(function () {
        d.mouseDelayMet = !0;
      }, this.options.delay));if (this._mouseDistanceMet(b) && this._mouseDelayMet(b)) {
        this._mouseStarted = this._mouseStart(b) !== !1;if (!this._mouseStarted) return b.preventDefault(), !0;
      }return !0 === a.data(b.target, this.widgetName + ".preventClickEvent") && a.removeData(b.target, this.widgetName + ".preventClickEvent"), this._mouseMoveDelegate = function (a) {
        return d._mouseMove(a);
      }, this._mouseUpDelegate = function (a) {
        return d._mouseUp(a);
      }, a(document).bind("mousemove." + this.widgetName, this._mouseMoveDelegate).bind("mouseup." + this.widgetName, this._mouseUpDelegate), b.preventDefault(), c = !0, !0;
    }, _mouseMove: function _mouseMove(b) {
      return !a.browser.msie || document.documentMode >= 9 || !!b.button ? this._mouseStarted ? (this._mouseDrag(b), b.preventDefault()) : (this._mouseDistanceMet(b) && this._mouseDelayMet(b) && (this._mouseStarted = this._mouseStart(this._mouseDownEvent, b) !== !1, this._mouseStarted ? this._mouseDrag(b) : this._mouseUp(b)), !this._mouseStarted) : this._mouseUp(b);
    }, _mouseUp: function _mouseUp(b) {
      return a(document).unbind("mousemove." + this.widgetName, this._mouseMoveDelegate).unbind("mouseup." + this.widgetName, this._mouseUpDelegate), this._mouseStarted && (this._mouseStarted = !1, b.target == this._mouseDownEvent.target && a.data(b.target, this.widgetName + ".preventClickEvent", !0), this._mouseStop(b)), !1;
    }, _mouseDistanceMet: function _mouseDistanceMet(a) {
      return Math.max(Math.abs(this._mouseDownEvent.pageX - a.pageX), Math.abs(this._mouseDownEvent.pageY - a.pageY)) >= this.options.distance;
    }, _mouseDelayMet: function _mouseDelayMet(a) {
      return this.mouseDelayMet;
    }, _mouseStart: function _mouseStart(a) {}, _mouseDrag: function _mouseDrag(a) {}, _mouseStop: function _mouseStop(a) {}, _mouseCapture: function _mouseCapture(a) {
      return !0;
    } });
})(jQuery);
/* <<< file end: js/lib/jquery-ui/jquery.ui.mouse.min.js */

//# map link was there [jquery.ui.mouse.min.js.map]
/* >>> file start: js/lib/jquery-ui/jquery.ui.slider.min.js */
/*! jQuery UI - v1.8.24 - 2012-09-28
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.slider.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function (a, b) {
  var c = 5;a.widget("ui.slider", a.ui.mouse, { widgetEventPrefix: "slide", options: { animate: !1, distance: 0, max: 100, min: 0, orientation: "horizontal", range: !1, step: 1, value: 0, values: null }, _create: function _create() {
      var b = this,
          d = this.options,
          e = this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),
          f = "<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",
          g = d.values && d.values.length || 1,
          h = [];this._keySliding = !1, this._mouseSliding = !1, this._animateOff = !0, this._handleIndex = null, this._detectOrientation(), this._mouseInit(), this.element.addClass("ui-slider ui-slider-" + this.orientation + " ui-widget" + " ui-widget-content" + " ui-corner-all" + (d.disabled ? " ui-slider-disabled ui-disabled" : "")), this.range = a([]), d.range && (d.range === !0 && (d.values || (d.values = [this._valueMin(), this._valueMin()]), d.values.length && d.values.length !== 2 && (d.values = [d.values[0], d.values[0]])), this.range = a("<div></div>").appendTo(this.element).addClass("ui-slider-range ui-widget-header" + (d.range === "min" || d.range === "max" ? " ui-slider-range-" + d.range : "")));for (var i = e.length; i < g; i += 1) {
        h.push(f);
      }this.handles = e.add(a(h.join("")).appendTo(b.element)), this.handle = this.handles.eq(0), this.handles.add(this.range).filter("a").click(function (a) {
        a.preventDefault();
      }).hover(function () {
        d.disabled || a(this).addClass("ui-state-hover");
      }, function () {
        a(this).removeClass("ui-state-hover");
      }).focus(function () {
        d.disabled ? a(this).blur() : (a(".ui-slider .ui-state-focus").removeClass("ui-state-focus"), a(this).addClass("ui-state-focus"));
      }).blur(function () {
        a(this).removeClass("ui-state-focus");
      }), this.handles.each(function (b) {
        a(this).data("index.ui-slider-handle", b);
      }), this.handles.keydown(function (d) {
        var e = a(this).data("index.ui-slider-handle"),
            f,
            g,
            h,
            i;if (b.options.disabled) return;switch (d.keyCode) {case a.ui.keyCode.HOME:case a.ui.keyCode.END:case a.ui.keyCode.PAGE_UP:case a.ui.keyCode.PAGE_DOWN:case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:
            d.preventDefault();if (!b._keySliding) {
              b._keySliding = !0, a(this).addClass("ui-state-active"), f = b._start(d, e);if (f === !1) return;
            }}i = b.options.step, b.options.values && b.options.values.length ? g = h = b.values(e) : g = h = b.value();switch (d.keyCode) {case a.ui.keyCode.HOME:
            h = b._valueMin();break;case a.ui.keyCode.END:
            h = b._valueMax();break;case a.ui.keyCode.PAGE_UP:
            h = b._trimAlignValue(g + (b._valueMax() - b._valueMin()) / c);break;case a.ui.keyCode.PAGE_DOWN:
            h = b._trimAlignValue(g - (b._valueMax() - b._valueMin()) / c);break;case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:
            if (g === b._valueMax()) return;h = b._trimAlignValue(g + i);break;case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:
            if (g === b._valueMin()) return;h = b._trimAlignValue(g - i);}b._slide(d, e, h);
      }).keyup(function (c) {
        var d = a(this).data("index.ui-slider-handle");b._keySliding && (b._keySliding = !1, b._stop(c, d), b._change(c, d), a(this).removeClass("ui-state-active"));
      }), this._refreshValue(), this._animateOff = !1;
    }, destroy: function destroy() {
      return this.handles.remove(), this.range.remove(), this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all").removeData("slider").unbind(".slider"), this._mouseDestroy(), this;
    }, _mouseCapture: function _mouseCapture(b) {
      var c = this.options,
          d,
          e,
          f,
          g,
          h,
          i,
          j,
          k,
          l;return c.disabled ? !1 : (this.elementSize = { width: this.element.outerWidth(), height: this.element.outerHeight() }, this.elementOffset = this.element.offset(), d = { x: b.pageX, y: b.pageY }, e = this._normValueFromMouse(d), f = this._valueMax() - this._valueMin() + 1, h = this, this.handles.each(function (b) {
        var c = Math.abs(e - h.values(b));f > c && (f = c, g = a(this), i = b);
      }), c.range === !0 && this.values(1) === c.min && (i += 1, g = a(this.handles[i])), j = this._start(b, i), j === !1 ? !1 : (this._mouseSliding = !0, h._handleIndex = i, g.addClass("ui-state-active").focus(), k = g.offset(), l = !a(b.target).parents().andSelf().is(".ui-slider-handle"), this._clickOffset = l ? { left: 0, top: 0 } : { left: b.pageX - k.left - g.width() / 2, top: b.pageY - k.top - g.height() / 2 - (parseInt(g.css("borderTopWidth"), 10) || 0) - (parseInt(g.css("borderBottomWidth"), 10) || 0) + (parseInt(g.css("marginTop"), 10) || 0) }, this.handles.hasClass("ui-state-hover") || this._slide(b, i, e), this._animateOff = !0, !0));
    }, _mouseStart: function _mouseStart(a) {
      return !0;
    }, _mouseDrag: function _mouseDrag(a) {
      var b = { x: a.pageX, y: a.pageY },
          c = this._normValueFromMouse(b);return this._slide(a, this._handleIndex, c), !1;
    }, _mouseStop: function _mouseStop(a) {
      return this.handles.removeClass("ui-state-active"), this._mouseSliding = !1, this._stop(a, this._handleIndex), this._change(a, this._handleIndex), this._handleIndex = null, this._clickOffset = null, this._animateOff = !1, !1;
    }, _detectOrientation: function _detectOrientation() {
      this.orientation = this.options.orientation === "vertical" ? "vertical" : "horizontal";
    }, _normValueFromMouse: function _normValueFromMouse(a) {
      var b, c, d, e, f;return this.orientation === "horizontal" ? (b = this.elementSize.width, c = a.x - this.elementOffset.left - (this._clickOffset ? this._clickOffset.left : 0)) : (b = this.elementSize.height, c = a.y - this.elementOffset.top - (this._clickOffset ? this._clickOffset.top : 0)), d = c / b, d > 1 && (d = 1), d < 0 && (d = 0), this.orientation === "vertical" && (d = 1 - d), e = this._valueMax() - this._valueMin(), f = this._valueMin() + d * e, this._trimAlignValue(f);
    }, _start: function _start(a, b) {
      var c = { handle: this.handles[b], value: this.value() };return this.options.values && this.options.values.length && (c.value = this.values(b), c.values = this.values()), this._trigger("start", a, c);
    }, _slide: function _slide(a, b, c) {
      var d, e, f;this.options.values && this.options.values.length ? (d = this.values(b ? 0 : 1), this.options.values.length === 2 && this.options.range === !0 && (b === 0 && c > d || b === 1 && c < d) && (c = d), c !== this.values(b) && (e = this.values(), e[b] = c, f = this._trigger("slide", a, { handle: this.handles[b], value: c, values: e }), d = this.values(b ? 0 : 1), f !== !1 && this.values(b, c, !0))) : c !== this.value() && (f = this._trigger("slide", a, { handle: this.handles[b], value: c }), f !== !1 && this.value(c));
    }, _stop: function _stop(a, b) {
      var c = { handle: this.handles[b], value: this.value() };this.options.values && this.options.values.length && (c.value = this.values(b), c.values = this.values()), this._trigger("stop", a, c);
    }, _change: function _change(a, b) {
      if (!this._keySliding && !this._mouseSliding) {
        var c = { handle: this.handles[b], value: this.value() };this.options.values && this.options.values.length && (c.value = this.values(b), c.values = this.values()), this._trigger("change", a, c);
      }
    }, value: function value(a) {
      if (arguments.length) {
        this.options.value = this._trimAlignValue(a), this._refreshValue(), this._change(null, 0);return;
      }return this._value();
    }, values: function values(b, c) {
      var d, e, f;if (arguments.length > 1) {
        this.options.values[b] = this._trimAlignValue(c), this._refreshValue(), this._change(null, b);return;
      }if (!arguments.length) return this._values();if (!a.isArray(arguments[0])) return this.options.values && this.options.values.length ? this._values(b) : this.value();d = this.options.values, e = arguments[0];for (f = 0; f < d.length; f += 1) {
        d[f] = this._trimAlignValue(e[f]), this._change(null, f);
      }this._refreshValue();
    }, _setOption: function _setOption(b, c) {
      var d,
          e = 0;a.isArray(this.options.values) && (e = this.options.values.length), a.Widget.prototype._setOption.apply(this, arguments);switch (b) {case "disabled":
          c ? (this.handles.filter(".ui-state-focus").blur(), this.handles.removeClass("ui-state-hover"), this.handles.propAttr("disabled", !0), this.element.addClass("ui-disabled")) : (this.handles.propAttr("disabled", !1), this.element.removeClass("ui-disabled"));break;case "orientation":
          this._detectOrientation(), this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-" + this.orientation), this._refreshValue();break;case "value":
          this._animateOff = !0, this._refreshValue(), this._change(null, 0), this._animateOff = !1;break;case "values":
          this._animateOff = !0, this._refreshValue();for (d = 0; d < e; d += 1) {
            this._change(null, d);
          }this._animateOff = !1;}
    }, _value: function _value() {
      var a = this.options.value;return a = this._trimAlignValue(a), a;
    }, _values: function _values(a) {
      var b, c, d;if (arguments.length) return b = this.options.values[a], b = this._trimAlignValue(b), b;c = this.options.values.slice();for (d = 0; d < c.length; d += 1) {
        c[d] = this._trimAlignValue(c[d]);
      }return c;
    }, _trimAlignValue: function _trimAlignValue(a) {
      if (a <= this._valueMin()) return this._valueMin();if (a >= this._valueMax()) return this._valueMax();var b = this.options.step > 0 ? this.options.step : 1,
          c = (a - this._valueMin()) % b,
          d = a - c;return Math.abs(c) * 2 >= b && (d += c > 0 ? b : -b), parseFloat(d.toFixed(5));
    }, _valueMin: function _valueMin() {
      return this.options.min;
    }, _valueMax: function _valueMax() {
      return this.options.max;
    }, _refreshValue: function _refreshValue() {
      var b = this.options.range,
          c = this.options,
          d = this,
          e = this._animateOff ? !1 : c.animate,
          f,
          g = {},
          h,
          i,
          j,
          k;this.options.values && this.options.values.length ? this.handles.each(function (b, i) {
        f = (d.values(b) - d._valueMin()) / (d._valueMax() - d._valueMin()) * 100, g[d.orientation === "horizontal" ? "left" : "bottom"] = f + "%", a(this).stop(1, 1)[e ? "animate" : "css"](g, c.animate), d.options.range === !0 && (d.orientation === "horizontal" ? (b === 0 && d.range.stop(1, 1)[e ? "animate" : "css"]({ left: f + "%" }, c.animate), b === 1 && d.range[e ? "animate" : "css"]({ width: f - h + "%" }, { queue: !1, duration: c.animate })) : (b === 0 && d.range.stop(1, 1)[e ? "animate" : "css"]({ bottom: f + "%" }, c.animate), b === 1 && d.range[e ? "animate" : "css"]({ height: f - h + "%" }, { queue: !1, duration: c.animate }))), h = f;
      }) : (i = this.value(), j = this._valueMin(), k = this._valueMax(), f = k !== j ? (i - j) / (k - j) * 100 : 0, g[d.orientation === "horizontal" ? "left" : "bottom"] = f + "%", this.handle.stop(1, 1)[e ? "animate" : "css"](g, c.animate), b === "min" && this.orientation === "horizontal" && this.range.stop(1, 1)[e ? "animate" : "css"]({ width: f + "%" }, c.animate), b === "max" && this.orientation === "horizontal" && this.range[e ? "animate" : "css"]({ width: 100 - f + "%" }, { queue: !1, duration: c.animate }), b === "min" && this.orientation === "vertical" && this.range.stop(1, 1)[e ? "animate" : "css"]({ height: f + "%" }, c.animate), b === "max" && this.orientation === "vertical" && this.range[e ? "animate" : "css"]({ height: 100 - f + "%" }, { queue: !1, duration: c.animate }));
    } }), a.extend(a.ui.slider, { version: "1.8.24" });
})(jQuery);
/* <<< file end: js/lib/jquery-ui/jquery.ui.slider.min.js */

//# map link was there [jquery.ui.slider.min.js.map]
/* >>> file start: js/lib/jquery-ui/jquery.ui.draggable.min.js */
/*! jQuery UI - v1.8.24 - 2012-09-28
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.draggable.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function (a, b) {
  a.widget("ui.draggable", a.ui.mouse, { widgetEventPrefix: "drag", options: { addClasses: !0, appendTo: "parent", axis: !1, connectToSortable: !1, containment: !1, cursor: "auto", cursorAt: !1, grid: !1, handle: !1, helper: "original", iframeFix: !1, opacity: !1, refreshPositions: !1, revert: !1, revertDuration: 500, scope: "default", scroll: !0, scrollSensitivity: 20, scrollSpeed: 20, snap: !1, snapMode: "both", snapTolerance: 20, stack: !1, zIndex: !1 }, _create: function _create() {
      this.options.helper == "original" && !/^(?:r|a|f)/.test(this.element.css("position")) && (this.element[0].style.position = "relative"), this.options.addClasses && this.element.addClass("ui-draggable"), this.options.disabled && this.element.addClass("ui-draggable-disabled"), this._mouseInit();
    }, destroy: function destroy() {
      if (!this.element.data("draggable")) return;return this.element.removeData("draggable").unbind(".draggable").removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"), this._mouseDestroy(), this;
    }, _mouseCapture: function _mouseCapture(b) {
      var c = this.options;return this.helper || c.disabled || a(b.target).is(".ui-resizable-handle") ? !1 : (this.handle = this._getHandle(b), this.handle ? (c.iframeFix && a(c.iframeFix === !0 ? "iframe" : c.iframeFix).each(function () {
        a('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({ width: this.offsetWidth + "px", height: this.offsetHeight + "px", position: "absolute", opacity: "0.001", zIndex: 1e3 }).css(a(this).offset()).appendTo("body");
      }), !0) : !1);
    }, _mouseStart: function _mouseStart(b) {
      var c = this.options;return this.helper = this._createHelper(b), this.helper.addClass("ui-draggable-dragging"), this._cacheHelperProportions(), a.ui.ddmanager && (a.ui.ddmanager.current = this), this._cacheMargins(), this.cssPosition = this.helper.css("position"), this.scrollParent = this.helper.scrollParent(), this.offset = this.positionAbs = this.element.offset(), this.offset = { top: this.offset.top - this.margins.top, left: this.offset.left - this.margins.left }, a.extend(this.offset, { click: { left: b.pageX - this.offset.left, top: b.pageY - this.offset.top }, parent: this._getParentOffset(), relative: this._getRelativeOffset() }), this.originalPosition = this.position = this._generatePosition(b), this.originalPageX = b.pageX, this.originalPageY = b.pageY, c.cursorAt && this._adjustOffsetFromHelper(c.cursorAt), c.containment && this._setContainment(), this._trigger("start", b) === !1 ? (this._clear(), !1) : (this._cacheHelperProportions(), a.ui.ddmanager && !c.dropBehaviour && a.ui.ddmanager.prepareOffsets(this, b), this._mouseDrag(b, !0), a.ui.ddmanager && a.ui.ddmanager.dragStart(this, b), !0);
    }, _mouseDrag: function _mouseDrag(b, c) {
      this.position = this._generatePosition(b), this.positionAbs = this._convertPositionTo("absolute");if (!c) {
        var d = this._uiHash();if (this._trigger("drag", b, d) === !1) return this._mouseUp({}), !1;this.position = d.position;
      }if (!this.options.axis || this.options.axis != "y") this.helper[0].style.left = this.position.left + "px";if (!this.options.axis || this.options.axis != "x") this.helper[0].style.top = this.position.top + "px";return a.ui.ddmanager && a.ui.ddmanager.drag(this, b), !1;
    }, _mouseStop: function _mouseStop(b) {
      var c = !1;a.ui.ddmanager && !this.options.dropBehaviour && (c = a.ui.ddmanager.drop(this, b)), this.dropped && (c = this.dropped, this.dropped = !1);var d = this.element[0],
          e = !1;while (d && (d = d.parentNode)) {
        d == document && (e = !0);
      }if (!e && this.options.helper === "original") return !1;if (this.options.revert == "invalid" && !c || this.options.revert == "valid" && c || this.options.revert === !0 || a.isFunction(this.options.revert) && this.options.revert.call(this.element, c)) {
        var f = this;a(this.helper).animate(this.originalPosition, parseInt(this.options.revertDuration, 10), function () {
          f._trigger("stop", b) !== !1 && f._clear();
        });
      } else this._trigger("stop", b) !== !1 && this._clear();return !1;
    }, _mouseUp: function _mouseUp(b) {
      return a("div.ui-draggable-iframeFix").each(function () {
        this.parentNode.removeChild(this);
      }), a.ui.ddmanager && a.ui.ddmanager.dragStop(this, b), a.ui.mouse.prototype._mouseUp.call(this, b);
    }, cancel: function cancel() {
      return this.helper.is(".ui-draggable-dragging") ? this._mouseUp({}) : this._clear(), this;
    }, _getHandle: function _getHandle(b) {
      var c = !this.options.handle || !a(this.options.handle, this.element).length ? !0 : !1;return a(this.options.handle, this.element).find("*").andSelf().each(function () {
        this == b.target && (c = !0);
      }), c;
    }, _createHelper: function _createHelper(b) {
      var c = this.options,
          d = a.isFunction(c.helper) ? a(c.helper.apply(this.element[0], [b])) : c.helper == "clone" ? this.element.clone().removeAttr("id") : this.element;return d.parents("body").length || d.appendTo(c.appendTo == "parent" ? this.element[0].parentNode : c.appendTo), d[0] != this.element[0] && !/(fixed|absolute)/.test(d.css("position")) && d.css("position", "absolute"), d;
    }, _adjustOffsetFromHelper: function _adjustOffsetFromHelper(b) {
      typeof b == "string" && (b = b.split(" ")), a.isArray(b) && (b = { left: +b[0], top: +b[1] || 0 }), "left" in b && (this.offset.click.left = b.left + this.margins.left), "right" in b && (this.offset.click.left = this.helperProportions.width - b.right + this.margins.left), "top" in b && (this.offset.click.top = b.top + this.margins.top), "bottom" in b && (this.offset.click.top = this.helperProportions.height - b.bottom + this.margins.top);
    }, _getParentOffset: function _getParentOffset() {
      this.offsetParent = this.helper.offsetParent();var b = this.offsetParent.offset();this.cssPosition == "absolute" && this.scrollParent[0] != document && a.ui.contains(this.scrollParent[0], this.offsetParent[0]) && (b.left += this.scrollParent.scrollLeft(), b.top += this.scrollParent.scrollTop());if (this.offsetParent[0] == document.body || this.offsetParent[0].tagName && this.offsetParent[0].tagName.toLowerCase() == "html" && a.browser.msie) b = { top: 0, left: 0 };return { top: b.top + (parseInt(this.offsetParent.css("borderTopWidth"), 10) || 0), left: b.left + (parseInt(this.offsetParent.css("borderLeftWidth"), 10) || 0) };
    }, _getRelativeOffset: function _getRelativeOffset() {
      if (this.cssPosition == "relative") {
        var a = this.element.position();return { top: a.top - (parseInt(this.helper.css("top"), 10) || 0) + this.scrollParent.scrollTop(), left: a.left - (parseInt(this.helper.css("left"), 10) || 0) + this.scrollParent.scrollLeft() };
      }return { top: 0, left: 0 };
    }, _cacheMargins: function _cacheMargins() {
      this.margins = { left: parseInt(this.element.css("marginLeft"), 10) || 0, top: parseInt(this.element.css("marginTop"), 10) || 0, right: parseInt(this.element.css("marginRight"), 10) || 0, bottom: parseInt(this.element.css("marginBottom"), 10) || 0 };
    }, _cacheHelperProportions: function _cacheHelperProportions() {
      this.helperProportions = { width: this.helper.outerWidth(), height: this.helper.outerHeight() };
    }, _setContainment: function _setContainment() {
      var b = this.options;b.containment == "parent" && (b.containment = this.helper[0].parentNode);if (b.containment == "document" || b.containment == "window") this.containment = [b.containment == "document" ? 0 : a(window).scrollLeft() - this.offset.relative.left - this.offset.parent.left, b.containment == "document" ? 0 : a(window).scrollTop() - this.offset.relative.top - this.offset.parent.top, (b.containment == "document" ? 0 : a(window).scrollLeft()) + a(b.containment == "document" ? document : window).width() - this.helperProportions.width - this.margins.left, (b.containment == "document" ? 0 : a(window).scrollTop()) + (a(b.containment == "document" ? document : window).height() || document.body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top];if (!/^(document|window|parent)$/.test(b.containment) && b.containment.constructor != Array) {
        var c = a(b.containment),
            d = c[0];if (!d) return;var e = c.offset(),
            f = a(d).css("overflow") != "hidden";this.containment = [(parseInt(a(d).css("borderLeftWidth"), 10) || 0) + (parseInt(a(d).css("paddingLeft"), 10) || 0), (parseInt(a(d).css("borderTopWidth"), 10) || 0) + (parseInt(a(d).css("paddingTop"), 10) || 0), (f ? Math.max(d.scrollWidth, d.offsetWidth) : d.offsetWidth) - (parseInt(a(d).css("borderLeftWidth"), 10) || 0) - (parseInt(a(d).css("paddingRight"), 10) || 0) - this.helperProportions.width - this.margins.left - this.margins.right, (f ? Math.max(d.scrollHeight, d.offsetHeight) : d.offsetHeight) - (parseInt(a(d).css("borderTopWidth"), 10) || 0) - (parseInt(a(d).css("paddingBottom"), 10) || 0) - this.helperProportions.height - this.margins.top - this.margins.bottom], this.relative_container = c;
      } else b.containment.constructor == Array && (this.containment = b.containment);
    }, _convertPositionTo: function _convertPositionTo(b, c) {
      c || (c = this.position);var d = b == "absolute" ? 1 : -1,
          e = this.options,
          f = this.cssPosition == "absolute" && (this.scrollParent[0] == document || !a.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent,
          g = /(html|body)/i.test(f[0].tagName);return { top: c.top + this.offset.relative.top * d + this.offset.parent.top * d - (a.browser.safari && a.browser.version < 526 && this.cssPosition == "fixed" ? 0 : (this.cssPosition == "fixed" ? -this.scrollParent.scrollTop() : g ? 0 : f.scrollTop()) * d), left: c.left + this.offset.relative.left * d + this.offset.parent.left * d - (a.browser.safari && a.browser.version < 526 && this.cssPosition == "fixed" ? 0 : (this.cssPosition == "fixed" ? -this.scrollParent.scrollLeft() : g ? 0 : f.scrollLeft()) * d) };
    }, _generatePosition: function _generatePosition(b) {
      var c = this.options,
          d = this.cssPosition == "absolute" && (this.scrollParent[0] == document || !a.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent,
          e = /(html|body)/i.test(d[0].tagName),
          f = b.pageX,
          g = b.pageY;if (this.originalPosition) {
        var h;if (this.containment) {
          if (this.relative_container) {
            var i = this.relative_container.offset();h = [this.containment[0] + i.left, this.containment[1] + i.top, this.containment[2] + i.left, this.containment[3] + i.top];
          } else h = this.containment;b.pageX - this.offset.click.left < h[0] && (f = h[0] + this.offset.click.left), b.pageY - this.offset.click.top < h[1] && (g = h[1] + this.offset.click.top), b.pageX - this.offset.click.left > h[2] && (f = h[2] + this.offset.click.left), b.pageY - this.offset.click.top > h[3] && (g = h[3] + this.offset.click.top);
        }if (c.grid) {
          var j = c.grid[1] ? this.originalPageY + Math.round((g - this.originalPageY) / c.grid[1]) * c.grid[1] : this.originalPageY;g = h ? j - this.offset.click.top < h[1] || j - this.offset.click.top > h[3] ? j - this.offset.click.top < h[1] ? j + c.grid[1] : j - c.grid[1] : j : j;var k = c.grid[0] ? this.originalPageX + Math.round((f - this.originalPageX) / c.grid[0]) * c.grid[0] : this.originalPageX;f = h ? k - this.offset.click.left < h[0] || k - this.offset.click.left > h[2] ? k - this.offset.click.left < h[0] ? k + c.grid[0] : k - c.grid[0] : k : k;
        }
      }return { top: g - this.offset.click.top - this.offset.relative.top - this.offset.parent.top + (a.browser.safari && a.browser.version < 526 && this.cssPosition == "fixed" ? 0 : this.cssPosition == "fixed" ? -this.scrollParent.scrollTop() : e ? 0 : d.scrollTop()), left: f - this.offset.click.left - this.offset.relative.left - this.offset.parent.left + (a.browser.safari && a.browser.version < 526 && this.cssPosition == "fixed" ? 0 : this.cssPosition == "fixed" ? -this.scrollParent.scrollLeft() : e ? 0 : d.scrollLeft()) };
    }, _clear: function _clear() {
      this.helper.removeClass("ui-draggable-dragging"), this.helper[0] != this.element[0] && !this.cancelHelperRemoval && this.helper.remove(), this.helper = null, this.cancelHelperRemoval = !1;
    }, _trigger: function _trigger(b, c, d) {
      return d = d || this._uiHash(), a.ui.plugin.call(this, b, [c, d]), b == "drag" && (this.positionAbs = this._convertPositionTo("absolute")), a.Widget.prototype._trigger.call(this, b, c, d);
    }, plugins: {}, _uiHash: function _uiHash(a) {
      return { helper: this.helper, position: this.position, originalPosition: this.originalPosition, offset: this.positionAbs };
    } }), a.extend(a.ui.draggable, { version: "1.8.24" }), a.ui.plugin.add("draggable", "connectToSortable", { start: function start(b, c) {
      var d = a(this).data("draggable"),
          e = d.options,
          f = a.extend({}, c, { item: d.element });d.sortables = [], a(e.connectToSortable).each(function () {
        var c = a.data(this, "sortable");c && !c.options.disabled && (d.sortables.push({ instance: c, shouldRevert: c.options.revert }), c.refreshPositions(), c._trigger("activate", b, f));
      });
    }, stop: function stop(b, c) {
      var d = a(this).data("draggable"),
          e = a.extend({}, c, { item: d.element });a.each(d.sortables, function () {
        this.instance.isOver ? (this.instance.isOver = 0, d.cancelHelperRemoval = !0, this.instance.cancelHelperRemoval = !1, this.shouldRevert && (this.instance.options.revert = !0), this.instance._mouseStop(b), this.instance.options.helper = this.instance.options._helper, d.options.helper == "original" && this.instance.currentItem.css({ top: "auto", left: "auto" })) : (this.instance.cancelHelperRemoval = !1, this.instance._trigger("deactivate", b, e));
      });
    }, drag: function drag(b, c) {
      var d = a(this).data("draggable"),
          e = this,
          f = function f(b) {
        var c = this.offset.click.top,
            d = this.offset.click.left,
            e = this.positionAbs.top,
            f = this.positionAbs.left,
            g = b.height,
            h = b.width,
            i = b.top,
            j = b.left;return a.ui.isOver(e + c, f + d, i, j, g, h);
      };a.each(d.sortables, function (f) {
        this.instance.positionAbs = d.positionAbs, this.instance.helperProportions = d.helperProportions, this.instance.offset.click = d.offset.click, this.instance._intersectsWith(this.instance.containerCache) ? (this.instance.isOver || (this.instance.isOver = 1, this.instance.currentItem = a(e).clone().removeAttr("id").appendTo(this.instance.element).data("sortable-item", !0), this.instance.options._helper = this.instance.options.helper, this.instance.options.helper = function () {
          return c.helper[0];
        }, b.target = this.instance.currentItem[0], this.instance._mouseCapture(b, !0), this.instance._mouseStart(b, !0, !0), this.instance.offset.click.top = d.offset.click.top, this.instance.offset.click.left = d.offset.click.left, this.instance.offset.parent.left -= d.offset.parent.left - this.instance.offset.parent.left, this.instance.offset.parent.top -= d.offset.parent.top - this.instance.offset.parent.top, d._trigger("toSortable", b), d.dropped = this.instance.element, d.currentItem = d.element, this.instance.fromOutside = d), this.instance.currentItem && this.instance._mouseDrag(b)) : this.instance.isOver && (this.instance.isOver = 0, this.instance.cancelHelperRemoval = !0, this.instance.options.revert = !1, this.instance._trigger("out", b, this.instance._uiHash(this.instance)), this.instance._mouseStop(b, !0), this.instance.options.helper = this.instance.options._helper, this.instance.currentItem.remove(), this.instance.placeholder && this.instance.placeholder.remove(), d._trigger("fromSortable", b), d.dropped = !1);
      });
    } }), a.ui.plugin.add("draggable", "cursor", { start: function start(b, c) {
      var d = a("body"),
          e = a(this).data("draggable").options;d.css("cursor") && (e._cursor = d.css("cursor")), d.css("cursor", e.cursor);
    }, stop: function stop(b, c) {
      var d = a(this).data("draggable").options;d._cursor && a("body").css("cursor", d._cursor);
    } }), a.ui.plugin.add("draggable", "opacity", { start: function start(b, c) {
      var d = a(c.helper),
          e = a(this).data("draggable").options;d.css("opacity") && (e._opacity = d.css("opacity")), d.css("opacity", e.opacity);
    }, stop: function stop(b, c) {
      var d = a(this).data("draggable").options;d._opacity && a(c.helper).css("opacity", d._opacity);
    } }), a.ui.plugin.add("draggable", "scroll", { start: function start(b, c) {
      var d = a(this).data("draggable");d.scrollParent[0] != document && d.scrollParent[0].tagName != "HTML" && (d.overflowOffset = d.scrollParent.offset());
    }, drag: function drag(b, c) {
      var d = a(this).data("draggable"),
          e = d.options,
          f = !1;if (d.scrollParent[0] != document && d.scrollParent[0].tagName != "HTML") {
        if (!e.axis || e.axis != "x") d.overflowOffset.top + d.scrollParent[0].offsetHeight - b.pageY < e.scrollSensitivity ? d.scrollParent[0].scrollTop = f = d.scrollParent[0].scrollTop + e.scrollSpeed : b.pageY - d.overflowOffset.top < e.scrollSensitivity && (d.scrollParent[0].scrollTop = f = d.scrollParent[0].scrollTop - e.scrollSpeed);if (!e.axis || e.axis != "y") d.overflowOffset.left + d.scrollParent[0].offsetWidth - b.pageX < e.scrollSensitivity ? d.scrollParent[0].scrollLeft = f = d.scrollParent[0].scrollLeft + e.scrollSpeed : b.pageX - d.overflowOffset.left < e.scrollSensitivity && (d.scrollParent[0].scrollLeft = f = d.scrollParent[0].scrollLeft - e.scrollSpeed);
      } else {
        if (!e.axis || e.axis != "x") b.pageY - a(document).scrollTop() < e.scrollSensitivity ? f = a(document).scrollTop(a(document).scrollTop() - e.scrollSpeed) : a(window).height() - (b.pageY - a(document).scrollTop()) < e.scrollSensitivity && (f = a(document).scrollTop(a(document).scrollTop() + e.scrollSpeed));if (!e.axis || e.axis != "y") b.pageX - a(document).scrollLeft() < e.scrollSensitivity ? f = a(document).scrollLeft(a(document).scrollLeft() - e.scrollSpeed) : a(window).width() - (b.pageX - a(document).scrollLeft()) < e.scrollSensitivity && (f = a(document).scrollLeft(a(document).scrollLeft() + e.scrollSpeed));
      }f !== !1 && a.ui.ddmanager && !e.dropBehaviour && a.ui.ddmanager.prepareOffsets(d, b);
    } }), a.ui.plugin.add("draggable", "snap", { start: function start(b, c) {
      var d = a(this).data("draggable"),
          e = d.options;d.snapElements = [], a(e.snap.constructor != String ? e.snap.items || ":data(draggable)" : e.snap).each(function () {
        var b = a(this),
            c = b.offset();this != d.element[0] && d.snapElements.push({ item: this, width: b.outerWidth(), height: b.outerHeight(), top: c.top, left: c.left });
      });
    }, drag: function drag(b, c) {
      var d = a(this).data("draggable"),
          e = d.options,
          f = e.snapTolerance,
          g = c.offset.left,
          h = g + d.helperProportions.width,
          i = c.offset.top,
          j = i + d.helperProportions.height;for (var k = d.snapElements.length - 1; k >= 0; k--) {
        var l = d.snapElements[k].left,
            m = l + d.snapElements[k].width,
            n = d.snapElements[k].top,
            o = n + d.snapElements[k].height;if (!(l - f < g && g < m + f && n - f < i && i < o + f || l - f < g && g < m + f && n - f < j && j < o + f || l - f < h && h < m + f && n - f < i && i < o + f || l - f < h && h < m + f && n - f < j && j < o + f)) {
          d.snapElements[k].snapping && d.options.snap.release && d.options.snap.release.call(d.element, b, a.extend(d._uiHash(), { snapItem: d.snapElements[k].item })), d.snapElements[k].snapping = !1;continue;
        }if (e.snapMode != "inner") {
          var p = Math.abs(n - j) <= f,
              q = Math.abs(o - i) <= f,
              r = Math.abs(l - h) <= f,
              s = Math.abs(m - g) <= f;p && (c.position.top = d._convertPositionTo("relative", { top: n - d.helperProportions.height, left: 0 }).top - d.margins.top), q && (c.position.top = d._convertPositionTo("relative", { top: o, left: 0 }).top - d.margins.top), r && (c.position.left = d._convertPositionTo("relative", { top: 0, left: l - d.helperProportions.width }).left - d.margins.left), s && (c.position.left = d._convertPositionTo("relative", { top: 0, left: m }).left - d.margins.left);
        }var t = p || q || r || s;if (e.snapMode != "outer") {
          var p = Math.abs(n - i) <= f,
              q = Math.abs(o - j) <= f,
              r = Math.abs(l - g) <= f,
              s = Math.abs(m - h) <= f;p && (c.position.top = d._convertPositionTo("relative", { top: n, left: 0 }).top - d.margins.top), q && (c.position.top = d._convertPositionTo("relative", { top: o - d.helperProportions.height, left: 0 }).top - d.margins.top), r && (c.position.left = d._convertPositionTo("relative", { top: 0, left: l }).left - d.margins.left), s && (c.position.left = d._convertPositionTo("relative", { top: 0, left: m - d.helperProportions.width }).left - d.margins.left);
        }!d.snapElements[k].snapping && (p || q || r || s || t) && d.options.snap.snap && d.options.snap.snap.call(d.element, b, a.extend(d._uiHash(), { snapItem: d.snapElements[k].item })), d.snapElements[k].snapping = p || q || r || s || t;
      }
    } }), a.ui.plugin.add("draggable", "stack", { start: function start(b, c) {
      var d = a(this).data("draggable").options,
          e = a.makeArray(a(d.stack)).sort(function (b, c) {
        return (parseInt(a(b).css("zIndex"), 10) || 0) - (parseInt(a(c).css("zIndex"), 10) || 0);
      });if (!e.length) return;var f = parseInt(e[0].style.zIndex) || 0;a(e).each(function (a) {
        this.style.zIndex = f + a;
      }), this[0].style.zIndex = f + e.length;
    } }), a.ui.plugin.add("draggable", "zIndex", { start: function start(b, c) {
      var d = a(c.helper),
          e = a(this).data("draggable").options;d.css("zIndex") && (e._zIndex = d.css("zIndex")), d.css("zIndex", e.zIndex);
    }, stop: function stop(b, c) {
      var d = a(this).data("draggable").options;d._zIndex && a(c.helper).css("zIndex", d._zIndex);
    } });
})(jQuery);
/* <<< file end: js/lib/jquery-ui/jquery.ui.draggable.min.js */

//# map link was there [jquery.ui.draggable.min.js.map]
/* >>> file start: js/core/angular/colorpicker.js */
//= require js/core/string.js
//= require js/color.js

//= require js/lib/jquery-ui/jquery.ui.mouse.min.js
//= require js/lib/jquery-ui/jquery.ui.slider.min.js
//= require js/lib/jquery-ui/jquery.ui.draggable.min.js


Site.page.template['angular/ljColorpicker.ng.tmpl'] = '<div class=\"b-colorpicker\">\n\n    <div class=\"b-colorpicker-wrap\">\n        <div\n            class=\"b-color-selector\"\n            ng-style=\"{ \'background-color\': paletteColor }\"\n            >\n\n            <div class=\"b-color-selector-pick\"></div>\n\n        </div>\n\n        <div class=\"b-color-selector-bar\"></div>\n\n        <dl class=\"b-colorpicker-controls\">\n\n            <dt\n                class=\"b-colorpicker-controls-title\"\n                lj-ml=\"colorpicker.title.new\"\n                ></dt>\n            <dd\n                ng-style=\"{ \'background-color\': newColor }\"\n                class=\"b-colorpicker-controls-new\"\n                ></dd>\n\n            <dt\n                class=\"b-colorpicker-controls-title\"\n                lj-ml=\"colorpicker.title.current\"\n                ></dt>\n            <dd\n                ng-style=\"{ \'background-color\': color }\"\n                ng-click=\"reset()\"\n                class=\"b-colorpicker-controls-current\"\n                ></dd>\n\n            <dt class=\"b-colorpicker-controls-title\">\n                <label\n                    for=\"hexcolor\"\n                    lj-ml=\"colorpicker.title.code\"\n                    ></label>\n            </dt>\n            <dd class=\"b-colorpicker-controls-value\">\n                <input\n                    class=\"b-colorpicker-controls-hex\"\n                    ng-model=\"code\"\n                    ng-change=\"changeCode($value)\"\n                    maxlength=\"6\"\n                    size=\"6\"\n                    >\n            </dd>\n\n        </dl>\n    </div>\n\n    <div class=\"b-colorpicker-controls-submit\">\n        <div class=\"b-ljbutton b-ljbutton-submit\">\n            <button\n                type=\"button\"\n                name=\"submitpost\"\n                ng-click=\"submitColor()\"\n                lj-ml=\"colorpicker.title.choose\"\n                ></button>\n        </div>\n        <button\n            type=\"button\"\n            name=\"submitpost\"\n            class=\"b-flatbutton b-flatbutton-simple\"\n            ng-click=\"submitColor()\"\n            lj-ml=\"colorpicker.title.choose\"\n            ></button>\n    </div>\n\n</div>\n';

/**
 * @description Colorpicker directive
 * @author Valeriy Vasin (valeriy.vasin@sup.com)
 *
 * @example
 *
 * // Controller:
 * function ColorCtrl() {
 *
 *   // set initial color
 *   $scope.color = '#f0f0f0';
 *
 *   // this function will be executed when user accept color via clicking
 *   // on "Choose" button
 *   $scope.colorChanged() {
 *     console.log('%s has been choosen.', $scope.color);
 *   }
 *
 *   // preview color will be updated everytime user change "New" color
 *   // in the colorpicker
 *   $scope.$watch('previewColor', function (value) {
 *     console.log('preview color has been updated to %s', value);
 *   });
 *
 *   // Also it's possible to change colorpicker current color from controller
 *   //
 *   // Notice:
 *   //   previewColor couldn't be changed from controller right now, but it could
 *   //   be implemented if needed
 *   $scope.changeColorManually = function () {
 *     $scope.color = '#f3f3f3';
 *   };
 * }
 *
 * Layout:
 * <div
 *   lj-colorpicker="color"
 *   lj-colorpicker-preview="previewColor"
 *   lj-colorpicker-submit="colorChanged()"
 *   >
 *   this div element will be replaced with colorpicker template
 * </div>
 */

(function (a) {
  return a;
})();

(function ($) {
  'use strict';

  var app = angular.module('LJ.Colorpicker', []);

  // colorpicker helper service
  app.factory('ColorpickerHelper', [function () {

    return {
      /**
        * Convert 256x256 coords to 100x100 saturation/value system
        * @param {Object} coords      Coordinate object
        * @param {Number} coords.left Left coordinate (X-axis)
        * @param {Number} coords.top  Top coordinate (Y-axis)
        *
        * @return {Object} palette Palette object
        * @return {Number} palette.saturation Saturation of palette (x coord)
        * @return {Number} palette.value Saturation of palette (y coord)
        */
      coordsToPalette: function coordsToPalette(coords) {
        return {
          saturation: Math.round(100 * coords.left / 256),
          value: 100 - Math.round(100 * coords.top / 256)
        };
      },

      /**
       * Convert 100x100 saturation/brightness system to 256x256 coords
       * @param {Object} palette Palette object
       * @param {Number} palette.saturation Saturation of palette (x coord)
       * @param {Number} palette.value      Saturation of palette (y coord)
       *
       * @return {Object} coords Coords object
       * @return {Number} coords.left Left position
       * @return {Number} coords.top Top position
       */
      paletteToCoords: function paletteToCoords(palette) {
        return {
          top: Math.round((100 - palette.value) * 2.56),
          left: Math.round(palette.saturation * 2.56)
        };
      }
    };
  }]);

  // colorpicker directive
  app.directive('ljColorpicker', ['ColorpickerHelper', '$timeout', function (Color, $timeout) {

    return {
      templateUrl: 'ljColorpicker.ng.tmpl',
      replace: true,
      scope: {
        color: '=ljColorpicker',
        newColor: '=ljColorpickerPreview',
        submit: '&ljColorpickerSubmit'
      },
      link: function link(scope, element, attrs) {
        var pickerElement = element.find('.b-color-selector-pick'),
            sliderElement = element.find('.b-color-selector-bar'),
            paletteElement = element.find('.b-color-selector'),
            codeElement = element.find('.b-colorpicker-controls-hex'),
            color = new LJ.Color(),
            newColor = new LJ.Color(),
            paletteColor = new LJ.Color(),


        // code input regexp: hex digits
        regexp = /^[a-f\d]*$/i;

        scope.changeCode = function () {
          if (!regexp.test(scope.code)) {
            return;
          }

          newColor.HEX('#' + LJ.String.pad(scope.code, 6, '0'));

          paletteColor.set({
            hue: newColor.HSV().hue
          });
        };

        //
        // Scope watchers
        //

        // watch changes of color by controller and apply them
        scope.$watch('color', function (value) {
          scope.color = scope.color || '#44915a';
          scope.reset();
        });

        // watch changes of new color
        scope.$watch('newColor', function () {
          if (scope.inner !== true) {
            scope.reset();
          }
          scope.inner = false;
        });

        //
        // Events
        //
        codeElement.on('blur', function () {
          scope.$apply(function () {
            scope.code = LJ.String.pad(scope.newColor.slice(1), 6, '0');
          });
        });

        color.change(function (hex) {
          scope.color = hex;
        });

        newColor.change(function (hex) {
          scope.inner = true;
          scope.newColor = hex;

          // quirk:
          //  we should not change input code value if we are editing it manually
          //  at the time
          if (scope.code && scope.code.length === 6) {
            scope.code = hex.slice(1);
          }
        });

        paletteColor.change(function (hex) {
          scope.paletteColor = hex;

          // update slider position
          sliderElement.slider('option', 'value', paletteColor.HSV().hue);

          // update draggable position
          pickerElement.css(Color.paletteToCoords(newColor.HSV()));
        });

        // palette draggable
        pickerElement.draggable({
          drag: function drag(e, ui) {
            var position = $.extend({}, ui.position),
                isPositionCorrected = false;

            // correct position of picker
            if (position.left < 0) {
              position.left = 0;
              isPositionCorrected = true;
            }
            if (position.left > 256) {
              position.left = 256;
              isPositionCorrected = true;
            }
            if (position.top < 0) {
              position.top = 0;
              isPositionCorrected = true;
            }
            if (position.top > 255) {
              position.top = 256;
              isPositionCorrected = true;
            }

            if (isPositionCorrected) {
              pickerElement.css(position);
              ui.position = position;
            }

            newColor.set(Color.coordsToPalette(position));
            scope.$apply();
          }
        }).on('mousedown', function (e) {
          // fire blur event for code input manually
          // because it will not be fired (reason: draggable widget)
          codeElement.trigger('blur');
          e.stopPropagation();
        });

        // start dragging on mousedown of palette element
        paletteElement.on('mousedown', function (e) {
          var offset = null,
              coords = null;

          // we should react only when right mouse button is down
          if (e.which !== 1) {
            return;
          }

          offset = paletteElement.offset();
          coords = {
            left: e.pageX - offset.left,
            top: e.pageY - offset.top
          };

          pickerElement.css(coords).trigger(e);

          newColor.set(Color.coordsToPalette(coords));
          scope.$apply();
        });

        // slider
        sliderElement.slider({
          orientation: 'vertical',
          min: 0,
          max: 360,
          slide: function slide(e, ui) {
            var hue = ui.value % 360;

            newColor.set({ hue: hue });
            paletteColor.set({ hue: hue });

            scope.$apply();
          }
        });

        /**
         * Reset all values into initial (current value of color)
         */
        scope.reset = function () {
          scope.inner = true;
          scope.newColor = scope.color;
          scope.code = scope.color.slice(1);

          color.HEX(scope.color);
          newColor.HEX(scope.newColor);

          scope.code = scope.color.slice(1);

          paletteColor.set({
            hue: newColor.HSV().hue,
            saturation: 100,
            value: 100
          });
        };

        /**
         * Update current color
         */
        scope.submitColor = function () {
          color.RGB(newColor.RGB());
          scope.color = newColor.HEX();

          // call it asynchronously because color variable in the controller
          // will be changed asynchronously
          $timeout(scope.submit);
        };

        // initialization
        scope.color = scope.color || '#44915a';
        scope.reset();
      }
    };
  }]);
})(jQuery);
/* <<< file end: js/core/angular/colorpicker.js */

//# map link was there [colorpicker.js.map]
/* >>> file start: js/lib/plupload/plupload-2.1.2.full.min.js */
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/**
 * mOxie - multi-runtime File API & XMLHttpRequest L2 Polyfill
 * v1.2.1
 *
 * Copyright 2013, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Date: 2014-05-14
 */
!function (e, t) {
  "use strict";
  function n(e, t) {
    for (var n, i = [], r = 0; r < e.length; ++r) {
      if (n = s[e[r]] || o(e[r]), !n) throw "module definition dependecy not found: " + e[r];i.push(n);
    }t.apply(null, i);
  }function i(e, i, r) {
    if ("string" != typeof e) throw "invalid module definition, module id must be defined and be a string";if (i === t) throw "invalid module definition, dependencies must be specified";if (r === t) throw "invalid module definition, definition function must be specified";n(i, function () {
      s[e] = r.apply(null, arguments);
    });
  }function r(e) {
    return !!s[e];
  }function o(t) {
    for (var n = e, i = t.split(/[.\/]/), r = 0; r < i.length; ++r) {
      if (!n[i[r]]) return;n = n[i[r]];
    }return n;
  }function a(n) {
    for (var i = 0; i < n.length; i++) {
      for (var r = e, o = n[i], a = o.split(/[.\/]/), u = 0; u < a.length - 1; ++u) {
        r[a[u]] === t && (r[a[u]] = {}), r = r[a[u]];
      }r[a[a.length - 1]] = s[o];
    }
  }var s = {},
      u = "moxie/core/utils/Basic",
      c = "moxie/core/I18n",
      l = "moxie/core/utils/Mime",
      d = "moxie/core/utils/Env",
      f = "moxie/core/utils/Dom",
      h = "moxie/core/Exceptions",
      p = "moxie/core/EventTarget",
      m = "moxie/core/utils/Encode",
      g = "moxie/runtime/Runtime",
      v = "moxie/runtime/RuntimeClient",
      y = "moxie/file/Blob",
      w = "moxie/file/File",
      E = "moxie/file/FileInput",
      _ = "moxie/file/FileDrop",
      x = "moxie/runtime/RuntimeTarget",
      b = "moxie/file/FileReader",
      R = "moxie/core/utils/Url",
      T = "moxie/file/FileReaderSync",
      A = "moxie/xhr/FormData",
      S = "moxie/xhr/XMLHttpRequest",
      O = "moxie/runtime/Transporter",
      I = "moxie/image/Image",
      D = "moxie/runtime/html5/Runtime",
      N = "moxie/runtime/html5/file/Blob",
      L = "moxie/core/utils/Events",
      M = "moxie/runtime/html5/file/FileInput",
      C = "moxie/runtime/html5/file/FileDrop",
      F = "moxie/runtime/html5/file/FileReader",
      H = "moxie/runtime/html5/xhr/XMLHttpRequest",
      P = "moxie/runtime/html5/utils/BinaryReader",
      k = "moxie/runtime/html5/image/JPEGHeaders",
      U = "moxie/runtime/html5/image/ExifParser",
      B = "moxie/runtime/html5/image/JPEG",
      z = "moxie/runtime/html5/image/PNG",
      G = "moxie/runtime/html5/image/ImageInfo",
      q = "moxie/runtime/html5/image/MegaPixel",
      X = "moxie/runtime/html5/image/Image",
      j = "moxie/runtime/flash/Runtime",
      V = "moxie/runtime/flash/file/Blob",
      W = "moxie/runtime/flash/file/FileInput",
      Y = "moxie/runtime/flash/file/FileReader",
      $ = "moxie/runtime/flash/file/FileReaderSync",
      J = "moxie/runtime/flash/xhr/XMLHttpRequest",
      Z = "moxie/runtime/flash/runtime/Transporter",
      K = "moxie/runtime/flash/image/Image",
      Q = "moxie/runtime/silverlight/Runtime",
      et = "moxie/runtime/silverlight/file/Blob",
      tt = "moxie/runtime/silverlight/file/FileInput",
      nt = "moxie/runtime/silverlight/file/FileDrop",
      it = "moxie/runtime/silverlight/file/FileReader",
      rt = "moxie/runtime/silverlight/file/FileReaderSync",
      ot = "moxie/runtime/silverlight/xhr/XMLHttpRequest",
      at = "moxie/runtime/silverlight/runtime/Transporter",
      st = "moxie/runtime/silverlight/image/Image",
      ut = "moxie/runtime/html4/Runtime",
      ct = "moxie/runtime/html4/file/FileInput",
      lt = "moxie/runtime/html4/file/FileReader",
      dt = "moxie/runtime/html4/xhr/XMLHttpRequest",
      ft = "moxie/runtime/html4/image/Image";i(u, [], function () {
    var e = function e(_e) {
      var t;return _e === t ? "undefined" : null === _e ? "null" : _e.nodeType ? "node" : {}.toString.call(_e).match(/\s([a-z|A-Z]+)/)[1].toLowerCase();
    },
        t = function t(i) {
      var r;return n(arguments, function (o, s) {
        s > 0 && n(o, function (n, o) {
          n !== r && (e(i[o]) === e(n) && ~a(e(n), ["array", "object"]) ? t(i[o], n) : i[o] = n);
        });
      }), i;
    },
        n = function n(e, t) {
      var n, i, r, o;if (e) {
        try {
          n = e.length;
        } catch (a) {
          n = o;
        }if (n === o) {
          for (i in e) {
            if (e.hasOwnProperty(i) && t(e[i], i) === !1) return;
          }
        } else for (r = 0; n > r; r++) {
          if (t(e[r], r) === !1) return;
        }
      }
    },
        i = function i(t) {
      var n;if (!t || "object" !== e(t)) return !0;for (n in t) {
        return !1;
      }return !0;
    },
        r = function r(t, n) {
      function i(r) {
        "function" === e(t[r]) && t[r](function (e) {
          ++r < o && !e ? i(r) : n(e);
        });
      }var r = 0,
          o = t.length;"function" !== e(n) && (n = function n() {}), t && t.length || n(), i(r);
    },
        o = function o(e, t) {
      var i = 0,
          r = e.length,
          o = new Array(r);n(e, function (e, n) {
        e(function (e) {
          if (e) return t(e);var a = [].slice.call(arguments);a.shift(), o[n] = a, i++, i === r && (o.unshift(null), t.apply(this, o));
        });
      });
    },
        a = function a(e, t) {
      if (t) {
        if (Array.prototype.indexOf) return Array.prototype.indexOf.call(t, e);for (var n = 0, i = t.length; i > n; n++) {
          if (t[n] === e) return n;
        }
      }return -1;
    },
        s = function s(t, n) {
      var i = [];"array" !== e(t) && (t = [t]), "array" !== e(n) && (n = [n]);for (var r in t) {
        -1 === a(t[r], n) && i.push(t[r]);
      }return i.length ? i : !1;
    },
        u = function u(e, t) {
      var i = [];return n(e, function (e) {
        -1 !== a(e, t) && i.push(e);
      }), i.length ? i : null;
    },
        c = function c(e) {
      var t,
          n = [];for (t = 0; t < e.length; t++) {
        n[t] = e[t];
      }return n;
    },
        l = function () {
      var e = 0;return function (t) {
        var n = new Date().getTime().toString(32),
            i;for (i = 0; 5 > i; i++) {
          n += Math.floor(65535 * Math.random()).toString(32);
        }return (t || "o_") + n + (e++).toString(32);
      };
    }(),
        d = function d(e) {
      return e ? String.prototype.trim ? String.prototype.trim.call(e) : e.toString().replace(/^\s*/, "").replace(/\s*$/, "") : e;
    },
        f = function f(e) {
      if ("string" != typeof e) return e;var t = { t: 1099511627776, g: 1073741824, m: 1048576, k: 1024 },
          n;return e = /^([0-9]+)([mgk]?)$/.exec(e.toLowerCase().replace(/[^0-9mkg]/g, "")), n = e[2], e = +e[1], t.hasOwnProperty(n) && (e *= t[n]), e;
    };return { guid: l, typeOf: e, extend: t, each: n, isEmptyObj: i, inSeries: r, inParallel: o, inArray: a, arrayDiff: s, arrayIntersect: u, toArray: c, trim: d, parseSizeStr: f };
  }), i(c, [u], function (e) {
    var t = {};return { addI18n: function addI18n(n) {
        return e.extend(t, n);
      }, translate: function translate(e) {
        return t[e] || e;
      }, _: function _(e) {
        return this.translate(e);
      }, sprintf: function sprintf(t) {
        var n = [].slice.call(arguments, 1);return t.replace(/%[a-z]/g, function () {
          var t = n.shift();return "undefined" !== e.typeOf(t) ? t : "";
        });
      } };
  }), i(l, [u, c], function (e, t) {
    var n = "application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mp3 mpga mpega mp2,audio/x-wav,wav,audio/x-m4a,m4a,audio/ogg,oga ogg,audio/aiff,aiff aif,audio/flac,flac,audio/aac,aac,audio/ac3,ac3,audio/x-ms-wma,wma,image/bmp,bmp,image/gif,gif,image/jpeg,jpg jpeg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gpp 3gp,video/3gpp2,3g2,video/vnd.rn-realvideo,rv,video/ogg,ogv,video/x-matroska,mkv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe",
        i = { mimes: {}, extensions: {}, addMimeType: function addMimeType(e) {
        var t = e.split(/,/),
            n,
            i,
            r;for (n = 0; n < t.length; n += 2) {
          for (r = t[n + 1].split(/ /), i = 0; i < r.length; i++) {
            this.mimes[r[i]] = t[n];
          }this.extensions[t[n]] = r;
        }
      }, extList2mimes: function extList2mimes(t, n) {
        var i = this,
            r,
            o,
            a,
            s,
            u = [];for (o = 0; o < t.length; o++) {
          for (r = t[o].extensions.split(/\s*,\s*/), a = 0; a < r.length; a++) {
            if ("*" === r[a]) return [];if (s = i.mimes[r[a]]) -1 === e.inArray(s, u) && u.push(s);else {
              if (!n || !/^\w+$/.test(r[a])) return [];u.push("." + r[a]);
            }
          }
        }return u;
      }, mimes2exts: function mimes2exts(t) {
        var n = this,
            i = [];return e.each(t, function (t) {
          if ("*" === t) return i = [], !1;var r = t.match(/^(\w+)\/(\*|\w+)$/);r && ("*" === r[2] ? e.each(n.extensions, function (e, t) {
            new RegExp("^" + r[1] + "/").test(t) && [].push.apply(i, n.extensions[t]);
          }) : n.extensions[t] && [].push.apply(i, n.extensions[t]));
        }), i;
      }, mimes2extList: function mimes2extList(n) {
        var i = [],
            r = [];return "string" === e.typeOf(n) && (n = e.trim(n).split(/\s*,\s*/)), r = this.mimes2exts(n), i.push({ title: t.translate("Files"), extensions: r.length ? r.join(",") : "*" }), i.mimes = n, i;
      }, getFileExtension: function getFileExtension(e) {
        var t = e && e.match(/\.([^.]+)$/);return t ? t[1].toLowerCase() : "";
      }, getFileMime: function getFileMime(e) {
        return this.mimes[this.getFileExtension(e)] || "";
      } };return i.addMimeType(n), i;
  }), i(d, [u], function (e) {
    function t(e, t, n) {
      var i = 0,
          r = 0,
          o = 0,
          a = { dev: -6, alpha: -5, a: -5, beta: -4, b: -4, RC: -3, rc: -3, "#": -2, p: 1, pl: 1 },
          s = function s(e) {
        return e = ("" + e).replace(/[_\-+]/g, "."), e = e.replace(/([^.\d]+)/g, ".$1.").replace(/\.{2,}/g, "."), e.length ? e.split(".") : [-8];
      },
          u = function u(e) {
        return e ? isNaN(e) ? a[e] || -7 : parseInt(e, 10) : 0;
      };for (e = s(e), t = s(t), r = Math.max(e.length, t.length), i = 0; r > i; i++) {
        if (e[i] != t[i]) {
          if (e[i] = u(e[i]), t[i] = u(t[i]), e[i] < t[i]) {
            o = -1;break;
          }if (e[i] > t[i]) {
            o = 1;break;
          }
        }
      }if (!n) return o;switch (n) {case ">":case "gt":
          return o > 0;case ">=":case "ge":
          return o >= 0;case "<=":case "le":
          return 0 >= o;case "==":case "=":case "eq":
          return 0 === o;case "<>":case "!=":case "ne":
          return 0 !== o;case "":case "<":case "lt":
          return 0 > o;default:
          return null;}
    }var n = function (e) {
      var t = "",
          n = "?",
          i = "function",
          r = "undefined",
          o = "object",
          a = "major",
          s = "model",
          u = "name",
          c = "type",
          l = "vendor",
          d = "version",
          f = "architecture",
          h = "console",
          p = "mobile",
          m = "tablet",
          g = { has: function has(e, t) {
          return -1 !== t.toLowerCase().indexOf(e.toLowerCase());
        }, lowerize: function lowerize(e) {
          return e.toLowerCase();
        } },
          v = { rgx: function rgx() {
          for (var t, n = 0, a, s, u, c, l, d, f = arguments; n < f.length; n += 2) {
            var h = f[n],
                p = f[n + 1];if ((typeof t === "undefined" ? "undefined" : _typeof(t)) === r) {
              t = {};for (u in p) {
                c = p[u], (typeof c === "undefined" ? "undefined" : _typeof(c)) === o ? t[c[0]] = e : t[c] = e;
              }
            }for (a = s = 0; a < h.length; a++) {
              if (l = h[a].exec(this.getUA())) {
                for (u = 0; u < p.length; u++) {
                  d = l[++s], c = p[u], (typeof c === "undefined" ? "undefined" : _typeof(c)) === o && c.length > 0 ? 2 == c.length ? t[c[0]] = _typeof(c[1]) == i ? c[1].call(this, d) : c[1] : 3 == c.length ? t[c[0]] = _typeof(c[1]) !== i || c[1].exec && c[1].test ? d ? d.replace(c[1], c[2]) : e : d ? c[1].call(this, d, c[2]) : e : 4 == c.length && (t[c[0]] = d ? c[3].call(this, d.replace(c[1], c[2])) : e) : t[c] = d ? d : e;
                }break;
              }
            }if (l) break;
          }return t;
        }, str: function str(t, i) {
          for (var r in i) {
            if (_typeof(i[r]) === o && i[r].length > 0) {
              for (var a = 0; a < i[r].length; a++) {
                if (g.has(i[r][a], t)) return r === n ? e : r;
              }
            } else if (g.has(i[r], t)) return r === n ? e : r;
          }return t;
        } },
          y = { browser: { oldsafari: { major: { 1: ["/8", "/1", "/3"], 2: "/4", "?": "/" }, version: { "1.0": "/8", 1.2: "/1", 1.3: "/3", "2.0": "/412", "2.0.2": "/416", "2.0.3": "/417", "2.0.4": "/419", "?": "/" } } }, device: { sprint: { model: { "Evo Shift 4G": "7373KT" }, vendor: { HTC: "APA", Sprint: "Sprint" } } }, os: { windows: { version: { ME: "4.90", "NT 3.11": "NT3.51", "NT 4.0": "NT4.0", 2000: "NT 5.0", XP: ["NT 5.1", "NT 5.2"], Vista: "NT 6.0", 7: "NT 6.1", 8: "NT 6.2", 8.1: "NT 6.3", RT: "ARM" } } } },
          w = { browser: [[/(opera\smini)\/((\d+)?[\w\.-]+)/i, /(opera\s[mobiletab]+).+version\/((\d+)?[\w\.-]+)/i, /(opera).+version\/((\d+)?[\w\.]+)/i, /(opera)[\/\s]+((\d+)?[\w\.]+)/i], [u, d, a], [/\s(opr)\/((\d+)?[\w\.]+)/i], [[u, "Opera"], d, a], [/(kindle)\/((\d+)?[\w\.]+)/i, /(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?((\d+)?[\w\.]+)*/i, /(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?((\d+)?[\w\.]*)/i, /(?:ms|\()(ie)\s((\d+)?[\w\.]+)/i, /(rekonq)((?:\/)[\w\.]+)*/i, /(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron)\/((\d+)?[\w\.-]+)/i], [u, d, a], [/(trident).+rv[:\s]((\d+)?[\w\.]+).+like\sgecko/i], [[u, "IE"], d, a], [/(yabrowser)\/((\d+)?[\w\.]+)/i], [[u, "Yandex"], d, a], [/(comodo_dragon)\/((\d+)?[\w\.]+)/i], [[u, /_/g, " "], d, a], [/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?((\d+)?[\w\.]+)/i], [u, d, a], [/(dolfin)\/((\d+)?[\w\.]+)/i], [[u, "Dolphin"], d, a], [/((?:android.+)crmo|crios)\/((\d+)?[\w\.]+)/i], [[u, "Chrome"], d, a], [/((?:android.+))version\/((\d+)?[\w\.]+)\smobile\ssafari/i], [[u, "Android Browser"], d, a], [/version\/((\d+)?[\w\.]+).+?mobile\/\w+\s(safari)/i], [d, a, [u, "Mobile Safari"]], [/version\/((\d+)?[\w\.]+).+?(mobile\s?safari|safari)/i], [d, a, u], [/webkit.+?(mobile\s?safari|safari)((\/[\w\.]+))/i], [u, [a, v.str, y.browser.oldsafari.major], [d, v.str, y.browser.oldsafari.version]], [/(konqueror)\/((\d+)?[\w\.]+)/i, /(webkit|khtml)\/((\d+)?[\w\.]+)/i], [u, d, a], [/(navigator|netscape)\/((\d+)?[\w\.-]+)/i], [[u, "Netscape"], d, a], [/(swiftfox)/i, /(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?((\d+)?[\w\.\+]+)/i, /(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix)\/((\d+)?[\w\.-]+)/i, /(mozilla)\/((\d+)?[\w\.]+).+rv\:.+gecko\/\d+/i, /(uc\s?browser|polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|qqbrowser)[\/\s]?((\d+)?[\w\.]+)/i, /(links)\s\(((\d+)?[\w\.]+)/i, /(gobrowser)\/?((\d+)?[\w\.]+)*/i, /(ice\s?browser)\/v?((\d+)?[\w\._]+)/i, /(mosaic)[\/\s]((\d+)?[\w\.]+)/i], [u, d, a]], engine: [[/(presto)\/([\w\.]+)/i, /(webkit|trident|netfront|netsurf|amaya|lynx|w3m)\/([\w\.]+)/i, /(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i, /(icab)[\/\s]([23]\.[\d\.]+)/i], [u, d], [/rv\:([\w\.]+).*(gecko)/i], [d, u]], os: [[/(windows)\snt\s6\.2;\s(arm)/i, /(windows\sphone(?:\sos)*|windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i], [u, [d, v.str, y.os.windows.version]], [/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i], [[u, "Windows"], [d, v.str, y.os.windows.version]], [/\((bb)(10);/i], [[u, "BlackBerry"], d], [/(blackberry)\w*\/?([\w\.]+)*/i, /(tizen)\/([\w\.]+)/i, /(android|webos|palm\os|qnx|bada|rim\stablet\sos|meego)[\/\s-]?([\w\.]+)*/i], [u, d], [/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]+)*/i], [[u, "Symbian"], d], [/mozilla.+\(mobile;.+gecko.+firefox/i], [[u, "Firefox OS"], d], [/(nintendo|playstation)\s([wids3portablevu]+)/i, /(mint)[\/\s\(]?(\w+)*/i, /(joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)[\/\s-]?([\w\.-]+)*/i, /(hurd|linux)\s?([\w\.]+)*/i, /(gnu)\s?([\w\.]+)*/i], [u, d], [/(cros)\s[\w]+\s([\w\.]+\w)/i], [[u, "Chromium OS"], d], [/(sunos)\s?([\w\.]+\d)*/i], [[u, "Solaris"], d], [/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]+)*/i], [u, d], [/(ip[honead]+)(?:.*os\s*([\w]+)*\slike\smac|;\sopera)/i], [[u, "iOS"], [d, /_/g, "."]], [/(mac\sos\sx)\s?([\w\s\.]+\w)*/i], [u, [d, /_/g, "."]], [/(haiku)\s(\w+)/i, /(aix)\s((\d)(?=\.|\)|\s)[\w\.]*)*/i, /(macintosh|mac(?=_powerpc)|plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos)/i, /(unix)\s?([\w\.]+)*/i], [u, d]] },
          E = function E(e) {
        var n = e || (window && window.navigator && window.navigator.userAgent ? window.navigator.userAgent : t);this.getBrowser = function () {
          return v.rgx.apply(this, w.browser);
        }, this.getEngine = function () {
          return v.rgx.apply(this, w.engine);
        }, this.getOS = function () {
          return v.rgx.apply(this, w.os);
        }, this.getResult = function () {
          return { ua: this.getUA(), browser: this.getBrowser(), engine: this.getEngine(), os: this.getOS() };
        }, this.getUA = function () {
          return n;
        }, this.setUA = function (e) {
          return n = e, this;
        }, this.setUA(n);
      };return new E().getResult();
    }(),
        i = function () {
      var t = { define_property: function () {
          return !1;
        }(), create_canvas: function () {
          var e = document.createElement("canvas");return !(!e.getContext || !e.getContext("2d"));
        }(), return_response_type: function return_response_type(t) {
          try {
            if (-1 !== e.inArray(t, ["", "text", "document"])) return !0;if (window.XMLHttpRequest) {
              var n = new XMLHttpRequest();if (n.open("get", "/"), "responseType" in n) return n.responseType = t, n.responseType !== t ? !1 : !0;
            }
          } catch (i) {}return !1;
        }, use_data_uri: function () {
          var e = new Image();return e.onload = function () {
            t.use_data_uri = 1 === e.width && 1 === e.height;
          }, setTimeout(function () {
            e.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP8AAAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==";
          }, 1), !1;
        }(), use_data_uri_over32kb: function use_data_uri_over32kb() {
          return t.use_data_uri && ("IE" !== r.browser || r.version >= 9);
        }, use_data_uri_of: function use_data_uri_of(e) {
          return t.use_data_uri && 33e3 > e || t.use_data_uri_over32kb();
        }, use_fileinput: function use_fileinput() {
          var e = document.createElement("input");return e.setAttribute("type", "file"), !e.disabled;
        } };return function (n) {
        var i = [].slice.call(arguments);return i.shift(), "function" === e.typeOf(t[n]) ? t[n].apply(this, i) : !!t[n];
      };
    }(),
        r = { can: i, browser: n.browser.name, version: parseFloat(n.browser.major), os: n.os.name, osVersion: n.os.version, verComp: t, swf_url: "../flash/Moxie.swf", xap_url: "../silverlight/Moxie.xap", global_event_dispatcher: "moxie.core.EventTarget.instance.dispatchEvent" };return r.OS = r.os, r;
  }), i(f, [d], function (e) {
    var t = function t(e) {
      return "string" != typeof e ? e : document.getElementById(e);
    },
        n = function n(e, t) {
      if (!e.className) return !1;var n = new RegExp("(^|\\s+)" + t + "(\\s+|$)");return n.test(e.className);
    },
        i = function i(e, t) {
      n(e, t) || (e.className = e.className ? e.className.replace(/\s+$/, "") + " " + t : t);
    },
        r = function r(e, t) {
      if (e.className) {
        var n = new RegExp("(^|\\s+)" + t + "(\\s+|$)");e.className = e.className.replace(n, function (e, t, n) {
          return " " === t && " " === n ? " " : "";
        });
      }
    },
        o = function o(e, t) {
      return e.currentStyle ? e.currentStyle[t] : window.getComputedStyle ? window.getComputedStyle(e, null)[t] : void 0;
    },
        a = function a(t, n) {
      function i(e) {
        var t,
            n,
            i = 0,
            r = 0;return e && (n = e.getBoundingClientRect(), t = "CSS1Compat" === s.compatMode ? s.documentElement : s.body, i = n.left + t.scrollLeft, r = n.top + t.scrollTop), { x: i, y: r };
      }var r = 0,
          o = 0,
          a,
          s = document,
          u,
          c;if (t = t, n = n || s.body, t && t.getBoundingClientRect && "IE" === e.browser && (!s.documentMode || s.documentMode < 8)) return u = i(t), c = i(n), { x: u.x - c.x, y: u.y - c.y };for (a = t; a && a != n && a.nodeType;) {
        r += a.offsetLeft || 0, o += a.offsetTop || 0, a = a.offsetParent;
      }for (a = t.parentNode; a && a != n && a.nodeType;) {
        r -= a.scrollLeft || 0, o -= a.scrollTop || 0, a = a.parentNode;
      }return { x: r, y: o };
    },
        s = function s(e) {
      return { w: e.offsetWidth || e.clientWidth, h: e.offsetHeight || e.clientHeight };
    };return { get: t, hasClass: n, addClass: i, removeClass: r, getStyle: o, getPos: a, getSize: s };
  }), i(h, [u], function (e) {
    function t(e, t) {
      var n;for (n in e) {
        if (e[n] === t) return n;
      }return null;
    }return { RuntimeError: function () {
        function n(e) {
          this.code = e, this.name = t(i, e), this.message = this.name + ": RuntimeError " + this.code;
        }var i = { NOT_INIT_ERR: 1, NOT_SUPPORTED_ERR: 9, JS_ERR: 4 };return e.extend(n, i), n.prototype = Error.prototype, n;
      }(), OperationNotAllowedException: function () {
        function t(e) {
          this.code = e, this.name = "OperationNotAllowedException";
        }return e.extend(t, { NOT_ALLOWED_ERR: 1 }), t.prototype = Error.prototype, t;
      }(), ImageError: function () {
        function n(e) {
          this.code = e, this.name = t(i, e), this.message = this.name + ": ImageError " + this.code;
        }var i = { WRONG_FORMAT: 1, MAX_RESOLUTION_ERR: 2 };return e.extend(n, i), n.prototype = Error.prototype, n;
      }(), FileException: function () {
        function n(e) {
          this.code = e, this.name = t(i, e), this.message = this.name + ": FileException " + this.code;
        }var i = { NOT_FOUND_ERR: 1, SECURITY_ERR: 2, ABORT_ERR: 3, NOT_READABLE_ERR: 4, ENCODING_ERR: 5, NO_MODIFICATION_ALLOWED_ERR: 6, INVALID_STATE_ERR: 7, SYNTAX_ERR: 8 };return e.extend(n, i), n.prototype = Error.prototype, n;
      }(), DOMException: function () {
        function n(e) {
          this.code = e, this.name = t(i, e), this.message = this.name + ": DOMException " + this.code;
        }var i = { INDEX_SIZE_ERR: 1, DOMSTRING_SIZE_ERR: 2, HIERARCHY_REQUEST_ERR: 3, WRONG_DOCUMENT_ERR: 4, INVALID_CHARACTER_ERR: 5, NO_DATA_ALLOWED_ERR: 6, NO_MODIFICATION_ALLOWED_ERR: 7, NOT_FOUND_ERR: 8, NOT_SUPPORTED_ERR: 9, INUSE_ATTRIBUTE_ERR: 10, INVALID_STATE_ERR: 11, SYNTAX_ERR: 12, INVALID_MODIFICATION_ERR: 13, NAMESPACE_ERR: 14, INVALID_ACCESS_ERR: 15, VALIDATION_ERR: 16, TYPE_MISMATCH_ERR: 17, SECURITY_ERR: 18, NETWORK_ERR: 19, ABORT_ERR: 20, URL_MISMATCH_ERR: 21, QUOTA_EXCEEDED_ERR: 22, TIMEOUT_ERR: 23, INVALID_NODE_TYPE_ERR: 24, DATA_CLONE_ERR: 25 };return e.extend(n, i), n.prototype = Error.prototype, n;
      }(), EventException: function () {
        function t(e) {
          this.code = e, this.name = "EventException";
        }return e.extend(t, { UNSPECIFIED_EVENT_TYPE_ERR: 0 }), t.prototype = Error.prototype, t;
      }() };
  }), i(p, [h, u], function (e, t) {
    function n() {
      var n = {};t.extend(this, { uid: null, init: function init() {
          this.uid || (this.uid = t.guid("uid_"));
        }, addEventListener: function addEventListener(e, i, r, o) {
          var a = this,
              s;return e = t.trim(e), /\s/.test(e) ? void t.each(e.split(/\s+/), function (e) {
            a.addEventListener(e, i, r, o);
          }) : (e = e.toLowerCase(), r = parseInt(r, 10) || 0, s = n[this.uid] && n[this.uid][e] || [], s.push({ fn: i, priority: r, scope: o || this }), n[this.uid] || (n[this.uid] = {}), void (n[this.uid][e] = s));
        }, hasEventListener: function hasEventListener(e) {
          return e ? !(!n[this.uid] || !n[this.uid][e]) : !!n[this.uid];
        }, removeEventListener: function removeEventListener(e, i) {
          e = e.toLowerCase();var r = n[this.uid] && n[this.uid][e],
              o;if (r) {
            if (i) {
              for (o = r.length - 1; o >= 0; o--) {
                if (r[o].fn === i) {
                  r.splice(o, 1);break;
                }
              }
            } else r = [];r.length || (delete n[this.uid][e], t.isEmptyObj(n[this.uid]) && delete n[this.uid]);
          }
        }, removeAllEventListeners: function removeAllEventListeners() {
          n[this.uid] && delete n[this.uid];
        }, dispatchEvent: function dispatchEvent(i) {
          var r,
              o,
              a,
              s,
              u = {},
              c = !0,
              l;if ("string" !== t.typeOf(i)) {
            if (s = i, "string" !== t.typeOf(s.type)) throw new e.EventException(e.EventException.UNSPECIFIED_EVENT_TYPE_ERR);i = s.type, s.total !== l && s.loaded !== l && (u.total = s.total, u.loaded = s.loaded), u.async = s.async || !1;
          }if (-1 !== i.indexOf("::") ? !function (e) {
            r = e[0], i = e[1];
          }(i.split("::")) : r = this.uid, i = i.toLowerCase(), o = n[r] && n[r][i]) {
            o.sort(function (e, t) {
              return t.priority - e.priority;
            }), a = [].slice.call(arguments), a.shift(), u.type = i, a.unshift(u);var d = [];t.each(o, function (e) {
              a[0].target = e.scope, d.push(u.async ? function (t) {
                setTimeout(function () {
                  t(e.fn.apply(e.scope, a) === !1);
                }, 1);
              } : function (t) {
                t(e.fn.apply(e.scope, a) === !1);
              });
            }), d.length && t.inSeries(d, function (e) {
              c = !e;
            });
          }return c;
        }, bind: function bind() {
          this.addEventListener.apply(this, arguments);
        }, unbind: function unbind() {
          this.removeEventListener.apply(this, arguments);
        }, unbindAll: function unbindAll() {
          this.removeAllEventListeners.apply(this, arguments);
        }, trigger: function trigger() {
          return this.dispatchEvent.apply(this, arguments);
        }, convertEventPropsToHandlers: function convertEventPropsToHandlers(e) {
          var n;"array" !== t.typeOf(e) && (e = [e]);for (var i = 0; i < e.length; i++) {
            n = "on" + e[i], "function" === t.typeOf(this[n]) ? this.addEventListener(e[i], this[n]) : "undefined" === t.typeOf(this[n]) && (this[n] = null);
          }
        } });
    }return n.instance = new n(), n;
  }), i(m, [], function () {
    var e = function e(_e2) {
      return unescape(encodeURIComponent(_e2));
    },
        t = function t(e) {
      return decodeURIComponent(escape(e));
    },
        n = function n(e, _n) {
      if ("function" == typeof window.atob) return _n ? t(window.atob(e)) : window.atob(e);var i = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
          r,
          o,
          a,
          s,
          u,
          c,
          l,
          d,
          f = 0,
          h = 0,
          p = "",
          m = [];if (!e) return e;e += "";do {
        s = i.indexOf(e.charAt(f++)), u = i.indexOf(e.charAt(f++)), c = i.indexOf(e.charAt(f++)), l = i.indexOf(e.charAt(f++)), d = s << 18 | u << 12 | c << 6 | l, r = d >> 16 & 255, o = d >> 8 & 255, a = 255 & d, m[h++] = 64 == c ? String.fromCharCode(r) : 64 == l ? String.fromCharCode(r, o) : String.fromCharCode(r, o, a);
      } while (f < e.length);return p = m.join(""), _n ? t(p) : p;
    },
        i = function i(t, n) {
      if (n && e(t), "function" == typeof window.btoa) return window.btoa(t);var i = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
          r,
          o,
          a,
          s,
          u,
          c,
          l,
          d,
          f = 0,
          h = 0,
          p = "",
          m = [];if (!t) return t;do {
        r = t.charCodeAt(f++), o = t.charCodeAt(f++), a = t.charCodeAt(f++), d = r << 16 | o << 8 | a, s = d >> 18 & 63, u = d >> 12 & 63, c = d >> 6 & 63, l = 63 & d, m[h++] = i.charAt(s) + i.charAt(u) + i.charAt(c) + i.charAt(l);
      } while (f < t.length);p = m.join("");var g = t.length % 3;return (g ? p.slice(0, g - 3) : p) + "===".slice(g || 3);
    };return { utf8_encode: e, utf8_decode: t, atob: n, btoa: i };
  }), i(g, [u, f, p], function (e, t, n) {
    function i(n, r, a, s, u) {
      var c = this,
          l,
          d = e.guid(r + "_"),
          f = u || "browser";n = n || {}, o[d] = this, a = e.extend({ access_binary: !1, access_image_binary: !1, display_media: !1, do_cors: !1, drag_and_drop: !1, filter_by_extension: !0, resize_image: !1, report_upload_progress: !1, return_response_headers: !1, return_response_type: !1, return_status_code: !0, send_custom_headers: !1, select_file: !1, select_folder: !1, select_multiple: !0, send_binary_string: !1, send_browser_cookies: !0, send_multipart: !0, slice_blob: !1, stream_upload: !1, summon_file_dialog: !1, upload_filesize: !0, use_http_method: !0 }, a), n.preferred_caps && (f = i.getMode(s, n.preferred_caps, f)), l = function () {
        var t = {};return { exec: function exec(e, n, i, r) {
            return l[n] && (t[e] || (t[e] = { context: this, instance: new l[n]() }), t[e].instance[i]) ? t[e].instance[i].apply(this, r) : void 0;
          }, removeInstance: function removeInstance(e) {
            delete t[e];
          }, removeAllInstances: function removeAllInstances() {
            var n = this;e.each(t, function (t, i) {
              "function" === e.typeOf(t.instance.destroy) && t.instance.destroy.call(t.context), n.removeInstance(i);
            });
          } };
      }(), e.extend(this, { initialized: !1, uid: d, type: r, mode: i.getMode(s, n.required_caps, f), shimid: d + "_container", clients: 0, options: n, can: function can(t, n) {
          var r = arguments[2] || a;if ("string" === e.typeOf(t) && "undefined" === e.typeOf(n) && (t = i.parseCaps(t)), "object" === e.typeOf(t)) {
            for (var o in t) {
              if (!this.can(o, t[o], r)) return !1;
            }return !0;
          }return "function" === e.typeOf(r[t]) ? r[t].call(this, n) : n === r[t];
        }, getShimContainer: function getShimContainer() {
          var n,
              i = t.get(this.shimid);return i || (n = this.options.container ? t.get(this.options.container) : document.body, i = document.createElement("div"), i.id = this.shimid, i.className = "moxie-shim moxie-shim-" + this.type, e.extend(i.style, { position: "absolute", top: "0px", left: "0px", width: "1px", height: "1px", overflow: "hidden" }), n.appendChild(i), n = null), i;
        }, getShim: function getShim() {
          return l;
        }, shimExec: function shimExec(e, t) {
          var n = [].slice.call(arguments, 2);return c.getShim().exec.call(this, this.uid, e, t, n);
        }, exec: function exec(e, t) {
          var n = [].slice.call(arguments, 2);return c[e] && c[e][t] ? c[e][t].apply(this, n) : c.shimExec.apply(this, arguments);
        }, destroy: function destroy() {
          if (c) {
            var e = t.get(this.shimid);e && e.parentNode.removeChild(e), l && l.removeAllInstances(), this.unbindAll(), delete o[this.uid], this.uid = null, d = c = l = e = null;
          }
        } }), this.mode && n.required_caps && !this.can(n.required_caps) && (this.mode = !1);
    }var r = {},
        o = {};return i.order = "html5,flash,silverlight,html4", i.getRuntime = function (e) {
      return o[e] ? o[e] : !1;
    }, i.addConstructor = function (e, t) {
      t.prototype = n.instance, r[e] = t;
    }, i.getConstructor = function (e) {
      return r[e] || null;
    }, i.getInfo = function (e) {
      var t = i.getRuntime(e);return t ? { uid: t.uid, type: t.type, mode: t.mode, can: function can() {
          return t.can.apply(t, arguments);
        } } : null;
    }, i.parseCaps = function (t) {
      var n = {};return "string" !== e.typeOf(t) ? t || {} : (e.each(t.split(","), function (e) {
        n[e] = !0;
      }), n);
    }, i.can = function (e, t) {
      var n,
          r = i.getConstructor(e),
          o;return r ? (n = new r({ required_caps: t }), o = n.mode, n.destroy(), !!o) : !1;
    }, i.thatCan = function (e, t) {
      var n = (t || i.order).split(/\s*,\s*/);for (var r in n) {
        if (i.can(n[r], e)) return n[r];
      }return null;
    }, i.getMode = function (t, n, i) {
      var r = null;if ("undefined" === e.typeOf(i) && (i = "browser"), n && !e.isEmptyObj(t)) {
        if (e.each(n, function (n, i) {
          if (t.hasOwnProperty(i)) {
            var o = t[i](n);if ("string" == typeof o && (o = [o]), r) {
              if (!(r = e.arrayIntersect(r, o))) return r = !1;
            } else r = o;
          }
        }), r) return -1 !== e.inArray(i, r) ? i : r[0];if (r === !1) return !1;
      }return i;
    }, i.capTrue = function () {
      return !0;
    }, i.capFalse = function () {
      return !1;
    }, i.capTest = function (e) {
      return function () {
        return !!e;
      };
    }, i;
  }), i(v, [h, u, g], function (e, t, n) {
    return function i() {
      var i;t.extend(this, { connectRuntime: function connectRuntime(r) {
          function o(t) {
            var s, u;return t.length ? (s = t.shift(), (u = n.getConstructor(s)) ? (i = new u(r), i.bind("Init", function () {
              i.initialized = !0, setTimeout(function () {
                i.clients++, a.trigger("RuntimeInit", i);
              }, 1);
            }), i.bind("Error", function () {
              i.destroy(), o(t);
            }), i.mode ? void i.init() : void i.trigger("Error")) : void o(t)) : (a.trigger("RuntimeError", new e.RuntimeError(e.RuntimeError.NOT_INIT_ERR)), void (i = null));
          }var a = this,
              s;if ("string" === t.typeOf(r) ? s = r : "string" === t.typeOf(r.ruid) && (s = r.ruid), s) {
            if (i = n.getRuntime(s)) return i.clients++, i;throw new e.RuntimeError(e.RuntimeError.NOT_INIT_ERR);
          }o((r.runtime_order || n.order).split(/\s*,\s*/));
        }, getRuntime: function getRuntime() {
          return i && i.uid ? i : (i = null, null);
        }, disconnectRuntime: function disconnectRuntime() {
          i && --i.clients <= 0 && (i.destroy(), i = null);
        } });
    };
  }), i(y, [u, m, v], function (e, t, n) {
    function i(o, a) {
      function s(t, n, o) {
        var a,
            s = r[this.uid];return "string" === e.typeOf(s) && s.length ? (a = new i(null, { type: o, size: n - t }), a.detach(s.substr(t, a.size)), a) : null;
      }n.call(this), o && this.connectRuntime(o), a ? "string" === e.typeOf(a) && (a = { data: a }) : a = {}, e.extend(this, { uid: a.uid || e.guid("uid_"), ruid: o, size: a.size || 0, type: a.type || "", slice: function slice(e, t, n) {
          return this.isDetached() ? s.apply(this, arguments) : this.getRuntime().exec.call(this, "Blob", "slice", this.getSource(), e, t, n);
        }, getSource: function getSource() {
          return r[this.uid] ? r[this.uid] : null;
        }, detach: function detach(e) {
          this.ruid && (this.getRuntime().exec.call(this, "Blob", "destroy"), this.disconnectRuntime(), this.ruid = null), e = e || "";var n = e.match(/^data:([^;]*);base64,/);n && (this.type = n[1], e = t.atob(e.substring(e.indexOf("base64,") + 7))), this.size = e.length, r[this.uid] = e;
        }, isDetached: function isDetached() {
          return !this.ruid && "string" === e.typeOf(r[this.uid]);
        }, destroy: function destroy() {
          this.detach(), delete r[this.uid];
        } }), a.data ? this.detach(a.data) : r[this.uid] = a;
    }var r = {};return i;
  }), i(w, [u, l, y], function (e, t, n) {
    function i(i, r) {
      var o, a;if (r || (r = {}), a = r.type && "" !== r.type ? r.type : t.getFileMime(r.name), r.name) o = r.name.replace(/\\/g, "/"), o = o.substr(o.lastIndexOf("/") + 1);else {
        var s = a.split("/")[0];o = e.guid(("" !== s ? s : "file") + "_"), t.extensions[a] && (o += "." + t.extensions[a][0]);
      }n.apply(this, arguments), e.extend(this, { type: a || "", name: o || e.guid("file_"), lastModifiedDate: r.lastModifiedDate || new Date().toLocaleString() });
    }return i.prototype = n.prototype, i;
  }), i(E, [u, l, f, h, p, c, w, g, v], function (e, t, n, i, r, o, a, s, u) {
    function c(r) {
      var c = this,
          d,
          f,
          h;if (-1 !== e.inArray(e.typeOf(r), ["string", "node"]) && (r = { browse_button: r }), f = n.get(r.browse_button), !f) throw new i.DOMException(i.DOMException.NOT_FOUND_ERR);h = { accept: [{ title: o.translate("All Files"), extensions: "*" }], name: "file", multiple: !1, required_caps: !1, container: f.parentNode || document.body }, r = e.extend({}, h, r), "string" == typeof r.required_caps && (r.required_caps = s.parseCaps(r.required_caps)), "string" == typeof r.accept && (r.accept = t.mimes2extList(r.accept)), d = n.get(r.container), d || (d = document.body), "static" === n.getStyle(d, "position") && (d.style.position = "relative"), d = f = null, u.call(c), e.extend(c, { uid: e.guid("uid_"), ruid: null, shimid: null, files: null, init: function init() {
          c.convertEventPropsToHandlers(l), c.bind("RuntimeInit", function (t, i) {
            c.ruid = i.uid, c.shimid = i.shimid, c.bind("Ready", function () {
              c.trigger("Refresh");
            }, 999), c.bind("Change", function () {
              var t = i.exec.call(c, "FileInput", "getFiles");c.files = [], e.each(t, function (e) {
                return 0 === e.size ? !0 : void c.files.push(new a(c.ruid, e));
              });
            }, 999), c.bind("Refresh", function () {
              var t, o, a, s;a = n.get(r.browse_button), s = n.get(i.shimid), a && (t = n.getPos(a, n.get(r.container)), o = n.getSize(a), s && e.extend(s.style, { top: t.y + "px", left: t.x + "px", width: o.w + "px", height: o.h + "px" })), s = a = null;
            }), i.exec.call(c, "FileInput", "init", r);
          }), c.connectRuntime(e.extend({}, r, { required_caps: { select_file: !0 } }));
        }, disable: function disable(t) {
          var n = this.getRuntime();n && n.exec.call(this, "FileInput", "disable", "undefined" === e.typeOf(t) ? !0 : t);
        }, refresh: function refresh() {
          c.trigger("Refresh");
        }, destroy: function destroy() {
          var t = this.getRuntime();t && (t.exec.call(this, "FileInput", "destroy"), this.disconnectRuntime()), "array" === e.typeOf(this.files) && e.each(this.files, function (e) {
            e.destroy();
          }), this.files = null;
        } });
    }var l = ["ready", "change", "cancel", "mouseenter", "mouseleave", "mousedown", "mouseup"];return c.prototype = r.instance, c;
  }), i(_, [c, f, h, u, w, v, p, l], function (e, t, n, i, r, o, a, s) {
    function u(n) {
      var a = this,
          u;"string" == typeof n && (n = { drop_zone: n }), u = { accept: [{ title: e.translate("All Files"), extensions: "*" }], required_caps: { drag_and_drop: !0 } }, n = "object" == (typeof n === "undefined" ? "undefined" : _typeof(n)) ? i.extend({}, u, n) : u, n.container = t.get(n.drop_zone) || document.body, "static" === t.getStyle(n.container, "position") && (n.container.style.position = "relative"), "string" == typeof n.accept && (n.accept = s.mimes2extList(n.accept)), o.call(a), i.extend(a, { uid: i.guid("uid_"), ruid: null, files: null, init: function init() {
          a.convertEventPropsToHandlers(c), a.bind("RuntimeInit", function (e, t) {
            a.ruid = t.uid, a.bind("Drop", function () {
              var e = t.exec.call(a, "FileDrop", "getFiles");a.files = [], i.each(e, function (e) {
                a.files.push(new r(a.ruid, e));
              });
            }, 999), t.exec.call(a, "FileDrop", "init", n), a.dispatchEvent("ready");
          }), a.connectRuntime(n);
        }, destroy: function destroy() {
          var e = this.getRuntime();e && (e.exec.call(this, "FileDrop", "destroy"), this.disconnectRuntime()), this.files = null;
        } });
    }var c = ["ready", "dragenter", "dragleave", "drop", "error"];return u.prototype = a.instance, u;
  }), i(x, [u, v, p], function (e, t, n) {
    function i() {
      this.uid = e.guid("uid_"), t.call(this), this.destroy = function () {
        this.disconnectRuntime(), this.unbindAll();
      };
    }return i.prototype = n.instance, i;
  }), i(b, [u, m, h, p, y, w, x], function (e, t, n, i, r, o, a) {
    function s() {
      function i(e, i) {
        function l(e) {
          o.readyState = s.DONE, o.error = e, o.trigger("error"), d();
        }function d() {
          c.destroy(), c = null, o.trigger("loadend");
        }function f(t) {
          c.bind("Error", function (e, t) {
            l(t);
          }), c.bind("Progress", function (e) {
            o.result = t.exec.call(c, "FileReader", "getResult"), o.trigger(e);
          }), c.bind("Load", function (e) {
            o.readyState = s.DONE, o.result = t.exec.call(c, "FileReader", "getResult"), o.trigger(e), d();
          }), t.exec.call(c, "FileReader", "read", e, i);
        }if (c = new a(), this.convertEventPropsToHandlers(u), this.readyState === s.LOADING) return l(new n.DOMException(n.DOMException.INVALID_STATE_ERR));if (this.readyState = s.LOADING, this.trigger("loadstart"), i instanceof r) {
          if (i.isDetached()) {
            var h = i.getSource();switch (e) {case "readAsText":case "readAsBinaryString":
                this.result = h;break;case "readAsDataURL":
                this.result = "data:" + i.type + ";base64," + t.btoa(h);}this.readyState = s.DONE, this.trigger("load"), d();
          } else f(c.connectRuntime(i.ruid));
        } else l(new n.DOMException(n.DOMException.NOT_FOUND_ERR));
      }var o = this,
          c;e.extend(this, { uid: e.guid("uid_"), readyState: s.EMPTY, result: null, error: null, readAsBinaryString: function readAsBinaryString(e) {
          i.call(this, "readAsBinaryString", e);
        }, readAsDataURL: function readAsDataURL(e) {
          i.call(this, "readAsDataURL", e);
        }, readAsText: function readAsText(e) {
          i.call(this, "readAsText", e);
        }, abort: function abort() {
          this.result = null, -1 === e.inArray(this.readyState, [s.EMPTY, s.DONE]) && (this.readyState === s.LOADING && (this.readyState = s.DONE), c && c.getRuntime().exec.call(this, "FileReader", "abort"), this.trigger("abort"), this.trigger("loadend"));
        }, destroy: function destroy() {
          this.abort(), c && (c.getRuntime().exec.call(this, "FileReader", "destroy"), c.disconnectRuntime()), o = c = null;
        } });
    }var u = ["loadstart", "progress", "load", "abort", "error", "loadend"];return s.EMPTY = 0, s.LOADING = 1, s.DONE = 2, s.prototype = i.instance, s;
  }), i(R, [], function () {
    var e = function e(t, n) {
      for (var i = ["source", "scheme", "authority", "userInfo", "user", "pass", "host", "port", "relative", "path", "directory", "file", "query", "fragment"], r = i.length, o = { http: 80, https: 443 }, a = {}, s = /^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/, u = s.exec(t || ""); r--;) {
        u[r] && (a[i[r]] = u[r]);
      }if (!a.scheme) {
        n && "string" != typeof n || (n = e(n || document.location.href)), a.scheme = n.scheme, a.host = n.host, a.port = n.port;var c = "";/^[^\/]/.test(a.path) && (c = n.path, /(\/|\/[^\.]+)$/.test(c) ? c += "/" : c = c.replace(/\/[^\/]+$/, "/")), a.path = c + (a.path || "");
      }return a.port || (a.port = o[a.scheme] || 80), a.port = parseInt(a.port, 10), a.path || (a.path = "/"), delete a.source, a;
    },
        t = function t(_t) {
      var n = { http: 80, https: 443 },
          i = e(_t);return i.scheme + "://" + i.host + (i.port !== n[i.scheme] ? ":" + i.port : "") + i.path + (i.query ? i.query : "");
    },
        n = function n(t) {
      function n(e) {
        return [e.scheme, e.host, e.port].join("/");
      }return "string" == typeof t && (t = e(t)), n(e()) === n(t);
    };return { parseUrl: e, resolveUrl: t, hasSameOrigin: n };
  }), i(T, [u, v, m], function (e, t, n) {
    return function () {
      function i(e, t) {
        if (!t.isDetached()) {
          var i = this.connectRuntime(t.ruid).exec.call(this, "FileReaderSync", "read", e, t);return this.disconnectRuntime(), i;
        }var r = t.getSource();switch (e) {case "readAsBinaryString":
            return r;case "readAsDataURL":
            return "data:" + t.type + ";base64," + n.btoa(r);case "readAsText":
            for (var o = "", a = 0, s = r.length; s > a; a++) {
              o += String.fromCharCode(r[a]);
            }return o;}
      }t.call(this), e.extend(this, { uid: e.guid("uid_"), readAsBinaryString: function readAsBinaryString(e) {
          return i.call(this, "readAsBinaryString", e);
        }, readAsDataURL: function readAsDataURL(e) {
          return i.call(this, "readAsDataURL", e);
        }, readAsText: function readAsText(e) {
          return i.call(this, "readAsText", e);
        } });
    };
  }), i(A, [h, u, y], function (e, t, n) {
    function i() {
      var e,
          i = [];t.extend(this, { append: function append(r, o) {
          var a = this,
              s = t.typeOf(o);o instanceof n ? e = { name: r, value: o } : "array" === s ? (r += "[]", t.each(o, function (e) {
            a.append(r, e);
          })) : "object" === s ? t.each(o, function (e, t) {
            a.append(r + "[" + t + "]", e);
          }) : "null" === s || "undefined" === s || "number" === s && isNaN(o) ? a.append(r, "false") : i.push({ name: r, value: o.toString() });
        }, hasBlob: function hasBlob() {
          return !!this.getBlob();
        }, getBlob: function getBlob() {
          return e && e.value || null;
        }, getBlobName: function getBlobName() {
          return e && e.name || null;
        }, each: function each(n) {
          t.each(i, function (e) {
            n(e.value, e.name);
          }), e && n(e.value, e.name);
        }, destroy: function destroy() {
          e = null, i = [];
        } });
    }return i;
  }), i(S, [u, h, p, m, R, g, x, y, T, A, d, l], function (e, t, n, i, r, o, a, s, u, c, l, d) {
    function f() {
      this.uid = e.guid("uid_");
    }function h() {
      function n(e, t) {
        return y.hasOwnProperty(e) ? 1 === arguments.length ? l.can("define_property") ? y[e] : v[e] : void (l.can("define_property") ? y[e] = t : v[e] = t) : void 0;
      }function u(t) {
        function i() {
          k && (k.destroy(), k = null), s.dispatchEvent("loadend"), s = null;
        }function r(r) {
          k.bind("LoadStart", function (e) {
            n("readyState", h.LOADING), s.dispatchEvent("readystatechange"), s.dispatchEvent(e), I && s.upload.dispatchEvent(e);
          }), k.bind("Progress", function (e) {
            n("readyState") !== h.LOADING && (n("readyState", h.LOADING), s.dispatchEvent("readystatechange")), s.dispatchEvent(e);
          }), k.bind("UploadProgress", function (e) {
            I && s.upload.dispatchEvent({ type: "progress", lengthComputable: !1, total: e.total, loaded: e.loaded });
          }), k.bind("Load", function (t) {
            n("readyState", h.DONE), n("status", Number(r.exec.call(k, "XMLHttpRequest", "getStatus") || 0)), n("statusText", p[n("status")] || ""), n("response", r.exec.call(k, "XMLHttpRequest", "getResponse", n("responseType"))), ~e.inArray(n("responseType"), ["text", ""]) ? n("responseText", n("response")) : "document" === n("responseType") && n("responseXML", n("response")), U = r.exec.call(k, "XMLHttpRequest", "getAllResponseHeaders"), s.dispatchEvent("readystatechange"), n("status") > 0 ? (I && s.upload.dispatchEvent(t), s.dispatchEvent(t)) : (N = !0, s.dispatchEvent("error")), i();
          }), k.bind("Abort", function (e) {
            s.dispatchEvent(e), i();
          }), k.bind("Error", function (e) {
            N = !0, n("readyState", h.DONE), s.dispatchEvent("readystatechange"), D = !0, s.dispatchEvent(e), i();
          }), r.exec.call(k, "XMLHttpRequest", "send", { url: E, method: _, async: w, user: b, password: R, headers: x, mimeType: A, encoding: T, responseType: s.responseType, withCredentials: s.withCredentials, options: P }, t);
        }var s = this;M = new Date().getTime(), k = new a(), "string" == typeof P.required_caps && (P.required_caps = o.parseCaps(P.required_caps)), P.required_caps = e.extend({}, P.required_caps, { return_response_type: s.responseType }), t instanceof c && (P.required_caps.send_multipart = !0), L || (P.required_caps.do_cors = !0), P.ruid ? r(k.connectRuntime(P)) : (k.bind("RuntimeInit", function (e, t) {
          r(t);
        }), k.bind("RuntimeError", function (e, t) {
          s.dispatchEvent("RuntimeError", t);
        }), k.connectRuntime(P));
      }function g() {
        n("responseText", ""), n("responseXML", null), n("response", null), n("status", 0), n("statusText", ""), M = C = null;
      }var v = this,
          y = { timeout: 0, readyState: h.UNSENT, withCredentials: !1, status: 0, statusText: "", responseType: "", responseXML: null, responseText: null, response: null },
          w = !0,
          E,
          _,
          x = {},
          b,
          R,
          T = null,
          A = null,
          S = !1,
          O = !1,
          I = !1,
          D = !1,
          N = !1,
          L = !1,
          M,
          C,
          F = null,
          H = null,
          P = {},
          k,
          U = "",
          B;e.extend(this, y, { uid: e.guid("uid_"), upload: new f(), open: function open(o, a, s, u, c) {
          var l;if (!o || !a) throw new t.DOMException(t.DOMException.SYNTAX_ERR);if (/[\u0100-\uffff]/.test(o) || i.utf8_encode(o) !== o) throw new t.DOMException(t.DOMException.SYNTAX_ERR);if (~e.inArray(o.toUpperCase(), ["CONNECT", "DELETE", "GET", "HEAD", "OPTIONS", "POST", "PUT", "TRACE", "TRACK"]) && (_ = o.toUpperCase()), ~e.inArray(_, ["CONNECT", "TRACE", "TRACK"])) throw new t.DOMException(t.DOMException.SECURITY_ERR);if (a = i.utf8_encode(a), l = r.parseUrl(a), L = r.hasSameOrigin(l), E = r.resolveUrl(a), (u || c) && !L) throw new t.DOMException(t.DOMException.INVALID_ACCESS_ERR);if (b = u || l.user, R = c || l.pass, w = s || !0, w === !1 && (n("timeout") || n("withCredentials") || "" !== n("responseType"))) throw new t.DOMException(t.DOMException.INVALID_ACCESS_ERR);S = !w, O = !1, x = {}, g.call(this), n("readyState", h.OPENED), this.convertEventPropsToHandlers(["readystatechange"]), this.dispatchEvent("readystatechange");
        }, setRequestHeader: function setRequestHeader(r, o) {
          var a = ["accept-charset", "accept-encoding", "access-control-request-headers", "access-control-request-method", "connection", "content-length", "cookie", "cookie2", "content-transfer-encoding", "date", "expect", "host", "keep-alive", "origin", "referer", "te", "trailer", "transfer-encoding", "upgrade", "user-agent", "via"];if (n("readyState") !== h.OPENED || O) throw new t.DOMException(t.DOMException.INVALID_STATE_ERR);if (/[\u0100-\uffff]/.test(r) || i.utf8_encode(r) !== r) throw new t.DOMException(t.DOMException.SYNTAX_ERR);return r = e.trim(r).toLowerCase(), ~e.inArray(r, a) || /^(proxy\-|sec\-)/.test(r) ? !1 : (x[r] ? x[r] += ", " + o : x[r] = o, !0);
        }, getAllResponseHeaders: function getAllResponseHeaders() {
          return U || "";
        }, getResponseHeader: function getResponseHeader(t) {
          return t = t.toLowerCase(), N || ~e.inArray(t, ["set-cookie", "set-cookie2"]) ? null : U && "" !== U && (B || (B = {}, e.each(U.split(/\r\n/), function (t) {
            var n = t.split(/:\s+/);2 === n.length && (n[0] = e.trim(n[0]), B[n[0].toLowerCase()] = { header: n[0], value: e.trim(n[1]) });
          })), B.hasOwnProperty(t)) ? B[t].header + ": " + B[t].value : null;
        }, overrideMimeType: function overrideMimeType(i) {
          var r, o;if (~e.inArray(n("readyState"), [h.LOADING, h.DONE])) throw new t.DOMException(t.DOMException.INVALID_STATE_ERR);if (i = e.trim(i.toLowerCase()), /;/.test(i) && (r = i.match(/^([^;]+)(?:;\scharset\=)?(.*)$/)) && (i = r[1], r[2] && (o = r[2])), !d.mimes[i]) throw new t.DOMException(t.DOMException.SYNTAX_ERR);F = i, H = o;
        }, send: function send(n, r) {
          if (P = "string" === e.typeOf(r) ? { ruid: r } : r ? r : {}, this.convertEventPropsToHandlers(m), this.upload.convertEventPropsToHandlers(m), this.readyState !== h.OPENED || O) throw new t.DOMException(t.DOMException.INVALID_STATE_ERR);if (n instanceof s) P.ruid = n.ruid, A = n.type || "application/octet-stream";else if (n instanceof c) {
            if (n.hasBlob()) {
              var o = n.getBlob();P.ruid = o.ruid, A = o.type || "application/octet-stream";
            }
          } else "string" == typeof n && (T = "UTF-8", A = "text/plain;charset=UTF-8", n = i.utf8_encode(n));this.withCredentials || (this.withCredentials = P.required_caps && P.required_caps.send_browser_cookies && !L), I = !S && this.upload.hasEventListener(), N = !1, D = !n, S || (O = !0), u.call(this, n);
        }, abort: function abort() {
          if (N = !0, S = !1, ~e.inArray(n("readyState"), [h.UNSENT, h.OPENED, h.DONE])) n("readyState", h.UNSENT);else {
            if (n("readyState", h.DONE), O = !1, !k) throw new t.DOMException(t.DOMException.INVALID_STATE_ERR);k.getRuntime().exec.call(k, "XMLHttpRequest", "abort", D), D = !0;
          }
        }, destroy: function destroy() {
          k && ("function" === e.typeOf(k.destroy) && k.destroy(), k = null), this.unbindAll(), this.upload && (this.upload.unbindAll(), this.upload = null);
        } });
    }var p = { 100: "Continue", 101: "Switching Protocols", 102: "Processing", 200: "OK", 201: "Created", 202: "Accepted", 203: "Non-Authoritative Information", 204: "No Content", 205: "Reset Content", 206: "Partial Content", 207: "Multi-Status", 226: "IM Used", 300: "Multiple Choices", 301: "Moved Permanently", 302: "Found", 303: "See Other", 304: "Not Modified", 305: "Use Proxy", 306: "Reserved", 307: "Temporary Redirect", 400: "Bad Request", 401: "Unauthorized", 402: "Payment Required", 403: "Forbidden", 404: "Not Found", 405: "Method Not Allowed", 406: "Not Acceptable", 407: "Proxy Authentication Required", 408: "Request Timeout", 409: "Conflict", 410: "Gone", 411: "Length Required", 412: "Precondition Failed", 413: "Request Entity Too Large", 414: "Request-URI Too Long", 415: "Unsupported Media Type", 416: "Requested Range Not Satisfiable", 417: "Expectation Failed", 422: "Unprocessable Entity", 423: "Locked", 424: "Failed Dependency", 426: "Upgrade Required", 500: "Internal Server Error", 501: "Not Implemented", 502: "Bad Gateway", 503: "Service Unavailable", 504: "Gateway Timeout", 505: "HTTP Version Not Supported", 506: "Variant Also Negotiates", 507: "Insufficient Storage", 510: "Not Extended" };f.prototype = n.instance;var m = ["loadstart", "progress", "abort", "error", "load", "timeout", "loadend"],
        g = 1,
        v = 2;return h.UNSENT = 0, h.OPENED = 1, h.HEADERS_RECEIVED = 2, h.LOADING = 3, h.DONE = 4, h.prototype = n.instance, h;
  }), i(O, [u, m, v, p], function (e, t, n, i) {
    function r() {
      function i() {
        l = d = 0, c = this.result = null;
      }function o(t, n) {
        var i = this;u = n, i.bind("TransportingProgress", function (t) {
          d = t.loaded, l > d && -1 === e.inArray(i.state, [r.IDLE, r.DONE]) && a.call(i);
        }, 999), i.bind("TransportingComplete", function () {
          d = l, i.state = r.DONE, c = null, i.result = u.exec.call(i, "Transporter", "getAsBlob", t || "");
        }, 999), i.state = r.BUSY, i.trigger("TransportingStarted"), a.call(i);
      }function a() {
        var e = this,
            n,
            i = l - d;f > i && (f = i), n = t.btoa(c.substr(d, f)), u.exec.call(e, "Transporter", "receive", n, l);
      }var s, u, c, l, d, f;n.call(this), e.extend(this, { uid: e.guid("uid_"), state: r.IDLE, result: null, transport: function transport(t, n, r) {
          var a = this;if (r = e.extend({ chunk_size: 204798 }, r), (s = r.chunk_size % 3) && (r.chunk_size += 3 - s), f = r.chunk_size, i.call(this), c = t, l = t.length, "string" === e.typeOf(r) || r.ruid) o.call(a, n, this.connectRuntime(r));else {
            var u = function u(e, t) {
              a.unbind("RuntimeInit", u), o.call(a, n, t);
            };this.bind("RuntimeInit", u), this.connectRuntime(r);
          }
        }, abort: function abort() {
          var e = this;e.state = r.IDLE, u && (u.exec.call(e, "Transporter", "clear"), e.trigger("TransportingAborted")), i.call(e);
        }, destroy: function destroy() {
          this.unbindAll(), u = null, this.disconnectRuntime(), i.call(this);
        } });
    }return r.IDLE = 0, r.BUSY = 1, r.DONE = 2, r.prototype = i.instance, r;
  }), i(I, [u, f, h, T, S, g, v, O, d, p, y, w, m], function (e, t, n, i, r, o, a, s, u, c, l, d, f) {
    function h() {
      function i(e) {
        e || (e = this.getRuntime().exec.call(this, "Image", "getInfo")), this.size = e.size, this.width = e.width, this.height = e.height, this.type = e.type, this.meta = e.meta, "" === this.name && (this.name = e.name);
      }function c(t) {
        var i = e.typeOf(t);try {
          if (t instanceof h) {
            if (!t.size) throw new n.DOMException(n.DOMException.INVALID_STATE_ERR);m.apply(this, arguments);
          } else if (t instanceof l) {
            if (!~e.inArray(t.type, ["image/jpeg", "image/png"])) throw new n.ImageError(n.ImageError.WRONG_FORMAT);g.apply(this, arguments);
          } else if (-1 !== e.inArray(i, ["blob", "file"])) c.call(this, new d(null, t), arguments[1]);else if ("string" === i) /^data:[^;]*;base64,/.test(t) ? c.call(this, new l(null, { data: t }), arguments[1]) : v.apply(this, arguments);else {
            if ("node" !== i || "img" !== t.nodeName.toLowerCase()) throw new n.DOMException(n.DOMException.TYPE_MISMATCH_ERR);c.call(this, t.src, arguments[1]);
          }
        } catch (r) {
          this.trigger("error", r.code);
        }
      }function m(t, n) {
        var i = this.connectRuntime(t.ruid);this.ruid = i.uid, i.exec.call(this, "Image", "loadFromImage", t, "undefined" === e.typeOf(n) ? !0 : n);
      }function g(t, n) {
        function i(e) {
          r.ruid = e.uid, e.exec.call(r, "Image", "loadFromBlob", t);
        }var r = this;r.name = t.name || "", t.isDetached() ? (this.bind("RuntimeInit", function (e, t) {
          i(t);
        }), n && "string" == typeof n.required_caps && (n.required_caps = o.parseCaps(n.required_caps)), this.connectRuntime(e.extend({ required_caps: { access_image_binary: !0, resize_image: !0 } }, n))) : i(this.connectRuntime(t.ruid));
      }function v(e, t) {
        var n = this,
            i;i = new r(), i.open("get", e), i.responseType = "blob", i.onprogress = function (e) {
          n.trigger(e);
        }, i.onload = function () {
          g.call(n, i.response, !0);
        }, i.onerror = function (e) {
          n.trigger(e);
        }, i.onloadend = function () {
          i.destroy();
        }, i.bind("RuntimeError", function (e, t) {
          n.trigger("RuntimeError", t);
        }), i.send(null, t);
      }a.call(this), e.extend(this, { uid: e.guid("uid_"), ruid: null, name: "", size: 0, width: 0, height: 0, type: "", meta: {}, clone: function clone() {
          this.load.apply(this, arguments);
        }, load: function load() {
          this.bind("Load Resize", function () {
            i.call(this);
          }, 999), this.convertEventPropsToHandlers(p), c.apply(this, arguments);
        }, downsize: function downsize(t) {
          var i = { width: this.width, height: this.height, crop: !1, preserveHeaders: !0 };t = "object" == (typeof t === "undefined" ? "undefined" : _typeof(t)) ? e.extend(i, t) : e.extend(i, { width: arguments[0], height: arguments[1], crop: arguments[2], preserveHeaders: arguments[3] });try {
            if (!this.size) throw new n.DOMException(n.DOMException.INVALID_STATE_ERR);if (this.width > h.MAX_RESIZE_WIDTH || this.height > h.MAX_RESIZE_HEIGHT) throw new n.ImageError(n.ImageError.MAX_RESOLUTION_ERR);this.getRuntime().exec.call(this, "Image", "downsize", t.width, t.height, t.crop, t.preserveHeaders);
          } catch (r) {
            this.trigger("error", r.code);
          }
        }, crop: function crop(e, t, n) {
          this.downsize(e, t, !0, n);
        }, getAsCanvas: function getAsCanvas() {
          if (!u.can("create_canvas")) throw new n.RuntimeError(n.RuntimeError.NOT_SUPPORTED_ERR);var e = this.connectRuntime(this.ruid);return e.exec.call(this, "Image", "getAsCanvas");
        }, getAsBlob: function getAsBlob(e, t) {
          if (!this.size) throw new n.DOMException(n.DOMException.INVALID_STATE_ERR);return e || (e = "image/jpeg"), "image/jpeg" !== e || t || (t = 90), this.getRuntime().exec.call(this, "Image", "getAsBlob", e, t);
        }, getAsDataURL: function getAsDataURL(e, t) {
          if (!this.size) throw new n.DOMException(n.DOMException.INVALID_STATE_ERR);return this.getRuntime().exec.call(this, "Image", "getAsDataURL", e, t);
        }, getAsBinaryString: function getAsBinaryString(e, t) {
          var n = this.getAsDataURL(e, t);return f.atob(n.substring(n.indexOf("base64,") + 7));
        }, embed: function embed(i) {
          function r() {
            if (u.can("create_canvas")) {
              var t = a.getAsCanvas();if (t) return i.appendChild(t), t = null, a.destroy(), void o.trigger("embedded");
            }var r = a.getAsDataURL(c, l);if (!r) throw new n.ImageError(n.ImageError.WRONG_FORMAT);if (u.can("use_data_uri_of", r.length)) i.innerHTML = '<img src="' + r + '" width="' + a.width + '" height="' + a.height + '" />', a.destroy(), o.trigger("embedded");else {
              var d = new s();d.bind("TransportingComplete", function () {
                v = o.connectRuntime(this.result.ruid), o.bind("Embedded", function () {
                  e.extend(v.getShimContainer().style, { top: "0px", left: "0px", width: a.width + "px", height: a.height + "px" }), v = null;
                }, 999), v.exec.call(o, "ImageView", "display", this.result.uid, m, g), a.destroy();
              }), d.transport(f.atob(r.substring(r.indexOf("base64,") + 7)), c, e.extend({}, p, { required_caps: { display_media: !0 }, runtime_order: "flash,silverlight", container: i }));
            }
          }var o = this,
              a,
              c,
              l,
              d,
              p = arguments[1] || {},
              m = this.width,
              g = this.height,
              v;try {
            if (!(i = t.get(i))) throw new n.DOMException(n.DOMException.INVALID_NODE_TYPE_ERR);if (!this.size) throw new n.DOMException(n.DOMException.INVALID_STATE_ERR);if (this.width > h.MAX_RESIZE_WIDTH || this.height > h.MAX_RESIZE_HEIGHT) throw new n.ImageError(n.ImageError.MAX_RESOLUTION_ERR);if (c = p.type || this.type || "image/jpeg", l = p.quality || 90, d = "undefined" !== e.typeOf(p.crop) ? p.crop : !1, p.width) m = p.width, g = p.height || m;else {
              var y = t.getSize(i);y.w && y.h && (m = y.w, g = y.h);
            }return a = new h(), a.bind("Resize", function () {
              r.call(o);
            }), a.bind("Load", function () {
              a.downsize(m, g, d, !1);
            }), a.clone(this, !1), a;
          } catch (w) {
            this.trigger("error", w.code);
          }
        }, destroy: function destroy() {
          this.ruid && (this.getRuntime().exec.call(this, "Image", "destroy"), this.disconnectRuntime()), this.unbindAll();
        } });
    }var p = ["progress", "load", "error", "resize", "embedded"];return h.MAX_RESIZE_WIDTH = 6500, h.MAX_RESIZE_HEIGHT = 6500, h.prototype = c.instance, h;
  }), i(D, [u, h, g, d], function (e, t, n, i) {
    function r(t) {
      var r = this,
          s = n.capTest,
          u = n.capTrue,
          c = e.extend({ access_binary: s(window.FileReader || window.File && window.File.getAsDataURL), access_image_binary: function access_image_binary() {
          return r.can("access_binary") && !!a.Image;
        }, display_media: s(i.can("create_canvas") || i.can("use_data_uri_over32kb")), do_cors: s(window.XMLHttpRequest && "withCredentials" in new XMLHttpRequest()), drag_and_drop: s(function () {
          var e = document.createElement("div");return ("draggable" in e || "ondragstart" in e && "ondrop" in e) && ("IE" !== i.browser || i.version > 9);
        }()), filter_by_extension: s(function () {
          return "Chrome" === i.browser && i.version >= 28 || "IE" === i.browser && i.version >= 10;
        }()), return_response_headers: u, return_response_type: function return_response_type(e) {
          return "json" === e && window.JSON ? !0 : i.can("return_response_type", e);
        }, return_status_code: u, report_upload_progress: s(window.XMLHttpRequest && new XMLHttpRequest().upload), resize_image: function resize_image() {
          return r.can("access_binary") && i.can("create_canvas");
        }, select_file: function select_file() {
          return i.can("use_fileinput") && window.File;
        }, select_folder: function select_folder() {
          return r.can("select_file") && "Chrome" === i.browser && i.version >= 21;
        }, select_multiple: function select_multiple() {
          return !(!r.can("select_file") || "Safari" === i.browser && "Windows" === i.os || "iOS" === i.os && i.verComp(i.osVersion, "7.0.4", "<"));
        }, send_binary_string: s(window.XMLHttpRequest && (new XMLHttpRequest().sendAsBinary || window.Uint8Array && window.ArrayBuffer)), send_custom_headers: s(window.XMLHttpRequest), send_multipart: function send_multipart() {
          return !!(window.XMLHttpRequest && new XMLHttpRequest().upload && window.FormData) || r.can("send_binary_string");
        }, slice_blob: s(window.File && (File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice)), stream_upload: function stream_upload() {
          return r.can("slice_blob") && r.can("send_multipart");
        }, summon_file_dialog: s(function () {
          return "Firefox" === i.browser && i.version >= 4 || "Opera" === i.browser && i.version >= 12 || "IE" === i.browser && i.version >= 10 || !!~e.inArray(i.browser, ["Chrome", "Safari"]);
        }()), upload_filesize: u }, arguments[2]);n.call(this, t, arguments[1] || o, c), e.extend(this, { init: function init() {
          this.trigger("Init");
        }, destroy: function (e) {
          return function () {
            e.call(r), e = r = null;
          };
        }(this.destroy) }), e.extend(this.getShim(), a);
    }var o = "html5",
        a = {};return n.addConstructor(o, r), a;
  }), i(N, [D, y], function (e, t) {
    function n() {
      function e(e, t, n) {
        var i;if (!window.File.prototype.slice) return (i = window.File.prototype.webkitSlice || window.File.prototype.mozSlice) ? i.call(e, t, n) : null;try {
          return e.slice(), e.slice(t, n);
        } catch (r) {
          return e.slice(t, n - t);
        }
      }this.slice = function () {
        return new t(this.getRuntime().uid, e.apply(this, arguments));
      };
    }return e.Blob = n;
  }), i(L, [u], function (e) {
    function t() {
      this.returnValue = !1;
    }function n() {
      this.cancelBubble = !0;
    }var i = {},
        r = "moxie_" + e.guid(),
        o = function o(_o, a, s, u) {
      var c, l;a = a.toLowerCase(), _o.addEventListener ? (c = s, _o.addEventListener(a, c, !1)) : _o.attachEvent && (c = function c() {
        var e = window.event;e.target || (e.target = e.srcElement), e.preventDefault = t, e.stopPropagation = n, s(e);
      }, _o.attachEvent("on" + a, c)), _o[r] || (_o[r] = e.guid()), i.hasOwnProperty(_o[r]) || (i[_o[r]] = {}), l = i[_o[r]], l.hasOwnProperty(a) || (l[a] = []), l[a].push({ func: c, orig: s, key: u });
    },
        a = function a(t, n, o) {
      var a, s;if (n = n.toLowerCase(), t[r] && i[t[r]] && i[t[r]][n]) {
        a = i[t[r]][n];for (var u = a.length - 1; u >= 0 && (a[u].orig !== o && a[u].key !== o || (t.removeEventListener ? t.removeEventListener(n, a[u].func, !1) : t.detachEvent && t.detachEvent("on" + n, a[u].func), a[u].orig = null, a[u].func = null, a.splice(u, 1), o === s)); u--) {}if (a.length || delete i[t[r]][n], e.isEmptyObj(i[t[r]])) {
          delete i[t[r]];try {
            delete t[r];
          } catch (c) {
            t[r] = s;
          }
        }
      }
    },
        s = function s(t, n) {
      t && t[r] && e.each(i[t[r]], function (e, i) {
        a(t, i, n);
      });
    };return { addEvent: o, removeEvent: a, removeAllEvents: s };
  }), i(M, [D, u, f, L, l, d], function (e, t, n, i, r, o) {
    function a() {
      var e = [],
          a;t.extend(this, { init: function init(s) {
          var u = this,
              c = u.getRuntime(),
              l,
              d,
              f,
              h,
              p,
              m;a = s, e = [], f = a.accept.mimes || r.extList2mimes(a.accept, c.can("filter_by_extension")), d = c.getShimContainer(), d.innerHTML = '<input id="' + c.uid + '" type="file" style="font-size:999px;opacity:0;"' + (a.multiple && c.can("select_multiple") ? "multiple" : "") + (a.directory && c.can("select_folder") ? "webkitdirectory directory" : "") + (f ? ' accept="' + f.join(",") + '"' : "") + " />", l = n.get(c.uid), t.extend(l.style, { position: "absolute", top: 0, left: 0, width: "100%", height: "100%" }), h = n.get(a.browse_button), c.can("summon_file_dialog") && ("static" === n.getStyle(h, "position") && (h.style.position = "relative"), p = parseInt(n.getStyle(h, "z-index"), 10) || 1, h.style.zIndex = p, d.style.zIndex = p - 1, i.addEvent(h, "click", function (e) {
            var t = n.get(c.uid);t && !t.disabled && t.click(), e.preventDefault();
          }, u.uid)), m = c.can("summon_file_dialog") ? h : d, i.addEvent(m, "mouseover", function () {
            u.trigger("mouseenter");
          }, u.uid), i.addEvent(m, "mouseout", function () {
            u.trigger("mouseleave");
          }, u.uid), i.addEvent(m, "mousedown", function () {
            u.trigger("mousedown");
          }, u.uid), i.addEvent(n.get(a.container), "mouseup", function () {
            u.trigger("mouseup");
          }, u.uid), l.onchange = function g() {
            if (e = [], a.directory ? t.each(this.files, function (t) {
              "." !== t.name && e.push(t);
            }) : e = [].slice.call(this.files), "IE" !== o.browser && "IEMobile" !== o.browser) this.value = "";else {
              var n = this.cloneNode(!0);this.parentNode.replaceChild(n, this), n.onchange = g;
            }u.trigger("change");
          }, u.trigger({ type: "ready", async: !0 }), d = null;
        }, getFiles: function getFiles() {
          return e;
        }, disable: function disable(e) {
          var t = this.getRuntime(),
              i;(i = n.get(t.uid)) && (i.disabled = !!e);
        }, destroy: function destroy() {
          var t = this.getRuntime(),
              r = t.getShim(),
              o = t.getShimContainer();i.removeAllEvents(o, this.uid), i.removeAllEvents(a && n.get(a.container), this.uid), i.removeAllEvents(a && n.get(a.browse_button), this.uid), o && (o.innerHTML = ""), r.removeInstance(this.uid), e = a = o = r = null;
        } });
    }return e.FileInput = a;
  }), i(C, [D, u, f, L, l], function (e, t, n, i, r) {
    function o() {
      function e(e) {
        if (!e.dataTransfer || !e.dataTransfer.types) return !1;var n = t.toArray(e.dataTransfer.types || []);return -1 !== t.inArray("Files", n) || -1 !== t.inArray("public.file-url", n) || -1 !== t.inArray("application/x-moz-file", n);
      }function o(e) {
        for (var n = [], i = 0; i < e.length; i++) {
          [].push.apply(n, e[i].extensions.split(/\s*,\s*/));
        }return -1 === t.inArray("*", n) ? n : [];
      }function a(e) {
        if (!f.length) return !0;var n = r.getFileExtension(e.name);return !n || -1 !== t.inArray(n, f);
      }function s(e, n) {
        var i = [];t.each(e, function (e) {
          var t = e.webkitGetAsEntry();if (t) if (t.isFile) {
            var n = e.getAsFile();a(n) && d.push(n);
          } else i.push(t);
        }), i.length ? u(i, n) : n();
      }function u(e, n) {
        var i = [];t.each(e, function (e) {
          i.push(function (t) {
            c(e, t);
          });
        }), t.inSeries(i, function () {
          n();
        });
      }function c(e, t) {
        e.isFile ? e.file(function (e) {
          a(e) && d.push(e), t();
        }, function () {
          t();
        }) : e.isDirectory ? l(e, t) : t();
      }function l(e, t) {
        function n(e) {
          r.readEntries(function (t) {
            t.length ? ([].push.apply(i, t), n(e)) : e();
          }, e);
        }var i = [],
            r = e.createReader();n(function () {
          u(i, t);
        });
      }var d = [],
          f = [],
          h;t.extend(this, { init: function init(n) {
          var r = this,
              u;h = n, f = o(h.accept), u = h.container, i.addEvent(u, "dragover", function (t) {
            e(t) && (t.preventDefault(), t.dataTransfer.dropEffect = "copy");
          }, r.uid), i.addEvent(u, "drop", function (n) {
            e(n) && (n.preventDefault(), d = [], n.dataTransfer.items && n.dataTransfer.items[0].webkitGetAsEntry ? s(n.dataTransfer.items, function () {
              r.trigger("drop");
            }) : (t.each(n.dataTransfer.files, function (e) {
              a(e) && d.push(e);
            }), r.trigger("drop")));
          }, r.uid), i.addEvent(u, "dragenter", function (e) {
            r.trigger("dragenter");
          }, r.uid), i.addEvent(u, "dragleave", function (e) {
            r.trigger("dragleave");
          }, r.uid);
        }, getFiles: function getFiles() {
          return d;
        }, destroy: function destroy() {
          i.removeAllEvents(h && n.get(h.container), this.uid), d = f = h = null;
        } });
    }return e.FileDrop = o;
  }), i(F, [D, m, u], function (e, t, n) {
    function i() {
      function e(e) {
        return t.atob(e.substring(e.indexOf("base64,") + 7));
      }var i,
          r = !1;n.extend(this, { read: function read(e, t) {
          var o = this;i = new window.FileReader(), i.addEventListener("progress", function (e) {
            o.trigger(e);
          }), i.addEventListener("load", function (e) {
            o.trigger(e);
          }), i.addEventListener("error", function (e) {
            o.trigger(e, i.error);
          }), i.addEventListener("loadend", function () {
            i = null;
          }), "function" === n.typeOf(i[e]) ? (r = !1, i[e](t.getSource())) : "readAsBinaryString" === e && (r = !0, i.readAsDataURL(t.getSource()));
        }, getResult: function getResult() {
          return i && i.result ? r ? e(i.result) : i.result : null;
        }, abort: function abort() {
          i && i.abort();
        }, destroy: function destroy() {
          i = null;
        } });
    }return e.FileReader = i;
  }), i(H, [D, u, l, R, w, y, A, h, d], function (e, t, n, i, r, o, a, s, u) {
    function c() {
      function e(e, t) {
        var n = this,
            i,
            r;i = t.getBlob().getSource(), r = new window.FileReader(), r.onload = function () {
          t.append(t.getBlobName(), new o(null, { type: i.type, data: r.result })), f.send.call(n, e, t);
        }, r.readAsBinaryString(i);
      }function c() {
        return !window.XMLHttpRequest || "IE" === u.browser && u.version < 8 ? function () {
          for (var e = ["Msxml2.XMLHTTP.6.0", "Microsoft.XMLHTTP"], t = 0; t < e.length; t++) {
            try {
              return new ActiveXObject(e[t]);
            } catch (n) {}
          }
        }() : new window.XMLHttpRequest();
      }function l(e) {
        var t = e.responseXML,
            n = e.responseText;return "IE" === u.browser && n && t && !t.documentElement && /[^\/]+\/[^\+]+\+xml/.test(e.getResponseHeader("Content-Type")) && (t = new window.ActiveXObject("Microsoft.XMLDOM"), t.async = !1, t.validateOnParse = !1, t.loadXML(n)), t && ("IE" === u.browser && 0 !== t.parseError || !t.documentElement || "parsererror" === t.documentElement.tagName) ? null : t;
      }function d(e) {
        var t = "----moxieboundary" + new Date().getTime(),
            n = "--",
            i = "\r\n",
            r = "",
            a = this.getRuntime();if (!a.can("send_binary_string")) throw new s.RuntimeError(s.RuntimeError.NOT_SUPPORTED_ERR);return h.setRequestHeader("Content-Type", "multipart/form-data; boundary=" + t), e.each(function (e, a) {
          r += e instanceof o ? n + t + i + 'Content-Disposition: form-data; name="' + a + '"; filename="' + unescape(encodeURIComponent(e.name || "blob")) + '"' + i + "Content-Type: " + (e.type || "application/octet-stream") + i + i + e.getSource() + i : n + t + i + 'Content-Disposition: form-data; name="' + a + '"' + i + i + unescape(encodeURIComponent(e)) + i;
        }), r += n + t + n + i;
      }var f = this,
          h,
          p;t.extend(this, { send: function send(n, r) {
          var s = this,
              l = "Mozilla" === u.browser && u.version >= 4 && u.version < 7,
              f = "Android Browser" === u.browser,
              m = !1;if (p = n.url.replace(/^.+?\/([\w\-\.]+)$/, "$1").toLowerCase(), h = c(), h.open(n.method, n.url, n.async, n.user, n.password), r instanceof o) r.isDetached() && (m = !0), r = r.getSource();else if (r instanceof a) {
            if (r.hasBlob()) if (r.getBlob().isDetached()) r = d.call(s, r), m = !0;else if ((l || f) && "blob" === t.typeOf(r.getBlob().getSource()) && window.FileReader) return void e.call(s, n, r);if (r instanceof a) {
              var g = new window.FormData();r.each(function (e, t) {
                e instanceof o ? g.append(t, e.getSource()) : g.append(t, e);
              }), r = g;
            }
          }h.upload ? (n.withCredentials && (h.withCredentials = !0), h.addEventListener("load", function (e) {
            s.trigger(e);
          }), h.addEventListener("error", function (e) {
            s.trigger(e);
          }), h.addEventListener("progress", function (e) {
            s.trigger(e);
          }), h.upload.addEventListener("progress", function (e) {
            s.trigger({ type: "UploadProgress", loaded: e.loaded, total: e.total });
          })) : h.onreadystatechange = function v() {
            switch (h.readyState) {case 1:
                break;case 2:
                break;case 3:
                var e, t;try {
                  i.hasSameOrigin(n.url) && (e = h.getResponseHeader("Content-Length") || 0), h.responseText && (t = h.responseText.length);
                } catch (r) {
                  e = t = 0;
                }s.trigger({ type: "progress", lengthComputable: !!e, total: parseInt(e, 10), loaded: t });break;case 4:
                h.onreadystatechange = function () {}, s.trigger(0 === h.status ? "error" : "load");}
          }, t.isEmptyObj(n.headers) || t.each(n.headers, function (e, t) {
            h.setRequestHeader(t, e);
          }), "" !== n.responseType && "responseType" in h && (h.responseType = "json" !== n.responseType || u.can("return_response_type", "json") ? n.responseType : "text"), m ? h.sendAsBinary ? h.sendAsBinary(r) : !function () {
            for (var e = new Uint8Array(r.length), t = 0; t < r.length; t++) {
              e[t] = 255 & r.charCodeAt(t);
            }h.send(e.buffer);
          }() : h.send(r), s.trigger("loadstart");
        }, getStatus: function getStatus() {
          try {
            if (h) return h.status;
          } catch (e) {}return 0;
        }, getResponse: function getResponse(e) {
          var t = this.getRuntime();try {
            switch (e) {case "blob":
                var i = new r(t.uid, h.response),
                    o = h.getResponseHeader("Content-Disposition");if (o) {
                  var a = o.match(/filename=([\'\"'])([^\1]+)\1/);a && (p = a[2]);
                }return i.name = p, i.type || (i.type = n.getFileMime(p)), i;case "json":
                return u.can("return_response_type", "json") ? h.response : 200 === h.status && window.JSON ? JSON.parse(h.responseText) : null;case "document":
                return l(h);default:
                return "" !== h.responseText ? h.responseText : null;}
          } catch (s) {
            return null;
          }
        }, getAllResponseHeaders: function getAllResponseHeaders() {
          try {
            return h.getAllResponseHeaders();
          } catch (e) {}return "";
        }, abort: function abort() {
          h && h.abort();
        }, destroy: function destroy() {
          f = p = null;
        } });
    }return e.XMLHttpRequest = c;
  }), i(P, [], function () {
    return function () {
      function e(e, t) {
        var n = r ? 0 : -8 * (t - 1),
            i = 0,
            a;for (a = 0; t > a; a++) {
          i |= o.charCodeAt(e + a) << Math.abs(n + 8 * a);
        }return i;
      }function n(e, t, n) {
        n = 3 === arguments.length ? n : o.length - t - 1, o = o.substr(0, t) + e + o.substr(n + t);
      }function i(e, t, i) {
        var o = "",
            a = r ? 0 : -8 * (i - 1),
            s;for (s = 0; i > s; s++) {
          o += String.fromCharCode(t >> Math.abs(a + 8 * s) & 255);
        }n(o, e, i);
      }var r = !1,
          o;return { II: function II(e) {
          return e === t ? r : void (r = e);
        }, init: function init(e) {
          r = !1, o = e;
        }, SEGMENT: function SEGMENT(e, t, i) {
          switch (arguments.length) {case 1:
              return o.substr(e, o.length - e - 1);case 2:
              return o.substr(e, t);case 3:
              n(i, e, t);break;default:
              return o;}
        }, BYTE: function BYTE(t) {
          return e(t, 1);
        }, SHORT: function SHORT(t) {
          return e(t, 2);
        }, LONG: function LONG(n, r) {
          return r === t ? e(n, 4) : void i(n, r, 4);
        }, SLONG: function SLONG(t) {
          var n = e(t, 4);return n > 2147483647 ? n - 4294967296 : n;
        }, STRING: function STRING(t, n) {
          var i = "";for (n += t; n > t; t++) {
            i += String.fromCharCode(e(t, 1));
          }return i;
        } };
    };
  }), i(k, [P], function (e) {
    return function t(n) {
      var i = [],
          r,
          o,
          a,
          s = 0;if (r = new e(), r.init(n), 65496 === r.SHORT(0)) {
        for (o = 2; o <= n.length;) {
          if (a = r.SHORT(o), a >= 65488 && 65495 >= a) o += 2;else {
            if (65498 === a || 65497 === a) break;s = r.SHORT(o + 2) + 2, a >= 65505 && 65519 >= a && i.push({ hex: a, name: "APP" + (15 & a), start: o, length: s, segment: r.SEGMENT(o, s) }), o += s;
          }
        }return r.init(null), { headers: i, restore: function restore(e) {
            var t, n;for (r.init(e), o = 65504 == r.SHORT(2) ? 4 + r.SHORT(4) : 2, n = 0, t = i.length; t > n; n++) {
              r.SEGMENT(o, 0, i[n].segment), o += i[n].length;
            }return e = r.SEGMENT(), r.init(null), e;
          }, strip: function strip(e) {
            var n, i, o;for (i = new t(e), n = i.headers, i.purge(), r.init(e), o = n.length; o--;) {
              r.SEGMENT(n[o].start, n[o].length, "");
            }return e = r.SEGMENT(), r.init(null), e;
          }, get: function get(e) {
            for (var t = [], n = 0, r = i.length; r > n; n++) {
              i[n].name === e.toUpperCase() && t.push(i[n].segment);
            }return t;
          }, set: function set(e, t) {
            var n = [],
                r,
                o,
                a;for ("string" == typeof t ? n.push(t) : n = t, r = o = 0, a = i.length; a > r && (i[r].name === e.toUpperCase() && (i[r].segment = n[o], i[r].length = n[o].length, o++), !(o >= n.length)); r++) {}
          }, purge: function purge() {
            i = [], r.init(null), r = null;
          } };
      }
    };
  }), i(U, [u, P], function (e, n) {
    return function i() {
      function i(e, n) {
        var i = a.SHORT(e),
            r,
            o,
            s,
            u,
            d,
            f,
            h,
            p,
            m = [],
            g = {};for (r = 0; i > r; r++) {
          if (h = f = e + 12 * r + 2, s = n[a.SHORT(h)], s !== t) {
            switch (u = a.SHORT(h += 2), d = a.LONG(h += 2), h += 4, m = [], u) {case 1:case 7:
                for (d > 4 && (h = a.LONG(h) + c.tiffHeader), o = 0; d > o; o++) {
                  m[o] = a.BYTE(h + o);
                }break;case 2:
                d > 4 && (h = a.LONG(h) + c.tiffHeader), g[s] = a.STRING(h, d - 1);continue;case 3:
                for (d > 2 && (h = a.LONG(h) + c.tiffHeader), o = 0; d > o; o++) {
                  m[o] = a.SHORT(h + 2 * o);
                }break;case 4:
                for (d > 1 && (h = a.LONG(h) + c.tiffHeader), o = 0; d > o; o++) {
                  m[o] = a.LONG(h + 4 * o);
                }break;case 5:
                for (h = a.LONG(h) + c.tiffHeader, o = 0; d > o; o++) {
                  m[o] = a.LONG(h + 4 * o) / a.LONG(h + 4 * o + 4);
                }break;case 9:
                for (h = a.LONG(h) + c.tiffHeader, o = 0; d > o; o++) {
                  m[o] = a.SLONG(h + 4 * o);
                }break;case 10:
                for (h = a.LONG(h) + c.tiffHeader, o = 0; d > o; o++) {
                  m[o] = a.SLONG(h + 4 * o) / a.SLONG(h + 4 * o + 4);
                }break;default:
                continue;}p = 1 == d ? m[0] : m, g[s] = l.hasOwnProperty(s) && "object" != (typeof p === "undefined" ? "undefined" : _typeof(p)) ? l[s][p] : p;
          }
        }return g;
      }function r() {
        var e = c.tiffHeader;return a.II(18761 == a.SHORT(e)), 42 !== a.SHORT(e += 2) ? !1 : (c.IFD0 = c.tiffHeader + a.LONG(e += 2), u = i(c.IFD0, s.tiff), "ExifIFDPointer" in u && (c.exifIFD = c.tiffHeader + u.ExifIFDPointer, delete u.ExifIFDPointer), "GPSInfoIFDPointer" in u && (c.gpsIFD = c.tiffHeader + u.GPSInfoIFDPointer, delete u.GPSInfoIFDPointer), !0);
      }function o(e, t, n) {
        var i,
            r,
            o,
            u = 0;if ("string" == typeof t) {
          var l = s[e.toLowerCase()];for (var d in l) {
            if (l[d] === t) {
              t = d;break;
            }
          }
        }i = c[e.toLowerCase() + "IFD"], r = a.SHORT(i);for (var f = 0; r > f; f++) {
          if (o = i + 12 * f + 2, a.SHORT(o) == t) {
            u = o + 8;break;
          }
        }return u ? (a.LONG(u, n), !0) : !1;
      }var a,
          s,
          u,
          c = {},
          l;return a = new n(), s = { tiff: { 274: "Orientation", 270: "ImageDescription", 271: "Make", 272: "Model", 305: "Software", 34665: "ExifIFDPointer", 34853: "GPSInfoIFDPointer" }, exif: { 36864: "ExifVersion", 40961: "ColorSpace", 40962: "PixelXDimension", 40963: "PixelYDimension", 36867: "DateTimeOriginal", 33434: "ExposureTime", 33437: "FNumber", 34855: "ISOSpeedRatings", 37377: "ShutterSpeedValue", 37378: "ApertureValue", 37383: "MeteringMode", 37384: "LightSource", 37385: "Flash", 37386: "FocalLength", 41986: "ExposureMode", 41987: "WhiteBalance", 41990: "SceneCaptureType", 41988: "DigitalZoomRatio", 41992: "Contrast", 41993: "Saturation", 41994: "Sharpness" }, gps: { 0: "GPSVersionID", 1: "GPSLatitudeRef", 2: "GPSLatitude", 3: "GPSLongitudeRef", 4: "GPSLongitude" } }, l = { ColorSpace: { 1: "sRGB", 0: "Uncalibrated" }, MeteringMode: { 0: "Unknown", 1: "Average", 2: "CenterWeightedAverage", 3: "Spot", 4: "MultiSpot", 5: "Pattern", 6: "Partial", 255: "Other" }, LightSource: { 1: "Daylight", 2: "Fliorescent", 3: "Tungsten", 4: "Flash", 9: "Fine weather", 10: "Cloudy weather", 11: "Shade", 12: "Daylight fluorescent (D 5700 - 7100K)", 13: "Day white fluorescent (N 4600 -5400K)", 14: "Cool white fluorescent (W 3900 - 4500K)", 15: "White fluorescent (WW 3200 - 3700K)", 17: "Standard light A", 18: "Standard light B", 19: "Standard light C", 20: "D55", 21: "D65", 22: "D75", 23: "D50", 24: "ISO studio tungsten", 255: "Other" }, Flash: { 0: "Flash did not fire.", 1: "Flash fired.", 5: "Strobe return light not detected.", 7: "Strobe return light detected.", 9: "Flash fired, compulsory flash mode", 13: "Flash fired, compulsory flash mode, return light not detected", 15: "Flash fired, compulsory flash mode, return light detected", 16: "Flash did not fire, compulsory flash mode", 24: "Flash did not fire, auto mode", 25: "Flash fired, auto mode", 29: "Flash fired, auto mode, return light not detected", 31: "Flash fired, auto mode, return light detected", 32: "No flash function", 65: "Flash fired, red-eye reduction mode", 69: "Flash fired, red-eye reduction mode, return light not detected", 71: "Flash fired, red-eye reduction mode, return light detected", 73: "Flash fired, compulsory flash mode, red-eye reduction mode", 77: "Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected", 79: "Flash fired, compulsory flash mode, red-eye reduction mode, return light detected", 89: "Flash fired, auto mode, red-eye reduction mode", 93: "Flash fired, auto mode, return light not detected, red-eye reduction mode", 95: "Flash fired, auto mode, return light detected, red-eye reduction mode" }, ExposureMode: { 0: "Auto exposure", 1: "Manual exposure", 2: "Auto bracket" }, WhiteBalance: { 0: "Auto white balance", 1: "Manual white balance" }, SceneCaptureType: { 0: "Standard", 1: "Landscape", 2: "Portrait", 3: "Night scene" }, Contrast: { 0: "Normal", 1: "Soft", 2: "Hard" }, Saturation: { 0: "Normal", 1: "Low saturation", 2: "High saturation" }, Sharpness: { 0: "Normal", 1: "Soft", 2: "Hard" }, GPSLatitudeRef: { N: "North latitude", S: "South latitude" }, GPSLongitudeRef: { E: "East longitude", W: "West longitude" } }, { init: function init(e) {
          return c = { tiffHeader: 10 }, e !== t && e.length ? (a.init(e), 65505 === a.SHORT(0) && "EXIF\x00" === a.STRING(4, 5).toUpperCase() ? r() : !1) : !1;
        }, TIFF: function TIFF() {
          return u;
        }, EXIF: function EXIF() {
          var t;if (t = i(c.exifIFD, s.exif), t.ExifVersion && "array" === e.typeOf(t.ExifVersion)) {
            for (var n = 0, r = ""; n < t.ExifVersion.length; n++) {
              r += String.fromCharCode(t.ExifVersion[n]);
            }t.ExifVersion = r;
          }return t;
        }, GPS: function GPS() {
          var t;return t = i(c.gpsIFD, s.gps), t.GPSVersionID && "array" === e.typeOf(t.GPSVersionID) && (t.GPSVersionID = t.GPSVersionID.join(".")), t;
        }, setExif: function setExif(e, t) {
          return "PixelXDimension" !== e && "PixelYDimension" !== e ? !1 : o("exif", e, t);
        }, getBinary: function getBinary() {
          return a.SEGMENT();
        }, purge: function purge() {
          a.init(null), a = u = null, c = {};
        } };
    };
  }), i(B, [u, h, k, P, U], function (e, t, n, i, r) {
    function o(o) {
      function a() {
        for (var e = 0, t, n; e <= u.length;) {
          if (t = c.SHORT(e += 2), t >= 65472 && 65475 >= t) return e += 5, { height: c.SHORT(e), width: c.SHORT(e += 2) };n = c.SHORT(e += 2), e += n - 2;
        }return null;
      }function s() {
        d && l && c && (d.purge(), l.purge(), c.init(null), u = f = l = d = c = null);
      }var u, c, l, d, f, h;if (u = o, c = new i(), c.init(u), 65496 !== c.SHORT(0)) throw new t.ImageError(t.ImageError.WRONG_FORMAT);l = new n(o), d = new r(), h = !!d.init(l.get("app1")[0]), f = a.call(this), e.extend(this, { type: "image/jpeg", size: u.length, width: f && f.width || 0, height: f && f.height || 0, setExif: function setExif(t, n) {
          return h ? ("object" === e.typeOf(t) ? e.each(t, function (e, t) {
            d.setExif(t, e);
          }) : d.setExif(t, n), void l.set("app1", d.getBinary())) : !1;
        }, writeHeaders: function writeHeaders() {
          return arguments.length ? l.restore(arguments[0]) : u = l.restore(u);
        }, stripHeaders: function stripHeaders(e) {
          return l.strip(e);
        }, purge: function purge() {
          s.call(this);
        } }), h && (this.meta = { tiff: d.TIFF(), exif: d.EXIF(), gps: d.GPS() });
    }return o;
  }), i(z, [h, u, P], function (e, t, n) {
    function i(i) {
      function r() {
        var e, t;return e = a.call(this, 8), "IHDR" == e.type ? (t = e.start, { width: u.LONG(t), height: u.LONG(t += 4) }) : null;
      }function o() {
        u && (u.init(null), s = d = c = l = u = null);
      }function a(e) {
        var t, n, i, r;return t = u.LONG(e), n = u.STRING(e += 4, 4), i = e += 4, r = u.LONG(e + t), { length: t, type: n, start: i, CRC: r };
      }var s, u, c, l, d;s = i, u = new n(), u.init(s), function () {
        var t = 0,
            n = 0,
            i = [35152, 20039, 3338, 6666];for (n = 0; n < i.length; n++, t += 2) {
          if (i[n] != u.SHORT(t)) throw new e.ImageError(e.ImageError.WRONG_FORMAT);
        }
      }(), d = r.call(this), t.extend(this, { type: "image/png", size: s.length, width: d.width, height: d.height, purge: function purge() {
          o.call(this);
        } }), o.call(this);
    }return i;
  }), i(G, [u, h, B, z], function (e, t, n, i) {
    return function (r) {
      var o = [n, i],
          a;a = function () {
        for (var e = 0; e < o.length; e++) {
          try {
            return new o[e](r);
          } catch (n) {}
        }throw new t.ImageError(t.ImageError.WRONG_FORMAT);
      }(), e.extend(this, { type: "", size: 0, width: 0, height: 0, setExif: function setExif() {}, writeHeaders: function writeHeaders(e) {
          return e;
        }, stripHeaders: function stripHeaders(e) {
          return e;
        }, purge: function purge() {} }), e.extend(this, a), this.purge = function () {
        a.purge(), a = null;
      };
    };
  }), i(q, [], function () {
    function e(e, i, r) {
      var o = e.naturalWidth,
          a = e.naturalHeight,
          s = r.width,
          u = r.height,
          c = r.x || 0,
          l = r.y || 0,
          d = i.getContext("2d");t(e) && (o /= 2, a /= 2);var f = 1024,
          h = document.createElement("canvas");h.width = h.height = f;for (var p = h.getContext("2d"), m = n(e, o, a), g = 0; a > g;) {
        for (var v = g + f > a ? a - g : f, y = 0; o > y;) {
          var w = y + f > o ? o - y : f;p.clearRect(0, 0, f, f), p.drawImage(e, -y, -g);var E = y * s / o + c << 0,
              _ = Math.ceil(w * s / o),
              x = g * u / a / m + l << 0,
              b = Math.ceil(v * u / a / m);d.drawImage(h, 0, 0, w, v, E, x, _, b), y += f;
        }g += f;
      }h = p = null;
    }function t(e) {
      var t = e.naturalWidth,
          n = e.naturalHeight;if (t * n > 1048576) {
        var i = document.createElement("canvas");i.width = i.height = 1;var r = i.getContext("2d");return r.drawImage(e, -t + 1, 0), 0 === r.getImageData(0, 0, 1, 1).data[3];
      }return !1;
    }function n(e, t, n) {
      var i = document.createElement("canvas");i.width = 1, i.height = n;var r = i.getContext("2d");r.drawImage(e, 0, 0);for (var o = r.getImageData(0, 0, 1, n).data, a = 0, s = n, u = n; u > a;) {
        var c = o[4 * (u - 1) + 3];0 === c ? s = u : a = u, u = s + a >> 1;
      }i = null;var l = u / n;return 0 === l ? 1 : l;
    }return { isSubsampled: t, renderTo: e };
  }), i(X, [D, u, h, m, w, G, q, l, d], function (e, t, n, i, r, o, a, s, u) {
    function c() {
      function e() {
        if (!E && !y) throw new n.ImageError(n.DOMException.INVALID_STATE_ERR);return E || y;
      }function c(e) {
        return i.atob(e.substring(e.indexOf("base64,") + 7));
      }function l(e, t) {
        return "data:" + (t || "") + ";base64," + i.btoa(e);
      }function d(e) {
        var t = this;y = new Image(), y.onerror = function () {
          g.call(this), t.trigger("error", n.ImageError.WRONG_FORMAT);
        }, y.onload = function () {
          t.trigger("load");
        }, y.src = /^data:[^;]*;base64,/.test(e) ? e : l(e, x.type);
      }function f(e, t) {
        var i = this,
            r;return window.FileReader ? (r = new FileReader(), r.onload = function () {
          t(this.result);
        }, r.onerror = function () {
          i.trigger("error", n.ImageError.WRONG_FORMAT);
        }, r.readAsDataURL(e), void 0) : t(e.getAsDataURL());
      }function h(n, i, r, o) {
        var a = this,
            s,
            u,
            c = 0,
            l = 0,
            d,
            f,
            h,
            g;if (R = o, g = this.meta && this.meta.tiff && this.meta.tiff.Orientation || 1, -1 !== t.inArray(g, [5, 6, 7, 8])) {
          var v = n;n = i, i = v;
        }return d = e(), r ? (n = Math.min(n, d.width), i = Math.min(i, d.height), s = Math.max(n / d.width, i / d.height)) : s = Math.min(n / d.width, i / d.height), s > 1 && !r && o ? void this.trigger("Resize") : (E || (E = document.createElement("canvas")), f = Math.round(d.width * s), h = Math.round(d.height * s), r ? (E.width = n, E.height = i, f > n && (c = Math.round((f - n) / 2)), h > i && (l = Math.round((h - i) / 2))) : (E.width = f, E.height = h), R || m(E.width, E.height, g), p.call(this, d, E, -c, -l, f, h), this.width = E.width, this.height = E.height, b = !0, void a.trigger("Resize"));
      }function p(e, t, n, i, r, o) {
        if ("iOS" === u.OS) a.renderTo(e, t, { width: r, height: o, x: n, y: i });else {
          var s = t.getContext("2d");s.drawImage(e, n, i, r, o);
        }
      }function m(e, t, n) {
        switch (n) {case 5:case 6:case 7:case 8:
            E.width = t, E.height = e;break;default:
            E.width = e, E.height = t;}var i = E.getContext("2d");switch (n) {case 2:
            i.translate(e, 0), i.scale(-1, 1);break;case 3:
            i.translate(e, t), i.rotate(Math.PI);break;case 4:
            i.translate(0, t), i.scale(1, -1);break;case 5:
            i.rotate(.5 * Math.PI), i.scale(1, -1);break;case 6:
            i.rotate(.5 * Math.PI), i.translate(0, -t);break;case 7:
            i.rotate(.5 * Math.PI), i.translate(e, -t), i.scale(-1, 1);break;case 8:
            i.rotate(-.5 * Math.PI), i.translate(-e, 0);}
      }function g() {
        w && (w.purge(), w = null), _ = y = E = x = null, b = !1;
      }var v = this,
          y,
          w,
          E,
          _,
          x,
          b = !1,
          R = !0;t.extend(this, { loadFromBlob: function loadFromBlob(e) {
          var t = this,
              i = t.getRuntime(),
              r = arguments.length > 1 ? arguments[1] : !0;if (!i.can("access_binary")) throw new n.RuntimeError(n.RuntimeError.NOT_SUPPORTED_ERR);return x = e, e.isDetached() ? (_ = e.getSource(), void d.call(this, _)) : void f.call(this, e.getSource(), function (e) {
            r && (_ = c(e)), d.call(t, e);
          });
        }, loadFromImage: function loadFromImage(e, t) {
          this.meta = e.meta, x = new r(null, { name: e.name, size: e.size, type: e.type }), d.call(this, t ? _ = e.getAsBinaryString() : e.getAsDataURL());
        }, getInfo: function getInfo() {
          var t = this.getRuntime(),
              n;return !w && _ && t.can("access_image_binary") && (w = new o(_)), n = { width: e().width || 0, height: e().height || 0, type: x.type || s.getFileMime(x.name), size: _ && _.length || x.size || 0, name: x.name || "", meta: w && w.meta || this.meta || {} };
        }, downsize: function downsize() {
          h.apply(this, arguments);
        }, getAsCanvas: function getAsCanvas() {
          return E && (E.id = this.uid + "_canvas"), E;
        }, getAsBlob: function getAsBlob(e, t) {
          return e !== this.type && h.call(this, this.width, this.height, !1), new r(null, { name: x.name || "", type: e, data: v.getAsBinaryString.call(this, e, t) });
        }, getAsDataURL: function getAsDataURL(e) {
          var t = arguments[1] || 90;if (!b) return y.src;if ("image/jpeg" !== e) return E.toDataURL("image/png");try {
            return E.toDataURL("image/jpeg", t / 100);
          } catch (n) {
            return E.toDataURL("image/jpeg");
          }
        }, getAsBinaryString: function getAsBinaryString(e, t) {
          if (!b) return _ || (_ = c(v.getAsDataURL(e, t))), _;if ("image/jpeg" !== e) _ = c(v.getAsDataURL(e, t));else {
            var n;t || (t = 90);try {
              n = E.toDataURL("image/jpeg", t / 100);
            } catch (i) {
              n = E.toDataURL("image/jpeg");
            }_ = c(n), w && (_ = w.stripHeaders(_), R && (w.meta && w.meta.exif && w.setExif({ PixelXDimension: this.width, PixelYDimension: this.height }), _ = w.writeHeaders(_)), w.purge(), w = null);
          }return b = !1, _;
        }, destroy: function destroy() {
          v = null, g.call(this), this.getRuntime().getShim().removeInstance(this.uid);
        } });
    }return e.Image = c;
  }), i(j, [u, d, f, h, g], function (e, t, n, i, r) {
    function o() {
      var e;try {
        e = navigator.plugins["Shockwave Flash"], e = e.description;
      } catch (t) {
        try {
          e = new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version");
        } catch (n) {
          e = "0.0";
        }
      }return e = e.match(/\d+/g), parseFloat(e[0] + "." + e[1]);
    }function a(a) {
      var c = this,
          l;a = e.extend({ swf_url: t.swf_url }, a), r.call(this, a, s, { access_binary: function access_binary(e) {
          return e && "browser" === c.mode;
        }, access_image_binary: function access_image_binary(e) {
          return e && "browser" === c.mode;
        }, display_media: r.capTrue, do_cors: r.capTrue, drag_and_drop: !1, report_upload_progress: function report_upload_progress() {
          return "client" === c.mode;
        }, resize_image: r.capTrue, return_response_headers: !1, return_response_type: function return_response_type(t) {
          return "json" === t && window.JSON ? !0 : !e.arrayDiff(t, ["", "text", "document"]) || "browser" === c.mode;
        }, return_status_code: function return_status_code(t) {
          return "browser" === c.mode || !e.arrayDiff(t, [200, 404]);
        }, select_file: r.capTrue, select_multiple: r.capTrue, send_binary_string: function send_binary_string(e) {
          return e && "browser" === c.mode;
        }, send_browser_cookies: function send_browser_cookies(e) {
          return e && "browser" === c.mode;
        }, send_custom_headers: function send_custom_headers(e) {
          return e && "browser" === c.mode;
        }, send_multipart: r.capTrue, slice_blob: function slice_blob(e) {
          return e && "browser" === c.mode;
        }, stream_upload: function stream_upload(e) {
          return e && "browser" === c.mode;
        }, summon_file_dialog: !1, upload_filesize: function upload_filesize(t) {
          return e.parseSizeStr(t) <= 2097152 || "client" === c.mode;
        }, use_http_method: function use_http_method(t) {
          return !e.arrayDiff(t, ["GET", "POST"]);
        } }, { access_binary: function access_binary(e) {
          return e ? "browser" : "client";
        }, access_image_binary: function access_image_binary(e) {
          return e ? "browser" : "client";
        }, report_upload_progress: function report_upload_progress(e) {
          return e ? "browser" : "client";
        }, return_response_type: function return_response_type(t) {
          return e.arrayDiff(t, ["", "text", "json", "document"]) ? "browser" : ["client", "browser"];
        }, return_status_code: function return_status_code(t) {
          return e.arrayDiff(t, [200, 404]) ? "browser" : ["client", "browser"];
        }, send_binary_string: function send_binary_string(e) {
          return e ? "browser" : "client";
        }, send_browser_cookies: function send_browser_cookies(e) {
          return e ? "browser" : "client";
        }, send_custom_headers: function send_custom_headers(e) {
          return e ? "browser" : "client";
        }, stream_upload: function stream_upload(e) {
          return e ? "client" : "browser";
        }, upload_filesize: function upload_filesize(t) {
          return e.parseSizeStr(t) >= 2097152 ? "client" : "browser";
        } }, "client"), o() < 10 && (this.mode = !1), e.extend(this, { getShim: function getShim() {
          return n.get(this.uid);
        }, shimExec: function shimExec(e, t) {
          var n = [].slice.call(arguments, 2);return c.getShim().exec(this.uid, e, t, n);
        }, init: function init() {
          var n, r, o;o = this.getShimContainer(), e.extend(o.style, { position: "absolute", top: "-8px", left: "-8px", width: "9px", height: "9px", overflow: "hidden" }), n = '<object id="' + this.uid + '" type="application/x-shockwave-flash" data="' + a.swf_url + '" ', "IE" === t.browser && (n += 'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '), n += 'width="100%" height="100%" style="outline:0"><param name="movie" value="' + a.swf_url + '" /><param name="flashvars" value="uid=' + escape(this.uid) + "&target=" + t.global_event_dispatcher + '" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>', "IE" === t.browser ? (r = document.createElement("div"), o.appendChild(r), r.outerHTML = n, r = o = null) : o.innerHTML = n, l = setTimeout(function () {
            c && !c.initialized && c.trigger("Error", new i.RuntimeError(i.RuntimeError.NOT_INIT_ERR));
          }, 5e3);
        }, destroy: function (e) {
          return function () {
            e.call(c), clearTimeout(l), a = l = e = c = null;
          };
        }(this.destroy) }, u);
    }var s = "flash",
        u = {};return r.addConstructor(s, a), u;
  }), i(V, [j, y], function (e, t) {
    var n = { slice: function slice(e, n, i, r) {
        var o = this.getRuntime();return 0 > n ? n = Math.max(e.size + n, 0) : n > 0 && (n = Math.min(n, e.size)), 0 > i ? i = Math.max(e.size + i, 0) : i > 0 && (i = Math.min(i, e.size)), e = o.shimExec.call(this, "Blob", "slice", n, i, r || ""), e && (e = new t(o.uid, e)), e;
      } };return e.Blob = n;
  }), i(W, [j], function (e) {
    var t = { init: function init(e) {
        this.getRuntime().shimExec.call(this, "FileInput", "init", { name: e.name, accept: e.accept, multiple: e.multiple }), this.trigger("ready");
      } };return e.FileInput = t;
  }), i(Y, [j, m], function (e, t) {
    function n(e, n) {
      switch (n) {case "readAsText":
          return t.atob(e, "utf8");case "readAsBinaryString":
          return t.atob(e);case "readAsDataURL":
          return e;}return null;
    }var i = "",
        r = { read: function read(e, t) {
        var r = this,
            o = r.getRuntime();return "readAsDataURL" === e && (i = "data:" + (t.type || "") + ";base64,"), r.bind("Progress", function (t, r) {
          r && (i += n(r, e));
        }), o.shimExec.call(this, "FileReader", "readAsBase64", t.uid);
      }, getResult: function getResult() {
        return i;
      }, destroy: function destroy() {
        i = null;
      } };return e.FileReader = r;
  }), i($, [j, m], function (e, t) {
    function n(e, n) {
      switch (n) {case "readAsText":
          return t.atob(e, "utf8");case "readAsBinaryString":
          return t.atob(e);case "readAsDataURL":
          return e;}return null;
    }var i = { read: function read(e, t) {
        var i,
            r = this.getRuntime();return (i = r.shimExec.call(this, "FileReaderSync", "readAsBase64", t.uid)) ? ("readAsDataURL" === e && (i = "data:" + (t.type || "") + ";base64," + i), n(i, e, t.type)) : null;
      } };return e.FileReaderSync = i;
  }), i(J, [j, u, y, w, T, A, O], function (e, t, n, i, r, o, a) {
    var s = { send: function send(e, i) {
        function r() {
          e.transport = l.mode, l.shimExec.call(c, "XMLHttpRequest", "send", e, i);
        }function s(e, t) {
          l.shimExec.call(c, "XMLHttpRequest", "appendBlob", e, t.uid), i = null, r();
        }function u(e, t) {
          var n = new a();n.bind("TransportingComplete", function () {
            t(this.result);
          }), n.transport(e.getSource(), e.type, { ruid: l.uid });
        }var c = this,
            l = c.getRuntime();if (t.isEmptyObj(e.headers) || t.each(e.headers, function (e, t) {
          l.shimExec.call(c, "XMLHttpRequest", "setRequestHeader", t, e.toString());
        }), i instanceof o) {
          var d;if (i.each(function (e, t) {
            e instanceof n ? d = t : l.shimExec.call(c, "XMLHttpRequest", "append", t, e);
          }), i.hasBlob()) {
            var f = i.getBlob();f.isDetached() ? u(f, function (e) {
              f.destroy(), s(d, e);
            }) : s(d, f);
          } else i = null, r();
        } else i instanceof n ? i.isDetached() ? u(i, function (e) {
          i.destroy(), i = e.uid, r();
        }) : (i = i.uid, r()) : r();
      }, getResponse: function getResponse(e) {
        var n,
            o,
            a = this.getRuntime();if (o = a.shimExec.call(this, "XMLHttpRequest", "getResponseAsBlob")) {
          if (o = new i(a.uid, o), "blob" === e) return o;try {
            if (n = new r(), ~t.inArray(e, ["", "text"])) return n.readAsText(o);if ("json" === e && window.JSON) return JSON.parse(n.readAsText(o));
          } finally {
            o.destroy();
          }
        }return null;
      }, abort: function abort(e) {
        var t = this.getRuntime();t.shimExec.call(this, "XMLHttpRequest", "abort"), this.dispatchEvent("readystatechange"), this.dispatchEvent("abort");
      } };return e.XMLHttpRequest = s;
  }), i(Z, [j, y], function (e, t) {
    var n = { getAsBlob: function getAsBlob(e) {
        var n = this.getRuntime(),
            i = n.shimExec.call(this, "Transporter", "getAsBlob", e);return i ? new t(n.uid, i) : null;
      } };return e.Transporter = n;
  }), i(K, [j, u, O, y, T], function (e, t, n, i, r) {
    var o = { loadFromBlob: function loadFromBlob(e) {
        function t(e) {
          r.shimExec.call(i, "Image", "loadFromBlob", e.uid), i = r = null;
        }var i = this,
            r = i.getRuntime();if (e.isDetached()) {
          var o = new n();o.bind("TransportingComplete", function () {
            t(o.result.getSource());
          }), o.transport(e.getSource(), e.type, { ruid: r.uid });
        } else t(e.getSource());
      }, loadFromImage: function loadFromImage(e) {
        var t = this.getRuntime();return t.shimExec.call(this, "Image", "loadFromImage", e.uid);
      }, getAsBlob: function getAsBlob(e, t) {
        var n = this.getRuntime(),
            r = n.shimExec.call(this, "Image", "getAsBlob", e, t);return r ? new i(n.uid, r) : null;
      }, getAsDataURL: function getAsDataURL() {
        var e = this.getRuntime(),
            t = e.Image.getAsBlob.apply(this, arguments),
            n;return t ? (n = new r(), n.readAsDataURL(t)) : null;
      } };return e.Image = o;
  }), i(Q, [u, d, f, h, g], function (e, t, n, i, r) {
    function o(e) {
      var t = !1,
          n = null,
          i,
          r,
          o,
          a,
          s,
          u = 0;try {
        try {
          n = new ActiveXObject("AgControl.AgControl"), n.IsVersionSupported(e) && (t = !0), n = null;
        } catch (c) {
          var l = navigator.plugins["Silverlight Plug-In"];if (l) {
            for (i = l.description, "1.0.30226.2" === i && (i = "2.0.30226.2"), r = i.split("."); r.length > 3;) {
              r.pop();
            }for (; r.length < 4;) {
              r.push(0);
            }for (o = e.split("."); o.length > 4;) {
              o.pop();
            }do {
              a = parseInt(o[u], 10), s = parseInt(r[u], 10), u++;
            } while (u < o.length && a === s);s >= a && !isNaN(a) && (t = !0);
          }
        }
      } catch (d) {
        t = !1;
      }return t;
    }function a(a) {
      var c = this,
          l;a = e.extend({ xap_url: t.xap_url }, a), r.call(this, a, s, { access_binary: r.capTrue, access_image_binary: r.capTrue, display_media: r.capTrue, do_cors: r.capTrue, drag_and_drop: !1, report_upload_progress: r.capTrue, resize_image: r.capTrue, return_response_headers: function return_response_headers(e) {
          return e && "client" === c.mode;
        }, return_response_type: function return_response_type(e) {
          return "json" !== e ? !0 : !!window.JSON;
        }, return_status_code: function return_status_code(t) {
          return "client" === c.mode || !e.arrayDiff(t, [200, 404]);
        }, select_file: r.capTrue, select_multiple: r.capTrue, send_binary_string: r.capTrue, send_browser_cookies: function send_browser_cookies(e) {
          return e && "browser" === c.mode;
        }, send_custom_headers: function send_custom_headers(e) {
          return e && "client" === c.mode;
        }, send_multipart: r.capTrue, slice_blob: r.capTrue, stream_upload: !0, summon_file_dialog: !1, upload_filesize: r.capTrue, use_http_method: function use_http_method(t) {
          return "client" === c.mode || !e.arrayDiff(t, ["GET", "POST"]);
        } }, { return_response_headers: function return_response_headers(e) {
          return e ? "client" : "browser";
        }, return_status_code: function return_status_code(t) {
          return e.arrayDiff(t, [200, 404]) ? "client" : ["client", "browser"];
        }, send_browser_cookies: function send_browser_cookies(e) {
          return e ? "browser" : "client";
        }, send_custom_headers: function send_custom_headers(e) {
          return e ? "client" : "browser";
        }, use_http_method: function use_http_method(t) {
          return e.arrayDiff(t, ["GET", "POST"]) ? "client" : ["client", "browser"];
        } }), o("2.0.31005.0") && "Opera" !== t.browser || (this.mode = !1), e.extend(this, { getShim: function getShim() {
          return n.get(this.uid).content.Moxie;
        }, shimExec: function shimExec(e, t) {
          var n = [].slice.call(arguments, 2);return c.getShim().exec(this.uid, e, t, n);
        }, init: function init() {
          var e;e = this.getShimContainer(), e.innerHTML = '<object id="' + this.uid + '" data="data:application/x-silverlight," type="application/x-silverlight-2" width="100%" height="100%" style="outline:none;"><param name="source" value="' + a.xap_url + '"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="uid=' + this.uid + ",target=" + t.global_event_dispatcher + '"/></object>', l = setTimeout(function () {
            c && !c.initialized && c.trigger("Error", new i.RuntimeError(i.RuntimeError.NOT_INIT_ERR));
          }, "Windows" !== t.OS ? 1e4 : 5e3);
        }, destroy: function (e) {
          return function () {
            e.call(c), clearTimeout(l), a = l = e = c = null;
          };
        }(this.destroy) }, u);
    }var s = "silverlight",
        u = {};return r.addConstructor(s, a), u;
  }), i(et, [Q, u, V], function (e, t, n) {
    return e.Blob = t.extend({}, n);
  }), i(tt, [Q], function (e) {
    var t = { init: function init(e) {
        function t(e) {
          for (var t = "", n = 0; n < e.length; n++) {
            t += ("" !== t ? "|" : "") + e[n].title + " | *." + e[n].extensions.replace(/,/g, ";*.");
          }return t;
        }this.getRuntime().shimExec.call(this, "FileInput", "init", t(e.accept), e.name, e.multiple), this.trigger("ready");
      } };return e.FileInput = t;
  }), i(nt, [Q, f, L], function (e, t, n) {
    var i = { init: function init() {
        var e = this,
            i = e.getRuntime(),
            r;return r = i.getShimContainer(), n.addEvent(r, "dragover", function (e) {
          e.preventDefault(), e.stopPropagation(), e.dataTransfer.dropEffect = "copy";
        }, e.uid), n.addEvent(r, "dragenter", function (e) {
          e.preventDefault();var n = t.get(i.uid).dragEnter(e);n && e.stopPropagation();
        }, e.uid), n.addEvent(r, "drop", function (e) {
          e.preventDefault();var n = t.get(i.uid).dragDrop(e);n && e.stopPropagation();
        }, e.uid), i.shimExec.call(this, "FileDrop", "init");
      } };return e.FileDrop = i;
  }), i(it, [Q, u, Y], function (e, t, n) {
    return e.FileReader = t.extend({}, n);
  }), i(rt, [Q, u, $], function (e, t, n) {
    return e.FileReaderSync = t.extend({}, n);
  }), i(ot, [Q, u, J], function (e, t, n) {
    return e.XMLHttpRequest = t.extend({}, n);
  }), i(at, [Q, u, Z], function (e, t, n) {
    return e.Transporter = t.extend({}, n);
  }), i(st, [Q, u, K], function (e, t, n) {
    return e.Image = t.extend({}, n, { getInfo: function getInfo() {
        var e = this.getRuntime(),
            n = ["tiff", "exif", "gps"],
            i = { meta: {} },
            r = e.shimExec.call(this, "Image", "getInfo");return r.meta && t.each(n, function (e) {
          var t = r.meta[e],
              n,
              o,
              a,
              s;if (t && t.keys) for (i.meta[e] = {}, o = 0, a = t.keys.length; a > o; o++) {
            n = t.keys[o], s = t[n], s && (/^(\d|[1-9]\d+)$/.test(s) ? s = parseInt(s, 10) : /^\d*\.\d+$/.test(s) && (s = parseFloat(s)), i.meta[e][n] = s);
          }
        }), i.width = parseInt(r.width, 10), i.height = parseInt(r.height, 10), i.size = parseInt(r.size, 10), i.type = r.type, i.name = r.name, i;
      } });
  }), i(ut, [u, h, g, d], function (e, t, n, i) {
    function r(t) {
      var r = this,
          s = n.capTest,
          u = n.capTrue;n.call(this, t, o, { access_binary: s(window.FileReader || window.File && File.getAsDataURL), access_image_binary: !1, display_media: s(a.Image && (i.can("create_canvas") || i.can("use_data_uri_over32kb"))), do_cors: !1, drag_and_drop: !1, filter_by_extension: s(function () {
          return "Chrome" === i.browser && i.version >= 28 || "IE" === i.browser && i.version >= 10;
        }()), resize_image: function resize_image() {
          return a.Image && r.can("access_binary") && i.can("create_canvas");
        }, report_upload_progress: !1, return_response_headers: !1, return_response_type: function return_response_type(t) {
          return "json" === t && window.JSON ? !0 : !!~e.inArray(t, ["text", "document", ""]);
        }, return_status_code: function return_status_code(t) {
          return !e.arrayDiff(t, [200, 404]);
        }, select_file: function select_file() {
          return i.can("use_fileinput");
        }, select_multiple: !1, send_binary_string: !1, send_custom_headers: !1, send_multipart: !0, slice_blob: !1, stream_upload: function stream_upload() {
          return r.can("select_file");
        }, summon_file_dialog: s(function () {
          return "Firefox" === i.browser && i.version >= 4 || "Opera" === i.browser && i.version >= 12 || !!~e.inArray(i.browser, ["Chrome", "Safari"]);
        }()), upload_filesize: u, use_http_method: function use_http_method(t) {
          return !e.arrayDiff(t, ["GET", "POST"]);
        } }), e.extend(this, { init: function init() {
          this.trigger("Init");
        }, destroy: function (e) {
          return function () {
            e.call(r), e = r = null;
          };
        }(this.destroy) }), e.extend(this.getShim(), a);
    }var o = "html4",
        a = {};return n.addConstructor(o, r), a;
  }), i(ct, [ut, u, f, L, l, d], function (e, t, n, i, r, o) {
    function a() {
      function e() {
        var r = this,
            l = r.getRuntime(),
            d,
            f,
            h,
            p,
            m,
            g;g = t.guid("uid_"), d = l.getShimContainer(), a && (h = n.get(a + "_form"), h && t.extend(h.style, { top: "100%" })), p = document.createElement("form"), p.setAttribute("id", g + "_form"), p.setAttribute("method", "post"), p.setAttribute("enctype", "multipart/form-data"), p.setAttribute("encoding", "multipart/form-data"), t.extend(p.style, { overflow: "hidden", position: "absolute", top: 0, left: 0, width: "100%", height: "100%" }), m = document.createElement("input"), m.setAttribute("id", g), m.setAttribute("type", "file"), m.setAttribute("name", c.name || "Filedata"), m.setAttribute("accept", u.join(",")), t.extend(m.style, { fontSize: "999px", opacity: 0 }), p.appendChild(m), d.appendChild(p), t.extend(m.style, { position: "absolute", top: 0, left: 0, width: "100%", height: "100%" }), "IE" === o.browser && o.version < 10 && t.extend(m.style, { filter: "progid:DXImageTransform.Microsoft.Alpha(opacity=0)" }), m.onchange = function () {
          var t;this.value && (t = this.files ? this.files[0] : { name: this.value }, s = [t], this.onchange = function () {}, e.call(r), r.bind("change", function i() {
            var e = n.get(g),
                t = n.get(g + "_form"),
                o;r.unbind("change", i), r.files.length && e && t && (o = r.files[0], e.setAttribute("id", o.uid), t.setAttribute("id", o.uid + "_form"), t.setAttribute("target", o.uid + "_iframe")), e = t = null;
          }, 998), m = p = null, r.trigger("change"));
        }, l.can("summon_file_dialog") && (f = n.get(c.browse_button), i.removeEvent(f, "click", r.uid), i.addEvent(f, "click", function (e) {
          m && !m.disabled && m.click(), e.preventDefault();
        }, r.uid)), a = g, d = h = f = null;
      }var a,
          s = [],
          u = [],
          c;t.extend(this, { init: function init(t) {
          var o = this,
              a = o.getRuntime(),
              s;c = t, u = t.accept.mimes || r.extList2mimes(t.accept, a.can("filter_by_extension")), s = a.getShimContainer(), function () {
            var e, r, u;e = n.get(t.browse_button), a.can("summon_file_dialog") && ("static" === n.getStyle(e, "position") && (e.style.position = "relative"), r = parseInt(n.getStyle(e, "z-index"), 10) || 1, e.style.zIndex = r, s.style.zIndex = r - 1), u = a.can("summon_file_dialog") ? e : s, i.addEvent(u, "mouseover", function () {
              o.trigger("mouseenter");
            }, o.uid), i.addEvent(u, "mouseout", function () {
              o.trigger("mouseleave");
            }, o.uid), i.addEvent(u, "mousedown", function () {
              o.trigger("mousedown");
            }, o.uid), i.addEvent(n.get(t.container), "mouseup", function () {
              o.trigger("mouseup");
            }, o.uid), e = null;
          }(), e.call(this), s = null, o.trigger({ type: "ready", async: !0 });
        }, getFiles: function getFiles() {
          return s;
        }, disable: function disable(e) {
          var t;(t = n.get(a)) && (t.disabled = !!e);
        }, destroy: function destroy() {
          var e = this.getRuntime(),
              t = e.getShim(),
              r = e.getShimContainer();i.removeAllEvents(r, this.uid), i.removeAllEvents(c && n.get(c.container), this.uid), i.removeAllEvents(c && n.get(c.browse_button), this.uid), r && (r.innerHTML = ""), t.removeInstance(this.uid), a = s = u = c = r = t = null;
        } });
    }return e.FileInput = a;
  }), i(lt, [ut, F], function (e, t) {
    return e.FileReader = t;
  }), i(dt, [ut, u, f, R, h, L, y, A], function (e, t, n, i, r, o, a, s) {
    function u() {
      function e(e) {
        var t = this,
            i,
            r,
            a,
            s,
            u = !1;if (l) {
          if (i = l.id.replace(/_iframe$/, ""), r = n.get(i + "_form")) {
            for (a = r.getElementsByTagName("input"), s = a.length; s--;) {
              switch (a[s].getAttribute("type")) {case "hidden":
                  a[s].parentNode.removeChild(a[s]);break;case "file":
                  u = !0;}
            }a = [], u || r.parentNode.removeChild(r), r = null;
          }setTimeout(function () {
            o.removeEvent(l, "load", t.uid), l.parentNode && l.parentNode.removeChild(l);var n = t.getRuntime().getShimContainer();n.children.length || n.parentNode.removeChild(n), n = l = null, e();
          }, 1);
        }
      }var u, c, l;t.extend(this, { send: function send(d, f) {
          function h() {
            var n = m.getShimContainer() || document.body,
                r = document.createElement("div");r.innerHTML = '<iframe id="' + g + '_iframe" name="' + g + '_iframe" src="javascript:&quot;&quot;" style="display:none"></iframe>', l = r.firstChild, n.appendChild(l), o.addEvent(l, "load", function () {
              var n;try {
                n = l.contentWindow.document || l.contentDocument || window.frames[l.id].document, /^4(0[0-9]|1[0-7]|2[2346])\s/.test(n.title) ? u = n.title.replace(/^(\d+).*$/, "$1") : (u = 200, c = t.trim(n.body.innerHTML), p.trigger({ type: "progress", loaded: c.length, total: c.length }), w && p.trigger({ type: "uploadprogress", loaded: w.size || 1025, total: w.size || 1025 }));
              } catch (r) {
                if (!i.hasSameOrigin(d.url)) return void e.call(p, function () {
                  p.trigger("error");
                });u = 404;
              }e.call(p, function () {
                p.trigger("load");
              });
            }, p.uid);
          }var p = this,
              m = p.getRuntime(),
              g,
              v,
              y,
              w;if (u = c = null, f instanceof s && f.hasBlob()) {
            if (w = f.getBlob(), g = w.uid, y = n.get(g), v = n.get(g + "_form"), !v) throw new r.DOMException(r.DOMException.NOT_FOUND_ERR);
          } else g = t.guid("uid_"), v = document.createElement("form"), v.setAttribute("id", g + "_form"), v.setAttribute("method", d.method), v.setAttribute("enctype", "multipart/form-data"), v.setAttribute("encoding", "multipart/form-data"), v.setAttribute("target", g + "_iframe"), m.getShimContainer().appendChild(v);f instanceof s && f.each(function (e, n) {
            if (e instanceof a) y && y.setAttribute("name", n);else {
              var i = document.createElement("input");t.extend(i, { type: "hidden", name: n, value: e }), y ? v.insertBefore(i, y) : v.appendChild(i);
            }
          }), v.setAttribute("action", d.url), h(), v.submit(), p.trigger("loadstart");
        }, getStatus: function getStatus() {
          return u;
        }, getResponse: function getResponse(e) {
          if ("json" === e && "string" === t.typeOf(c) && window.JSON) try {
            return JSON.parse(c.replace(/^\s*<pre[^>]*>/, "").replace(/<\/pre>\s*$/, ""));
          } catch (n) {
            return null;
          }return c;
        }, abort: function abort() {
          var t = this;l && l.contentWindow && (l.contentWindow.stop ? l.contentWindow.stop() : l.contentWindow.document.execCommand ? l.contentWindow.document.execCommand("Stop") : l.src = "about:blank"), e.call(this, function () {
            t.dispatchEvent("abort");
          });
        } });
    }return e.XMLHttpRequest = u;
  }), i(ft, [ut, X], function (e, t) {
    return e.Image = t;
  }), a([u, c, l, d, f, h, p, m, g, v, y, w, E, _, x, b, R, T, A, S, O, I, L]);
}(this);
(function (a) {
  return a;
})();

(function (e) {
  "use strict";
  var t = {},
      n = e.moxie.core.utils.Basic.inArray;return function r(e) {
    var i, s;for (i in e) {
      s = _typeof(e[i]), s === "object" && !~n(i, ["Exceptions", "Env", "Mime"]) ? r(e[i]) : s === "function" && (t[i] = e[i]);
    }
  }(e.moxie), t.Env = e.moxie.core.utils.Env, t.Mime = e.moxie.core.utils.Mime, t.Exceptions = e.moxie.core.Exceptions, e.mOxie = t, e.o || (e.o = t), t;
})(this);
/**
 * Plupload - multi-runtime File Uploader
 * v2.1.2
 *
 * Copyright 2013, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Date: 2014-05-14
 */

(function (a) {
  return a;
})();

(function (e, t, n) {
  function s(e) {
    function r(e, t, r) {
      var i = { chunks: "slice_blob", jpgresize: "send_binary_string", pngresize: "send_binary_string", progress: "report_upload_progress", multi_selection: "select_multiple", dragdrop: "drag_and_drop", drop_element: "drag_and_drop", headers: "send_custom_headers", urlstream_upload: "send_binary_string", canSendBinary: "send_binary", triggerDialog: "summon_file_dialog" };i[e] ? n[i[e]] = t : r || (n[e] = t);
    }var t = e.required_features,
        n = {};if (typeof t == "string") o.each(t.split(/\s*,\s*/), function (e) {
      r(e, !0);
    });else if ((typeof t === "undefined" ? "undefined" : _typeof(t)) == "object") o.each(t, function (e, t) {
      r(t, e);
    });else if (t === !0) {
      e.chunk_size > 0 && (n.slice_blob = !0);if (e.resize.enabled || !e.multipart) n.send_binary_string = !0;o.each(e, function (e, t) {
        r(t, !!e, !0);
      });
    }return n;
  }var r = e.setTimeout,
      i = {},
      o = { VERSION: "2.1.2", STOPPED: 1, STARTED: 2, QUEUED: 1, UPLOADING: 2, FAILED: 4, DONE: 5, GENERIC_ERROR: -100, HTTP_ERROR: -200, IO_ERROR: -300, SECURITY_ERROR: -400, INIT_ERROR: -500, FILE_SIZE_ERROR: -600, FILE_EXTENSION_ERROR: -601, FILE_DUPLICATE_ERROR: -602, IMAGE_FORMAT_ERROR: -700, MEMORY_ERROR: -701, IMAGE_DIMENSIONS_ERROR: -702, mimeTypes: t.mimes, ua: t.ua, typeOf: t.typeOf, extend: t.extend, guid: t.guid, get: function get(n) {
      var r = [],
          i;t.typeOf(n) !== "array" && (n = [n]);var s = n.length;while (s--) {
        i = t.get(n[s]), i && r.push(i);
      }return r.length ? r : null;
    }, each: t.each, getPos: t.getPos, getSize: t.getSize, xmlEncode: function xmlEncode(e) {
      var t = { "<": "lt", ">": "gt", "&": "amp", '"': "quot", "'": "#39" },
          n = /[<>&\"\']/g;return e ? ("" + e).replace(n, function (e) {
        return t[e] ? "&" + t[e] + ";" : e;
      }) : e;
    }, toArray: t.toArray, inArray: t.inArray, addI18n: t.addI18n, translate: t.translate, isEmptyObj: t.isEmptyObj, hasClass: t.hasClass, addClass: t.addClass, removeClass: t.removeClass, getStyle: t.getStyle, addEvent: t.addEvent, removeEvent: t.removeEvent, removeAllEvents: t.removeAllEvents, cleanName: function cleanName(e) {
      var t, n;n = [/[\300-\306]/g, "A", /[\340-\346]/g, "a", /\307/g, "C", /\347/g, "c", /[\310-\313]/g, "E", /[\350-\353]/g, "e", /[\314-\317]/g, "I", /[\354-\357]/g, "i", /\321/g, "N", /\361/g, "n", /[\322-\330]/g, "O", /[\362-\370]/g, "o", /[\331-\334]/g, "U", /[\371-\374]/g, "u"];for (t = 0; t < n.length; t += 2) {
        e = e.replace(n[t], n[t + 1]);
      }return e = e.replace(/\s+/g, "_"), e = e.replace(/[^a-z0-9_\-\.]+/gi, ""), e;
    }, buildUrl: function buildUrl(e, t) {
      var n = "";return o.each(t, function (e, t) {
        n += (n ? "&" : "") + encodeURIComponent(t) + "=" + encodeURIComponent(e);
      }), n && (e += (e.indexOf("?") > 0 ? "&" : "?") + n), e;
    }, formatSize: function formatSize(e) {
      function t(e, t) {
        return Math.round(e * Math.pow(10, t)) / Math.pow(10, t);
      }if (e === n || /\D/.test(e)) return o.translate("N/A");var r = Math.pow(1024, 4);return e > r ? t(e / r, 1) + " " + o.translate("tb") : e > (r /= 1024) ? t(e / r, 1) + " " + o.translate("gb") : e > (r /= 1024) ? t(e / r, 1) + " " + o.translate("mb") : e > 1024 ? Math.round(e / 1024) + " " + o.translate("kb") : e + " " + o.translate("b");
    }, parseSize: t.parseSizeStr, predictRuntime: function predictRuntime(e, n) {
      var r, i;return r = new o.Uploader(e), i = t.Runtime.thatCan(r.getOption().required_features, n || e.runtimes), r.destroy(), i;
    }, addFileFilter: function addFileFilter(e, t) {
      i[e] = t;
    } };o.addFileFilter("mime_types", function (e, t, n) {
    e.length && !e.regexp.test(t.name) ? (this.trigger("Error", { code: o.FILE_EXTENSION_ERROR, message: o.translate("File extension error."), file: t }), n(!1)) : n(!0);
  }), o.addFileFilter("max_file_size", function (e, t, n) {
    var r;e = o.parseSize(e), t.size !== r && e && t.size > e ? (this.trigger("Error", { code: o.FILE_SIZE_ERROR, message: o.translate("File size error."), file: t }), n(!1)) : n(!0);
  }), o.addFileFilter("prevent_duplicates", function (e, t, n) {
    if (e) {
      var r = this.files.length;while (r--) {
        if (t.name === this.files[r].name && t.size === this.files[r].size) {
          this.trigger("Error", { code: o.FILE_DUPLICATE_ERROR, message: o.translate("Duplicate file error."), file: t }), n(!1);return;
        }
      }
    }n(!0);
  }), o.Uploader = function (e) {
    function g() {
      var e,
          t = 0,
          n;if (this.state == o.STARTED) {
        for (n = 0; n < f.length; n++) {
          !e && f[n].status == o.QUEUED ? (e = f[n], this.trigger("BeforeUpload", e) && (e.status = o.UPLOADING, this.trigger("UploadFile", e))) : t++;
        }t == f.length && (this.state !== o.STOPPED && (this.state = o.STOPPED, this.trigger("StateChanged")), this.trigger("UploadComplete", f));
      }
    }function y(e) {
      e.percent = e.size > 0 ? Math.ceil(e.loaded / e.size * 100) : 100, b();
    }function b() {
      var e, t;d.reset();for (e = 0; e < f.length; e++) {
        t = f[e], t.size !== n ? (d.size += t.origSize, d.loaded += t.loaded * t.origSize / t.size) : d.size = n, t.status == o.DONE ? d.uploaded++ : t.status == o.FAILED ? d.failed++ : d.queued++;
      }d.size === n ? d.percent = f.length > 0 ? Math.ceil(d.uploaded / f.length * 100) : 0 : (d.bytesPerSec = Math.ceil(d.loaded / ((+new Date() - p || 1) / 1e3)), d.percent = d.size > 0 ? Math.ceil(d.loaded / d.size * 100) : 0);
    }function w() {
      var e = c[0] || h[0];return e ? e.getRuntime().uid : !1;
    }function E(e, n) {
      if (e.ruid) {
        var r = t.Runtime.getInfo(e.ruid);if (r) return r.can(n);
      }return !1;
    }function S() {
      this.bind("FilesAdded FilesRemoved", function (e) {
        e.trigger("QueueChanged"), e.refresh();
      }), this.bind("CancelUpload", O), this.bind("BeforeUpload", C), this.bind("UploadFile", k), this.bind("UploadProgress", L), this.bind("StateChanged", A), this.bind("QueueChanged", b), this.bind("Error", _), this.bind("FileUploaded", M), this.bind("Destroy", D);
    }function x(e, n) {
      var r = this,
          i = 0,
          s = [],
          u = { runtime_order: e.runtimes, required_caps: e.required_features, preferred_caps: l, swf_url: e.flash_swf_url, xap_url: e.silverlight_xap_url };o.each(e.runtimes.split(/\s*,\s*/), function (t) {
        e[t] && (u[t] = e[t]);
      }), e.browse_button && o.each(e.browse_button, function (n) {
        s.push(function (s) {
          var a = new t.FileInput(o.extend({}, u, { accept: e.filters.mime_types, name: e.file_data_name, multiple: e.multi_selection, container: e.container, browse_button: n }));a.onready = function () {
            var e = t.Runtime.getInfo(this.ruid);t.extend(r.features, { chunks: e.can("slice_blob"), multipart: e.can("send_multipart"), multi_selection: e.can("select_multiple") }), i++, c.push(this), s();
          }, a.onchange = function () {
            r.addFile(this.files);
          }, a.bind("mouseenter mouseleave mousedown mouseup", function (r) {
            v || (e.browse_button_hover && ("mouseenter" === r.type ? t.addClass(n, e.browse_button_hover) : "mouseleave" === r.type && t.removeClass(n, e.browse_button_hover)), e.browse_button_active && ("mousedown" === r.type ? t.addClass(n, e.browse_button_active) : "mouseup" === r.type && t.removeClass(n, e.browse_button_active)));
          }), a.bind("mousedown", function () {
            r.trigger("Browse");
          }), a.bind("error runtimeerror", function () {
            a = null, s();
          }), a.init();
        });
      }), e.drop_element && o.each(e.drop_element, function (e) {
        s.push(function (n) {
          var s = new t.FileDrop(o.extend({}, u, { drop_zone: e }));s.onready = function () {
            var e = t.Runtime.getInfo(this.ruid);r.features.dragdrop = e.can("drag_and_drop"), i++, h.push(this), n();
          }, s.ondrop = function () {
            r.addFile(this.files);
          }, s.bind("error runtimeerror", function () {
            s = null, n();
          }), s.init();
        });
      }), t.inSeries(s, function () {
        typeof n == "function" && n(i);
      });
    }function T(e, r, i) {
      var s = new t.Image();try {
        s.onload = function () {
          if (r.width > this.width && r.height > this.height && r.quality === n && r.preserve_headers && !r.crop) return this.destroy(), i(e);s.downsize(r.width, r.height, r.crop, r.preserve_headers);
        }, s.onresize = function () {
          i(this.getAsBlob(e.type, r.quality)), this.destroy();
        }, s.onerror = function () {
          i(e);
        }, s.load(e);
      } catch (o) {
        i(e);
      }
    }function N(e, n, r) {
      function f(e, t, n) {
        var r = a[e];switch (e) {case "max_file_size":
            e === "max_file_size" && (a.max_file_size = a.filters.max_file_size = t);break;case "chunk_size":
            if (t = o.parseSize(t)) a[e] = t, a.send_file_name = !0;break;case "multipart":
            a[e] = t, t || (a.send_file_name = !0);break;case "unique_names":
            a[e] = t, t && (a.send_file_name = !0);break;case "filters":
            o.typeOf(t) === "array" && (t = { mime_types: t }), n ? o.extend(a.filters, t) : a.filters = t, t.mime_types && (a.filters.mime_types.regexp = function (e) {
              var t = [];return o.each(e, function (e) {
                o.each(e.extensions.split(/,/), function (e) {
                  /^\s*\*\s*$/.test(e) ? t.push("\\.*") : t.push("\\." + e.replace(new RegExp("[" + "/^$.*+?|()[]{}\\".replace(/./g, "\\$&") + "]", "g"), "\\$&"));
                });
              }), new RegExp("(" + t.join("|") + ")$", "i");
            }(a.filters.mime_types));break;case "resize":
            n ? o.extend(a.resize, t, { enabled: !0 }) : a.resize = t;break;case "prevent_duplicates":
            a.prevent_duplicates = a.filters.prevent_duplicates = !!t;break;case "browse_button":case "drop_element":
            t = o.get(t);case "container":case "runtimes":case "multi_selection":case "flash_swf_url":case "silverlight_xap_url":
            a[e] = t, n || (u = !0);break;default:
            a[e] = t;}n || i.trigger("OptionChanged", e, t, r);
      }var i = this,
          u = !1;(typeof e === "undefined" ? "undefined" : _typeof(e)) == "object" ? o.each(e, function (e, t) {
        f(t, e, r);
      }) : f(e, n, r), r ? (a.required_features = s(o.extend({}, a)), l = s(o.extend({}, a, { required_features: !0 }))) : u && (i.trigger("Destroy"), x.call(i, a, function (e) {
        e ? (i.runtime = t.Runtime.getInfo(w()).type, i.trigger("Init", { runtime: i.runtime }), i.trigger("PostInit")) : i.trigger("Error", { code: o.INIT_ERROR, message: o.translate("Init error.") });
      }));
    }function C(e, t) {
      if (e.settings.unique_names) {
        var n = t.name.match(/\.([^.]+)$/),
            r = "part";n && (r = n[1]), t.target_name = t.id + "." + r;
      }
    }function k(e, n) {
      function h() {
        u-- > 0 ? r(p, 1e3) : (n.loaded = f, e.trigger("Error", { code: o.HTTP_ERROR, message: o.translate("HTTP Error."), file: n, response: m.responseText, status: m.status, responseHeaders: m.getAllResponseHeaders() }));
      }function p() {
        var d,
            v,
            g = {},
            y;if (n.status !== o.UPLOADING || e.state === o.STOPPED) return;e.settings.send_file_name && (g.name = n.target_name || n.name), s && a.chunks && c.size > s ? (y = Math.min(s, c.size - f), d = c.slice(f, f + y)) : (y = c.size, d = c), s && a.chunks && (e.settings.send_chunk_number ? (g.chunk = Math.ceil(f / s), g.chunks = Math.ceil(c.size / s)) : (g.offset = f, g.total = c.size)), m = new t.XMLHttpRequest(), m.upload && (m.upload.onprogress = function (t) {
          n.loaded = Math.min(n.size, f + t.loaded), e.trigger("UploadProgress", n);
        }), m.onload = function () {
          if (m.status >= 400) {
            h();return;
          }u = e.settings.max_retries, y < c.size ? (d.destroy(), f += y, n.loaded = Math.min(f, c.size), e.trigger("ChunkUploaded", n, { offset: n.loaded, total: c.size, response: m.responseText, status: m.status, responseHeaders: m.getAllResponseHeaders() }), t.Env.browser === "Android Browser" && e.trigger("UploadProgress", n)) : n.loaded = n.size, d = v = null, !f || f >= c.size ? (n.size != n.origSize && (c.destroy(), c = null), e.trigger("UploadProgress", n), n.status = o.DONE, e.trigger("FileUploaded", n, { response: m.responseText, status: m.status, responseHeaders: m.getAllResponseHeaders() })) : r(p, 1);
        }, m.onerror = function () {
          h();
        }, m.onloadend = function () {
          this.destroy(), m = null;
        }, e.settings.multipart && a.multipart ? (m.open("post", i, !0), o.each(e.settings.headers, function (e, t) {
          m.setRequestHeader(t, e);
        }), v = new t.FormData(), o.each(o.extend(g, e.settings.multipart_params), function (e, t) {
          v.append(t, e);
        }), v.append(e.settings.file_data_name, d), m.send(v, { runtime_order: e.settings.runtimes, required_caps: e.settings.required_features, preferred_caps: l, swf_url: e.settings.flash_swf_url, xap_url: e.settings.silverlight_xap_url })) : (i = o.buildUrl(e.settings.url, o.extend(g, e.settings.multipart_params)), m.open("post", i, !0), m.setRequestHeader("Content-Type", "application/octet-stream"), o.each(e.settings.headers, function (e, t) {
          m.setRequestHeader(t, e);
        }), m.send(d, { runtime_order: e.settings.runtimes, required_caps: e.settings.required_features, preferred_caps: l, swf_url: e.settings.flash_swf_url, xap_url: e.settings.silverlight_xap_url }));
      }var i = e.settings.url,
          s = e.settings.chunk_size,
          u = e.settings.max_retries,
          a = e.features,
          f = 0,
          c;n.loaded && (f = n.loaded = s ? s * Math.floor(n.loaded / s) : 0), c = n.getSource(), e.settings.resize.enabled && E(c, "send_binary_string") && !!~t.inArray(c.type, ["image/jpeg", "image/png"]) ? T.call(this, c, e.settings.resize, function (e) {
        c = e, n.size = e.size, p();
      }) : p();
    }function L(e, t) {
      y(t);
    }function A(e) {
      if (e.state == o.STARTED) p = +new Date();else if (e.state == o.STOPPED) for (var t = e.files.length - 1; t >= 0; t--) {
        e.files[t].status == o.UPLOADING && (e.files[t].status = o.QUEUED, b());
      }
    }function O() {
      m && m.abort();
    }function M(e) {
      b(), r(function () {
        g.call(e);
      }, 1);
    }function _(e, t) {
      t.code === o.INIT_ERROR ? e.destroy() : t.file && (t.file.status = o.FAILED, y(t.file), e.state == o.STARTED && (e.trigger("CancelUpload"), r(function () {
        g.call(e);
      }, 1)));
    }function D(e) {
      e.stop(), o.each(f, function (e) {
        e.destroy();
      }), f = [], c.length && (o.each(c, function (e) {
        e.destroy();
      }), c = []), h.length && (o.each(h, function (e) {
        e.destroy();
      }), h = []), l = {}, v = !1, p = m = null, d.reset();
    }var u = o.guid(),
        a,
        f = [],
        l = {},
        c = [],
        h = [],
        p,
        d,
        v = !1,
        m;a = { runtimes: t.Runtime.order, max_retries: 0, chunk_size: 0, multipart: !0, multi_selection: !0, file_data_name: "file", flash_swf_url: "js/Moxie.swf", silverlight_xap_url: "js/Moxie.xap", filters: { mime_types: [], prevent_duplicates: !1, max_file_size: 0 }, resize: { enabled: !1, preserve_headers: !0, crop: !1 }, send_file_name: !0, send_chunk_number: !0 }, N.call(this, e, null, !0), d = new o.QueueProgress(), o.extend(this, { id: u, uid: u, state: o.STOPPED, features: {}, runtime: null, files: f, settings: a, total: d, init: function init() {
        var e = this;typeof a.preinit == "function" ? a.preinit(e) : o.each(a.preinit, function (t, n) {
          e.bind(n, t);
        }), S.call(this);if (!a.browse_button || !a.url) {
          this.trigger("Error", { code: o.INIT_ERROR, message: o.translate("Init error.") });return;
        }x.call(this, a, function (n) {
          typeof a.init == "function" ? a.init(e) : o.each(a.init, function (t, n) {
            e.bind(n, t);
          }), n ? (e.runtime = t.Runtime.getInfo(w()).type, e.trigger("Init", { runtime: e.runtime }), e.trigger("PostInit")) : e.trigger("Error", { code: o.INIT_ERROR, message: o.translate("Init error.") });
        });
      }, setOption: function setOption(e, t) {
        N.call(this, e, t, !this.runtime);
      }, getOption: function getOption(e) {
        return e ? a[e] : a;
      }, refresh: function refresh() {
        c.length && o.each(c, function (e) {
          e.trigger("Refresh");
        }), this.trigger("Refresh");
      }, start: function start() {
        this.state != o.STARTED && (this.state = o.STARTED, this.trigger("StateChanged"), g.call(this));
      }, stop: function stop() {
        this.state != o.STOPPED && (this.state = o.STOPPED, this.trigger("StateChanged"), this.trigger("CancelUpload"));
      }, disableBrowse: function disableBrowse() {
        v = arguments[0] !== n ? arguments[0] : !0, c.length && o.each(c, function (e) {
          e.disable(v);
        }), this.trigger("DisableBrowse", v);
      }, getFile: function getFile(e) {
        var t;for (t = f.length - 1; t >= 0; t--) {
          if (f[t].id === e) return f[t];
        }
      }, addFile: function addFile(e, n) {
        function c(e, n) {
          var r = [];t.each(s.settings.filters, function (t, n) {
            i[n] && r.push(function (r) {
              i[n].call(s, t, e, function (e) {
                r(!e);
              });
            });
          }), t.inSeries(r, n);
        }function h(e) {
          var i = t.typeOf(e);if (e instanceof t.File) {
            if (!e.ruid && !e.isDetached()) {
              if (!l) return !1;e.ruid = l, e.connectRuntime(l);
            }h(new o.File(e));
          } else e instanceof t.Blob ? (h(e.getSource()), e.destroy()) : e instanceof o.File ? (n && (e.name = n), u.push(function (t) {
            c(e, function (n) {
              n || (f.push(e), a.push(e), s.trigger("FileFiltered", e)), r(t, 1);
            });
          })) : t.inArray(i, ["file", "blob"]) !== -1 ? h(new t.File(null, e)) : i === "node" && t.typeOf(e.files) === "filelist" ? t.each(e.files, h) : i === "array" && (n = null, t.each(e, h));
        }var s = this,
            u = [],
            a = [],
            l;l = w(), h(e), u.length && t.inSeries(u, function () {
          a.length && s.trigger("FilesAdded", a);
        });
      }, removeFile: function removeFile(e) {
        var t = typeof e == "string" ? e : e.id;for (var n = f.length - 1; n >= 0; n--) {
          if (f[n].id === t) return this.splice(n, 1)[0];
        }
      }, splice: function splice(e, t) {
        var r = f.splice(e === n ? 0 : e, t === n ? f.length : t),
            i = !1;return this.state == o.STARTED && (o.each(r, function (e) {
          if (e.status === o.UPLOADING) return i = !0, !1;
        }), i && this.stop()), this.trigger("FilesRemoved", r), o.each(r, function (e) {
          e.destroy();
        }), i && this.start(), r;
      }, bind: function bind(e, t, n) {
        var r = this;o.Uploader.prototype.bind.call(this, e, function () {
          var e = [].slice.call(arguments);return e.splice(0, 1, r), t.apply(this, e);
        }, 0, n);
      }, destroy: function destroy() {
        this.trigger("Destroy"), a = d = null, this.unbindAll();
      } });
  }, o.Uploader.prototype = t.EventTarget.instance, o.File = function () {
    function n(n) {
      o.extend(this, { id: o.guid(), name: n.name || n.fileName, type: n.type || "", size: n.size || n.fileSize, origSize: n.size || n.fileSize, loaded: 0, percent: 0, status: o.QUEUED, lastModifiedDate: n.lastModifiedDate || new Date().toLocaleString(), getNative: function getNative() {
          var e = this.getSource().getSource();return t.inArray(t.typeOf(e), ["blob", "file"]) !== -1 ? e : null;
        }, getSource: function getSource() {
          return e[this.id] ? e[this.id] : null;
        }, destroy: function destroy() {
          var t = this.getSource();t && (t.destroy(), delete e[this.id]);
        } }), e[this.id] = n;
    }var e = {};return n;
  }(), o.QueueProgress = function () {
    var e = this;e.size = 0, e.loaded = 0, e.uploaded = 0, e.failed = 0, e.queued = 0, e.percent = 0, e.bytesPerSec = 0, e.reset = function () {
      e.size = e.loaded = e.uploaded = e.failed = e.queued = e.percent = e.bytesPerSec = 0;
    };
  }, e.plupload = o;
})(window, mOxie);
/* <<< file end: js/lib/plupload/plupload-2.1.2.full.min.js */

//# map link was there [plupload-2.1.2.full.min.js.map]
/* >>> file start: js/discovery/settings.js */
/*global plupload*/
/* eslint-disable */
//= require js/core/angular/api.js

//= require js/core/angular/bubble.js
//= require js/core/angular/colorpicker.js
//= require js/lib/plupload/plupload-2.1.2.full.min.js
//= require js/color.js

Site.page.template['angular/color.ng.tmpl'] = '<div ng-controller=\"ColorCtrl\">\n  <div lj-colorpicker=\"oldColor\" lj-colorpicker-preview=\"color\" lj-colorpicker-submit=\"save()\"></div>\n</div>\n';
Site.page.template['angular/lentaPreviewStyle.ng.tmpl'] = '/* background_color, background_image_key, background_repeat, background_position */\n\n.p-lenta {\n    background-color: {background_color};\n    background-image: url({background_image});\n    background-repeat: {background_repeat};\n    background-position: {background_position};\n    }\n\n/* url_color, url_visited, url_hover settings */\n.js-link-color,\n.js-link-color:link,\n.js-link-color--a A:link,\n.js-link-color--username .i-ljuser A:link,\n.js-link-color--a-novisited A:link,\n.js-link-color--a-novisited A:visited,\n.b-translation-pseudo:link,\n.b-translation-pseudo:visited {\n    color: {url_color};\n    }\n\n.js-link-color .svgicon {\n    fill: {url_color};\n    }\n\n.js-sidebar-color--a A:link {\n    /* because we need to inherit hover color */\n    color: {sidebar_font_color};\n    }\n\n.js-link-color:visited,\n.js-link-color--a A:visited,\n.js-link-color--username .i-ljuser A:visited {\n    color: {url_visited_color};\n    }\n\n.js-sidebar-color--a-novisited A:link,\n.js-sidebar-color--a-novisited A:visited {\n    /* because we need to inherit hover color */\n    color: {sidebar_font_color};\n    }\n\n.js-link-color:hover,\n.js-link-color--a A:hover,\n.js-link-color--username .i-ljuser A:hover,\n.js-link-color--a-novisited A:hover,\n.js-link-color--a-novisited A:active,\n.b-translation-pseudo:hover {\n    color: {url_hover_color}\n    }\n\n.js-link-color:hover .svgicon {\n    fill: {url_hover_color}\n    }\n\n/* sidebar_font_color */\n.js-sidebar-color,\n.js-sidebar-color TH,\n.js-sidebar-color TD,\n.js-sidebar-color--before:before,\n.sbar-cal-month,\n.sbar-cal-year {\n    color: {sidebar_font_color};\n    }\n\n /* sidebar_background_color */\n.js-sidebar-bgcolor,\n.p-lenta .l-flatslide-container:after,\n.p-lenta .flatquestion-item-question-arr1:before,\n.p-lenta .flatquestion-item-question-arr2:before {\n    background-color: {sidebar_background_color};\n    }\n\n\n/* entry_background_color */\n.js-entry-bgcolor,\n.ljcut-link:after,\n.ljcut-pseudolink:after {\n    background-color: {entry_background_color};\n    }\n.js-entry-bgcolor--after-color:after {\n    color: {entry_background_color} !important;\n    }\n\n/* font_size, font_family, font_color */\n.js-font-family {\n    font-family: {font_family} !important;\n    }\n.js-font-color {\n    color: {font_color};\n    }\n.js-font-size {\n    font-size: {font_size}px !important;\n    }\n\n/* element_color (headers) */\n.js-elem-color,\n.js-elem-color--a A:link,\n.js-elem-color--a A:visited,\n.js-elem-color--a A:hover,\n.js-elem-color--a A:active,\n.b-lenta-sidebar-title {\n    color: {element_color};\n    }\n\n\n/* element_color (svg) */\n.js-elem-color--svgicon .svgicon,\n.b-selectus .label,\n.svgpreloader-background {\n    color: {element_color} !important;\n    fill: {element_color} !important;\n    }\n\n\n\n/* element_border_color */\n.js-elem-bordercolor,\n.js-elem-bordercolor--table TD,\n.js-elem-bordercolor--table TH,\n.ljcut-link:after,\n.ljcut-pseudolink:after,\n.ljcut-link:before,\n.ljcut-pseudolink:before,\n.b-sticky-cut-decor:before,\n.b-sticky-cut-decor:after,\n.b-sticky-cut-link-wrap:before,\n.b-feedwidgets-options,\n.b-feedwidgets-options .b-selectus {\n    border-color: {element_border_color} !important;\n    }\n.js-elem-bordercolor--before-color:before {\n    color: {element_border_color} !important;\n    }\n\n\n/* element_border_color for flatquestion */\n.flatquestionjournal-question,\n.flatquestion-item-question {\n    background-color: {element_border_color} !important;\n    }\n.flatquestionjournal-question:after,\n.flatquestion-item-question:after {\n    background-image: url(\'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20id%3D%222-Layer_1%22%20height%3D%2216%22%20viewBox%3D%220%200%2033.999%2015.999%22%20width%3D%2234%22%20version%3D%221.1%22%20y%3D%220px%22%20x%3D%220px%22%3E%3Cpath%20d%3D%22m12%200c-0.45-0.096%207.339%2014.482-12%2014.975v1.023h33.999v-1.027c-14.672-0.582-16.643-13.83-21.999-14.971z%22%20fill%3D%22rgb({element_border_color_rgb})%22%2F%3E%3C%2Fsvg%3E\') !important;\n    }\n\n/* element background color */\n.js-elem-bgcolor,\n.js-elem-bgcolor--before:before,\n.js-elem-bgcolor--after:after,\n.js-elem-bgcolor--pseudos:before,\n.js-elem-bgcolor--pseudos:after,\n.b-lenta-calendar TABLE TH,\n.b-feedwidgets-options .b-selectus {\n    background-color: {element_background_color} !important;\n    }\n\n/* preloader */\n.svgpreloader-background {\n    fill: {element_color};\n    }\n\n.svgpreloader-piece {\n    fill: {element_border_color};\n    }\n\n\n\n/* lj sticky cut gradient */\n.b-sticky-cut-decor {\n    background:\n        linear-gradient(\n            to bottom,\n            rgba({entry_background_color_rgb}, 1) 0%,\n            rgba({entry_background_color_rgb}, 0.92) 79%,\n            rgba({entry_background_color_rgb}, 0) 100%)\n            repeat 0 0;\n    }\n    .b-sticky-cut-link-wrap:before {\n        background: rgb({entry_background_color_rgb});\n        }\n';
Site.page.template['angular/backgroundUploader.ng.tmpl'] = '<div\n  class=\"b-feedsettings-bg-options b-feedsettings-bubble\"\n  ng-controller=\"ImageUploaderCtrl\"\n  id=\"upload-container\"\n  ng-class=\"{\'b-feedsettings-upload-state-loading\': inprogress, \'b-feedsettings-upload-state-user\': settings.background_image}\">\n    <div class=\"b-feedsettings-bg-options-head\">\n        <div\n          class=\"b-feedsettings-upload b-feedsettings-upload-default\"\n          ng-click=\"clickOnUpload()\">\n        </div>\n        <a href=\"javascript: void(0);\" class=\"b-feedsettings-delete-icon\" title=\"delete\" ng-click=\"clickOnRestore()\"></a>\n        <span class=\"b-feedsettings-spinner\"></span>\n    </div>\n    <div class=\"b-feedsettings-bg-options-body\">\n        <ul class=\"nostyle\">\n            <li class=\"b-feedsettings-bg-options-item\">\n                <span class=\"b-feedsettings-label\">Position</span>\n                <div class=\"b-feedsettings-bg-options-row\">\n                    <select class=\"b-selectus\" ng-model=\"settings.background_position\">\n                        <option value=\"\">None</option>\n                        <option value=\"left\">Left</option>\n                        <option value=\"right\">Right</option>\n                    </select>\n                </div>\n            </li>\n            <li class=\"b-feedsettings-bg-options-item\">\n                <span class=\"b-feedsettings-label\">Repeat</span>\n                <div class=\"b-feedsettings-bg-options-row\"><!--\n                --><input type=\"checkbox\" ng-model=\"settings.background_repeat_x\" ng-checked=\"settings.background_repeat_x\">\n                    <span class=\"b-feedsettings-checkbox-text\">horizontal</span>\n                </div>\n                <div class=\"b-feedsettings-bg-options-row\"><!--\n                --><input type=\"checkbox\" ng-model=\"settings.background_repeat_y\" ng-checked=\"settings.background_repeat_y\">\n                    <span class=\"b-feedsettings-checkbox-text\">vertical</span>\n                </div>\n\n            </li>\n        </ul>\n    </div>\n    <input name=\"data\" type=\"file\" id=\"pickfiles\">\n</div>\n';

LJ.injectStyle('/* >>> file start: stc/widgets/colorpicker.css */\n/* Colorpicker */\n.b-colorpicker {\n	max-width: 410px;\n	min-width: 280px;\n	margin: 0;\n	padding: 5px 0;\n	}\n.b-colorpicker:after {\n	content: \"\";\n	display: table;\n	border-collapse: collapse;\n	clear: both;\n	}\n.b-colorpicker-wrap {\n		overflow: hidden;\n		}\n.b-color-selector {\n	position: relative;\n	float: left;\n	overflow: hidden;\n	width: 256px;\n	height: 256px;\n	margin: 0 15px 0 0;\n	border: 1px solid #000;\n	background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAQAAAD2e2DtAAAhPklEQVR4XuyZ3Y4cSRGFo6R9cR4KiTueAh4BLlawAq/X9kxXHUbZrjrK+RQRnY0ZCcG2uvMvyl7pO3EisrxJ8T/8+f/4k+K/5b//0P/p9rH/J3riXMlKGOevOR/ju8cRt7jFt/gan+Ln+FP8Lj5IAFoA8MGi0Y9BrWehbuuYDdsz/xr6+P3+2eMWe7zGS3yLL/Fr/BJ/iT9H/EgB6Dms+igPUCrAdfRaQ82156qBy/MNOX4h92jwuoMf331k/h3/1/gcn+Jv8df4+d8TgCrU+jCb31afVcNMa9g3tZbNeQ+cuS4x2zX+fn8MXhd8438d+L/E5/hH/D1+iU+rArAWPwT11iLg1nql3Up8fR7rIQPfnoFeZLxnOi70sQ0B2PYn/Gf+/xa/xj/j09vvFwigBf88dC33ANIPMPberoXdvlqvZ7hS6BuxEzrN3hnv8dAdfGwT/sv+7/X/t/g8Pl/iBQLo0GsZeo9bmK5nLs+Fk07UfcU2RIKHPJKRsAXkWwWfn+P8+qN9yGCP25z/QwBvEhi/3+LWC0A1+vV2UOuFQIUWtCgUxksETrB9rjPHLTBht8x4Tfg3o0ePD/y2/iNu2uMWsU0FYPQAb7/DDyyACj8CFvNTa5fCzha0JBTx+eY5rMQT9VXdK9H0gb0yfI0xafcAH63fTbG5APjzEq+xQwDMPS2i35axb8TVPstqDFAQ8rqxb2XXLhH91rd2sulbDpAAR4VkIRx59rP66zViex3QB/oB/zVucZQC2BaaMIDvsg4e3MoKxNqiIzyUSRYSMGJEe4/G7ieUNHhcSbB7wp/GQ3PPT/xH3CyAu/0rtpeB3vh3CGANv61wHXxfvzduqYwkaQoDoPFntwYvZn2R8xKtn4bvmWQh9E2fdHX8iv3d1e97AzhQv5wSGOgH/nEqCID4e/haaARVF4PO0BlHgBRGjxqw/UNJAPIcld3mw7ned/o6o5Rd+Gz+OkVg+z/iZgFcn2+K7YQ/8h8OAHTPwdca+A1sOlNX2hn0tZ2Gr9zmp1Fd3hvyLAd8z7gzhqbPqs/G7/y9RLBPDuAL4PgdY1w7QyZ2gLX8Vw+fhYHhGygBBCkxgsktuoWjGLO17d2W9PZ93mu2f5r/nO2p8X83e+a/P/slAuPfB+wr64cHDPgQAPA/Db9Hv4EpnCXv9lQ0kEpFoeqFjVqr1/tz4JbB+zzL+OTtHrId9q/jvAMkl79TBM5/fyyBE3/qACrxN/B7I1dzUVNl70TK7kGQBPK7Ai68qGXNZ+Y7QsoKgEFX1q/mzi9djZ/huwPYB+I7fo+3awzjhwAAfwk/4VfoCU/Zc+pPVVm/REEQOOu/actnzHxKwafn3FLoO37KwPjP2u/GD/f/UwK3SQTuCyLoACwAPf4ePgqCgN4A8FRn8X6SJ/6Bv7TIVTR6EsVg2D7hFU/FPV+ZDA7LII68+zd+vwGkBC7oXxWb858CCK3hL+E3hq68gyhMXklNL8ydPXyLHJW9zn35VMKJYQfavSiM37U/trz7dwl4Gwdsu4Dhu/WLOLISoNb8+33l8A1FdQcg1P68e+cTBpjLQdgvDJ/AmfvO7ibvI+QuIJHBweqvcx8NoN5dACcXMPZzvAtAcAAWgH5/y7K4qNliIQBgSKUqAEI/UMvBsCKDjisc//lWlILSlzyCDKZ91n/b/lT7LYL5o33sG7Ul4J17rIuA2iaQ+PvcJ3wYe14IBPTMYNp8k+1Cta+gs5Iz+9nvE7hjp13e9mMyf1b/+R993P6hATRsZztc4Lhu/7qPpQCIn7vEr9QPCB+xgGxAWWYTcF7XxesdoTPP8+xXIgQUAAtBk/n7RMZtGXjX37vp8wq4yy5gGdw0y0UuAhF2AMBfFoUMeh1+5hFbYfUq9owzq/feLfcskD77vedIZj6zntZv23fOG39xA3C+n8IYsHfHnXvoAYB1bU9Z7qsxd4NSEccSwL0ys8dsBTtbvjT7afes+e7/vYPOHy99nfeSX/1c49jbIYHDO5MHWEAa7wP16C1AT+DnLcA7sPcc8wxVaXZ7j2JgxacUXOu9w0xPoIfxGnAqA+8x7w3d1j/Xfvb/zuw7cMvCn5jXFiocoIbNHUI0MOa+MVTwhRjYvbgzltWOZl8gdkfxpY738h3vTTtEHkYOEdj6dVV62frPYjD1/xCB5p0jXu0B58dsGgHwBY4EQaRuwNxnF8AcB+ipfj+44zUbPcSw2jP/mf3eYS+QyCB98eOsxwugtgEE8B2NX3h+9f8uASu4Yw0/20DDpxMYEqw8sfvK2LFOpUAhJPnvCLZ7kzCSa59GRGX/dgK0gJTAngA/DNwecJdaWwL6/F/ED7QEqbqpa0oA1wSdSAFCQP7Xpu+I/FVv6LHMr+u/W0BLYGc30HuASwBuAcZJ3P3aMIEOFT4vAzwnWjl+LefdGSg5V7J2PE2f2Odz+RzQi3d/XrP6+xqYIx+9v4GP9eQ9L4oNDlB3ADzP3UDB3J/zOM3zWhx5AehzXqkDVGuWATZ8c7uHVi8APVzh2QNMVz9X/7F2HgN5BHJ+ujYGGsD2RVCT73oUP/F2ZcDnhIsmb1onOQ9hVEIo8p/YUQRGLPoAOZrQvdZk/lJMIphKgSXgFT3BgoryFtAD5ylXxJ/nvnECfgvbAFEAgJrmTiEsgM9qP0Rg0D4t7J/mL9d/NIAzdBn5Ka7LE9z2vU5FwbwaB+iBM59L/OOYTyqBX5YAZj1XBG+YQF2AZ/5PZ17Nlh/E7hUy39Bd/w3d3QAl4NUVeZ5NV79oHQCr/lRpYUATJzgBI3lWuoJEDxDrvvElqEN0AKKm7UtF5RcLADOfHYBXB94CnqWA/T2zPu5zryyD3gEeznj1J7ITILLNdUCEyUMkpd1TCE0HYNSe+4IH03flT7Gz+599wJnPFlCh+doHD3DWuyhYAMZPAVQdQC6GJfzM7ybXa8AJ0hI2DB1+QBn4xHOu8ny3WNj/n6B9AvPXVf9l7F5d0H3C3l9+HeRi0DlAL4auFNDeUQYYxZPE9Mu2z3MfbFpxAJ7MJcErgzd2r+rcn+dG6/s/8t7XPkN3x+9+X4kHFA7Qi6Fp6Iif9o4nGFXVeLpA4gGe4wk4AGCj4lfV3yLgi59CBH4DKGP3TYBNoHHO0F0wDD2//6MHeLLlA/4O7AxZudUzhiWgcATOgZvo0eXj4uf5FQMRVNnP+YH5/Pp3zGzxzvXU7Gd3cNb3DsBmjnnOeY+/kIIYn5QKdvM2fZh5gjjB3exzTi/wPrPfTaNz3HNcAVVIYC4RyPUd+5zfxnxgGC+DLYD1nI9VKRA/faArAst57zm7gN4BxoxzegHnXe6zBzDeueb7FsBroGM0CBzIdc7Ds1gTAPP/YSkkFo/otghwl/M67z1Ddx9A7105mm0fr3yWCcAbNj3BHQDMH/VfIVu/r4DIe4jB3GoBEDTsGREVfvoAO35HsM5jFxELea9YQo+OH+AxL7LfKH3tY+6L9X+GOnmAJTBFXMY/EzTzRAB6UgqpExBuZuuo+pAH0SLDgVYE7pmxBdBn9d8zR1gE0qPg3QMw9wWTt/mzE3AZ8G6kzZ/nFICRUQylFDpRqPSBpBtIctx7xTnzvsz1Hr286xl2eS1sCgByv5bAPDsMGGIwdLSBSQko5z10ukbnA5RPVfW950ieUxDETAd4HH0kkFHxk2IwIUTuS1MkbgGGOXaNHeeescD3AjAWzCCLShQUAu2coOkCfIYGb+QlZs40RRo9qn42gycAN+RwlI7gqyD8AA2g4AGehfN+EoNaAXi2iPoxIbDaM454i73cA5oZBZGjjxBnMH7iRk4bN2eGzL3pGoiCYMMHbLzqe14AxpXO1n2glAmhcq/3AM78BBvBtOoDs0/TPUJ28+dZlufzaTZz5sMXLAHsNQLoa30njt4HWO2JOnlywQNK0PcdCqMvAvJpavyZIxzTrO0AkOfs+4NFYI7vHYAdgNbzn1Ed/iSqz/jGA2rQniWNoOXQWX8QM2e0eO/lhQDgmfmMogfcrn6A/xgE7K3t4zQXAsEaT+UHPCuavxSro5V4gc+MPM17RZr1AeC5D7AHsB+wEDjPK1HQA8xQIdPyRRACaApALwnmM6Wx5AfM78T4HYPoRBg58qzlm3cc5Rigr7sApRdD7vRu4Erv0VJIGkG1AljHHlEA7Y2eLpBnfIR6D0DmOyZHzg5AbAcBOkr00vFeDMx5n0EeKfh0x9HGr7oHYN732HmpWxeEGEMZFDtp9UcMWsG0DFAWbP3eg7Y8SuPHXaB2gQhKgf7QFYHd4qhvAZy12R4GyB08A/zGJjyDEwClK7Cfr+2f+c6RyGMCjFh0/FX2e/SL3SPJfez46xMXAdg/m8AFu4cQauyMMFRxBP7swkfjN2I809u/ijLgE3b7qPqIMKws+/MR4gD4/CQYQX4rDmAhEDexo4fPhfG4C6SVHNATtBGpLDCy8yfyADaWCRo/uwGa+9HYf+cBjoBTe90KgDsLuGvsz8ugKgX5mm0i7T9p/9gBUAwe/YRBdrcC0Sci6QSq3I/YMw/wiHJAAfROUMvEkNqxl4EUfc53a8iitH+gDrR4zH+O4RpPkWht7MuAR1wGee3DZ/vjiNUlFl2i0X30OeJ+3Og/33+vynMtrb2v+bwYHe/nub8+HvL68KhjOj84ynHHtd6v9S6P+zXu86jbGG96m43xJzGP23xnVD/y4seRbrCe833GR+ihMesE2vx/MrsDxu9MlmfI+Squ/9QCoBBo91lP3/UHPf4ab4YZT0EECyPNf6xp7Xhq3fCJ1gLphYMqDxkIdNcEkAIl2G7EqpKBMT+a+/SAXgzeB/Sk+SO8ea0DUYCJsar84XXS4CHK4Mn1MQEYhnca4HyWUWlRINAFq3dUUQi8ysYF85+j2ArKUY9m/yH+GbO924fc+we+52nRCFIARIs9FIBWDkled2bPbC9w8yIozadTVF77CT1y86dbeBdVHbHI8xM18hjCeJ/VmmSCcZYJBbBe+ZeA97t0gdYLaov3qWOBGzU/gV+bP3enZyCBIvunWOO0XIwexSHmXVT83Ae2P/B6FyGO46yNkTx6VezygudfrPyb7jJmjD7DyiMufmOBGO96bx7n1YGzw2fX6NX1iwugr3/+ncddvhqevx73MZ7XwL26BjJv+xg+wbre27xX8ILEA5j77Aa4Yu2fL4Bd5Q+YfpLpnQuwPDAGRh8Rzn1nKDjZNTJ6tQD6AtCB71cd4koMXi1g98oovUcpEHMA05oEDuJFM2h0vOh5VRUBs6NI/Nl+/y/mzrJXkyOHwm9J89fCzMy0zAyKggzLzKvg8io/L1OdaNKS1TryfQx1R4mUni7b3V+e42P3vdIMjIA9J6YsFVJ5rKeTjgS195T1uxX2p4wIy8nJGwV80kFgp2lj4Xg6joM949m/DgEbBqeTjID9+tGl0/hQEJ6NFSZ+FDxUMH4WAWCXCotl4fcloLPfrnaybcBHv09/ZwtQAVzYIru/Wr5l1PidQWEnPybvENM3C9eYWr7Me8f4LSbf9Tog9CNwv9rerwNBB4Fa/sHc5WtgHt6hW7/OfWWol/F/7XLf+nUAcJ2d/K6WWM4RNKa9byerFleQOsuBG2DHa2xu6gV6tX7fDl2/n6TrD71/HAX7/b7/77HxP7B5HgA18BqLSWLDjJ1EBGz8lteMvQfh23U6EtCPQBXCYQ+QYWBXQb9/CuoWoLvA+C9jps53+99HrtKCTneuGtMO1z7XmOb78BU0S0Cv1ul2r3K4eMjYydDvVSqA/xBmXv3yyBG85R3IkIfeB+MHH1gogQlCCHmAot9xy9XQmwD+nRcATf4wcgXH8hCgGvNRW0aroj7g1ApcuU6QgPa9XWP2L6NAriqA8S8HMw0FAg+1RfAsBQWrcR0W4ANawz3vbAQgAVwFLeait4isgVMF8E9FFLL2VOdDpWXwCiIQsJ4sgve8AWSFMA/3LAH2gG1HaxHXA0wMJoB/BASQB5/ufIKqV6hH+PwVoJG1ElD06z2ABfDBagEw5s4VpADx1D30vNQrasVeGwA++k2Wvumsgd4gGO/DqlfcABg29zdLgUWAHgDwy14wJYJrII4BdAAVAwvgvTBoQF7uecHftv3a9GfwlREwQQIiBrmqDEQIav92hkEw3gUBoCM42UrPQ5c7sBE5uIEDH4dAfQs4s/sd+Jtj/LwLgADecfBErd/B2uz2qO3nFj/49pe62BAA8xfsPADYCew+uga6AnhbwfJI4L7mnufRwBuAisKr8N0AAfPs587HHUCx6xU/Br010ODLPuD8OljO8qtbi1rV4Re0lrPnnIrDr23tajm34ng+1o1LYCx6fO50rNDcJ0ep2HNy9XL2V8vYWXK7ierTlrMK+4Ww/WckPs1ZTKs0N/4OnQ0rIETDne/XOu/BXSDoBs7+b+d4zv8Q1K9/dwHkrwDZBpwhcJYP2N34GwuABSG1ddyGhqMiArF3f/LDGewfBoFgFnnI9PfhywagQ8CVwQ7dZKAC+KsIQM4AFSETdPoO0CiIwq9i8M42UJJA7BsAVsFc9ztbwH5nZxPAXwSaoJU8QE72v5OnM4PWKssz+JIXTMkLbHUCEQPB3++8swFXH1AB/BlQwhmsvwtdcRJomPwCWs448fnsi2GSE3jbgJ3D3R/zgfGnvAAYpZxdI6dK/xySQx88I6fMlLNmzlgF3e5nGdjM931g/LEGHLocMwzdFwpkRBg1IXBGz4pcEFs+D59loIKgQTD+QAIAeAXA/iLII4EzNAYYPNs/i8HwyRmcQOCL9St2iynsY0wcYfy+0PFVP8DtX4GC5QNku/NrICaS4K6H/hcZiBh8N7AzdD8NAhPA77jjtdephrFqNgwYh4E+QSg964eOB+T8JZCA73f/hluAYrfhMH5LAmC4/ZhlCbA+wWMAhACu0LybzlgowdfvAZMBdP8eUwH8RuAAusuHnodBcgxoHYM/Lel9jU/3TjYCFQTIQGFPXwC/hqme9gNG79Vm9oD0GAAH0FgafK3/Ab7s/qUtQL3ABPArARVHDH6g6LLoATOPgb4DsAu4uI8wsf/hW8Di/h1LQQXwy6AAUA61eo2nh4Gd3LhitvejGAA8zn4FzzJQ+P5PAzTubwJ6Gr/wMALejjiS6NH4Od6Hfkr3Pve/Qlb4clJHkBPbv53Gzz1UCDQOez16HRQYR+ga524HQcAaqHGCvzmdr8g3p/tFAD9DmAyUT75cIA7opZJPDegnRg3gWQa6GNIiqKfJJxPAT5MCSDpBRxJazdKgkzyHmOHEpg8yYPh2Ah8oCeAnDjbBDsgBbQ09ws55ATlAzgWo97XH0fwFLkrBkMIa6ArgLQcS9L1iYafw8xpR9AxbgfYdQPNs+E5+ggwUvuV2eF5ET9z9e2S8GQeYHwckFIgAevACVyIMvB/h/lfUELGT7wMaQQG8EYZbk4XzVEsMlkHQ7AcwJLrQuf9xAKgUwAesLiCA14twNcqANROJaJRBp+Y/oNXamRCG1k5/MfRXQol6GwAvhhcP0fEaCCAfZcHAxC9H7aTC8aOc2ZLRCVHZAfyoghd3QOu3qME3AbzqQOWelyzVt8SgeDgjEYEnURCGAgRxCHgBLlEYAAIe1sCjJFQAr5AAuOf5uawYWBCQkSzMf8iIOHgLYCkIcIWO4LXH0wJ42WAyau55hcrPQhZ3AsCI3c9Tn0FrFiZ92AN08uMKuDF8E8BLipg7miu49xkqGz2Yfqr7udcTFdOTAowCFzpuAP42AAJ4kQVgeHqVWKX3UAFLYK77eXjAD35QDnkP4GUQtgEWwAsgAN7tGbNlcrbPRk/YefM/lfqcq2dqHNQHAPxgmAXwPAggsx/0er8+AvhMyPkpup8kBz4r7DB4dxCwAJ5LYSyuhCmBQO9LjgFS9/emPsuCxwFDZ0+oiWA8u7XAh9Fm+70mg5Aw2nJg3Jxj+CkPqAvgmW05eEJZxh7t/Xrns0RmqBawlz1gvQguyL8wFT9nc/378cllbPa/nDGGuf79/nf4hP4F/w3uz/8ynv4s934mV+r+vkPMYs1c4gH9TeAC9DGcC7FGXDp3becvPJt/ac9brO8Bfc8YP75Mnb9i9ePzohUQ7leugH6/S9QqMxsBxMaPFgpgzSCoykBjgLqHvGj9kUWQY+tWwfHDBngnC4DrvV+QAQI8nQt2L8NnEIKDve4C4wdJAQBkhZ0AnVv9cp9+kkFJ5Lo85wO5j8HcCphzgfH9KHiGnerwviQUF0vBMn3Dj9t/zAdiXwTx6R8UwPcIvKm75QvsAwwZ4LIMShV6ZuzsA4ybhwGLISCA75Y7n8FXu5uzneWP4LKDzNLXAQiiMQQEbWIkjO8IWgCYk0U9w87AMkjvA1XDr2BP9z4KQTBLRrPj2zkBAMQV0LWWgWcnftYbKDobglCwjBxEkBHAt3LWb3lE1oeOMsCoQAbQa6OM3XeGWRSCb/qOAL4JAkj4QcEHMtD7MmDH6KPnVRAjSSHA+gcDYnzDACBUjrIcGLEPCYCzuft1LfwGBGogYuAQuTP9KaoCGF8vCYBrFEIKel8G+JSe1kdmWQzU+5ovCuBrKAAnn0TNruBHWAaRnqd+78HmEWA5jDh5xq5ugQL4qmHAXmeULA4++RHue5ZIXxDc54xenpUT975F3b5X5BIZX1EBEE6trp7WyiCdk8jyE/0E8CwRub2fGwdwGl8GpCAH6GwGnBMF2z/DOZ0j8PgIkDidAHtZAF8CAeR7vSKKvgwqmHtigBHQR694JY6SYAF80RUAxOFU7nO2eY6zJ8Ti7ad18jNsGAIwHOQO5DC+QKbehlzrekUHqAEPiGFtnNFDPQwBjoflMD5PAsghZ7GwDBQrg2RTZ9kxZh4DXAHoU07A5s8C+NxWA51xhMwo4BjE0Q86spgVqfTRc8dDzN4mAnhKkNV7O5rlGACF5+FZgNaPKbqEJJJy4IUQBPBkQQD9LMcYN0PmuvOHvhA9Zxm7CuCJggCayBEqZtZCZh9hmHiH6JvAywJ4XATQQZyz/YYTJGZ5vZ/71RMFlJNDUAoK3BfAYyKADmLL1mssVsygvBhyv2amhcHWz5h5IIgAHhUBpB3BzvAM4yt1PeNF+WXQMrbqIGCPmMFMQgCPgADCW0DQJ+JOUAN9SuHMi2kiZHxSMyip+FnuSAAPZwXAMFkWhfdxhkGe/5lnPOcniAS2gqwAHpLOW32uwS75Ab+lD7YElSErNPYHlgZLYTwYFwCaPGPKwWZ43Ot9h+CqiVU8QqJ+MHNSYAE8sCWB2zXc3aUoCoeFwkj5jbP8RsYrOYgyZPQCFcD9KAAGjhOegfJ7NAdy6WPrPKEYSp3P6AEyCuA+MmsGHn6ujZn7HSXIcPu5WZUG+wH0ezhnArg3JgCuYOAsF/AcrmBoLAcGzxhZIOwH3P9s+LwzjHsyMz6HulHt5KCugpLlO9tv1e5Ld36x33lQjLvrlt8XBj/TF0ILXx/8LPoBA4xFJjw57gIBsOH24wwPatpyWC+W2XIFiKeGAQjgThDASqQUXy8EfmqdQGaznrOF/sf4uCMhgG5lXwJc2RdFH3MfPMdXiWHcfi4CkMxnVgjh2j74ZvacBHDbVsfaR3kCBFUhrAfbQc5vXbsLpARwKwigau1VgVQksP45vlbBl3yh0f8ogFs2hbAeNPf6qQQ0i+zUxsvW3Acf7nwEzGIYN295qH3QjJjfsgalnFp4OT8b8qDOLwngpo3RsTdwppKv93QT1eJ31sHnYLNMND9uDAtAYxU0ObuvdO4qeN1q9hCozmc0xgK4AQUQ6veORNJv6AtiFXDuvQZ4fit7Agvg+q2PmQFzRb8OTk3sAABQV5+dadHAUJBnx3UggA7mUwgLA0lhbFWcGBPDZaxRgfSlwQK4dquh7GNmGXF9H0tPSCvxZ42/JAoVwDUggFauL4Huc5ddJjXgDJdRz1LluDolgPV4a29jka2HuRYjwG3lUgK4CgRAWPo1XdHA8wRhcc0simkWaxg1CODKDboccEANY+FarWlHWVqMYrlguDYtDo6OKy4J4ON2y2JJdiUGotZFZmZmZoYH//9J0l32akahPrJV0y1vxtGSMlXOExXjRRO5AwAmAC0MyqL6CmDz4AgC8P8KgEB8oaqPi+ML8BmyqqFZBVUfC/nPAcC5wp1QHa1AN4Wtvktj3bBrVXUA+NcBIHodR3BKRAEGlT/tx81h8f8t9KfkH/PC8Ot+X6gb/AVqBAo/OBBoyC0OwB8CAOjjc/W6mq0X7+MA/F6xNjgCAYXi+rwYaWpdfqUBkIcCmEyHJh8LHn8qAD/XA2CaeJAIovQoF9VWm2kiDsAPY596WnUgaBhOvkZ9hwINBS4OAN93AyAeBY8vVHHVyiuagJACP09NvoUAAL2rSgibel0QOtLVNXbQsK58tfUC8hHg0/yXfCwC4aAeDWyqYHf5EgQg0O1N8fnQjjagR36kYQA+7wRAaOEJRACUQGQjuiiGJe4inwwH4d8GQS2uYAGFWh/lCggX+WgghgA6ACcYXH0/i9+/0MktIR8cAGBo6I3r5geHAwNqvkq8X94biZHPcuXx37ROzwfgXRiA5MiGd+ERLRh/HIC3OwIQjy4VJTQzYZ8Zg0YzmjwjbxwAQAggEBDTcHWupDPOy2tjsUEEgMO2aCnQ8u8peeUA4JgEl8vFITHEYfdR5uwD8NJ8wVVkPB4A19Z0aKqL7tohLxwAQGQAB2cSeNb4gLiYpw/AcwgAfyd3TP0731ihEwTgmYGICnDYC9EvFz/Xl6dWEMqgfraAnw7mJ08CAIBIQJfjD1yWOIvWfjEfgMcWEZ8cW/qpE/Eo2VRnPnc+cvLIAvIQgfw4lt5dBz9jHEF56ADAEFii1t4EUHkAAHA6aRC8tvmbcgDuGzWdUOh5ve2ia7jIPQu0AwTmrnZV15qVux4AHAF/mYLpTdtU1/SSOxiAOAJd53VN0pPbRiTyIahXGH8nTVSUW8YWj90L3KU7NNVFbhpdLnAvpOraVupqsq7csFli8CEo/2X0jXSRHeW6BT4K6UpWnzfk+i5daFO5FgDA6+N3A3fgavWuuuC55KrNbbMMBhUo8JjrzyJXjIY47/xEnYrndfBN5bIBYdyLuwfYWIFC/ZeXS0bWY7/Xe7anXDRgXNCfq9SbygXjxwCVYpd2kfMOAHy9kad6dzlngdHiWm+aX5OzDgCbXe2qnHEB2OR61+W0+RKb29EdcsoCQoP19Ea8R04GAAB9g6r1GeSEOa3A3Out7+xN5bgBYdhdr97nlGMGDOBMvUu7yFEDZsVzfLI3lSNGbffyfM/LYQMycJ16pT6ZHDIqydesU+1N5aDVLV3v0i5ywKpjqvRvf9lfeLHVP72p7LNtDqABFOkAtvqRaasB6OcvFZhJCJnqx/4AAAAASUVORK5CYII=);\n	/*background-image: url(/img/colorpicker/color-selector.png?v=27298);*/\n	background-repeat: no-repeat;\n	background-size: contain;\n	}\n.b-color-selector-pick {\n	position: absolute;\n	top: 50px;\n	left: 50px;\n	margin: -6px 0 0 -6px;\n	width: 12px;\n	height: 12px;\n	background: url(/img/colorpicker/color-selector-pick.png?v=27530)\n	}\n.b-color-selector-bar {\n	position: relative;\n	float: left;\n	margin: 0 10px 0 0;\n	width: 20px;\n	height: 256px;\n	border: 1px solid #000;\n	background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAEACAYAAACzuVY0AAAA9klEQVR42u3XgQ3CMAxEUReSWmL/VUFKSikrIDgqJ/4M8JTT2Skph9W7CX/FbL2pQQMEBJwBrGrQKQWQwWb1iPyfyFwOGUDPN4fiyIcVLdjNAAEBAU8ANzXYKIWWA5yw54tMKRkiA2YA2eXfwddVDIofo0OArgYrpQAGGBunlAS77MwhczhjKUTmtqFl7sNB53DZxKB1wHigvOVGKYDMIZGJnHX1eviWWT02Zco55K9IuJYXe2pB8WMUEBAQEBAwMFjVoBM53glXIgMCAp6yy5ddDIofo4CAgB+CmxpsRI53wk5kIhOZyGOC8Uvhq8fl8FXkhxJ8AxUSiPbR9nUKAAAAAElFTkSuQmCC);\n	/*background-image: url(/img/colorpicker/color-selector-bar.png?v=27298);*/\n	background-size: contain;\n	}\n.b-color-selector-bar A {\n		position: absolute;\n		left: -6px;\n		margin: 0 0 -4px;\n		width: 32px;\n		height: 9px;\n		background: url(/img/colorpicker/color-selector-slider.gif?v=27298) no-repeat 50% 50%;\n		}\n.b-color-selector-bar A:link,\n		.b-color-selector-bar A:visited,\n		.b-color-selector-bar A:hover,\n		.b-color-selector-bar A:active,\n		.b-color-selector-bar A:focus {\n			border: none;\n			outline: none;\n			cursor: auto;\n			}\n.b-colorpicker-controls {\n	float: right;\n	margin: 0 .5em 0 0;\n	padding: 0;\n	}\n.b-colorpicker-controls-title {\n		margin: 0 auto;\n		width: 68px;\n		font-size: 11px;\n		}\n.b-colorpicker-controls-current,\n	.b-colorpicker-controls-new {\n		margin: 0 auto 15px;\n		padding: 0;\n		width: 68px;\n		height: 68px;\n		border: 1px solid #000;\n		}\n.b-colorpicker-controls-hex {\n		width: 100%;\n		}\n.b-colorpicker-controls-value {\n		margin: 0 auto;\n		padding: 0;\n		width: 68px;\n		}\n.b-colorpicker-controls-submit {\n		margin: 1em 0.5em 0;\n		padding: 0;\n		text-align: right;\n		}\n/* two submit buttons (old + new) [LJSUP-19090] */\n.b-colorpicker-controls-submit .b-ljbutton {\n			display: inline-block;\n			}\n.b-colorpicker-controls-submit .b-flatbutton {\n			display: none;\n			}\n.s-schemius .b-colorpicker-controls-submit .b-ljbutton {\n			display: none;\n			}\n.s-schemius .b-colorpicker-controls-submit .b-flatbutton {\n			display: inline-block;\n			padding: 10px;\n			font-size: 12px;\n			}\n.b-updateform-bubble-user-button {\n	text-align: right;\n	}\n@media all and (max-width: 650px) {\n	.b-color-selector {\n		width: 150px;\n		height: 150px;\n		}\n\n	.b-color-selector-bar {\n		width: 15px;\n		height: 150px;\n		margin: 0 15px 0 0;\n		}\n\n	.b-color-selector-bar A {\n		left: -8px;\n		}\n\n	.b-colorpicker-controls-current,\n	.b-colorpicker-controls-new {\n		width: 30px;\n		height: 30px;\n		margin: 0 0 10px 0;\n		}\n}\n\n/* <<< file end: stc/widgets/colorpicker.css */\n\n/*# sourceMappingURL=colorpicker.css.map */\n');

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Discovery.Settings', ['LJ.Api', 'LJ.Bubble', 'LJ.Colorpicker']).controller('ColorCtrl', ['$scope', function ($scope) {

    $scope.$on('bubble:open:color', function (event, name, options) {
      $scope.color = options.color;
      $scope.attr = options.attr;
      $scope.oldColor = $scope.color;
    });

    $scope.$on('bubble:close:color', function () {
      $scope.color = $scope.oldColor;
      LJ.Event.trigger('color:reset', $scope.color, $scope.attr);
      $scope.color = null;
    });

    $scope.save = function () {
      $scope.oldColor = $scope.color;
      LJ.Event.trigger('color:save', $scope.color, $scope.attr);
      $scope.bubble.close();
    };

    $scope.$watch('color', function (current, previous) {
      if (current !== previous && current !== null) {
        LJ.Event.trigger('color:change', current, $scope.attr);
      }
    });
  }]).controller('ImageUploaderCtrl', ['$scope', '$timeout', 'Api', function ($scope, $timeout, Api) {

    var $preview = angular.element('.b-feedsettings-upload'),
        $input = angular.element('#pickfiles'),
        attrs = ['background_repeat_y', 'background_repeat_x', 'background_position', 'background_image_key', 'background_image'];


    function setPreviewImage(image) {
      var value = '';

      if (image) {
        value = 'url(' + image + ')';
      }

      $preview.css('background-image', value);
    }
    $scope.clickOnUpload = function () {
      $input.trigger('click');
    };

    $scope.clickOnRestore = function () {
      uploader.splice(0);
      setPreviewImage('');

      Api.call('settings.reset_friendsfeed_background_settings').then(function (response) {
        $scope.settings = response;
      });
    };

    var uploader = new plupload.Uploader({
      runtimes: 'html5,flash',

      browse_button: 'pickfiles',

      url: '/feed/endpoints/background_upload',

      multipart: true,

      dragdrop: true,

      drop_element: 'upload-container',

      filters: {
        max_file_size: '10mb',
        mime_types: [{ title: 'Image files', extensions: 'jpg,gif,png' }, { title: 'Zip files', extensions: 'zip' }]
      },

      flash_swf_url: '/js/lib/plupload/Moxie.cdn.swf',

      init: {
        FilesAdded: function FilesAdded(up, files) {
          plupload.each(files, function (file) {
            file.formattedSize = plupload.formatSize(file.size);
          });

          $timeout(function () {
            uploader.start();
          });
        },

        FileUploaded: function FileUploaded(up, file, response) {
          response = JSON.parse(response.response);
          $scope.settings.background_image_key = response.result.imageKey;
          $scope.settings.background_image = response.result.imageURL;
          setPreviewImage($scope.settings.background_image);
          $scope.inprogress = false;
          $scope.$apply();
        },

        BeforeUpload: function BeforeUpload() {
          $scope.inprogress = true;
        }
      }
    });

    attrs.forEach(function (attr) {
      $scope.$watch('settings.' + attr, function (current, previous) {
        if (current !== previous) {
          LJ.Event.trigger('background:change', current, attr);
        }
      });
    });

    $scope.$on('bubble:open:background', function (event, name, options) {
      $scope.settings = options;
      setPreviewImage($scope.settings.background_image);
    });

    uploader.init();
  }]).controller('SettingsCtrl', ['$scope', '$templateCache', '$timeout', 'Api', 'Bubble', function ($scope, $templateCache, $timeout, Api, Bubble) {

    var that = this,
        $css = angular.element('.b-lenta-preview'),
        $template = $templateCache.get('lentaPreviewStyle.ng.tmpl'),
        $window = angular.element(window),
        $settings = angular.element('.b-feedsettings'),
        $title = angular.element('.b-lenta-head-title'),
        colorsAttrs = ['background_color', 'entry_background_color', 'sidebar_background_color', 'font_color', 'sidebar_font_color', 'url_color', 'url_visited_color', 'url_hover_color', 'element_color', 'element_border_color', 'element_background_color'],
        replaceStyle = LJ.Function.debounce(function (result) {
      $css.text(result);
    }, 100),
        isLoadedSettings = false;


    function convertColorAttrs(response) {
      colorsAttrs.forEach(function (attr) {
        var value = response[attr];

        $scope.settings[attr] = value ? '#' + value : value;
      });
    }

    this.change = function (value, attr) {
      $scope.settings[attr] = value;
      that.updateStyle();
    };

    this.updateStyle = function () {
      var result;

      if (!isLoadedSettings) {
        return;
      }

      $scope.settings.background_repeat = 'no-repeat';

      angular.element('.b-lenta').toggleClass('b-lenta-tiny-size', $scope.settings.font_size <= 11);

      if ($scope.settings.background_repeat_y) {
        $scope.settings.background_repeat = 'repeat-y';
      }

      if ($scope.settings.background_repeat_x) {
        $scope.settings.background_repeat = 'repeat-x';
      }

      if ($scope.settings.background_repeat_y && $scope.settings.background_repeat_x) {
        $scope.settings.background_repeat = 'repeat';
      }

      $scope.settings.entry_background_color_rgb = LJ.Color.prototype.hexToRgbString($scope.settings.entry_background_color);
      $scope.settings.element_border_color_rgb = LJ.Color.prototype.hexToRgbString($scope.settings.element_border_color);

      result = $template.supplant($scope.settings);

      replaceStyle(result);
    };

    this.getSettings = function () {
      return Api.call('settings.get_friendsfeed_settings').then(function (response) {
        $scope.settings = response;

        // The ugly hack for LJSUP-26210 becouse we can not change all users props
        if ($scope.settings.font_family === 'ProximaNovaRegular') {
          $scope.settings.font_family = 'ProximaNova';
        }
        convertColorAttrs(response);
        isLoadedSettings = true;
      });
    };

    this.saveSettings = function (settings) {
      return Api.call('settings.save_friendsfeed_settings', settings);
    };

    this.restoreSettings = function () {
      return Api.call('settings.reset_friendsfeed_settings').then(function (response) {
        $scope.settings = response;
        convertColorAttrs(response);
      });
    };

    this.isEnabled = function () {
      return LJ.get('remote') && LJ.Flags.isEnabled('friendsfeed_v3_settings') && LJ.get('journal.username') === LJ.get('remote.username');
    };

    $scope.settings = {};

    // used for font-size generating
    $scope.range = new Array(27);
    $scope.fontTypes = ['ProximaNova', 'Verdana', 'Arial', 'Helvetica'];
    $scope.paginationType = ['pages', 'endless'];

    $scope.save = function () {
      var data = angular.copy($scope.settings);

      colorsAttrs.forEach(function (attr) {
        data[attr] = data[attr].slice(1);
      });

      that.saveSettings(data).then(function () {
        $scope.feed.menu.isOpened = false;
      });
    };

    $scope.cancel = function () {
      that.getSettings().then(function () {
        $scope.feed.menu.isOpened = false;
      }).then(that.updateStyle);
    };

    $scope.restore = function () {
      that.restoreSettings().then(that.updateStyle);
    };

    $scope.openColorpicker = function (event, attr) {
      $scope.feed.menu.isBubbleOpened = true;

      $timeout(function () {
        Bubble.open('color', {
          color: $scope.settings[attr], attr: attr
        }, angular.element(event.target));
      });
    };

    $scope.openUploader = function (event) {
      var options = {
        background_position: $scope.settings.background_position,
        background_repeat_x: $scope.settings.background_repeat_x,
        background_repeat_y: $scope.settings.background_repeat_y,
        background_image_key: $scope.settings.background_image_key,
        background_image: $scope.settings.background_image
      };

      $scope.feed.menu.isBubbleOpened = true;
      $timeout(function () {
        Bubble.open('background', options, angular.element(event.target));
      });
    };

    $scope.$watch('settings.friends_feed_title', function (value) {
      if (LJ.get('feed_type') === 'feed') {
        $title.text(value);
      }
    });

    ['settings.font_size', 'settings.font_family'].forEach(function (attr) {
      $scope.$watch(attr, function (current, previous) {
        if (current !== previous) {
          that.updateStyle();
        }
      });
    });

    $scope.$on('bubble:close:color', function () {

      // Use set timeout for prevent hide menu when you close colorpicker
      $timeout(function () {
        $scope.feed.menu.isBubbleOpened = false;
      }, 100);
    });

    $scope.$on('bubble:close:background', function () {

      // Use set timeout for prevent hide menu when you close uploader
      $timeout(function () {
        $scope.feed.menu.isBubbleOpened = false;
      }, 100);
    });

    $settings.on('scroll', function () {
      $window.trigger('scroll');
    });

    LJ.Event.on('color:change', that.change);
    LJ.Event.on('color:reset', that.change);
    LJ.Event.on('background:change', that.change);

    if (this.isEnabled()) {
      this.getSettings();
    }
  }]);
})();
/* <<< file end: js/discovery/settings.js */

//# map link was there [settings.js.map]
/* >>> file start: js/core/angular/users.js */
//= require js/core/angular/api.js
//= require js/core/angular/options.js

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Users', ['LJ.Api', 'LJ.Options']) // eslint-disable-line angular/di

  // Relations wrapper. Currently works through js/relations/relations.js
  .factory('Relations', ['$q', '$timeout', 'UsersCache', function ($q, $timeout, UsersCache) {

    /**
     * // add friend without options. State will be changed immediately
     * Relations.toggleFriend('test', true);
     *
     * // unsubscribe, but don't change user props immediately
     * Relations.toggleSubscription('test', false, { immediate: false });
     */

    /**
     * Helper that helps to interact with exiting relations
     * @param {String}   username        Username of user we are changing relation
     * @param {String}   action          Action to perform
     * @param {Object}   [options]       Options
     * @param {Boolean}  [options.wait]  Wait for response before updating user props
     * @return {Promise} Promise that will be resolved after action is completed
     */
    function _action(username, action, options) {
      var defer = $q.defer(),


      // immediate update user props
      updateProps = {
        addFriend: { is_invite_sent: true },
        removeFriend: { is_friend: false },
        subscribe: { is_subscribedon: true },
        unsubscribe: { is_subscribedon: false },
        join: { is_invite_sent: true },
        leave: { is_member: false },
        setBan: { is_banned: true },
        setUnban: { is_banned: false }
      },


      // revert properties values if error happens
      revertProps = {
        addFriend: { is_invite_sent: false },
        removeFriend: { is_friend: true },
        subscribe: { is_subscribedon: false },
        unsubscribe: { is_subscribedon: true },
        join: { is_invite_sent: false },
        leave: { is_member: true },
        setBan: { is_banned: false },
        setUnban: { is_banned: true }
      },


      // save current props
      userProps = angular.copy(UsersCache.get(username) || {});

      if (angular.isUndefined(options)) {
        options = {};
      }

      if (!options.wait) {
        UsersCache.update(username, updateProps[action] || {});
      }

      LJ.Event.trigger('relations.change', {
        username: username,
        action: action,
        callback: function callback(data) {
          $timeout(function () {
            if (data.error) {

              // rollback props
              if (!options.wait) {
                UsersCache.update(username, angular.extend(revertProps[action], userProps));
              }

              defer.reject(data.error.message);
              return;
            }

            var props = LJ.Object.pick(data, 'is_banned', 'is_friend', 'is_member', 'is_subscriber', 'is_subscribedon', 'is_friend_of', 'is_invite_sent');

            // update user props
            UsersCache.update(username, props);
            defer.resolve(data);
          });
        }
      });

      return defer.promise;
    }

    /**
     * Toggles subscription status of a user with provided username
     *
     * @param {String}   username        Username
     * @param {Boolean}  state           State: subscribe (true) or unsubscribe (false)
     * @param {Object}   [options]       Options
     * @param {Boolean}  [options.wait]  Wait for response before updating user props
     * @return {Promise}                 Promise that will be resolved with data after
     *                                   subscription status will be changed
     */
    function toggleSubscription(username, state, options) {
      var promise = _action(username, state ? 'subscribe' : 'unsubscribe', options);

      // reset filter mask after unsubscribe
      if (!state) {
        promise.then(function () {
          UsersCache.update(username, { filtermask: 0 });
        });
      }

      return promise;
    }

    /**
     * Toggles friend status of a user with provided username
     *
     * @param {String}   username        Username
     * @param {Boolean}  state           State: add friend (true) or remove from friend (false)
     * @param {Object}   [options]       Options
     * @param {Boolean}  [options.wait]  Wait for response before updating user props
     * @return {Promise}                 Promise that will be resolved with data after
     *                                   friend status will be changed
     */
    function toggleFriend(username, state, options) {
      return _action(username, state ? 'addFriend' : 'removeFriend', options);
    }

    /**
     * Join/leave community
     *
     * @param {String}   username        Username
     * @param {Boolean}  state           State: add friend (true) or remove from friend (false)
     * @param {Object}   [options]       Options
     * @param {Boolean}  [options.wait]  Wait for response before updating user props
     * @return {Promise}                 Promise that will be resolved with data after action completeness
     */
    function toggleMember(username, state, options) {
      return _action(username, state ? 'join' : 'leave', options);
    }

    /**
     * Ban/unban usern
     *
     * @param {String}   username        Username
     * @param {Boolean}  state           State: ban (true) or unban user (false)
     * @param {Object}   [options]       Options
     * @param {Boolean}  [options.wait]  Wait for response before updating user props
     * @return {Promise}                 Promise that will be resolved with data after action is completed
     */
    function toggleBan(username, state, options) {
      return _action(username, state ? 'setBan' : 'setUnban', options);
    }

    /**
     * Ban/unban user everywhere
     *
     * @param {String}   username       Username
     * @param {Boolean}  state          State: ban (true) or unban user (false) everywhere
     * @param {Object}   [options]      Options
     * @param {Boolean}  [options.wait] Wait for response before updating user props
     * @return {Promise}                Promise that will be resolved with data after action is completed
     */
    function toggleBanEverywhere(username, state, options) {
      return _action(username, state ? 'banEverywhere' : 'unbanEverywhere', options);
    }

    return {
      toggleFriend: toggleFriend,
      toggleSubscription: toggleSubscription,
      toggleMember: toggleMember,
      toggleBan: toggleBan,
      toggleBanEverywhere: toggleBanEverywhere
    };
  }])

  // mask operations
  .factory('Mask', function () {
    var factory = {};

    /**
     * Notice: first bit of a mask is not used
     */

    /**
      * Notice:
      *   Our max filter id is equal 31: last bit (of 32) could be equal to 1
      *
      *   JavaScript bitwise operators converts numbers to signed integers:
      *   https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators#Signed_32-bit_integers
      *
      *   If max bit is equal to 1, it will be converted to negative number.
      *
      *   That is why we should manually interpret number as unsigned integer
      */
    function unsigned(number) {
      return number >>> 0;
    }

    /**
     * Change mask accroding to provided operations
     *
     * @param {Number}       mask             Mask field
     * @param {Object}       actions          Operations
     * @param {Number|Array} [actions.add]    Group id(s) to be added in
     * @param {Number|Array} [actions.remove] Group id(s) to be removed from
     *
     * @return {Number} Updated mask
     */
    factory.change = function (mask, actions) {
      var add = actions.add,
          remove = actions.remove;

      // add
      if (angular.isDefined(add)) {
        if (!angular.isArray(add)) {
          add = [add];
        }

        mask = add.reduce(function (mask, id) {
          return unsigned(mask | Math.pow(2, id));
        }, mask);
      }

      // remove
      if (angular.isDefined(remove)) {
        if (!angular.isArray(remove)) {
          remove = [remove];
        }

        mask = remove.reduce(function (mask, id) {
          var filterMask = Math.pow(2, 32) - 1 - Math.pow(2, id);

          return unsigned(mask & filterMask);
        }, mask);
      }

      return mask;
    };

    /**
     * Check mask for inclusion in group
     *
     * @param  {Number} mask    Mask
     * @param  {Number} groupId Group id
     * @return {Boolean}        Result of the check
     */
    factory.check = function (mask, groupId) {
      var groupMask = Math.pow(2, groupId);

      // convert to Boolean, because `&` returns number (group id)
      return Boolean(mask & groupMask);
    };

    return factory;
  })

  /**
   * Service is responsible for retrieving, caching and updating users
   *
   * // get by username
   * UsersCache.get('test');
   *
   * // get all available users
   * UsersCache.get();
   *
   * // get users that satisfy filtering function
   * UsersCache.get( LJ.Function.get('is_community') );
   */
  .factory('UsersCache', ['$q', '$cacheFactory', 'Options', function ($q, $cacheFactory, Options) {

    var _cache = $cacheFactory('users'),
        options = Options.create({
      journal: LJ.get('remoteUser')
    }),
        factory;

    /**
     * Add / update user(s) to cache
     * @param  {Array|Object} users Models to cache
     * @return {Array|Object}       Cached models
     */
    function add(users) {
      if (angular.isUndefined(users)) {
        return;
      }

      var hash = _cache.get(options.get('journal')) || {},
          result = users;

      if (!angular.isArray(users)) {
        users = [users];
      }

      users.forEach(function (user) {
        if (!user || !angular.isObject(user) || angular.isUndefined(user.username)) {
          return;
        }

        var name = user.display_username || user.username,
            existed = hash[name];


        hash[name] = existed ? angular.extend(existed, user) : user;
      });

      _cache.put(options.get('journal'), hash);

      return result;
    }

    /**
     * Check if user exists in cache
     *
     * @param {String}   username Username
     * @return {Boolean}          Checking result
     */
    function exists(username) {
      var cachedUsers = _cache.get(options.get('journal'));

      return Boolean(cachedUsers[username]);
    }

    /**
     * User(s) getter
     * @param  {String|Function} [username] Get users by username if string passed,
     *                                      apply filtering function for all users if function passed,
     *                                      return all users, if nothing has been passed
     * @return {Object|Array|NULL}          Result
     *
     * @example
     *
     *     // get by username
     *     get('test');
     *
     *     // get all communities
     *     get( LJ.Function.get('is_community') );
     *
     *     // get all users
     *     get();
     */
    function get(username) {
      var cache;

      if (angular.isString(username)) {
        cache = _cache.get(options.get('journal'));
        return cache && cache[username] ? cache[username] : null;
      }

      if (angular.isFunction(username)) {
        // get users with filter function
        return _users(username);
      }

      if (angular.isUndefined(username)) {
        // get all users
        return _users();
      }

      throw new TypeError('Incorrect argument passed.');
    }

    function getById(id) {
      var cache = _cache.get(options.get('journal'));
      if (!cache && !angular.isObject(cache)) {
        return null;
      }
      return Object.keys(cache).reduce(function (res, key) {
        return String(cache[key].id) === String(id) ? cache[key] : res;
      }, null);
    }

    /**
     * Getter helper
     * @param  {Function} [filter] Filter function
     * @return {Array}             List of users
     */
    function _users(filter) {
      var cachedUsers = _cache.get(options.get('journal')),
          result = [],
          username;

      for (username in cachedUsers) {
        if (cachedUsers.hasOwnProperty(username)) {

          // skip users that not satisfy filter function
          if (filter && !filter(cachedUsers[username])) {
            continue;
          }

          result.push(cachedUsers[username]);
        }
      }

      return result;
    }

    /**
     * Update user props
     *
     * @param  {String} username Username of user to update
     * @param  {Object} props    Props to update
     * @return {Object}          Updated user
     */
    function update(username, props) {
      var user = get(username) || { username: username };

      angular.extend(user, props);
      add(user);

      return user;
    }

    factory = {
      // cache users
      add: add,
      update: update,

      // work with options
      set: options.set,

      // work with users
      get: get,
      getById: getById,
      exists: exists
    };

    return factory;
  }]).factory('Users', ['$q', '$timeout', 'Api', 'Mask', 'UsersCache', 'Options', function ($q, $timeout, Api, Mask, UsersCache, Options) {

    var rpc = {
      friends: {
        read: 'relations.list_friends',
        readOne: 'relations.get_friend',
        update: 'groups.update_users'
      },

      subscriptions: {
        read: 'relations.list_subscriptions',
        readOne: 'relations.get_subscription',
        update: 'filters.update_users'
      }
    },
        options = Options.create({
      type: 'friends',
      journal: LJ.get('remoteUser')
    });

    function _rpc(rpcType) {
      return rpc[options.get('type')][rpcType];
    }

    /**
     * Check if user should be extracted from cache according friend/subscription status
     * @param  {Object}  user User model
     * @return {Boolean}      Result
     */
    function _isUserCorrect(user) {
      if (options.get('type') === 'subscriptions') {
        return Boolean(user.is_subscribedon);
      }

      // we are able to add any user to group, that is why any know user is correct for groups
      return true;
    }

    /**
     * Mask getter
     *
     * @param  {Object} user    User object
     * @param {Number}  [value] Mask value to set
     * @return {Number}         Mask
     */
    function mask(user, value) {
      if (angular.isUndefined(value)) {
        return user[maskField()] || 1;
      }

      user[maskField()] = value;
    }

    function maskField() {
      return options.get('type') === 'subscriptions' ? 'filtermask' : 'groupmask';
    }

    function fetchUser(username, fields, options) {
      return Api.call('user.get', { target: username, fields: fields }, options).then(function (response) {
        var user = response.user;

        UsersCache.add(user);
        return user;
      });
    }

    function fetchUserById(userid, fields, options) {
      return Api.call('user.get', { targetid: userid, fields: fields }, options).then(function (response) {
        var user = response.user;

        UsersCache.add(user);
        return user;
      });
    }

    /**
     * Fetch friends of current user
     * @param  {Object} [fields]      Fields to fetch,
     *                                e.g. { groupmask: 1, is_personal: 1, is_identity: 1 }
     * @param  {Object} [apiOptions]  Api options: {cache: true}
     * @return {Promise}              Promise that will be resolved with data
     */
    function fetchFriends(fields, apiOptions) {
      return Api.call('relations.list_friends', {
        journal: options.get('journal'),
        fields: fields
      }, apiOptions).then(_setFlagAndCache('is_friend'));
    }

    function fetchGroupUsers(fields) {
      return Api.call('groups.list_users', {
        journal: options.get('journal'),
        fields: fields
      }).then(function (response) {
        UsersCache.add(response.users);
        return response;
      });
    }

    function fetchSubscriptions(fields) {
      return Api.call('relations.list_subscriptions', {
        journal: options.get('journal'),
        fields: fields
      }).then(_setFlagAndCache('is_subscribedon'));
    }

    function fetchBanned(fields) {
      return Api.call('relations.list_banned', {
        journal: options.get('journal'),
        fields: fields
      }).then(_setFlagAndCache('is_banned'));
    }

    /**
     * Fetch helper method: set flag for fetched users, cache and return them
     * @return {Function} Function to use inside of .then()
     */
    function _setFlagAndCache(flag) {
      return function (response) {
        var users = response.users;

        users.forEach(LJ.Function.set(flag, true));

        UsersCache.add(users);
        return users;
      };
    }

    function fetchCount(type) {
      return Api.call('relations.' + type + '_count').then(function (response) {
        return response.count;
      });
    }

    /**
     * Sync user(s) model(s) with server
     *
     * @param  {Array|Object} users User model or collection of models
     * @return {Promise}            Promise that will be resolved after server response
     */
    function sync(users) {
      if (!angular.isArray(users)) {
        users = [users];
      }

      if (users.length === 0) {
        return $q.reject('You should provide users to sync.');
      }

      return Api.call(_rpc('update'), {
        users: users,
        journal: options.get('journal')
      }).then(function (response) {
        UsersCache.add(response.users);
        return response;
      });
    }

    /**
     * Check is user listed in group/filter with `id`
     *
     * @method  isUserInGroup
     *
     * @param  {String}  username Username
     * @param  {Number}  id       Filter/Group id (1..30)
     * @return {Boolean}          Result
     */
    function isUserInGroup(username, id) {
      var user = UsersCache.get(username);

      return user ? Mask.check(mask(user), id) : false;
    }

    /**
     * @todo Remove this method and replace it usage in controller
     *
     * Temp method for extracting only existing users by usernames
     *
     * @param  {Array}  usernames   Username(s)
     * @return {Array}              Array of existing users
     */
    function getExisting(usernames) {
      return usernames.filter(UsersCache.exists).map(UsersCache.get).filter(_isUserCorrect);
    }

    /**
      * Filter users that are in exact group
      *
      * @method fromGroup
      *
      * @param  {Object} options          Options for users filtering
      * @param  {Number} options.id       Group id: (1..31)
      * @param  {Number} [options.limit]  Limit of users to extract
      * @param  {String} [options.filter] Filter username string
      * @return {Array}                   Array of users that are in group
      */
    function fromGroup(options) {
      var filter = (options.filter || '').toLowerCase(),
          users = UsersCache.get(function (user) {

        // filter friends/subscription
        if (!_isUserCorrect(user)) {
          return false;
        }

        if (!Mask.check(mask(user), options.id)) {
          return false;
        }

        if (filter && user.display_username.toLowerCase().indexOf(filter) === -1) {
          return false;
        }

        return true;
      });

      if (options.limit) {
        users = users.slice(0, options.limit);
      }

      return users;
    }

    /**
      * Filter users that are out of exact group
      *
      * @method outOfGroup
      *
      * @param {Object} options           Options for users filtering
      * @param {Number} options.id        Group id: (1..30)
      * @param {Number} [options.limit]   Limit of users to extract
      * @param {String} [options.filter]  Filter username string
      * @return {Array}                   Array of users that are out of group
      */
    function outOfGroup(options) {
      var filter = (options.filter || '').toLowerCase(),
          users = UsersCache.get(function (user) {

        // filter friends/subscription
        if (!_isUserCorrect(user)) {
          return false;
        }

        if (Mask.check(mask(user), options.id)) {
          return false;
        }

        if (filter && user.display_username.toLowerCase().indexOf(filter) === -1) {
          return false;
        }

        return true;
      });

      if (options.limit) {
        users = users.slice(0, options.limit);
      }

      return users;
    }

    /**
     * Add users to group
     *
     * @method addToGroup
     *
     * @param  {Number}         id          Group id
     * @param  {String|Array}   usernames   Username(s) of users to add
     * @return {Promise}                    Promise that will be resolved
     *                                      with synced users
     */
    function addToGroup(id, usernames) {
      if (!angular.isArray(usernames)) {
        usernames = [usernames];
      }

      var users;

      if (options.get('type') === 'subscriptions') {
        // for subscriptions we should filter non-existed
        users = getExisting(usernames);
      } else {
        users = usernames.map(function (username) {
          return UsersCache.get(username) || { username: username };
        });
      }

      users.forEach(function (user) {
        mask(user, Mask.change(mask(user), { add: id }));
      });

      return sync(users);
    }

    /**
     * Remove users from group
     *
     * @method removeFromGroup
     *
     * @param {Number}        id                Group id
     * @param {String|Array}  usernames         Username(s) of users to remove
     * @param {Object}        [options]         Options
     * @param {Boolean}       [options.silent]  Remove users from group without sync
     *
     * @return {Promise|Undefined}        Promise that will be resolved
     *                                    with synced users or Undefined, if options.silent provided
     */
    function removeFromGroup(id, usernames, options) {
      if (!angular.isArray(usernames)) {
        usernames = [usernames];
      }

      var existing = getExisting(usernames);

      // update mask
      existing.forEach(function (user) {
        mask(user, Mask.change(mask(user), { remove: id }));
      });

      // return without sync if silent
      if (options && options.silent) {
        return;
      }

      return sync(existing);
    }

    /**
     * Set alias for user
     *
     * @param  {String}  username Username
     * @param  {String}  value    User alias
     * @return {Promise}          Promise that will be resolved with data when complete
     */
    function alias(username, value) {
      UsersCache.update(username, { alias: value });
      return Api.call('user.alias_set', { target: username, alias: value });
    }

    /**
     * Sort helper
     *
     * @param {String}   prop Property. Available: username or display_username
     * @return {Function}      Comparator function
     *
     * @example
     *
     *    users.sort( Users.comparator('username') );
     */
    function comparator(prop) {
      return function (a, b) {
        return a[prop].toLowerCase().localeCompare(b[prop].toLowerCase());
      };
    }

    /**
     * Patched version of options.set
     *
     * If we set journal for users it should also set journal for cache
     */
    function set() {
      var old = options.get('journal'),
          journal;

      options.set.apply(null, arguments);
      journal = options.get('journal');

      // update journal of cache if it changed
      if (journal !== old) {
        UsersCache.set('journal', journal);
      }
    }

    return {
      USERHEAD_FIELDS: {
        alias: 1,
        journal_url: 1,
        profile_url: 1,
        userhead_url: 1,
        is_invisible: 1,
        journaltype: 1
      },

      // options
      set: set,
      get: options.get,

      Cache: UsersCache,

      // work with server
      fetchUser: fetchUser,
      fetchUserById: fetchUserById,
      fetchBanned: fetchBanned,
      fetchFriends: fetchFriends,
      fetchGroupUsers: fetchGroupUsers,
      fetchSubscriptions: fetchSubscriptions,

      fetchCount: fetchCount,

      sync: sync,

      alias: alias,

      isUserInGroup: isUserInGroup,
      getExisting: getExisting,
      fromGroup: fromGroup,
      outOfGroup: outOfGroup,
      addToGroup: addToGroup,
      removeFromGroup: removeFromGroup,

      comparator: comparator
    };
  }]);
})();
/* <<< file end: js/core/angular/users.js */

//# map link was there [users.js.map]
/* >>> file start: js/core/angular/ljUser.js */
//= require js/core/angular/api.js
//= require js/core/angular/users.js
Site.page.template['angular/ljUser.ng.tmpl'] = '<span\n    class=\"\n        ljuser\n        i-ljuser\n        i-ljuser-type-{{user.journaltype}}\n        \"\n    ng-class=\"{\n        \'i-ljuser-deleted\': user.is_invisible,\n        \'i-ljuser-nopopup noctxpopup\': user.noctxpopup,\n        \'i-ljuser-withalias\': user.alias,\n        \'i-ljuser-showalias\': user.showalias\n    }\"\n    data-ljuser=\"{{user.username}}\"\n    lj:user=\"{{user.username}}\"\n    ><!--\n\n    Userhead\n    --><a\n        class=\"i-ljuser-profile\"\n        ng-href=\"{{user.profile_url}}\"\n        ng-attr-target=\"{{user.target ? user.target : \'_self\'}}\"\n        ><!--\n        --><img\n            class=\"i-ljuser-userhead\"\n            ng-src=\"{{user.userhead_url}}\"\n            ><!--\n    --></a><!--\n\n    Username\n    --><a\n        class=\"i-ljuser-username\"\n        ng-href=\"{{user.journal_url}}\"\n        ng-attr-title=\"{{user.display_username || user.alias}}\"\n        ng-attr-target=\"{{user.target ? user.target : \'_self\'}}\"\n        ><b ng-bind=\"user.display_name || user.display_username\"></b></a><!--\n\n    Alias\n    --><span\n        class=\"i-ljuser-alias\"\n        ng-bind=\"user.alias\"\n        ></span><!--\n\n--></span>\n';

(function () {
  'use strict';

  /**
   * @module LJ.User
   */

  ljUserStatic.$inject = ['$parse'];
  ljUserAvatarStatic.$inject = ['$parse', '$location'];
  angular.module('LJ.User', ['LJ.Api', 'LJ.Templates', 'Users']);

  angular.module('LJ.User').factory('ljUser', ljUser).directive('ljUserById', ljUserById).directive('ljUserDynamic', ljUserDynamic).directive('ljUserAvatarImg', ljUserAvatarImg).directive('ljUserStatic', ljUserStatic).directive('ljUserAvatarStatic', ljUserAvatarStatic);

  /**
   * Helper service that allow us to get lj-user html for user with username and options
   *
   * @example
   *
   *     // returns promise that will be resolved with html for user `good`
   *     ljUser.get('good', { noctxpopup: true });
   */
  ljUser.$inject = ['$rootScope', 'Api', '$q', '$templateCache', '$compile', '$timeout', 'Users'];
  function ljUser($rootScope, Api, $q, $templateCache, $compile, $timeout, Users) {

    // wrapper is needed because we have to get outerHTML
    var wrapper = angular.element('<div />'),
        tmpl = $templateCache.get('ljUser.ng.tmpl');

    /**
     * Prepare data for user, fetch if not ready
     *
     * @param  {String} username Username
     * @return {Promise}         Promise that will be resolved with user data
     */
    function prepare(username) {
      var defer = $q.defer(),
          user = Users.Cache.get(username);

      // do not fetch user data if it has been already fetched
      if (user && user.userhead_url) {
        defer.resolve(user);
        return defer.promise;
      }

      return Users.fetchUser(username, Users.USERHEAD_FIELDS, { cache: true, silent: true });
    }

    /**
     * Prepare data for user, fetch if not ready
     *
     * @param {String} UserId
     * @return {Promise} Promise that will be resolved with user data
     */
    function prepareById(id) {
      var defer = $q.defer(),
          user = Users.Cache.getById(id);

      // do not fetch user data if it has been already fetched
      if (user && user.userhead_url) {
        defer.resolve(user);
        return defer.promise;
      }

      return Users.fetchUserById(id, Users.USERHEAD_FIELDS, { cache: true, silent: true });
    }

    /**
     * Get user html by username
     * @param  {String} username  Username
     * @param  {Object} [options] User options
     * @return {Promise}          Promise that will be resolved with user data
     */
    function get(username, options) {
      var defer = $q.defer(),


      // create temporary scope for html compilation
      scope = $rootScope.$new();

      prepare(username).then(function () {
        var element;

        scope.user = angular.extend({}, Users.Cache.get(username), options || {});
        element = $compile(tmpl)(scope);

        // let angular apply all directives
        $timeout(function () {
          defer.resolve(
          // outerHTML
          wrapper.empty().append(element).html());

          scope.$destroy();
        });
      });

      return defer.promise;
    }

    /**
     * Get user html by id
     * @param  {number} id  userId
     * @param  {Object} [options] User options
     * @return {Promise}          Promise that will be resolved with user data
     */
    function getById(id, options) {
      var defer = $q.defer(),


      // create temporary scope for html compilation
      scope = $rootScope.$new();

      prepareById(id).then(function () {
        var element;

        scope.user = angular.extend({}, Users.Cache.getById(id), options || {});
        element = $compile(tmpl)(scope);

        // let angular apply all directives
        $timeout(function () {
          defer.resolve(
          // outerHTML
          wrapper.empty().append(element).html());

          scope.$destroy();
        });
      });

      return defer.promise;
    }

    return {
      prepare: prepare,
      prepareById: prepareById,
      getById: getById,
      get: get
    };
  }

  /**
   * lj-user-dynamic directive
   *
   * Available options:
   * - noctxpopup: disable contextual popup over the user
   *
   * @example
   *
   *     <span lj-user-dynamic="'good'" />
   *     <span lj-user-dynamic="username" />
   *     <span
   *       lj-user-dynamic="'good'"
   *       lj-user-dynamic-options="{ noctxpopup: true }"
   *       />
   */
  ljUserDynamic.$inject = ['$parse', 'Users', 'ljUser'];
  function ljUserDynamic($parse, Users, ljUser) {

    return {
      templateUrl: 'ljUser.ng.tmpl',
      replace: true,
      scope: true,
      compile: function compile(element, attrs) {
        var usernameGetter = $parse(attrs.ljUserDynamic),
            optionsGetter = $parse(attrs.ljUserDynamicOptions);

        return function link(scope) {
          var options = optionsGetter(scope);

          scope.$watch(function () {
            return usernameGetter(scope);
          }, function (value) {
            var username = value;

            scope.user = angular.extend({
              username: username,
              'display_username': username
            }, options || {});

            ljUser.prepare(username).then(function () {
              scope.$watch(function () {
                return Users.Cache.get(username);
              }, function (user) {
                angular.extend(scope.user, user);
              }, true);
            });
          });
        };
      }
    };
  }

  /**
   * lj-user-avatar directive
   *
   * @example
   *
   *     <span lj-user-avatar-img="username" />
   *     <span lj-user-avatar-img="userid" />
   *     <span
   *       lj-user-avatar-img="username"
   *       lj-user-avatar-img-options="{ class: 'one two three classes' }"
   *       />
   */
  ljUserAvatarImg.$inject = ['$parse', 'Users', 'ljUser'];
  function ljUserAvatarImg($parse, Users, ljUser) {
    return {
      template: '<img class="{{user.class}}" src="https://l-userpic.livejournal.net/default/{{user.id}}" alt="" />',
      // replace: true,
      scope: true,
      compile: function compile(element, attrs) {
        return function link(scope) {
          var user = $parse(attrs.ljUserAvatarImg)(scope),
              options = $parse(attrs.ljUserAvatarImgOptions)(scope),
              may_be_id = +user;

          if (may_be_id !== NaN && user.toString().length === may_be_id.toString().length) {
            scope.user = angular.extend({
              id: user
            }, options || {});

            return;
          }
          (function (a) {
            return a;
          })();

          scope.user = angular.extend({
            username: user
          }, options || {});

          ljUser.prepare(user).then(function (result) {
            scope.$watch(function () {
              return Users.Cache.get(user);
            }, function (user) {
              angular.extend(scope.user, user);
            }, true);
          });
        };
      }
    };
  }

  /**
   * lj-user-by-id directive
   *
   * Available options:
   * - noctxpopup: disable contextual popup over the user
   *
   * @example
   *
   *     <span lj-user-by-id="'123'" />
   *     <span lj-user-by-id="userid" />
   *     <span
   *       lj-user-by-id="'123'"
   *       lj-user-by-id-options="{ noctxpopup: true }"
   *       />
   */
  ljUserById.$inject = ['$parse', 'Users', 'ljUser'];
  function ljUserById($parse, Users, ljUser) {

    return {
      templateUrl: 'ljUser.ng.tmpl',
      replace: true,
      scope: true,
      compile: function compile(element, attrs) {
        return function link(scope) {
          var id = $parse(attrs.ljUserById)(scope),
              options = $parse(attrs.ljUserByIdOptions)(scope);

          scope.user = angular.extend({
            username: 'user-' + id,
            'display_username': 'user-' + id
          }, options || {});

          ljUser.prepareById(id).then(function () {
            scope.$watch(function () {
              return Users.Cache.getById(id);
            }, function (user) {
              angular.extend(scope.user, user);
            }, true);
          });
        };
      }
    };
  }

  /**
   * lj-user-static directive
   *
   * Available options:
   * - noctxpopup: disable contextual popup over the user
   *
   * @example
   *
   *     <span
   *       lj-user-static="'good'"
   *       lj-user-static-id="'123'"
   *       lj-user-static-options="{ noctxpopup: true }"
   *     />
   *
   */
  /* eslint-disable camelcase */
  function ljUserStatic($parse) {
    var protocol = 'https:';

    return {
      templateUrl: 'ljUser.ng.tmpl',
      replace: true,
      scope: true,
      compile: function compile(element, attrs) {
        var userGetter = $parse(attrs.ljUserStatic),
            idGetter = $parse(attrs.ljUserStaticId),
            optionsGetter = $parse(attrs.ljUserStaticOptions);


        return function link(scope) {
          var user = userGetter(scope),
              userid = idGetter(scope),
              options = optionsGetter(scope) || {},
              journal = options.journal_url || protocol + '//' + user + '.livejournal.com/',
              profileUrl = protocol + '//' + user + '.livejournal.com/profile';


          // for varlamov.ru
          if (user === 'zyalt') {
            profileUrl = journal + 'profile';
            user = 'varlamov.ru';
          }

          scope.user = {
            alias: '',
            display_name: options.display_name || user,
            display_username: options.display_username || user,
            id: userid,
            is_invisible: false,
            journal_url: journal,
            journaltype: 'P',
            profile_url: profileUrl,
            userhead_url: protocol + '//l-files.livejournal.net/userhead/default/' + userid,
            username: user,
            noctxpopup: options.noctxpopup
          };
        };
      }
    };
  }
  /* eslint-enable camelcase */

  /**
   * lj-user-avatar-static directive
   *
   * Available options:
   * - class: specific classname
   *
   * @example
   *
   *     <span
   *       lj-user-avatar-static
   *       lj-user-avatar-static-id="'123'"
   *       lj-user-avatar-static-options="{ class: 'one two three classes' }"
   *     />
   *
   */
  function ljUserAvatarStatic($parse, $location) {
    var protocol = 'https:';
    return {
      template: '\n        <img\n          class="{{user.class}}"\n          ng-src="' + protocol + '//l-userpic.livejournal.net/default/{{user.id}}"\n          alt=""\n        />',
      scope: true,
      compile: function compile(element, attrs) {
        var idGetter = $parse(attrs.ljUserAvatarStaticId),
            optionsGetter = $parse(attrs.ljUserAvatarStaticOptions);


        return function link(scope) {
          var userid = idGetter(scope),
              options = optionsGetter(scope);

          scope.user = {
            id: userid,
            class: options.class || ''
          };
        };
      }
    };
  }
})();
/* <<< file end: js/core/angular/ljUser.js */

//# map link was there [ljUser.js.map]
/* >>> file start: js/widgets/likus.js */
var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

//= require js/core/angular/ljUser.js
//= require js/core/angular/api.js
//= require js/core/angular/bubble.js

// Due to LJSUP-23886
//= disabled_require js/node_modules/mo-js/mo.min.js

Site.page.template['angular/widgets/likus/likusMain.ng.tmpl'] = '<a\n    class=\"ljlikus-button ljlikus--like\"\n    ng-class=\"{\'ljlikus--like-active\': likus.liked}\"\n    ng-href=\"#\"\n    ng-click=\"likus.vote($event)\"\n    ng-if=\"likus.show && !likus.link\"\n    ><span class=\"ljlikus-icon\" lj-svg-icon=\"flaticon--like\"></span></a>\n<a\n    class=\"ljlikus-action\"\n    ng-href=\"#\"\n    ng-if=\"likus.show && likus.count && !likus.link\"\n    ng-click=\"likus.countClick($event)\"\n    ng-mouseover=\"likus.countHover($event)\"\n    ><span class=\"ljlikus-counter\">{{likus.count}}</span></a>\n\n<!-- no actions -->\n<a\n    class=\"ljlikus--like ljlikus-no-action\"\n    ng-href=\"{{likus.link}}\"\n    ng-if=\"likus.show && likus.link\"\n    >\n    <span class=\"ljlikus-icon\" lj-svg-icon=\"flaticon--like\"></span>\n    <span\n        class=\"ljlikus-counter\"\n        ng-if=\"likus.show && likus.link && likus.count\"\n        >{{likus.count}}</span>\n</a>\n';
Site.page.template['angular/widgets/likus/likusUsers.ng.tmpl'] = '<ul class=\"ljlikus-list\">\n    <li class=\"ljlikus__item\" ng-repeat=\"user in users.slice(0, 5)\">\n        <span lj-user-by-id=\"user\" lj-user-by-id-options=\"{ noctxpopup: true }\" />\n    </li>\n    <li\n        ng-if=\"count > 5\"\n        class=\"ljlikus__item ljlikus--more\"\n        >\n        <a href=\"#\" class=\"ljlikus__item--more\" ng-click=\"more($event)\">\n            <span lj-ml=\"likus.users.add_more\" lj-ml-resolve=\"{count: count - 5}\" />\n        </a>\n    </li>\n</ul>\n';
Site.page.template['angular/widgets/likus/likusBubble.ng.tmpl'] = '<!-- Bubble -->\n<div class=\"ljlikus-bubble\">\n\n    <!-- header -->\n    <header class=\"ljlikus-bubble__header\">\n        <span class=\"ljlikus-bubble__title\" lj-ml=\"likus.users.title\"></span>\n        <span class=\"ljlikus-counter\">{{likusBubble.count}}</span>\n        <span\n            class=\"ljlikus-bubble__close\"\n            lj-svg-icon=\"flaticon--cross\"\n            ng-click=\"likusBubble.close($event)\"\n        ></span>\n    </header> <!-- /header -->\n\n    <!-- body -->\n    <div class=\"ljlikus-bubble__body\">\n\n        <!-- list -->\n        <ul class=\"ljlikus-list ljlikus-list--full\">\n            <li ng-repeat=\"user in likusBubble.users\" class=\"ljlikus__item\">\n                <span class=\"ljlikus__item-userpic\">\n                    <img ng-src=\"{{likusBubble.getUserImage(user)}}\" alt=\"\" >\n                </span>\n                <div class=\"ljlikus__item-meta\">\n                    <span lj-html=\"user.entry_title\" />\n                    <p class=\"ljlikus__item-usertitle\">{{user.title}}</p>\n                </div>\n                <div class=\"ljlikus__friends-wrap\">\n                    <button class=\"ljlikus__friends\n                                    ljlikus__friends--add\n                                    flatbutton\n                                    flatbutton--small\n                                    flatbutton--neutral\"\n                          ng-class=\"{ \'ljlikus__friends--hide\': user.is_friend }\"\n                          ng-disabled=\"user.updating\"\n                          ng-click=\"likusBubble.toggleFriend(user, true)\"\n                          lj-ml=\"likus.users.add.friends\"\n                    ></button>\n                    <button class=\"ljlikus__friends\n                                    ljlikus__friends--list\n                                    flatbutton\n                                    flatbutton--small\n                                    flatbutton--neutral\"\n                          ng-class=\"{ \'ljlikus__friends--hide\': !user.is_friend }\"\n                          ng-disabled=\"user.updating\"\n                          ng-click=\"likusBubble.toggleFriend(user, false)\">\n                        <span class=\"ljlikus__friends--list-span\"\n                              lj-ml=\"likus.users.friend.list\"\n                        ></span>\n                        <span lj-ml=\"likus.users.friend.remove\"\n                              class=\"ljlikus__friends--remove\"\n                        ></span>\n                    </button>\n                </div>\n            </li>\n            <li\n                class=\"ljlikus__item ljlikus__item--more\"\n                ng-if=\"likusBubble.hasMore\"\n                >\n                <a\n                    class=\"b-flatbutton b-flatbutton-simple\"\n                    href=\"#\"\n                    ng-click=\"likusBubble.loadMore($event)\"\n                    lj-ml=\"likus.users.show.more\"\n                ></a><!--\n            --></li>\n            <li\n                class=\"ljlikus__item ljlikus__item--loading\"\n                ng-if=\"likusBubble.loading\"\n                >\n                <span class=\"svgpreloader-16 svgpreloader-tag\"></span>\n            </li>\n        </ul> <!-- /list -->\n\n    </div> <!-- /body -->\n</div> <!-- /bubble -->\n';

//= require_ml likus.users.add_more
//= require_ml likus.users.sc
//= require_ml likus.users.add.friends
//= require_ml likus.users.friend.list
//= require_ml likus.users.friend.remove
//= require_ml likus.users.title

(function () {
  'use strict';

  syncService.$inject = ['$window'];
  likusService.$inject = ['$timeout', '$q', '$log', '$window', 'Api', 'SyncService'];
  angular.module('LJ.Likus', ['LJ.Directives', 'LJ.User', 'LJ.Bubble', 'LJ.Api']).run(function () {
    if (LJ.Flags.isEnabled('likes_display')) {
      angular.element('body').addClass('j-p-likus');
      angular.element('[ng-app]').append('<div lj-likus-bubble></div>');
    }
  }).factory('SyncService', syncService).factory('LikusService', likusService).directive('ljLikus', ljLikus).directive('ljLikusBubble', ljLikusBubble);

  /**
   * @directive ljLikus
   */
  function ljLikus() {
    return {
      scope: {
        noActions: '@ljLikusNoActions',
        count: '@ljLikusCount',
        medius: '@ljLikusMedius',
        journal: '@ljLikusJournal',
        item: '@ljLikusItem',
        token: '@ljLikusToken',
        uri: '@ljLikusUri'
      },
      templateUrl: 'likusMain.ng.tmpl',
      controllerAs: 'likus',
      controller: likusController
    };
  }

  /**
   * @controller likusController
   */
  likusController.$inject = ['$scope', '$element', '$rootScope', '$window', '$log', 'LikusService', 'Bubble', 'ljUser'];
  function likusController($scope, $element, $rootScope, $window, $log, LikusService, Bubble, ljUser) {
    var vm = this,
        link = $scope.noActions || false,
        count = parseInt($scope.count) || 0,
        medius = $scope.medius,
        journal = $scope.journal,
        item = $scope.item,
        uri = $scope.uri || $window.LJ.get('currentEntry'),
        token = $scope.token || $window.LJ.get('likes_signature'),
        likesEnabled = $window.LJ.Flags.isEnabled('likes'),
        flagMedius = $window.LJ.Flags.isEnabled('medius'),
        likesDisplayed = $window.LJ.Flags.isEnabled('likes_display'),
        oldDesign = $window.LJ.Flags.isDisabled('homepage_v3'),
        remote = $window.LJ.get('remote'),
        body = angular.element('body'),
        users,
        entity,
        unregFn,
        votting;

    if (!likesEnabled) {
      $element.remove();
      return;
    }

    if (oldDesign) {
      $element.remove();
      return;
    }

    // LJSUP-25959: [Likes] There is no likes for non-cyr users in medius
    // location.pathname == '/'
    if (medius && !flagMedius && location.pathname == '/') {
      $element.remove();
      return;
    }

    if (journal && item) {
      entity = {
        journal: journal,
        item: item,
        uniq: '' + journal + '-' + item
      };
    }

    if (!entity && uri) {
      entity = {
        uri: uri,
        uniq: uri
      };
    }

    if (!entity || !token) {
      return;
    }

    if (likesDisplayed) {
      $element.removeClass('lj-likus--hidden');
    }

    vm.show = likesDisplayed;
    vm.count = count;
    vm.liked = false;
    vm.link = link;

    LikusService.getVote(entity, {
      token: token,
      type: link ? 'short' : 'full',
      count: count && link ? count : false
    }, update).then(update)

    // add animation only after likus data
    // Animation is disabled due to LJSUP-23886
    /*
    .then(() => {
      if (!likesDisplayed || link) {
        return;
      }
      const el = $element.find('.ljlikus-button')[0];
      const elSpan = $element.find('.ljlikus-button > .ljlikus-icon')[0];
      ljLikusAnimation(el, elSpan, vm.liked);
    })
    */
    ;

    vm.vote = function (e) {
      e.preventDefault();
      if (!remote) {
        LJ.Util.Action.login(e);
        return;
      }
      if (votting) {
        $log.log('You don\'t want to vote so quickly!');
        return;
      }

      votting = true;
      LikusService.setVote(_extends({}, entity), { mark: +vm.liked }).then(update).then(function () {
        votting = false;
      }, function () {
        votting = false;
      });
    };

    vm.users = function (e) {
      var scope = $rootScope.$new();

      scope.users = users;
      scope.count = this.count;
      scope.more = more;

      unregFn = Bubble.register({
        name: 'likus-users',
        template: 'likusUsers.ng.tmpl',
        closeControl: false,
        closeOnScroll: true,
        autoClose: 200,
        tryAsideIfNoHorizSpace: true
      }, scope);

      Bubble.open('likus-users', angular.element(e.currentTarget));
      $scope.$on('bubble:close:likus-users', unregFn);
    };

    vm.countHover = function (e) {
      if ($window.innerWidth <= 650) {
        e.preventDefault();
        return;
      }
      vm.users(e);
    };

    vm.countClick = function (e) {
      e.preventDefault();
      if ($window.innerWidth > 650) {
        return;
      }
      vm.users(e);
    };

    function more(ev) {
      ev.preventDefault();
      Bubble.close('likus-users');
      if (angular.isFunction(unregFn)) {
        unregFn();
      }
      LikusService.showUsers(_extends({}, entity), { likes_signature: token });
    }

    function update(res) {
      entity = {
        journal: res.journal,
        item: res.item,
        uniq: res.journal + '-' + res.item
      };
      vm.count = parseInt(res.count) || 0;
      vm.liked = Boolean(res.liked);

      if (!link) {
        Promise.all(res.users.map(function (us) {
          return ljUser.prepareById(us);
        })).then(function (uss) {
          // set user list after it cached
          users = [].concat(res.users);
        });
      }
    }
  }

  /*
  function ljLikusAnimation(el, elSpan, state) {
    new Animocon(el, {
      liked: state,
      tweens : [
        // ring animation
        new mojs.Transit({
          parent: el,
          duration: 750,
          type: 'circle',
          radius: {0: 40},
          fill: 'transparent',
          stroke: '#F35186',
          strokeWidth: {35:0},
          opacity: 0.2,
          x: '50%',
          y: '45%',
          isRunLess: true,
          easing: mojs.easing.bezier(0, 1, 0.5, 1)
        }),
        new mojs.Transit({
          parent: el,
          duration: 500,
          delay: 100,
          type: 'circle',
          radius: {0: 20},
          fill: 'transparent',
          stroke: '#F35186',
          strokeWidth: {5:0},
          opacity: 0.2,
          x: '50%',
          y: '50%',
          shiftX : 40,
          shiftY : -60,
          isRunLess: true,
          easing: mojs.easing.sin.out
        }),
        new mojs.Transit({
          parent: el,
          duration: 500,
          delay: 180,
          type: 'circle',
          radius: {0: 10},
          fill: 'transparent',
          stroke: '#F35186',
          strokeWidth: {5:0},
          opacity: 0.5,
          x: '50%',
          y: '50%',
          shiftX : -10,
          shiftY : -80,
          isRunLess: true,
          easing: mojs.easing.sin.out
        }),
        new mojs.Transit({
          parent: el,
          duration: 800,
          delay: 240,
          type: 'circle',
          radius: {0: 20},
          fill: 'transparent',
          stroke: '#F35186',
          strokeWidth: {5:0},
          opacity: 0.3,
          x: '50%',
          y: '50%',
          shiftX : -70,
          shiftY : -10,
          isRunLess: true,
          easing: mojs.easing.sin.out
        }),
        new mojs.Transit({
          parent: el,
          duration: 800,
          delay: 240,
          type: 'circle',
          radius: {0: 20},
          fill: 'transparent',
          stroke: '#F35186',
          strokeWidth: {5:0},
          opacity: 0.4,
          x: '50%',
          y: '50%',
          shiftX : 80,
          shiftY : -50,
          isRunLess: true,
          easing: mojs.easing.sin.out
        }),
        new mojs.Transit({
          parent: el,
          duration: 1000,
          delay: 300,
          type: 'circle',
          radius: {0: 15},
          fill: 'transparent',
          stroke: '#F35186',
          strokeWidth: {5:0},
          opacity: 0.2,
          x: '50%',
          y: '50%',
          shiftX : 20,
          shiftY : -100,
          isRunLess: true,
          easing: mojs.easing.sin.out
        }),
        new mojs.Transit({
          parent: el,
          duration: 600,
          delay: 330,
          type: 'circle',
          radius: {0: 25},
          fill: 'transparent',
          stroke: '#F35186',
          strokeWidth: {5:0},
          opacity: 0.4,
          x: '50%',
          y: '50%',
          shiftX : -40,
          shiftY : -90,
          isRunLess: true,
          easing: mojs.easing.sin.out
        }),
        // icon scale animation
        new mojs.Tween({
          duration : 1200,
          easing: mojs.easing.ease.out,
          onUpdate: function(progress) {
            if(progress > 0.3) {
              var elasticOutProgress = mojs.easing.elastic.out(1.43*progress-0.43);
              elSpan.style.WebkitTransform = elSpan.style.transform = 'scale3d(' + elasticOutProgress + ',' + elasticOutProgress + ',1)';
            }
            else {
              elSpan.style.WebkitTransform = elSpan.style.transform = 'scale3d(0,0,1)';
            }
          }
        })
      ],
    });
  }
  */

  /**
   * @directive ljLikusBubble
   */
  function ljLikusBubble() {
    return {
      scope: true,
      templateUrl: 'likusBubble.ng.tmpl',
      controllerAs: 'likusBubble',
      controller: likusBubbleController
    };
  }

  /**
   * @controller likusBubbleController
   */
  likusBubbleController.$inject = ['$scope', '$window', 'LikusService', 'Api'];
  function likusBubbleController($scope, $window, LikusService, Api) {
    var vm = this,
        limit = 100,
        lastid = null,
        klass = 'ljlikus-bubble--full',
        likesEnabled = $window.LJ.Flags.isEnabled('likes'),
        body = angular.element('body');

    if (!likesEnabled) {
      return;
    }

    vm.loading = false;
    vm.hasMore = false;
    vm.users = [];
    vm.count = 0;

    // Hide modal window after click on backdrop
    vm.fader = angular.element('.b-fader');
    vm.fader.on('click', function (e) {
      vm.close(e);
      $scope.$apply();
    });

    vm.getUserImage = function (user) {
      return user.userpic || LJ.get('siteroot') + '/img/userpics/userpic-user.png';
    };

    vm.close = function (e) {
      e && e.preventDefault();
      LikusService.showUsers(false);
    };

    vm.loadMore = function (e) {
      e.preventDefault();
      loadUsers(LikusService.showUsers());
    };

    vm.toggleFriend = function (user, add) {
      user.updating = true;
      Api.call(add ? 'relations.addfriend' : 'relations.removefriend', { target: user.username }, { silent: true }).then(function () {
        user.updating = false;
        user.is_friend = add;
      });
    };

    $scope.$watch(check, toggleUsers);

    function check() {
      return LikusService.showUsers();
    }

    function toggleUsers(entity) {
      if (!entity) {
        body.removeClass(klass);
        vm.users = [];
        vm.count = 0;
        lastid = null;
        return;
      }

      body.addClass(klass);
      vm.count = LikusService.getCached(entity);
      loadUsers(entity);
    }

    function loadUsers(entity) {
      vm.loading = true;
      vm.hasMore = false;
      LikusService.getUsers(entity, { limit: limit, lastid: lastid }).then(function (_ref) {
        var res = _ref.res,
            count = _ref.count;

        vm.count = count;
        vm.loading = false;
        lastid = (res[limit - 1] || {}).id;
        vm.hasMore = false; // Boolean(lastid);
        vm.users = vm.users.concat(vm.lastid ? res.slice(1) : res);
      });
    }
  }

  /**
   * @service SyncService
   */
  function syncService($window) {
    var _cache = {};

    return {
      push: push,
      listen: listen
    };

    function init(key) {
      _cache[key] = _cache[key] || new Promise(function (resolve) {
        var iframe = $window.document.createElement('iframe');
        iframe.style = 'display: none; width: 0; height: 0; border: 0;';
        iframe.frameBorder = 0;
        iframe.src = LJ.get('statprefix') + '/??plain/storage.html?key=' + key + '&v=' + LJ.get('v');
        $window.document.body.appendChild(iframe);
        iframe.onload = function () {
          resolve(iframe);
        };
      });

      return _cache[key];
    }

    function push(key, data) {
      init(key).then(function (iframe) {
        iframe.contentWindow.postMessage(angular.toJson(data), '*');
      });
    }

    function listen(key, handler) {
      $window.addEventListener('message', function (e) {
        if (e.origin !== LJ.get('statprefix')) {
          return;
        }

        var current = void 0;
        try {
          current = angular.fromJson(e.data || '{}') || {};
        } catch (error) {
          current = {};
        }
        handler(current);
      });
    }
  }

  /**
   * @service LikusService
   */
  function likusService($timeout, $q, $log, $window, Api, SyncService) {
    var currentKey = 'lj-likus',
        party = {},
        _cache = {},
        _show = false,
        _listeners = [],
        _sync = {};


    SyncService.listen(currentKey, listenFunc);

    return {
      getVote: getVote,
      setVote: setVote,
      getCached: getCached,
      getUsers: getUsers,
      showUsers: showUsers
    };

    /**
     * @function getVote
     */
    function getVote(entity, params, listener) {
      // use $q (because there isn't digest event while use native Promise)
      var deferred = $q.defer(),
          key = params.token + '#' + params.type;


      if (params.count) {
        var res = _extends({}, entity, {
          count: params.count,
          liked: false,
          users: []
        });

        _cache[entity.uniq] = params.count;
        storageWrite(res);
        addListener(entity.uniq, listener);
        deferred.resolve(res);
        return deferred.promise;
      }

      if (!party.hasOwnProperty(key)) {
        party[key] = {};
        $timeout(getVotes.bind(null, key), 50);
      }

      if (party[key][entity.uniq]) {
        party[key][entity.uniq].listeners.push(listener);
      } else {
        party[key][entity.uniq] = {
          entity: entity,
          params: params,
          listeners: [listener],
          resolve: deferred.resolve,
          reject: deferred.reject
        };
      }

      return deferred.promise;
    }

    /**
     * @function setVote
     */
    function setVote(entity, params) {
      var opt = _extends({}, entity, params);

      return Api.call('likes.vote', opt).then(function (res) {
        if (!res.result) {
          LJ.Messages.error('An error has occurred.');
          return {};
        }
        _cache[opt.uniq] = res.result.count;
        storageWrite([res.result]);
        return res.result;
      });
    }

    /**
     * @function getVotes
     */
    function getVotes(key) {
      var current = void 0,
          entities = void 0,
          opt = void 0,
          token = key.split('#')[0],
          type = key.split('#')[1];


      if (!party.hasOwnProperty(key)) {
        $log.log('Unhandled error [getVotes / ljkus]');
        return;
      }

      current = party[key];
      delete party[key];
      entities = Object.keys(current).map(function (key) {
        return current[key].entity;
      });
      opt = {
        entities: entities,
        mode: 'feed',
        type: type,
        likes_signature: token
      };

      Api.call('likes.get_votes', opt, { silent: true }).then(function (response) {
        var res = response.result;
        if (!angular.isArray(res)) {
          $log.log('Unexpected response [getVotes / ljkus]');
          return;
        }

        storageWrite(res);
        res.map(function (ent) {
          var cur = current[ent.uniq];
          _cache[ent.uniq] = ent.count;
          cur && addListener(ent.journal + '-' + ent.item, cur.listeners);
          cur && cur.resolve(ent);
        });
      });
    }

    /**
     * @function getCached
     */
    function getCached(entity) {
      return _cache[entity.uniq] || 0;
    }

    /**
     * @function getUsers
     */
    function getUsers(entity, params) {
      var opt = _extends({}, entity, params);

      return Api.call('likes.get_users', opt).then(function (res) {
        storageWrite([{
          count: res.count,
          item: entity.item,
          journal: entity.journal
        }]);
        return {
          res: res.result,
          count: res.count
        };
      });
    }

    /**
     * @function showUsers
     */
    function showUsers(entity, params) {
      if (angular.isDefined(entity) && !entity) {
        _show = false;
      }

      if (angular.isObject(entity)) {
        _show = _extends({}, entity, params);
      }

      return _show;
    }

    function storageWrite(entities) {
      if (!angular.isArray(entities)) {
        return [];
      }

      var previous = Object.values(_sync).filter(function (el) {
        return el.expire > new Date().getTime();
      }),
          current = previous.concat(entities).reduce(function (acc, cur) {
        var uniq = cur.journal + '-' + cur.item;
        return _extends({}, acc, _defineProperty({}, uniq, _extends({}, acc[uniq], cur, {
          // save old users if new is empty
          users: cur.users && cur.users.length ? cur.users : acc[uniq] && acc[uniq].users || [],
          // expire after one day
          expire: new Date(new Date().getTime() + 1000 * 60 * 60 * 24).getTime()
        })));
      }, {});

      SyncService.push(currentKey, current);
      return current;
    }

    function addListener(uniq, cbs) {
      if (!Array.isArray(cbs)) {
        cbs = [cbs];
      }
      var callbackFunctions = cbs.filter(function (cb) {
        return angular.isFunction(cb);
      });
      if (!callbackFunctions.length) {
        return;
      }
      _listeners.push({ uniq: uniq, callbackFunctions: callbackFunctions });
    }

    function listenFunc(current) {
      _sync = _extends({}, current);
      _listeners.forEach(function (el) {
        if (!current.hasOwnProperty(el.uniq)) {
          return;
        }
        el.callbackFunctions.forEach(function (cb) {
          return cb(current[el.uniq]);
        });
      });
    }
  }

  /*
  var Animocon;
  document.addEventListener('DOMContentLoaded', function() {
    // taken from mo.js demos
    function isIOSSafari() {
      var userAgent;
      userAgent = window.navigator.userAgent;
      return userAgent.match(/iPad/i) || userAgent.match(/iPhone/i);
    };
     // taken from mo.js demos
    function isTouch() {
      var isIETouch;
      isIETouch = navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
      return [].indexOf.call(window, 'ontouchstart') >= 0 || isIETouch;
    };
     // taken from mo.js demos
    var isIOS = isIOSSafari(),
      clickHandler = isIOS || isTouch() ? 'touchstart' : 'click';
     function extend( a, b ) {
      for( var key in b ) {
        if( b.hasOwnProperty( key ) ) {
          a[key] = b[key];
        }
      }
      return a;
    }
     if (typeof mojs !== 'undefined') {
      Animocon = function Animocon(el, options) {
        this.el = el;
        this.options = extend( {}, this.options );
        extend( this.options, options );
         this.checked = options.liked || false;
         this.timeline = new mojs.Timeline();
         for(var i = 0, len = this.options.tweens.length; i < len; ++i) {
          this.timeline.add(this.options.tweens[i]);
        }
         var self = this;
        this.el.addEventListener(clickHandler, function() {
          if( self.checked ) {
            self.options.onUnCheck();
          }
          else {
            self.options.onCheck();
            self.timeline.start();
          }
          self.checked = !self.checked;
        });
      };
       Animocon.prototype.options = {
        tweens : [
          new mojs.Burst({
            shape : 'circle',
            isRunLess: true
          })
        ],
        onCheck : function() { return false; },
        onUnCheck : function() { return false; }
      };
    }
   });
  */
})();
/* <<< file end: js/widgets/likus.js */

//# map link was there [likus.js.map]
/* >>> file start: js/node_modules/angular-animate/angular-animate.js */
/**
 * @license AngularJS v1.5.8
 * (c) 2010-2016 Google, Inc. http://angularjs.org
 * License: MIT
 */
(function (window, angular) {
  'use strict';

  var ELEMENT_NODE = 1,
      COMMENT_NODE = 8,
      ADD_CLASS_SUFFIX = '-add',
      REMOVE_CLASS_SUFFIX = '-remove',
      EVENT_CLASS_PREFIX = 'ng-',
      ACTIVE_CLASS_SUFFIX = '-active',
      PREPARE_CLASS_SUFFIX = '-prepare',
      NG_ANIMATE_CLASSNAME = 'ng-animate',
      NG_ANIMATE_CHILDREN_DATA = '$$ngAnimateChildren',
      CSS_PREFIX = '',
      TRANSITION_PROP,
      TRANSITIONEND_EVENT,
      ANIMATION_PROP,
      ANIMATIONEND_EVENT;

  // Detect proper transitionend/animationend event names.


  // If unprefixed events are not supported but webkit-prefixed are, use the latter.
  // Otherwise, just use W3C names, browsers not supporting them at all will just ignore them.
  // Note: Chrome implements `window.onwebkitanimationend` and doesn't implement `window.onanimationend`
  // but at the same time dispatches the `animationend` event and not `webkitAnimationEnd`.
  // Register both events in case `window.onanimationend` is not supported because of that,
  // do the same for `transitionend` as Safari is likely to exhibit similar behavior.
  // Also, the only modern browser that uses vendor prefixes for transitions/keyframes is webkit
  // therefore there is no reason to test anymore for other vendor prefixes:
  // http://caniuse.com/#search=transition
  if (window.ontransitionend === void 0 && window.onwebkittransitionend !== void 0) {
    CSS_PREFIX = '-webkit-';
    TRANSITION_PROP = 'WebkitTransition';
    TRANSITIONEND_EVENT = 'webkitTransitionEnd transitionend';
  } else {
    TRANSITION_PROP = 'transition';
    TRANSITIONEND_EVENT = 'transitionend';
  }

  if (window.onanimationend === void 0 && window.onwebkitanimationend !== void 0) {
    CSS_PREFIX = '-webkit-';
    ANIMATION_PROP = 'WebkitAnimation';
    ANIMATIONEND_EVENT = 'webkitAnimationEnd animationend';
  } else {
    ANIMATION_PROP = 'animation';
    ANIMATIONEND_EVENT = 'animationend';
  }

  var DURATION_KEY = 'Duration',
      PROPERTY_KEY = 'Property',
      DELAY_KEY = 'Delay',
      TIMING_KEY = 'TimingFunction',
      ANIMATION_ITERATION_COUNT_KEY = 'IterationCount',
      ANIMATION_PLAYSTATE_KEY = 'PlayState',
      SAFE_FAST_FORWARD_DURATION_VALUE = 9999,
      ANIMATION_DELAY_PROP = ANIMATION_PROP + DELAY_KEY,
      ANIMATION_DURATION_PROP = ANIMATION_PROP + DURATION_KEY,
      TRANSITION_DELAY_PROP = TRANSITION_PROP + DELAY_KEY,
      TRANSITION_DURATION_PROP = TRANSITION_PROP + DURATION_KEY,
      ngMinErr = angular.$$minErr('ng');

  function assertArg(arg, name, reason) {
    if (!arg) {
      throw ngMinErr('areq', "Argument '{0}' is {1}", name || '?', reason || "required");
    }
    return arg;
  }

  function mergeClasses(a, b) {
    if (!a && !b) return '';
    if (!a) return b;
    if (!b) return a;
    if (isArray(a)) a = a.join(' ');
    if (isArray(b)) b = b.join(' ');
    return a + ' ' + b;
  }

  function packageStyles(options) {
    var styles = {};
    if (options && (options.to || options.from)) {
      styles.to = options.to;
      styles.from = options.from;
    }
    return styles;
  }

  function pendClasses(classes, fix, isPrefix) {
    var className = '';
    classes = isArray(classes) ? classes : classes && isString(classes) && classes.length ? classes.split(/\s+/) : [];
    forEach(classes, function (klass, i) {
      if (klass && klass.length > 0) {
        className += i > 0 ? ' ' : '';
        className += isPrefix ? fix + klass : klass + fix;
      }
    });
    return className;
  }

  function removeFromArray(arr, val) {
    var index = arr.indexOf(val);
    if (val >= 0) {
      arr.splice(index, 1);
    }
  }

  function stripCommentsFromElement(element) {
    if (element instanceof jqLite) {
      switch (element.length) {
        case 0:
          return element;

        case 1:
          // there is no point of stripping anything if the element
          // is the only element within the jqLite wrapper.
          // (it's important that we retain the element instance.)
          if (element[0].nodeType === ELEMENT_NODE) {
            return element;
          }
          break;

        default:
          return jqLite(extractElementNode(element));
      }
    }

    if (element.nodeType === ELEMENT_NODE) {
      return jqLite(element);
    }
  }

  function extractElementNode(element) {
    if (!element[0]) return element;
    for (var i = 0; i < element.length; i++) {
      var elm = element[i];
      if (elm.nodeType == ELEMENT_NODE) {
        return elm;
      }
    }
  }

  function $$addClass($$jqLite, element, className) {
    forEach(element, function (elm) {
      $$jqLite.addClass(elm, className);
    });
  }

  function $$removeClass($$jqLite, element, className) {
    forEach(element, function (elm) {
      $$jqLite.removeClass(elm, className);
    });
  }

  function applyAnimationClassesFactory($$jqLite) {
    return function (element, options) {
      if (options.addClass) {
        $$addClass($$jqLite, element, options.addClass);
        options.addClass = null;
      }
      if (options.removeClass) {
        $$removeClass($$jqLite, element, options.removeClass);
        options.removeClass = null;
      }
    };
  }

  function prepareAnimationOptions(options) {
    options = options || {};
    if (!options.$$prepared) {
      var domOperation = options.domOperation || noop;
      options.domOperation = function () {
        options.$$domOperationFired = true;
        domOperation();
        domOperation = noop;
      };
      options.$$prepared = true;
    }
    return options;
  }

  function applyAnimationStyles(element, options) {
    applyAnimationFromStyles(element, options);
    applyAnimationToStyles(element, options);
  }

  function applyAnimationFromStyles(element, options) {
    if (options.from) {
      element.css(options.from);
      options.from = null;
    }
  }

  function applyAnimationToStyles(element, options) {
    if (options.to) {
      element.css(options.to);
      options.to = null;
    }
  }

  function mergeAnimationDetails(element, oldAnimation, newAnimation) {
    var target = oldAnimation.options || {},
        newOptions = newAnimation.options || {},
        toAdd = (target.addClass || '') + ' ' + (newOptions.addClass || ''),
        toRemove = (target.removeClass || '') + ' ' + (newOptions.removeClass || ''),
        classes = resolveElementClasses(element.attr('class'), toAdd, toRemove);


    if (newOptions.preparationClasses) {
      target.preparationClasses = concatWithSpace(newOptions.preparationClasses, target.preparationClasses);
      delete newOptions.preparationClasses;
    }

    // noop is basically when there is no callback; otherwise something has been set
    var realDomOperation = target.domOperation !== noop ? target.domOperation : null;

    extend(target, newOptions);

    // TODO(matsko or sreeramu): proper fix is to maintain all animation callback in array and call at last,but now only leave has the callback so no issue with this.
    if (realDomOperation) {
      target.domOperation = realDomOperation;
    }

    if (classes.addClass) {
      target.addClass = classes.addClass;
    } else {
      target.addClass = null;
    }

    if (classes.removeClass) {
      target.removeClass = classes.removeClass;
    } else {
      target.removeClass = null;
    }

    oldAnimation.addClass = target.addClass;
    oldAnimation.removeClass = target.removeClass;

    return target;
  }

  function resolveElementClasses(existing, toAdd, toRemove) {
    var ADD_CLASS = 1,
        REMOVE_CLASS = -1,
        flags = {};

    existing = splitClassesToLookup(existing);

    toAdd = splitClassesToLookup(toAdd);
    forEach(toAdd, function (value, key) {
      flags[key] = ADD_CLASS;
    });

    toRemove = splitClassesToLookup(toRemove);
    forEach(toRemove, function (value, key) {
      flags[key] = flags[key] === ADD_CLASS ? null : REMOVE_CLASS;
    });

    var classes = {
      addClass: '',
      removeClass: ''
    };

    forEach(flags, function (val, klass) {
      var prop, allow;
      if (val === ADD_CLASS) {
        prop = 'addClass';
        allow = !existing[klass] || existing[klass + REMOVE_CLASS_SUFFIX];
      } else if (val === REMOVE_CLASS) {
        prop = 'removeClass';
        allow = existing[klass] || existing[klass + ADD_CLASS_SUFFIX];
      }
      if (allow) {
        if (classes[prop].length) {
          classes[prop] += ' ';
        }
        classes[prop] += klass;
      }
    });

    function splitClassesToLookup(classes) {
      if (isString(classes)) {
        classes = classes.split(' ');
      }

      var obj = {};
      forEach(classes, function (klass) {
        // sometimes the split leaves empty string values
        // incase extra spaces were applied to the options
        if (klass.length) {
          obj[klass] = true;
        }
      });
      return obj;
    }

    return classes;
  }

  function getDomNode(element) {
    return element instanceof jqLite ? element[0] : element;
  }

  function applyGeneratedPreparationClasses(element, event, options) {
    var classes = '';
    if (event) {
      classes = pendClasses(event, EVENT_CLASS_PREFIX, true);
    }
    if (options.addClass) {
      classes = concatWithSpace(classes, pendClasses(options.addClass, ADD_CLASS_SUFFIX));
    }
    if (options.removeClass) {
      classes = concatWithSpace(classes, pendClasses(options.removeClass, REMOVE_CLASS_SUFFIX));
    }
    if (classes.length) {
      options.preparationClasses = classes;
      element.addClass(classes);
    }
  }

  function clearGeneratedClasses(element, options) {
    if (options.preparationClasses) {
      element.removeClass(options.preparationClasses);
      options.preparationClasses = null;
    }
    if (options.activeClasses) {
      element.removeClass(options.activeClasses);
      options.activeClasses = null;
    }
  }

  function blockTransitions(node, duration) {
    // we use a negative delay value since it performs blocking
    // yet it doesn't kill any existing transitions running on the
    // same element which makes this safe for class-based animations
    var value = duration ? '-' + duration + 's' : '';
    applyInlineStyle(node, [TRANSITION_DELAY_PROP, value]);
    return [TRANSITION_DELAY_PROP, value];
  }

  function blockKeyframeAnimations(node, applyBlock) {
    var value = applyBlock ? 'paused' : '',
        key = ANIMATION_PROP + ANIMATION_PLAYSTATE_KEY;

    applyInlineStyle(node, [key, value]);
    return [key, value];
  }

  function applyInlineStyle(node, styleTuple) {
    var prop = styleTuple[0],
        value = styleTuple[1];

    node.style[prop] = value;
  }

  function concatWithSpace(a, b) {
    if (!a) return b;
    if (!b) return a;
    return a + ' ' + b;
  }

  var $$rAFSchedulerFactory = ['$$rAF', function ($$rAF) {
    var queue, cancelFn;

    function scheduler(tasks) {
      // we make a copy since RAFScheduler mutates the state
      // of the passed in array variable and this would be difficult
      // to track down on the outside code
      queue = queue.concat(tasks);
      nextTick();
    }

    queue = scheduler.queue = [];

    /* waitUntilQuiet does two things:
     * 1. It will run the FINAL `fn` value only when an uncanceled RAF has passed through
     * 2. It will delay the next wave of tasks from running until the quiet `fn` has run.
     *
     * The motivation here is that animation code can request more time from the scheduler
     * before the next wave runs. This allows for certain DOM properties such as classes to
     * be resolved in time for the next animation to run.
     */
    scheduler.waitUntilQuiet = function (fn) {
      if (cancelFn) cancelFn();

      cancelFn = $$rAF(function () {
        cancelFn = null;
        fn();
        nextTick();
      });
    };

    return scheduler;

    function nextTick() {
      if (!queue.length) return;

      var items = queue.shift();
      for (var i = 0; i < items.length; i++) {
        items[i]();
      }

      if (!cancelFn) {
        $$rAF(function () {
          if (!cancelFn) nextTick();
        });
      }
    }
  }],
      $$AnimateChildrenDirective = ['$interpolate', function ($interpolate) {
    return {
      link: function link(scope, element, attrs) {
        var val = attrs.ngAnimateChildren;
        if (isString(val) && val.length === 0) {
          //empty attribute
          element.data(NG_ANIMATE_CHILDREN_DATA, true);
        } else {
          // Interpolate and set the value, so that it is available to
          // animations that run right after compilation
          setData($interpolate(val)(scope));
          attrs.$observe('ngAnimateChildren', setData);
        }

        function setData(value) {
          value = value === 'on' || value === 'true';
          element.data(NG_ANIMATE_CHILDREN_DATA, value);
        }
      }
    };
  }],
      ANIMATE_TIMER_KEY = '$$animateCss',
      ONE_SECOND = 1000,
      BASE_TEN = 10,
      ELAPSED_TIME_MAX_DECIMAL_PLACES = 3,
      CLOSING_TIME_BUFFER = 1.5,
      DETECT_CSS_PROPERTIES = {
    transitionDuration: TRANSITION_DURATION_PROP,
    transitionDelay: TRANSITION_DELAY_PROP,
    transitionProperty: TRANSITION_PROP + PROPERTY_KEY,
    animationDuration: ANIMATION_DURATION_PROP,
    animationDelay: ANIMATION_DELAY_PROP,
    animationIterationCount: ANIMATION_PROP + ANIMATION_ITERATION_COUNT_KEY
  },
      DETECT_STAGGER_CSS_PROPERTIES = {
    transitionDuration: TRANSITION_DURATION_PROP,
    transitionDelay: TRANSITION_DELAY_PROP,
    animationDuration: ANIMATION_DURATION_PROP,
    animationDelay: ANIMATION_DELAY_PROP
  };

  /**
   * @ngdoc directive
   * @name ngAnimateChildren
   * @restrict AE
   * @element ANY
   *
   * @description
   *
   * ngAnimateChildren allows you to specify that children of this element should animate even if any
   * of the children's parents are currently animating. By default, when an element has an active `enter`, `leave`, or `move`
   * (structural) animation, child elements that also have an active structural animation are not animated.
   *
   * Note that even if `ngAnimteChildren` is set, no child animations will run when the parent element is removed from the DOM (`leave` animation).
   *
   *
   * @param {string} ngAnimateChildren If the value is empty, `true` or `on`,
   *     then child animations are allowed. If the value is `false`, child animations are not allowed.
   *
   * @example
   * <example module="ngAnimateChildren" name="ngAnimateChildren" deps="angular-animate.js" animations="true">
       <file name="index.html">
         <div ng-controller="mainController as main">
           <label>Show container? <input type="checkbox" ng-model="main.enterElement" /></label>
           <label>Animate children? <input type="checkbox" ng-model="main.animateChildren" /></label>
           <hr>
           <div ng-animate-children="{{main.animateChildren}}">
             <div ng-if="main.enterElement" class="container">
               List of items:
               <div ng-repeat="item in [0, 1, 2, 3]" class="item">Item {{item}}</div>
             </div>
           </div>
         </div>
       </file>
       <file name="animations.css">
  
        .container.ng-enter,
        .container.ng-leave {
          transition: all ease 1.5s;
        }
  
        .container.ng-enter,
        .container.ng-leave-active {
          opacity: 0;
        }
  
        .container.ng-leave,
        .container.ng-enter-active {
          opacity: 1;
        }
  
        .item {
          background: firebrick;
          color: #FFF;
          margin-bottom: 10px;
        }
  
        .item.ng-enter,
        .item.ng-leave {
          transition: transform 1.5s ease;
        }
  
        .item.ng-enter {
          transform: translateX(50px);
        }
  
        .item.ng-enter-active {
          transform: translateX(0);
        }
      </file>
      <file name="script.js">
        angular.module('ngAnimateChildren', ['ngAnimate'])
          .controller('mainController', function() {
            this.animateChildren = false;
            this.enterElement = false;
          });
      </file>
    </example>
   */


  /**
   * @ngdoc service
   * @name $animateCss
   * @kind object
   *
   * @description
   * The `$animateCss` service is a useful utility to trigger customized CSS-based transitions/keyframes
   * from a JavaScript-based animation or directly from a directive. The purpose of `$animateCss` is NOT
   * to side-step how `$animate` and ngAnimate work, but the goal is to allow pre-existing animations or
   * directives to create more complex animations that can be purely driven using CSS code.
   *
   * Note that only browsers that support CSS transitions and/or keyframe animations are capable of
   * rendering animations triggered via `$animateCss` (bad news for IE9 and lower).
   *
   * ## Usage
   * Once again, `$animateCss` is designed to be used inside of a registered JavaScript animation that
   * is powered by ngAnimate. It is possible to use `$animateCss` directly inside of a directive, however,
   * any automatic control over cancelling animations and/or preventing animations from being run on
   * child elements will not be handled by Angular. For this to work as expected, please use `$animate` to
   * trigger the animation and then setup a JavaScript animation that injects `$animateCss` to trigger
   * the CSS animation.
   *
   * The example below shows how we can create a folding animation on an element using `ng-if`:
   *
   * ```html
   * <!-- notice the `fold-animation` CSS class -->
   * <div ng-if="onOff" class="fold-animation">
   *   This element will go BOOM
   * </div>
   * <button ng-click="onOff=true">Fold In</button>
   * ```
   *
   * Now we create the **JavaScript animation** that will trigger the CSS transition:
   *
   * ```js
   * ngModule.animation('.fold-animation', ['$animateCss', function($animateCss) {
   *   return {
   *     enter: function(element, doneFn) {
   *       var height = element[0].offsetHeight;
   *       return $animateCss(element, {
   *         from: { height:'0px' },
   *         to: { height:height + 'px' },
   *         duration: 1 // one second
   *       });
   *     }
   *   }
   * }]);
   * ```
   *
   * ## More Advanced Uses
   *
   * `$animateCss` is the underlying code that ngAnimate uses to power **CSS-based animations** behind the scenes. Therefore CSS hooks
   * like `.ng-EVENT`, `.ng-EVENT-active`, `.ng-EVENT-stagger` are all features that can be triggered using `$animateCss` via JavaScript code.
   *
   * This also means that just about any combination of adding classes, removing classes, setting styles, dynamically setting a keyframe animation,
   * applying a hardcoded duration or delay value, changing the animation easing or applying a stagger animation are all options that work with
   * `$animateCss`. The service itself is smart enough to figure out the combination of options and examine the element styling properties in order
   * to provide a working animation that will run in CSS.
   *
   * The example below showcases a more advanced version of the `.fold-animation` from the example above:
   *
   * ```js
   * ngModule.animation('.fold-animation', ['$animateCss', function($animateCss) {
   *   return {
   *     enter: function(element, doneFn) {
   *       var height = element[0].offsetHeight;
   *       return $animateCss(element, {
   *         addClass: 'red large-text pulse-twice',
   *         easing: 'ease-out',
   *         from: { height:'0px' },
   *         to: { height:height + 'px' },
   *         duration: 1 // one second
   *       });
   *     }
   *   }
   * }]);
   * ```
   *
   * Since we're adding/removing CSS classes then the CSS transition will also pick those up:
   *
   * ```css
   * /&#42; since a hardcoded duration value of 1 was provided in the JavaScript animation code,
   * the CSS classes below will be transitioned despite them being defined as regular CSS classes &#42;/
   * .red { background:red; }
   * .large-text { font-size:20px; }
   *
   * /&#42; we can also use a keyframe animation and $animateCss will make it work alongside the transition &#42;/
   * .pulse-twice {
   *   animation: 0.5s pulse linear 2;
   *   -webkit-animation: 0.5s pulse linear 2;
   * }
   *
   * @keyframes pulse {
   *   from { transform: scale(0.5); }
   *   to { transform: scale(1.5); }
   * }
   *
   * @-webkit-keyframes pulse {
   *   from { -webkit-transform: scale(0.5); }
   *   to { -webkit-transform: scale(1.5); }
   * }
   * ```
   *
   * Given this complex combination of CSS classes, styles and options, `$animateCss` will figure everything out and make the animation happen.
   *
   * ## How the Options are handled
   *
   * `$animateCss` is very versatile and intelligent when it comes to figuring out what configurations to apply to the element to ensure the animation
   * works with the options provided. Say for example we were adding a class that contained a keyframe value and we wanted to also animate some inline
   * styles using the `from` and `to` properties.
   *
   * ```js
   * var animator = $animateCss(element, {
   *   from: { background:'red' },
   *   to: { background:'blue' }
   * });
   * animator.start();
   * ```
   *
   * ```css
   * .rotating-animation {
   *   animation:0.5s rotate linear;
   *   -webkit-animation:0.5s rotate linear;
   * }
   *
   * @keyframes rotate {
   *   from { transform: rotate(0deg); }
   *   to { transform: rotate(360deg); }
   * }
   *
   * @-webkit-keyframes rotate {
   *   from { -webkit-transform: rotate(0deg); }
   *   to { -webkit-transform: rotate(360deg); }
   * }
   * ```
   *
   * The missing pieces here are that we do not have a transition set (within the CSS code nor within the `$animateCss` options) and the duration of the animation is
   * going to be detected from what the keyframe styles on the CSS class are. In this event, `$animateCss` will automatically create an inline transition
   * style matching the duration detected from the keyframe style (which is present in the CSS class that is being added) and then prepare both the transition
   * and keyframe animations to run in parallel on the element. Then when the animation is underway the provided `from` and `to` CSS styles will be applied
   * and spread across the transition and keyframe animation.
   *
   * ## What is returned
   *
   * `$animateCss` works in two stages: a preparation phase and an animation phase. Therefore when `$animateCss` is first called it will NOT actually
   * start the animation. All that is going on here is that the element is being prepared for the animation (which means that the generated CSS classes are
   * added and removed on the element). Once `$animateCss` is called it will return an object with the following properties:
   *
   * ```js
   * var animator = $animateCss(element, { ... });
   * ```
   *
   * Now what do the contents of our `animator` variable look like:
   *
   * ```js
   * {
   *   // starts the animation
   *   start: Function,
   *
   *   // ends (aborts) the animation
   *   end: Function
   * }
   * ```
   *
   * To actually start the animation we need to run `animation.start()` which will then return a promise that we can hook into to detect when the animation ends.
   * If we choose not to run the animation then we MUST run `animation.end()` to perform a cleanup on the element (since some CSS classes and styles may have been
   * applied to the element during the preparation phase). Note that all other properties such as duration, delay, transitions and keyframes are just properties
   * and that changing them will not reconfigure the parameters of the animation.
   *
   * ### runner.done() vs runner.then()
   * It is documented that `animation.start()` will return a promise object and this is true, however, there is also an additional method available on the
   * runner called `.done(callbackFn)`. The done method works the same as `.finally(callbackFn)`, however, it does **not trigger a digest to occur**.
   * Therefore, for performance reasons, it's always best to use `runner.done(callback)` instead of `runner.then()`, `runner.catch()` or `runner.finally()`
   * unless you really need a digest to kick off afterwards.
   *
   * Keep in mind that, to make this easier, ngAnimate has tweaked the JS animations API to recognize when a runner instance is returned from $animateCss
   * (so there is no need to call `runner.done(doneFn)` inside of your JavaScript animation code).
   * Check the {@link ngAnimate.$animateCss#usage animation code above} to see how this works.
   *
   * @param {DOMElement} element the element that will be animated
   * @param {object} options the animation-related options that will be applied during the animation
   *
   * * `event` - The DOM event (e.g. enter, leave, move). When used, a generated CSS class of `ng-EVENT` and `ng-EVENT-active` will be applied
   * to the element during the animation. Multiple events can be provided when spaces are used as a separator. (Note that this will not perform any DOM operation.)
   * * `structural` - Indicates that the `ng-` prefix will be added to the event class. Setting to `false` or omitting will turn `ng-EVENT` and
   * `ng-EVENT-active` in `EVENT` and `EVENT-active`. Unused if `event` is omitted.
   * * `easing` - The CSS easing value that will be applied to the transition or keyframe animation (or both).
   * * `transitionStyle` - The raw CSS transition style that will be used (e.g. `1s linear all`).
   * * `keyframeStyle` - The raw CSS keyframe animation style that will be used (e.g. `1s my_animation linear`).
   * * `from` - The starting CSS styles (a key/value object) that will be applied at the start of the animation.
   * * `to` - The ending CSS styles (a key/value object) that will be applied across the animation via a CSS transition.
   * * `addClass` - A space separated list of CSS classes that will be added to the element and spread across the animation.
   * * `removeClass` - A space separated list of CSS classes that will be removed from the element and spread across the animation.
   * * `duration` - A number value representing the total duration of the transition and/or keyframe (note that a value of 1 is 1000ms). If a value of `0`
   * is provided then the animation will be skipped entirely.
   * * `delay` - A number value representing the total delay of the transition and/or keyframe (note that a value of 1 is 1000ms). If a value of `true` is
   * used then whatever delay value is detected from the CSS classes will be mirrored on the elements styles (e.g. by setting delay true then the style value
   * of the element will be `transition-delay: DETECTED_VALUE`). Using `true` is useful when you want the CSS classes and inline styles to all share the same
   * CSS delay value.
   * * `stagger` - A numeric time value representing the delay between successively animated elements
   * ({@link ngAnimate#css-staggering-animations Click here to learn how CSS-based staggering works in ngAnimate.})
   * * `staggerIndex` - The numeric index representing the stagger item (e.g. a value of 5 is equal to the sixth item in the stagger; therefore when a
   *   `stagger` option value of `0.1` is used then there will be a stagger delay of `600ms`)
   * * `applyClassesEarly` - Whether or not the classes being added or removed will be used when detecting the animation. This is set by `$animate` when enter/leave/move animations are fired to ensure that the CSS classes are resolved in time. (Note that this will prevent any transitions from occurring on the classes being added and removed.)
   * * `cleanupStyles` - Whether or not the provided `from` and `to` styles will be removed once
   *    the animation is closed. This is useful for when the styles are used purely for the sake of
   *    the animation and do not have a lasting visual effect on the element (e.g. a collapse and open animation).
   *    By default this value is set to `false`.
   *
   * @return {object} an object with start and end methods and details about the animation.
   *
   * * `start` - The method to start the animation. This will return a `Promise` when called.
   * * `end` - This method will cancel the animation and remove all applied CSS classes and styles.
   */


  function getCssKeyframeDurationStyle(duration) {
    return [ANIMATION_DURATION_PROP, duration + 's'];
  }

  function getCssDelayStyle(delay, isKeyframeAnimation) {
    var prop = isKeyframeAnimation ? ANIMATION_DELAY_PROP : TRANSITION_DELAY_PROP;
    return [prop, delay + 's'];
  }

  function computeCssStyles($window, element, properties) {
    var styles = Object.create(null),
        detectedStyles = $window.getComputedStyle(element) || {};

    forEach(properties, function (formalStyleName, actualStyleName) {
      var val = detectedStyles[formalStyleName];
      if (val) {
        var c = val.charAt(0);

        // only numerical-based values have a negative sign or digit as the first value
        if (c === '-' || c === '+' || c >= 0) {
          val = parseMaxTime(val);
        }

        // by setting this to null in the event that the delay is not set or is set directly as 0
        // then we can still allow for negative values to be used later on and not mistake this
        // value for being greater than any other negative value.
        if (val === 0) {
          val = null;
        }
        styles[actualStyleName] = val;
      }
    });

    return styles;
  }

  function parseMaxTime(str) {
    var maxValue = 0,
        values = str.split(/\s*,\s*/);

    forEach(values, function (value) {
      // it's always safe to consider only second values and omit `ms` values since
      // getComputedStyle will always handle the conversion for us
      if (value.charAt(value.length - 1) == 's') {
        value = value.substring(0, value.length - 1);
      }
      value = parseFloat(value) || 0;
      maxValue = maxValue ? Math.max(value, maxValue) : value;
    });
    return maxValue;
  }

  function truthyTimingValue(val) {
    return val === 0 || val != null;
  }

  function getCssTransitionDurationStyle(duration, applyOnlyDuration) {
    var style = TRANSITION_PROP,
        value = duration + 's';

    if (applyOnlyDuration) {
      style += DURATION_KEY;
    } else {
      value += ' linear all';
    }
    return [style, value];
  }

  function createLocalCacheLookup() {
    var cache = Object.create(null);
    return {
      flush: function flush() {
        cache = Object.create(null);
      },

      count: function count(key) {
        var entry = cache[key];
        return entry ? entry.total : 0;
      },

      get: function get(key) {
        var entry = cache[key];
        return entry && entry.value;
      },

      put: function put(key, value) {
        if (!cache[key]) {
          cache[key] = { total: 1, value: value };
        } else {
          cache[key].total++;
        }
      }
    };
  }

  // we do not reassign an already present style value since
  // if we detect the style property value again we may be
  // detecting styles that were added via the `from` styles.
  // We make use of `isDefined` here since an empty string
  // or null value (which is what getPropertyValue will return
  // for a non-existing style) will still be marked as a valid
  // value for the style (a falsy value implies that the style
  // is to be removed at the end of the animation). If we had a simple
  // "OR" statement then it would not be enough to catch that.
  function registerRestorableStyles(backup, node, properties) {
    forEach(properties, function (prop) {
      backup[prop] = isDefined(backup[prop]) ? backup[prop] : node.style.getPropertyValue(prop);
    });
  }

  var $AnimateCssProvider = ['$animateProvider', function ($animateProvider) {
    var gcsLookup = createLocalCacheLookup(),
        gcsStaggerLookup = createLocalCacheLookup();


    this.$get = ['$window', '$$jqLite', '$$AnimateRunner', '$timeout', '$$forceReflow', '$sniffer', '$$rAFScheduler', '$$animateQueue', function ($window, $$jqLite, $$AnimateRunner, $timeout, $$forceReflow, $sniffer, $$rAFScheduler, $$animateQueue) {

      var applyAnimationClasses = applyAnimationClassesFactory($$jqLite),
          parentCounter = 0;

      function gcsHashFn(node, extraClasses) {
        var KEY = "$$ngAnimateParentKey",
            parentNode = node.parentNode,
            parentID = parentNode[KEY] || (parentNode[KEY] = ++parentCounter);

        return parentID + '-' + node.getAttribute('class') + '-' + extraClasses;
      }

      function computeCachedCssStyles(node, className, cacheKey, properties) {
        var timings = gcsLookup.get(cacheKey);

        if (!timings) {
          timings = computeCssStyles($window, node, properties);
          if (timings.animationIterationCount === 'infinite') {
            timings.animationIterationCount = 1;
          }
        }

        // we keep putting this in multiple times even though the value and the cacheKey are the same
        // because we're keeping an internal tally of how many duplicate animations are detected.
        gcsLookup.put(cacheKey, timings);
        return timings;
      }

      function computeCachedCssStaggerStyles(node, className, cacheKey, properties) {
        var stagger;

        // if we have one or more existing matches of matching elements
        // containing the same parent + CSS styles (which is how cacheKey works)
        // then staggering is possible
        if (gcsLookup.count(cacheKey) > 0) {
          stagger = gcsStaggerLookup.get(cacheKey);

          if (!stagger) {
            var staggerClassName = pendClasses(className, '-stagger');

            $$jqLite.addClass(node, staggerClassName);

            stagger = computeCssStyles($window, node, properties);

            // force the conversion of a null value to zero incase not set
            stagger.animationDuration = Math.max(stagger.animationDuration, 0);
            stagger.transitionDuration = Math.max(stagger.transitionDuration, 0);

            $$jqLite.removeClass(node, staggerClassName);

            gcsStaggerLookup.put(cacheKey, stagger);
          }
        }

        return stagger || {};
      }

      var cancelLastRAFRequest,
          rafWaitQueue = [];

      function waitUntilQuiet(callback) {
        rafWaitQueue.push(callback);
        $$rAFScheduler.waitUntilQuiet(function () {
          gcsLookup.flush();
          gcsStaggerLookup.flush();

          // DO NOT REMOVE THIS LINE OR REFACTOR OUT THE `pageWidth` variable.
          // PLEASE EXAMINE THE `$$forceReflow` service to understand why.
          var pageWidth = $$forceReflow();

          // we use a for loop to ensure that if the queue is changed
          // during this looping then it will consider new requests
          for (var i = 0; i < rafWaitQueue.length; i++) {
            rafWaitQueue[i](pageWidth);
          }
          rafWaitQueue.length = 0;
        });
      }

      function computeTimings(node, className, cacheKey) {
        var timings = computeCachedCssStyles(node, className, cacheKey, DETECT_CSS_PROPERTIES),
            aD = timings.animationDelay,
            tD = timings.transitionDelay;

        timings.maxDelay = aD && tD ? Math.max(aD, tD) : aD || tD;
        timings.maxDuration = Math.max(timings.animationDuration * timings.animationIterationCount, timings.transitionDuration);

        return timings;
      }

      return function init(element, initialOptions) {
        // all of the animation functions should create
        // a copy of the options data, however, if a
        // parent service has already created a copy then
        // we should stick to using that
        var options = initialOptions || {};
        if (!options.$$prepared) {
          options = prepareAnimationOptions(copy(options));
        }

        var restoreStyles = {},
            node = getDomNode(element);

        if (!node || !node.parentNode || !$$animateQueue.enabled()) {
          return closeAndReturnNoopAnimator();
        }

        var temporaryStyles = [],
            classes = element.attr('class'),
            styles = packageStyles(options),
            animationClosed,
            animationPaused,
            animationCompleted,
            runner,
            runnerHost,
            maxDelay,
            maxDelayTime,
            maxDuration,
            maxDurationTime,
            startTime,
            events = [];


        if (options.duration === 0 || !$sniffer.animations && !$sniffer.transitions) {
          return closeAndReturnNoopAnimator();
        }

        var method = options.event && isArray(options.event) ? options.event.join(' ') : options.event,
            isStructural = method && options.structural,
            structuralClassName = '',
            addRemoveClassName = '';

        if (isStructural) {
          structuralClassName = pendClasses(method, EVENT_CLASS_PREFIX, true);
        } else if (method) {
          structuralClassName = method;
        }

        if (options.addClass) {
          addRemoveClassName += pendClasses(options.addClass, ADD_CLASS_SUFFIX);
        }

        if (options.removeClass) {
          if (addRemoveClassName.length) {
            addRemoveClassName += ' ';
          }
          addRemoveClassName += pendClasses(options.removeClass, REMOVE_CLASS_SUFFIX);
        }

        // there may be a situation where a structural animation is combined together
        // with CSS classes that need to resolve before the animation is computed.
        // However this means that there is no explicit CSS code to block the animation
        // from happening (by setting 0s none in the class name). If this is the case
        // we need to apply the classes before the first rAF so we know to continue if
        // there actually is a detected transition or keyframe animation
        if (options.applyClassesEarly && addRemoveClassName.length) {
          applyAnimationClasses(element, options);
        }

        var preparationClasses = [structuralClassName, addRemoveClassName].join(' ').trim(),
            fullClassName = classes + ' ' + preparationClasses,
            activeClasses = pendClasses(preparationClasses, ACTIVE_CLASS_SUFFIX),
            hasToStyles = styles.to && Object.keys(styles.to).length > 0,
            containsKeyframeAnimation = (options.keyframeStyle || '').length > 0;


        // there is no way we can trigger an animation if no styles and
        // no classes are being applied which would then trigger a transition,
        // unless there a is raw keyframe value that is applied to the element.
        if (!containsKeyframeAnimation && !hasToStyles && !preparationClasses) {
          return closeAndReturnNoopAnimator();
        }

        var cacheKey, stagger;
        if (options.stagger > 0) {
          var staggerVal = parseFloat(options.stagger);
          stagger = {
            transitionDelay: staggerVal,
            animationDelay: staggerVal,
            transitionDuration: 0,
            animationDuration: 0
          };
        } else {
          cacheKey = gcsHashFn(node, fullClassName);
          stagger = computeCachedCssStaggerStyles(node, preparationClasses, cacheKey, DETECT_STAGGER_CSS_PROPERTIES);
        }

        if (!options.$$skipPreparationClasses) {
          $$jqLite.addClass(element, preparationClasses);
        }

        var applyOnlyDuration;

        if (options.transitionStyle) {
          var transitionStyle = [TRANSITION_PROP, options.transitionStyle];
          applyInlineStyle(node, transitionStyle);
          temporaryStyles.push(transitionStyle);
        }

        if (options.duration >= 0) {
          applyOnlyDuration = node.style[TRANSITION_PROP].length > 0;
          var durationStyle = getCssTransitionDurationStyle(options.duration, applyOnlyDuration);

          // we set the duration so that it will be picked up by getComputedStyle later
          applyInlineStyle(node, durationStyle);
          temporaryStyles.push(durationStyle);
        }

        if (options.keyframeStyle) {
          var keyframeStyle = [ANIMATION_PROP, options.keyframeStyle];
          applyInlineStyle(node, keyframeStyle);
          temporaryStyles.push(keyframeStyle);
        }

        var itemIndex = stagger ? options.staggerIndex >= 0 ? options.staggerIndex : gcsLookup.count(cacheKey) : 0,
            isFirst = itemIndex === 0;

        // this is a pre-emptive way of forcing the setup classes to be added and applied INSTANTLY
        // without causing any combination of transitions to kick in. By adding a negative delay value
        // it forces the setup class' transition to end immediately. We later then remove the negative
        // transition delay to allow for the transition to naturally do it's thing. The beauty here is
        // that if there is no transition defined then nothing will happen and this will also allow
        // other transitions to be stacked on top of each other without any chopping them out.
        if (isFirst && !options.skipBlocking) {
          blockTransitions(node, SAFE_FAST_FORWARD_DURATION_VALUE);
        }

        var timings = computeTimings(node, fullClassName, cacheKey),
            relativeDelay = timings.maxDelay;

        maxDelay = Math.max(relativeDelay, 0);
        maxDuration = timings.maxDuration;

        var flags = {};
        flags.hasTransitions = timings.transitionDuration > 0;
        flags.hasAnimations = timings.animationDuration > 0;
        flags.hasTransitionAll = flags.hasTransitions && timings.transitionProperty == 'all';
        flags.applyTransitionDuration = hasToStyles && (flags.hasTransitions && !flags.hasTransitionAll || flags.hasAnimations && !flags.hasTransitions);
        flags.applyAnimationDuration = options.duration && flags.hasAnimations;
        flags.applyTransitionDelay = truthyTimingValue(options.delay) && (flags.applyTransitionDuration || flags.hasTransitions);
        flags.applyAnimationDelay = truthyTimingValue(options.delay) && flags.hasAnimations;
        flags.recalculateTimingStyles = addRemoveClassName.length > 0;

        if (flags.applyTransitionDuration || flags.applyAnimationDuration) {
          maxDuration = options.duration ? parseFloat(options.duration) : maxDuration;

          if (flags.applyTransitionDuration) {
            flags.hasTransitions = true;
            timings.transitionDuration = maxDuration;
            applyOnlyDuration = node.style[TRANSITION_PROP + PROPERTY_KEY].length > 0;
            temporaryStyles.push(getCssTransitionDurationStyle(maxDuration, applyOnlyDuration));
          }

          if (flags.applyAnimationDuration) {
            flags.hasAnimations = true;
            timings.animationDuration = maxDuration;
            temporaryStyles.push(getCssKeyframeDurationStyle(maxDuration));
          }
        }

        if (maxDuration === 0 && !flags.recalculateTimingStyles) {
          return closeAndReturnNoopAnimator();
        }

        if (options.delay != null) {
          var delayStyle;
          if (typeof options.delay !== "boolean") {
            delayStyle = parseFloat(options.delay);
            // number in options.delay means we have to recalculate the delay for the closing timeout
            maxDelay = Math.max(delayStyle, 0);
          }

          if (flags.applyTransitionDelay) {
            temporaryStyles.push(getCssDelayStyle(delayStyle));
          }

          if (flags.applyAnimationDelay) {
            temporaryStyles.push(getCssDelayStyle(delayStyle, true));
          }
        }

        // we need to recalculate the delay value since we used a pre-emptive negative
        // delay value and the delay value is required for the final event checking. This
        // property will ensure that this will happen after the RAF phase has passed.
        if (options.duration == null && timings.transitionDuration > 0) {
          flags.recalculateTimingStyles = flags.recalculateTimingStyles || isFirst;
        }

        maxDelayTime = maxDelay * ONE_SECOND;
        maxDurationTime = maxDuration * ONE_SECOND;
        if (!options.skipBlocking) {
          flags.blockTransition = timings.transitionDuration > 0;
          flags.blockKeyframeAnimation = timings.animationDuration > 0 && stagger.animationDelay > 0 && stagger.animationDuration === 0;
        }

        if (options.from) {
          if (options.cleanupStyles) {
            registerRestorableStyles(restoreStyles, node, Object.keys(options.from));
          }
          applyAnimationFromStyles(element, options);
        }

        if (flags.blockTransition || flags.blockKeyframeAnimation) {
          applyBlocking(maxDuration);
        } else if (!options.skipBlocking) {
          blockTransitions(node, false);
        }

        // TODO(matsko): for 1.5 change this code to have an animator object for better debugging
        return {
          $$willAnimate: true,
          end: endFn,
          start: function start() {
            if (animationClosed) return;

            runnerHost = {
              end: endFn,
              cancel: cancelFn,
              resume: null, //this will be set during the start() phase
              pause: null
            };

            runner = new $$AnimateRunner(runnerHost);

            waitUntilQuiet(_start);

            // we don't have access to pause/resume the animation
            // since it hasn't run yet. AnimateRunner will therefore
            // set noop functions for resume and pause and they will
            // later be overridden once the animation is triggered
            return runner;
          }
        };

        function endFn() {
          close();
        }

        function cancelFn() {
          close(true);
        }

        function close(rejected) {
          // jshint ignore:line
          // if the promise has been called already then we shouldn't close
          // the animation again
          if (animationClosed || animationCompleted && animationPaused) return;
          animationClosed = true;
          animationPaused = false;

          if (!options.$$skipPreparationClasses) {
            $$jqLite.removeClass(element, preparationClasses);
          }
          $$jqLite.removeClass(element, activeClasses);

          blockKeyframeAnimations(node, false);
          blockTransitions(node, false);

          forEach(temporaryStyles, function (entry) {
            // There is only one way to remove inline style properties entirely from elements.
            // By using `removeProperty` this works, but we need to convert camel-cased CSS
            // styles down to hyphenated values.
            node.style[entry[0]] = '';
          });

          applyAnimationClasses(element, options);
          applyAnimationStyles(element, options);

          if (Object.keys(restoreStyles).length) {
            forEach(restoreStyles, function (value, prop) {
              value ? node.style.setProperty(prop, value) : node.style.removeProperty(prop);
            });
          }

          // the reason why we have this option is to allow a synchronous closing callback
          // that is fired as SOON as the animation ends (when the CSS is removed) or if
          // the animation never takes off at all. A good example is a leave animation since
          // the element must be removed just after the animation is over or else the element
          // will appear on screen for one animation frame causing an overbearing flicker.
          if (options.onDone) {
            options.onDone();
          }

          if (events && events.length) {
            // Remove the transitionend / animationend listener(s)
            element.off(events.join(' '), onAnimationProgress);
          }

          //Cancel the fallback closing timeout and remove the timer data
          var animationTimerData = element.data(ANIMATE_TIMER_KEY);
          if (animationTimerData) {
            $timeout.cancel(animationTimerData[0].timer);
            element.removeData(ANIMATE_TIMER_KEY);
          }

          // if the preparation function fails then the promise is not setup
          if (runner) {
            runner.complete(!rejected);
          }
        }

        function applyBlocking(duration) {
          if (flags.blockTransition) {
            blockTransitions(node, duration);
          }

          if (flags.blockKeyframeAnimation) {
            blockKeyframeAnimations(node, !!duration);
          }
        }

        function closeAndReturnNoopAnimator() {
          runner = new $$AnimateRunner({
            end: endFn,
            cancel: cancelFn
          });

          // should flush the cache animation
          waitUntilQuiet(noop);
          close();

          return {
            $$willAnimate: false,
            start: function start() {
              return runner;
            },
            end: endFn
          };
        }

        function onAnimationProgress(event) {
          event.stopPropagation();
          var ev = event.originalEvent || event,
              timeStamp = ev.$manualTimeStamp || Date.now(),
              elapsedTime = parseFloat(ev.elapsedTime.toFixed(ELAPSED_TIME_MAX_DECIMAL_PLACES));

          // we now always use `Date.now()` due to the recent changes with
          // event.timeStamp in Firefox, Webkit and Chrome (see #13494 for more info)


          /* Firefox (or possibly just Gecko) likes to not round values up
           * when a ms measurement is used for the animation */


          /* $manualTimeStamp is a mocked timeStamp value which is set
           * within browserTrigger(). This is only here so that tests can
           * mock animations properly. Real events fallback to event.timeStamp,
           * or, if they don't, then a timeStamp is automatically created for them.
           * We're checking to see if the timeStamp surpasses the expected delay,
           * but we're using elapsedTime instead of the timeStamp on the 2nd
           * pre-condition since animationPauseds sometimes close off early */
          if (Math.max(timeStamp - startTime, 0) >= maxDelayTime && elapsedTime >= maxDuration) {
            // we set this flag to ensure that if the transition is paused then, when resumed,
            // the animation will automatically close itself since transitions cannot be paused.
            animationCompleted = true;
            close();
          }
        }

        function _start() {
          if (animationClosed) return;
          if (!node.parentNode) {
            close();
            return;
          }

          // even though we only pause keyframe animations here the pause flag
          // will still happen when transitions are used. Only the transition will
          // not be paused since that is not possible. If the animation ends when
          // paused then it will not complete until unpaused or cancelled.
          var playPause = function playPause(playAnimation) {
            if (!animationCompleted) {
              animationPaused = !playAnimation;
              if (timings.animationDuration) {
                var value = blockKeyframeAnimations(node, animationPaused);
                animationPaused ? temporaryStyles.push(value) : removeFromArray(temporaryStyles, value);
              }
            } else if (animationPaused && playAnimation) {
              animationPaused = false;
              close();
            }
          },
              maxStagger = itemIndex > 0 && (timings.transitionDuration && stagger.transitionDuration === 0 || timings.animationDuration && stagger.animationDuration === 0) && Math.max(stagger.animationDelay, stagger.transitionDelay);

          // checking the stagger duration prevents an accidentally cascade of the CSS delay style
          // being inherited from the parent. If the transition duration is zero then we can safely
          // rely that the delay value is an intentional stagger delay style.

          if (maxStagger) {
            $timeout(triggerAnimationStart, Math.floor(maxStagger * itemIndex * ONE_SECOND), false);
          } else {
            triggerAnimationStart();
          }

          // this will decorate the existing promise runner with pause/resume methods
          runnerHost.resume = function () {
            playPause(true);
          };

          runnerHost.pause = function () {
            playPause(false);
          };

          function triggerAnimationStart() {
            // just incase a stagger animation kicks in when the animation
            // itself was cancelled entirely
            if (animationClosed) return;

            applyBlocking(false);

            forEach(temporaryStyles, function (entry) {
              var key = entry[0],
                  value = entry[1];

              node.style[key] = value;
            });

            applyAnimationClasses(element, options);
            $$jqLite.addClass(element, activeClasses);

            if (flags.recalculateTimingStyles) {
              fullClassName = node.className + ' ' + preparationClasses;
              cacheKey = gcsHashFn(node, fullClassName);

              timings = computeTimings(node, fullClassName, cacheKey);
              relativeDelay = timings.maxDelay;
              maxDelay = Math.max(relativeDelay, 0);
              maxDuration = timings.maxDuration;

              if (maxDuration === 0) {
                close();
                return;
              }

              flags.hasTransitions = timings.transitionDuration > 0;
              flags.hasAnimations = timings.animationDuration > 0;
            }

            if (flags.applyAnimationDelay) {
              relativeDelay = typeof options.delay !== "boolean" && truthyTimingValue(options.delay) ? parseFloat(options.delay) : relativeDelay;

              maxDelay = Math.max(relativeDelay, 0);
              timings.animationDelay = relativeDelay;
              delayStyle = getCssDelayStyle(relativeDelay, true);
              temporaryStyles.push(delayStyle);
              node.style[delayStyle[0]] = delayStyle[1];
            }

            maxDelayTime = maxDelay * ONE_SECOND;
            maxDurationTime = maxDuration * ONE_SECOND;

            if (options.easing) {
              var easeProp,
                  easeVal = options.easing;
              if (flags.hasTransitions) {
                easeProp = TRANSITION_PROP + TIMING_KEY;
                temporaryStyles.push([easeProp, easeVal]);
                node.style[easeProp] = easeVal;
              }
              if (flags.hasAnimations) {
                easeProp = ANIMATION_PROP + TIMING_KEY;
                temporaryStyles.push([easeProp, easeVal]);
                node.style[easeProp] = easeVal;
              }
            }

            if (timings.transitionDuration) {
              events.push(TRANSITIONEND_EVENT);
            }

            if (timings.animationDuration) {
              events.push(ANIMATIONEND_EVENT);
            }

            startTime = Date.now();
            var timerTime = maxDelayTime + CLOSING_TIME_BUFFER * maxDurationTime,
                endTime = startTime + timerTime,
                animationsData = element.data(ANIMATE_TIMER_KEY) || [],
                setupFallbackTimer = true;

            if (animationsData.length) {
              var currentTimerData = animationsData[0];
              setupFallbackTimer = endTime > currentTimerData.expectedEndTime;
              if (setupFallbackTimer) {
                $timeout.cancel(currentTimerData.timer);
              } else {
                animationsData.push(close);
              }
            }

            if (setupFallbackTimer) {
              var timer = $timeout(onAnimationExpired, timerTime, false);
              animationsData[0] = {
                timer: timer,
                expectedEndTime: endTime
              };
              animationsData.push(close);
              element.data(ANIMATE_TIMER_KEY, animationsData);
            }

            if (events.length) {
              element.on(events.join(' '), onAnimationProgress);
            }

            if (options.to) {
              if (options.cleanupStyles) {
                registerRestorableStyles(restoreStyles, node, Object.keys(options.to));
              }
              applyAnimationToStyles(element, options);
            }
          }

          function onAnimationExpired() {
            var animationsData = element.data(ANIMATE_TIMER_KEY);

            // this will be false in the event that the element was
            // removed from the DOM (via a leave animation or something
            // similar)
            if (animationsData) {
              for (var i = 1; i < animationsData.length; i++) {
                animationsData[i]();
              }
              element.removeData(ANIMATE_TIMER_KEY);
            }
          }
        }
      };
    }];
  }],
      $$AnimateCssDriverProvider = ['$$animationProvider', function ($$animationProvider) {
    $$animationProvider.drivers.push('$$animateCssDriver');

    var NG_ANIMATE_SHIM_CLASS_NAME = 'ng-animate-shim',
        NG_ANIMATE_ANCHOR_CLASS_NAME = 'ng-anchor',
        NG_OUT_ANCHOR_CLASS_NAME = 'ng-anchor-out',
        NG_IN_ANCHOR_CLASS_NAME = 'ng-anchor-in';


    function isDocumentFragment(node) {
      return node.parentNode && node.parentNode.nodeType === 11;
    }

    this.$get = ['$animateCss', '$rootScope', '$$AnimateRunner', '$rootElement', '$sniffer', '$$jqLite', '$document', function ($animateCss, $rootScope, $$AnimateRunner, $rootElement, $sniffer, $$jqLite, $document) {

      // only browsers that support these properties can render animations
      if (!$sniffer.animations && !$sniffer.transitions) return noop;

      var bodyNode = $document[0].body,
          rootNode = getDomNode($rootElement),
          rootBodyElement = jqLite(
      // this is to avoid using something that exists outside of the body
      // we also special case the doc fragment case because our unit test code
      // appends the $rootElement to the body after the app has been bootstrapped
      isDocumentFragment(rootNode) || bodyNode.contains(rootNode) ? rootNode : bodyNode),
          applyAnimationClasses = applyAnimationClassesFactory($$jqLite);


      return function initDriverFn(animationDetails) {
        return animationDetails.from && animationDetails.to ? prepareFromToAnchorAnimation(animationDetails.from, animationDetails.to, animationDetails.classes, animationDetails.anchors) : prepareRegularAnimation(animationDetails);
      };

      function filterCssClasses(classes) {
        //remove all the `ng-` stuff
        return classes.replace(/\bng-\S+\b/g, '');
      }

      function getUniqueValues(a, b) {
        if (isString(a)) a = a.split(' ');
        if (isString(b)) b = b.split(' ');
        return a.filter(function (val) {
          return b.indexOf(val) === -1;
        }).join(' ');
      }

      function prepareAnchoredAnimation(classes, outAnchor, inAnchor) {
        var clone = jqLite(getDomNode(outAnchor).cloneNode(true)),
            startingClasses = filterCssClasses(getClassVal(clone));


        outAnchor.addClass(NG_ANIMATE_SHIM_CLASS_NAME);
        inAnchor.addClass(NG_ANIMATE_SHIM_CLASS_NAME);

        clone.addClass(NG_ANIMATE_ANCHOR_CLASS_NAME);

        rootBodyElement.append(clone);

        var animatorIn,
            animatorOut = prepareOutAnimation();

        // the user may not end up using the `out` animation and
        // only making use of the `in` animation or vice-versa.
        // In either case we should allow this and not assume the
        // animation is over unless both animations are not used.
        if (!animatorOut) {
          animatorIn = prepareInAnimation();
          if (!animatorIn) {
            return end();
          }
        }

        var startingAnimator = animatorOut || animatorIn;

        return {
          start: function start() {
            var runner,
                currentAnimation = startingAnimator.start();

            currentAnimation.done(function () {
              currentAnimation = null;
              if (!animatorIn) {
                animatorIn = prepareInAnimation();
                if (animatorIn) {
                  currentAnimation = animatorIn.start();
                  currentAnimation.done(function () {
                    currentAnimation = null;
                    end();
                    runner.complete();
                  });
                  return currentAnimation;
                }
              }
              // in the event that there is no `in` animation
              end();
              runner.complete();
            });

            runner = new $$AnimateRunner({
              end: endFn,
              cancel: endFn
            });

            return runner;

            function endFn() {
              if (currentAnimation) {
                currentAnimation.end();
              }
            }
          }
        };

        function calculateAnchorStyles(anchor) {
          var styles = {},
              coords = getDomNode(anchor).getBoundingClientRect();

          // we iterate directly since safari messes up and doesn't return
          // all the keys for the coords object when iterated
          forEach(['width', 'height', 'top', 'left'], function (key) {
            var value = coords[key];
            switch (key) {
              case 'top':
                value += bodyNode.scrollTop;
                break;
              case 'left':
                value += bodyNode.scrollLeft;
                break;
            }
            styles[key] = Math.floor(value) + 'px';
          });
          return styles;
        }

        function prepareOutAnimation() {
          var animator = $animateCss(clone, {
            addClass: NG_OUT_ANCHOR_CLASS_NAME,
            delay: true,
            from: calculateAnchorStyles(outAnchor)
          });

          // read the comment within `prepareRegularAnimation` to understand
          // why this check is necessary
          return animator.$$willAnimate ? animator : null;
        }

        function getClassVal(element) {
          return element.attr('class') || '';
        }

        function prepareInAnimation() {
          var endingClasses = filterCssClasses(getClassVal(inAnchor)),
              toAdd = getUniqueValues(endingClasses, startingClasses),
              toRemove = getUniqueValues(startingClasses, endingClasses),
              animator = $animateCss(clone, {
            to: calculateAnchorStyles(inAnchor),
            addClass: NG_IN_ANCHOR_CLASS_NAME + ' ' + toAdd,
            removeClass: NG_OUT_ANCHOR_CLASS_NAME + ' ' + toRemove,
            delay: true
          });


          // read the comment within `prepareRegularAnimation` to understand
          // why this check is necessary
          return animator.$$willAnimate ? animator : null;
        }

        function end() {
          clone.remove();
          outAnchor.removeClass(NG_ANIMATE_SHIM_CLASS_NAME);
          inAnchor.removeClass(NG_ANIMATE_SHIM_CLASS_NAME);
        }
      }

      function prepareFromToAnchorAnimation(from, to, classes, anchors) {
        var fromAnimation = prepareRegularAnimation(from, noop),
            toAnimation = prepareRegularAnimation(to, noop),
            anchorAnimations = [];

        forEach(anchors, function (anchor) {
          var outElement = anchor['out'],
              inElement = anchor['in'],
              animator = prepareAnchoredAnimation(classes, outElement, inElement);

          if (animator) {
            anchorAnimations.push(animator);
          }
        });

        // no point in doing anything when there are no elements to animate
        if (!fromAnimation && !toAnimation && anchorAnimations.length === 0) return;

        return {
          start: function start() {
            var animationRunners = [];

            if (fromAnimation) {
              animationRunners.push(fromAnimation.start());
            }

            if (toAnimation) {
              animationRunners.push(toAnimation.start());
            }

            forEach(anchorAnimations, function (animation) {
              animationRunners.push(animation.start());
            });

            var runner = new $$AnimateRunner({
              end: endFn,
              cancel: endFn // CSS-driven animations cannot be cancelled, only ended
            });

            $$AnimateRunner.all(animationRunners, function (status) {
              runner.complete(status);
            });

            return runner;

            function endFn() {
              forEach(animationRunners, function (runner) {
                runner.end();
              });
            }
          }
        };
      }

      function prepareRegularAnimation(animationDetails) {
        var element = animationDetails.element,
            options = animationDetails.options || {};


        if (animationDetails.structural) {
          options.event = animationDetails.event;
          options.structural = true;
          options.applyClassesEarly = true;

          // we special case the leave animation since we want to ensure that
          // the element is removed as soon as the animation is over. Otherwise
          // a flicker might appear or the element may not be removed at all
          if (animationDetails.event === 'leave') {
            options.onDone = options.domOperation;
          }
        }

        // We assign the preparationClasses as the actual animation event since
        // the internals of $animateCss will just suffix the event token values
        // with `-active` to trigger the animation.
        if (options.preparationClasses) {
          options.event = concatWithSpace(options.event, options.preparationClasses);
        }

        var animator = $animateCss(element, options);

        // the driver lookup code inside of $$animation attempts to spawn a
        // driver one by one until a driver returns a.$$willAnimate animator object.
        // $animateCss will always return an object, however, it will pass in
        // a flag as a hint as to whether an animation was detected or not
        return animator.$$willAnimate ? animator : null;
      }
    }];
  }],
      $$AnimateJsProvider = ['$animateProvider', function ($animateProvider) {
    this.$get = ['$injector', '$$AnimateRunner', '$$jqLite', function ($injector, $$AnimateRunner, $$jqLite) {

      var applyAnimationClasses = applyAnimationClassesFactory($$jqLite);
      // $animateJs(element, 'enter');
      return function (element, event, classes, options) {
        var animationClosed = false;

        // the `classes` argument is optional and if it is not used
        // then the classes will be resolved from the element's className
        // property as well as options.addClass/options.removeClass.
        if (arguments.length === 3 && isObject(classes)) {
          options = classes;
          classes = null;
        }

        options = prepareAnimationOptions(options);
        if (!classes) {
          classes = element.attr('class') || '';
          if (options.addClass) {
            classes += ' ' + options.addClass;
          }
          if (options.removeClass) {
            classes += ' ' + options.removeClass;
          }
        }

        var classesToAdd = options.addClass,
            classesToRemove = options.removeClass,
            animations = lookupAnimations(classes),
            before,
            after;

        // the lookupAnimations function returns a series of animation objects that are
        // matched up with one or more of the CSS classes. These animation objects are
        // defined via the module.animation factory function. If nothing is detected then
        // we don't return anything which then makes $animation query the next driver.

        if (animations.length) {
          var afterFn, beforeFn;
          if (event == 'leave') {
            beforeFn = 'leave';
            afterFn = 'afterLeave'; // TODO(matsko): get rid of this
          } else {
            beforeFn = 'before' + event.charAt(0).toUpperCase() + event.substr(1);
            afterFn = event;
          }

          if (event !== 'enter' && event !== 'move') {
            before = packageAnimations(element, event, options, animations, beforeFn);
          }
          after = packageAnimations(element, event, options, animations, afterFn);
        }

        // no matching animations
        if (!before && !after) return;

        function applyOptions() {
          options.domOperation();
          applyAnimationClasses(element, options);
        }

        function close() {
          animationClosed = true;
          applyOptions();
          applyAnimationStyles(element, options);
        }

        var runner;

        return {
          $$willAnimate: true,
          end: function end() {
            if (runner) {
              runner.end();
            } else {
              close();
              runner = new $$AnimateRunner();
              runner.complete(true);
            }
            return runner;
          },
          start: function start() {
            if (runner) {
              return runner;
            }

            runner = new $$AnimateRunner();
            var closeActiveAnimations,
                chain = [];


            if (before) {
              chain.push(function (fn) {
                closeActiveAnimations = before(fn);
              });
            }

            if (chain.length) {
              chain.push(function (fn) {
                applyOptions();
                fn(true);
              });
            } else {
              applyOptions();
            }

            if (after) {
              chain.push(function (fn) {
                closeActiveAnimations = after(fn);
              });
            }

            runner.setHost({
              end: function end() {
                endAnimations();
              },
              cancel: function cancel() {
                endAnimations(true);
              }
            });

            $$AnimateRunner.chain(chain, onComplete);
            return runner;

            function onComplete(success) {
              close(success);
              runner.complete(success);
            }

            function endAnimations(cancelled) {
              if (!animationClosed) {
                (closeActiveAnimations || noop)(cancelled);
                onComplete(cancelled);
              }
            }
          }
        };

        function executeAnimationFn(fn, element, event, options, onDone) {
          var args;
          switch (event) {
            case 'animate':
              args = [element, options.from, options.to, onDone];
              break;

            case 'setClass':
              args = [element, classesToAdd, classesToRemove, onDone];
              break;

            case 'addClass':
              args = [element, classesToAdd, onDone];
              break;

            case 'removeClass':
              args = [element, classesToRemove, onDone];
              break;

            default:
              args = [element, onDone];
              break;
          }

          args.push(options);

          var value = fn.apply(fn, args);
          if (value) {
            if (isFunction(value.start)) {
              value = value.start();
            }

            if (value instanceof $$AnimateRunner) {
              value.done(onDone);
            } else if (isFunction(value)) {
              // optional onEnd / onCancel callback
              return value;
            }
          }

          return noop;
        }

        function groupEventedAnimations(element, event, options, animations, fnName) {
          var operations = [];
          forEach(animations, function (ani) {
            var animation = ani[fnName];
            if (!animation) return;

            // note that all of these animations will run in parallel
            operations.push(function () {
              var runner,
                  endProgressCb,
                  resolved = false,
                  onAnimationComplete = function onAnimationComplete(rejected) {
                if (!resolved) {
                  resolved = true;
                  (endProgressCb || noop)(rejected);
                  runner.complete(!rejected);
                }
              };


              runner = new $$AnimateRunner({
                end: function end() {
                  onAnimationComplete();
                },
                cancel: function cancel() {
                  onAnimationComplete(true);
                }
              });

              endProgressCb = executeAnimationFn(animation, element, event, options, function (result) {
                var cancelled = result === false;
                onAnimationComplete(cancelled);
              });

              return runner;
            });
          });

          return operations;
        }

        function packageAnimations(element, event, options, animations, fnName) {
          var operations = groupEventedAnimations(element, event, options, animations, fnName);
          if (operations.length === 0) {
            var a, b;
            if (fnName === 'beforeSetClass') {
              a = groupEventedAnimations(element, 'removeClass', options, animations, 'beforeRemoveClass');
              b = groupEventedAnimations(element, 'addClass', options, animations, 'beforeAddClass');
            } else if (fnName === 'setClass') {
              a = groupEventedAnimations(element, 'removeClass', options, animations, 'removeClass');
              b = groupEventedAnimations(element, 'addClass', options, animations, 'addClass');
            }

            if (a) {
              operations = operations.concat(a);
            }
            if (b) {
              operations = operations.concat(b);
            }
          }

          if (operations.length === 0) return;

          // TODO(matsko): add documentation
          return function startAnimation(callback) {
            var runners = [];
            if (operations.length) {
              forEach(operations, function (animateFn) {
                runners.push(animateFn());
              });
            }

            runners.length ? $$AnimateRunner.all(runners, callback) : callback();

            return function endFn(reject) {
              forEach(runners, function (runner) {
                reject ? runner.cancel() : runner.end();
              });
            };
          };
        }
      };

      function lookupAnimations(classes) {
        classes = isArray(classes) ? classes : classes.split(' ');
        var matches = [],
            flagMap = {};
        for (var i = 0; i < classes.length; i++) {
          var klass = classes[i],
              animationFactory = $animateProvider.$$registeredAnimations[klass];
          if (animationFactory && !flagMap[klass]) {
            matches.push($injector.get(animationFactory));
            flagMap[klass] = true;
          }
        }
        return matches;
      }
    }];
  }],
      $$AnimateJsDriverProvider = ['$$animationProvider', function ($$animationProvider) {
    $$animationProvider.drivers.push('$$animateJsDriver');
    this.$get = ['$$animateJs', '$$AnimateRunner', function ($$animateJs, $$AnimateRunner) {
      return function initDriverFn(animationDetails) {
        if (animationDetails.from && animationDetails.to) {
          var fromAnimation = prepareAnimation(animationDetails.from),
              toAnimation = prepareAnimation(animationDetails.to);

          if (!fromAnimation && !toAnimation) return;

          return {
            start: function start() {
              var animationRunners = [];

              if (fromAnimation) {
                animationRunners.push(fromAnimation.start());
              }

              if (toAnimation) {
                animationRunners.push(toAnimation.start());
              }

              $$AnimateRunner.all(animationRunners, done);

              var runner = new $$AnimateRunner({
                end: endFnFactory(),
                cancel: endFnFactory()
              });

              return runner;

              function endFnFactory() {
                return function () {
                  forEach(animationRunners, function (runner) {
                    // at this point we cannot cancel animations for groups just yet. 1.5+
                    runner.end();
                  });
                };
              }

              function done(status) {
                runner.complete(status);
              }
            }
          };
        } else {
          return prepareAnimation(animationDetails);
        }
      };

      function prepareAnimation(animationDetails) {
        // TODO(matsko): make sure to check for grouped animations and delegate down to normal animations
        var element = animationDetails.element,
            event = animationDetails.event,
            options = animationDetails.options,
            classes = animationDetails.classes;

        return $$animateJs(element, event, classes, options);
      }
    }];
  }],
      NG_ANIMATE_ATTR_NAME = 'data-ng-animate',
      NG_ANIMATE_PIN_DATA = '$ngAnimatePin',
      $$AnimateQueueProvider = ['$animateProvider', function ($animateProvider) {
    var PRE_DIGEST_STATE = 1,
        RUNNING_STATE = 2,
        ONE_SPACE = ' ',
        rules = this.rules = {
      skip: [],
      cancel: [],
      join: []
    };


    function makeTruthyCssClassMap(classString) {
      if (!classString) {
        return null;
      }

      var keys = classString.split(ONE_SPACE),
          map = Object.create(null);


      forEach(keys, function (key) {
        map[key] = true;
      });
      return map;
    }

    function hasMatchingClasses(newClassString, currentClassString) {
      if (newClassString && currentClassString) {
        var currentClassMap = makeTruthyCssClassMap(currentClassString);
        return newClassString.split(ONE_SPACE).some(function (className) {
          return currentClassMap[className];
        });
      }
    }

    function isAllowed(ruleType, element, currentAnimation, previousAnimation) {
      return rules[ruleType].some(function (fn) {
        return fn(element, currentAnimation, previousAnimation);
      });
    }

    function hasAnimationClasses(animation, and) {
      var a = (animation.addClass || '').length > 0,
          b = (animation.removeClass || '').length > 0;

      return and ? a && b : a || b;
    }

    rules.join.push(function (element, newAnimation, currentAnimation) {
      // if the new animation is class-based then we can just tack that on
      return !newAnimation.structural && hasAnimationClasses(newAnimation);
    });

    rules.skip.push(function (element, newAnimation, currentAnimation) {
      // there is no need to animate anything if no classes are being added and
      // there is no structural animation that will be triggered
      return !newAnimation.structural && !hasAnimationClasses(newAnimation);
    });

    rules.skip.push(function (element, newAnimation, currentAnimation) {
      // why should we trigger a new structural animation if the element will
      // be removed from the DOM anyway?
      return currentAnimation.event == 'leave' && newAnimation.structural;
    });

    rules.skip.push(function (element, newAnimation, currentAnimation) {
      // if there is an ongoing current animation then don't even bother running the class-based animation
      return currentAnimation.structural && currentAnimation.state === RUNNING_STATE && !newAnimation.structural;
    });

    rules.cancel.push(function (element, newAnimation, currentAnimation) {
      // there can never be two structural animations running at the same time
      return currentAnimation.structural && newAnimation.structural;
    });

    rules.cancel.push(function (element, newAnimation, currentAnimation) {
      // if the previous animation is already running, but the new animation will
      // be triggered, but the new animation is structural
      return currentAnimation.state === RUNNING_STATE && newAnimation.structural;
    });

    rules.cancel.push(function (element, newAnimation, currentAnimation) {
      // cancel the animation if classes added / removed in both animation cancel each other out,
      // but only if the current animation isn't structural

      if (currentAnimation.structural) return false;

      var nA = newAnimation.addClass,
          nR = newAnimation.removeClass,
          cA = currentAnimation.addClass,
          cR = currentAnimation.removeClass;


      // early detection to save the global CPU shortage :)
      if (isUndefined(nA) && isUndefined(nR) || isUndefined(cA) && isUndefined(cR)) {
        return false;
      }

      return hasMatchingClasses(nA, cR) || hasMatchingClasses(nR, cA);
    });

    this.$get = ['$$rAF', '$rootScope', '$rootElement', '$document', '$$HashMap', '$$animation', '$$AnimateRunner', '$templateRequest', '$$jqLite', '$$forceReflow', function ($$rAF, $rootScope, $rootElement, $document, $$HashMap, $$animation, $$AnimateRunner, $templateRequest, $$jqLite, $$forceReflow) {

      var activeAnimationsLookup = new $$HashMap(),
          disabledElementsLookup = new $$HashMap(),
          animationsEnabled = null;


      function postDigestTaskFactory() {
        var postDigestCalled = false;
        return function (fn) {
          // we only issue a call to postDigest before
          // it has first passed. This prevents any callbacks
          // from not firing once the animation has completed
          // since it will be out of the digest cycle.
          if (postDigestCalled) {
            fn();
          } else {
            $rootScope.$$postDigest(function () {
              postDigestCalled = true;
              fn();
            });
          }
        };
      }

      // Wait until all directive and route-related templates are downloaded and
      // compiled. The $templateRequest.totalPendingRequests variable keeps track of
      // all of the remote templates being currently downloaded. If there are no
      // templates currently downloading then the watcher will still fire anyway.
      var deregisterWatch = $rootScope.$watch(function () {
        return $templateRequest.totalPendingRequests === 0;
      }, function (isEmpty) {
        if (!isEmpty) return;
        deregisterWatch();

        // Now that all templates have been downloaded, $animate will wait until
        // the post digest queue is empty before enabling animations. By having two
        // calls to $postDigest calls we can ensure that the flag is enabled at the
        // very end of the post digest queue. Since all of the animations in $animate
        // use $postDigest, it's important that the code below executes at the end.
        // This basically means that the page is fully downloaded and compiled before
        // any animations are triggered.
        $rootScope.$$postDigest(function () {
          $rootScope.$$postDigest(function () {
            // we check for null directly in the event that the application already called
            // .enabled() with whatever arguments that it provided it with
            if (animationsEnabled === null) {
              animationsEnabled = true;
            }
          });
        });
      }),
          callbackRegistry = Object.create(null),
          classNameFilter = $animateProvider.classNameFilter(),
          isAnimatableClassName = !classNameFilter ? function () {
        return true;
      } : function (className) {
        return classNameFilter.test(className);
      },
          applyAnimationClasses = applyAnimationClassesFactory($$jqLite);

      // remember that the classNameFilter is set during the provider/config
      // stage therefore we can optimize here and setup a helper function


      function normalizeAnimationDetails(element, animation) {
        return mergeAnimationDetails(element, animation, {});
      }

      // IE9-11 has no method "contains" in SVG element and in Node.prototype. Bug #10259.
      var contains = window.Node.prototype.contains || function (arg) {
        // jshint bitwise: false
        return this === arg || !!(this.compareDocumentPosition(arg) & 16);
        // jshint bitwise: true
      };

      function findCallbacks(parent, element, event) {
        var targetNode = getDomNode(element),
            targetParentNode = getDomNode(parent),
            matches = [],
            entries = callbackRegistry[event];

        if (entries) {
          forEach(entries, function (entry) {
            if (contains.call(entry.node, targetNode)) {
              matches.push(entry.callback);
            } else if (event === 'leave' && contains.call(entry.node, targetParentNode)) {
              matches.push(entry.callback);
            }
          });
        }

        return matches;
      }

      function filterFromRegistry(list, matchContainer, matchCallback) {
        var containerNode = extractElementNode(matchContainer);
        return list.filter(function (entry) {
          var isMatch = entry.node === containerNode && (!matchCallback || entry.callback === matchCallback);
          return !isMatch;
        });
      }

      function cleanupEventListeners(phase, element) {
        if (phase === 'close' && !element[0].parentNode) {
          // If the element is not attached to a parentNode, it has been removed by
          // the domOperation, and we can safely remove the event callbacks
          $animate.off(element);
        }
      }

      var $animate = {
        on: function on(event, container, callback) {
          var node = extractElementNode(container);
          callbackRegistry[event] = callbackRegistry[event] || [];
          callbackRegistry[event].push({
            node: node,
            callback: callback
          });

          // Remove the callback when the element is removed from the DOM
          jqLite(container).on('$destroy', function () {
            var animationDetails = activeAnimationsLookup.get(node);

            if (!animationDetails) {
              // If there's an animation ongoing, the callback calling code will remove
              // the event listeners. If we'd remove here, the callbacks would be removed
              // before the animation ends
              $animate.off(event, container, callback);
            }
          });
        },

        off: function off(event, container, callback) {
          if (arguments.length === 1 && !isString(arguments[0])) {
            container = arguments[0];
            for (var eventType in callbackRegistry) {
              callbackRegistry[eventType] = filterFromRegistry(callbackRegistry[eventType], container);
            }

            return;
          }

          var entries = callbackRegistry[event];
          if (!entries) return;

          callbackRegistry[event] = arguments.length === 1 ? null : filterFromRegistry(entries, container, callback);
        },

        pin: function pin(element, parentElement) {
          assertArg(isElement(element), 'element', 'not an element');
          assertArg(isElement(parentElement), 'parentElement', 'not an element');
          element.data(NG_ANIMATE_PIN_DATA, parentElement);
        },

        push: function push(element, event, options, domOperation) {
          options = options || {};
          options.domOperation = domOperation;
          return queueAnimation(element, event, options);
        },

        // this method has four signatures:
        //  () - global getter
        //  (bool) - global setter
        //  (element) - element getter
        //  (element, bool) - element setter<F37>
        enabled: function enabled(element, bool) {
          var argCount = arguments.length;

          if (argCount === 0) {
            // () - Global getter
            bool = !!animationsEnabled;
          } else {
            var hasElement = isElement(element);

            if (!hasElement) {
              // (bool) - Global setter
              bool = animationsEnabled = !!element;
            } else {
              var node = getDomNode(element);

              if (argCount === 1) {
                // (element) - Element getter
                bool = !disabledElementsLookup.get(node);
              } else {
                // (element, bool) - Element setter
                disabledElementsLookup.put(node, !bool);
              }
            }
          }

          return bool;
        }
      };

      return $animate;

      function queueAnimation(element, event, initialOptions) {
        // we always make a copy of the options since
        // there should never be any side effects on
        // the input data when running `$animateCss`.
        var options = copy(initialOptions),
            node,
            parent;

        element = stripCommentsFromElement(element);
        if (element) {
          node = getDomNode(element);
          parent = element.parent();
        }

        options = prepareAnimationOptions(options);

        // we create a fake runner with a working promise.
        // These methods will become available after the digest has passed
        var runner = new $$AnimateRunner(),
            runInNextPostDigestOrNow = postDigestTaskFactory();

        // this is used to trigger callbacks in postDigest mode


        if (isArray(options.addClass)) {
          options.addClass = options.addClass.join(' ');
        }

        if (options.addClass && !isString(options.addClass)) {
          options.addClass = null;
        }

        if (isArray(options.removeClass)) {
          options.removeClass = options.removeClass.join(' ');
        }

        if (options.removeClass && !isString(options.removeClass)) {
          options.removeClass = null;
        }

        if (options.from && !isObject(options.from)) {
          options.from = null;
        }

        if (options.to && !isObject(options.to)) {
          options.to = null;
        }

        // there are situations where a directive issues an animation for
        // a jqLite wrapper that contains only comment nodes... If this
        // happens then there is no way we can perform an animation
        if (!node) {
          close();
          return runner;
        }

        var className = [node.className, options.addClass, options.removeClass].join(' ');
        if (!isAnimatableClassName(className)) {
          close();
          return runner;
        }

        var isStructural = ['enter', 'move', 'leave'].indexOf(event) >= 0,
            documentHidden = $document[0].hidden,
            skipAnimations = !animationsEnabled || documentHidden || disabledElementsLookup.get(node),
            existingAnimation = !skipAnimations && activeAnimationsLookup.get(node) || {},
            hasExistingAnimation = !!existingAnimation.state;

        // this is a hard disable of all animations for the application or on
        // the element itself, therefore  there is no need to continue further
        // past this point if not enabled
        // Animations are also disabled if the document is currently hidden (page is not visible
        // to the user), because browsers slow down or do not flush calls to requestAnimationFrame


        // there is no point in traversing the same collection of parent ancestors if a followup
        // animation will be run on the same element that already did all that checking work
        if (!skipAnimations && (!hasExistingAnimation || existingAnimation.state != PRE_DIGEST_STATE)) {
          skipAnimations = !areAnimationsAllowed(element, parent, event);
        }

        if (skipAnimations) {
          // Callbacks should fire even if the document is hidden (regression fix for issue #14120)
          if (documentHidden) notifyProgress(runner, event, 'start');
          close();
          if (documentHidden) notifyProgress(runner, event, 'close');
          return runner;
        }

        if (isStructural) {
          closeChildAnimations(element);
        }

        var newAnimation = {
          structural: isStructural,
          element: element,
          event: event,
          addClass: options.addClass,
          removeClass: options.removeClass,
          close: close,
          options: options,
          runner: runner
        };

        if (hasExistingAnimation) {
          var skipAnimationFlag = isAllowed('skip', element, newAnimation, existingAnimation);
          if (skipAnimationFlag) {
            if (existingAnimation.state === RUNNING_STATE) {
              close();
              return runner;
            } else {
              mergeAnimationDetails(element, existingAnimation, newAnimation);
              return existingAnimation.runner;
            }
          }
          var cancelAnimationFlag = isAllowed('cancel', element, newAnimation, existingAnimation);
          if (cancelAnimationFlag) {
            if (existingAnimation.state === RUNNING_STATE) {
              // this will end the animation right away and it is safe
              // to do so since the animation is already running and the
              // runner callback code will run in async
              existingAnimation.runner.end();
            } else if (existingAnimation.structural) {
              // this means that the animation is queued into a digest, but
              // hasn't started yet. Therefore it is safe to run the close
              // method which will call the runner methods in async.
              existingAnimation.close();
            } else {
              // this will merge the new animation options into existing animation options
              mergeAnimationDetails(element, existingAnimation, newAnimation);

              return existingAnimation.runner;
            }
          } else {
            // a joined animation means that this animation will take over the existing one
            // so an example would involve a leave animation taking over an enter. Then when
            // the postDigest kicks in the enter will be ignored.
            var joinAnimationFlag = isAllowed('join', element, newAnimation, existingAnimation);
            if (joinAnimationFlag) {
              if (existingAnimation.state === RUNNING_STATE) {
                normalizeAnimationDetails(element, newAnimation);
              } else {
                applyGeneratedPreparationClasses(element, isStructural ? event : null, options);

                event = newAnimation.event = existingAnimation.event;
                options = mergeAnimationDetails(element, existingAnimation, newAnimation);

                //we return the same runner since only the option values of this animation will
                //be fed into the `existingAnimation`.
                return existingAnimation.runner;
              }
            }
          }
        } else {
          // normalization in this case means that it removes redundant CSS classes that
          // already exist (addClass) or do not exist (removeClass) on the element
          normalizeAnimationDetails(element, newAnimation);
        }

        // when the options are merged and cleaned up we may end up not having to do
        // an animation at all, therefore we should check this before issuing a post
        // digest callback. Structural animations will always run no matter what.
        var isValidAnimation = newAnimation.structural;
        if (!isValidAnimation) {
          // animate (from/to) can be quickly checked first, otherwise we check if any classes are present
          isValidAnimation = newAnimation.event === 'animate' && Object.keys(newAnimation.options.to || {}).length > 0 || hasAnimationClasses(newAnimation);
        }

        if (!isValidAnimation) {
          close();
          clearElementAnimationState(element);
          return runner;
        }

        // the counter keeps track of cancelled animations
        var counter = (existingAnimation.counter || 0) + 1;
        newAnimation.counter = counter;

        markElementAnimationState(element, PRE_DIGEST_STATE, newAnimation);

        $rootScope.$$postDigest(function () {
          var animationDetails = activeAnimationsLookup.get(node),
              animationCancelled = !animationDetails;

          animationDetails = animationDetails || {};

          // if addClass/removeClass is called before something like enter then the
          // registered parent element may not be present. The code below will ensure
          // that a final value for parent element is obtained
          var parentElement = element.parent() || [],
              isValidAnimation = parentElement.length > 0 && (animationDetails.event === 'animate' || animationDetails.structural || hasAnimationClasses(animationDetails));

          // animate/structural/class-based animations all have requirements. Otherwise there
          // is no point in performing an animation. The parent node must also be set.


          // this means that the previous animation was cancelled
          // even if the follow-up animation is the same event
          if (animationCancelled || animationDetails.counter !== counter || !isValidAnimation) {
            // if another animation did not take over then we need
            // to make sure that the domOperation and options are
            // handled accordingly
            if (animationCancelled) {
              applyAnimationClasses(element, options);
              applyAnimationStyles(element, options);
            }

            // if the event changed from something like enter to leave then we do
            // it, otherwise if it's the same then the end result will be the same too
            if (animationCancelled || isStructural && animationDetails.event !== event) {
              options.domOperation();
              runner.end();
            }

            // in the event that the element animation was not cancelled or a follow-up animation
            // isn't allowed to animate from here then we need to clear the state of the element
            // so that any future animations won't read the expired animation data.
            if (!isValidAnimation) {
              clearElementAnimationState(element);
            }

            return;
          }

          // this combined multiple class to addClass / removeClass into a setClass event
          // so long as a structural event did not take over the animation
          event = !animationDetails.structural && hasAnimationClasses(animationDetails, true) ? 'setClass' : animationDetails.event;

          markElementAnimationState(element, RUNNING_STATE);
          var realRunner = $$animation(element, event, animationDetails.options);

          // this will update the runner's flow-control events based on
          // the `realRunner` object.
          runner.setHost(realRunner);
          notifyProgress(runner, event, 'start', {});

          realRunner.done(function (status) {
            close(!status);
            var animationDetails = activeAnimationsLookup.get(node);
            if (animationDetails && animationDetails.counter === counter) {
              clearElementAnimationState(getDomNode(element));
            }
            notifyProgress(runner, event, 'close', {});
          });
        });

        return runner;

        function notifyProgress(runner, event, phase, data) {
          runInNextPostDigestOrNow(function () {
            var callbacks = findCallbacks(parent, element, event);
            if (callbacks.length) {
              // do not optimize this call here to RAF because
              // we don't know how heavy the callback code here will
              // be and if this code is buffered then this can
              // lead to a performance regression.
              $$rAF(function () {
                forEach(callbacks, function (callback) {
                  callback(element, phase, data);
                });
                cleanupEventListeners(phase, element);
              });
            } else {
              cleanupEventListeners(phase, element);
            }
          });
          runner.progress(event, phase, data);
        }

        function close(reject) {
          // jshint ignore:line
          clearGeneratedClasses(element, options);
          applyAnimationClasses(element, options);
          applyAnimationStyles(element, options);
          options.domOperation();
          runner.complete(!reject);
        }
      }

      function closeChildAnimations(element) {
        var node = getDomNode(element),
            children = node.querySelectorAll('[' + NG_ANIMATE_ATTR_NAME + ']');

        forEach(children, function (child) {
          var state = parseInt(child.getAttribute(NG_ANIMATE_ATTR_NAME)),
              animationDetails = activeAnimationsLookup.get(child);

          if (animationDetails) {
            switch (state) {
              case RUNNING_STATE:
                animationDetails.runner.end();
              /* falls through */
              case PRE_DIGEST_STATE:
                activeAnimationsLookup.remove(child);
                break;
            }
          }
        });
      }

      function clearElementAnimationState(element) {
        var node = getDomNode(element);
        node.removeAttribute(NG_ANIMATE_ATTR_NAME);
        activeAnimationsLookup.remove(node);
      }

      function isMatchingElement(nodeOrElmA, nodeOrElmB) {
        return getDomNode(nodeOrElmA) === getDomNode(nodeOrElmB);
      }

      /**
       * This fn returns false if any of the following is true:
       * a) animations on any parent element are disabled, and animations on the element aren't explicitly allowed
       * b) a parent element has an ongoing structural animation, and animateChildren is false
       * c) the element is not a child of the body
       * d) the element is not a child of the $rootElement
       */
      function areAnimationsAllowed(element, parentElement, event) {
        var bodyElement = jqLite($document[0].body),
            bodyElementDetected = isMatchingElement(element, bodyElement) || element[0].nodeName === 'HTML',
            rootElementDetected = isMatchingElement(element, $rootElement),
            parentAnimationDetected = false,
            animateChildren,
            elementDisabled = disabledElementsLookup.get(getDomNode(element)),
            parentHost = jqLite.data(element[0], NG_ANIMATE_PIN_DATA);

        if (parentHost) {
          parentElement = parentHost;
        }

        parentElement = getDomNode(parentElement);

        while (parentElement) {
          if (!rootElementDetected) {
            // angular doesn't want to attempt to animate elements outside of the application
            // therefore we need to ensure that the rootElement is an ancestor of the current element
            rootElementDetected = isMatchingElement(parentElement, $rootElement);
          }

          if (parentElement.nodeType !== ELEMENT_NODE) {
            // no point in inspecting the #document element
            break;
          }

          var details = activeAnimationsLookup.get(parentElement) || {};
          // either an enter, leave or move animation will commence
          // therefore we can't allow any animations to take place
          // but if a parent animation is class-based then that's ok
          if (!parentAnimationDetected) {
            var parentElementDisabled = disabledElementsLookup.get(parentElement);

            if (parentElementDisabled === true && elementDisabled !== false) {
              // disable animations if the user hasn't explicitly enabled animations on the
              // current element
              elementDisabled = true;
              // element is disabled via parent element, no need to check anything else
              break;
            } else if (parentElementDisabled === false) {
              elementDisabled = false;
            }
            parentAnimationDetected = details.structural;
          }

          if (isUndefined(animateChildren) || animateChildren === true) {
            var value = jqLite.data(parentElement, NG_ANIMATE_CHILDREN_DATA);
            if (isDefined(value)) {
              animateChildren = value;
            }
          }

          // there is no need to continue traversing at this point
          if (parentAnimationDetected && animateChildren === false) break;

          if (!bodyElementDetected) {
            // we also need to ensure that the element is or will be a part of the body element
            // otherwise it is pointless to even issue an animation to be rendered
            bodyElementDetected = isMatchingElement(parentElement, bodyElement);
          }

          if (bodyElementDetected && rootElementDetected) {
            // If both body and root have been found, any other checks are pointless,
            // as no animation data should live outside the application
            break;
          }

          if (!rootElementDetected) {
            // If no rootElement is detected, check if the parentElement is pinned to another element
            parentHost = jqLite.data(parentElement, NG_ANIMATE_PIN_DATA);
            if (parentHost) {
              // The pin target element becomes the next parent element
              parentElement = getDomNode(parentHost);
              continue;
            }
          }

          parentElement = parentElement.parentNode;
        }

        var allowAnimation = (!parentAnimationDetected || animateChildren) && elementDisabled !== true;
        return allowAnimation && rootElementDetected && bodyElementDetected;
      }

      function markElementAnimationState(element, state, details) {
        details = details || {};
        details.state = state;

        var node = getDomNode(element);
        node.setAttribute(NG_ANIMATE_ATTR_NAME, state);

        var oldValue = activeAnimationsLookup.get(node),
            newValue = oldValue ? extend(oldValue, details) : details;

        activeAnimationsLookup.put(node, newValue);
      }
    }];
  }],
      $$AnimationProvider = ['$animateProvider', function ($animateProvider) {
    var NG_ANIMATE_REF_ATTR = 'ng-animate-ref',
        drivers = this.drivers = [],
        RUNNER_STORAGE_KEY = '$$animationRunner';

    function setRunner(element, runner) {
      element.data(RUNNER_STORAGE_KEY, runner);
    }

    function removeRunner(element) {
      element.removeData(RUNNER_STORAGE_KEY);
    }

    function getRunner(element) {
      return element.data(RUNNER_STORAGE_KEY);
    }

    this.$get = ['$$jqLite', '$rootScope', '$injector', '$$AnimateRunner', '$$HashMap', '$$rAFScheduler', function ($$jqLite, $rootScope, $injector, $$AnimateRunner, $$HashMap, $$rAFScheduler) {

      var animationQueue = [],
          applyAnimationClasses = applyAnimationClassesFactory($$jqLite);


      function sortAnimations(animations) {
        var tree = { children: [] },
            i,
            lookup = new $$HashMap();


        // this is done first beforehand so that the hashmap
        // is filled with a list of the elements that will be animated
        for (i = 0; i < animations.length; i++) {
          var animation = animations[i];
          lookup.put(animation.domNode, animations[i] = {
            domNode: animation.domNode,
            fn: animation.fn,
            children: []
          });
        }

        for (i = 0; i < animations.length; i++) {
          processNode(animations[i]);
        }

        return flatten(tree);

        function processNode(entry) {
          if (entry.processed) return entry;
          entry.processed = true;

          var elementNode = entry.domNode,
              parentNode = elementNode.parentNode;

          lookup.put(elementNode, entry);

          var parentEntry;
          while (parentNode) {
            parentEntry = lookup.get(parentNode);
            if (parentEntry) {
              if (!parentEntry.processed) {
                parentEntry = processNode(parentEntry);
              }
              break;
            }
            parentNode = parentNode.parentNode;
          }

          (parentEntry || tree).children.push(entry);
          return entry;
        }

        function flatten(tree) {
          var result = [],
              queue = [],
              i;


          for (i = 0; i < tree.children.length; i++) {
            queue.push(tree.children[i]);
          }

          var remainingLevelEntries = queue.length,
              nextLevelEntries = 0,
              row = [];


          for (i = 0; i < queue.length; i++) {
            var entry = queue[i];
            if (remainingLevelEntries <= 0) {
              remainingLevelEntries = nextLevelEntries;
              nextLevelEntries = 0;
              result.push(row);
              row = [];
            }
            row.push(entry.fn);
            entry.children.forEach(function (childEntry) {
              nextLevelEntries++;
              queue.push(childEntry);
            });
            remainingLevelEntries--;
          }

          if (row.length) {
            result.push(row);
          }

          return result;
        }
      }

      // TODO(matsko): document the signature in a better way
      return function (element, event, options) {
        options = prepareAnimationOptions(options);
        var isStructural = ['enter', 'move', 'leave'].indexOf(event) >= 0,
            runner = new $$AnimateRunner({
          end: function end() {
            close();
          },
          cancel: function cancel() {
            close(true);
          }
        });

        // there is no animation at the current moment, however
        // these runner methods will get later updated with the
        // methods leading into the driver's end/cancel methods
        // for now they just stop the animation from starting


        if (!drivers.length) {
          close();
          return runner;
        }

        setRunner(element, runner);

        var classes = mergeClasses(element.attr('class'), mergeClasses(options.addClass, options.removeClass)),
            tempClasses = options.tempClasses;

        if (tempClasses) {
          classes += ' ' + tempClasses;
          options.tempClasses = null;
        }

        var prepareClassName;
        if (isStructural) {
          prepareClassName = 'ng-' + event + PREPARE_CLASS_SUFFIX;
          $$jqLite.addClass(element, prepareClassName);
        }

        animationQueue.push({
          // this data is used by the postDigest code and passed into
          // the driver step function
          element: element,
          classes: classes,
          event: event,
          structural: isStructural,
          options: options,
          beforeStart: beforeStart,
          close: close
        });

        element.on('$destroy', handleDestroyedElement);

        // we only want there to be one function called within the post digest
        // block. This way we can group animations for all the animations that
        // were apart of the same postDigest flush call.
        if (animationQueue.length > 1) return runner;

        $rootScope.$$postDigest(function () {
          var animations = [];
          forEach(animationQueue, function (entry) {
            // the element was destroyed early on which removed the runner
            // form its storage. This means we can't animate this element
            // at all and it already has been closed due to destruction.
            if (getRunner(entry.element)) {
              animations.push(entry);
            } else {
              entry.close();
            }
          });

          // now any future animations will be in another postDigest
          animationQueue.length = 0;

          var groupedAnimations = groupAnimations(animations),
              toBeSortedAnimations = [];


          forEach(groupedAnimations, function (animationEntry) {
            toBeSortedAnimations.push({
              domNode: getDomNode(animationEntry.from ? animationEntry.from.element : animationEntry.element),
              fn: function triggerAnimationStart() {
                // it's important that we apply the `ng-animate` CSS class and the
                // temporary classes before we do any driver invoking since these
                // CSS classes may be required for proper CSS detection.
                animationEntry.beforeStart();

                var startAnimationFn,
                    closeFn = animationEntry.close,
                    targetElement = animationEntry.anchors ? animationEntry.from.element || animationEntry.to.element : animationEntry.element;

                // in the event that the element was removed before the digest runs or
                // during the RAF sequencing then we should not trigger the animation.


                if (getRunner(targetElement)) {
                  var operation = invokeFirstDriver(animationEntry);
                  if (operation) {
                    startAnimationFn = operation.start;
                  }
                }

                if (!startAnimationFn) {
                  closeFn();
                } else {
                  var animationRunner = startAnimationFn();
                  animationRunner.done(function (status) {
                    closeFn(!status);
                  });
                  updateAnimationRunners(animationEntry, animationRunner);
                }
              }
            });
          });

          // we need to sort each of the animations in order of parent to child
          // relationships. This ensures that the child classes are applied at the
          // right time.
          $$rAFScheduler(sortAnimations(toBeSortedAnimations));
        });

        return runner;

        // TODO(matsko): change to reference nodes
        function getAnchorNodes(node) {
          var SELECTOR = '[' + NG_ANIMATE_REF_ATTR + ']',
              items = node.hasAttribute(NG_ANIMATE_REF_ATTR) ? [node] : node.querySelectorAll(SELECTOR),
              anchors = [];

          forEach(items, function (node) {
            var attr = node.getAttribute(NG_ANIMATE_REF_ATTR);
            if (attr && attr.length) {
              anchors.push(node);
            }
          });
          return anchors;
        }

        function groupAnimations(animations) {
          var preparedAnimations = [],
              refLookup = {};

          forEach(animations, function (animation, index) {
            var element = animation.element,
                node = getDomNode(element),
                event = animation.event,
                enterOrMove = ['enter', 'move'].indexOf(event) >= 0,
                anchorNodes = animation.structural ? getAnchorNodes(node) : [];


            if (anchorNodes.length) {
              var direction = enterOrMove ? 'to' : 'from';

              forEach(anchorNodes, function (anchor) {
                var key = anchor.getAttribute(NG_ANIMATE_REF_ATTR);
                refLookup[key] = refLookup[key] || {};
                refLookup[key][direction] = {
                  animationID: index,
                  element: jqLite(anchor)
                };
              });
            } else {
              preparedAnimations.push(animation);
            }
          });

          var usedIndicesLookup = {},
              anchorGroups = {};

          forEach(refLookup, function (operations, key) {
            var from = operations.from,
                to = operations.to;


            if (!from || !to) {
              // only one of these is set therefore we can't have an
              // anchor animation since all three pieces are required
              var index = from ? from.animationID : to.animationID,
                  indexKey = index.toString();

              if (!usedIndicesLookup[indexKey]) {
                usedIndicesLookup[indexKey] = true;
                preparedAnimations.push(animations[index]);
              }
              return;
            }

            var fromAnimation = animations[from.animationID],
                toAnimation = animations[to.animationID],
                lookupKey = from.animationID.toString();

            if (!anchorGroups[lookupKey]) {
              var group = anchorGroups[lookupKey] = {
                structural: true,
                beforeStart: function beforeStart() {
                  fromAnimation.beforeStart();
                  toAnimation.beforeStart();
                },
                close: function close() {
                  fromAnimation.close();
                  toAnimation.close();
                },
                classes: cssClassesIntersection(fromAnimation.classes, toAnimation.classes),
                from: fromAnimation,
                to: toAnimation,
                anchors: [] // TODO(matsko): change to reference nodes
              };

              // the anchor animations require that the from and to elements both have at least
              // one shared CSS class which effectively marries the two elements together to use
              // the same animation driver and to properly sequence the anchor animation.
              if (group.classes.length) {
                preparedAnimations.push(group);
              } else {
                preparedAnimations.push(fromAnimation);
                preparedAnimations.push(toAnimation);
              }
            }

            anchorGroups[lookupKey].anchors.push({
              'out': from.element, 'in': to.element
            });
          });

          return preparedAnimations;
        }

        function cssClassesIntersection(a, b) {
          a = a.split(' ');
          b = b.split(' ');
          var matches = [];

          for (var i = 0; i < a.length; i++) {
            var aa = a[i];
            if (aa.substring(0, 3) === 'ng-') continue;

            for (var j = 0; j < b.length; j++) {
              if (aa === b[j]) {
                matches.push(aa);
                break;
              }
            }
          }

          return matches.join(' ');
        }

        function invokeFirstDriver(animationDetails) {
          // we loop in reverse order since the more general drivers (like CSS and JS)
          // may attempt more elements, but custom drivers are more particular
          for (var i = drivers.length - 1; i >= 0; i--) {
            var driverName = drivers[i],
                factory = $injector.get(driverName),
                driver = factory(animationDetails);

            if (driver) {
              return driver;
            }
          }
        }

        function beforeStart() {
          element.addClass(NG_ANIMATE_CLASSNAME);
          if (tempClasses) {
            $$jqLite.addClass(element, tempClasses);
          }
          if (prepareClassName) {
            $$jqLite.removeClass(element, prepareClassName);
            prepareClassName = null;
          }
        }

        function updateAnimationRunners(animation, newRunner) {
          if (animation.from && animation.to) {
            update(animation.from.element);
            update(animation.to.element);
          } else {
            update(animation.element);
          }

          function update(element) {
            var runner = getRunner(element);
            if (runner) runner.setHost(newRunner);
          }
        }

        function handleDestroyedElement() {
          var runner = getRunner(element);
          if (runner && (event !== 'leave' || !options.$$domOperationFired)) {
            runner.end();
          }
        }

        function close(rejected) {
          // jshint ignore:line
          element.off('$destroy', handleDestroyedElement);
          removeRunner(element);

          applyAnimationClasses(element, options);
          applyAnimationStyles(element, options);
          options.domOperation();

          if (tempClasses) {
            $$jqLite.removeClass(element, tempClasses);
          }

          element.removeClass(NG_ANIMATE_CLASSNAME);
          runner.complete(!rejected);
        }
      };
    }];
  }],
      ngAnimateSwapDirective = ['$animate', '$rootScope', function ($animate, $rootScope) {
    return {
      restrict: 'A',
      transclude: 'element',
      terminal: true,
      priority: 600, // we use 600 here to ensure that the directive is caught before others
      link: function link(scope, $element, attrs, ctrl, $transclude) {
        var previousElement, previousScope;
        scope.$watchCollection(attrs.ngAnimateSwap || attrs['for'], function (value) {
          if (previousElement) {
            $animate.leave(previousElement);
          }
          if (previousScope) {
            previousScope.$destroy();
            previousScope = null;
          }
          if (value || value === 0) {
            previousScope = scope.$new();
            $transclude(previousScope, function (element) {
              previousElement = element;
              $animate.enter(element, null, $element);
            });
          }
        });
      }
    };
  }],
      copy,
      extend,
      forEach,
      isArray,
      isDefined,
      isElement,
      isFunction,
      isObject,
      isString,
      isUndefined,
      jqLite,
      noop;

  // TODO(matsko): use caching here to speed things up for detection
  // TODO(matsko): add documentation
  //  by the time...

  /**
   * @ngdoc directive
   * @name ngAnimateSwap
   * @restrict A
   * @scope
   *
   * @description
   *
   * ngAnimateSwap is a animation-oriented directive that allows for the container to
   * be removed and entered in whenever the associated expression changes. A
   * common usecase for this directive is a rotating banner or slider component which
   * contains one image being present at a time. When the active image changes
   * then the old image will perform a `leave` animation and the new element
   * will be inserted via an `enter` animation.
   *
   * @animations
   * | Animation                        | Occurs                               |
   * |----------------------------------|--------------------------------------|
   * | {@link ng.$animate#enter enter}  | when the new element is inserted to the DOM  |
   * | {@link ng.$animate#leave leave}  | when the old element is removed from the DOM |
   *
   * @example
   * <example name="ngAnimateSwap-directive" module="ngAnimateSwapExample"
   *          deps="angular-animate.js"
   *          animations="true" fixBase="true">
   *   <file name="index.html">
   *     <div class="container" ng-controller="AppCtrl">
   *       <div ng-animate-swap="number" class="cell swap-animation" ng-class="colorClass(number)">
   *         {{ number }}
   *       </div>
   *     </div>
   *   </file>
   *   <file name="script.js">
   *     angular.module('ngAnimateSwapExample', ['ngAnimate'])
   *       .controller('AppCtrl', ['$scope', '$interval', function($scope, $interval) {
   *         $scope.number = 0;
   *         $interval(function() {
   *           $scope.number++;
   *         }, 1000);
   *
   *         var colors = ['red','blue','green','yellow','orange'];
   *         $scope.colorClass = function(number) {
   *           return colors[number % colors.length];
   *         };
   *       }]);
   *   </file>
   *  <file name="animations.css">
   *  .container {
   *    height:250px;
   *    width:250px;
   *    position:relative;
   *    overflow:hidden;
   *    border:2px solid black;
   *  }
   *  .container .cell {
   *    font-size:150px;
   *    text-align:center;
   *    line-height:250px;
   *    position:absolute;
   *    top:0;
   *    left:0;
   *    right:0;
   *    border-bottom:2px solid black;
   *  }
   *  .swap-animation.ng-enter, .swap-animation.ng-leave {
   *    transition:0.5s linear all;
   *  }
   *  .swap-animation.ng-enter {
   *    top:-250px;
   *  }
   *  .swap-animation.ng-enter-active {
   *    top:0px;
   *  }
   *  .swap-animation.ng-leave {
   *    top:0px;
   *  }
   *  .swap-animation.ng-leave-active {
   *    top:250px;
   *  }
   *  .red { background:red; }
   *  .green { background:green; }
   *  .blue { background:blue; }
   *  .yellow { background:yellow; }
   *  .orange { background:orange; }
   *  </file>
   * </example>
   */


  /**
   * @ngdoc module
   * @name ngAnimate
   * @description
   *
   * The `ngAnimate` module provides support for CSS-based animations (keyframes and transitions) as well as JavaScript-based animations via
   * callback hooks. Animations are not enabled by default, however, by including `ngAnimate` the animation hooks are enabled for an Angular app.
   *
   * <div doc-module-components="ngAnimate"></div>
   *
   * # Usage
   * Simply put, there are two ways to make use of animations when ngAnimate is used: by using **CSS** and **JavaScript**. The former works purely based
   * using CSS (by using matching CSS selectors/styles) and the latter triggers animations that are registered via `module.animation()`. For
   * both CSS and JS animations the sole requirement is to have a matching `CSS class` that exists both in the registered animation and within
   * the HTML element that the animation will be triggered on.
   *
   * ## Directive Support
   * The following directives are "animation aware":
   *
   * | Directive                                                                                                | Supported Animations                                                     |
   * |----------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|
   * | {@link ng.directive:ngRepeat#animations ngRepeat}                                                        | enter, leave and move                                                    |
   * | {@link ngRoute.directive:ngView#animations ngView}                                                       | enter and leave                                                          |
   * | {@link ng.directive:ngInclude#animations ngInclude}                                                      | enter and leave                                                          |
   * | {@link ng.directive:ngSwitch#animations ngSwitch}                                                        | enter and leave                                                          |
   * | {@link ng.directive:ngIf#animations ngIf}                                                                | enter and leave                                                          |
   * | {@link ng.directive:ngClass#animations ngClass}                                                          | add and remove (the CSS class(es) present)                               |
   * | {@link ng.directive:ngShow#animations ngShow} & {@link ng.directive:ngHide#animations ngHide}            | add and remove (the ng-hide class value)                                 |
   * | {@link ng.directive:form#animation-hooks form} & {@link ng.directive:ngModel#animation-hooks ngModel}    | add and remove (dirty, pristine, valid, invalid & all other validations) |
   * | {@link module:ngMessages#animations ngMessages}                                                          | add and remove (ng-active & ng-inactive)                                 |
   * | {@link module:ngMessages#animations ngMessage}                                                           | enter and leave                                                          |
   *
   * (More information can be found by visiting each the documentation associated with each directive.)
   *
   * ## CSS-based Animations
   *
   * CSS-based animations with ngAnimate are unique since they require no JavaScript code at all. By using a CSS class that we reference between our HTML
   * and CSS code we can create an animation that will be picked up by Angular when an the underlying directive performs an operation.
   *
   * The example below shows how an `enter` animation can be made possible on an element using `ng-if`:
   *
   * ```html
   * <div ng-if="bool" class="fade">
   *    Fade me in out
   * </div>
   * <button ng-click="bool=true">Fade In!</button>
   * <button ng-click="bool=false">Fade Out!</button>
   * ```
   *
   * Notice the CSS class **fade**? We can now create the CSS transition code that references this class:
   *
   * ```css
   * /&#42; The starting CSS styles for the enter animation &#42;/
   * .fade.ng-enter {
   *   transition:0.5s linear all;
   *   opacity:0;
   * }
   *
   * /&#42; The finishing CSS styles for the enter animation &#42;/
   * .fade.ng-enter.ng-enter-active {
   *   opacity:1;
   * }
   * ```
   *
   * The key thing to remember here is that, depending on the animation event (which each of the directives above trigger depending on what's going on) two
   * generated CSS classes will be applied to the element; in the example above we have `.ng-enter` and `.ng-enter-active`. For CSS transitions, the transition
   * code **must** be defined within the starting CSS class (in this case `.ng-enter`). The destination class is what the transition will animate towards.
   *
   * If for example we wanted to create animations for `leave` and `move` (ngRepeat triggers move) then we can do so using the same CSS naming conventions:
   *
   * ```css
   * /&#42; now the element will fade out before it is removed from the DOM &#42;/
   * .fade.ng-leave {
   *   transition:0.5s linear all;
   *   opacity:1;
   * }
   * .fade.ng-leave.ng-leave-active {
   *   opacity:0;
   * }
   * ```
   *
   * We can also make use of **CSS Keyframes** by referencing the keyframe animation within the starting CSS class:
   *
   * ```css
   * /&#42; there is no need to define anything inside of the destination
   * CSS class since the keyframe will take charge of the animation &#42;/
   * .fade.ng-leave {
   *   animation: my_fade_animation 0.5s linear;
   *   -webkit-animation: my_fade_animation 0.5s linear;
   * }
   *
   * @keyframes my_fade_animation {
   *   from { opacity:1; }
   *   to { opacity:0; }
   * }
   *
   * @-webkit-keyframes my_fade_animation {
   *   from { opacity:1; }
   *   to { opacity:0; }
   * }
   * ```
   *
   * Feel free also mix transitions and keyframes together as well as any other CSS classes on the same element.
   *
   * ### CSS Class-based Animations
   *
   * Class-based animations (animations that are triggered via `ngClass`, `ngShow`, `ngHide` and some other directives) have a slightly different
   * naming convention. Class-based animations are basic enough that a standard transition or keyframe can be referenced on the class being added
   * and removed.
   *
   * For example if we wanted to do a CSS animation for `ngHide` then we place an animation on the `.ng-hide` CSS class:
   *
   * ```html
   * <div ng-show="bool" class="fade">
   *   Show and hide me
   * </div>
   * <button ng-click="bool=!bool">Toggle</button>
   *
   * <style>
   * .fade.ng-hide {
   *   transition:0.5s linear all;
   *   opacity:0;
   * }
   * </style>
   * ```
   *
   * All that is going on here with ngShow/ngHide behind the scenes is the `.ng-hide` class is added/removed (when the hidden state is valid). Since
   * ngShow and ngHide are animation aware then we can match up a transition and ngAnimate handles the rest.
   *
   * In addition the addition and removal of the CSS class, ngAnimate also provides two helper methods that we can use to further decorate the animation
   * with CSS styles.
   *
   * ```html
   * <div ng-class="{on:onOff}" class="highlight">
   *   Highlight this box
   * </div>
   * <button ng-click="onOff=!onOff">Toggle</button>
   *
   * <style>
   * .highlight {
   *   transition:0.5s linear all;
   * }
   * .highlight.on-add {
   *   background:white;
   * }
   * .highlight.on {
   *   background:yellow;
   * }
   * .highlight.on-remove {
   *   background:black;
   * }
   * </style>
   * ```
   *
   * We can also make use of CSS keyframes by placing them within the CSS classes.
   *
   *
   * ### CSS Staggering Animations
   * A Staggering animation is a collection of animations that are issued with a slight delay in between each successive operation resulting in a
   * curtain-like effect. The ngAnimate module (versions >=1.2) supports staggering animations and the stagger effect can be
   * performed by creating a **ng-EVENT-stagger** CSS class and attaching that class to the base CSS class used for
   * the animation. The style property expected within the stagger class can either be a **transition-delay** or an
   * **animation-delay** property (or both if your animation contains both transitions and keyframe animations).
   *
   * ```css
   * .my-animation.ng-enter {
   *   /&#42; standard transition code &#42;/
   *   transition: 1s linear all;
   *   opacity:0;
   * }
   * .my-animation.ng-enter-stagger {
   *   /&#42; this will have a 100ms delay between each successive leave animation &#42;/
   *   transition-delay: 0.1s;
   *
   *   /&#42; As of 1.4.4, this must always be set: it signals ngAnimate
   *     to not accidentally inherit a delay property from another CSS class &#42;/
   *   transition-duration: 0s;
   * }
   * .my-animation.ng-enter.ng-enter-active {
   *   /&#42; standard transition styles &#42;/
   *   opacity:1;
   * }
   * ```
   *
   * Staggering animations work by default in ngRepeat (so long as the CSS class is defined). Outside of ngRepeat, to use staggering animations
   * on your own, they can be triggered by firing multiple calls to the same event on $animate. However, the restrictions surrounding this
   * are that each of the elements must have the same CSS className value as well as the same parent element. A stagger operation
   * will also be reset if one or more animation frames have passed since the multiple calls to `$animate` were fired.
   *
   * The following code will issue the **ng-leave-stagger** event on the element provided:
   *
   * ```js
   * var kids = parent.children();
   *
   * $animate.leave(kids[0]); //stagger index=0
   * $animate.leave(kids[1]); //stagger index=1
   * $animate.leave(kids[2]); //stagger index=2
   * $animate.leave(kids[3]); //stagger index=3
   * $animate.leave(kids[4]); //stagger index=4
   *
   * window.requestAnimationFrame(function() {
   *   //stagger has reset itself
   *   $animate.leave(kids[5]); //stagger index=0
   *   $animate.leave(kids[6]); //stagger index=1
   *
   *   $scope.$digest();
   * });
   * ```
   *
   * Stagger animations are currently only supported within CSS-defined animations.
   *
   * ### The `ng-animate` CSS class
   *
   * When ngAnimate is animating an element it will apply the `ng-animate` CSS class to the element for the duration of the animation.
   * This is a temporary CSS class and it will be removed once the animation is over (for both JavaScript and CSS-based animations).
   *
   * Therefore, animations can be applied to an element using this temporary class directly via CSS.
   *
   * ```css
   * .zipper.ng-animate {
   *   transition:0.5s linear all;
   * }
   * .zipper.ng-enter {
   *   opacity:0;
   * }
   * .zipper.ng-enter.ng-enter-active {
   *   opacity:1;
   * }
   * .zipper.ng-leave {
   *   opacity:1;
   * }
   * .zipper.ng-leave.ng-leave-active {
   *   opacity:0;
   * }
   * ```
   *
   * (Note that the `ng-animate` CSS class is reserved and it cannot be applied on an element directly since ngAnimate will always remove
   * the CSS class once an animation has completed.)
   *
   *
   * ### The `ng-[event]-prepare` class
   *
   * This is a special class that can be used to prevent unwanted flickering / flash of content before
   * the actual animation starts. The class is added as soon as an animation is initialized, but removed
   * before the actual animation starts (after waiting for a $digest).
   * It is also only added for *structural* animations (`enter`, `move`, and `leave`).
   *
   * In practice, flickering can appear when nesting elements with structural animations such as `ngIf`
   * into elements that have class-based animations such as `ngClass`.
   *
   * ```html
   * <div ng-class="{red: myProp}">
   *   <div ng-class="{blue: myProp}">
   *     <div class="message" ng-if="myProp"></div>
   *   </div>
   * </div>
   * ```
   *
   * It is possible that during the `enter` animation, the `.message` div will be briefly visible before it starts animating.
   * In that case, you can add styles to the CSS that make sure the element stays hidden before the animation starts:
   *
   * ```css
   * .message.ng-enter-prepare {
   *   opacity: 0;
   * }
   *
   * ```
   *
   * ## JavaScript-based Animations
   *
   * ngAnimate also allows for animations to be consumed by JavaScript code. The approach is similar to CSS-based animations (where there is a shared
   * CSS class that is referenced in our HTML code) but in addition we need to register the JavaScript animation on the module. By making use of the
   * `module.animation()` module function we can register the animation.
   *
   * Let's see an example of a enter/leave animation using `ngRepeat`:
   *
   * ```html
   * <div ng-repeat="item in items" class="slide">
   *   {{ item }}
   * </div>
   * ```
   *
   * See the **slide** CSS class? Let's use that class to define an animation that we'll structure in our module code by using `module.animation`:
   *
   * ```js
   * myModule.animation('.slide', [function() {
   *   return {
   *     // make note that other events (like addClass/removeClass)
   *     // have different function input parameters
   *     enter: function(element, doneFn) {
   *       jQuery(element).fadeIn(1000, doneFn);
   *
   *       // remember to call doneFn so that angular
   *       // knows that the animation has concluded
   *     },
   *
   *     move: function(element, doneFn) {
   *       jQuery(element).fadeIn(1000, doneFn);
   *     },
   *
   *     leave: function(element, doneFn) {
   *       jQuery(element).fadeOut(1000, doneFn);
   *     }
   *   }
   * }]);
   * ```
   *
   * The nice thing about JS-based animations is that we can inject other services and make use of advanced animation libraries such as
   * greensock.js and velocity.js.
   *
   * If our animation code class-based (meaning that something like `ngClass`, `ngHide` and `ngShow` triggers it) then we can still define
   * our animations inside of the same registered animation, however, the function input arguments are a bit different:
   *
   * ```html
   * <div ng-class="color" class="colorful">
   *   this box is moody
   * </div>
   * <button ng-click="color='red'">Change to red</button>
   * <button ng-click="color='blue'">Change to blue</button>
   * <button ng-click="color='green'">Change to green</button>
   * ```
   *
   * ```js
   * myModule.animation('.colorful', [function() {
   *   return {
   *     addClass: function(element, className, doneFn) {
   *       // do some cool animation and call the doneFn
   *     },
   *     removeClass: function(element, className, doneFn) {
   *       // do some cool animation and call the doneFn
   *     },
   *     setClass: function(element, addedClass, removedClass, doneFn) {
   *       // do some cool animation and call the doneFn
   *     }
   *   }
   * }]);
   * ```
   *
   * ## CSS + JS Animations Together
   *
   * AngularJS 1.4 and higher has taken steps to make the amalgamation of CSS and JS animations more flexible. However, unlike earlier versions of Angular,
   * defining CSS and JS animations to work off of the same CSS class will not work anymore. Therefore the example below will only result in **JS animations taking
   * charge of the animation**:
   *
   * ```html
   * <div ng-if="bool" class="slide">
   *   Slide in and out
   * </div>
   * ```
   *
   * ```js
   * myModule.animation('.slide', [function() {
   *   return {
   *     enter: function(element, doneFn) {
   *       jQuery(element).slideIn(1000, doneFn);
   *     }
   *   }
   * }]);
   * ```
   *
   * ```css
   * .slide.ng-enter {
   *   transition:0.5s linear all;
   *   transform:translateY(-100px);
   * }
   * .slide.ng-enter.ng-enter-active {
   *   transform:translateY(0);
   * }
   * ```
   *
   * Does this mean that CSS and JS animations cannot be used together? Do JS-based animations always have higher priority? We can make up for the
   * lack of CSS animations by using the `$animateCss` service to trigger our own tweaked-out, CSS-based animations directly from
   * our own JS-based animation code:
   *
   * ```js
   * myModule.animation('.slide', ['$animateCss', function($animateCss) {
   *   return {
   *     enter: function(element) {
  *        // this will trigger `.slide.ng-enter` and `.slide.ng-enter-active`.
   *       return $animateCss(element, {
   *         event: 'enter',
   *         structural: true
   *       });
   *     }
   *   }
   * }]);
   * ```
   *
   * The nice thing here is that we can save bandwidth by sticking to our CSS-based animation code and we don't need to rely on a 3rd-party animation framework.
   *
   * The `$animateCss` service is very powerful since we can feed in all kinds of extra properties that will be evaluated and fed into a CSS transition or
   * keyframe animation. For example if we wanted to animate the height of an element while adding and removing classes then we can do so by providing that
   * data into `$animateCss` directly:
   *
   * ```js
   * myModule.animation('.slide', ['$animateCss', function($animateCss) {
   *   return {
   *     enter: function(element) {
   *       return $animateCss(element, {
   *         event: 'enter',
   *         structural: true,
   *         addClass: 'maroon-setting',
   *         from: { height:0 },
   *         to: { height: 200 }
   *       });
   *     }
   *   }
   * }]);
   * ```
   *
   * Now we can fill in the rest via our transition CSS code:
   *
   * ```css
   * /&#42; the transition tells ngAnimate to make the animation happen &#42;/
   * .slide.ng-enter { transition:0.5s linear all; }
   *
   * /&#42; this extra CSS class will be absorbed into the transition
   * since the $animateCss code is adding the class &#42;/
   * .maroon-setting { background:red; }
   * ```
   *
   * And `$animateCss` will figure out the rest. Just make sure to have the `done()` callback fire the `doneFn` function to signal when the animation is over.
   *
   * To learn more about what's possible be sure to visit the {@link ngAnimate.$animateCss $animateCss service}.
   *
   * ## Animation Anchoring (via `ng-animate-ref`)
   *
   * ngAnimate in AngularJS 1.4 comes packed with the ability to cross-animate elements between
   * structural areas of an application (like views) by pairing up elements using an attribute
   * called `ng-animate-ref`.
   *
   * Let's say for example we have two views that are managed by `ng-view` and we want to show
   * that there is a relationship between two components situated in within these views. By using the
   * `ng-animate-ref` attribute we can identify that the two components are paired together and we
   * can then attach an animation, which is triggered when the view changes.
   *
   * Say for example we have the following template code:
   *
   * ```html
   * <!-- index.html -->
   * <div ng-view class="view-animation">
   * </div>
   *
   * <!-- home.html -->
   * <a href="#/banner-page">
   *   <img src="./banner.jpg" class="banner" ng-animate-ref="banner">
   * </a>
   *
   * <!-- banner-page.html -->
   * <img src="./banner.jpg" class="banner" ng-animate-ref="banner">
   * ```
   *
   * Now, when the view changes (once the link is clicked), ngAnimate will examine the
   * HTML contents to see if there is a match reference between any components in the view
   * that is leaving and the view that is entering. It will scan both the view which is being
   * removed (leave) and inserted (enter) to see if there are any paired DOM elements that
   * contain a matching ref value.
   *
   * The two images match since they share the same ref value. ngAnimate will now create a
   * transport element (which is a clone of the first image element) and it will then attempt
   * to animate to the position of the second image element in the next view. For the animation to
   * work a special CSS class called `ng-anchor` will be added to the transported element.
   *
   * We can now attach a transition onto the `.banner.ng-anchor` CSS class and then
   * ngAnimate will handle the entire transition for us as well as the addition and removal of
   * any changes of CSS classes between the elements:
   *
   * ```css
   * .banner.ng-anchor {
   *   /&#42; this animation will last for 1 second since there are
   *          two phases to the animation (an `in` and an `out` phase) &#42;/
   *   transition:0.5s linear all;
   * }
   * ```
   *
   * We also **must** include animations for the views that are being entered and removed
   * (otherwise anchoring wouldn't be possible since the new view would be inserted right away).
   *
   * ```css
   * .view-animation.ng-enter, .view-animation.ng-leave {
   *   transition:0.5s linear all;
   *   position:fixed;
   *   left:0;
   *   top:0;
   *   width:100%;
   * }
   * .view-animation.ng-enter {
   *   transform:translateX(100%);
   * }
   * .view-animation.ng-leave,
   * .view-animation.ng-enter.ng-enter-active {
   *   transform:translateX(0%);
   * }
   * .view-animation.ng-leave.ng-leave-active {
   *   transform:translateX(-100%);
   * }
   * ```
   *
   * Now we can jump back to the anchor animation. When the animation happens, there are two stages that occur:
   * an `out` and an `in` stage. The `out` stage happens first and that is when the element is animated away
   * from its origin. Once that animation is over then the `in` stage occurs which animates the
   * element to its destination. The reason why there are two animations is to give enough time
   * for the enter animation on the new element to be ready.
   *
   * The example above sets up a transition for both the in and out phases, but we can also target the out or
   * in phases directly via `ng-anchor-out` and `ng-anchor-in`.
   *
   * ```css
   * .banner.ng-anchor-out {
   *   transition: 0.5s linear all;
   *
   *   /&#42; the scale will be applied during the out animation,
   *          but will be animated away when the in animation runs &#42;/
   *   transform: scale(1.2);
   * }
   *
   * .banner.ng-anchor-in {
   *   transition: 1s linear all;
   * }
   * ```
   *
   *
   *
   *
   * ### Anchoring Demo
   *
    <example module="anchoringExample"
             name="anchoringExample"
             id="anchoringExample"
             deps="angular-animate.js;angular-route.js"
             animations="true">
      <file name="index.html">
        <a href="#/">Home</a>
        <hr />
        <div class="view-container">
          <div ng-view class="view"></div>
        </div>
      </file>
      <file name="script.js">
        angular.module('anchoringExample', ['ngAnimate', 'ngRoute'])
          .config(['$routeProvider', function($routeProvider) {
            $routeProvider.when('/', {
              templateUrl: 'home.html',
              controller: 'HomeController as home'
            });
            $routeProvider.when('/profile/:id', {
              templateUrl: 'profile.html',
              controller: 'ProfileController as profile'
            });
          }])
          .run(['$rootScope', function($rootScope) {
            $rootScope.records = [
              { id:1, title: "Miss Beulah Roob" },
              { id:2, title: "Trent Morissette" },
              { id:3, title: "Miss Ava Pouros" },
              { id:4, title: "Rod Pouros" },
              { id:5, title: "Abdul Rice" },
              { id:6, title: "Laurie Rutherford Sr." },
              { id:7, title: "Nakia McLaughlin" },
              { id:8, title: "Jordon Blanda DVM" },
              { id:9, title: "Rhoda Hand" },
              { id:10, title: "Alexandrea Sauer" }
            ];
          }])
          .controller('HomeController', [function() {
            //empty
          }])
          .controller('ProfileController', ['$rootScope', '$routeParams', function($rootScope, $routeParams) {
            var index = parseInt($routeParams.id, 10);
            var record = $rootScope.records[index - 1];
  
            this.title = record.title;
            this.id = record.id;
          }]);
      </file>
      <file name="home.html">
        <h2>Welcome to the home page</h1>
        <p>Please click on an element</p>
        <a class="record"
           ng-href="#/profile/{{ record.id }}"
           ng-animate-ref="{{ record.id }}"
           ng-repeat="record in records">
          {{ record.title }}
        </a>
      </file>
      <file name="profile.html">
        <div class="profile record" ng-animate-ref="{{ profile.id }}">
          {{ profile.title }}
        </div>
      </file>
      <file name="animations.css">
        .record {
          display:block;
          font-size:20px;
        }
        .profile {
          background:black;
          color:white;
          font-size:100px;
        }
        .view-container {
          position:relative;
        }
        .view-container > .view.ng-animate {
          position:absolute;
          top:0;
          left:0;
          width:100%;
          min-height:500px;
        }
        .view.ng-enter, .view.ng-leave,
        .record.ng-anchor {
          transition:0.5s linear all;
        }
        .view.ng-enter {
          transform:translateX(100%);
        }
        .view.ng-enter.ng-enter-active, .view.ng-leave {
          transform:translateX(0%);
        }
        .view.ng-leave.ng-leave-active {
          transform:translateX(-100%);
        }
        .record.ng-anchor-out {
          background:red;
        }
      </file>
    </example>
   *
   * ### How is the element transported?
   *
   * When an anchor animation occurs, ngAnimate will clone the starting element and position it exactly where the starting
   * element is located on screen via absolute positioning. The cloned element will be placed inside of the root element
   * of the application (where ng-app was defined) and all of the CSS classes of the starting element will be applied. The
   * element will then animate into the `out` and `in` animations and will eventually reach the coordinates and match
   * the dimensions of the destination element. During the entire animation a CSS class of `.ng-animate-shim` will be applied
   * to both the starting and destination elements in order to hide them from being visible (the CSS styling for the class
   * is: `visibility:hidden`). Once the anchor reaches its destination then it will be removed and the destination element
   * will become visible since the shim class will be removed.
   *
   * ### How is the morphing handled?
   *
   * CSS Anchoring relies on transitions and keyframes and the internal code is intelligent enough to figure out
   * what CSS classes differ between the starting element and the destination element. These different CSS classes
   * will be added/removed on the anchor element and a transition will be applied (the transition that is provided
   * in the anchor class). Long story short, ngAnimate will figure out what classes to add and remove which will
   * make the transition of the element as smooth and automatic as possible. Be sure to use simple CSS classes that
   * do not rely on DOM nesting structure so that the anchor element appears the same as the starting element (since
   * the cloned element is placed inside of root element which is likely close to the body element).
   *
   * Note that if the root element is on the `<html>` element then the cloned node will be placed inside of body.
   *
   *
   * ## Using $animate in your directive code
   *
   * So far we've explored how to feed in animations into an Angular application, but how do we trigger animations within our own directives in our application?
   * By injecting the `$animate` service into our directive code, we can trigger structural and class-based hooks which can then be consumed by animations. Let's
   * imagine we have a greeting box that shows and hides itself when the data changes
   *
   * ```html
   * <greeting-box active="onOrOff">Hi there</greeting-box>
   * ```
   *
   * ```js
   * ngModule.directive('greetingBox', ['$animate', function($animate) {
   *   return function(scope, element, attrs) {
   *     attrs.$observe('active', function(value) {
   *       value ? $animate.addClass(element, 'on') : $animate.removeClass(element, 'on');
   *     });
   *   });
   * }]);
   * ```
   *
   * Now the `on` CSS class is added and removed on the greeting box component. Now if we add a CSS class on top of the greeting box element
   * in our HTML code then we can trigger a CSS or JS animation to happen.
   *
   * ```css
   * /&#42; normally we would create a CSS class to reference on the element &#42;/
   * greeting-box.on { transition:0.5s linear all; background:green; color:white; }
   * ```
   *
   * The `$animate` service contains a variety of other methods like `enter`, `leave`, `animate` and `setClass`. To learn more about what's
   * possible be sure to visit the {@link ng.$animate $animate service API page}.
   *
   *
   * ## Callbacks and Promises
   *
   * When `$animate` is called it returns a promise that can be used to capture when the animation has ended. Therefore if we were to trigger
   * an animation (within our directive code) then we can continue performing directive and scope related activities after the animation has
   * ended by chaining onto the returned promise that animation method returns.
   *
   * ```js
   * // somewhere within the depths of the directive
   * $animate.enter(element, parent).then(function() {
   *   //the animation has completed
   * });
   * ```
   *
   * (Note that earlier versions of Angular prior to v1.4 required the promise code to be wrapped using `$scope.$apply(...)`. This is not the case
   * anymore.)
   *
   * In addition to the animation promise, we can also make use of animation-related callbacks within our directives and controller code by registering
   * an event listener using the `$animate` service. Let's say for example that an animation was triggered on our view
   * routing controller to hook into that:
   *
   * ```js
   * ngModule.controller('HomePageController', ['$animate', function($animate) {
   *   $animate.on('enter', ngViewElement, function(element) {
   *     // the animation for this route has completed
   *   }]);
   * }])
   * ```
   *
   * (Note that you will need to trigger a digest within the callback to get angular to notice any scope-related changes.)
   */

  /**
   * @ngdoc service
   * @name $animate
   * @kind object
   *
   * @description
   * The ngAnimate `$animate` service documentation is the same for the core `$animate` service.
   *
   * Click here {@link ng.$animate to learn more about animations with `$animate`}.
   */
  angular.module('ngAnimate', [], function initAngularHelpers() {
    // Access helpers from angular core.
    // Do it inside a `config` block to ensure `window.angular` is available.
    noop = angular.noop;
    copy = angular.copy;
    extend = angular.extend;
    jqLite = angular.element;
    forEach = angular.forEach;
    isArray = angular.isArray;
    isString = angular.isString;
    isObject = angular.isObject;
    isUndefined = angular.isUndefined;
    isDefined = angular.isDefined;
    isFunction = angular.isFunction;
    isElement = angular.isElement;
  }).directive('ngAnimateSwap', ngAnimateSwapDirective).directive('ngAnimateChildren', $$AnimateChildrenDirective).factory('$$rAFScheduler', $$rAFSchedulerFactory).provider('$$animateQueue', $$AnimateQueueProvider).provider('$$animation', $$AnimationProvider).provider('$animateCss', $AnimateCssProvider).provider('$$animateCssDriver', $$AnimateCssDriverProvider).provider('$$animateJs', $$AnimateJsProvider).provider('$$animateJsDriver', $$AnimateJsDriverProvider);
})(window, window.angular);
/* <<< file end: js/node_modules/angular-animate/angular-animate.js */

//# map link was there [angular-animate.js.map]
/* >>> file start: js/widgets/angular/today.js */

//= require js/core/angular/api.js
//= require js/core/angular/users.js
//= require js/core/angular/ljUser.js

Site.page.template['angular/widgets/todayLJ/todayLJ.ng.tmpl'] = '<!-- today lj (discovery) -->\n\n<div\n    class=\"\n        b-todaylj\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-todaylj-loading\': isLoading\n    }\"\n    ng-if=\"isSup || type === \'homepage\'\"\n    >\n\n    <!-- head -->\n    <header\n        class=\"\n            b-todaylj-head\n            flatwidget__head\"\n        >\n        <h3\n            class=\"\n                b-todaylj-title\n                js-elem-color\n                \"\n            lj-ml=\"main.todaylj.head\"\n            ng-if=\"type === \'homepage\'\"\n            >\n        </h3>\n        <h3\n            class=\"\n                b-todaylj-title\n                js-elem-color\n                \"\n            lj-ml=\"discovery.todaylj.head\"\n            ng-if=\"type === \'discovery\'\"\n            >\n        </h3>\n    </header>\n\n    <!-- body -->\n    <div\n        class=\"\n            b-todaylj-body\n            flatwidget__body\n            js-link-color--a\"\n        >\n\n        <!-- items -->\n        <ul class=\"b-todaylj-items\">\n\n            <!-- item -->\n            <li\n                class=\"b-todaylj-item\"\n                ng-repeat=\"item in items\"\n                >\n\n                <!-- pic -->\n                <figure\n                    class=\"b-todaylj-figure\"\n                    ng-if=\"item.image\"\n                    >\n                    <a\n                        target=\"{{target}}\"\n                        ng-href=\"{{item.url}}\"\n                        >\n                        <img\n                            ng-src=\"{{item.image}}\"\n                            alt=\"\"\n                            class=\"b-todaylj-pic\"\n                            >\n                    </a>\n                </figure>\n\n                <!-- caption -->\n                <h4\n                    class=\"\n                        b-todaylj-caption\n                        js-sidebar-color--a-novisited\">\n                    <a\n                        ng-href=\"{{item.url}}\"\n                        target=\"{{target}}\"\n                        lj-html=\"item.subject_clean\"\n                        >\n                    </a>\n                </h4>\n\n                <!-- meta -->\n                <p\n                    class=\"b-todaylj-meta\"\n                    ng-if=\"item.user\"\n                    >\n                    <span class=\"b-todaylj-username\">\n                        <span\n                            ng-if=\"item.user\"\n                            lj-user-dynamic=\"item.user.username\"\n                            lj-user-dynamic-options=\"{target: \'_blank\'}\"\n                            ></span>\n                    </span>\n                    <span\n                        class=\"b-todaylj-comments\"\n                        ng-if=\"item.comments_url && item.comments_cnt > 0\"\n                        >\n                        <a\n                            target=\"{{target}}\"\n                            ng-href=\"{{item.comments_url}}\"\n                            >\n                             <span\n                                class=\"\n                                    b-todaylj-comments-icon\n                                    js-elem-color--svgicon\n                                    \"\n                                lj-svg-icon=\"flaticon--comments-bold\"\n                                ></span>\n                             <span\n                                class=\"b-todaylj-comments-inner\"\n                                >\n                                <span\n                                    ng-hide=\"item.comments_cnt === 0\"\n                                    lj-ml=\"entryunit.comments.numbersonly\"\n                                    lj-ml-resolve=\"{reply_count: item.comments_cnt}\"\n                                    ></span>\n                            </span>\n                        </a>\n                    </span>\n                </p>\n\n            </li><!-- /item -->\n\n        </ul><!-- /items -->\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-todaylj-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-todaylj-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-todaylj-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-todaylj-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n    </div><!-- /body -->\n\n</div><!-- /todaylj -->\n\n\n';
Site.page.template['angular/widgets/popularLJ/popularLJ.ng.tmpl'] = '<h3\n    lj-ml=\"main.intro.discovery.popular\"\n    class=\"\n        discovery-popular__title\n        \"></h3>\n<span\n  ng-class=\"{\'svgpreloader-show\': popular.loading}\"\n  class=\"\n    svgpreloader\n    svgpreloader-tag\n    svgpreloader-30\n  \"\n  ></span>\n<ul\n    class=\"\n        discovery-popular__list\n        \">\n    <li\n        ng-repeat=\"item in popular.items\"\n        ng-class=\"{\n            \'popular-item--big\': item.main_post,\n            \'popular-item--image-disable\': !item.image\n        }\"\n        class=\"\n            discovery-popular-list__item\n            popular-item\n            \">\n        <a\n            data-track-event=\"LJMag:Sidebar:OpenPopularPost:{{item.main_post ? \'big\' : \'small\'}}\"\n            href=\"{{item.url}}\"\n            target=\"_self\"\n            >\n            <div\n                ng-style=\"{\'background-image\':\'url({{item.image}})\'}\"\n                class=\"\n                    popular-item__image\n                    \">\n                <img\n                    ng-src=\"{{item.image}}\"\n                    alt=\"\"\n                    />\n            </div>\n            <h3\n                class=\"\n                    popular-item__title\n                    \"><!--\n             -->{{item.subject}}<!--\n             --></h3>\n        </a>\n    </li>\n</ul>\n\n';
LJ.injectStyle('/* >>> file start: stc/widgets/todaylj.css */\n/* TODAY LJ */\n\n.b-todaylj {\n    text-align: left;\n    }\n\n/* head */\n\n.b-todaylj-head {\n        margin: 0 0 1rem;\n        padding: 0;\n        }\n\n.b-feedwidgets .b-todaylj-head {\n        margin: 0 0 0.8125rem;\n        }\n\n.b-todaylj-title {\n            margin: 0;\n            padding: 0;\n            font-style: normal;\n            font-weight: normal;\n            font-size: 1.25rem;\n            text-transform: uppercase;\n            }\n\n.flatwidget--default-theme .b-todaylj-title {\n                color: #829399;\n                }\n\n/* body */\n\n.b-todaylj-body {\n        margin: 0;\n        padding: 0;\n        }\n\n.b-feedwidgets .b-todaylj-body {\n        font-size: 0.875rem;\n        }\n\n/* items */\n\n.b-todaylj-items {\n            margin: 0;\n            padding: 0;\n            list-style: none;\n            }\n\n/* item */\n\n.b-todaylj-item {\n                margin: 1rem 0 0;\n                padding: 0;\n                }\n\n.b-todaylj-item:first-child {\n                margin-top: 0;\n                }\n\n/* image */\n\n.b-todaylj-figure {\n                    margin: 0 0 1rem;\n                    padding: 0;\n                    }\n\n.b-todaylj-pic {\n                        max-width: 100%;\n                        height: auto;\n                        margin: 0;\n                        vertical-align: top;\n                        }\n\n/* hide at /feed page (LJSUP-18145) */\n\n.b-feedwidgets .b-todaylj-figure {\n                    display: none;\n                    }\n\n/* caption */\n\n.b-todaylj-caption {\n                    margin: 0 0 0.3rem;\n                    padding: 0;\n                    font-weight: normal;\n                    font-size: 1.125rem;\n                    line-height: 1.2;\n                    }\n\n.b-todaylj-caption A {\n                        display: inline-block;\n                        }\n\n.flatwidget--default-theme .b-todaylj-caption A:link,\n                        .flatwidget--default-theme .b-todaylj-caption A:visited,\n                        .flatwidget--default-theme .b-discoveryarticle .b-todaylj-caption A:link,\n                        .flatwidget--default-theme .b-discoveryarticle .b-todaylj-caption A:visited {\n                            color: #242F33;\n                            }\n\n.flatwidget--default-theme .b-todaylj-caption A:hover,\n                        .flatwidget--default-theme .b-todaylj-caption A:active,\n                        .flatwidget--default-theme .b-discoveryarticle .b-todaylj-caption A:hover,\n                        .flatwidget--default-theme .b-discoveryarticle .b-todaylj-caption A:active {\n                            color: #00A3D9;\n                            }\n\n.b-feedwidgets .b-todaylj-caption {\n                    margin: 0;\n                    font-size: 1em;\n                    line-height: 1.4;\n                    }\n\n/* meta */\n\n.b-todaylj-meta {\n                    margin: 0;\n                    padding: 0;\n                    }\n\n.b-mainpage .b-todaylj-meta {\n                    letter-spacing: 0.05rem;\n                    text-transform: uppercase;\n                    font-family: \'ProximaNova\', Tahoma, Arial, sans-serif;\n                    font-weight: 600;\n                    font-size: 0.875rem;\n                    }\n\n/* links */\n\n.flatwidget--default-theme .b-todaylj-meta A:link,\n                    .flatwidget--default-theme .b-todaylj-meta A:visited {\n                        color: #00A3D9;\n                        }\n\n.flatwidget--default-theme .b-todaylj-meta A:hover,\n                    .flatwidget--default-theme .b-todaylj-meta A:active {\n                        color: #0086B3;\n                        }\n\n/* username */\n\n.b-todaylj-username {\n                        margin: 0 1rem 0 0;\n                        }\n\n.b-todaylj-username .story--author-users .i-ljuser-profile {\n                            display: none;\n                            }\n\n/* comments */\n\n.b-todaylj-comments {\n                        position: relative;\n                        display: inline-block;\n                        margin: 0 1rem 0 0;\n                        }\n\n.b-todaylj-comments-icon {\n                            display: inline-block;\n                            width: 17px;\n                            height: 16px;\n                            margin: 0;\n                            padding: 0;\n                            background: url(/img/icons/unit_v3.png?v=42878) no-repeat 0 -17px;\n                            font: 0px/0 serif;\n                            vertical-align: middle;\n                            color: #7A9199;\n                            }\n\n.b-todaylj-comments-icon .svgicon {\n                                width: 17px;\n                                height: 16px;\n                                }\n\n.b-todaylj-comments-inner {\n                            vertical-align: middle;\n                            }\n\n/* enabled feedsettings */\n\n.b-feedsettings-on .b-todaylj-comments-icon {\n                            background: none;\n                            }\n\n/* loading */\n\n.b-todaylj-loading {\n    }\n\n.b-todaylj-loading .b-todaylj-body {\n        min-height: 300px;\n        }\n\n.b-todaylj-loading .b-todaylj-dummy {\n            display: block;\n            }\n\n.b-todaylj-loading .b-todaylj-items {\n            visibility: hidden;\n            }\n\n@media all and (max-width: 1000px) {\n\n    .b-discoveryarticle .b-todaylj {\n        width: auto;\n        max-width: 650px;\n        margin: 0 auto;\n        padding-left: 0;\n    }\n\n}\n\n@media all and (max-width: 800px) {\n\n    .b-discoveryarticle .b-todaylj {\n        width: 300px;\n        }\n        .b-todaylj-items {\n            -webkit-column-count: auto;\n                    column-count: auto;\n            -webkit-column-gap: normal;\n                    column-gap: normal;\n            }\n\n}\n\n@media all and (max-width: 650px) {\n\n    .b-discoveryarticle .b-todaylj {\n        width: auto;\n        max-width: 300px;\n        padding-left: 0;\n        padding-right: 0;\n        }\n}\n\n/* <<< file end: stc/widgets/todaylj.css */\n\n/*# sourceMappingURL=todaylj.css.map */\n');

//= require_ml main.intro.discovery.popular
//= require_ml main.todaylj.head,
//= require_ml discovery.todaylj.head,
//= require_ml entryunit.comments.numbersonly,
//= require_ml entryunit.comments.none

/**
 * Discovery in LiveJournal widget for Discovery page
 *
 * Usage:
 *
 *  <div lj-widget-discovery lj-widget-discovery-target="_blank"></div>
 */
angular.module('LJ.Widget.Discovery', ['LJ.Templates', 'LJ.Api', 'LJ.Directives', 'LJ.User', 'Users']).directive('ljWidgetDiscoveryPopular', ['Api', 'Users', function (Api, Users) {
  return {
    templateUrl: 'popularLJ.ng.tmpl',
    link: function link($scope) {

      var that = {};
      $scope.popular = that;

      Api.call('discovery.popular', null, { cache: true }).then(function (response) {
        that.items = [].concat(response.items.filter(LJ.Function.get('main_post', 1))).concat(response.items.filter(LJ.Function.get('main_post', 0)));

        // cache users
        Users.Cache.add(that.items.map(LJ.Function.get('user')));
        that.loading = false;
      });
    }
  };
}]).directive('ljWidgetDiscovery', ['Api', 'Users', function (Api, Users) {
  return {
    templateUrl: 'todayLJ.ng.tmpl',
    link: function link(scope, element, attrs) {
      scope.type = 'discovery';
      scope.isLoading = true;

      scope.target = angular.isDefined(attrs.ljWidgetDiscoveryTarget) ? attrs.ljWidgetDiscoveryTarget : '_blank';

      Api.call('discovery.today', null, { cache: true }).then(function (response) {
        scope.items = response.items;

        // cache users
        Users.Cache.add(scope.items.map(LJ.Function.get('user')));

        scope.isLoading = false;
      });

      scope.isSup = LJ.get('remote_is_sup');
    }
  };
}]);

/**
 * Top in LiveJournal widget for Home page
 *
 * Usage:
 *
 *  <div lj-widget-top lj-widget-top-target="_blank"></div>
 */
angular.module('LJ.Widget.Top', ['LJ.Templates', 'LJ.Api', 'LJ.Directives', 'LJ.User', 'Users']).directive('ljWidgetTop', ['Api', 'Users', '$q', function (Api, Users, $q) {
  return {
    templateUrl: 'todayLJ.ng.tmpl',
    link: function link(scope, element, attrs) {
      var blacknames = [],
          settings = {},
          items = [];

      function getSettings() {
        return Api.call('ratings.show_flags', { cache: true });
      }

      function getBlackNames() {
        return Api.call('ratings.blacklist_get', { cache: true }).then(function (response) {
          return response.blacklist.map(LJ.Function.get('user'));
        });
      }

      function filterItems(items) {
        var dups = [];

        return items.filter(function (item) {
          var name = item.user.display_name;

          dups.push(name);

          // Сheck for the entering to blacklist and check for uniqueness, if it's necessary
          return !!(blacknames.indexOf(name) === -1 || settings.show_unique_items && dups.indexOf(name) === -1);
        });
      }

      function loadItems(page) {
        // Only 5 items should be displayed
        var length = 5,
            times = 5;

        page = page || 0;

        return Api.call('homepage.today', { page: page }, { cache: true }).then(function (response) {
          var filtered = filterItems(response.items);

          Array.prototype.push.apply(items, filtered);

          if (items.length < length && page < times) {
            return loadItems(page + 1);
          }

          // cache users
          Users.Cache.add(items.map(LJ.Function.get('user')));

          scope.isLoading = false;

          return items.slice(0, length);
        });
      }

      if (LJ.get('remote')) {
        $q.all({ settings: getSettings(), names: getBlackNames() }).then(function (result) {
          angular.extend(settings, result.settings);

          blacknames = result.names;

          loadItems().then(function (result) {
            scope.items = result;
          });
        });
      } else {
        loadItems().then(function (result) {
          scope.items = result;
        });
      }

      scope.type = 'homepage';
      scope.isLoading = true;
      scope.items = [];

      scope.target = angular.isDefined(attrs.ljWidgetTopTarget) ? attrs.ljWidgetTopTarget : '_blank';

      scope.isSup = LJ.get('remote_is_sup');
    }
  };
}]);
/* <<< file end: js/widgets/angular/today.js */

//# map link was there [today.js.map]
/* >>> file start: js/widgets/angular/ljMediaWidget.js */
var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

Site.page.template['angular/widgets/ljMedia/ljMedia.ng.tmpl'] = '<!-- lj media -->\n\n<div\n    class=\"\n        b-todaylj\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-todaylj-loading\': isLoading\n    }\"\n    >\n\n    <!-- head -->\n    <header\n        class=\"\n            b-todaylj-head\n            flatwidget__head\"\n        >\n        <h3\n            class=\"\n                b-todaylj-title\n                js-elem-color\n                \"\n            lj-ml=\"friendsfeed.ljmedia.title\"\n            >\n        </h3>\n    </header>\n\n    <!-- body -->\n    <div\n        class=\"\n            b-todaylj-body\n            flatwidget__body\n            js-link-color--a\"\n        >\n\n        <!-- items -->\n        <ul class=\"b-todaylj-items\">\n\n            <!-- item -->\n            <li\n                class=\"b-todaylj-item\"\n                ng-repeat=\"item in items\"\n                >\n\n                <!-- caption -->\n                <h4\n                    class=\"\n                        b-todaylj-caption\n                        js-sidebar-color--a-novisited\">\n                    <a\n                        ng-href=\"{{item.link}}\"\n                        target=\"{{target}}\"\n                        >{{item.title}}\n                    </a>\n                </h4>\n\n                <!-- meta -->\n                <p\n                    class=\"b-todaylj-meta\"\n\n                    >\n                    <span\n                        class=\"\n                            b-todaylj-username\n                            \"\n                        >\n                        <span\n                            ng-bind-html=\"item.ljuser\"\n                            ></span>\n                    </span>\n                    <span\n                        class=\"b-todaylj-comments\"\n                        ng-if=\"item.comments_url && item.replycount > 0\"\n                        >\n                        <a\n                            target=\"{{target}}\"\n                            ng-href=\"{{item.comments_url}}\"\n                            >\n                             <span\n                                class=\"\n                                    b-todaylj-comments-icon\n                                    js-elem-color--svgicon\n                                    \"\n                                lj-svg-icon=\"flaticon--comments-bold\"\n                                ></span>\n                             <span\n                                class=\"b-todaylj-comments-inner\"\n                                >\n                                <span\n                                    ng-hide=\"item.replycount === 0\"\n                                    lj-ml=\"entryunit.comments.numbersonly\"\n                                    lj-ml-resolve=\"{reply_count: item.replycount}\"\n                                    ></span>\n                            </span>\n                        </a>\n                    </span>\n                </p>\n\n            </li><!-- /item -->\n\n        </ul><!-- /items -->\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-todaylj-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-todaylj-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-todaylj-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-todaylj-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n    </div><!-- /body -->\n\n</div><!-- /todaylj -->\n';

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Widget.Media', ['LJ.Api']);

  angular.module('LJ.Widget.Media').directive('ljWidgetMedia', ljWidgetMedia);

  ljWidgetMedia.$inject = ['$sce', 'Api'];
  function ljWidgetMedia($sce, Api) {
    return {
      templateUrl: 'ljMedia.ng.tmpl',
      link: link
    };

    function link(scope) {
      var entriesLimit = 5;
      scope.type = 'ljMedia';
      scope.isLoading = true;

      Api.call('medius.get_public_items', { limit: entriesLimit }, { cache: true }).then(function (response) {
        scope.items = response.items.map(function (item) {
          return _extends({}, item, {
            ljuser: $sce.trustAsHtml(item.author),
            'comments_url': item.link + '#comments'
          });
        });

        scope.isLoading = false;
      });

      scope.isSup = LJ.get('remote_is_sup');
    }
  }
})();
/* <<< file end: js/widgets/angular/ljMediaWidget.js */

//# map link was there [ljMediaWidget.js.map]
/* >>> file start: js/widgets/angular/updates.js */
/**
 * Updates widgets
 */

//= require js/node_modules/angular-animate/angular-animate.js

//= require js/core/angular/options.js
//= require js/core/angular/api.js

Site.page.template['angular/widgets/updates/updates.ng.tmpl'] = '<!-- my updates (LJSUP-18034) -->\n\n\n\n<div\n    class=\"\n        b-myupdates\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-myupdates-empty\': widget.items.length === 0,\n        \'b-myupdates-loading\': !widget.state.initialized\n    }\"\n    >\n\n\n\n    <!-- head -->\n    <header\n        class=\"\n            b-myupdates-head\n            flatwidget__head\"\n        >\n\n        <h3 class=\"b-myupdates-header\"><!--\n\n            --><span\n                class=\"\n                    b-myupdates-title\n                    js-elem-color\"\n                lj-ml=\"{\n                    \'main.updates.widget.title.comments\': widget.type === \'comments\',\n                    \'main.updates.widget.title.events\': widget.type === \'events\',\n                    \'main.updates.widget.title.entries\': widget.type === \'entries\',\n                    \'main.updates.widget.title.guests\': widget.type === \'guests\',\n                    \'main.updates.widget.title.friend_activity\': widget.type === \'friendAct\'\n                }\"\n                ></span><!--\n\n            --><span\n                class=\"b-myupdates-counter\"\n                ng-bind=\"widget.options.count\"\n                ng-if=\"widget.type != \'guests\'\"\n                ></span><!--\n\n        --></h3>\n\n    </header><!-- /head -->\n\n\n\n    <!-- body -->\n    <div\n        class=\"\n            b-myupdates-body\n            flatwidget__body\n            js-link-color--a\"\n        >\n\n        <!-- items -->\n        <ul class=\"b-myupdates-items\">\n\n            <!-- item -->\n            <li\n                class=\"\n                    b-myupdates-item\n                    js-elem-bordercolor\n                    \"\n                ng-repeat=\"item in widget.items | orderBy:widget.options.orderBy | limitTo: widget.options.size track by item.id\"\n                >\n\n                <!-- content -->\n                <span\n                    class=\"\n                        b-myupdates-item-content\n                        js-sidebar-color--a-novisited\n                        js-link-color--username\"\n                    lj-html=\"widget.content(item)\"\n                    ></span>\n\n                <!-- remove button -->\n                <span\n                    class=\"b-myupdates-item-remove\"\n                    lj-ml=\"main.updates.remove\"\n                    lj-ml-attr=\"title\"\n                    ng-click=\"widget.remove(item)\"\n                    ng-if=\"widget.type !== \'guests\'\"\n                    lj-svg-icon=\"flaticon--check\"\n                    >\n                </span>\n\n            </li>\n\n        </ul><!-- /items -->\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-myupdates-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-myupdates-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-myupdates-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-myupdates-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n        <!-- emptiness message -->\n        <p\n            class=\"\n                b-myupdates-emptiness\n                js-sidebar-color\n                \"\n            lj-ml=\"{\n                \'main.updates.recent.empty\':   widget.type === \'entries\',\n                \'main.updates.comments.empty\': widget.type === \'comments\',\n                \'main.updates.common.empty\':   widget.type === \'events\',\n                \'main.updates.guests.empty\':   widget.type === \'guests\',\n                \'main.updates.friend_activity.empty\':   widget.type === \'friendAct\'\n            }\"\n            ></p>\n\n    </div><!-- /body -->\n\n\n\n    <!-- footer -->\n    <footer\n        class=\"\n            b-myupdates-footer\n            flatwidget__footer\n            js-link-color--a-novisited\"\n        ng-if=\"widget.type === \'comments\'\"\n        >\n        <a\n            ng-href=\"{{widget.siteroot}}/tools/recent_comments.bml\"\n            target=\"_blank\"\n            lj-ml=\"main.updates.comments.all\"\n            ></a>\n    </footer><!-- /footer -->\n\n\n\n</div>\n';
LJ.injectStyle('/* >>> file start: stc/widgets/myupdates.css */\n/* my updates widgets (LJSUP-18034) */\n\n\n\n/*.b-myupdates {\n    }*/\n\n\n\n/* head */\n\n\n\n.b-myupdates-head {\n        position: relative;\n        margin: 0 0 0.8125rem;\n        padding: 0;\n        }\n\n\n\n/* header */\n\n\n\n.b-myupdates-header {\n            margin: 0;\n            padding: 0;\n            font-style: normal;\n            font-weight: normal;\n            font-size: 1.25rem;\n            text-transform: uppercase;\n            color: #829399;\n            }\n\n\n\n/* title */\n\n\n\n.b-myupdates-title {\n                margin: 0;\n                }\n\n\n\n/* counter */\n\n\n\n.b-myupdates-counter {\n                display: inline-block;\n                min-width: 10px;\n                margin: 0 0 0 0.7em;\n                padding: 3px 5px;\n                border-radius: 15px;\n                vertical-align: 4px;\n                font: 600 11px/1 \'ProximaNova\', Tahoma, Arial, sans-serif;\n                background: #FF8F40;\n                text-align: center;\n                color: #FFF;\n                }\n\n\n\n.html-ie11 .b-myupdates-counter {\n                padding: 4px 5px 2px;\n                }\n\n\n\n/* body */\n\n\n\n.b-myupdates-body {\n        margin: 0;\n        padding: 0;\n        font-size: 0.875rem;\n        }\n\n\n\n/* items */\n\n\n\n.b-myupdates-items {\n            margin: 0;\n            padding: 0;\n            list-style: none;\n            }\n\n\n\n/* item */\n\n\n\n.b-myupdates-item {\n                position: relative;\n                margin: 0 0 1em;\n                padding: 0;\n                }\n\n\n\n/* content */\n\n\n\n.b-myupdates-item-content {\n                    display: block;\n                    margin: 0 20px 0 0;\n                    }\n\n\n\n/* remove */\n\n\n\n.b-myupdates-item-remove {\n                    overflow: hidden;\n                    visibility: hidden;\n                    position: absolute;\n                    top: 0;\n                    right: 0;\n                    width: 16px;\n                    height: 16px;\n                    margin: 0;\n                    padding: 0;\n                    background: url(/img/icons/unit_v3.png?v=42878) no-repeat 0 -221px;\n                    font: 0/0 a;\n                    cursor: pointer;\n                    color: #7A9199;\n                    }\n\n\n\n.b-myupdates-item:hover .b-myupdates-item-remove {\n                    visibility: visible;\n                    }\n\n\n\n.b-myupdates-item-remove .svgicon {\n                        width: 16px;\n                        height: 16px;\n                        }\n\n\n\n/* enabled feedsettings */\n\n\n\n.b-feedsettings-on .b-myupdates-item-remove {\n                    background: none;\n                    }\n\n\n\n/* emptiness */\n\n\n\n.b-myupdates-emptiness {\n        display: none;\n        margin: 0;\n        padding: 0.5em 0;\n        font-size: 1.2307em;\n        }\n\n\n\n/* footer */\n\n\n\n.b-myupdates-footer {\n        margin: 0;\n        padding: 0;\n        font-size: 0.875rem;\n        text-align: right;\n        }\n\n\n\n/* loading */\n\n\n\n.b-myupdates-loading {\n    }\n\n\n\n.b-myupdates-loading .b-myupdates-dummy,\n    .b-myupdates-loading.b-myupdates-empty .b-myupdates-dummy {\n        display: block;\n        }\n\n\n\n.b-myupdates-loading .b-myupdates-items {\n        display: none;\n        }\n\n\n\n.b-myupdates-loading .b-myupdates-emptiness,\n    .b-myupdates-loading.b-myupdates-empty .b-myupdates-emptiness {\n        display: none;\n        }\n\n\n\n/* empty*/\n\n\n\n.b-myupdates-empty {\n    }\n\n\n\n.b-myupdates-empty .b-myupdates-emptiness {\n        display: block;\n        }\n\n\n\n.b-myupdates-empty .b-myupdates-counter {\n        display: none;\n        }\n\n\n\n.b-myupdates-empty .b-myupdates-footer {\n        display: none;\n        }\n\n\n\n.b-myupdates-empty .b-myupdates-dummy {\n        display: none;\n        }\n\n\n\n.b-myupdates-empty .b-myupdates-items {\n        display: none;\n        }\n\n/* <<< file end: stc/widgets/myupdates.css */\n\n/*# sourceMappingURL=myupdates.css.map */\n');

//= require_ml main.updates.ban
//= require_ml main.updates.remove
//= require_ml main.updates.recent.empty
//= require_ml main.updates.recent.empty.title
//= require_ml main.updates.recent.clear
//= require_ml main.updates.recent.confirm_ban

//= require_ml main.updates.widget.title.friend_activity
//= require_ml main.updates.friend_activity.empty
(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Widget.Updates', ['ngAnimate', 'LJ.Templates', 'LJ.Api', 'LJ.Directives', 'LJ.Options']).factory('Entries', ['Options', 'Api', createFactory({
    type: 'entries',
    rpc: {
      fetch: 'homepage.get_entries',
      remove: 'homepage.remove_entry'
    },
    options: {
      orderBy: '-timestamp'
    }
  })]).factory('Comments', ['Options', 'Api', createFactory({
    type: 'comments',
    rpc: {
      fetch: 'homepage.get_comments',
      remove: 'homepage.remove_comment'
    }
  })]).factory('Events', ['Options', 'Api', createFactory({
    type: 'events',
    rpc: {
      fetch: 'homepage.get_events',
      remove: 'homepage.remove_event'
    }
  })]).factory('Guests', ['Options', 'Api', createFactory({
    type: 'guests',
    rpc: {
      fetch: 'friendsfeed.get_guests'
    },
    options: {
      timeout: 0,
      preloadAfter: 0
    }
  })]).factory('FriendActivity', ['Options', 'Api', createFactory({
    type: 'friendAct',
    rpc: {
      fetch: 'friendsfeed.friends_activity',
      remove: 'friendsfeed.friends_actitivy_skip'
    },
    options: {
      size: 10
    }
  })]).controller('EntriesCtrl', ['$scope', '$interval', 'Entries', updatesCtrl]).controller('CommentsCtrl', ['$scope', '$interval', 'Comments', updatesCtrl]).controller('EventsCtrl', ['$scope', '$interval', 'Events', updatesCtrl]).controller('GuestsCtrl', ['$scope', '$interval', 'Guests', updatesCtrl]).controller('FriendActivityCtrl', ['$scope', '$interval', 'FriendActivity', updatesCtrl]).directive('ljWidgetEntries', [function () {
    return {
      scope: true,
      controller: 'EntriesCtrl',
      controllerAs: 'widget',
      templateUrl: 'updates.ng.tmpl'
    };
  }]).directive('ljWidgetEvents', [function () {
    return {
      scope: true,
      controller: 'EventsCtrl',
      controllerAs: 'widget',
      templateUrl: 'updates.ng.tmpl'
    };
  }]).directive('ljWidgetComments', [function () {
    return {
      scope: true,
      controller: 'CommentsCtrl',
      controllerAs: 'widget',
      templateUrl: 'updates.ng.tmpl'
    };
  }]).directive('ljWidgetGuests', [function () {
    return {
      scope: true,
      controller: 'GuestsCtrl',
      controllerAs: 'widget',
      templateUrl: 'updates.ng.tmpl'
    };
  }]).directive('ljWidgetFriendActivity', function () {
    return {
      scope: true,
      controller: 'FriendActivityCtrl',
      controllerAs: 'widget',
      templateUrl: 'updates.ng.tmpl'
    };
  }).animation('.b-myupdates-item', [function () {
    return {
      enter: function enter(element, done) {
        element.hide().slideDown('fast', 'linear', done);
      },

      leave: function leave(element, done) {
        element.slideUp('fast', 'linear', done);
      }
    };
  }]);

  function updatesCtrl($scope, $interval, Service) {

    var that = this,
        stop;

    $scope.$watch(Service.get, function (items) {
      that.items = items;
    });

    // Notice:
    // If preloadAfter is 0 - we widget doesn't need preloading by count
    if (Service.options.get('preloadAfter') !== 0) {

      // fetch on demand, when items count is less then `preloadAfter`
      $scope.$watch(function () {
        return that.items.length;
      }, function (length) {
        // only after widget has been initialized
        if (!that.state.initialized) {
          return;
        }

        if (length < Service.options.get('preloadAfter') &&

        // -1 is because count has not been changed right after remove
        length < Service.options.get('count') - 1) {
          if (Service.options.get('timeout') === 0) {
            Service.fetch();
          } else {
            _fetch();
          }
        }
      });
    }

    this.options = Service.options.raw();

    this.type = Service.type;
    this.siteroot = LJ.get('siteroot');

    this.state = {
      initialized: false
    };

    this.remove = function (entry) {
      Service.track('close').remove(entry);
    };

    /**
     * Function helper that helps to get item content
     * @todo Add general response field for content
     */
    this.content = function (item) {
      if (Service.type === 'entries' || Service.type === 'friendAct') {
        return item['entry'];
      }

      if (Service.type === 'comments') {
        return item['comment'];
      }

      if (Service.type === 'events') {
        return item['event'];
      }

      if (Service.type === 'guests') {
        return item['guest'];
      }
    };

    Service.fetch().then(function () {
      that.state.initialized = true;
    });

    // if widget needs updates
    if (Service.options.get('timeout') !== 0) {
      stop = $interval(Service.fetch, Service.options.get('timeout'));
    }

    // reset $interval and fetch
    function _fetch() {
      // reset timestamp to get all entries
      Service.options.set('timestamp', null);
      Service.fetch();
      $interval.cancel(stop);
      stop = $interval(Service.fetch, Service.options.get('timeout'));
    }

    $scope.$on('$destroy', function () {
      $interval.cancel(stop);
    });
  }

  function createFactory(opts) {
    var rpc = opts.rpc,
        type = opts.type,
        _options = opts.options;

    return function (Options, Api) {
      var options = Options.create(angular.extend({
        // amount of items that are stored on server
        // Notice: we don't fetch all items
        count: 0,

        size: 4,

        // fetch items from server when less than 10 items left
        preloadAfter: 10,

        // updates request timeout
        timeout: LJ.get('updates_timeout') || 30000,

        // last item timestamp that will be sent to server
        // Notice: currently it's needed only for entries widget
        timestamp: null,

        // order field
        orderBy: 'order'
      }, _options || {})),
          items = [],


      // ids of models that has been removed yet
      ids = [],


      // Prevent making dups api calls when fetch in progress
      isFetchBusy = false,
          factory = {
        type: type,

        fetch: fetch,
        remove: remove,
        get: get,
        options: options,
        track: track
      };

      function track(event) {
        LJ.Track.event('FriendsFeed', 'Widget', type + ' ' + event);
        return factory;
      }

      function fetch() {
        if (isFetchBusy) {
          return;
        }

        isFetchBusy = true;

        return Api.call(rpc.fetch, {
          from: 0,
          to: 20,
          timestamp: options.get('timestamp')
        }).then(function (response) {
          var listKey = type;
          if (type === 'friendAct') {
            listKey = 'entries';
          }
          var _items = response[listKey],
              time = -new Date().valueOf();

          // Filter items that has been removed yet.
          // It could not be realized on server at the moment
          _items = _items.filter(function (item) {
            return ids.indexOf(item.id) === -1;
          });

          // entries are sorted by timestamp
          if (type !== 'entries') {

            // add order field
            _items.forEach(function (item, index) {
              item.order = time + index;
            });
          }

          // for entries we fetch new items if timestamp provided, otherwise - latest items,
          // for other widgets - latest items
          if (type === 'entries' && options.get('timestamp')) {
            items = items.concat(_items);
          } else {
            items = _items;
          }

          options.set({
            count: Number(response.count),

            // update timestamp
            timestamp: response.timestamp
          });

          isFetchBusy = false;
        });
      }

      function remove(item) {
        var id = item.id;

        // add item id to removed list
        ids.push(id);

        Api.call(rpc.remove, { id: id }).then(function (response) {
          if (response.count) {
            options.set({ count: response.count });
          } else {
            options.set({ count: options.get('count') - 1 });
          }
        });

        // remove item from the list
        items = items.filter(function (item) {
          return item.id !== id;
        });
      }

      function get() {
        return items;
      }

      return factory;
    };
  }
})();
/* <<< file end: js/widgets/angular/updates.js */

//# map link was there [updates.js.map]
/* >>> file start: js/widgets/angular/links.js */
/**
 * Interesting links widget
 * Usage:
 *   <div lj-widget-links></div>
 */

//= require js/core/angular/api.js

Site.page.template['angular/widgets/links/links.ng.tmpl'] = '<!-- my links (LJSUP-18522) -->\n\n\n\n<div\n    class=\"\n        b-mylinks\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-mylinks-empty\': widget.items.length === 0,\n        \'b-mylinks-loading\': isLoading\n    }\"\n    >\n\n\n\n    <!-- head -->\n    <header\n        class=\"\n            b-mylinks-head\n            flatwidget__head\"\n        >\n\n        <h3 class=\"b-mylinks-header\"><!--\n\n            --><span\n                class=\"\n                    b-mylinks-title\n                    js-elem-color\n                    \"\n                lj-ml=\"widget.links.title\"\n                ></span><!--\n\n        --></h3>\n\n    </header><!-- /head -->\n\n\n\n    <!-- body -->\n    <div\n        class=\"\n            b-mylinks-body\n            flatwidget__body\n            js-link-color--a\"\n        >\n\n        <!-- items -->\n        <ul class=\"b-mylinks-items\">\n\n            <li\n                class=\"b-mylinks-item\"\n                ng-repeat=\"item in items\"\n                ><!--\n                --><a\n                    ng-href=\"{{item.url}}\"\n                    ng-bind=\"item.title\"\n                    target=\"_blank\"\n                    class=\"b-mylinks-item-link\"\n                    ></a><!--\n            --></li>\n\n        </ul><!-- /items -->\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-mylinks-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-mylinks-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mylinks-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n        <!-- emptiness message -->\n        <p\n            class=\"b-mylinks-emptiness\"\n            lj-ml=\"widget.links.empty\"\n            ></p>\n\n    </div><!-- /body -->\n\n\n\n    <!-- footer -->\n    <footer\n        class=\"\n            b-mylinks-footer\n            flatwidget__footer\n            js-link-color--a\"\n        >\n        <a\n            ng-href=\"{{siteroot}}/customize/options.bml?group=linkslist\"\n            target=\"_blank\"\n            lj-ml=\"widget.links.all\"\n            ></a>\n    </footer><!-- /footer -->\n\n\n\n</div>\n';
LJ.injectStyle('/* >>> file start: stc/widgets/mylinks.css */\n/* my links widgets (LJSUP-18522) */\n\n\n\n/*.b-mylinks {\n    }*/\n\n\n\n/* head */\n\n\n\n.b-mylinks-head {\n        position: relative;\n        margin: 0 0 13px;\n        margin: 0 0 0.8125rem;\n        padding: 0;\n        }\n\n\n\n/* header */\n\n\n\n.b-mylinks-header {\n            margin: 0;\n            padding: 0;\n            font-style: normal;\n            font-weight: normal;\n            font-size: 20px;\n            font-size: 1.25rem;\n            text-transform: uppercase;\n            color: #829399;\n            }\n\n\n\n/* title */\n\n\n\n.b-mylinks-title {\n                margin: 0;\n                }\n\n\n\n/* body */\n\n\n\n.b-mylinks-body {\n        margin: 0;\n        font-size: 14px;\n        font-size: 0.875rem;\n        }\n\n\n\n/* items */\n\n\n\n.b-mylinks-items {\n            margin: 0 0 19px;\n            margin: 0 0 1.2rem;\n            padding: 0;\n            list-style: none;\n            }\n\n\n\n/* item */\n\n\n\n.b-mylinks-item {\n                position: relative;\n                margin: 0;\n                padding: 0;\n                }\n\n\n\n/* link */\n\n\n\n.b-mylinks-item-link {\n                    display: inline-block;\n                    }\n\n\n\n/* emptiness */\n\n\n\n.b-mylinks-emptiness {\n        display: none;\n        margin: 0;\n        padding: 0.5em 0;\n        font-size: 1.2307em;\n        color: #829399;\n        }\n\n\n\n/* footer */\n\n\n\n.b-mylinks-footer {\n        margin: 0;\n        padding: 0;\n        font-size: 14px;\n        font-size: 0.875rem;\n        text-align: right;\n        }\n\n\n\n/* loading */\n\n\n\n.b-mylinks-loading {\n    }\n\n\n\n/* show */\n\n\n\n.b-mylinks-loading .b-mylinks-dummy {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.b-mylinks-loading .b-mylinks-items {\n        display: none;\n        }\n\n\n\n.b-mylinks-loading .b-mylinks-erroneous {\n        display: none;\n        }\n\n\n\n.b-mylinks-loading .b-mylinks-loginess {\n        display: none;\n        }\n\n\n\n.b-mylinks-loading .b-mylinks-emptiness {\n        display: none;\n        }\n\n\n\n/* empty */\n\n\n\n.b-mylinks-empty {\n    }\n\n\n\n/* show */\n\n\n\n.b-mylinks-empty .b-mylinks-emptiness {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.b-mylinks-empty .b-mylinks-counter {\n        display: none;\n        }\n\n\n\n.b-mylinks-empty .b-mylinks-footer {\n        display: none;\n        }\n\n\n\n.b-mylinks-empty .b-mylinks-dummy {\n        display: none;\n        }\n\n\n\n.b-mylinks-empty .b-mylinks-items {\n        display: none;\n        }\n\n/* <<< file end: stc/widgets/mylinks.css */\n\n/*# sourceMappingURL=mylinks.css.map */\n');

//= require_ml widget.links.title

angular.module('LJ.Widget.Links', []).directive('ljWidgetLinks', ['Api', function (Api) {
  return {
    templateUrl: 'links.ng.tmpl',
    link: function link(scope) {
      scope.isLoading = true;

      Api.call('friendsfeed.get_linkslist').then(function (response) {
        scope.items = response.linkslist;
        scope.isLoading = false;
      });

      scope.siteroot = LJ.get('siteroot');
    }
  };
}]);
/* <<< file end: js/widgets/angular/links.js */

//# map link was there [links.js.map]
/* >>> file start: js/core/angular/authHelper.js */
/**
 * /auth_helper.html is a callback URL for social network apps
 * Auth Helper module creates child window
 * and write auth token to cookie.
 *
 * Token is taking from #access_token=(.*) url hash
 *
 * e.g.:
 * AuthHelper.open($scope.backUrl)
 *  .then(function (token) {
 *    $scope.useToken(token);
 *    $scope.refresh();
 * });
 *
 */
(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.AuthHelper', []).factory('AuthHelper', ['$q', '$interval', function ($q, $interval) {
    var deferred,
        counterStop = 5 * 60 * 5; // 5 minutes

    function open(url) {
      var authWindow = window.open(url, 'Auth helper', 'height=450,width=650'),
          counter = 0,
          polling;
      deferred = $q.defer();

      // get auth status on child window close /auth_helper.html
      polling = $interval(function () {
        var token;
        counter++;

        if (authWindow.closed) {
          token = LJ.Cookie.get('_Auth_token');

          if (typeof token !== 'undefined') {
            deferred.resolve(token);
          } else {
            deferred.reject();
          }

          LJ.Cookie.setGlobal('_Auth_token', null);
          $interval.cancel(polling);
        }

        if (counter > counterStop) {
          $interval.cancel(polling);
        }
      }, 200);

      return deferred.promise;
    }

    return {
      open: open
    };
  }]);
})();
/* <<< file end: js/core/angular/authHelper.js */

//# map link was there [authHelper.js.map]
/* >>> file start: js/editor/media.js */
var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

//= require_ml media.ramblerkassa.title
/* eslint-disable angular/typecheck-function */
/* eslint-disable angular/typecheck-string */

LJ.define('LJ.Media');

/**
 * Parse link or embed html.
 *
 * @param  {String}   input  Input can contain link or html.
 * @param  {Object}   params Contain parameters of request
 * @param  {Boolean}  params.thumbnail Request a thumbnail
 *
 * @return {Promise}  Promise representing the media
 */

LJ.Media.parse = function ($) {
  'use strict';

  /**
   * Media provider factory
   *
   * @param {String}   name          Provider name
   * @param {Object}   config        Configuration object
   * @param {String}   config.link   Link with params that will be supplanted after params parsing
   * @param {Function} config.param  Function that extracts needed params from user input.
   *                                 It returns params object if input successfully parsed,
   *                                 otherwise null/undefined
   *
   * @param {String|Function} config.embed  Embed. If string - it will be supplanted with parsed params
   *                                        If function - it should return Promise that will be resolved with embed
   *   string
   *
   * @param {String|Function} [config.thumbnail]  Thumbnail. If string - it will be supplanted with parsed params
   *                                              If function - it should return Promise that will be resolved with
   *   thumbnail string
   */

  function Provider(name, config) {
    this.provider = name;
    $.extend(this, config);

    // provider cache for embeds and thumbnails
    this._cache = {};
  }

  /**
   * Parse user input
   *
   * @param  {String} input              User media input
   * @param  {Object} options            Additional parsing options
   * @param  {Boolean} options.thumbnail Parse thumbnail or not
   *
   * @return {Promise} Promise that will be resolved with object
   *                   that contains {link, embed, thumb, site}
   */
  Provider.prototype.parse = function (input, options) {
    var that = this,
        params = this.params(input, options),
        promises;


    if (!params) {
      return;
    }

    promises = [];

    // embed promise
    promises.push(typeof this.embed === 'string' ? this.toPromise(this.embed.supplant(params)) : this.embed(params));

    if (options.thumbnail && this.thumbnail) {

      // embed promise
      promises.push(typeof this.thumbnail === 'string' ? this.toPromise(this.thumbnail.supplant(params)) : this.thumbnail(params));
    }

    return $.when.apply($, promises).then(function (embed, thumb) {
      var bakedLink = '';
      if (typeof that.link === 'function') {
        bakedLink = that.link(params);
      } else if (typeof that.link === 'string') {
        bakedLink = that.link.supplant(params);
      }
      return {
        link: bakedLink,
        embed: embed,
        thumb: thumb,
        site: that.provider
      };
    });
  };

  /**
   * Cache or retrieve from cache item by key
   * @param  {String} key     Cache key
   * @param  {*}      [value] Value to cache; if not defined - method will
   *                          work as a getter
   */
  Provider.prototype.cache = function (key, value) {
    if (typeof value === 'undefined') {
      return this._cache[key];
    }

    this._cache[key] = value;
  };

  /**
   * Helper that return provided value as a resolved promise
   * @return {Promise} Resolved promise
   */
  Provider.prototype.toPromise = function (value) {
    var defer = $.Deferred();

    defer.resolve(value);
    return defer.promise();
  };

  var providers = {

    'ljVideo': new Provider('ljVideo', {
      link: 'https://vc.videos.livejournal.com/index/player?player=new&record_id={storageid}',
      embed: function embed(params) {
        return '<iframe data-link="{link}" data-thumb="{thumbnail}" frameBorder="0" height="315" src="{link}" width="560" allowfullscreen="allowfullscreen"></iframe>'.supplant(params);
      },
      thumbnail: function thumbnail(params) {
        return params.screenshot || this.cache(params.storageid);
      },
      params: function params(input, options) {
        var matcher = /.*livejournal\.com\/.*\?[\w=&]*record_id=(\d+).*$/,
            match = (typeof input === 'string' ? input : options.url).match(matcher);

        if (options.screenshot) {
          this.cache(options.storageid, options.screenshot);
        }

        return match && $.extend(options, { storageid: match[1] });
      }

    }),

    'coub': new Provider('coub', {
      link: '//coub.com/embed/{id}?muted=false&autostart=false&originalSize=false',
      embed: '<iframe src="//coub.com/embed/{id}?muted=false&autostart=false&originalSize=false&hideTopBar=false&startWithHD=false" allowfullscreen="true" frameborder="0" width="640" height="272"></iframe> ',
      thumbnail: function thumbnail(params) {
        var that = this,
            cached = this.cache(params.id);

        if (cached) {
          return this.toPromise(cached);
        } else {
          return this.toPromise(null); // do not do anything as long as coub API doesn't support JSONP, yet
        }

        return $.ajax({
          url: '//coub.com/api/v2/coubs/{id}'.supplant(params),
          dataType: 'json'
        }).then(function (response) {
          if (response) {
            var thumb = response.thumbnail_url;

            if (thumb) {
              that.cache(params.id, thumb);
              return thumb;
            }
          } else {
            console.error('Data error', response);
          }
        });
      },
      params: function params(input) {
        var matcher = /\/\/[w\.]*coub\.com\/embed\/(\w+)/,
            match = input.match(matcher);

        return match && { id: match[1] };
      }
    }),

    'youtube': new Provider('youtube', {
      link: 'https://youtube.com/watch?v={id}',
      thumbnail: 'https://img.youtube.com/vi/{id}/0.jpg',
      embed: '<iframe src="https://www.youtube.com/embed/{id}" width="560" height="315" frameborder="0" allowfullscreen data-link="https://youtube.com/watch?v={id}"></iframe>',

      params: function params(input) {
        var matcher = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\??v?=?))([^#\&\?]*).*/,
            match = input.match(matcher);

        if (match && match[0].indexOf('youtu') === -1) {
          return null;
        }

        return match && { id: match[7] };
      }
    }),

    'vimeo': new Provider('vimeo', {
      link: 'https://vimeo.com/{id}',
      embed: '<iframe src="https://player.vimeo.com/video/{id}" width="560" height="315" frameborder="0" allowfullscreen data-link="https://vimeo.com/{id}"></iframe>',

      params: function params(input) {
        // URLs formats:
        // https://vimeo.com/:id
        // https://player.vimeo.com/video/:id
        // https://vimeo.com/channels/:userId/:id
        var matcher = /^(https?:\/\/)?(www\.)?(player\.)?vimeo.com\/(video\/|channels\/\w+\/)?(\d+)*/,
            match = input.match(matcher);

        return match && { id: match[5] };
      },

      thumbnail: function thumbnail(params) {
        var that = this,
            cached = this.cache(params.id);


        if (cached) {
          return this.toPromise(cached);
        }

        return $.ajax({
          url: 'https://vimeo.com/api/v2/video/' + params.id + '.json',
          dataType: 'jsonp'
        }).then(function (response) {
          if (response && response[0]) {
            var thumb = response[0].thumbnail_large;

            if (thumb) {
              that.cache(params.id, thumb);
              return thumb;
            }
          } else {
            console.error('Data error', response);
          }
        });
      }
    }),

    'vine': new Provider('vine', {
      link: 'https://vine.co/v/{id}',
      embed: '<iframe src="https://vine.co/v/{id}/card" width="380" height="380" frameborder="0" data-link="https://vine.co/v/{id}"></iframe>',

      params: function params(input) {
        // https://vine.co/v/bdbF0i72uwA
        var matcher = /vine.co\/v\/([^\/]*)/,
            match = input.match(matcher);

        return match && { id: match[1] };
      }
    }),

    'gist': new Provider('gist', {
      link: 'https://gist.github.com/{id}',
      embed: '<div class="gh-gist" data-gist-id="{id}"><a href="https://gist.github.com/{id}">gist.github.com/{id}</a></div>',

      params: function params(input) {
        var matcher = /.*(?:gist\.github\.com\/)([^\/]+\/{1}[^\/]+)\/{0,1}$/,
            match = input.match(matcher);

        return match && { id: match[1] };
      }
    }),

    'rutube': new Provider('rutube', {
      link: 'https://rutube.ru/video/{id}/',
      embed: '<iframe src="https://rutube.ru/video/embed/{id}" width="560" height="315" frameborder="0" allowfullscreen data-link="https://rutube.ru/video/{id}/"></iframe>',

      params: function params(input) {

        // https://rutube.ru/video/015075383e2736aa4e864753167b0d49/
        var matcher = /^.*rutube.ru\/video(\/embed\/|\/private\/|\/)(\w{32}).*/,
            match = input.match(matcher);


        return match && { id: match[2] };
      },

      thumbnail: function thumbnail(params) {
        var that = this,
            cached = this.cache(params.id);


        if (cached) {
          return this.toPromise(cached);
        }

        return $.ajax({
          url: 'https://rutube.ru/api/video/' + params.id + '/?format=jsonp',
          dataType: 'jsonp'
        }).done(function (response) {
          if (response && response.thumbnail_url) {
            var thumb = response.thumbnail_url;

            if (thumb) {
              that.cache(params.id, thumb);
              return thumb;
            }
          } else {
            console.error('Data error', response);
          }
        });
      }
    }),

    'twitter': new Provider('twitter', {
      link: 'https://twitter.com/{username}/status/{id}',

      params: function params(input) {
        var matcher = /^.*twitter.com\/(\w*)\/status\/(\w*).*/,
            match = input.match(matcher);

        return match && { id: match[2], username: match[1] };
      },

      embed: function embed(params) {
        var that = this,
            cached = this.cache(params.id);


        if (cached) {
          return this.toPromise(cached);
        }

        return $.ajax({
          url: 'https://api.twitter.com/1/statuses/oembed.json?id={id}'.supplant({ id: params.id }),
          dataType: 'jsonp'
        }).then(function (response) {

          // Remove all script tags
          var result = response.html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

          that.cache(params.id, result);
          return result;
        });
      }
    }),

    'facebook': new Provider('facebook', {
      link: '{link}',

      params: function params(input) {
        var matcher = /(^.*facebook.com\/.*)/,
            match = input.match(matcher);

        return match && { link: match[1] };
      },

      embed: function embed(params) {
        var that = this,
            embed = void 0,
            matcher = /(^.*facebook.com\/)(\d*)(\/.*)/,
            match = params.link.match(matcher),
            isVideo = params.link.match(/video\.php/),
            defer = $.Deferred(),
            // eslint-disable-line new-cap
        userid = match && match[2],
            cached = this.cache(params.link),
            result = void 0;

        if (isVideo) {
          embed = '<iframe src="{link}" width="560" height="315" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true" allowFullScreen="true"></iframe>';
        } else {
          embed = '<div class="fb-post" data-href="{link}" data-width="500"><div class="fb-xfbml-parse-ignore"><a href="{link}">Facebook post</a></div></div>';
        }

        if (cached) {
          return this.toPromise(cached);
        }

        // Notice:
        //  Facebook doesn't support embeds for posts that contains userid
        //  instead of usernames at the moment. That is why we get username by user id
        //
        // For example:
        //  https://www.facebook.com/717311163/posts/10153033960491164 is not supported,
        // but
        //  https://www.facebook.com/galina.timchenko.7/posts/10153033960491164 is supported
        //
        // Try it out here:
        //  https://developers.facebook.com/docs/plugins/embedded-posts
        if (userid) {
          LJ.Social.load('facebook').then(function () {
            FB.api(userid, function (response) {
              var link = params.link.replace(matcher, '$1' + response.username + '$3');

              result = embed.supplant({ link: link });

              that.cache(params.link, result);
              defer.resolve(result);
            });
          });
        } else {
          result = embed.supplant({ link: params.link });

          this.cache(params.link, result);
          defer.resolve(result);
        }

        return defer.promise();
      }
    }),

    'ramblerKassa': new Provider('ramblerKassa', {
      link: 'https://kassa.rambler.ru/movie/{id}',
      embed: '<lj-rkassa id="{id}" title="' + LJ.ml('media.ramblerkassa.title') + '" />',

      params: function params(input) {
        var matcher = /kassa\.rambler\.ru\/movie\/(\d+)$/,
            match = input.match(matcher);

        return match && { id: match[1] };
      }
    }),

    'ljEmbed': new Provider('ljEmbed', {
      link: '{link}',
      embed: '{link}',

      params: function params(input) {
        var matcher = getLjEmbedRegex(true),
            match = input.match(matcher);

        return match && { link: input };
      }
    })
  },
      providerRecipes = {
    telegram: {
      config: {
        link: function link(params) {
          var id = params.id;

          return '//t.me/' + id;
        },
        embed: function embed(params) {
          var id = params.id;

          return '<blockquote class=\'telegram-post\' data-telegram-post=\'' + id + '\' data-width=560><a href=\'//t.me/' + id + '\'>https://t.me/' + id + '</a></blockquote>';
        },
        params: function params(input) {
          var matcher = /t.me\/([^\/]+\/[0-9]+)/;
          if (input.indexOf('script') > -1) {
            matcher = /data-telegram-post=["']([^"']*)["']/;
          }
          var blobMatch = input.match(matcher);

          if (!blobMatch || !blobMatch[1] || blobMatch[1].indexOf('/') === -1) {
            return null;
          }

          return {
            id: blobMatch[1]
          };
        }
      }
    },
    instagram: {
      config: {
        link: function link(params) {
          return 'https://instagram.com/p/' + params.id + '/';
        },
        embed: function embed(params) {
          var id = params.id;

          return ('<blockquote\n              lj-screenable="social:newinsta:parse"\n              class="instagram-media"\n              data-instgrm-captioned="data-instgrm-captioned"\n              data-instgrm-version="7"\n            >\n              <a href="https://instagram.com/p/' + id + '" target="_blank" rel="nofollow">https://instagram.com/p/' + id + '</a>\n            </blockquote>').replace(/\n/g, '').replace(/\s+/g, ' ');
        },
        params: function params(input) {
          // eslint-disable-next-line no-useless-escape
          var matcher = /.*(?:instagram\.\w*|instagr\.am)\/p\/([^\/]+).*/,
              match = input.match(matcher);


          return match && { id: match[1] };
        }
      }
    }
  };

  // We avoid duplication of providers among various parts of code (including Post2017).
  // To do this, we export `providerRecipes`, from which all parts of code can build similar providers.

  Object.keys(providerRecipes).forEach(function (recipeKey) {
    providers[recipeKey] = new Provider(recipeKey, providerRecipes[recipeKey].config);
  });
  LJ.Media.providerRecipes = providerRecipes;

  /**
   * Parse media content
   *
   * @param  {String}   input                     User content
   * @param  {Object}   [options]                 Options
   * @param  {Boolean}  [options.thumbnail=true]  Get thumbnail or not
   *
   * @return {Promise}  Promise that will be resilved with {site, embed, link, thumbnail}
   */
  function parseMediaLink(input, options) {
    var provider, promise;

    for (provider in providers) {
      if (providers.hasOwnProperty(provider)) {
        promise = providers[provider].parse(input, options);

        if (promise) {
          return promise;
        }
      }
    }

    return null;
  }

  function parse(input, options) {
    options = $.extend({ thumbnail: true }, options || {});

    // jQuery can fail on input
    try {
      var node = $(input).first(),
          src;

      if (node && node.prop('tagName').toLowerCase() === 'iframe') {
        src = node && node.attr('src');

        if (src && src.match(getLjEmbedRegex())) {
          return parseMediaLink(input, options);
        }

        if (src) {
          return parseMediaLink(src, options);
        }
      }
      if (node && node.prop('tagName').toLowerCase() === 'script') {
        return parseMediaLink(input, _extends({}, options, {
          tagName: 'script'
        }));
      }
    } catch (e) {
      return parseMediaLink(input, options);
    }
  }

  function getLjEmbedRegex(forIframe) {
    var root = LJ.get('siteroot').split(/https?:\/\/www\./)[1].replace(/\./g, '\\.'),
        urlPattern = '(?:(?:https?:)?//)?[-\\w]{1,15}\\.' + root + '/\\d+.html.*?[&?]embed\\b';

    return forIframe ? new RegExp('<iframe.*src="' + urlPattern + '".*></iframe>') : new RegExp('^' + urlPattern);
  }

  return parse;
}(jQuery);
/* <<< file end: js/editor/media.js */

//# map link was there [media.js.map]
/* >>> file start: js/widgets/angular/social.js */

//= require js/core/angular/options.js
//= require js/core/angular/api.js
//= require js/core/angular/authHelper.js
//= require js/core/string.js
//= require js/editor/media.js

Site.page.template['angular/widgets/social/twitter.ng.tmpl'] = '<!-- my updates (LJSUP-18034) -->\n\n<div\n    class=\"\n        b-mysocial\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-mysocial-empty\': status.isEmpty,\n        \'b-mysocial-error\': status.isError,\n        \'b-mysocial-login\': status.isLogin,\n        \'b-mysocial-refreshing\': status.isRefreshing,\n        \'b-mysocial-loading\': status.isLoading,\n        \'b-mysocial-showmore\': status.noMore\n    }\"\n    >\n\n\n\n    <!-- head -->\n    <header\n        id=\"twitter\"\n        class=\"\n            b-mysocial-head\n            flatwidget__head\"\n        >\n\n        <h3 class=\"b-mysocial-header\"><!--\n\n            --><span\n                class=\"\n                    b-mysocial-title\n                    js-elem-color\n                    \"\n                lj-ml=\"widget.social.twitter.title\"\n                ng-click=\"refresh()\"\n                ></span><!--\n            --><span\n                ng-click=\"refresh()\"\n                lj-svg-icon=\"flaticon--spinner\"\n                class=\"\n                    b-mysocial-refresh\n                    js-elem-color--svgicon\n                    \"\n                ></span><!--\n\n        --></h3>\n\n    </header><!-- /head -->\n\n\n\n    <!-- body -->\n    <div\n        class=\"\n            b-mysocial-body\n            flatwidget__body\n            js-link-color--a\">\n\n        <!-- items -->\n        <ul class=\"b-mysocial-items\"\n            ng-if=\"items\"\n            >\n\n            <li\n                class=\"\n                    b-mysocial-item\n                    js-elem-bordercolor\n                    \"\n                ng-repeat=\"item in items | limitTo: status.itemsLimit\"\n                >\n\n                <!-- retweet -->\n                <div\n                    class=\"b-mysocial-item-retweet\"\n                    ng-if=\"item.retweeted_status\"\n                    >\n                    <span\n                        class=\"\n                            b-mysocial-item-rt\n                            js-sidebar-color\"\n                        lj-ml=\"widget.social.twitter.retweet\"\n                        ></span>\n                    <a\n                        ng-href=\"{{ \'https://twitter.com/\' + item.user.screen_name }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-username\"\n                        ng-bind=\"item.user.screen_name\"\n                        ></a>\n                </div><!-- /retweet -->\n\n                <!-- meta -->\n                <div class=\"b-mysocial-item-meta\">\n\n                    <!-- user -->\n                    <a\n                        ng-href=\"{{ \'https://twitter.com/\' + item.user.screen_name }}\"\n                        ng-if=\"!item.retweeted_status\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-user\"\n                        >\n                        <span\n                            ng-style=\"{ backgroundImage: \'url(\' + item.user.profile_image_url_https + \')\' }\"\n                            class=\"b-mysocial-item-userpic\"\n                            ></span>\n                        <strong\n                            ng-bind=\"item.user.screen_name\"\n                            class=\"b-mysocial-item-username\"\n                            ></strong>\n                    </a>\n\n                    <!-- user on retweet -->\n                    <a\n                        ng-href=\"{{ \'https://twitter.com/\' + item.retweeted_status.user.screen_name }}\"\n                        ng-if=\"item.retweeted_status\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-user\"\n                        >\n                        <span\n                            ng-style=\"{ backgroundImage: \'url(\' + item.retweeted_status.user.profile_image_url_https + \')\' }\"\n                            class=\"b-mysocial-item-userpic\"\n                            ></span>\n                        <strong\n                            ng-bind=\"item.retweeted_status.user.screen_name\"\n                            class=\"b-mysocial-item-username\"\n                            ></strong>\n                    </a>\n\n                    <!-- link -->\n                    <a\n                        ng-href=\"{{ \'https://twitter.com/\' + item.user.screen_name + \'/status/\' + item.id_str }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-link\"\n                        >\n                        <time\n                            class=\"b-mysocial-item-date\"\n                            ng-bind=\"item.time\"\n                            ></time>\n                    </a>\n\n                    <ul class=\"b-mysocial-item-actions\">\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do retweet -->\n                            <span\n                                lj-ml-attr=\"widget.social.twitter.doretweet\"\n                                class=\"b-mysocial-item-doretweet\"\n                                style=\"display:none;\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.twitter.doretweet\"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    ></span>\n                            </span>\n                        </li>\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do fav -->\n                            <span\n                                lj-ml-attr=\"widget.social.twitter.dofav\"\n                                class=\"b-mysocial-item-dofav\"\n                                style=\"display:none;\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.twitter.dofav\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    ></span>\n                            </span>\n                        </li>\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do repost -->\n                            <a\n                                ng-href=\"{{ item.ljRepost }}\"\n                                ng-show=\"item.ljRepost\"\n                                lj-ml-attr=\"widget.social.twitter.dorepost\"\n                                target=\"_blank\"\n                                class=\"b-mysocial-item-dorepost\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.twitter.dorepost\"\n                                    lj-ml-attr=\"title\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    ></span>\n                            </a>\n                        </li>\n                    </ul>\n\n                </div><!-- /meta -->\n\n                <!-- content -->\n                <div\n                    class=\"b-mysocial-item-content\"\n                    lj-html=\"item.text\"\n                    ></div><!-- /content -->\n\n            </li>\n\n        </ul><!-- /items -->\n\n        <!-- loadmore button -->\n        <div\n            class=\"\n                b-mysocial-loadmore\n                js-elem-bordercolor\n                \">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    \"\n                lj-ml=\"widget.social.twitter.loadmore\"\n                ng-click=\"showMore()\"\n                ></span>\n        </div>\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-mysocial-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n        <!-- erroneous message -->\n        <p\n            class=\"b-mysocial-erroneous\"\n            lj-ml=\"widget.social.twitter.error\"\n            ></p>\n\n        <!-- loginess button -->\n        <div class=\"b-mysocial-loginess\">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    b-flatbutton-twitter\n                    \"\n                ng-click=\"login()\"\n                >\n                <span\n                    class=\"b-flatbutton-icon\"\n                    ></span>\n                <span\n                    class=\"b-flatbutton-title\"\n                    lj-ml=\"widget.social.twitter.login\"\n                    ></span>\n            </span>\n        </div>\n\n        <!-- emptiness message -->\n        <p\n            class=\"b-mysocial-emptiness\"\n            lj-ml=\"widget.social.twitter.empty\"\n            ></p>\n\n    </div><!-- /body -->\n\n\n\n    <!-- footer -->\n    <footer\n        class=\"\n            b-mysocial-footer\n            flatwidget__footer\"\n        >\n        <span\n            ng-click=\"refresh()\"\n            lj-ml=\"widget.social.twitter.refresh\"\n            class=\"\n                b-mysocial-footer-refresh\n                js-link-color\"\n            ></span>\n        <span\n            ng-click=\"logout()\"\n            class=\"\n                b-mysocial-footer-logout\n                js-link-color\"\n            >\n            <span\n                class=\"b-mysocial-footer-logout-text\"\n                lj-ml=\"widget.social.twitter.logout\">\n            </span>\n            <span\n                lj-ml=\"widget.social.twitter.logout\"\n                lj-ml-attr=\"title\"\n                lj-svg-icon=\"flaticon--logout\"\n                class=\"\n                    b-mysocial-footer-logout-icon\n                    js-elem-color--svgicon\n                    \"\n                ></span>\n        </span>\n        <a\n            ng-href=\"https://www.twitter.com/\"\n            lj-ml=\"widget.social.twitter.all\"\n            target=\"_blank\"\n            class=\"\n                b-mysocial-footer-all\n                js-link-color\"\n            ></a>\n    </footer><!-- /footer -->\n\n\n\n</div>\n\n\n';
Site.page.template['angular/widgets/social/facebook.ng.tmpl'] = '<!-- my updates (LJSUP-18034) -->\n\n\n\n<div\n    class=\"\n        b-mysocial\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-mysocial-empty\': status.isEmpty,\n        \'b-mysocial-error\': status.isError,\n        \'b-mysocial-login\': status.isLogin,\n        \'b-mysocial-refreshing\': status.isRefreshing,\n        \'b-mysocial-loading\': status.isLoading,\n        \'b-mysocial-showmore\': status.noMore\n    }\"\n    >\n\n\n\n    <!-- head -->\n    <header\n        id=\"facebook\"\n        class=\"\n            b-mysocial-head\n            flatwidget__head\"\n        >\n\n        <h3 class=\"b-mysocial-header\"><!--\n\n            --><span\n                class=\"\n                    b-mysocial-title\n                    js-elem-color\n                    \"\n                lj-ml=\"widget.social.facebook.title\"\n                ng-click=\"refresh()\"\n                ></span><!--\n            --><span\n                ng-click=\"refresh()\"\n                lj-svg-icon=\"flaticon--spinner\"\n                class=\"\n                    b-mysocial-refresh\n                    js-elem-color--svgicon\n                    \"\n                ></span><!--\n        --></h3>\n\n    </header><!-- /head -->\n\n\n\n    <!-- body -->\n    <div\n        class=\"\n            b-mysocial-body\n            flatwidget__body\n            js-link-color--a\"\n        >\n\n        <!-- items -->\n        <ul\n            class=\"b-mysocial-items\"\n            ng-if=\"items\"\n            >\n\n            <li\n                class=\"\n                    b-mysocial-item\n                    js-elem-bordercolor\n                    \"\n                ng-repeat=\"item in items | limitTo: status.itemsLimit\"\n                >\n\n                <!-- meta -->\n                <div class=\"b-mysocial-item-meta\">\n\n                    <!-- user -->\n                    <a\n                        ng-href=\"https://facebook.com/{{item.from.id}}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-user\"\n                        >\n                        <span\n                            class=\"b-mysocial-item-userpic\"\n                            ng-style=\"{ backgroundImage: \'url(https://graph.facebook.com/\' + item.from.id + \'/picture?type=square)\' }\"\n                            ></span>\n                        <strong\n                            class=\"b-mysocial-item-username\"\n                            ng-bind=\"item.from.name\"\n                            ></strong>\n                    </a>\n\n                    <!-- link -->\n                    <a\n                        ng-href=\"{{ item.permalink }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-link\"\n                        >\n                        <time\n                            class=\"b-mysocial-item-date\"\n                            ng-bind=\"item.time\"\n                            ></time>\n                    </a>\n\n                    <ul class=\"b-mysocial-item-actions\">\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do like -->\n                            <span\n                                lj-ml=\"widget.social.facebook.dolike\"\n                                lj-ml-attr=\"title\"\n                                class=\"b-mysocial-item-dolike\"\n                                style=\"display:none;\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.facebook.dolike\"\n                                    lj-ml-attr=\"title\"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    ></span>\n                            </span>\n                        </li>\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do repost -->\n                            <a\n                                ng-href=\"{{ item.ljRepost }}\"\n                                ng-show=\"item.ljRepost\"\n                                lj-ml=\"widget.social.facebook.dorepost\"\n                                lj-ml-attr=\"title\"\n                                target=\"_blank\"\n                                class=\"b-mysocial-item-dorepost\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.facebook.dorepost\"\n                                    lj-ml-attr=\"title\"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    ></span>\n                            </a>\n                        </li>\n                    </ul>\n\n                </div><!-- /meta -->\n\n                <!-- content -->\n                <div\n                    class=\"b-mysocial-item-content\"\n                    lj-html=\"item.text\"\n                    ></div><!-- /content -->\n\n                <!-- image -->\n                <div\n                    class=\"b-mysocial-item-picture\"\n                    ng-if=\"item.picture && item.object_id\"\n                    >\n                    <a\n                        ng-href=\"{{ item.link }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-picture-link\"\n                        >\n                        <img\n                            ng-src=\"{{ item.picture }}\"\n                            alt=\"\"\n                            class=\"b-mysocial-item-picture-image\"\n                            >\n                    </a>\n                </div><!-- /image -->\n\n                <!-- external -->\n                <div\n                    class=\"b-mysocial-item-external\"\n                    ng-if=\"item.link && !item.object_id\"\n                    >\n                    <a\n                        ng-href=\"{{ item.link }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-external-link\"\n                        >\n                        <!-- external title -->\n                        <h4\n                            class=\"b-mysocial-item-external-title\"\n                            ng-bind=\"item.name\"\n                            ></h4>\n                        <!-- external wrapper -->\n                        <div class=\"b-mysocial-item-external-wrapper\">\n                            <img\n                                ng-src=\"{{ item.picture }}\"\n                                class=\"b-mysocial-item-external-image\"\n                            >\n                            <p\n                                class=\"b-mysocial-item-external-text\"\n                                >{{item.description}}</p>\n                        </div>\n                    </a>\n                </div><!-- /external -->\n\n            </li>\n\n        </ul><!-- /items -->\n\n        <!-- loadmore button -->\n        <div\n            class=\"\n                b-mysocial-loadmore\n                js-elem-bordercolor\n                \">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    \"\n                ng-hide=\"status.hideMoreButton\"\n                lj-ml=\"widget.social.facebook.loadmore\"\n                ng-click=\"showMore()\"\n                ></span>\n        </div>\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-mysocial-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n        <!-- erroneous message -->\n        <p\n            class=\"b-mysocial-erroneous\"\n            lj-ml=\"widget.social.facebook.error\"\n            ></p>\n\n        <!-- loginess button -->\n        <div class=\"b-mysocial-loginess\">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    b-flatbutton-facebook\n                    \"\n                ng-click=\"login()\"\n                >\n                <span\n                    class=\"b-flatbutton-icon\"\n                    ></span>\n                <span\n                    class=\"b-flatbutton-title\"\n                    lj-ml=\"widget.social.facebook.login\"\n                    ></span>\n            </span>\n        </div>\n\n        <!-- emptiness message -->\n        <p\n            class=\"b-mysocial-emptiness\"\n            lj-ml=\"widget.social.facebook.empty\"\n            ></p>\n\n    </div><!-- /body -->\n\n\n\n    <!-- footer -->\n    <footer\n        class=\"\n            b-mysocial-footer\n            flatwidget__footer\"\n        >\n        <span\n            class=\"\n                b-mysocial-footer-refresh\n                js-link-color\n                \"\n            lj-ml=\"widget.social.facebook.refresh\"\n            ng-click=\"refresh()\"\n            ></span>\n        <span\n            ng-click=\"logout()\"\n            class=\"\n                b-mysocial-footer-logout\n                js-link-color\n                \">\n            <span\n                class=\"b-mysocial-footer-logout-text\"\n                lj-ml=\"widget.social.facebook.logout\">\n            </span>\n            <span\n                lj-ml=\"widget.social.facebook.logout\"\n                lj-ml-attr=\"title\"\n                lj-svg-icon=\"flaticon--logout\"\n                class=\"\n                    b-mysocial-footer-logout-icon\n                    js-elem-color--svgicon\n                    \"\n                ></span>\n        </span>\n        <a\n            ng-href=\"https://www.facebook.com/\"\n            class=\"\n                b-mysocial-footer-all\n                js-link-color\"\n            target=\"_blank\"\n            lj-ml=\"widget.social.facebook.all\"\n            ></a>\n    </footer><!-- /footer -->\n\n\n\n</div>\n\n\n';
Site.page.template['angular/widgets/social/instagram.ng.tmpl'] = '<!-- my updates (LJSUP-18034 & LJSUP-18883) -->\n\n\n\n<div\n    class=\"\n        b-mysocial\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-mysocial-empty\': status.isEmpty,\n        \'b-mysocial-error\': status.isError,\n        \'b-mysocial-login\': status.isLogin,\n        \'b-mysocial-refreshing\': status.isRefreshing,\n        \'b-mysocial-loading\': status.isLoading,\n        \'b-mysocial-showmore\': status.noMore\n    }\"\n    >\n\n\n\n    <!-- head -->\n    <header\n        id=\"instagram\"\n        class=\"\n            b-mysocial-head\n            flatwidget__head\"\n        >\n\n        <h3 class=\"b-mysocial-header\"><!--\n\n            --><span\n                class=\"\n                    b-mysocial-title\n                    js-elem-color\n                    \"\n                lj-ml=\"widget.social.instagram.title\"\n                ng-click=\"refresh()\"\n                ></span><!--\n            --><span\n                ng-click=\"refresh()\"\n                lj-svg-icon=\"flaticon--spinner\"\n                class=\"\n                    b-mysocial-refresh\n                    js-elem-color--svgicon\n                    \"\n                ></span><!--\n        --></h3>\n\n    </header><!-- /head -->\n\n\n\n    <!-- body -->\n    <div\n        class=\"\n            b-mysocial-body\n            flatwidget__body\n            js-link-color--a\"\n        >\n\n        <!-- items -->\n        <ul\n            class=\"b-mysocial-items\"\n            ng-if=\"items\"\n            >\n\n            <li\n                class=\"\n                    b-mysocial-item\n                    js-elem-bordercolor\n                    \"\n                ng-repeat=\"item in items | limitTo: status.itemsLimit\"\n                >\n\n                <!-- meta -->\n                <div class=\"b-mysocial-item-meta\">\n\n                    <!-- user -->\n                    <a\n                        ng-href=\"https://instagram.com/{{item.user.username}}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-user\"\n                        >\n                        <span\n                            class=\"b-mysocial-item-userpic\"\n                            ng-style=\"{ backgroundImage: \'url(\' + item.user.profile_picture + \')\'}\"\n                            ></span>\n                        <strong\n                            class=\"b-mysocial-item-username\"\n                            ng-bind=\"item.user.username\"\n                            ></strong>\n                    </a>\n\n                    <!-- link -->\n                    <a\n                        ng-href=\"{{ item.link }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-link\"\n                        >\n                        <time\n                            class=\"b-mysocial-item-date\"\n                            ng-bind=\"item.time\"\n                            ></time>\n                    </a>\n\n                    <ul class=\"b-mysocial-item-actions\">\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do like -->\n                            <span\n                                lj-ml=\"widget.social.instagram.dolike\"\n                                lj-ml-attr=\"title\"\n                                class=\"b-mysocial-item-dolike\"\n                                style=\"display:none;\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.instagram.dolike\"\n                                    lj-ml-attr=\"title\"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    ></span>\n                            </span>\n                        </li>\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do repost -->\n                            <a\n                                ng-href=\"{{item.ljRepost}}\"\n                                ng-show=\"item.ljRepost\"\n                                lj-ml=\"widget.social.instagram.dorepost\"\n                                lj-ml-attr=\"title\"\n                                class=\"b-mysocial-item-dorepost\"\n                                target=\"_blank\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.instagram.dorepost\"\n                                    lj-ml-attr=\"title\"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    ></span>\n                            </a>\n                        </li>\n                    </ul>\n\n                </div><!-- /meta -->\n\n                <!-- image -->\n                <div\n                    class=\"b-mysocial-item-picture\"\n                    ng-if=\"item.images.standard_resolution.url\"\n                    >\n                    <a\n                        ng-href=\"{{ item.link }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-picture-link\"\n                        >\n                        <img\n                            ng-src=\"{{ item.images.standard_resolution.url }}\"\n                            alt=\"\"\n                            class=\"b-mysocial-item-picture-image\"\n                            >\n                    </a>\n                </div><!-- /image -->\n\n                <!-- content -->\n                <div\n                    class=\"b-mysocial-item-content\"\n                    lj-html=\"item.text\"\n                    ></div><!-- /content -->\n\n            </li>\n\n        </ul><!-- /items -->\n\n        <!-- loadmore button -->\n        <div\n            class=\"\n                b-mysocial-loadmore\n                js-elem-bordercolor\n                \">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    \"\n                ng-hide=\"status.hideMoreButton\"\n                lj-ml=\"widget.social.instagram.loadmore\"\n                ng-click=\"showMore()\"\n                ></span>\n        </div>\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-mysocial-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n        <!-- erroneous message -->\n        <p\n            class=\"b-mysocial-erroneous\"\n            lj-ml=\"widget.social.instagram.error\"\n            ></p>\n\n        <!-- loginess button -->\n        <div class=\"b-mysocial-loginess\">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    b-flatbutton-instagram\n                    \"\n                ng-click=\"login()\"\n                >\n                <span\n                    class=\"b-flatbutton-icon\"\n                    ></span>\n                <span\n                    class=\"b-flatbutton-title\"\n                    lj-ml=\"widget.social.instagram.login\"\n                    ></span>\n            </span>\n        </div>\n\n        <!-- emptiness message -->\n        <p\n            class=\"b-mysocial-emptiness\"\n            lj-ml=\"widget.social.instagram.empty\"\n            ></p>\n\n    </div><!-- /body -->\n\n\n\n    <!-- footer -->\n    <footer\n        class=\"\n            b-mysocial-footer\n            flatwidget__footer\"\n        >\n        <span\n            class=\"\n                b-mysocial-footer-refresh\n                js-link-color\n                \"\n            lj-ml=\"widget.social.instagram.refresh\"\n            ng-click=\"refresh()\"\n            ></span>\n        <span\n            class=\"\n                b-mysocial-footer-logout\n                js-link-color\n                \"\n            ng-click=\"logout()\"\n            >\n            <span\n                lj-ml=\"widget.social.instagram.logout\"\n                class=\"b-mysocial-footer-logout-text\">\n            </span>\n            <span\n                lj-ml=\"widget.social.instagram.logout\"\n                lj-ml-attr=\"title\"\n                lj-svg-icon=\"flaticon--logout\"\n                class=\"\n                    b-mysocial-footer-logout-icon\n                    js-elem-color--svgicon\n                    \"\n                ></span>\n        </span>\n        <a\n            ng-href=\"https://www.instagram.com/\"\n            class=\"\n                b-mysocial-footer-all\n                js-link-color\"\n            target=\"_blank\"\n            lj-ml=\"widget.social.instagram.all\"\n            ></a>\n    </footer><!-- /footer -->\n\n\n\n</div>\n\n\n';
Site.page.template['angular/widgets/social/tumblr.ng.tmpl'] = '<!-- my updates (LJSUP-19134) -->\n\n\n\n<div\n    class=\"\n        b-mysocial\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'b-mysocial-empty\': status.isEmpty,\n        \'b-mysocial-error\': status.isError,\n        \'b-mysocial-login\': status.isLogin,\n        \'b-mysocial-refreshing\': status.isRefreshing,\n        \'b-mysocial-loading\': status.isLoading,\n        \'b-mysocial-showmore\': status.noMore\n    }\"\n    >\n\n\n\n    <!-- head -->\n    <header\n        id=\"tumblr\"\n        class=\"\n            b-mysocial-head\n            flatwidget__head\"\n        >\n\n        <h3 class=\"b-mysocial-header\"><!--\n\n            --><span\n                class=\"\n                    b-mysocial-title\n                    js-elem-color\n                    \"\n                lj-ml=\"widget.social.tumblr.title\"\n                ng-click=\"refresh()\"\n                ></span><!--\n            --><span\n                ng-click=\"refresh()\"\n                lj-svg-icon=\"flaticon--spinner\"\n                class=\"\n                    b-mysocial-refresh\n                    js-elem-color--svgicon\n                    \"\n                ></span><!--\n        --></h3>\n\n    </header><!-- /head -->\n\n\n\n    <!-- body -->\n    <div\n        class=\"\n            b-mysocial-body\n            flatwidget__body\n            js-link-color--a\"\n            >\n\n        <!-- items -->\n        <ul\n            class=\"b-mysocial-items\"\n            ng-if=\"items\"\n            >\n\n            <li\n                class=\"\n                    b-mysocial-item\n                    js-elem-bordercolor\n                    \"\n                ng-repeat=\"item in items | limitTo: status.itemsLimit\"\n                >\n\n                <!-- meta -->\n                <div class=\"b-mysocial-item-meta\">\n\n                    <!-- user -->\n                    <a\n                        ng-href=\"http://{{ item.blog_name }}.tumblr.com/\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-user\"\n                        >\n                        <span\n                            class=\"b-mysocial-item-userpic\"\n                            ng-style=\"{ backgroundImage: \'url(https://api.tumblr.com/v2/blog/{{ item.blog_name }}.tumblr.com/avatar/150)\' }\"\n                            ></span>\n                        <strong\n                            class=\"b-mysocial-item-username\"\n                            ng-bind=\"item.blog_name\"\n                            ></strong>\n                    </a>\n\n                    <!-- link -->\n                    <a\n                        ng-href=\"{{ item.short_url }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-link\"\n                        >\n                        <time\n                            class=\"b-mysocial-item-date\"\n                            ng-bind=\"item.time\"\n                            ></time>\n                    </a>\n\n                    <ul class=\"b-mysocial-item-actions\">\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do like -->\n                            <span\n                                lj-ml=\"widget.social.tumblr.dolike\"\n                                lj-ml-attr=\"title\"\n                                class=\"b-mysocial-item-dolike\"\n                                style=\"display:none;\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.tumblr.dolike\"\n                                    lj-ml-attr=\"title\"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    ></span>\n                            </span>\n                        </li>\n                        <li class=\"b-mysocial-item-action\">\n                            <!-- do repost -->\n                            <a\n                                ng-href=\"{{ item.ljRepost }}\"\n                                ng-show=\"item.ljRepost\"\n                                lj-ml=\"widget.social.tumblr.dorepost\"\n                                lj-ml-attr=\"title\"\n                                target=\"_blank\"\n                                class=\"b-mysocial-item-dorepost\"\n                                >\n                                <span\n                                    lj-ml=\"widget.social.tumblr.dorepost\"\n                                    lj-ml-attr=\"title\"\n                                    lj-svg-icon=\"flaticon--edit_entry\"\n                                    class=\"\n                                        b-mysocial-item-icon\n                                        js-elem-color--svgicon\n                                        \"\n                                    ></span>\n                            </a>\n                        </li>\n                    </ul>\n\n                </div><!-- /meta -->\n\n                <!-- title -->\n                <h4 class=\"b-mysocial-item-title\"\n                    ng-if=\"item.title && !item.url\"\n                    ng-bind=\"item.title\"\n                    ></h4>\n                <h4 class=\"b-mysocial-item-title\"\n                    ng-if=\"item.title && item.url\"\n                    >\n                    <a\n                        ng-href=\"{{ item.url }}\"\n                        ng-bind=\"item.title\"\n                        target=\"_blank\"\n                        ></a>\n                </h4>\n\n                <!-- quote -->\n                <blockquote\n                    class=\"b-mysocial-item-quote\"\n                    ng-if=\"item.type === \'quote\'\"\n                    ng-class=\"{\n                        \'b-mysocial-item-clipped\': item.state === \'cut\'\n                    }\"\n                    >\n                    <!-- qoute -->\n                    <div\n                        class=\"b-mysocial-item-quote-text\"\n                        ng-if=\"item.text\"\n                        lj-html=\"item.text\"\n                        ></div>\n                    <!-- source -->\n                    <footer class=\"b-mysocial-item-quote-source\">\n                        <cite lj-html=\"item.source\"></cite>\n                    </footer>\n                </blockquote><!-- /quote -->\n\n                <!-- answer -->\n                <div\n                    class=\"b-mysocial-item-reply\"\n                    ng-if=\"item.question\"\n                    >\n                    <!-- question -->\n                    <blockquote class=\"b-mysocial-item-reply-question\">\n                        <p\n                            class=\"b-mysocial-item-reply-question-text\"\n                            ng-bind=\"item.question\"\n                            ></p>\n                        <footer class=\"b-mysocial-item-reply-question-source\">\n                            <cite>\n                                <a\n                                    ng-href=\"{{ item.asking_url }}\"\n                                    ng-bind=\"item.asking_name\"\n                                    target=\"_blank\"\n                                    ></a>\n                            </cite>\n                        </footer>\n                    </blockquote>\n                    <!-- answer -->\n                    <div\n                        class=\"b-mysocial-item-reply-answer\"\n                        lj-html=\"item.answer\"\n                        ></div>\n                </div>\n\n                <!-- embed -->\n                <div\n                    class=\"b-mysocial-item-embed\"\n                    ng-if=\"item.player\"\n                    >\n                    <div\n                        class=\"b-mysocial-item-embed-item\"\n                        lj-html=\"item.player[1].embed_code\"\n                        ></div>\n                </div>\n                <div\n                    class=\"b-mysocial-item-embed\"\n                    ng-if=\"item.embed\"\n                    >\n                    <div\n                        class=\"b-mysocial-item-embed-item\"\n                        lj-html=\"item.embed\"\n                        ></div>\n                </div>\n\n                <!-- photo -->\n                <div\n                    class=\"b-mysocial-item-photo\"\n                    ng-if=\"item.photos.length\"\n                    >\n                    <figure\n                        class=\"b-mysocial-item-photo-item\"\n                        ng-repeat=\"photo in item.photos | limitTo: 1\"\n                        >\n                        <a\n                            ng-href=\"{{ item.short_url }}\"\n                            target=\"_blank\"\n                            class=\"b-mysocial-item-photo-link\"\n                            >\n                            <img\n                                ng-src=\"{{ photo.alt_sizes[0].url }}\"\n                                alt=\"\"\n                                class=\"b-mysocial-item-photo-image\"\n                                >\n                        </a>\n                    </figure>\n                    <p\n                        ng-if=\"item.photos.length >= 2\"\n                        class=\"b-mysocial-item-photo-more\"\n                        >\n                        <a\n                            ng-href=\"{{ item.short_url }}\"\n                            class=\"b-mysocial-item-photo-more-link\"\n                            lj-ml=\"widget.social.tumblr.loadpictures\"\n                            target=\"_blank\"\n                            ></a>\n                    </p>\n                </div>\n\n                <!-- chat -->\n                <div\n                    class=\"b-mysocial-item-chat\"\n                    ng-if=\"item.dialogue.length\"\n                    >\n                    <p\n                        class=\"b-mysocial-item-chat-line\"\n                        ng-repeat=\"line in item.dialogue\"\n                        >\n                        <strong\n                            class=\"b-mysocial-item-chat-author\"\n                            ng-bind=\"line.name\"\n                            ng-if=\"line.name\"\n                            ></strong>\n                        <span\n                            class=\"b-mysocial-item-chat-text\"\n                            ng-bind=\"line.phrase\"\n                            ></span>\n                    </p>\n                </div>\n\n                <!-- content -->\n                <div\n                    class=\"b-mysocial-item-content\"\n                    ng-if=\"!item.question && !item.source && item.type !== \'chat\'\"\n                    lj-html=\"item.text\"\n                    ng-class=\"{\n                        \'b-mysocial-item-clipped\': item.state === \'cut\'\n                    }\"\n                    ></div><!-- /content -->\n\n                <!-- full post link -->\n                <p\n                    ng-if=\"item.state === \'cut\'\"\n                    class=\"b-mysocial-item-fullpost\"\n                    >\n                    <a\n                        ng-href=\"{{ item.short_url }}\"\n                        target=\"_blank\"\n                        class=\"b-mysocial-item-fullpost-link\"\n                        lj-ml=\"widget.social.tumblr.loadpost\"\n                        ></a>\n                </p>\n\n            </li>\n\n        </ul><!-- /items -->\n\n        <!-- loadmore button -->\n        <div\n            class=\"\n                b-mysocial-loadmore\n                js-elem-bordercolor\n                \">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    \"\n                ng-hide=\"status.hideMoreButton\"\n                lj-ml=\"widget.social.tumblr.loadmore\"\n                ng-click=\"showMore()\"\n                ></span>\n        </div>\n\n        <!-- dummy loader -->\n        <ul\n            class=\"\n                b-mysocial-dummy\n                flatwidget__load\n                load-flatwidget\n                \">\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n            <li\n                class=\"\n                    b-mysocial-dummy-item\n                    load-flatwidget__item\n                    js-elem-bgcolor--pseudos\n                    \">\n            </li>\n        </ul><!-- /dummy -->\n\n        <!-- erroneous message -->\n        <p\n            class=\"b-mysocial-erroneous\"\n            lj-ml=\"widget.social.tumblr.error\"\n            ></p>\n\n        <!-- loginess button -->\n        <div class=\"b-mysocial-loginess\">\n            <span\n                class=\"\n                    b-flatbutton\n                    b-flatbutton-simple\n                    b-flatbutton-tumblr\n                    \"\n                ng-click=\"login()\"\n                >\n                <span\n                    class=\"b-flatbutton-icon\"\n                    ></span>\n                <span\n                    class=\"b-flatbutton-title\"\n                    lj-ml=\"widget.social.tumblr.login\"\n                    ></span>\n            </span>\n        </div>\n\n        <!-- emptiness message -->\n        <p\n            class=\"b-mysocial-emptiness\"\n            lj-ml=\"widget.social.tumblr.empty\"\n            ></p>\n\n    </div><!-- /body -->\n\n\n\n    <!-- footer -->\n    <footer\n        class=\"\n            b-mysocial-footer\n            flatwidget__footer\"\n            >\n        <span\n            class=\"\n                b-mysocial-footer-refresh\n                js-link-color\n                \"\n            lj-ml=\"widget.social.tumblr.refresh\"\n            ng-click=\"refresh()\"\n            ></span>\n        <span\n            ng-click=\"logout()\"\n            class=\"\n                b-mysocial-footer-logout\n                js-link-color\"\n                >\n            <span\n                class=\"b-mysocial-footer-logout-text\"\n                lj-ml=\"widget.social.tumblr.logout\"\n                ></span>\n            <span\n                lj-ml=\"widget.social.tumblr.logout\"\n                lj-ml-attr=\"title\"\n                lj-svg-icon=\"flaticon--logout\"\n                class=\"\n                    b-mysocial-footer-logout-icon\n                    js-elem-color--svgicon\n                    \"\n                ></span>\n        </span>\n        <a\n            ng-href=\"https://www.tumblr.com/\"\n            class=\"\n                b-mysocial-footer-all\n                js-link-color\"\n            target=\"_blank\"\n            lj-ml=\"widget.social.tumblr.all\"\n            ></a>\n    </footer><!-- /footer -->\n\n\n\n</div>\n\n\n';

LJ.injectStyle('/* >>> file start: stc/widgets/mysocial.css */\n\n/* my updates widgets (LJSUP-18034) */\n\n\n\n/*.b-mysocial {\n    }*/\n\n\n\n/* head */\n\n\n\n.b-mysocial-head {\n        position: relative;\n        margin: 0 0 13px;\n        margin: 0 0 0.8125rem;\n        padding: 0;\n        }\n\n\n\n/* header */\n\n\n\n.b-mysocial-header {\n            margin: 0;\n            padding: 0;\n            font-style: normal;\n            font-weight: normal;\n            font-size: 20px;\n            font-size: 1.25rem;\n            text-transform: uppercase;\n            color: #829399;\n            }\n\n\n\n/* title */\n\n\n\n.b-mysocial-title {\n                position: relative;\n                margin: 0;\n                padding: 0 23px 0 0;\n                cursor: pointer;\n                }\n\n\n\n.b-mysocial-title:after {\n                content: \" \";\n                position: absolute;\n                top: 50%;\n                right: 0;\n                width: 16px;\n                height: 16px;\n                margin: -9px 0 0;\n                padding: 0;\n                background: url(/img/icons/unit_v3.png?v=13435656) no-repeat 0 -299px;\n                font: 0/0 a;\n                cursor: pointer;\n                }\n\n\n\n.b-mysocial-title:after {\n                visibility: hidden;\n                }\n\n\n\n.b-feedwidgets-item:hover .b-mysocial-title:after {\n                visibility: visible;\n                }\n\n\n\n/* enabled feedsettings */\n\n\n\n.b-feedsettings-on .b-mysocial-title {\n                padding: 0 2px 0 0;\n                }\n\n\n\n.b-feedsettings-on .b-mysocial-title:after {\n                display: none;\n                }\n\n\n\n/* refresh */\n\n\n\n.b-mysocial-refresh {\n                margin-left: 3px;\n                cursor: pointer;\n                visibility: hidden;\n                color: #7A9199;\n                }\n\n\n\n.b-feedwidgets-item:hover .b-mysocial-refresh {\n                visibility: visible;\n                }\n\n\n\n.b-mysocial-refresh .svgicon {\n                    display: inline-block;\n                    width: 16px;\n                    height: 16px;\n                    }\n\n\n\n/* body */\n\n\n\n.b-mysocial-body {\n        margin: 0;\n        padding: 0;\n        font-size: 14px;\n        font-size: 0.875rem;\n        }\n\n\n\n/* items */\n\n\n\n.b-mysocial-items {\n            margin: 0;\n            padding: 0;\n            list-style: none;\n            }\n\n\n\n/* item */\n\n\n\n.b-mysocial-item {\n                position: relative;\n                margin: 0 0 1em;\n                padding: 0 0 1em;\n                border-bottom: 1px solid #DAE3E6;\n                }\n\n\n\n/* retweet */\n\n\n\n.b-mysocial-item-retweet {\n                    position: relative;\n                    margin: 0 0 0.5em;\n                    padding: 0;\n                    font-size: 13px;\n                    font-size: 0.8125rem;\n                    }\n\n\n\n/* meta */\n\n\n\n.b-mysocial-item-meta {\n                    margin: 0 0 0.3em;\n                    }\n\n\n\n.b-mysocial-item-meta:after {\n                    content: \"\";\n                    display: table;\n                    border-collapse: collapse;\n                    clear: both;\n                    }\n\n\n\n/* user */\n\n\n\n.b-mysocial-item-user {\n                        position: relative;\n                        float: left;\n                        max-width: 200px;\n                        margin: 0;\n                        padding: 1px 0 0 27px;\n                        }\n\n\n\n.b-mysocial-item-user:link,\n                    .b-mysocial-item-user:visited {\n                        color: #00A3D9;\n                        }\n\n\n\n.b-mysocial-item-user:hover,\n                    .b-mysocial-item-user:active {\n                        color: #0086B3;\n                        }\n\n\n\n/* userpic */\n\n\n\n.b-mysocial-item-userpic {\n                            position: absolute;\n                            top: 0;\n                            left: 0;\n                            display: block;\n                            width: 20px;\n                            height: 20px;\n                            margin: 0;\n                            padding: 0;\n                            border-radius: 3px;\n                            background-color: transparent;\n                            background-repeat: no-repeat;\n                            background-position: 50% 50%;\n                            background-size: contain;\n                            font: 0/0 a;\n                            }\n\n\n\n/* username */\n\n\n\n.b-mysocial-item-username {\n                            margin: 0;\n                            font-weight: normal;\n                            }\n\n\n\n/* link */\n\n\n\n.b-mysocial-item-link {\n                        float: right;\n                        margin: 0 0 0 5px;\n                        padding: 0;\n                        text-align: right;\n                        line-height: 21px;\n                        }\n\n\n\n/* date */\n\n\n\n.b-mysocial-item-date {\n                            margin: 0;\n                            }\n\n\n\n/* actions: repost, fav, etc. */\n\n\n\n.b-mysocial-item-actions {\n                        margin: 0;\n                        padding: 0;\n                        }\n\n\n\n.b-mysocial-item-action {\n                            position: relative;\n                            float: right;\n                            margin: 0;\n                            padding: 0;\n                            list-style-type: none;\n                            }\n\n\n\n.b-mysocial-item-action .svgicon {\n                                width: 16px;\n                                height: 16px;\n                                margin: 1px 0 0 5px;\n                                }\n\n\n\n/* content */\n\n\n\n.b-mysocial-item-content {\n                    margin: 0 0 0.3em;\n                    word-break: break-word;\n                    word-wrap: break-word;\n                    }\n\n\n\n.b-mysocial-item-content A {\n                        word-break: break-all;\n                        word-break: break-word;\n                        -webkit-hyphens: auto;\n                        -ms-hyphens: auto;\n                            hyphens: auto;\n                        word-wrap: break-word;\n                        }\n\n\n\n.b-mysocial-item-content IMG {\n                        max-width: 100%;\n                        }\n\n\n\n.b-mysocial-item-content P {\n                        margin: 0 0 0.3em;\n                        }\n\n\n\n.b-mysocial-item-content BLOCKQUOTE {\n                        margin: 0 0 0 0.7em;\n                        padding: 0 0 0 0.7em;\n                        border-left: 3px solid #DAE3E6;\n                        }\n\n\n\n/* cut and full content */\n\n\n\n.b-mysocial-item-clipped {\n                    position: relative;\n                    overflow: hidden;\n                    max-height: 25em;\n                    border-bottom: 1px solid #DAE3E6;\n                    }\n\n\n\n.b-mysocial-item-clipped:before {\n                    content: \" \";\n                    position: absolute;\n                    bottom: -20px;\n                    left: 10px;\n                    right: 10px;\n                    height: 20px;\n                    box-shadow: 0 0 15px rgba(0,0,0,0.2);\n                    border-radius: 100px / 10px;\n                    }\n\n\n\n/* full post link */\n\n\n\n.b-mysocial-item-fullpost {\n                    display: block;\n                    margin: 0;\n                    text-align: center;\n                    }\n\n\n\n.b-mysocial-item-fullpost-link {\n                        margin: 0;\n                        }\n\n\n\n/* picture */\n\n\n\n.b-mysocial-item-picture {\n                    margin: 0 0 0.3em;\n                    }\n\n\n\n.b-mysocial-item-picture-link {\n                        margin: 0;\n                        }\n\n\n\n.b-mysocial-item-picture-image {\n                            max-width: 100%;\n                            max-height: 1000px;\n                            margin: 0 0 0 -4px;\n                            padding: 3px;\n                            border: 1px solid #DAE3E6;\n                            vertical-align: top;\n                            }\n\n\n\n.b-mysocial-item-picture-link:visited {\n                        }\n\n\n\n.b-mysocial-item-picture-link:visited .b-mysocial-item-picture-image {\n                            opacity: 0.7;\n                            }\n\n\n\n/* external */\n\n\n\n.b-mysocial-item-external {\n                    margin: 0 0 0.3em;\n                    }\n\n\n\n.b-mysocial-item-external-link {\n                        display: block;\n                        margin: 0 0 0 -6px;\n                        padding: 5px;\n                        border: 1px solid #DAE3E6;\n                        }\n\n\n\n.b-mysocial-item-external-title {\n                            margin: 0 0 0.3em;\n                            font-size: 1em;\n                            font-weight: normal;\n                            line-height: 1.2;\n                            }\n\n\n\n.b-mysocial-item-external-wrapper {\n                            overflow: hidden;\n                            position: relative;\n                            max-height: 14em;\n                            margin: 0;\n                            padding: 0;\n                            }\n\n\n\n.b-mysocial-item-external-wrapper:before {\n                            content: \"\";\n                            position: absolute;\n                            top: 13em;\n                            left: 0;\n                            right: 0;\n                            height: 1em;\n                            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%,rgba(255,255,255,1) 70%);\n                            }\n\n\n\n.b-mysocial-item-external-wrapper:after {\n                            content: \"\";\n                            display: table;\n                            border-collapse: collapse;\n                            clear: both;\n                            }\n\n\n\n.b-mysocial-item-external-image {\n                                float: left;\n                                width: 70px;\n                                margin: 3px 10px 3px 0;\n                                padding: 0;\n                                }\n\n\n\n.b-mysocial-item-external-text {\n                                margin: 0;\n                                color: #000;\n                                }\n\n\n\n.b-mysocial-item-external-link:visited {\n                        }\n\n\n\n.b-mysocial-item-external-link:visited .b-mysocial-item-external-image {\n                            opacity: 0.7;\n                            }\n\n\n\n.b-mysocial-item-external-link:visited .b-mysocial-item-external-text {\n                            opacity: 0.7;\n                            }\n\n\n\n/* title */\n\n\n\n.b-mysocial-item-title {\n                    margin: 0;\n                    font-size: 1.1428em;\n                    font-weight: bold;\n                    }\n\n\n\n/* quote */\n\n\n\n.b-mysocial-item-quote {\n                    margin: 0 0 0.3em;\n                    }\n\n\n\n/* text */\n\n\n\n.b-mysocial-item-quote-text {\n                        margin: 0 0 0.5em;\n                        font-size: 1.1428em;\n                        }\n\n\n\n.b-mysocial-item-quote-text:before {\n                        content: \"\\201C\";\n                        position: absolute;\n                        right: 100%;\n                        font-size: 2em;\n                        }\n\n\n\n.b-mysocial-item-quote-text:after {\n                        content: \"\\201D\";\n                        position: absolute;\n                        margin: 0 0 0 0.1em;\n                        font-size: 2em;\n                        }\n\n\n\n.b-mysocial-item-quote-text P {\n                            margin: 0;\n                            }\n\n\n\n.b-mysocial-item-quote-text IMG {\n                            max-width: 100%;\n                            }\n\n\n\n/* source */\n\n\n\n.b-mysocial-item-quote-source {\n                        margin: 0 0 0.3em 1.1em;\n                        text-indent: -1.1em;\n                        font-size: 0.92em;\n                        }\n\n\n\n.b-mysocial-item-quote-source:before {\n                        content: \"\\2014\"; /* em dash */\n                        }\n\n\n\n.b-mysocial-item-quote-source CITE {\n                            font-style: normal;\n                            }\n\n\n\n/* clipped quote */\n\n\n\n.b-mysocial-item-quote.b-mysocial-item-clipped {\n                    margin-left: -0.92em;\n                    margin-right: -0.92em;\n                    padding-left: 0.92em;\n                    padding-right: 0.92em;\n                    }\n\n\n\n.b-mysocial-item-clipped .b-mysocial-item-quote-text:before {\n                        right: auto;\n                        left: 0;\n                        }\n\n\n\n/* reply */\n\n\n\n.b-mysocial-item-reply {\n                    margin: 0;\n                    }\n\n\n\n/* question */\n\n\n\n.b-mysocial-item-reply-question {\n                        margin: 0 0 0.5em -6px;\n                        padding: 5px;\n                        border: 1px solid #DAE3E6;\n                        background: #F7F9FA;\n                        }\n\n\n\n.b-mysocial-item-reply-question P {\n                            margin: 0;\n                            }\n\n\n\n/* source */\n\n\n\n.b-mysocial-item-reply-question-source {\n                        margin: 0 0 0.3em 1.1em;\n                        text-indent: -1.1em;\n                        font-size: 0.92em;\n                        }\n\n\n\n.b-mysocial-item-reply-question-source:before {\n                        content: \"\\2014\"; /* em dash */\n                        }\n\n\n\n.b-mysocial-item-reply-question-source CITE {\n                            font-style: normal;\n                            }\n\n\n\n/* answer */\n\n\n\n.b-mysocial-item-reply-answer {\n                        margin: 0;\n                        }\n\n\n\n.b-mysocial-item-reply-answer P {\n                            margin: 0 0 0.3em;\n                            }\n\n\n\n/* embed */\n\n\n\n.b-mysocial-item-embed {\n                    margin: 0;\n                    }\n\n\n\n.b-mysocial-item-embed-item {\n                        margin: 0 0 0.3em;\n                        }\n\n\n\n.b-mysocial-item-embed IFRAME,\n                        .b-mysocial-item-embed OBJECT,\n                        .b-mysocial-item-embed EMBED {\n                            max-width: 100%;\n                            margin: 0;\n                            }\n\n\n\n/* photo */\n\n\n\n.b-mysocial-item-photo {\n                    margin: 0;\n                    }\n\n\n\n.b-mysocial-item-photo-item {\n                        margin: 0 0 0.3em;\n                        }\n\n\n\n.b-mysocial-item-photo-link {\n                            margin: 0;\n                            }\n\n\n\n.b-mysocial-item-photo-image {\n                                max-width: 100%;\n                                max-height: 1000px;\n                                margin: 0 0 0 -4px;\n                                padding: 3px;\n                                border: 1px solid #DAE3E6;\n                                vertical-align: top;\n                                }\n\n\n\n.b-mysocial-item-photo-more {\n                        margin: 0;\n                        text-align: center;\n                        }\n\n\n\n.b-mysocial-item-photo-more-link {\n                            margin: 0;\n                            }\n\n\n\n/* chat */\n\n\n\n.b-mysocial-item-chat {\n                    margin: 0;\n                    }\n\n\n\n.b-mysocial-item-chat-line {\n                        margin: 0 0 0.3em;\n                        }\n\n\n\n.b-mysocial-item-chat-author {\n                            margin: 0;\n                            font-weight: bold;\n                            }\n\n\n\n.b-mysocial-item-chat-author:after {\n                            content: \":\";\n                            }\n\n\n\n.b-mysocial-item-chat-text {\n                            margin: 0;\n                            }\n\n\n\n/* load more button */\n\n\n\n.b-mysocial-loadmore {\n            margin: 0 0 1em;\n            padding: 0 0 1em;\n            border-bottom: 1px solid #DAE3E6;\n            text-align: center;\n            }\n\n\n\n/* erroneous */\n\n\n\n.b-mysocial-erroneous {\n            display: none;\n            margin: 0 0 1em;\n            padding: 0;\n            font-size: 1.2307em;\n            color: #D92B2B;\n            }\n\n\n\n/* loginess */\n\n\n\n.b-mysocial-loginess {\n            display: none;\n            margin: 0;\n            text-align: center;\n            }\n\n\n\n/* emptiness */\n\n\n\n.b-mysocial-emptiness {\n            display: none;\n            margin: 0;\n            padding: 0 0 1em;\n            font-size: 1.2307em;\n            color: #829399;\n            }\n\n\n\n/* footer */\n\n\n\n.b-mysocial-footer {\n        margin: 0;\n        padding: 0;\n        font-size: 14px;\n        font-size: 0.875rem;\n        text-align: right;\n        }\n\n\n\n.b-mysocial-footer:after {\n        content: \"\";\n        display: table;\n        border-collapse: collapse;\n        clear: both;\n        }\n\n\n\n.b-mysocial-footer-refresh {\n            float: left;\n            margin: 0;\n            cursor: pointer;\n            }\n\n\n\n.b-mysocial-footer-refresh:hover {\n            }\n\n\n\n.b-mysocial-footer-logout {\n            position: relative;\n            float: right;\n            margin: 0;\n            padding: 0 20px 0 0;\n            cursor: pointer;\n            }\n\n\n\n.b-mysocial-footer-logout:hover {\n            }\n\n\n\n.b-mysocial-footer-logout:after {\n            content: \" \";\n            position: absolute;\n            top: 0;\n            right: 0;\n            width: 16px;\n            height: 16px;\n            margin: 0;\n            padding: 0;\n            background: url(/img/icons/unit_v3.png?v=14345656) no-repeat 0 -384px;\n            font: 0/0 a;\n            cursor: pointer;\n            }\n\n\n\n/* enabled feedsettings */\n\n\n\n.b-feedsettings-on .b-mysocial-footer-logout:after {\n            display: none;\n            }\n\n\n\n.b-mysocial-footer-logout-icon {\n            position: absolute;\n            top: 0;\n            right: 0;\n            cursor: pointer;\n            color: #7A9199;\n            }\n\n\n\n.b-mysocial-footer-logout-icon .svgicon {\n                display: inline-block;\n                width: 16px;\n                height: 16px;\n                }\n\n\n\n.b-mysocial-footer-all {\n            display: inline-block;\n            float: right;\n            clear: both;\n            margin: 0.5em 0 0;\n            display: none; /* temp */\n            }\n\n\n\n/* loading */\n\n\n\n.b-mysocial-loading {\n    }\n\n\n\n/* show */\n\n\n\n.b-mysocial-loading .b-mysocial-dummy {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.b-mysocial-loading .b-mysocial-items {\n        display: none;\n        }\n\n\n\n.b-mysocial-loading .b-mysocial-loadmore {\n        display: none;\n        }\n\n\n\n.b-mysocial-loading .b-mysocial-erroneous {\n        display: none;\n        }\n\n\n\n.b-mysocial-loading .b-mysocial-loginess {\n        display: none;\n        }\n\n\n\n.b-mysocial-loading .b-mysocial-emptiness {\n        display: none;\n        }\n\n\n\n.b-mysocial-loading .b-mysocial-footer {\n        display: none;\n        }\n\n\n\n/* disable refresh */\n\n\n\n.b-mysocial-loading .b-mysocial-title {\n        padding-right: 0;\n        cursor: default;\n        }\n\n\n\n.b-mysocial-loading .b-mysocial-title:after {\n        display: none;\n        }\n\n\n\n.b-mysocial-loading .b-mysocial-refresh {\n        display: none;\n        }\n\n\n\n/* refreshing */\n\n\n\n.b-mysocial-refreshing {\n    }\n\n\n\n/* show */\n\n\n\n.b-mysocial-refreshing .b-mysocial-items {\n        display: block;\n        pointer-events: none;\n        opacity: 0.3;\n        }\n\n\n\n.b-mysocial-refreshing .b-mysocial-loadmore {\n        display: block;\n        pointer-events: none;\n        opacity: 0.3;\n        }\n\n\n\n.b-mysocial-refreshing.b-mysocial-error .b-mysocial-erroneous {\n        display: block;\n        opacity: 0.3;\n        }\n\n\n\n.b-mysocial-refreshing .b-mysocial-refresh {\n        opacity: 0.3;\n        }\n\n\n\n/* hide */\n\n\n\n.b-mysocial-refreshing .b-mysocial-dummy {\n        display: none;\n        }\n\n\n\n.b-mysocial-refreshing .b-mysocial-erroneous {\n        display: none;\n        }\n\n\n\n.b-mysocial-refreshing .b-mysocial-loginess {\n        display: none;\n        }\n\n\n\n.b-mysocial-refreshing .b-mysocial-emptiness {\n        display: none;\n        }\n\n\n\n.b-mysocial-refrashing .my-social-showmore {\n        display: none;\n        }\n\n\n\n/* empty */\n\n\n\n.b-mysocial-error {\n    }\n\n\n\n/* show */\n\n\n\n.b-mysocial-error .b-mysocial-erroneous {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.b-mysocial-error .b-mysocial-items {\n        display: none;\n        }\n\n\n\n.b-mysocial-error .b-mysocial-loadmore {\n        display: none;\n        }\n\n\n\n.b-mysocial-error .b-mysocial-dummy {\n        display: none;\n        }\n\n\n\n.b-mysocial-error .b-mysocial-loginess {\n        display: none;\n        }\n\n\n\n.b-mysocial-error .b-mysocial-emptiness {\n        display: none;\n        }\n\n\n\n/* login */\n\n\n\n.b-mysocial-login {\n    }\n\n\n\n/* show */\n\n\n\n.b-mysocial-login .b-mysocial-loginess {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.b-mysocial-login .b-mysocial-items {\n        display: none;\n        }\n\n\n\n.b-mysocial-login .b-mysocial-loadmore {\n        display: none;\n        }\n\n\n\n.b-mysocial-login .b-mysocial-dummy {\n        display: none;\n        }\n\n\n\n.b-mysocial-login .b-mysocial-erroneous {\n        display: none;\n        }\n\n\n\n.b-mysocial-login .b-mysocial-emptiness {\n        display: none;\n        }\n\n\n\n.b-mysocial-login .b-mysocial-footer {\n        display: none;\n        }\n\n\n\n/* disable refresh */\n\n\n\n.b-mysocial-login .b-mysocial-title {\n        padding-right: 0;\n        cursor: default;\n        }\n\n\n\n.b-mysocial-login .b-mysocial-title:after {\n        display: none;\n        }\n\n\n\n.b-mysocial-login .b-mysocial-refresh {\n        display: none;\n        }\n\n\n\n/* empty */\n\n\n\n.b-mysocial-empty {\n    }\n\n\n\n/* show */\n\n\n\n.b-mysocial-empty .b-mysocial-emptiness {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.b-mysocial-empty .b-mysocial-items {\n        display: none;\n        }\n\n\n\n.b-mysocial-empty .b-mysocial-loadmore {\n        display: none;\n        }\n\n\n\n.b-mysocial-empty .b-mysocial-dummy {\n        display: none;\n        }\n\n\n\n.b-mysocial-empty .b-mysocial-erroneous {\n        display: none;\n        }\n\n\n\n.b-mysocial-empty .b-mysocial-loginess {\n        display: none;\n        }\n\n\n\n/* disable refresh */\n\n\n\n.b-mysocial-empty .b-mysocial-title {\n        cursor: default;\n        }\n\n\n\n/* show more */\n\n\n\n.b-mysocial-showmore {\n    }\n\n\n\n/* hide */\n\n\n\n.b-mysocial-showmore .b-mysocial-loadmore {\n        display: none;\n        }\n\n\n\n.b-mysocial-showmore .b-mysocial-dummy {\n        display: none;\n        }\n\n\n\n.b-mysocial-showmore .b-mysocial-erroneous {\n        display: none;\n        }\n\n\n\n.b-mysocial-showmore .b-mysocial-loginess {\n        display: none;\n        }\n\n\n\n.b-mysocial-showmore .b-mysocial-emptiness {\n        display: none;\n        }\n\n/* <<< file end: stc/widgets/mysocial.css */\n\n/*# sourceMappingURL=mysocial.css.map */\n');

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Widget.Social', ['LJ.Templates', 'LJ.Api', 'LJ.Directives', 'LJ.AuthHelper']).factory('Twitter', function () {
    var factory = {};

    factory.requestParams = {
      service: 'twitter',
      api_method: 'statuses/home_timeline'
    };

    factory.requestOptions = {
      silent: true
    };

    factory.modifyParams = {
      replaceLinks: true,
      replaceHashTags: 'https://twitter.com/hashtag/{hashtag}?src=hash',
      replaceUsers: 'https://twitter.com/{username}'
    };

    factory.beforeModify = function (tweet) {

      if (!tweet) {
        return false;
      }

      tweet.permalink = 'https://twitter.com/' + tweet.user.screen_name + '/status/' + tweet.id_str;

      // Remove 'RT @user: ' from the beginning
      if (tweet.retweeted_status) {
        tweet.text = tweet.text.replace(/^(RT\s@\w+:\s{0,1})/i, '');
      }

      return tweet;
    };

    // Normalize twitter 'created_at' time.
    factory.getDate = function (tweet) {
      return Date.parse(tweet.created_at) || Date.parse(tweet.created_at.replace(/(\s\+)/, ' UTC$1'));
    };

    return factory;
  }).factory('Facebook', function () {
    var factory = {};

    factory.requestParams = {
      service: 'facebook',
      api_method: 'me/home'
    };

    factory.requestOptions = {
      silent: true
    };

    factory.modifyParams = {
      replaceLinks: true,
      replaceHashTags: 'https://www.facebook.com/hashtag/{hashtag}'
    };

    factory.beforeModify = function (item) {

      if (item.picture) {
        // remove 's130x130' string
        var sizePattern = /\/\w?\d{2,5}x\d{2,5}/,

        // NOT show images with session URL params
        sessionPattern = /\?(oh=|oe=|__gda__=)\w+/;

        if (sessionPattern.test(item.picture)) {
          delete item.picture;
        } else {
          item.picture = item.picture.replace(sizePattern, '');
        }
      }

      // prevent XSS
      item.text = LJ.String.encodeHTML(factory.textMethod(item));

      // permalink to post. Construct it if no link received
      if (item.actions.length && item.link) {
        item.permalink = item.link.indexOf('facebook') !== -1 ? item.link : item.actions[0].link;
      } else {
        item.permalink = 'https://www.facebook.com/permalink.php?id=' + item.from.id + '&story_fbid=' + item.id.split('_')[1];
      }

      // next line tags add.
      item.text = item.text.replace(/\n/g, '\n<br/>');

      return item;
    };

    factory.textMethod = function (item) {
      return item.message || item.caption || item.story;
    };

    // Normalize facebook 'update_time' time. +0000 timezone to +00:00
    factory.getDate = function (item) {
      return item.updated_time.replace(/(\+(\d){2})/, '$1:');
    };

    factory.itemsRoot = 'data';

    return factory;
  }).factory('Instagram', function () {
    var factory = {};

    factory.beforeModify = function (item) {
      item.created_at = item.created_time * 1000;
      item.permalink = item.link;

      return item;
    };

    factory.requestParams = {
      service: 'instagram',
      api_method: 'users/self/feed'
    };

    factory.requestOptions = {
      silent: true
    };

    factory.itemsRoot = 'data';

    factory.textMethod = function (item) {
      return item.caption ? item.caption.text : '';
    };

    factory.modifyParams = {
      replaceLinks: true,
      replaceUsers: 'https://instagram.com/{username}'
    };

    factory.getDate = function (item) {
      return item.created_time * 1000;
    };

    return factory;
  }).factory('Tumblr', function () {
    var factory = {};

    factory.beforeModify = function (item) {

      if (item.player && !angular.isArray(item.player)) {
        item.player = [item.player];
      }

      return item;
    };

    factory.requestParams = {
      service: 'tumblr',
      api_method: 'user/dashboard'
    };

    factory.requestOptions = {
      silent: true
    };

    factory.modifyParams = {
      replaceHashTags: 'https://www.tumblr.com/tagged/{hashtag}',
      replaceUsers: 'https://{username}.tumblr.com/'
    };

    factory.getDate = function (item) {
      return item.date.replace(/\s(\d{2}:\d{2}:\d{2})\sGMT$/g, 'T$1+00:00');
    };

    factory.textMethod = function (item) {
      return item.caption || item.description || item.body;
    };

    factory.itemsRoot = 'response.posts';

    return factory;
  }).factory('Social', function () {

    var factory = {};

    // replace set patterns to links
    factory.modify = function (text, options) {

      if (options.replaceLinks) {
        text = replaceLinks(text);
      }

      if (options.replaceHashTags) {
        text = replaceHashTags(text, options.replaceHashTags);
      }

      if (options.replaceUsers) {
        text = replaceUsers(text, options.replaceUsers);
      }

      return text;
    };

    return factory;
  }).controller('TwitterCtrl', ['$scope', '$timeout', '$location', '$anchorScroll', 'Api', 'Social', 'AuthHelper', 'Twitter', socialCtrl]).controller('FacebookCtrl', ['$scope', '$timeout', '$location', '$anchorScroll', 'Api', 'Social', 'AuthHelper', 'Facebook', socialCtrl]).controller('InstagramCtrl', ['$scope', '$timeout', '$location', '$anchorScroll', 'Api', 'Social', 'AuthHelper', 'Instagram', socialCtrl]).controller('TumblrCtrl', ['$scope', '$timeout', '$location', '$anchorScroll', 'Api', 'Social', 'AuthHelper', 'Tumblr', socialCtrl]).directive('ljWidgetTwitter', function () {
    return {
      controller: 'TwitterCtrl',
      controllerAs: 'widget',
      templateUrl: 'twitter.ng.tmpl',
      scope: true
    };
  }).directive('ljWidgetFacebook', function () {
    return {
      controller: 'FacebookCtrl',
      controllerAs: 'widget',
      templateUrl: 'facebook.ng.tmpl',
      scope: true
    };
  }).directive('ljWidgetInstagram', function () {
    return {
      controller: 'InstagramCtrl',
      controllerAs: 'widget',
      templateUrl: 'instagram.ng.tmpl',
      scope: true
    };
  }).directive('ljWidgetTumblr', function () {
    return {
      controller: 'TumblrCtrl',
      controllerAs: 'widget',
      templateUrl: 'tumblr.ng.tmpl',
      scope: true
    };
  });

  function socialCtrl($scope, $timeout, $location, $anchorScroll, Api, Social, AuthHelper, Service) {
    var itemsLimit = Service.itemsLimit || 10,
        textLimit = 400; // item cut

    $scope.status = {
      isLoading: true,
      isError: false,
      isLogin: false,
      isRefreshing: false,
      isEmpty: false,
      itemsLimit: 5,
      noMore: false
    };

    $scope.siteroot = LJ.get('siteroot');

    $scope.getItems = function () {

      // MAKE API REQUEST OUT OF BATCH QUEUE!
      // Can be slower then 10 seconds!
      $timeout(function () {
        // Get tweets from server proxy. Caches on server for 60s.
        Api.call('oauth_proxy.make_request', Service.requestParams, Service.requestOptions).then(successCallback, errorCallback).then(function (items) {

          if (!items) {
            return;
          }

          if (!items.length) {
            $scope.status.isEmpty = true;
            return;
          }

          // slice latest 10 items.
          $scope.items = items.length > itemsLimit ? items.slice(0, itemsLimit) : items;
          $scope.status.noMore = $scope.status.itemsLimit >= itemsLimit || $scope.status.itemsLimit >= items.length;
          angular.forEach($scope.items, $scope.toHtml);
        });
      }, 200);
    };

    $scope.refresh = function () {
      $scope.status.isRefreshing = true;

      $scope.getItems();
    };

    $scope.backUrl = LJ.get('siteroot') + '/oauth_proxy/authorize?service=' + Service.requestParams.service + '&callback=' + LJ.get('siteroot') + '/auth_helper.html';

    $scope.login = function () {
      $scope.status.isRefreshing = true;

      AuthHelper.open($scope.backUrl).then(function () {
        $scope.refresh();
      });
    };

    // Replaces hash tags, links.
    $scope.toHtml = function (item, index) {
      var text, date, minutes;

      if (Service.beforeModify) {
        item = Service.beforeModify(item);
      }

      // standard property is .text, some Services use own property
      text = item.text || Service.textMethod(item);
      date = new Date(Service.getDate(item));
      minutes = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();

      if (text && text.length) {
        item.text = Social.modify(text, Service.modifyParams);

        // sometimes we have HTML instead of text (Tumblr)
        var $node = jQuery(jQuery.parseHTML(item.text));

        if ($node.text().length > textLimit || $node.find('img').length > 1) {
          item.state = 'cut';
        }
      }

      item.time = [date.getHours(), minutes].join(':');

      $scope.repost(item, index);
      $scope.items[index] = item;
    };

    $scope.showMore = function () {
      $scope.status.itemsLimit = itemsLimit;
      $scope.status.noMore = true;
    };

    $scope.logout = function () {
      var token = LJ.get('friendsfeed_widgets.' + Service.requestParams.service + '.disconnect_token'),
          img = new Image();

      // send GET to logout by adding image.

      img.src = LJ.get('siteroot') + '/manage/settings/' + Service.requestParams.service + '.bml?act=disconnect&auth_token=' + token;

      $scope.status.noMore = false;
      $scope.status.isEmpty = false;
      $scope.status.isLogin = true;

      // scroll to the widget top.
      $location.hash(Service.requestParams.service);
      $anchorScroll();
    };

    // construct url for repost item to LJ
    $scope.repost = function (item, index) {
      if (item.permalink) {
        var embed = LJ.Media.parse(item.permalink);

        if (!embed) {
          return;
        }
        embed.then(function (data) {
          $timeout(function () {
            $scope.items[index].ljRepost = $scope.siteroot + '/update.bml?event=' + encodeURIComponent(data.embed);
          });
        });
      }
    };

    function successCallback(data) {
      var dataObj;

      $scope.status.isError = false;
      $scope.status.isEmpty = false;
      $scope.status.isLogin = false;
      $scope.status.isLoading = false;
      $scope.status.isRefreshing = false;

      // server proxies response as JSON.stringify
      // if service API dies - return string and JSON.parse crashes
      try {
        dataObj = JSON.parse(data.response);
      } catch (e) {
        $scope.status.isError = true;
        return e;
      }

      if (!dataObj || dataObj.error || dataObj.errors) {
        errorCallback(dataObj ? dataObj.error || dataObj.errors[0] : null);
        return;
      }

      return Service.itemsRoot ? LJ.Object.resolve(dataObj, Service.itemsRoot) : dataObj;
    }

    function errorCallback(error) {
      var NO_ACCESS_TOKEN = -12604,
          AUTH_FAILED = -12602;

      $scope.status.isLoading = false;
      $scope.status.isRefreshing = false;

      if (error && (error.code === NO_ACCESS_TOKEN || error.code === AUTH_FAILED || error.type === 'OAuthException')) {

        $scope.status.isLogin = true;
        return false;
      }

      $scope.status.isError = true;
      return false;
    }

    // get feed on init.
    $scope.getItems();
  }

  // plain text URL to link
  function replaceLinks(text) {
    return text.replace(/((https?\:\/\/)|(www\.|(\S+|)(lj|livejournal)))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/gi, function (url) {
      var href = url;
      if (!href.match('^https?:\/\/')) {
        href = 'https://' + href;
      }
      return '<a href="' + href + '" target="_blank">' + url + '</a>';
    });
  }

  // #hashtag link
  function replaceHashTags(text, hashTagUrl) {
    var template = ' <a href="' + hashTagUrl + '" target="_blank">#{hashtag}</a>';

    // ^\s excludes special symbols (e.g. &#8093)
    return text.replace(/\s#([\S]+)/gi, function (match, hashTag) {
      return template.supplant({ hashtag: hashTag });
    });
  }

  // @username to user link
  function replaceUsers(text, profileUrl) {
    var template = '<a href="' + profileUrl + '" target="_blank">@{username}</a>';
    return text.replace(/@(\w+)/gi, function (match, username) {
      return template.supplant({ username: username });
    });
  }
})();
/* <<< file end: js/widgets/angular/social.js */

//# map link was there [social.js.map]
/* >>> file start: js/widgets/angular/fbPage.js */
Site.page.template['angular/widgets/fbPage.ng.tmpl'] = '<!-- fbPage widget -->\n<div\n    class=\"l-flatslide-aside-block\"\n    ng-if=\"widget.initialized\"\n    >\n\n    <!-- head -->\n    <header\n        id=\"fb-page\"\n        class=\"b-mysocial-head flatwidget__head\"\n    >\n        <h3 class=\"b-mysocial-header b-topten-title\">\n            <span class=\"b-mysocial-title js-elem-color\" lj-ml=\"widget.social.facebookpage.title\"></span>\n        </h3>\n    </header>\n    <!-- /head -->\n\n    <iframe\n        ng-src=\"{{widget.iframeSrc}}\"\n        style=\"border:none;\"\n        ng-style={{widget.ngIframeStyles}}\n        scrolling=\"no\"\n        frameborder=\"0\"\n        allowTransparency=\"true\"\n        ></iframe>\n</div>\n';
//= require_ml widget.social.facebookpage.title

ljWidgetFbPageCtrl.$inject = ['$scope', '$sce'];
angular.module('LJ.Widget.FbPage', ['LJ.Templates', 'LJ.Directives']);

angular.module('LJ.Widget.FbPage').controller('ljWidgetFbPageCtrl', ljWidgetFbPageCtrl).directive('ljWidgetFbPage', ljWidgetFbPageDirective);

function ljWidgetFbPageCtrl($scope, $sce) {
  var vm = this;
  // Showing widget to Cyrillics only
  if (!LJ.get('remote_is_sup')) {
    return;
  }
  vm.width = +$scope.iframeWidth || 300;
  vm.height = +$scope.iframeHeight || 230;
  vm.ngIframeStyles = {
    width: vm.width,
    height: vm.height
  };
  vm.iframeSrc = $sce.trustAsResourceUrl('https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2Flivejournal.ru&tabs' + '&width=' + vm.width + '&height=' + vm.height + '&small_header=false&adapt_container_width=true&hide_cover=true&show_facepile=true&appId&hide_cta=true');
  vm.initialized = true;
}

function ljWidgetFbPageDirective() {
  return {
    controller: 'ljWidgetFbPageCtrl',
    controllerAs: 'widget',
    templateUrl: 'fbPage.ng.tmpl',
    scope: {
      iframeWidth: '@ljWidgetFbPageIframeWidth',
      iframeHeight: '@ljWidgetFbPageIframeHeight'
    }
  };
}
/* <<< file end: js/widgets/angular/fbPage.js */

//# map link was there [fbPage.js.map]
/* >>> file start: js/core/angular/checked.js */
angular.module('LJ.Checked', [])

/**
 * Allows to work with checked groups.
 * When model with some id is set to true, all others will be set to false.
 *
 * @return {Object}   factory
 * @return {Function} factory.get  RadioGroup getter
 *
 * @example
 *
 *    // get CheckedGroup instance
 *    var checked = checkedGroup('editable');
 *
 *    // transfer models to scope
 *    $scope.models = checked.models();
 *
 *    // check if all models checked
 *    if ( checked.isAllChecked(ids) ) { ... }
 *
 *    // check if none checked
 *    if ( checked.isNoneChecked() ) { ... }
 *
 *    // check if none of ids is checked
 *    if ( checked.isNoneChecked(ids) ) { ... }
 *
 *    // check some models
 *    checked.toggle(ids, true);
 *
 *    // uncheck some models
 *    checked.toggle(ids, false);
 *
 *    // get checked model ids
 *    checked.getChecked();
 *
 *    // get amount of checked models
 *    checked.count();
 *
 */
.factory('checkedGroup', [function () {
  // instances cache
  var cache = {};

  function CheckedGroup() {
    this._models = {};
  }

  /**
   * Reset models states
   * @return {Object} Models
   */
  CheckedGroup.prototype.reset = function (_models) {
    var models = this.models(),
        id;

    // reset models
    for (id in models) {
      if (models.hasOwnProperty(id)) {
        delete models[id];
      }
    }

    if (angular.isObject(_models)) {
      angular.extend(models, _models);
    }

    return this;
  };

  /**
   * Total models count
   * @return {Number} Count
   */
  CheckedGroup.prototype.length = function () {
    return Object.keys(this.models()).length;
  };

  /**
   * CheckedGroup models count
   * @return {Number} Amount of checked models
   */
  CheckedGroup.prototype.count = function () {
    var models = this.models(),
        result = 0,
        id;

    for (id in models) {
      if (models.hasOwnProperty(id) && models[id]) {
        result += 1;
      }
    }

    return result;
  };

  /**
   * Get models
   * @return {Object} Models
   */
  CheckedGroup.prototype.models = function () {
    return this._models;
  };

  /**
   * Check helper
   * @param  {Array|Number|String} ids     Invite(s) id(s) to change state
   * @param  {Boolean}             [state] State: check or uncheck, if not provided,
   *                                       toggles previous model state
   */
  CheckedGroup.prototype.toggle = function (ids, state) {
    var models = this.models(),
        isStateDefined = typeof state !== 'undefined';

    if (!Array.isArray(ids)) {
      ids = [ids];
    }

    ids.forEach(function (id) {
      models[id] = isStateDefined ? state : !Boolean(models[id]);
    });
  };

  /**
   * Checkes if a model with provided id is checked
   * @param  {Number|String}  id  Model id
   * @return {Boolean}            Check result
   */
  CheckedGroup.prototype.isChecked = function (id) {
    return Boolean(this.models()[id]);
  };

  /**
   * Checks if all ids are checked
   * @param {Array|Number|String}  ids  Ids of models to check
   * @return {Boolean} Result
   */
  CheckedGroup.prototype.isAllChecked = function (ids) {
    var models = this.models();

    if (typeof ids === 'undefined') {
      return this.count() === this.length();
    }

    if (!Array.isArray(ids)) {
      ids = [ids];
    }

    return ids.every(function (id) {
      return models[id];
    });
  };

  /**
   * Checks if none of provided ids checked
   * @param  {Array|Number|String} [ids] Ids to check
   * @return {Boolean}      Result
   */
  CheckedGroup.prototype.isNoneChecked = function (ids) {
    var models = this.models();

    if (typeof ids === 'undefined') {
      return this.count() === 0;
    }

    if (!Array.isArray(ids)) {
      ids = [ids];
    }

    return ids.every(function (id) {
      return !models[id];
    });
  };

  /**
   * Get checked model ids
   * @param {Array|String|Number} [idsToCheck] Ids to check
   * @return {Array} CheckedGroup model ids
   */
  CheckedGroup.prototype.getChecked = function (idsToCheck) {
    var models = this.models(),
        ids = [],
        id;

    for (id in models) {
      if (models.hasOwnProperty(id) && models[id]) {
        ids.push(id);
      }
    }

    if (typeof idsToCheck !== 'undefined') {
      if (!Array.isArray(idsToCheck)) {
        idsToCheck = [idsToCheck];
      }

      // ids contain strings (object keys)
      idsToCheck = idsToCheck.map(String);

      ids = ids.filter(function (id) {
        return idsToCheck.indexOf(id) !== -1;
      });
    }

    return ids;
  };

  /**
   * Get instance of CheckedGroup instance
   *
   * @param  {String}       name CheckedGroup identifier
   * @return {CheckedGroup}      CheckedGroup instance
   */
  function get(name) {
    if (cache[name]) {
      return cache[name];
    }

    cache[name] = new CheckedGroup();
    return cache[name];
  }

  return get;
}]);
/* <<< file end: js/core/angular/checked.js */

//# map link was there [checked.js.map]
/* >>> file start: js/core/angular/privacy.js */

//= require js/core/angular/api.js
//= require js/core/angular/checked.js

Site.page.template['angular/privacy.ng.tmpl'] = ' <span>\n\n  <select\n          class=\"sharp-select\"\n          name=\"privacy\"\n          ng-model=\"model.privacy\"\n          ng-attr-tabindex=\"{{tab}}\"\n          ng-options=\"item.value as item.title for item in privacy.all\"\n          ng-disabled=\"disabled\"\n  ></select>\n\n  <ul class=\"privacy-list\" ng-if=\"model.privacy === \'custom\'\">\n    <li class=\"privacy-item\" ng-repeat=\"group in privacy.groups track by group.id\">\n        <label>\n          <input type=\"checkbox\" ng-model=\"privacy.selected[group.id]\" name=\"custom_bit_{{group.id}}\" ng-attr-tabindex=\"{{tab}}\">\n          <span ng-bind=\"group.name\"></span>\n        </label>\n    </li>\n  </ul>\n\n</span>\n';
//= require_ml flatmedia.security
//= require_ml admin.writers_block.answer.private
//= require_ml admin.writers_block.answer.public
//= require_ml admin.writers_block.answer.custom
//= require_ml admin.writers_block.answer.friends
//= require_ml admin.writers_block.answer.default
//= require_ml admin.writers_block.answer.members
//= require_ml admin.writers_block.answer.maintainers

/**
 * Privacy directive
 *
 * @example
 *   HTML:
 *     <div lj-privacy="object"></div>
 *
 *     <div lj-privacy="object" lj-privacy-not-strict></div>
 *
 *     <div lj-privacy="object" lj-privacy-scope="something"></div>

 *     <div lj-privacy="object" lj-privacy-user="username"></div>
 */

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Privacy', ['LJ.Templates', 'LJ.Api', 'LJ.Checked']).factory('Privacy', ['Api', function (Api) {
    function getPrivacyList(params) {
      return Api.call('user.get_privacy_list', params, { cache: true }).then(function (response) {
        return response.list;
      });
    }

    function getGroups(params) {
      params = params || {};
      return Api.call('groups.list', params, { cache: true }).then(function (response) {
        return response.groups;
      });
    }

    return {
      getGroups: getGroups,
      getPrivacyList: getPrivacyList
    };
  }]).directive('ljPrivacy', ['$timeout', 'Privacy', 'checkedGroup', function ($timeout, Privacy, checkedGroup) {
    return {
      scope: {
        model: '=ljPrivacy',
        scope: '=ljPrivacyScope',
        user: '=ljPrivacyUser',
        tab: '=ljPrivacyTabindex',
        init: '=ljPrivacyInit',
        disabled: '=ljPrivacyDisabled'
      },
      templateUrl: 'privacy.ng.tmpl',
      controllerAs: 'privacy',
      controller: ['$scope', '$attrs', function ($scope, $attrs) {
        var that = this,
            groups = checkedGroup('custom'),
            init = true,
            vm = that;

        function watchCheckedGroups() {
          $scope.$watchCollection(function () {
            return groups.getChecked();
          }, function (value) {
            $scope.model.groupids = value.map(Number);
          });
        }

        function render() {
          if (!init || $scope.user === '') {
            return;
          }

          that.selected = groups.models();

          Privacy.getPrivacyList({ scope: $scope.scope, user: $scope.user }).then(function (list) {
            that.all = [];

            list.forEach(function (item) {
              that.all.push({ title: LJ.ml('admin.writers_block.answer.' + item), value: item });
            });

            if ($attrs.hasOwnProperty('ljPrivacyDeafult')) {
              that.all.unshift({ title: LJ.ml('admin.writers_block.answer.default'), value: '' });
            }

            if (!$scope.communityChanged) {
              var initial = that.all.find(function (item) {
                return item.value === $scope.model.privacy;
              });
            }

            if (!initial) {
              $scope.model.privacy = that.all[0].value;
            }
          });

          Privacy.getGroups({ journal: $scope.user }).then(function (value) {
            that.groups = value;
            groups.toggle($scope.model.groupids, true);
            watchCheckedGroups();
          });
        }

        if ($attrs.hasOwnProperty('ljPrivacyInit')) {
          $scope.$watch('init', function (value) {
            if (!value) {
              return;
            }
            init = value;
            $timeout(render);
          });
        }

        $scope.$watch('user', render);

        $scope.$watchCollection('model.groupids', function () {
          groups.toggle($scope.model.groupids, true);
        });

        $scope.$on('privacy:customGroups:reset', function () {
          groups.reset();
        });

        LJ.Event.on('community:change', function () {

          // we don't need first community:change after draft restore
          if (!$scope.needStateRestore) {
            $scope.communityChanged = true;
          } else {
            $scope.needStateRestore = false;
          }
        });

        LJ.Event.on('state_restore', function () {
          $scope.needStateRestore = true;
        });
      }]
    };
  }]);
})();
/* <<< file end: js/core/angular/privacy.js */

//# map link was there [privacy.js.map]
/* >>> file start: js/widgets/angular/answerForTheQuestionOfTheDay.js */

//= require js/core/angular/api.js
//= require js/core/angular/privacy.js

Site.page.template['angular/widgets/flatquestion/answer.ng.tmpl'] = '<a\n   ng-href=\"{{directive.siteroot}}/writersblock/answer?qid={{questionId}}\"\n   class=\"flatquestion-item-reply\"\n   ng-click=\"$event.preventDefault();directive.show()\"\n   lj-ml=\"widget.flatquestion.reply\"\n   >\n</a>\n\n<!-- flatquestion reply popup (add .p-flatquestion-reply at BODY to show) -->\n<div\n  class=\"\n    flatquestion-popup\n    flatquestion-reply\n  \"\n  ng-class=\"{\n    \'flatquestion-popup-sending\'      : directive.state.sending,\n    \'flatquestion-popup-successfully\' : directive.state.success,\n    \'flatquestion-reply-active\'       : directive.state.active\n  }\"\n  ng-if=\"directive.state.active\"\n  >\n\n  <!-- header -->\n  <header class=\"flatquestion-popup-header\">\n\n    <!-- head -->\n    <h3\n    class=\"flatquestion-popup-head\"\n    lj-ml=\"widget.flatquestion.popup.reply.head\"\n    ></h3>\n\n    <!-- close button -->\n    <span\n    tabindex=\"50\"\n    class=\"i-iconus flatquestion-popup-close\"\n    ng-click=\"directive.state.active = false\"\n    ></span>\n\n  </header>\n\n  <!-- body -->\n  <div class=\"flatquestion-popup-body\">\n\n    <form class=\"flatquestion-popup-form\">\n\n      <!-- answer -->\n      <div class=\"flatquestion-popup-field\">\n        <textarea\n        name=\"flatquestion_reply_aswer\"\n        cols=\"25\"\n        rows=\"5\"\n        tabindex=\"50\"\n        class=\"flatquestion-popup-textarea\"\n        lj-ml=\"widget.flatquestion.popup.reply.answer\"\n        lj-ml-attr=\"placeholder\"\n        ng-model=\"directive.post.text\"\n        ></textarea>\n      </div>\n\n      <!-- post to journal -->\n      <div class=\"flatquestion-popup-field\" ng-if=\"!directive.isIdentity\">\n        <input\n          type=\"checkbox\"\n          name=\"flatquestion_reply_post\"\n          id=\"flatquestion_reply_post\"\n          tabindex=\"50\"\n          ng-model=\"directive.post.is_without_post\"\n          ng-checked=\"!directive.post.is_without_post\"\n          class=\"flatquestion-popup-checkbox\"\n          ng-disabled=\"true\"\n          ng-show=\"false\"\n        >\n        <label\n          for=\"flatquestion_reply_post\"\n          class=\"flatquestion-popup-label\"\n          lj-ml=\"widget.flatquestion.popup.reply.post\"\n        ></label>\n        <span lj-privacy=\"directive.post\"></span>\n  </div>\n\n  <!-- anonymity -->\n  <div class=\"flatquestion-popup-field\" ng-show=\"directive.showQestionAtPage\">\n    <input\n    type=\"checkbox\"\n    name=\"flatquestion_reply_name\"\n    id=\"flatquestion_reply_name\"\n    tabindex=\"50\"\n    class=\"flatquestion-popup-checkbox\"\n    ng-model=\"directive.post.is_visible\"\n    ng-checked=\"directive.post.is_visible\"\n    ng-disabled=\"directive.isIdentity\"\n    >\n    <label\n    for=\"flatquestion_reply_name\"\n    class=\"flatquestion-popup-label\"\n    lj-ml=\"widget.flatquestion.popup.reply.name\"\n    ></label>\n  </div>\n\n  <!-- submit -->\n  <div class=\"flatquestion-popup-submitbox\">\n    <div\n      class=\"\n        flatquestion-popup-submitbox-inner\n        svgpreloader\n        svgpreloader-pseudo\n        svgpreloader-16\n        \">\n      <!--\n      <button\n      name=\"submit\"\n      tabindex=\"50\"\n      class=\"b-flatbutton\"\n      ng-click=\"directive.send()\"\n      ng-disabled=\"directive.isDisabled()\"\n      lj-ml=\"widget.flatquestion.popup.reply.submit\"\n      ></button> -->\n      <lj-flatbutton lj-flatbutton=\"[\'submit\', \'widget.flatquestion.popup.reply.submit\', \'b-flatbutton\', \'name\', \'submit\', \'tabindex\', \'50\', \'ng-click\', \'directive.send()\', \'ng-disabled\', \'directive.isDisabled()\']\">\n        </lj-flatbutton>\n    </div>\n  </div>\n\n  </form>\n\n  <!-- success message -->\n  <div class=\"flatquestion-popup-success\">\n    <p\n    class=\"flatquestion-popup-success-text\"\n    lj-ml=\"widget.flatquestion.popup.reply.success\"\n    ></p>\n    <p class=\"flatquestion-popup-success-button\">\n      <!--\n      <a\n      ng-href=\"{{directive.post.url}}\"\n      class=\"b-flatbutton b-flatbutton-simple\"\n      lj-ml=\"widget.flatquestion.popup.reply.success.button\"\n      ></a> -->\n      <lj-flatbutton lj-flatbutton=\"[\'a\', \'widget.flatquestion.popup.reply.success.button\', \'b-flatbutton b-flatbutton-simple\', \'ng-href\', \'{{directive.post.url}}\']\">\n        </lj-flatbutton>\n    </p>\n  </div>\n\n  </div><!-- /body -->\n\n</div>\n';

LJ.injectStyle('/* >>> file start: stc/widgets/flatquestion.css */\n/* flat question (LJSUP-19210) */\n\n\n\n/* root */\n\n\n\n.flatquestion {\n    }\n\n\n\n.flatwidget--default-theme .flatquestion {\n        color: #242F33;\n        }\n\n\n\n/* head */\n\n\n\n.flatquestion-head {\n        position: relative;\n        margin: 0 0 13px;\n        margin: 0 0 0.8125rem;\n        padding: 0;\n        }\n\n\n\n/* title */\n\n\n\n.flatquestion-title {\n            margin: 0;\n            padding: 0;\n            font-style: normal;\n            font-weight: normal;\n            font-size: 20px;\n            font-size: 1.25rem;\n            text-transform: uppercase;\n            }\n\n\n\n.flatwidget--default-theme .flatquestion-title,\n            .flatwidget--default-theme .flatquestion-title A:link,\n            .flatwidget--default-theme .flatquestion-title A:visited {\n                color: #829399;\n                }\n\n\n\n.flatwidget--default-theme .flatquestion-title A:hover,\n            .flatwidget--default-theme .flatquestion-title A:active {\n                color: #00A3D9;\n                }\n\n\n\n/* body */\n\n\n\n.flatquestion-body {\n        position: relative;\n        margin: 0 0 1em;\n        padding: 0 0 1em;\n        border-bottom: 1px solid #DAE3E6;\n        }\n\n\n\n/* navigation */\n\n\n\n.flatquestion-nav {\n            position: absolute;\n            top: 2px;\n            right: 2px;\n            margin: 0;\n            color: #7A9199;\n            }\n\n\n\n/* prev */\n\n\n\n.flatquestion-nav-prev {\n                display: inline-block;\n                width: 16px;\n                height: 16px;\n                cursor: pointer;\n                }\n\n\n\n/* next */\n\n\n\n.flatquestion-nav-next {\n                display: inline-block;\n                width: 16px;\n                height: 16px;\n                cursor: pointer;\n                }\n\n\n\n.flatquestion-nav-prev .svgicon,\n                .flatquestion-nav-next .svgicon {\n                    width: 16px;\n                    height: 16px;\n                    }\n\n\n\n/* disabled */\n\n\n\n.flatquestion-nav-disabled {\n                filter: alpha(opacity=50);\n                opacity: 0.5;\n                cursor: default;\n                pointer-events: none;\n                }\n\n\n\n/* items */\n\n\n\n.flatquestion-items {\n            margin: 0;\n            padding: 0;\n            list-style: none;\n            }\n\n\n\n/* item */\n\n\n\n.flatquestion-item {\n                margin: 0;\n                padding: 0;\n                }\n\n\n\n/* meta */\n\n\n\n.flatquestion-item-meta {\n                    margin: 0;\n                    }\n\n\n\n/* date */\n\n\n\n.flatquestion-item-date {\n                        display: block;\n                        margin: 0;\n                        }\n\n\n\n.flatwidget--default-theme .flatquestion-item-date {\n                            color: #829399;\n                        }\n\n\n\n/* user */\n\n\n\n.flatquestion-item-user {\n                        margin: 0;\n                        }\n\n\n\n/* question */\n\n\n\n.flatquestion-item-question {\n                    position: relative;\n                    margin: 20px 0 1em;\n                    padding: 1em;\n                    border-radius: 0.5em;\n                    background: #DAE3E6;\n                    }\n\n\n\n/* arrow */\n\n\n\n.flatquestion-item-question:after {\n                        content: \" \";\n                        overflow: hidden;\n                        position: absolute;\n                        top: -15px;\n                        left: 20px;\n                        width: 34px;\n                        height: 16px;\n                        margin: 0;\n                        padding: 0;\n                        background-image: url(\'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20id%3D%222-Layer_1%22%20height%3D%2216%22%20viewBox%3D%220%200%2033.999%2015.999%22%20width%3D%2234%22%20version%3D%221.1%22%20y%3D%220px%22%20x%3D%220px%22%3E%3Cpath%20d%3D%22m12%200c-0.45-0.096%207.339%2014.482-12%2014.975v1.023h33.999v-1.027c-14.672-0.582-16.643-13.83-21.999-14.971z%22%20fill%3D%22%23DAE3E6%22%2F%3E%3C%2Fsvg%3E\');\n                        background-repeat: no-repeat;\n                        background-position: 0 0;\n                        font: 0/0 a;\n                        }\n\n\n\n/* subject */\n\n\n\n.flatquestion-item-subject {\n                        margin: 0 0 0.3rem;\n                        padding: 0;\n                        line-height: 1.2;\n                        font-size: 1.125rem;\n                        font-weight: 600;\n                        font-family: \'ProximaNova\', Tahoma, Arial, sans-serif;\n                        }\n\n\n\n.flatquestion-item-subject A {\n                            display: inline-block;\n                            }\n\n\n\n.flatwidget--default-theme .flatquestion-item-subject A:link,\n                        .flatwidget--default-theme .flatquestion-item-subject A:visited {\n                            color: #242F33;\n                            }\n\n\n\n.flatwidget--default-theme .flatquestion-item-subject A:hover,\n                        .flatwidget--default-theme .flatquestion-item-subject A:active {\n                            color: #00A3D9;\n                            }\n\n\n\n/* text */\n\n\n\n.flatquestion-item-text {\n                        margin: 0;\n                        }\n\n\n\n/* controls */\n\n\n\n.flatquestion-item-controls {\n                    margin: 0;\n                    }\n\n\n\n.flatquestion-item-controls:after {\n                        content: \"\";\n                        display: table;\n                        border-collapse: collapse;\n                        clear: both;\n                        }\n\n\n\n.flatwidget--default-theme .flatquestion-item-controls A:link,\n                    .flatwidget--default-theme .flatquestion-item-controls A:visited {\n                        color: #00A3D9;\n                        }\n\n\n\n.flatwidget--default-theme .flatquestion-item-controls A:hover,\n                    .flatwidget--default-theme .flatquestion-item-controls A:active {\n                        color: #0086b3;\n                        }\n\n\n\n.flatwidget--default-theme .flatquestion-item-controls .b-flatbutton:link,\n                        .flatwidget--default-theme .flatquestion-item-controls .b-flatbutton:visited,\n                        .flatwidget--default-theme .flatquestion-item-controls .b-flatbutton:hover,\n                        .flatwidget--default-theme .flatquestion-item-controls .b-flatbutton:active {\n                            color: #FFF;\n                            }\n\n\n\n/* reply */\n\n\n\n.flatquestion-item-reply {\n                        float: right;\n                        margin: 0;\n                        text-transform: uppercase;\n                        }\n\n\n\n/* answers */\n\n\n\n.flatquestion-item-answers {\n                        float: left;\n                        margin: 0;\n                        }\n\n\n\n.flatquestion-item-answers-icon {\n                            display: inline-block;\n                            vertical-align: -3px;\n                            color: #7A9199;\n                            }\n\n\n\n.flatquestion-item-answers-icon .svgicon {\n                                width: 17px;\n                                height: 16px;\n                                }\n\n\n\n/* dummy loader */\n\n\n\n.flatquestion-dummy {\n            display: none;\n            margin: 0;\n            }\n\n\n\n.flatquestion-dummy-item {\n                background: #F8F9FB;\n                -webkit-animation: loading-mysocial 1s infinite;\n                animation:         loading-mysocial 1s infinite;\n                }\n\n\n\n.flatquestion-dummy-user {\n                width: 40%;\n                height: 25px;\n                margin: 0 0 1em;\n                padding: 0;\n                }\n\n\n\n.flatquestion-dummy-content {\n                height: 90px;\n                margin: 0 0 1em;\n                padding: 0;\n                }\n\n\n\n.flatquestion-dummy-comments {\n                width: 30%;\n                height: 25px;\n                margin: 0 0 0 auto;\n                padding: 0;\n                }\n\n\n\n@-webkit-keyframes loading-mysocial {\n                0%   { opacity: 0.8; }\n                50%  { opacity: 0.9; }\n                100% { opacity: 1; }\n            }\n\n\n\n@keyframes loading-mysocial {\n                0%   { opacity: 0.8; }\n                50%  { opacity: 0.9; }\n                100% { opacity: 1; }\n            }\n\n\n\n/* erroneous */\n\n\n\n.flatquestion-erroneous {\n            display: none;\n            margin: 0;\n            padding: 0;\n            font-size: 1.2307em;\n            color: #D92B2B;\n            }\n\n\n\n/* emptiness */\n\n\n\n.flatquestion-emptiness {\n            display: none;\n            margin: 0;\n            padding: 2em 0 0;\n            font-size: 1.2307em;\n            color: #829399;\n            }\n\n\n\n/* footer */\n\n\n\n.flatquestion-footer {\n        margin: 0;\n        font-size: 0.875rem;\n        }\n\n\n\n.flatquestion-footer-items {\n            margin: 0;\n            padding: 0;\n            list-style: none;\n            text-align: right;\n            }\n\n\n\n.flatquestion-footer-item {\n                display: inline;\n                margin: 0;\n                }\n\n\n\n.flatquestion-footer-item:before {\n                content: \"|\";\n                margin: 0;\n                }\n\n\n\n.flatwidget--default-theme .flatquestion-footer-item:before {\n                    color: #242F33;\n                    }\n\n\n\n.flatquestion-footer-item:first-child:before {\n                content: none;\n                display: none;\n                }\n\n\n\n.flatwidget--default-theme .flatquestion-footer-item A:link,\n                .flatwidget--default-theme .flatquestion-footer-item A:visited {\n                    color: #00A3D9;\n                    }\n\n\n\n.flatwidget--default-theme .flatquestion-footer-item A:hover,\n                .flatwidget--default-theme .flatquestion-footer-item A:active {\n                    color: #0086b3;\n                    }\n\n\n\n/* flatquestion anon */\n\n\n\n.flatquestion-anon {\n    }\n\n\n\n/* flatquestion empty */\n\n\n\n.flatquestion-empty {\n    }\n\n\n\n/* show */\n\n\n\n.flatquestion-empty .flatquestion-emptiness {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.flatquestion-empty .flatquestion-items {\n        display: none;\n        }\n\n\n\n.flatquestion-empty .flatquestion-dummy {\n        display: none;\n        }\n\n\n\n.flatquestion-empty .flatquestion-erroneous {\n        display: none;\n        }\n\n\n\n/* flatquestion loading */\n\n\n\n.flatquestion-loading {\n    }\n\n\n\n/* show */\n\n\n\n.flatquestion-loading .flatquestion-nav {\n        display: block;\n        }\n\n\n\n.flatquestion-loading .flatquestion-items {\n        display: block;\n        pointer-events: none;\n        filter: alpha(opacity=30);\n        opacity: 0.3;\n        }\n\n\n\n/* hide */\n\n\n\n.flatquestion-loading .flatquestion-dummy {\n        display: none;\n        }\n\n\n\n.flatquestion-loading .flatquestion-erroneous {\n        display: none;\n        }\n\n\n\n.flatquestion-loading .flatquestion-emptiness {\n        display: none;\n        }\n\n\n\n/* flatquestion preloading */\n\n\n\n.flatquestion-preloading {\n    }\n\n\n\n/* show */\n\n\n\n.flatquestion-preloading .flatquestion-dummy {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.flatquestion-preloading .flatquestion-nav {\n        display: none;\n        }\n\n\n\n.flatquestion-preloading .flatquestion-items {\n        display: none;\n        }\n\n\n\n.flatquestion-preloading .flatquestion-erroneous {\n        display: none;\n        }\n\n\n\n.flatquestion-preloading .flatquestion-emptiness {\n        display: none;\n        }\n\n\n\n/* error */\n\n\n\n.flatquestion-error {\n    }\n\n\n\n/* show */\n\n\n\n.flatquestion-error .flatquestion-erroneous {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.flatquestion-error .flatquestion-nav {\n        display: none;\n        }\n\n\n\n.flatquestion-error .flatquestion-items {\n        display: none;\n        }\n\n\n\n.flatquestion-error .flatquestion-dummy {\n        display: none;\n        }\n\n\n\n.flatquestion-error .flatquestion-emptiness {\n        display: none;\n        }\n\n\n\n/* flatquestion popup */\n\n\n\n.flatquestion-popup {\n    display: none;\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    z-index: 5001;\n    width: 510px;\n    margin: -280px 0 0 -255px;\n    padding: 0;\n    background: #FFF;\n    color: #242F33;\n    }\n\n\n\n/* head */\n\n\n\n.flatquestion-popup-header {\n        margin: 0;\n        padding: 15px 25px;\n        background: #09C;\n        color: #FFF;\n        }\n\n\n\n.flatquestion-popup-head,\n        .b-text .flatquestion-popup-head {\n            margin: 0;\n            padding: 0;\n            text-transform: uppercase;\n            font: 300 21px/1 \'ProximaNova\', Helvetica, Arial, sans-serif;\n            font: 300 1.3125rem/1 \'ProximaNova\', Helvetica, Arial, sans-serif;\n            color: #FFF;\n            }\n\n\n\n.flatquestion-popup-header .i-iconus {\n            position: absolute;\n            width: 30px;\n            height: 30px;\n            right: 12px;\n            top: 12px;\n            background-image: url(/img/schemius/s-icons.svg?v=40651);\n            background-position: -62px 6px;\n            background-repeat: no-repeat;\n            cursor: pointer;\n            }\n\n\n\n/* body */\n\n\n\n.flatquestion-popup-body {\n        overflow: auto;\n        position: relative;\n        max-height: 400px;\n        padding: 25px;\n        font-size: 0.8125rem;\n        }\n\n\n\n/* field */\n\n\n\n.flatquestion-popup-field {\n            margin: 0 0 1em;\n            }\n\n\n\n/* input */\n\n\n\n.flatquestion-popup-input {\n                width: 100%;\n                margin: 0;\n                padding: 13px;\n                border: 1px solid #CED6D9;\n                box-sizing: border-box;\n                font: 400 18px/1 \'ProximaNova\', Helvetica, Arial, sans-serif;\n                font: 400 1.125rem/1 \'ProximaNova\', Helvetica, Arial, sans-serif;\n                background: #F7F9FA;\n                color: #242F33;\n                }\n\n\n\n.flatquestion-popup-input:focus {\n                border-color: #00A3D9;\n                }\n\n\n\n/* textarea */\n\n\n\n.flatquestion-popup-textarea {\n                width: 100%;\n                height: 6em;\n                margin: 0;\n                padding: 13px;\n                border: 1px solid #CED6D9;\n                box-sizing: border-box;\n                resize: vertical;\n                font: 400 18px/1 \'ProximaNova\', Helvetica, Arial, sans-serif;\n                font: 400 1.125rem/1 \'ProximaNova\', Helvetica, Arial, sans-serif;\n                background: #F7F9FA;\n                color: #242F33;\n                }\n\n\n\n.flatquestion-popup-textarea:focus {\n                border-color: #00A3D9;\n                }\n\n\n\n.flatquestion-popup-checkbox {\n                margin: 0;\n                }\n\n\n\n.flatquestion-popup-label {\n                margin: 0;\n                }\n\n\n\n.flatquestion-popup-select {\n                margin: 0;\n                }\n\n\n\n.flatquestion-popup-friendsgroups {\n                list-style: none;\n                margin: 0.2em 0 0 1.4em;\n                padding: 0;\n                }\n\n\n\n.flatquestion-popup-friendsgroups-item {\n                    margin: 0;\n                    padding: 0;\n                    }\n\n\n\n/* submit field */\n\n\n\n.flatquestion-popup-submitbox {\n            margin: 0;\n            text-align: right;\n            }\n\n\n\n/* inner block for preloader */\n\n\n\n.flatquestion-popup-submitbox-inner {\n                position: relative;\n                display: inline-block;\n                padding: 0 0 0 30px;\n                }\n\n\n\n.flatquestion-popup-submitbox-inner.svgpreloader:after {\n                position: absolute;\n                top: 50%;\n                left: 0;\n                display: none;\n                margin-top: -8px;\n                }\n\n\n\n/* success message */\n\n\n\n.flatquestion-popup-success {\n            display: none;\n            margin: 0;\n            }\n\n\n\n.flatquestion-popup-success-text {\n                margin: 0;\n                text-align: center;\n                font-size: 1.2em;\n                }\n\n\n\n.flatquestion-popup-success-button {\n                margin: 1em 0 0;\n                text-align: center;\n                }\n\n\n\n.b-mainpage-state-discovery .flatquestion-popup-success A:link,\n                .b-mainpage-state-discovery .flatquestion-popup-success A:visited,\n                .b-mainpage-state-discovery .flatquestion-popup-success A:hover,\n                .b-mainpage-state-discovery .flatquestion-popup-success A:active {\n                    color: #FFF;\n                    }\n\n\n\n.b-lenta .flatquestion-popup-success A:link,\n                .b-lenta .flatquestion-popup-success A:visited,\n                .b-lenta .flatquestion-popup-success A:hover,\n                .b-lenta .flatquestion-popup-success A:active {\n                    color: #FFF;\n                    }\n\n\n\n/* block message */\n\n\n\n.flatquestion-popup-block {\n            display: none;\n            margin: 0;\n            }\n\n\n\n.flatquestion-popup-block-text {\n                margin: 0;\n                text-align: center;\n                font-size: 1.2em;\n                color: #C00;\n                }\n\n\n\n/* sending request */\n\n\n\n.flatquestion-popup-sending {\n    }\n\n\n\n.flatquestion-popup-sending .flatquestion-popup-input,\n    .flatquestion-popup-sending .flatquestion-popup-textarea,\n    .flatquestion-popup-sending .flatquestion-popup-checkbox,\n    .flatquestion-popup-sending .flatquestion-popup-select,\n    .flatquestion-popup-sending .flatquestion-popup-friendsgroups-checkbox {\n        opacity: 0.5;\n        pointer-events: none;\n        }\n\n\n\n.flatquestion-popup-sending .flatquestion-popup-submitbox-inner.svgpreloader:after {\n        display: block;\n        }\n\n\n\n/* popup with success (successfully) */\n\n\n\n.flatquestion-popup-successfully {\n    }\n\n\n\n/* show */\n\n\n\n.flatquestion-popup-successfully .flatquestion-popup-success {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.flatquestion-popup-successfully .flatquestion-popup-form {\n        display: none;\n        }\n\n\n\n.flatquestion-popup-successfully .flatquestion-popup-error {\n        display: none;\n        }\n\n\n\n/* popup with block (blocked) */\n\n\n\n.flatquestion-popup-blocked {\n    margin-top: -100px;\n    }\n\n\n\n/* show */\n\n\n\n.flatquestion-popup-blocked .flatquestion-popup-block {\n        display: block;\n        }\n\n\n\n/* hide */\n\n\n\n.flatquestion-popup-blocked .flatquestion-popup-form {\n        display: none;\n        }\n\n\n\n.flatquestion-popup-blocked .flatquestion-popup-error {\n        display: none;\n        }\n\n\n\n/* show reply popup (add .flatquestion-reply-active to .flatquestion-reply) */\n\n\n\n.flatquestion-reply.flatquestion-reply-active {\n    display: block;\n    }\n\n\n\n/* show suggest popup (add .p-flatquestion-suggest to BODY) */\n\n\n\n.p-flatquestion-suggest .flatquestion-suggest {\n    display: block;\n    }\n\n\n\n.p-flatquestion-suggest .b-fader {\n    display: block !important;\n    }\n\n\n\n/* change position fixed to absolute for short screens */\n\n\n\n@media screen and (max-height: 700px) {\n\n    .flatquestion-popup {\n        top: 50px;\n        margin-top: 0;\n        }\n    .flatquestion-popup-blocked {\n        top: 150px;\n        }\n\n}\n\n\n\n@media screen and (max-height: 500px) {\n\n    .flatquestion-popup {\n        top: 30px;\n        }\n    .flatquestion-popup-blocked {\n        top: 100px;\n        }\n\n}\n\n\n\n@media screen and (max-height: 300px) {\n\n    .flatquestion-popup-body {\n        max-height: 200px;\n        }\n\n}\n\n\n\n/* no-js versions (LJSUP-19628) */\n\n\n\n.flatquestion-nojs {\n    width: 510px;\n    margin: 2em auto;\n    border: 1px solid #DAE3E6;\n    }\n\n\n\n.flatquestion-nojs .flatquestion-popup-body {\n        max-height: none;\n        margin: 0;\n        padding: 25px;\n        font-size: 1em;\n        }\n\n\n\n.flatquestion-nojs .flatquestion-popup-success {\n        display: block;\n        }\n\n\n\n.flatquestion-nojs-friendsgroups {\n        margin: 0.3em 0 0 1.2em;\n        }\n\n\n\n#js .flatquestion-nojs-friendsgroups {\n        display: none;\n        }\n\n\n\n.flatquestion-nojs-field {\n        margin: 0;\n        }\n\n/* <<< file end: stc/widgets/flatquestion.css */\n\n/*# sourceMappingURL=flatquestion.css.map */\n');

//= require_ml widget.flatquestion.popup.reply.success
//= require_ml widget.flatquestion.popup.reply.success.button
//= require_ml widget.flatquestion.popup.reply.security.public
//= require_ml widget.flatquestion.popup.reply.security.friends
//= require_ml widget.flatquestion.popup.reply.security.private
//= require_ml widget.flatquestion.popup.reply.security.custom
//= require_ml widget.flatquestion.popup.reply.head
//= require_ml widget.flatquestion.popup.reply.answer
//= require_ml widget.flatquestion.popup.reply.post
//= require_ml widget.flatquestion.popup.reply.submit
//= require_ml widget.flatquestion.popup.reply.submit.post
//= require_ml widget.flatquestion.popup.reply.submit.name
//= require_ml widget.flatquestion.popup.reply.submit.postname
//= require_ml widget.flatquestion.popup.reply.name
//= require_ml widget.flatquestion.reply

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Widget.AnswerForTheQuestionOfTheDay', ['LJ.Templates', 'LJ.Directives', 'LJ.Api', 'LJ.Privacy']).factory('Reply', ['Api', function (Api) {
    var factory = {};

    factory.send = function (reply) {
      return Api.call('writers_block.make_answer', reply);
    };

    factory.validate = function (reply) {
      if (!reply.text || reply.text.length === 0) {
        return false;
      }

      if (reply.privacy === 'custom' && reply.groupids.length === 0) {
        return false;
      }

      return true;
    };

    return factory;
  }]).directive('ljQuestionReply', ['Reply', function () {
    return {
      restrict: 'A',
      scope: {
        questionId: '=ljQuestionReply'
      },
      templateUrl: 'answer.ng.tmpl',
      controllerAs: 'directive',
      controller: ['$scope', '$element', '$document', 'Reply', function ($scope, $element, $document, Reply) {
        var that = this;

        that.isIdentity = LJ.get('remote.is_identity');

        var post = {
          id: null,
          text: null,
          is_without_post: false,
          privacy: 'public',
          groupids: [],
          is_visible: that.isIdentity ? true : false
        };

        that.siteroot = LJ.get('siteroot');
        that.post = angular.copy(post);
        that.groups = [];

        that.state = {
          sending: false,
          success: false,
          active: false
        };

        that.send = function () {
          that.state.sending = true;
          Reply.send(that.post).then(function (response) {
            that.post.url = response.url;
            that.state.sending = false;
            that.state.success = true;
          });
        };

        that.isDisabled = function () {
          return !Reply.validate(that.post);
        };

        that.show = function () {
          that.state.active = true;
          that.post = angular.copy(post);
        };

        that.hide = function () {
          that.state.active = false;
        };

        $scope.$watch(function () {
          return that.post.privacy;
        }, function (value) {
          that.showQestionAtPage = value === 'public';
        });

        $scope.$watch(function () {
          return that.state.active;
        }, function (state) {
          if (!state) {
            that.state.sending = false;
            that.state.success = false;
          }
          angular.element('body').toggleClass('p-fader', state);
        });

        $scope.$watch('questionId', function (value) {
          post.id = value;
        });

        function keydown(event) {
          if (event.which === 27) {
            $scope.$apply(that.hide);
          }
        }

        $document.on('keydown', keydown);

        $scope.$on('$destroy', function () {
          $document.off('keydown', keydown);
        });
      }]
    };
  }]);
})();
/* <<< file end: js/widgets/angular/answerForTheQuestionOfTheDay.js */

//# map link was there [answerForTheQuestionOfTheDay.js.map]
/* >>> file start: js/widgets/angular/questionOfTheDay.js */

//= require js/core/angular/api.js
//= require js/core/angular/ljUser.js
//= require js/core/angular/users.js

//= require js/widgets/angular/answerForTheQuestionOfTheDay.js

Site.page.template['angular/widgets/flatquestion/flatquestion.ng.tmpl'] = '<!-- Question Of The Day (flat version, LJSUP-19210) -->\n\n<div\n    class=\"\n        flatquestion\n        l-flatslide-aside-block\n        js-elem-bordercolor\n        \"\n    ng-class=\"{\n        \'flatquestion-empty\':      widget.questions.length === 0,\n        \'flatquestion-error\':      widget.state.error,\n        \'flatquestion-loading\':    widget.state.loading,\n        \'flatquestion-preloading\': !widget.state.initialized,\n        \'flatquestion-anon\':       !widget.currentQuestion.author\n    }\"\n    >\n\n\n\n    <!-- head -->\n    <header\n        class=\"\n            flatquestion-head\n            flatwidget__head\"\n        >\n        <h3\n            class=\"\n                flatquestion-title\n                js-elem-color--a\"\n            >\n            <a\n                ng-href=\"{{widget.writersBlockCommunity}}\"\n                target=\"_blank\"\n                lj-ml=\"widget.flatquestion.head\"\n                ></a>\n        </h3>\n    </header>\n\n    <!-- body -->\n    <div\n        class=\"\n            flatquestion-body\n            flatwidget__body\n            js-elem-bordercolor\"\n        >\n\n        <!-- navigation -->\n        <span\n            class=\"\n                flatquestion-nav\n                js-elem-color--svgicon\n                \">\n            <span\n                class=\"flatquestion-nav-prev\"\n                lj-ml=\"widget.flatquestion.nav.prev\"\n                lj-ml-attr=\"title\"\n                ng-click=\"widget.prev()\"\n                ng-class=\"{\n                    \'flatquestion-nav-disabled\': widget.currentQuestionIndex === widget.questions.length - 1\n                }\"\n                >\n                <span lj-svg-icon=\"flaticon--arrow-left\"></span>\n            </span>\n            <span\n                class=\"flatquestion-nav-next flatquestion-nav-disabled\"\n                ng-class=\"{\n                    \'flatquestion-nav-disabled\': widget.currentQuestionIndex === 0\n                }\"\n                lj-ml=\"widget.flatquestion.nav.next\"\n                lj-ml-attr=\"title\"\n                ng-click=\"widget.next()\"\n                >\n                <span lj-svg-icon=\"flaticon--arrow-right\"></span>\n            </span>\n        </span>\n\n        <!-- items -->\n        <ul\n            class=\"flatquestion-items\"\n            ng-if=\"widget.currentQuestion\"\n            >\n\n            <!-- item -->\n            <li class=\"flatquestion-item\">\n\n                <!-- meta -->\n                <div class=\"flatquestion-item-meta\">\n                    <time\n                        class=\"flatquestion-item-date\"\n                        ng-bind=\"widget.currentQuestion.datetime\"\n                        ></time>\n                    <span\n                        class=\"\n                            flatquestion-item-user\n                             js-link-color--a\n                             \"\n                        lj-user-dynamic=\"widget.currentQuestion.author.username\"\n                        ng-if=\"widget.currentQuestion.author\"\n                        ></span>\n                </div>\n\n                <!-- question -->\n                <div class=\"flatquestion-item-question\">\n                    <h4\n                        class=\"\n                            flatquestion-item-subject\n                            js-link-color--a\"\n                        ng-if=\"widget.currentQuestion.subject\"\n                        >\n                        <a\n                            ng-href=\"{{widget.siteroot}}/writersblock/question?qid={{widget.currentQuestion.id}}\"\n                            target=\"_blank\"\n                            lj-html-live=\"widget.currentQuestion.subject\"\n                            ></a>\n                    </h4>\n                    <div\n                        class=\"flatquestion-item-text\"\n                        lj-html-live=\"widget.currentQuestion.text\"\n                        ></div>\n                </div>\n\n                <!-- controls -->\n                <div class=\"flatquestion-item-controls\">\n                    <a\n                        ng-href=\"{{widget.siteroot}}/writersblock/question?qid={{widget.currentQuestion.id}}\"\n                        target=\"_blank\"\n                        class=\"\n                            flatquestion-item-answers\n                            js-link-color\n                            \"\n                        >\n                        <span\n                            class=\"\n                                flatquestion-item-answers-icon\n                                js-elem-color--svgicon\n                                \"\n                            lj-svg-icon=\"flaticon--comments-bold\"\n                            ></span>\n                        <span\n                            class=\"flatquestion-item-answers-inner\"\n                            ng-bind=\"widget.currentQuestion.comments_cnt\"\n                            ></span>\n                    </a>\n                    <span\n                        lj-question-reply=\"widget.currentQuestion.id\"\n                        class=\"js-link-color--a-novisited\"\n                        ></span>\n                </div>\n            </li><!-- /item -->\n\n        </ul><!-- /items -->\n\n        <!-- dummy loader -->\n        <div class=\"flatquestion-dummy\">\n            <div class=\"flatquestion-dummy-item flatquestion-dummy-user\"></div>\n            <div class=\"flatquestion-dummy-item flatquestion-dummy-content\"></div>\n            <div class=\"flatquestion-dummy-item flatquestion-dummy-comments\"></div>\n        </div>\n\n        <!-- erroneous message -->\n        <p\n            class=\"flatquestion-erroneous\"\n            lj-ml=\"widget.flatquestion.error\"\n            ></p>\n\n        <!-- emptiness message -->\n        <p\n            class=\"flatquestion-emptiness\"\n            lj-ml=\"widget.flatquestion.empty\"\n            ></p>\n\n    </div><!-- /body -->\n\n\n\n    <!-- footer -->\n    <footer\n        class=\"\n            flatquestion-footer\n            flatwidget__footer\n            js-link-color--a-novisited\"\n        >\n\n        <!-- items -->\n        <ul class=\"flatquestion-footer-items\">\n            <li\n                class=\"\n                    flatquestion-footer-item\n                    js-sidebar-color--before\n                    \">\n                <a\n                    ng-href=\"{{widget.siteroot}}/writersblock/suggest\"\n                    ng-click=\"widget.showSuggestion($event)\"\n                    lj-ml=\"widget.flatquestion.suggest\"\n                    ></a>\n            </li>\n            <li\n                class=\"\n                    flatquestion-footer-item\n                    js-sidebar-color--before\n                    \">\n                <a\n                    ng-href=\"{{widget.siteroot}}/friends/add.bml?user=writersblock\"\n                    target=\"_blank\"\n                    lj-ml=\"widget.flatquestion.subscribe\"\n                    ></a>\n            </li>\n            <li\n                class=\"\n                    flatquestion-footer-item\n                    js-sidebar-color--before\n                    \">\n                <a\n                    ng-href=\"{{widget.writersBlockCommunity}}\"\n                    target=\"_blank\"\n                    lj-ml=\"widget.flatquestion.all\"\n                    ></a>\n            </li>\n        </ul><!-- /items -->\n\n    </footer><!-- /footer -->\n\n\n\n</div><!-- /flatquestion -->\n\n\n<!-- flatquestion suggest popup (add .p-flatquestion-suggest at BODY to show) -->\n<div\n    class=\"\n        flatquestion-popup\n        flatquestion-suggest\n        \"\n    ng-class=\"{\n      \'flatquestion-popup-sending\': suggest.state.sending,\n      \'flatquestion-popup-successfully\': suggest.state.success,\n      \'flatquestion-popup-blocked\': suggest.state.blocked\n    }\"\n\n    ng-if=\"widget.state.suggest\"\n    ng-controller=\"QuestionSuggestCtrl as suggest\"\n    >\n\n    <!-- header -->\n    <header class=\"flatquestion-popup-header\">\n\n        <!-- head -->\n        <h3\n            class=\"flatquestion-popup-head\"\n            lj-ml=\"widget.flatquestion.popup.suggest.head\"\n            ></h3>\n\n        <!-- close button -->\n        <span\n            tabindex=\"50\"\n            class=\"i-iconus flatquestion-popup-close\"\n            ng-click=\"widget.state.suggest = false\"\n            ></span>\n\n    </header>\n\n    <!-- body -->\n    <div class=\"flatquestion-popup-body\">\n\n        <form class=\"flatquestion-popup-form\">\n\n            <!-- subject -->\n            <div class=\"flatquestion-popup-field\">\n                <input\n                    type=\"text\"\n                    name=\"flatquestion_suggest_subject\"\n                    id=\"flatquestion_suggest_subject\"\n                    size=\"30\"\n                    tabindex=\"50\"\n                    value=\"\"\n                    class=\"flatquestion-popup-input\"\n                    lj-ml=\"widget.flatquestion.popup.suggest.subject\"\n                    lj-ml-attr=\"placeholder\"\n                    ng-model=\"suggest.question.subject\"\n                    >\n            </div>\n\n            <!-- suggest -->\n            <div class=\"flatquestion-popup-field\">\n                <textarea\n                    name=\"flatquestion_suggest_question\"\n                    id=\"flatquestion_suggest_question\"\n                    cols=\"25\"\n                    rows=\"5\"\n                    tabindex=\"50\"\n                    class=\"flatquestion-popup-textarea\"\n                    lj-ml=\"widget.flatquestion.popup.suggest.question\"\n                    lj-ml-attr=\"placeholder\"\n                    ng-model=\"suggest.question.body\"\n                    ></textarea>\n            </div>\n\n            <!-- anonymity -->\n            <div class=\"flatquestion-popup-field\">\n                <input\n                    type=\"checkbox\"\n                    name=\"flatquestion_suggest_name\"\n                    id=\"flatquestion_suggest_name\"\n                    tabindex=\"50\"\n                    class=\"flatquestion-popup-checkbox\"\n                    ng-model=\"suggest.question.show_name\"\n                    >\n                <label\n                    for=\"flatquestion_suggest_name\"\n                    class=\"flatquestion-popup-label\"\n                    lj-ml=\"widget.flatquestion.popup.suggest.name\"\n                    ></label>\n            </div>\n\n            <!-- submit -->\n            <div class=\"flatquestion-popup-submitbox\">\n                <div\n                    class=\"\n                        flatquestion-popup-submitbox-inner\n                        svgpreloader\n                        svgpreloader-pseudo\n                        svgpreloader-16\n                        \">\n                    <!--\n                    <button\n                        name=\"submit\"\n                        tabindex=\"50\"\n                        class=\"b-flatbutton\"\n                        ng-disabled=\"suggest.isDisabled()\"\n                        ng-click=\"suggest.send()\"\n                        lj-ml=\"widget.flatquestion.popup.suggest.submit\"\n                        ></button> -->\n                    <lj-flatbutton lj-flatbutton=\"[\'button\', \'widget.flatquestion.popup.suggest.submit\', \'b-flatbutton\', \'name\', \'submit\', \'tabindex\', \'50\', \'ng-disabled\', \'suggest.isDisabled()\', \'ng-click\', \'suggest.send()\']\">\n                        </lj-flatbutton>\n                </div>\n            </div>\n\n        </form>\n\n        <!-- success message -->\n        <div class=\"flatquestion-popup-success\">\n            <p\n                class=\"flatquestion-popup-success-text\"\n                lj-ml=\"widget.flatquestion.popup.suggest.success\"\n                ></p>\n            <p class=\"flatquestion-popup-success-button\">\n                <!--\n                <a\n                    class=\"b-flatbutton b-flatbutton-simple\"\n                    ng-click=\"suggest.reset()\"\n                    lj-ml=\"widget.flatquestion.popup.suggest.success.button\"\n                    ></a> -->\n                <lj-flatbutton lj-flatbutton=\"[\'a\', \'widget.flatquestion.popup.suggest.success.button\', \'b-flatbutton b-flatbutton-simple\', \'ng-click\', \'suggest.reset()\']\">\n                    </lj-flatbutton>\n            </p>\n        </div>\n\n        <!-- block message -->\n        <div class=\"flatquestion-popup-block\">\n            <p\n                class=\"flatquestion-popup-block-text\"\n                lj-html-live=\"suggest.blockedReason\"\n                ></p>\n        </div>\n\n    </div><!-- /body -->\n\n</div>\n';

// error: widgets/flatquestion.css is already included

//= require_ml widget.flatquestion.all
//= require_ml widget.flatquestion.answers
//= require_ml widget.flatquestion.head
//= require_ml widget.flatquestion.nav.next
//= require_ml widget.flatquestion.nav.prev
//= require_ml widget.flatquestion.subscribe
//= require_ml widget.flatquestion.suggest

//= require_ml widget.flatquestion.popup.suggest.head
//= require_ml widget.flatquestion.popup.suggest.subject
//= require_ml widget.flatquestion.popup.suggest.question
//= require_ml widget.flatquestion.popup.suggest.name
//= require_ml widget.flatquestion.popup.suggest.success
//= require_ml widget.flatquestion.popup.suggest.success.button
//= require_ml widget.flatquestion.popup.suggest.submit
//= require_ml widget.flatquestion.popup.suggest.submit.name

(function (a) {
  return a;
})();

(function () {
  'use strict';

  /**
   * <div lj-widget-question-of-the-day></div>
   */

  angular.module('LJ.Widget.QuestionOfTheDay', ['LJ.Templates', 'LJ.Directives', 'LJ.Api', 'LJ.User', 'LJ.Widget.AnswerForTheQuestionOfTheDay']).factory('Questions', ['$q', 'Api', 'Users', function ($q, Api, Users) {
    var questions = [],
        state = {
      initialized: false,
      allFetched: false,
      isEndOfList: false
    },
        factory = {
      fetch: fetch,
      get: get,
      state: state,
      isEndOfList: isEndOfList
    },
        offset = 0,
        QUESTIONS_TO_FETCH = 5,
        COUNTRY = LJ.get('country'),
        USER_TYPE = LJ.get('remote') ? LJ.get('remote.account_type') : 'logged_out';


    function get() {
      return questions;
    }

    function fetch() {
      var defer;

      if (state.allFetched) {
        defer = $q.defer();
        defer.resolve(questions);
        return defer.promise;
      }

      return Api.call('writers_block.get_list', {
        offset: offset,
        limit: QUESTIONS_TO_FETCH,
        user_type: USER_TYPE,
        country: COUNTRY
      }).then(function (response) {
        state.isEndOfList = !response.questions.length;
        questions = questions.concat(response.questions);
        Users.Cache.add(questions.map(LJ.Function.get('author')));
        state.allFetched = questions.length < QUESTIONS_TO_FETCH;
        offset += questions.length;
      });
    }

    function isEndOfList() {
      return state.isEndOfList;
    }

    return factory;
  }]).factory('Suggest', ['Api', function (Api) {
    var factory = {};

    factory.send = function (suggest) {
      return Api.call('writers_block.suggest', suggest);
    };

    factory.check = function () {
      return Api.call('writers_block.check_user');
    };

    factory.validate = function (suggest) {
      if (!suggest.subject || suggest.subject.length === 0) {
        return false;
      }

      if (!suggest.body || suggest.body.length === 0) {
        return false;
      }

      return true;
    };

    return factory;
  }]).directive('ljWidgetQuestionOfTheDay', ['Questions', function (Questions) {
    return {
      restrict: 'A',
      templateUrl: 'flatquestion.ng.tmpl',
      controllerAs: 'widget',
      controller: ['$scope', function ($scope) {
        var that = this,
            $body = angular.element('body');


        this.siteroot = LJ.get('siteroot');
        this.writersBlockCommunity = LJ.get('writers_block_community');

        this.state = {
          suggest: false,
          reply: false,
          error: false,
          loading: false,
          initialized: false
        };

        this.questions = [];

        /**
         * Notice: question are stored from newest to oldest;
         * question with index `0` - newest
         * That is why prev question is current + 1
         */
        this.currentQuestionIndex = 0;
        this.currentQuestion = null;

        // next question
        this.next = function () {
          this.currentQuestionIndex -= 1;
        };

        // prev question
        this.prev = function () {
          this.currentQuestionIndex += 1;
        };

        this.showSuggestion = function (event) {
          if (!(event.metaKey || event.ctrlKey) && LJ.get('remote')) {
            event.preventDefault();
            that.state.suggest = true;
          }
        };

        $scope.$watch(function () {
          return that.currentQuestionIndex;
        }, function (index) {
          if (that.questions.length === 0) {
            return;
          }

          // check boundaries
          if (index < 0) {
            index = 0;
          }

          if (index === that.questions.length) {
            index -= 1;
          }

          // fetch prev questions when last question is on the screen
          if (index === that.questions.length - 1 && !Questions.isEndOfList()) {
            that.state.loading = true;

            Questions.fetch().then(function () {
              that.state.loading = false;
            });
          }

          that.currentQuestion = that.questions[index];
          that.currentQuestionIndex = index;
        });

        $body.on('keydown', function (event) {
          if (event.which === 27) {
            that.state.suggest = false;
            that.state.reply = false;
          }
        });

        $scope.$watchCollection(Questions.get, function (questions) {
          that.questions = questions;
          that.currentQuestion = questions[that.currentQuestionIndex];
        });

        $scope.$watch(function () {
          return that.state.suggest + that.state.reply;
        }, function () {
          $body.toggleClass('p-flatquestion-reply', that.state.reply);
          $body.toggleClass('p-flatquestion-suggest', that.state.suggest);
        });

        Questions.fetch().then(function () {
          that.state.initialized = true;
        });
      }]
    };
  }]).controller('QuestionPageCtrl', [function () {
    // this.newAnswer = function() {
    //
    // };
  }]).controller('QuestionSuggestCtrl', ['Suggest', function (Suggest) {
    var that = this,
        defaults = {
      subject: null,
      body: null,
      show_name: false
    };

    this.state = {
      sending: false,
      success: false,
      blocked: false
    };

    this.send = function () {
      that.state.sending = true;
      Suggest.send(that.question).then(function () {
        that.state.sending = false;
        that.state.success = true;
      });
    };

    this.isDisabled = function () {
      return !Suggest.validate(that.question);
    };

    this.check = function () {
      that.state.sending = true;
      Suggest.check().then(function (response) {
        that.state.blocked = response.status !== 'OK';
        that.blockedReason = response.reason;
        that.state.sending = false;
      });
    };

    this.reset = function () {
      this.state.success = false;
      this.question = angular.extend({}, defaults);
      this.check();
    };

    this.reset();
    this.check();
  }]);
})();
/* <<< file end: js/widgets/angular/questionOfTheDay.js */

//# map link was there [questionOfTheDay.js.map]
/* >>> file start: js/lib/jquery.selectric.min.js */
/*! Selectric ϟ v1.8.6 (2014-10-14) - git.io/tjl9sQ - Copyright (c) 2014 Leonardo Santos - Dual licensed: MIT/GPL */
!function (e) {
  "use strict";
  var t = "selectric",
      s = "Input Items Open Disabled TempShow HideSelect Wrapper Hover Responsive Above Scroll",
      o = ".sl",
      i = { onChange: function onChange(t) {
      e(t).change();
    }, maxHeight: 300, keySearchTimeout: 500, arrowButtonMarkup: '<b class="button">&#x25be;</b>', disableOnMobile: !0, openOnHover: !1, expandToItemText: !1, responsive: !1, preventWindowScroll: !0, inheritOriginalWidth: !1, customClass: { prefix: t, postfixes: s, camelCase: !0, overwrite: !0 }, optionsItemBuilder: "{text}" },
      n = { add: function add(e, t, s) {
      this[e] || (this[e] = {}), this[e][t] = s;
    }, remove: function remove(e, t) {
      delete this[e][t];
    } },
      a = { replaceDiacritics: function replaceDiacritics(e) {
      for (var t = "40-46 50-53 54-57 62-70 71-74 61 47 77".replace(/\d+/g, "\\3$&").split(" "), s = t.length; s--;) {
        e = e.toLowerCase().replace(RegExp("[" + t[s] + "]", "g"), "aeiouncy".charAt(s));
      }return e;
    }, format: function format(e) {
      var t = arguments;return ("" + e).replace(/{(\d+|(\w+))}/g, function (e, s, o) {
        return o && t[1] ? t[1][o] : t[s];
      });
    }, nextEnabledItem: function nextEnabledItem(e, t) {
      for (; e[t = (t + 1) % e.length].disabled;) {}return t;
    }, previousEnabledItem: function previousEnabledItem(e, t) {
      for (; e[t = (t > 0 ? t : e.length) - 1].disabled;) {}return t;
    }, toDash: function toDash(e) {
      return e.replace(/([a-z])([A-Z])/g, "$1-$2").toLowerCase();
    }, triggerCallback: function triggerCallback(s, o) {
      var i = o.element,
          l = o.options["on" + s];e.isFunction(l) && l.call(i, i, o), n[s] && e.each(n[s], function () {
        this.call(i, i, o);
      }), e(i).trigger(t + "-" + a.toDash(s), o);
    } },
      l = e(document),
      r = e(window),
      c = function c(n, _c) {
    function d(t) {
      if ($.options = e.extend(!0, {}, i, $.options, t), $.classes = {}, $.element = n, a.triggerCallback("BeforeInit", $), $.options.disableOnMobile && L) return void ($.disableOnMobile = !0);C(!0);var o = $.options.customClass,
          l = o.postfixes.split(" "),
          r = R.width();e.each(s.split(" "), function (e, t) {
        var s = o.prefix + l[e];$.classes[t.toLowerCase()] = o.camelCase ? s : a.toDash(s);
      }), x = e("<input/>", { "class": $.classes.input, readonly: L }), k = e("<div/>", { "class": $.classes.items, tabindex: -1 }), T = e("<div/>", { "class": $.classes.scroll }), D = e("<div/>", { "class": o.prefix, html: $.options.arrowButtonMarkup }), y = e('<p class="label"/>'), I = R.wrap("<div>").parent().append(D.prepend(y), k, x), A = { open: v, close: g, destroy: C, refresh: u, init: d }, R.on(A).wrap('<div class="' + $.classes.hideselect + '">'), e.extend($, A), $.options.inheritOriginalWidth && r > 0 && I.width(r), p();
    }function p() {
      $.items = [];var t = R.children(),
          s = "<ul>",
          i = t.filter(":selected").index();H = S = ~i ? i : 0, (E = t.length) && (t.each(function (t) {
        var o = e(this),
            i = o.html(),
            n = o.prop("disabled"),
            l = $.options.optionsItemBuilder;$.items[t] = { value: o.val(), text: i, slug: a.replaceDiacritics(i), disabled: n }, s += a.format('<li class="{1}">{2}</li>', e.trim([t == H ? "selected" : "", t == E - 1 ? "last" : "", n ? "disabled" : ""].join(" ")), e.isFunction(l) ? l($.items[t], o, t) : a.format(l, $.items[t]));
      }), k.append(T.html(s + "</ul>")), y.html($.items[H].text)), D.add(R).add(I).add(x).off(o), I.prop("class", [$.classes.wrapper, $.options.customClass.overwrite ? R.prop("class").replace(/\S+/g, $.options.customClass.prefix + "-$&") : R.prop("class"), $.options.responsive ? $.classes.responsive : ""].join(" ")), R.prop("disabled") ? (I.addClass($.classes.disabled), x.prop("disabled", !0)) : (j = !0, I.removeClass($.classes.disabled).on("mouseenter" + o + " mouseleave" + o, function (t) {
        e(this).toggleClass($.classes.hover), $.options.openOnHover && (clearTimeout($.closeTimer), "mouseleave" == t.type ? $.closeTimer = setTimeout(g, 500) : v());
      }), D.on("click" + o, function (e) {
        Y ? g() : v(e);
      }), x.prop({ tabindex: q, disabled: !1 }).on("keypress" + o, h).on("keydown" + o, function (e) {
        h(e), clearTimeout($.resetStr), $.resetStr = setTimeout(function () {
          x.val("");
        }, $.options.keySearchTimeout);var t = e.keyCode || e.which;t > 36 && 41 > t && b(a[(39 > t ? "previous" : "next") + "EnabledItem"]($.items, S));
      }).on("focusin" + o, function (e) {
        x.one("blur", function () {
          x.blur();
        }), Y || v(e);
      }).on("oninput" in x[0] ? "input" : "keyup", function () {
        x.val().length && e.each($.items, function (e, t) {
          return RegExp("^" + x.val(), "i").test(t.slug) && !t.disabled ? (b(e), !1) : void 0;
        });
      }), R.prop("tabindex", !1), O = e("li", k.removeAttr("style")).click(function () {
        return b(e(this).index(), !0), !1;
      })), a.triggerCallback("Init", $);
    }function u() {
      a.triggerCallback("Refresh", $), p();
    }function h(e) {
      var t = e.keyCode || e.which;13 == t && e.preventDefault(), /^(9|13|27)$/.test(t) && (e.stopPropagation(), b(S, !0));
    }function f() {
      var e = k.closest(":visible").children(":hidden"),
          t = $.options.maxHeight;e.addClass($.classes.tempshow);var s = k.outerWidth(),
          o = D.outerWidth() - (s - k.width());!$.options.expandToItemText || o > s ? W = o : (k.css("overflow", "scroll"), I.width(9e4), W = k.width(), k.css("overflow", ""), I.width("")), k.width(W).height() > t && k.height(t), e.removeClass($.classes.tempshow);
    }function v(s) {
      a.triggerCallback("BeforeOpen", $), s && (s.preventDefault(), s.stopPropagation()), j && (f(), e("." + $.classes.hideselect, "." + $.classes.open).children()[t]("close"), Y = !0, B = k.outerHeight(), M = k.height(), x.val("").is(":focus") || x.focus(), l.on("click" + o, g).on("scroll" + o, m), m(), $.options.preventWindowScroll && l.on("mousewheel" + o + " DOMMouseScroll" + o, "." + $.classes.scroll, function (t) {
        var s = t.originalEvent,
            o = e(this).scrollTop(),
            i = 0;"detail" in s && (i = -1 * s.detail), "wheelDelta" in s && (i = s.wheelDelta), "wheelDeltaY" in s && (i = s.wheelDeltaY), "deltaY" in s && (i = -1 * s.deltaY), (o == this.scrollHeight - M && 0 > i || 0 == o && i > 0) && t.preventDefault();
      }), I.addClass($.classes.open), w(S), a.triggerCallback("Open", $));
    }function m() {
      f(), I.toggleClass($.classes.above, I.offset().top + I.outerHeight() + B > r.scrollTop() + r.height());
    }function g() {
      if (a.triggerCallback("BeforeClose", $), H != S) {
        a.triggerCallback("BeforeChange", $);var e = $.items[S].text;R.prop("selectedIndex", H = S).data("value", e), y.html(e), a.triggerCallback("Change", $);
      }l.off(o), I.removeClass($.classes.open), Y = !1, a.triggerCallback("Close", $);
    }function b(e, t) {
      $.items[e].disabled || (O.removeClass("selected").eq(S = e).addClass("selected"), w(e), t && g());
    }function w(e) {
      var t = O.eq(e).outerHeight(),
          s = O[e].offsetTop,
          o = T.scrollTop(),
          i = s + 2 * t;T.scrollTop(i > o + B ? i - B : o > s - t ? s - t : o);
    }function C(e) {
      j && (k.add(D).add(x).remove(), !e && R.removeData(t).removeData("value"), R.prop("tabindex", q).off(o).off(A).unwrap().unwrap(), j = !1);
    }var x,
        k,
        T,
        D,
        y,
        I,
        O,
        S,
        H,
        B,
        M,
        W,
        E,
        A,
        $ = this,
        R = e(n),
        Y = !1,
        j = !1,
        L = /android|ip(hone|od|ad)/i.test(navigator.userAgent),
        q = R.prop("tabindex");d(_c);
  };e.fn[t] = function (s) {
    return this.each(function () {
      var o = e.data(this, t);o && !o.disableOnMobile ? "" + s === s && o[s] ? o[s]() : o.init(s) : e.data(this, t, new c(this, s));
    });
  }, e.fn[t].hooks = n;
}(jQuery);
/* <<< file end: js/lib/jquery.selectric.min.js */

//# map link was there [jquery.selectric.min.js.map]
/* >>> file start: js/core/angular/ljSelectric.js */
//= require js/lib/jquery.selectric.min.js

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Selectric', [])

  /**
   * Directive that helps to create custom select elements using selectric widget
   *
   * Notice:
   *   It's not possible to obtain ng-options change at the moment,
   *   that is why we need to provide items for `lj-selectric`
   *
   * See issue:
   *   https://github.com/angular/angular.js/issues/2903
   *
   * Usage:
   *   <select
   *     ng-options="label for value in items"
   *     lj-selectric="items"
   *     lj-selectric-max-height="200"
   *     >
   *   </select>
   *
   * Params can be set by attributes 'lj-selectric-param',
   * ex. lj-selectric-open-on-hover='true'
   */
  .directive('ljSelectric', ['$parse', '$timeout', function ($parse, $timeout) {
    return {
      require: '?ngModel',
      scope: true,
      link: function link($scope, element, attrs, ngModel) {
        var getOptions = $parse(attrs.ljSelectric),
            update,
            initParams;

        update = LJ.Function.debounce(function () {

          // timeout is needed to let angular update DOM
          $timeout(function () {
            element.selectric('refresh');
          });
        }, 50);

        // update selectric on options change
        if (attrs.ljSelectric) {
          $scope.$watchCollection(getOptions, update);
        }

        // update selectric on model value change
        if (ngModel) {
          $scope.$watch(function () {
            return ngModel.$modelValue;
          }, update);
        }

        // selectric initialization params (is copied from schemius.js)
        initParams = {
          customClass: {
            prefix: 'b-selectus',
            postfixes: 'Input Items Open Disabled TempShow HideSelect Wrapper Hover Responsive Above Scroll',
            camelCase: false,
            overwrite: false
          },
          disableOnMobile: false
        };

        // selectric params set by attributes
        for (var attr in attrs) {
          if (attrs.hasOwnProperty(attr) && /ljSelectric\w+/.test(attr)) {
            var param = attr.replace('ljSelectric', '');

            // put first letter to lower case
            param = param.charAt(0).toLowerCase() + param.slice(1);

            initParams[param] = attrs[attr];
          }
        }

        element.selectric(initParams);

        $scope.$on('$destroy', function () {
          element.selectric('destroy');
        });
      }
    };
  }]);
})();
/* <<< file end: js/core/angular/ljSelectric.js */

//# map link was there [ljSelectric.js.map]
/* >>> file start: js/core/angular/ljYandexContext.js */
/*global Ya*/
angular.module('LJ.YandexContext', []).factory('YandexContext', function () {
  function init() {
    window['yandex_context_callbacks'] = window['yandex_context_callbacks'] || [];
    return LJ.injectScript('//an.yandex.ru/system/context.js');
  }

  function getContext(type) {
    return LJ.get('yandex_context')[type];
  }

  function addAdBlock(elementId, type) {
    return init().then(function () {
      var context = getContext(type);
      Ya.Direct.insertInto(context.id, elementId, context);
    });
  }

  return {
    init: init,
    getContext: getContext,
    addAdBlock: addAdBlock
  };
}).directive('ljYandexContext', ['YandexContext', function (YandexContext) {
  return {
    scope: {
      type: '@ljYandexContext'
    },
    link: function link($scope, $element) {
      var id = Date.now(),
          contextBlock = $element.parent();


      if (!YandexContext.getContext($scope.type) && contextBlock.hasClass('yadirect')) {
        contextBlock.hide();
        return;
      }

      $element.prepend('<div id="' + id + '"/>');
      YandexContext.addAdBlock(id, $scope.type);
    }
  };
}])
// replace document.write to render ads after DOM load.
.directive('ljRamblerAds', function () {
  return {
    link: function link($scope, $element) {
      var id = Date.now(),
          bannerCode = LJ.get('page.ramblerNews');


      $element.append('<div id="' + id + '"/>');
      $element.append(bannerCode.replace(/document.write\(([^\)]+)\)/g, 'document.getElementById(' + id + ').innerHTML += $1'));
    }
  };
});
/* <<< file end: js/core/angular/ljYandexContext.js */

//# map link was there [ljYandexContext.js.map]
/* >>> file start: js/jquery/jquery.lj.inlineCalendar.js */
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/*!
 * LiveJournal Inline calendar
 *
 * Copyright 2011, dmitry.petrov@sup.com
 *
 * http://docs.jquery.com/UI
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *
 * @overview Inline calendar widget.
 *
 * Widget can be attached to any existant markup.
 *
 * Date wildcards used:
 *  - %D - day ( 01 - 31 )
 *  - %M - month ( 01 - 02 )
 *  - %Y - year ( yyyy, e.g. 2002 )
 *  - %s - unix timestamp in ms
 *
 * Options:
 *  - dayRef: Format of the url that will be attached to each day in the calendar.
 *  - allRefs: Wether to attach links to days in the calendar.
 *    and override currentDate on success.
 *    Could be: true/false/Object {from: Date, to: Date} (all fields are not required)
 *  - activeFrom: Days before this will be inactive in calendar.
 *  - actoveUntil: Days after this willbe inactive incalendar.
 *  - startMonth: Widget will not allow to switch calendar pane to the month before this.
 *  - endMonth: Widget will not allow to switch calendar pane to the month after this.
 *  - startAtSunday: Wether to count sunday as the start of the week.
 *  - events: Object, containing events to show in the calendar. They will be rendered as links. Structure of the object:
 *    { "yyyy": { "mm1" : [ d1, d2, d3, d4 ], "mm2": [ d5, d6, d7 ] } }
 *
 *  Events:
 *  - daySelected: Event is triggered when user selects a day in the calendar. The second parameter passed to the
 *  function is a Date object.
 *  - dateChange Event is triggered when user click on next or prev month/year button.
 *  - currentDateChange: Events is triggered when a new date is set in calendar as current.
 *
 *  Consistent options ( setting these options is guaranteed to work correctly ):
 *  - currentDate, date - Set/get current date.
 *  - activeFrom, date - Set/get earliest active date.
 *  - activeUntil, date - Set/get last active date.
 *  - title, title - set calendar title.
 *  - events, obj - override current events object
 *
 *  @TODO: move all service functions to the widget object and merge it with the view.
 *
 */

(function ($) {

  var defaultOptions = {
    dayRef: '/%Y/%M/%D',
    monthRef: '', //the same, but for the months and year. Calendar will render link, if options are set
    yearRef: '',
    allRefs: false,
    currentDate: new Date(),
    //allow user to select dates in this range
    activeUntil: null,
    activeFrom: null,
    //allow user to switch months between these dates
    startMonth: new Date(1900, 0, 1),
    endMonth: new Date(2050, 0, 1),
    startAtSunday: LJ.ml('date.format.offset') === '0' || false,
    dateFormat: '%Y-%M-%D',
    defaultTitle: 'Calendar',
    longMonth: false,

    events: null, //object with events to show in the calendar
    displayedMonth: null, //month displayed on the calendar. If not specified at
    //startup currentDate is used instead.
    dateChange: null,

    selectors: {
      table: 'table',
      title: 'h5',
      tbody: 'tbody',

      month: '.cal-nav-month',
      year: '.cal-nav-year',
      monthSelect: '.cal-nav-month-select',
      yearSelect: '.cal-nav-year-select',

      prevMonth: '.cal-nav-month .cal-nav-prev',
      nextMonth: '.cal-nav-month .cal-nav-next',
      prevYear: '.cal-nav-year .cal-nav-prev',
      nextYear: '.cal-nav-year .cal-nav-next',

      monthLabel: '.cal-nav-month .cal-month',
      yearLabel: '.cal-nav-year .cal-year'
    },

    classNames: {
      container: '',
      inactive: 'other',
      future: 'other',
      current: 'current',
      weekend: 'weekend',
      nextDisabled: 'cal-nav-next-dis',
      prevDisabled: 'cal-nav-prev-dis',
      cellHover: 'hover',
      longMonth: 'sidebar-cal-longmonth'
    },

    //now, all lang variables are collected from Site.ml_text and should not be modified
    mlPrefix: {
      monthNamesShort: ['monthNames', 'date.month.{name}.short'],
      monthNamesLong: ['monthNames', 'date.month.{name}.long'],
      dayNamesShort: ['dayNames', 'date.day.{name}.short']
    },

    ml: {
      monthNames: ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'],
      dayNames: ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'],
      caption: 'Calendar'
    }
  };

  function getDateNumber(d, dropDays) {
    dropDays = dropDays || false;
    var day = d.getDate().toString();
    if (day.length === 1) {
      day = '0' + day;
    }
    if (dropDays) {
      day = '';
    }

    var month = d.getMonth().toString();
    if (month.length === 1) {
      month = '0' + month;
    }

    return parseInt(d.getFullYear().toString() + month + day, 10);
  }

  function insideTimeRange(range, iDate) {
    return getDateNumber(iDate, true) >= getDateNumber(range[0], true) && getDateNumber(iDate, true) <= getDateNumber(range[1], true);
  }

  function View(nodes, styles, o) {
    this.initialize = function (date) {
      this.tbody = this.catchTableStructure(date);
    };

    this.modelChanged = function (monthDate, events, switcherStates) {
      var monthml = o.longMonth ? o.ml.monthNamesLong : o.ml.monthNamesShort;
      //we have a 30% speedup when we temporary remove tbody from dom
      this.tbody.detach();
      this.fillDates(monthDate, events);

      for (var sws in switcherStates) {
        if (switcherStates.hasOwnProperty(sws)) {
          nodes[sws][!switcherStates[sws] ? 'addClass' : 'removeClass'](this.disabledStyle(sws));
        }
      }

      var monthText = o.monthRef ? $('<a>', {
        href: LJ.Util.Date.format(monthDate, o.monthRef),
        text: monthml[monthDate.getMonth()] + (o.monthWithYear ? ' ' + monthDate.getFullYear() : '')
      }) : monthml[monthDate.getMonth()],
          yearText = o.yearRef ? $('<a>', { href: LJ.Util.Date.format(monthDate, o.yearRef), text: monthDate.getFullYear() }) : monthDate.getFullYear();

      nodes.monthLabel.empty().append(monthText);
      nodes.yearLabel.empty().append(yearText);

      this.tbody.appendTo(nodes.table);
    };

    this.catchTableStructure = function (date) {
      var tbody = nodes.tbody[0];
      nodes.daysCells = [];
      nodes.daysSpans = [];

      var row,
          rowsCount = tbody.rows.length,
          cell,
          cellsCount,
          toAdd = 6 - rowsCount,
          rowStr = '<tr>';

      for (var i = 0; i < 7; ++i) {
        rowStr += '<td><span></span></td>';
      }
      rowStr += '</tr>';

      while (toAdd-- > 0) {
        //add missing rows if server has rendered not enough markup
        $(rowStr).hide().appendTo(nodes.tbody);
      }
      rowsCount = 6;
      nodes.lastRow = jQuery(tbody.rows[tbody.rows.length - 1]);
      date = new Date(date);

      for (row = 0; row < rowsCount; ++row) {
        for (cell = 0, cellsCount = tbody.rows[row].cells.length; cell < cellsCount; ++cell) {
          // take into account span inside td
          var node = jQuery(tbody.rows[row].cells[cell]),
              children = node.children(),
              day = children.text().trim();

          if (day) {
            date.setDate(day);
            node.data('isActive', true);
            node.data('day', date);
          }

          nodes.daysCells.push(node);
          nodes.daysSpans.push(children);
        }
      }

      return jQuery(tbody);
    };

    this.fillDates = function (monthDate, events) {
      function hasEvents(date) {
        var year = date.getFullYear(),
            month = date.getMonth(),
            day = date.getDate();

        return events && events[year] && events[year][month] && events[year][month][day];
      }

      var d = new Date(monthDate);
      d.setDate(1);

      var offset;
      if (o.startAtSunday) {
        offset = d.getDay();
      } else {
        offset = d.getDay() === 0 ? 6 : d.getDay() - 1;
      }
      d.setDate(1 - offset);

      for (var i = 0, l = nodes.daysCells.length; i < l; ++i) {
        var cell = nodes.daysCells[i],
            span = nodes.daysSpans[i];

        this.formDayString(d, cell, span, hasEvents(d), this.isActiveDate(d, monthDate));

        d.setDate(d.getDate() + 1);
      }

      d.setDate(d.getDate() - 1); //get the date from the last cell
      //we do not use show and hide methods, because show method sets display: block;
      if (d.getDate() < 7) {
        nodes.lastRow.css('display', '');
      } else {
        nodes.lastRow.css('display', 'none');
      }
    };

    this.isActiveDate = function (date, currentMonth) {
      var isActive = true;

      isActive = currentMonth.getFullYear() === date.getFullYear() && currentMonth.getMonth() === date.getMonth();

      if (isActive && (o.activeFrom || o.activeUntil)) {
        isActive = o.activeFrom && getDateNumber(o.activeFrom) <= getDateNumber(date) || o.activeUntil && getDateNumber(o.activeUntil) >= getDateNumber(date);
      }

      return isActive;
    };

    this.formDayString = function (d, cell, span, hasEvents, isActive) {
      d = new Date(d);
      var isCurrentDay = getDateNumber(d) === getDateNumber(o.currentDate);

      cell.data('day', d);
      cell.data('isActive', isActive);
      cell.data('hasEvents', hasEvents);

      cell[isCurrentDay ? 'addClass' : 'removeClass'](styles.current);
      cell.removeClass(styles.cellHover);

      if (!isActive) {
        cell.addClass(styles.inactive);
        span.html(d.getDate());
      } else if (hasEvents || o.allRefs) {

        var _tmpAllRefs = true;
        if (o.allRefs && _typeof(o.allRefs) === 'object') {
          if (o.allRefs.from && d < o.allRefs.from) {
            _tmpAllRefs = false;
          }

          if (o.allRefs.to && d > o.allRefs.to) {
            _tmpAllRefs = false;
          }
        }

        if (_tmpAllRefs) {
          cell.removeClass(styles.inactive);
          span.html($('<a />', {
            html: d.getDate(),
            href: LJ.Util.Date.format(d, o.dayRef),
            target: '_self'
          }));
        } else {
          cell.removeClass(styles.inactive);
          span.html(d.getDate());
        }
      } else {
        cell.removeClass(styles.inactive);
        span.html(d.getDate());
      }
    };

    this.disabledStyle = function (sws) {
      if (sws === 'prevMonth' || sws === 'prevYear') {
        return styles.prevDisabled;
      } else {
        return styles.nextDisabled;
      }
    };
  }

  var Calendar = {
    options: {}, //all options were move to the default options object

    _create: function _create() {
      this._preInit();
      this._initialize();
      this._postInit();
    },

    _preInit: function _preInit() {
      var def = $[this.namespace][this.widgetName].getDefaults();
      this.options = jQuery.extend(true, {}, def, this.options);
      this._prepareMLVars();
    },

    _prepareMLVars: function _prepareMLVars() {
      var expandVar = function expandVar(prefix, name) {
        return LJ.ml(prefix.supplant({ name: name }));
      },
          prefixData;

      for (var prefix in this.options.mlPrefix) {
        if (this.options.mlPrefix.hasOwnProperty(prefix)) {
          prefixData = this.options.mlPrefix[prefix];
          this.options.ml[prefix] = this.options.ml[prefixData[0]].map(expandVar.bind(null, prefixData[1]));
        }
      }
    },

    // @TODO: need to change the structure of initialization code to remove this method
    _initialize: function _initialize() {
      if (!this.options.displayedMonth) {
        this.options.displayedMonth = new Date(this.options.currentDate);
      }

      this._events = this.options.events;
      this._hideTimer = null;
      this._nodes = this._nodes || { container: this.element, root: this.element };
      this._invalidateTimer = null;

      if (this.element.hasClass(this.options.classNames.longMonth)) {
        this.options.longMonth = true;
      }

      this._bindNodes();

      this.options.startMonth.setDate(1);

      this._view = new (this._getView())(this._nodes, this.options.classNames, this.options);
      this._view.initialize(this.options.currentDate);

      if (this._nodes.table.hasClass('monday')) {
        this._setOption('startAtSunday', false);
      }

      this._nodes.monthSelect.val(this.options.displayedMonth.getMonth());
      this._nodes.yearSelect.val(this.options.displayedMonth.getFullYear());

      this._bindEvents();
    },

    _postInit: function _postInit() {},

    _getView: function _getView() {
      return View;
    },

    _bindNodes: function _bindNodes() {
      for (var i in this.options.selectors) {
        if (this.options.selectors.hasOwnProperty(i) && !(i in this._nodes)) {
          this._nodes[i] = this._nodes.container.find(this.options.selectors[i]);
        }
      }

      var displayedMonth = LJ.Util.Date.parse(this._nodes.table.attr('data-date'), this.options.dateFormat);
      if (displayedMonth) {
        this.options.displayedMonth = displayedMonth;
      }
    },

    destroy: function destroy() {
      $.Widget.prototype.destroy.apply(this, arguments);
    },

    _bindEvents: function _bindEvents() {
      var self = this,
          switcherStates = this._getSwitcherStates(this.options.currentDate),
          switcherMouseDown = function switcherMouseDown(item) {
        return function (ev) {
          ev.preventDefault();
          ev.stopPropagation();
          var switcherStates = self._getSwitcherStates(self.options.currentDate);

          if (switcherStates[item]) {
            self['_' + item]();
          }
        };
      };

      for (var sws in switcherStates) {
        if (switcherStates.hasOwnProperty(sws)) {
          this._nodes[sws].click(switcherMouseDown(sws));
        }
      }

      this._nodes.monthSelect.change(function () {
        var d = new Date(self.options.currentDate);
        d.setMonth(this.value);
        self._setOption('currentDate', d);
      });

      this._nodes.yearSelect.change(function () {
        var d = new Date(self.options.currentDate);
        d.setFullYear(this.value);
        self._setOption('currentDate', d);
      });

      this._nodes.tbody.delegate('td', 'click', function (ev) {
        self._cellSelectedEvent($(this), ev);
      });
    },

    _switchMonth: function _switchMonth(go) {
      var event = jQuery.Event('dateChange');
      event.moveForward = go > 0;
      event.switchType = Math.abs(go) === 12 ? 'year' : Math.abs(go) === 1 ? 'month' : null;

      event.date = new Date(this.options.displayedMonth.getFullYear(), this.options.displayedMonth.getMonth() + go, 1);

      this._nodes.root.trigger(event);
      this._setOption('displayedMonth', event.date);
    },

    _prevMonth: function _prevMonth() {
      this._switchMonth(-1);
    },
    _nextMonth: function _nextMonth() {
      this._switchMonth(1);
    },

    _prevYear: function _prevYear() {
      this._switchMonth(-12);
    },
    _nextYear: function _nextYear() {
      this._switchMonth(12);
    },

    _cellSelectedEvent: function _cellSelectedEvent(cell, ev) {
      //if cell is inactive or user controls it's behavior we do not pass event to the link
      if (!cell.data('isActive') || this._cellSelected(cell.data('day'))) {
        ev.stopPropagation();
        ev.preventDefault();
      }
    },

    /**
     * @return {Boolean} returns true if user prevents default behaviour
     */
    _cellSelected: function _cellSelected(date) {
      var event = jQuery.Event('daySelected');
      this._nodes.root.trigger(event, [date, LJ.Util.Date.format(date, this.options.dateFormat)]);

      if (!event.isDefaultPrevented()) {
        this._setOption('currentDate', date);
      }

      return !event.isDefaultPrevented();
    },

    _fitDate: function _fitDate(date) {
      date = new Date(date);
      var enabledMonthsRange = [this.options.startMonth, this.options.endMonth];

      if (!insideTimeRange(enabledMonthsRange, date)) {
        if (getDateNumber(date, true) < getDateNumber(enabledMonthsRange[0], true)) {
          date = new Date(enabledMonthsRange[0]);
        } else {
          date = new Date(enabledMonthsRange[1]);
        }
      }

      return date;
    },

    _getSwitcherStates: function _getSwitcherStates() {
      var monthDate = this.options.displayedMonth,
          yearStart = new Date(monthDate.getFullYear(), 0, 1),
          yearEnd = new Date(monthDate.getFullYear(), 11, 1);

      return {
        prevMonth: this._isActivePrev(monthDate) !== false,
        prevYear: this._isActivePrev(yearStart) !== false,
        nextMonth: this._isActiveNext(monthDate) !== false,
        nextYear: this._isActiveNext(yearEnd) !== false
      };
    },

    _isActiveNext: function _isActiveNext(date) {
      return this._isActiveDate(date, 1);
    },
    _isActivePrev: function _isActivePrev(date) {
      return this._isActiveDate(date, -1);
    },
    _isActiveDate: function _isActiveDate(date, dir) {
      var d = new Date(date);
      d.setMonth(d.getMonth() + dir);
      d.setDate(1);

      return insideTimeRange([this.options.startMonth, this.options.endMonth], d);
    },

    _invalidateDisplay: function _invalidateDisplay() {
      var self = this;
      clearTimeout(this._invalidateTimer);

      setTimeout(function () {
        self._view.modelChanged(self.options.displayedMonth, self._events, self._getSwitcherStates());
      }, 50);
    },

    _setOption: function _setOption(name, value) {
      switch (name) {
        case 'currentDate':
          this.options.currentDate = this._fitDate(value);

          var event = jQuery.Event('currentDateChange'),
              date = new Date(this.options.currentDate);
          this._nodes.root.trigger(event, [date, LJ.Util.Date.format(date, this.options.dateFormat)]);

          this._setOption('displayedMonth', value);
          this._invalidateDisplay();
          break;
        case 'activeFrom':
          this.options.activeFrom = new Date(value);
          this._invalidateDisplay();
          break;
        case 'activeUntil':
          this.options.activeUntil = new Date(value);
          this._invalidateDisplay();
          break;
        case 'title':
          this._title = value;
          this._nodes.title.html(value);
          break;
        case 'events':
          this._events = value;
          this._invalidateDisplay();
          break;
        case 'displayedMonth':
          var newDate = this._fitDate(new Date(value)),
              isCurrentMonth = getDateNumber(newDate, true) === getDateNumber(this.options.displayedMonth, true);

          if (!isCurrentMonth) {
            this.options.displayedMonth = this._fitDate(new Date(value));
            this._nodes.monthSelect.val(this.options.displayedMonth.getMonth());
            this._nodes.yearSelect.val(this.options.displayedMonth.getFullYear());
            this._invalidateDisplay();
          }

          break;
        case 'startMonth':
          this.options.startMonth = new Date(value);
          this._invalidateDisplay();
          break;
        case 'endMonth':
          this.options.endMonth = new Date(value);
          this._invalidateDisplay();
          break;
        case 'startAtSunday':
          this.options.startAtSunday = !!value;
          break;
        case 'monthWithYear':
          this.options.monthWithYear = Boolean(value);
          break;
        case 'dayRef':
          this.options.dayRef = value;
          this._invalidateDisplay();
          break;
      }
    },

    getElement: function getElement(name) {
      if (name in this._nodes) {
        return this._nodes[name];
      } else {
        return null;
      }
    }

  };

  $.widget('lj.inlineCalendar', Calendar);

  jQuery.extend($.lj.inlineCalendar, {

    getDefaults: function getDefaults() {
      return defaultOptions;
    },

    setDefaults: function setDefaults(opts) {
      if (opts) {
        jQuery.extend(true, defaultOptions, opts);
      }
    }
  });
})(jQuery);
/* <<< file end: js/jquery/jquery.lj.inlineCalendar.js */

//# map link was there [jquery.lj.inlineCalendar.js.map]
/* >>> file start: js/jquery/jquery.lj.normalizedCalendar.js */
//= require js/jquery/jquery.lj.inlineCalendar.js

/*
 * LiveJournal Calendar
 * normalized for usage with DOM directly as $(element).normalizedCalendar( options )
 *
 * @author Valeriy Vasin (valeriy.vasin@sup.com)
 * @requires jquery.ui.core.js, jquery.ui.widget.js, jquery.lj.inlineCalendar.js
 *
 * Date wildcards used:
 *  - %D - day ( 01 - 31 )
 *  - %M - month ( 01 - 02 )
 *  - %Y - year ( yyyy, e.g. 2002 )
 *  - %s - unix timestamp in ms
 *
 * Options:
 *  - dayRef: Format of the url that will be attached to each day in the calendar.
 *  - allRefs: Wether to attach links to days in the calendar.
 *  - currentDate:  initialy selected date.
 *  - activeFrom: Days before this will be inactive in calendar.
 *  - activeUntil: Days after this willbe inactive incalendar.
 *  - startMonth: Widget will not allow to switch calendar pane to the month before this.
 *    Actually it's a Date object, from which widget brings correct month and year.
 *  - endMonth: Widget will not allow to switch calendar pane to the month after this.
 *    Actually it's a Date object, from which widget brings correct month and year.
 *  - startAtSunday: Wether to count sunday as the start of the week.
 *  - dateFormat: Format of date string that will be inserted in the input after user selected value.
 *  - events: Object, containing events to show in the calendar. They will be rendered as links. Structure of the object:
 *    { "yyyy": { "mm1" : [ d1, d2, d3, d4 ], "mm2": [ d5, d6, d7 ] } }
 *
 *  Events:
 *  - daySelected: Event is triggered when user selects a day in the calendar. The second parameter passed to the
 *  function is a Date object.
 *  - dateChange: switch month or year
 *
 *  Consistent options ( setting these options is guaranteed to work correctly ):
 *  - currentDate, date - Set/get current date. Input is also updated on set.
 *  - activeFrom, date - Set/get earliest active date.
 *  - activeUntil, date - Set/get last active date.
 *  - title, title - set calendar title.
 *  - events, obj - override current events object
 */

(function ($, window) {
  'use strict';

  $.widget('lj.normalizedCalendar', $.lj.inlineCalendar, {
    options: {}, //all options were move to the default options object

    _initialize: function _initialize() {
      this._nodes = {
        container: this._buildDOM(),
        root: this.element
      };

      this.element.html(this._nodes.container);

      $.lj.inlineCalendar.prototype._initialize.apply(this);
      this._invalidateDisplay();
    },

    _bindNodes: function _bindNodes() {
      $.lj.inlineCalendar.prototype._bindNodes.apply(this);

      if (this.options.showCellHovers) {
        this._nodes.table.addClass(this.options.classNames.showCellHovers);
      }
    },

    _buildDOM: function _buildDOM() {
      var // array, contains short days names in format: [ { day: 'sun' }, ... ]
      days,

      // array, contains years from endYear till startYear. Format: [ {year: 2012}, ... ]
      years = [],

      // array, contained months names. Format: [ {month: el}, ... ]
      months = [],
          weekendIdx1 = 0,
          weekendIdx2 = 6,

      // generate years
      startYear = this.options.startMonth.getFullYear(),
          endYear = this.options.endMonth.getFullYear(),

      // template options
      tmplOptions = null,
          makeArray = function makeArray(size, val) {
        var res = [];
        while (size--) {
          res.push(val);
        }

        return res;
      };
      // populate days
      days = this.options.ml.dayNamesShort.map(function (el) {
        return { day: el };
      });
      // populate months
      months = this.options.ml.monthNamesLong.map(function (el) {
        return { month: el };
      });
      // populate years
      while (endYear >= startYear) {
        years.push({ year: endYear-- });
      }
      // if week starts from Monday - move sunday to the end
      if (!this.options.startAtSunday) {
        days[7] = days[0];
        days.shift();
        weekendIdx1 = 5;
      }

      tmplOptions = {
        caption: this.options.ml.caption,
        days: days,
        months: months,
        years: years,
        // rows * days in week
        cells: makeArray(6 * 7, {}),
        weekend1: weekendIdx1,
        weekend2: weekendIdx2
      };

      return LJ.UI.template(this.options.templates['calendar'], tmplOptions);
    },

    _cellSelectedEvent: function _cellSelectedEvent(cell, ev) {
      $.lj.inlineCalendar.prototype._cellSelectedEvent.call(this, cell, ev);

      // if all of table cells are active controls (so on click on the cell we change date or something) - hide calendar
      if (this.options.showCellHovers && !!cell.data('isActive')) {
        this._nodes.container.bubble('hide');
      }

      if (typeof this.options.onSelect === 'function') {
        this.options.onSelect(ev);
      }
    },

    _invalidateDisplay: function _invalidateDisplay() {
      this._view.modelChanged(this.options.displayedMonth, this._events, this._getSwitcherStates());
    },

    destroy: function destroy() {
      $.lj.inlineCalendar.prototype.destroy.apply(this);
      this.element.empty();
    }
  });

  $.lj.normalizedCalendar.defaults = {
    showCellHovers: false,

    events: null, //object with events to show in the calendar
    displayedMonth: null, //month displayed on the calendar. If not specified atstartup currentDate is used instead.

    selectors: {
      tmpl: '.appwidget-calendar .calendar'
    },

    classNames: {
      showCellHovers: 'all-days',
      popup: 'b-bubble-calendar'
    },

    templates: {
      calendar: 'templates-Widgets-normalized_calendar'
    },

    fixRedirect: true
  };

  jQuery.extend($.lj.normalizedCalendar, {
    getDefaults: function getDefaults() {
      return jQuery.extend(true, {}, $.lj.inlineCalendar.getDefaults(), $.lj.normalizedCalendar.defaults);
    },

    setDefaults: function setDefaults(opts) {
      if (opts !== undefined) {
        jQuery.extend($.lj.normalizedCalendar.defaults, opts);
      }
    }
  });
})(jQuery, window);
/* <<< file end: js/jquery/jquery.lj.normalizedCalendar.js */

//# map link was there [jquery.lj.normalizedCalendar.js.map]
/* >>> file start: js/feed/feedWidget.js */
//= require js/node_modules/angular-animate/angular-animate.js

//= require js/widgets/angular/today.js
//= require js/widgets/angular/ljMediaWidget.js
//= require js/widgets/angular/updates.js
//= require js/widgets/angular/links.js
//= require js/widgets/angular/social.js
//= require js/widgets/angular/fbPage.js
//= require js/widgets/angular/questionOfTheDay.js
//= require js/core/angular/checked.js
//= require js/core/angular/api.js
//= require js/core/angular/ljSelectric.js
//= require js/core/angular/ljYandexContext.js

//= require js/jquery/jquery.lj.normalizedCalendar.js

Site.page.template['FriendsPage/v3/widget-calendar.tmpl'] = '<div\n    class=\"\n        b-lenta-calendar\n        l-flatslide-aside-block\n        js-link-color--a\n        js-elem-bordercolor\n        \">\n    <h3\n        class=\"b-lenta-sidebar-title\"\n        lj-ml=\"friendsfeed.linkbar.title.calendar\"\n        ></h3>\n    <div class=\"b-lenta-calendar-inner\">\n        <div class=\"b-lenta-calendar-content\"></div>\n    </div>\n</div>\n';
LJ.UI.registerTemplate('templates-Widgets-friends_feed_calendar', "{{html print_svg(\'flaticon\')}} <div class=\"popup-inner calendar\"> <p class=\"sbar-cal-nav\"> <span class=\"sbar-cal-nav-month\"> <i title=\"Previous Month\" class=\"sbar-cal-nav-prev\"> {{if 0}}<i class=\"sbar-cal-nav-arr\"></i>{{/if}} <span lj-svg-icon=\"flaticon--arrow-left\" class=\" sbar-cal-nav-arr js-elem-color--svgicon \" ></span> </i> <span class=\"sbar-cal-month\"> <a class=\"month\" href=\"javascript:void(0);\">Oct</a> </span> {{if 0}}<i title=\"Next Month\" class=\"sbar-cal-nav-next disabled\"><i class=\"sbar-cal-nav-arr\"></i></i>{{/if}} <i title=\"Next Month\" class=\"sbar-cal-nav-next disabled\"> <span lj-svg-icon=\"flaticon--arrow-right\" class=\" sbar-cal-nav-arr js-elem-color--svgicon \" ></span> </i> </span> <span class=\"sbar-cal-nav-year\"> {{if 0}}<i title=\"Previous Year\" class=\"sbar-cal-nav-prev\"><i class=\"sbar-cal-nav-arr\"></i></i>{{/if}} <i title=\"Previous Year\" class=\"sbar-cal-nav-prev\"> <span lj-svg-icon=\"flaticon--arrow-left\" class=\" sbar-cal-nav-arr js-elem-color--svgicon \" ></span> </i> <span class=\"sbar-cal-year\"> <a class=\"year\" href=\"javascript:void(0);\">2012</a> </span> {{if 0}}<i title=\"Next Year\" class=\"sbar-cal-nav-next disabled\"><i class=\"sbar-cal-nav-arr\"></i></i>{{/if}} <i title=\"Next Year\" class=\"sbar-cal-nav-next disabled\"> <span lj-svg-icon=\"flaticon--arrow-right\" class=\" sbar-cal-nav-arr js-elem-color--svgicon \" ></span> </i> </span> </p> <table cellspacing=\"1\" data-date=\"\" class=\" js-elem-bordercolor js-elem-bordercolor--table\" > <thead> <tr> {{each days}} <th class=\"child-${$index + 1}\">${day}</th> {{/each}} </tr> </thead> <tbody> {{each cells}} {{if $index % 7 === 0}}<tr>{{/if}} <td><span></span></td> {{if $index % 7 === 6}}</tr>{{/if}} {{/each}} </tbody> </table> </div> ", 'JQuery.stat');

//= require_ml widget.social.facebookpage.title

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Feed.Widget', ['LJ.Api', 'LJ.Checked', 'LJ.Widget.Top', 'LJ.Widget.Discovery', 'LJ.Widget.Media', 'LJ.Widget.Updates', 'LJ.Widget.Links', 'LJ.Widget.Social', 'LJ.Widget.FbPage', 'LJ.Widget.QuestionOfTheDay', 'ngAnimate', 'LJ.Selectric', 'LJ.YandexContext']);
  angular.module('Feed.Widget').run(run).config(config).animation('.b-feedwidgets-item', animation).controller('FeedWidgetsCtrl', FeedWidgetsCtrl).directive('ljWidgetFeedCalendar', ljWidgetFeedCalendar);

  /**
   * run
   *
   * @name run
   * @function
   * @public
   */
  function run() {
    // HTML5 mode is on to keep anchor links working by LJSV-2932
    angular.element('a:not([target])').attr('target', '_self'); // fix html5mode
  }

  /**
   * @ngdoc config
   * @requires $locationProvider
   */
  config.$inject = ['$locationProvider'];
  /**
   * config
   *
   * @name config
   * @function
   * @public
   * @param {object} $locationProvider - provides location services
   */
  function config($locationProvider) {
    $locationProvider.html5Mode(true);
  }

  /**
   * ngdoc animation
   */
  function animation() {
    return { move: move };
    /**
     * move
     *
     * @name move
     * @function
     * @public
     * @param {object} element - HTMLElement
     * @param {function} done - callback
     */
    function move(element, done) {
      var nextElement = element.next(),
          // fires after nodes position has been changed
      elementHeight = element.outerHeight(true),
          nextElementHeight = nextElement.outerHeight(true),
          elementTop = element.position().top,
          nextElementTop = nextElement.position().top,
          elementReplacer = angular.element('<div />', { height: elementHeight }).insertAfter(nextElement),
          nextElementReplacer = angular.element('<div />', { height: nextElementHeight }).insertAfter(element);

      element.css({
        position: 'absolute',
        top: elementTop + nextElementHeight,
        zIndex: 500 // z-index is needed to set top/bottom widget during animation
      });

      nextElement.css({
        position: 'absolute',
        top: elementTop,
        zIndex: 600
      });

      angular.element.when(element.animate({ top: elementTop }, 200, 'linear'), nextElement.animate({ top: nextElementTop }, 200, 'linear')).then(function () {
        elementReplacer.remove();
        nextElementReplacer.remove();
        element.removeAttr('style');
        nextElement.removeAttr('style');
        done();
      });
    }
  }

  /**
   * @ngdoc controller
   * @requires $scope
   * @requires Api
   * @requires checkedGroup
   * @requires $log
   */
  FeedWidgetsCtrl.$inject = ['$scope', 'Api', 'checkedGroup', '$log', '$window'];
  /**
   * FeedWidgetsCtrl
   *
   * @name FeedWidgetsCtrl
   * @function
   * @public
   * @param {object} $scope - local scope
   * @param {object} Api - LJ.Api wrapper
   * @param {function} checkedGroup - checkgroup service ?
   * @param {object} $log - console ng wrapper
   */
  function FeedWidgetsCtrl($scope, Api, checkedGroup, $log, $window) {
    var _positions,
        _watchInitialized,
        widgets = checkedGroup('widgets'),
        vm = this,
        DIRECTION = { UP: -1, DOWN: 1 };

    vm.isRemote = Boolean(LJ.get('remote'));
    vm.jsHeight = function () {
      return $window.innerWidth < 1000;
    };
    vm.isOwn = vm.isRemote && LJ.get('journal.username') === LJ.get('remote.username');

    vm.isDiscoveryEnabled = LJ.get('friendsfeed_widgets.discoveryToday.enabled'); // get state of discovery widget (is needed for non-logged users)
    vm.isLJMediaEnabled = LJ.get('friendsfeed_widgets.ljMedia.enabled'); // get state of ljMedia widget (is needed for non-logged users)
    vm.isCalendarEnabled = LJ.get('friendsfeed_widgets.calendar.enabled'); // get calendar widget state for non-logged/non-paid users

    vm.widgetItems = [// items for owner feed
    { widget: 'none', value: LJ.ml('friendsfeed.widgets.select.title') }, { widget: 'comments', value: LJ.ml('main.updates.widget.title.comments') }, { widget: 'events', value: LJ.ml('main.updates.widget.title.events') }, { widget: 'entries', value: LJ.ml('main.updates.widget.title.entries') }, { widget: 'guests', value: LJ.ml('main.updates.widget.title.guests') }, { widget: 'twitter', value: LJ.ml('widget.social.twitter.title') }, { widget: 'ljToday', value: LJ.ml('main.todaylj.head') }, { widget: 'links', value: LJ.ml('widget.links.title') }, { widget: 'facebook', value: LJ.ml('widget.social.facebook.title') }, { widget: 'instagram', value: LJ.ml('widget.social.instagram.title') }, { widget: 'tumblr', value: LJ.ml('widget.social.tumblr.title') }, { widget: 'calendar', value: LJ.ml('friendsfeed.linkbar.title.calendar') }, { widget: 'discoveryToday', value: LJ.ml('discovery.todaylj.head') }, { widget: 'friendAct', value: LJ.ml('main.updates.widget.title.friend_activity') }, { widget: 'questionOfTheDay', value: LJ.ml('widget.flatquestion.head') }, { widget: 'ljMedia', value: LJ.ml('friendsfeed.ljmedia.title') }];

    if (!vm.isOwn) {
      vm.widgetItems = [// items for not owner feed
      { widget: 'calendar', value: LJ.ml('friendsfeed.linkbar.title.calendar') }, { widget: 'discoveryToday', value: LJ.ml('discovery.todaylj.head') }, { widget: 'ljMedia', value: LJ.ml('friendsfeed.ljmedia.title') }, { widget: 'ljToday', value: LJ.ml('main.todaylj.head') }];
    }

    vm.widgetItems = vm.widgetItems.filter(function (item) {
      if (item.widget === 'none') {
        // filter enabled items only
        return true;
      }
      return LJ.get('friendsfeed_widgets.' + item.widget + '.enabled');
    });

    vm.selectedWidget = 'none';

    _positions = LJ.get('friendsfeed_widgets_order') ? LJ.get('friendsfeed_widgets_order').split(',').map(Number) : [];

    vm.list = list;
    /**
     * list
     *
     * @name list
     * @function
     * @public
     * @return {array} widgetItems list
     */
    function list() {
      var list = vm.widgetItems;

      if (vm.isOwn) {
        list = vm.widgetItems.slice(1).sort(function (a, b) {
          return _widgetPosition(a.widget) - _widgetPosition(b.widget);
        });
      }

      return list.filter(LJ.Function.not(vm.isWidgetInList, vm));
    }

    /**
     * _widgetPosition
     *
     * @description If widget has not been positioned yet - it should be added to the top;
     *              -1 is less then minimal widgets position that is equal 0.
     * @name _widgetPosition
     * @function
     * @private
     * @param {string|number} widget - name
     * @return {*} widget position in _positions
     */
    function _widgetPosition(widget) {
      var position = _positions.indexOf(_widgetId(widget));

      return position;
    }

    /**
     * _widgetId
     *
     * @name _widgetId
     * @function
     * @private
     * @param {string|number} widget - name or ID of a widget ?
     * @return {*} whatever LJ.get returns
     */
    function _widgetId(widget) {
      return LJ.get('friendsfeed_widgets.' + widget + '.id');
    }

    /**
     * positions
     *
     * @name positions
     * @function
     * @public
     * @param {array|null|false|undefined|*} value - TODO add description
     * @return {array|undefined} positions old array or nothing ?
     */
    function positions(value) {
      if (!value) {
        return _positions;
      }

      _positions = value;
    }

    /**
     * listPositions
     *
     * @description Positions according to the list
     * @name listPositions
     * @function
     * @public
     * @return {array} wigdet IDs
     */
    function listPositions() {
      return vm.list().map(LJ.Function.get('widget')).map(_widgetId);
    }

    /**
     * syncPositions
     *
     * @description calls Api friendsfeed.change_widgets_order
     * @name syncPositions
     * @function
     * @public
     */
    function syncPositions() {
      Api.call('friendsfeed.change_widgets_order', {
        'friendsfeed_widgets_order': positions().join(',')
      });
    }

    /**
     * When user selects some widget to add, - add
     * it to the page and reset select state
     */
    $scope.$watch(function () {
      return vm.selectedWidget;
    }, function (widget) {
      if (widget && widget !== 'none') {
        vm.add(widget);
        vm.selectedWidget = 'none';
      }
    });

    /**
     * Show widget in list of available widgets or not
     * @param  {object}  item  Widget item
     * @return {Boolean}       Result of the check
     */
    vm.isWidgetInList = function (item) {
      return !widgets.isChecked(item.widget);
    };

    /**
     * Show widgets select box or not depending on available widgets list
     * @return {Boolean} Result
     */
    vm.hasDisabled = function () {
      return !widgets.isAllChecked();
    };

    /**
     * Set initial states
     */
    widgets.reset(getInitialStates());

    /**
     * getInitialStates
     *
     * @name getInitialStates
     * @function
     * @public
     * @return {object} widget states hashmap
     */
    function getInitialStates() {
      var states = {};

      vm.widgetItems.forEach(function (item) {
        // add states for enabled widgets only
        if (item.widget === 'none') {
          return;
        }

        states[item.widget] = LJ.get('friendsfeed_widgets.' + item.widget + '.checked');
      });

      return states;
    }

    vm.models = widgets.models();

    /**
     * Remove widget from the page
     * @param  {String} widget Widget name
     */
    vm.remove = function (widget) {
      widgets.toggle(widget, false);

      Api.call('friendsfeed.delete_widget', {
        widget: widget
      });

      positions(listPositions());
    };

    /**
     * Add widget on the page
     * @param {String} widget Widget name
     */
    vm.add = function (widget) {
      widgets.toggle(widget, true);

      Api.call('friendsfeed.add_widget', {
        widget: widget
      });

      positions(listPositions());
    };

    vm.down = down;
    /**
     * down
     *
     * @name down
     * @function
     * @public
     * @param {*} widget - TODO add description
     */
    function down(widget) {
      moveWidget(widget, DIRECTION.DOWN);
    }

    vm.up = up;
    /**
     * up
     *
     * @name up
     * @function
     * @public
     * @param {*} widget - TODO add description
     */
    function up(widget) {
      moveWidget(widget, DIRECTION.UP);
    }

    /**
     * Swap widgets by diff positions
     * @param  {String} widget Widget name
     * @param  {Number} diff   Move diff: +1 - DOWN, -1 - UP
     */
    function moveWidget(widget, diff) {
      var pos = positions(),
          id = _widgetId(widget),
          index = pos.indexOf(id),
          nextIndex = index + diff,
          nextId = pos[nextIndex];

      if (angular.isNumber(nextId)) {
        // check if move is possible
        pos[nextIndex] = id;
        pos[index] = nextId;
      } else {
        $log.log('not possible');
      }

      positions(pos); // update positions
    }

    positions(listPositions()); // update positions, because sometimes server sends us more enabled widgets then positions

    if (LJ.get('remote')) {
      // send widgets statistics to ATI for logged users
      LJ.Event.trigger('ATI:Widgets', vm.list().map(LJ.Function.get('widget')));
    }

    $scope.$watchCollection(function () {
      // sync positions when changed
      return _positions;
    }, function () {
      if (!_watchInitialized) {
        // skip initial watch with same data
        _watchInitialized = true;
        return;
      }

      syncPositions();
    });
  }

  /**
   * @ngdoc
   * @directive ljWidgetFeedCalendar
   * @requires $location
   * @requires $compile
   */
  ljWidgetFeedCalendar.$inject = ['$location', '$compile'];
  /**
   * ljWidgetFeedCalendar
   *
   * @name ljWidgetFeedCalendar
   * @function
   * @public
   * @param {object} $location - location provider
   * @param {function} $compile - ng compiler
   * @return {object} directive fabric object
   */
  function ljWidgetFeedCalendar($location, $compile) {
    return {
      scope: true,
      restrict: 'A',
      templateUrl: 'widget-calendar.tmpl',
      link: link
    };
    /**
     * link
     *
     * @name link
     * @function
     * @public
     * @param {object} scope - local directive scope
     * @param {object} element - HTMLElement target
     */
    function link(scope, element) {
      var $calendar = element.find('.b-lenta-calendar-content');

      $calendar.normalizedCalendar({
        selectors: {
          month: '.sbar-cal-nav-month',
          year: '.sbar-cal-nav-year',

          prevMonth: '.sbar-cal-nav-month .sbar-cal-nav-prev',
          nextMonth: '.sbar-cal-nav-month .sbar-cal-nav-next',
          prevYear: '.sbar-cal-nav-year .sbar-cal-nav-prev',
          nextYear: '.sbar-cal-nav-year .sbar-cal-nav-next',

          monthLabel: '.sbar-cal-nav-month .sbar-cal-month',
          yearLabel: '.sbar-cal-nav-year .sbar-cal-year'
        },
        classNames: {
          current: 'today',
          nextDisabled: 'disabled',
          prevDisabled: 'disabled'
        },
        templates: {
          calendar: 'templates-Widgets-friends_feed_calendar'
        },
        allRefs: { to: new Date() },
        dayRef: LJ.get('calendarPattern'),
        monthRef: false,
        yearRef: false,
        endMonth: new Date(),
        startAtSunday: true,
        fixRedirect: false,
        onSelect: onSelect.bind(this, scope)
      });

      $compile($calendar)(scope);

      scope.$on('$routeChangeSuccess', function () {
        var ref = LJ.get('currentJournalBase') + '/feed' + $location.path() + '?date=%Y-%M-%D';

        $calendar.normalizedCalendar('option', 'dayRef', ref);
        $calendar.find('table a').removeAttr('target');
      });
    }

    /**
     * onSelect
     *
     * @name onSelect
     * @function
     * @public
     * @param {object} event - select event
     */
    function onSelect(scope, event) {
      angular.forEach(LiveJournal.parseGetArgs(event.target.search), function (value, key) {
        $location.search(key, value);
      });

      scope.$apply();
    }
  }

  angular.element(function () {
    /**
     * Scrolling sidebar functionality
     * @todo Refactor it
     */
    (function () {
      var className = 'b-lenta-widget-open',
          tabHeaders = angular.element('.b-lenta-widget-header'),
          tabWrappers = angular.element('.b-lenta-widget'),
          preventClose = false;

      tabHeaders.add(tabHeaders.prev()).on('click', function () {
        var tabWrapper = angular.element(this).closest('.b-lenta-widget');

        tabWrappers.not(tabWrapper).removeClass(className);
        tabWrapper.toggleClass(className);
        preventClose = true;
      });

      angular.element('.b-lenta-widget').on('click', function () {
        preventClose = true;
      });

      angular.element(document).on('click', function () {
        if (preventClose) {
          preventClose = false;
        } else {
          angular.element('.b-lenta-widget').removeClass(className);
        }
      });
    })();
  });

  /**
   * Friend feed v2 calendar widget initialization
   */

  angular.element(function () {
    if (LJ.Flags.isDisabled('friendsfeed_v3')) {
      angular.element('.b-lenta-calendar-content').normalizedCalendar({
        selectors: {
          month: '.sbar-cal-nav-month',
          year: '.sbar-cal-nav-year',

          prevMonth: '.sbar-cal-nav-month .sbar-cal-nav-prev',
          nextMonth: '.sbar-cal-nav-month .sbar-cal-nav-next',
          prevYear: '.sbar-cal-nav-year .sbar-cal-nav-prev',
          nextYear: '.sbar-cal-nav-year .sbar-cal-nav-next',

          monthLabel: '.sbar-cal-nav-month .sbar-cal-month',
          yearLabel: '.sbar-cal-nav-year .sbar-cal-year'
        },
        classNames: {
          current: 'today',
          nextDisabled: 'disabled',
          prevDisabled: 'disabled'
        },
        templates: {
          calendar: 'templates-Widgets-friends_feed_calendar'
        },
        allRefs: { to: new Date() },
        dayRef: LJ.get('calendarPattern'),
        monthRef: false,
        yearRef: false,
        endMonth: new Date(),
        startAtSunday: true,
        onSelect: onSelect
      });
    }
  });

  /**
   * onSelect
   *
   * @name onSelect
   * @function
   * @public
   * @param {object} event - event select
   */
  function onSelect(event) {
    if (event.target.tagName.toLowerCase() === 'a') {
      window.location.href = event.target.href; //eslint-disable-line angular/window-service
    }
  }
})();
/* <<< file end: js/feed/feedWidget.js */

//# map link was there [feedWidget.js.map]
/* >>> file start: js/feed/rss.js */
//= require js/core/angular/api.js

Site.page.template['angular/feed/rss.ng.tmpl'] = '<!-- popup content -->\n<div\n  class=\"b-translation-content {{ \'b-translation-\' + rss.state + \'-state\' }}\"\n  ng-controller=\"RssCtrl as rss\"\n  ng-class=\"{\'b-translation-error-state\': rss.hasError, \'b-translation-loading-state\': rss.isLoading }\">\n  <header class=\"b-translation-heads\">\n    <span class=\"b-translation-title b-translation-title-add\" lj-ml=\"friendsfeed.settings.translation.title_add\"></span>\n    <span class=\"b-translation-title b-translation-title-create\" lj-ml=\"friendsfeed.settings.translation.title_create\"></span>\n    <span class=\"b-translation-title b-translation-title-add-success\" lj-ml=\"friendsfeed.settings.translation.title_success_add\"></span>\n    <span class=\"b-translation-title b-translation-title-create-success\" lj-ml=\"friendsfeed.settings.translation.title_success_create\"></span>\n  </header>\n  <div class=\"b-translation-body\">\n    <div class=\"b-translation-items\">\n      <input\n        class=\"b-input b-input-simple b-input-max b-translation-input b-translation-input-add\"\n        ng-model=\"url\"\n        placeholder=\"http://...\"\n        type=\"text\"/>\n      <input\n        class=\"b-input b-input-simple b-input-max b-translation-input b-translation-input-create\"\n        ng-model=\"name\"\n        placeholder=\"Name\"\n        type=\"text\"/>\n      <a ng-href=\"{{link}}\" class=\"b-translation-success-item\">\n        <img ng-src=\"{{userpic}}\" />\n        <span ng-bind=\"user\"></span>\n      </a>\n    </div>\n    <div class=\"b-translation-errors\">\n      <span\n        class=\"b-translation-error b-translation-error-create\"\n        lj-html-live=\"rss.error\">\n      </span>\n      <span\n        class=\"b-translation-error b-translation-error-add\"\n        lj-ml=\"friendsfeed.settings.translation.error_paid\">\n      </span>\n    </div>\n\n    <div class=\"b-translation-submit\">\n      <button\n        class=\"b-flatbutton b-flatbutton-simple b-flatbutton-neutral  b-translation-submit-back\"\n        ng-click=\"rss.state = \'add\'\"\n        lj-ml=\"friendsfeed.settings.translation.button_back\">\n      </button>\n      <button\n        class=\"b-flatbutton b-flatbutton-simple b-translation-submit-add\"\n        ng-disabled=\"!url\"\n        ng-click=\"rss.add()\"\n        lj-ml=\"friendsfeed.settings.translation.button_add\">\n      </button>\n      <button\n        class=\"b-flatbutton b-flatbutton-simple b-translation-submit-create\"\n        ng-disabled=\"!rss.isValidName\"\n        ng-click=\"rss.create()\"\n        lj-ml=\"friendsfeed.settings.translation.button_create\">\n      </button>\n      <button\n        class=\"b-flatbutton b-flatbutton-simple b-translation-submit-next\"\n        href=\"#\"\n        ng-click=\"rss.state = \'add\'\"\n        lj-ml=\"friendsfeed.settings.translation.button_success\">\n      </button>\n    </div>\n  </div>\n</div>\n<!-- popup content -->\n';

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Feed.Rss', ['LJ.Api']).controller('RssCtrl', ['$timeout', '$scope', 'Api', function ($timeout, $scope, Api) {

    var that = this;

    function addToFriend(username) {
      return Api.call('relations.addfriend', { target: username });
    }

    that.isValidName = false;

    that.validate = function () {
      return Api.call('signup.check_username', { username: $scope.name });
    };

    that.create = function () {
      that.isLoading = true;

      Api.call('user.create_syndicated', { url: $scope.url, name: $scope.name }).then(function (response) {
        $scope.userpic = response.userpic;
        $scope.user = response.user;
        $scope.link = response.link;
        that.state = 'success-create';
        that.isLoading = false;
      });
    };

    that.add = function () {
      that.isLoading = true;
      Api.call('user.get_syndicated', { url: $scope.url }).then(function (response) {
        if (response.user) {
          $scope.userpic = response.userpic;
          $scope.user = response.user;
          $scope.link = response.link;
          that.hasError = false;

          addToFriend(response.user).then(function () {
            that.state = 'success-add';
          });
        } else {
          if (LJ.get('remote').is_paid) {
            that.state = 'create';
          } else {
            that.hasError = true;
          }
        }

        that.isLoading = false;
      }, function () {
        $scope.bubble.close();
      });
    };

    $scope.$watch(function () {
      return that.state;
    }, function (state) {
      if (state === 'add') {
        $scope.url = null;
        $scope.name = null;
        $scope.user = null;
        $scope.userpic = null;
      }
    });

    $scope.$watch(function () {
      return $scope.name + $scope.url;
    }, function () {
      that.hasError = false;
    });

    $scope.$on('bubble:open:rss', function () {
      that.state = 'add';
      that.isLoading = false;
    });

    $scope.$watch('name', function () {
      var timer;

      return function () {
        that.hasError = false;
        that.isValidName = false;

        if (!$scope.name) {
          return;
        }

        $timeout.cancel(timer);

        timer = $timeout(function () {
          that.validate().then(function (response) {
            that.isValidName = response.status !== 'error';
            that.hasError = response.status === 'error';
            that.error = response.errmsg;
          });
        }, 500);
      };
    }());

    that.isLoading = true;
    that.state = 'add';
  }]);
})();
/* <<< file end: js/feed/rss.js */

//# map link was there [rss.js.map]
/* >>> file start: js/node_modules/angular-sanitize/angular-sanitize.js */
/**
 * @license AngularJS v1.5.8
 * (c) 2010-2016 Google, Inc. http://angularjs.org
 * License: MIT
 */
(function (window, angular) {
  'use strict';

  /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
   *     Any commits to this file should be reviewed with security in mind.  *
   *   Changes to this file can potentially create security vulnerabilities. *
   *          An approval from 2 Core members with history of modifying      *
   *                         this file is required.                          *
   *                                                                         *
   *  Does the change somehow allow for arbitrary javascript to be executed? *
   *    Or allows for someone to change the prototype of built-in objects?   *
   *     Or gives undesired access to variables likes document or window?    *
   * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

  var $sanitizeMinErr = angular.$$minErr('$sanitize'),
      bind,
      extend,
      forEach,
      isDefined,
      lowercase,
      noop,
      htmlParser,
      htmlSanitizeWriter;


  /**
   * @ngdoc module
   * @name ngSanitize
   * @description
   *
   * # ngSanitize
   *
   * The `ngSanitize` module provides functionality to sanitize HTML.
   *
   *
   * <div doc-module-components="ngSanitize"></div>
   *
   * See {@link ngSanitize.$sanitize `$sanitize`} for usage.
   */

  /**
   * @ngdoc service
   * @name $sanitize
   * @kind function
   *
   * @description
   *   Sanitizes an html string by stripping all potentially dangerous tokens.
   *
   *   The input is sanitized by parsing the HTML into tokens. All safe tokens (from a whitelist) are
   *   then serialized back to properly escaped html string. This means that no unsafe input can make
   *   it into the returned string.
   *
   *   The whitelist for URL sanitization of attribute values is configured using the functions
   *   `aHrefSanitizationWhitelist` and `imgSrcSanitizationWhitelist` of {@link ng.$compileProvider
   *   `$compileProvider`}.
   *
   *   The input may also contain SVG markup if this is enabled via {@link $sanitizeProvider}.
   *
   * @param {string} html HTML input.
   * @returns {string} Sanitized HTML.
   *
   * @example
     <example module="sanitizeExample" deps="angular-sanitize.js">
     <file name="index.html">
       <script>
           angular.module('sanitizeExample', ['ngSanitize'])
             .controller('ExampleController', ['$scope', '$sce', function($scope, $sce) {
               $scope.snippet =
                 '<p style="color:blue">an html\n' +
                 '<em onmouseover="this.textContent=\'PWN3D!\'">click here</em>\n' +
                 'snippet</p>';
               $scope.deliberatelyTrustDangerousSnippet = function() {
                 return $sce.trustAsHtml($scope.snippet);
               };
             }]);
       </script>
       <div ng-controller="ExampleController">
          Snippet: <textarea ng-model="snippet" cols="60" rows="3"></textarea>
         <table>
           <tr>
             <td>Directive</td>
             <td>How</td>
             <td>Source</td>
             <td>Rendered</td>
           </tr>
           <tr id="bind-html-with-sanitize">
             <td>ng-bind-html</td>
             <td>Automatically uses $sanitize</td>
             <td><pre>&lt;div ng-bind-html="snippet"&gt;<br/>&lt;/div&gt;</pre></td>
             <td><div ng-bind-html="snippet"></div></td>
           </tr>
           <tr id="bind-html-with-trust">
             <td>ng-bind-html</td>
             <td>Bypass $sanitize by explicitly trusting the dangerous value</td>
             <td>
             <pre>&lt;div ng-bind-html="deliberatelyTrustDangerousSnippet()"&gt;
  &lt;/div&gt;</pre>
             </td>
             <td><div ng-bind-html="deliberatelyTrustDangerousSnippet()"></div></td>
           </tr>
           <tr id="bind-default">
             <td>ng-bind</td>
             <td>Automatically escapes</td>
             <td><pre>&lt;div ng-bind="snippet"&gt;<br/>&lt;/div&gt;</pre></td>
             <td><div ng-bind="snippet"></div></td>
           </tr>
         </table>
         </div>
     </file>
     <file name="protractor.js" type="protractor">
       it('should sanitize the html snippet by default', function() {
         expect(element(by.css('#bind-html-with-sanitize div')).getInnerHtml()).
           toBe('<p>an html\n<em>click here</em>\nsnippet</p>');
       });
  
       it('should inline raw snippet if bound to a trusted value', function() {
         expect(element(by.css('#bind-html-with-trust div')).getInnerHtml()).
           toBe("<p style=\"color:blue\">an html\n" +
                "<em onmouseover=\"this.textContent='PWN3D!'\">click here</em>\n" +
                "snippet</p>");
       });
  
       it('should escape snippet without any filter', function() {
         expect(element(by.css('#bind-default div')).getInnerHtml()).
           toBe("&lt;p style=\"color:blue\"&gt;an html\n" +
                "&lt;em onmouseover=\"this.textContent='PWN3D!'\"&gt;click here&lt;/em&gt;\n" +
                "snippet&lt;/p&gt;");
       });
  
       it('should update', function() {
         element(by.model('snippet')).clear();
         element(by.model('snippet')).sendKeys('new <b onclick="alert(1)">text</b>');
         expect(element(by.css('#bind-html-with-sanitize div')).getInnerHtml()).
           toBe('new <b>text</b>');
         expect(element(by.css('#bind-html-with-trust div')).getInnerHtml()).toBe(
           'new <b onclick="alert(1)">text</b>');
         expect(element(by.css('#bind-default div')).getInnerHtml()).toBe(
           "new &lt;b onclick=\"alert(1)\"&gt;text&lt;/b&gt;");
       });
     </file>
     </example>
   */

  /**
   * @ngdoc provider
   * @name $sanitizeProvider
   *
   * @description
   * Creates and configures {@link $sanitize} instance.
   */
  function $SanitizeProvider() {
    var svgEnabled = false;

    this.$get = ['$$sanitizeUri', function ($$sanitizeUri) {
      if (svgEnabled) {
        extend(validElements, svgElements);
      }
      return function (html) {
        var buf = [];
        htmlParser(html, htmlSanitizeWriter(buf, function (uri, isImage) {
          return !/^unsafe:/.test($$sanitizeUri(uri, isImage));
        }));
        return buf.join('');
      };
    }];

    /**
     * @ngdoc method
     * @name $sanitizeProvider#enableSvg
     * @kind function
     *
     * @description
     * Enables a subset of svg to be supported by the sanitizer.
     *
     * <div class="alert alert-warning">
     *   <p>By enabling this setting without taking other precautions, you might expose your
     *   application to click-hijacking attacks. In these attacks, sanitized svg elements could be positioned
     *   outside of the containing element and be rendered over other elements on the page (e.g. a login
     *   link). Such behavior can then result in phishing incidents.</p>
     *
     *   <p>To protect against these, explicitly setup `overflow: hidden` css rule for all potential svg
     *   tags within the sanitized content:</p>
     *
     *   <br>
     *
     *   <pre><code>
     *   .rootOfTheIncludedContent svg {
     *     overflow: hidden !important;
     *   }
     *   </code></pre>
     * </div>
     *
     * @param {boolean=} flag Enable or disable SVG support in the sanitizer.
     * @returns {boolean|ng.$sanitizeProvider} Returns the currently configured value if called
     *    without an argument or self for chaining otherwise.
     */
    this.enableSvg = function (enableSvg) {
      if (isDefined(enableSvg)) {
        svgEnabled = enableSvg;
        return this;
      } else {
        return svgEnabled;
      }
    };

    //////////////////////////////////////////////////////////////////////////////////////////////////
    // Private stuff
    //////////////////////////////////////////////////////////////////////////////////////////////////

    bind = angular.bind;
    extend = angular.extend;
    forEach = angular.forEach;
    isDefined = angular.isDefined;
    lowercase = angular.lowercase;
    noop = angular.noop;

    htmlParser = htmlParserImpl;
    htmlSanitizeWriter = htmlSanitizeWriterImpl;

    // Regular Expressions for parsing tags and attributes
    var SURROGATE_PAIR_REGEXP = /[\uD800-\uDBFF][\uDC00-\uDFFF]/g,

    // Match everything outside of normal chars and " (quote character)
    NON_ALPHANUMERIC_REGEXP = /([^\#-~ |!])/g,
        voidElements = toMap("area,br,col,hr,img,wbr"),
        optionalEndTagBlockElements = toMap("colgroup,dd,dt,li,p,tbody,td,tfoot,th,thead,tr"),
        optionalEndTagInlineElements = toMap("rp,rt"),
        optionalEndTagElements = extend({}, optionalEndTagInlineElements, optionalEndTagBlockElements),
        blockElements = extend({}, optionalEndTagBlockElements, toMap("address,article," + "aside,blockquote,caption,center,del,dir,div,dl,figure,figcaption,footer,h1,h2,h3,h4,h5," + "h6,header,hgroup,hr,ins,map,menu,nav,ol,pre,section,table,ul")),
        inlineElements = extend({}, optionalEndTagInlineElements, toMap("a,abbr,acronym,b," + "bdi,bdo,big,br,cite,code,del,dfn,em,font,i,img,ins,kbd,label,map,mark,q,ruby,rp,rt,s," + "samp,small,span,strike,strong,sub,sup,time,tt,u,var")),
        svgElements = toMap("circle,defs,desc,ellipse,font-face,font-face-name,font-face-src,g,glyph," + "hkern,image,linearGradient,line,marker,metadata,missing-glyph,mpath,path,polygon,polyline," + "radialGradient,rect,stop,svg,switch,text,title,tspan"),
        blockedElements = toMap("script,style"),
        validElements = extend({}, voidElements, blockElements, inlineElements, optionalEndTagElements),
        uriAttrs = toMap("background,cite,href,longdesc,src,xlink:href"),
        htmlAttrs = toMap('abbr,align,alt,axis,bgcolor,border,cellpadding,cellspacing,class,clear,' + 'color,cols,colspan,compact,coords,dir,face,headers,height,hreflang,hspace,' + 'ismap,lang,language,nohref,nowrap,rel,rev,rows,rowspan,rules,' + 'scope,scrolling,shape,size,span,start,summary,tabindex,target,title,type,' + 'valign,value,vspace,width'),
        svgAttrs = toMap('accent-height,accumulate,additive,alphabetic,arabic-form,ascent,' + 'baseProfile,bbox,begin,by,calcMode,cap-height,class,color,color-rendering,content,' + 'cx,cy,d,dx,dy,descent,display,dur,end,fill,fill-rule,font-family,font-size,font-stretch,' + 'font-style,font-variant,font-weight,from,fx,fy,g1,g2,glyph-name,gradientUnits,hanging,' + 'height,horiz-adv-x,horiz-origin-x,ideographic,k,keyPoints,keySplines,keyTimes,lang,' + 'marker-end,marker-mid,marker-start,markerHeight,markerUnits,markerWidth,mathematical,' + 'max,min,offset,opacity,orient,origin,overline-position,overline-thickness,panose-1,' + 'path,pathLength,points,preserveAspectRatio,r,refX,refY,repeatCount,repeatDur,' + 'requiredExtensions,requiredFeatures,restart,rotate,rx,ry,slope,stemh,stemv,stop-color,' + 'stop-opacity,strikethrough-position,strikethrough-thickness,stroke,stroke-dasharray,' + 'stroke-dashoffset,stroke-linecap,stroke-linejoin,stroke-miterlimit,stroke-opacity,' + 'stroke-width,systemLanguage,target,text-anchor,to,transform,type,u1,u2,underline-position,' + 'underline-thickness,unicode,unicode-range,units-per-em,values,version,viewBox,visibility,' + 'width,widths,x,x-height,x1,x2,xlink:actuate,xlink:arcrole,xlink:role,xlink:show,xlink:title,' + 'xlink:type,xml:base,xml:lang,xml:space,xmlns,xmlns:xlink,y,y1,y2,zoomAndPan', true),
        validAttrs = extend({}, uriAttrs, svgAttrs, htmlAttrs);

    // Good source of info about elements and attributes
    // http://dev.w3.org/html5/spec/Overview.html#semantics
    // http://simon.html5.org/html-elements

    // Safe Void Elements - HTML5
    // http://dev.w3.org/html5/spec/Overview.html#void-elements


    // Elements that you can, intentionally, leave open (and which close themselves)
    // http://dev.w3.org/html5/spec/Overview.html#optional-tags


    // Safe Block Elements - HTML5


    // Inline Elements - HTML5


    // SVG Elements
    // https://wiki.whatwg.org/wiki/Sanitization_rules#svg_Elements
    // Note: the elements animate,animateColor,animateMotion,animateTransform,set are intentionally omitted.
    // They can potentially allow for arbitrary javascript to be executed. See #11290


    // Blocked Elements (will be stripped)


    //Attributes that have href and hence need to be sanitized


    // SVG attributes (without "id" and "name" attributes)
    // https://wiki.whatwg.org/wiki/Sanitization_rules#svg_Attributes


    function toMap(str, lowercaseKeys) {
      var obj = {},
          items = str.split(','),
          i;
      for (i = 0; i < items.length; i++) {
        obj[lowercaseKeys ? lowercase(items[i]) : items[i]] = true;
      }
      return obj;
    }

    var inertBodyElement;
    (function (window) {
      var doc;
      if (window.document && window.document.implementation) {
        doc = window.document.implementation.createHTMLDocument("inert");
      } else {
        throw $sanitizeMinErr('noinert', "Can't create an inert html document");
      }
      var docElement = doc.documentElement || doc.getDocumentElement(),
          bodyElements = docElement.getElementsByTagName('body');


      // usually there should be only one body element in the document, but IE doesn't have any, so we need to create one
      if (bodyElements.length === 1) {
        inertBodyElement = bodyElements[0];
      } else {
        var html = doc.createElement('html');
        inertBodyElement = doc.createElement('body');
        html.appendChild(inertBodyElement);
        doc.appendChild(html);
      }
    })(window);

    /**
     * @example
     * htmlParser(htmlString, {
     *     start: function(tag, attrs) {},
     *     end: function(tag) {},
     *     chars: function(text) {},
     *     comment: function(text) {}
     * });
     *
     * @param {string} html string
     * @param {object} handler
     */
    function htmlParserImpl(html, handler) {
      if (html === null || html === undefined) {
        html = '';
      } else if (typeof html !== 'string') {
        html = '' + html;
      }
      inertBodyElement.innerHTML = html;

      //mXSS protection
      var mXSSAttempts = 5;
      do {
        if (mXSSAttempts === 0) {
          throw $sanitizeMinErr('uinput', "Failed to sanitize html because the input is unstable");
        }
        mXSSAttempts--;

        // strip custom-namespaced attributes on IE<=11
        if (window.document.documentMode) {
          stripCustomNsAttrs(inertBodyElement);
        }
        html = inertBodyElement.innerHTML; //trigger mXSS
        inertBodyElement.innerHTML = html;
      } while (html !== inertBodyElement.innerHTML);

      var node = inertBodyElement.firstChild;
      while (node) {
        switch (node.nodeType) {
          case 1:
            // ELEMENT_NODE
            handler.start(node.nodeName.toLowerCase(), attrToMap(node.attributes));
            break;
          case 3:
            // TEXT NODE
            handler.chars(node.textContent);
            break;
        }

        var nextNode;
        if (!(nextNode = node.firstChild)) {
          if (node.nodeType == 1) {
            handler.end(node.nodeName.toLowerCase());
          }
          nextNode = node.nextSibling;
          if (!nextNode) {
            while (nextNode == null) {
              node = node.parentNode;
              if (node === inertBodyElement) break;
              nextNode = node.nextSibling;
              if (node.nodeType == 1) {
                handler.end(node.nodeName.toLowerCase());
              }
            }
          }
        }
        node = nextNode;
      }

      while (node = inertBodyElement.firstChild) {
        inertBodyElement.removeChild(node);
      }
    }

    function attrToMap(attrs) {
      var map = {};
      for (var i = 0, ii = attrs.length; i < ii; i++) {
        var attr = attrs[i];
        map[attr.name] = attr.value;
      }
      return map;
    }

    /**
     * Escapes all potentially dangerous characters, so that the
     * resulting string can be safely inserted into attribute or
     * element text.
     * @param value
     * @returns {string} escaped text
     */
    function encodeEntities(value) {
      return value.replace(/&/g, '&amp;').replace(SURROGATE_PAIR_REGEXP, function (value) {
        var hi = value.charCodeAt(0),
            low = value.charCodeAt(1);

        return '&#' + ((hi - 0xD800) * 0x400 + (low - 0xDC00) + 0x10000) + ';';
      }).replace(NON_ALPHANUMERIC_REGEXP, function (value) {
        return '&#' + value.charCodeAt(0) + ';';
      }).replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    /**
     * create an HTML/XML writer which writes to buffer
     * @param {Array} buf use buf.join('') to get out sanitized html string
     * @returns {object} in the form of {
     *     start: function(tag, attrs) {},
     *     end: function(tag) {},
     *     chars: function(text) {},
     *     comment: function(text) {}
     * }
     */
    function htmlSanitizeWriterImpl(buf, uriValidator) {
      var ignoreCurrentElement = false,
          out = bind(buf, buf.push);

      return {
        start: function start(tag, attrs) {
          tag = lowercase(tag);
          if (!ignoreCurrentElement && blockedElements[tag]) {
            ignoreCurrentElement = tag;
          }
          if (!ignoreCurrentElement && validElements[tag] === true) {
            out('<');
            out(tag);
            forEach(attrs, function (value, key) {
              var lkey = lowercase(key),
                  isImage = tag === 'img' && lkey === 'src' || lkey === 'background';

              if (validAttrs[lkey] === true && (uriAttrs[lkey] !== true || uriValidator(value, isImage))) {
                out(' ');
                out(key);
                out('="');
                out(encodeEntities(value));
                out('"');
              }
            });
            out('>');
          }
        },
        end: function end(tag) {
          tag = lowercase(tag);
          if (!ignoreCurrentElement && validElements[tag] === true && voidElements[tag] !== true) {
            out('</');
            out(tag);
            out('>');
          }
          if (tag == ignoreCurrentElement) {
            ignoreCurrentElement = false;
          }
        },
        chars: function chars(_chars) {
          if (!ignoreCurrentElement) {
            out(encodeEntities(_chars));
          }
        }
      };
    }

    /**
     * When IE9-11 comes across an unknown namespaced attribute e.g. 'xlink:foo' it adds 'xmlns:ns1' attribute to declare
     * ns1 namespace and prefixes the attribute with 'ns1' (e.g. 'ns1:xlink:foo'). This is undesirable since we don't want
     * to allow any of these custom attributes. This method strips them all.
     *
     * @param node Root element to process
     */
    function stripCustomNsAttrs(node) {
      if (node.nodeType === window.Node.ELEMENT_NODE) {
        var attrs = node.attributes;
        for (var i = 0, l = attrs.length; i < l; i++) {
          var attrNode = attrs[i],
              attrName = attrNode.name.toLowerCase();

          if (attrName === 'xmlns:ns1' || attrName.lastIndexOf('ns1:', 0) === 0) {
            node.removeAttributeNode(attrNode);
            i--;
            l--;
          }
        }
      }

      var nextNode = node.firstChild;
      if (nextNode) {
        stripCustomNsAttrs(nextNode);
      }

      nextNode = node.nextSibling;
      if (nextNode) {
        stripCustomNsAttrs(nextNode);
      }
    }
  }

  function sanitizeText(chars) {
    var buf = [],
        writer = htmlSanitizeWriter(buf, noop);

    writer.chars(chars);
    return buf.join('');
  }

  // define ngSanitize module and register $sanitize service
  angular.module('ngSanitize', []).provider('$sanitize', $SanitizeProvider);

  /**
   * @ngdoc filter
   * @name linky
   * @kind function
   *
   * @description
   * Finds links in text input and turns them into html links. Supports `http/https/ftp/mailto` and
   * plain email address links.
   *
   * Requires the {@link ngSanitize `ngSanitize`} module to be installed.
   *
   * @param {string} text Input text.
   * @param {string} target Window (`_blank|_self|_parent|_top`) or named frame to open links in.
   * @param {object|function(url)} [attributes] Add custom attributes to the link element.
   *
   *    Can be one of:
   *
   *    - `object`: A map of attributes
   *    - `function`: Takes the url as a parameter and returns a map of attributes
   *
   *    If the map of attributes contains a value for `target`, it overrides the value of
   *    the target parameter.
   *
   *
   * @returns {string} Html-linkified and {@link $sanitize sanitized} text.
   *
   * @usage
     <span ng-bind-html="linky_expression | linky"></span>
   *
   * @example
     <example module="linkyExample" deps="angular-sanitize.js">
       <file name="index.html">
         <div ng-controller="ExampleController">
         Snippet: <textarea ng-model="snippet" cols="60" rows="3"></textarea>
         <table>
           <tr>
             <th>Filter</th>
             <th>Source</th>
             <th>Rendered</th>
           </tr>
           <tr id="linky-filter">
             <td>linky filter</td>
             <td>
               <pre>&lt;div ng-bind-html="snippet | linky"&gt;<br>&lt;/div&gt;</pre>
             </td>
             <td>
               <div ng-bind-html="snippet | linky"></div>
             </td>
           </tr>
           <tr id="linky-target">
            <td>linky target</td>
            <td>
              <pre>&lt;div ng-bind-html="snippetWithSingleURL | linky:'_blank'"&gt;<br>&lt;/div&gt;</pre>
            </td>
            <td>
              <div ng-bind-html="snippetWithSingleURL | linky:'_blank'"></div>
            </td>
           </tr>
           <tr id="linky-custom-attributes">
            <td>linky custom attributes</td>
            <td>
              <pre>&lt;div ng-bind-html="snippetWithSingleURL | linky:'_self':{rel: 'nofollow'}"&gt;<br>&lt;/div&gt;</pre>
            </td>
            <td>
              <div ng-bind-html="snippetWithSingleURL | linky:'_self':{rel: 'nofollow'}"></div>
            </td>
           </tr>
           <tr id="escaped-html">
             <td>no filter</td>
             <td><pre>&lt;div ng-bind="snippet"&gt;<br>&lt;/div&gt;</pre></td>
             <td><div ng-bind="snippet"></div></td>
           </tr>
         </table>
       </file>
       <file name="script.js">
         angular.module('linkyExample', ['ngSanitize'])
           .controller('ExampleController', ['$scope', function($scope) {
             $scope.snippet =
               'Pretty text with some links:\n'+
               'http://angularjs.org/,\n'+
               'mailto:us@somewhere.org,\n'+
               'another@somewhere.org,\n'+
               'and one more: ftp://127.0.0.1/.';
             $scope.snippetWithSingleURL = 'http://angularjs.org/';
           }]);
       </file>
       <file name="protractor.js" type="protractor">
         it('should linkify the snippet with urls', function() {
           expect(element(by.id('linky-filter')).element(by.binding('snippet | linky')).getText()).
               toBe('Pretty text with some links: http://angularjs.org/, us@somewhere.org, ' +
                    'another@somewhere.org, and one more: ftp://127.0.0.1/.');
           expect(element.all(by.css('#linky-filter a')).count()).toEqual(4);
         });
  
         it('should not linkify snippet without the linky filter', function() {
           expect(element(by.id('escaped-html')).element(by.binding('snippet')).getText()).
               toBe('Pretty text with some links: http://angularjs.org/, mailto:us@somewhere.org, ' +
                    'another@somewhere.org, and one more: ftp://127.0.0.1/.');
           expect(element.all(by.css('#escaped-html a')).count()).toEqual(0);
         });
  
         it('should update', function() {
           element(by.model('snippet')).clear();
           element(by.model('snippet')).sendKeys('new http://link.');
           expect(element(by.id('linky-filter')).element(by.binding('snippet | linky')).getText()).
               toBe('new http://link.');
           expect(element.all(by.css('#linky-filter a')).count()).toEqual(1);
           expect(element(by.id('escaped-html')).element(by.binding('snippet')).getText())
               .toBe('new http://link.');
         });
  
         it('should work with the target property', function() {
          expect(element(by.id('linky-target')).
              element(by.binding("snippetWithSingleURL | linky:'_blank'")).getText()).
              toBe('http://angularjs.org/');
          expect(element(by.css('#linky-target a')).getAttribute('target')).toEqual('_blank');
         });
  
         it('should optionally add custom attributes', function() {
          expect(element(by.id('linky-custom-attributes')).
              element(by.binding("snippetWithSingleURL | linky:'_self':{rel: 'nofollow'}")).getText()).
              toBe('http://angularjs.org/');
          expect(element(by.css('#linky-custom-attributes a')).getAttribute('rel')).toEqual('nofollow');
         });
       </file>
     </example>
   */
  angular.module('ngSanitize').filter('linky', ['$sanitize', function ($sanitize) {
    var LINKY_URL_REGEXP = /((ftp|https?):\/\/|(www\.)|(mailto:)?[A-Za-z0-9._%+-]+@)\S*[^\s.;,(){}<>"\u201d\u2019]/i,
        MAILTO_REGEXP = /^mailto:/i,
        linkyMinErr = angular.$$minErr('linky'),
        isDefined = angular.isDefined,
        isFunction = angular.isFunction,
        isObject = angular.isObject,
        isString = angular.isString;

    return function (text, target, attributes) {
      if (text == null || text === '') return text;
      if (!isString(text)) throw linkyMinErr('notstring', 'Expected string but received: {0}', text);

      var attributesFn = isFunction(attributes) ? attributes : isObject(attributes) ? function getAttributesObject() {
        return attributes;
      } : function getEmptyAttributesObject() {
        return {};
      },
          match,
          raw = text,
          html = [],
          url,
          i;

      while (match = raw.match(LINKY_URL_REGEXP)) {
        // We can not end in these as they are sometimes found at the end of the sentence
        url = match[0];
        // if we did not match ftp/http/www/mailto then assume mailto
        if (!match[2] && !match[4]) {
          url = (match[3] ? 'http://' : 'mailto:') + url;
        }
        i = match.index;
        addText(raw.substr(0, i));
        addLink(url, match[0].replace(MAILTO_REGEXP, ''));
        raw = raw.substring(i + match[0].length);
      }
      addText(raw);
      return $sanitize(html.join(''));

      function addText(text) {
        if (!text) {
          return;
        }
        html.push(sanitizeText(text));
      }

      function addLink(url, text) {
        var key,
            linkAttributes = attributesFn(url);
        html.push('<a ');

        for (key in linkAttributes) {
          html.push(key + '="' + linkAttributes[key] + '" ');
        }

        if (isDefined(target) && !('target' in linkAttributes)) {
          html.push('target="', target, '" ');
        }
        html.push('href="', url.replace(/"/g, '&quot;'), '">');
        addText(text);
        html.push('</a>');
      }
    };
  }]);
})(window, window.angular);
/* <<< file end: js/node_modules/angular-sanitize/angular-sanitize.js */

//# map link was there [angular-sanitize.js.map]
/* >>> file start: js/node_modules/moment/min/moment.min.js */
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

//! moment.js
//! version : 2.10.6
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
!function (a, b) {
  "object" == (typeof exports === "undefined" ? "undefined" : _typeof(exports)) && "undefined" != typeof module ? module.exports = b() : "function" == typeof define && define.amd ? define(b) : a.moment = b();
}(this, function () {
  "use strict";
  function a() {
    return Hc.apply(null, arguments);
  }function b(a) {
    Hc = a;
  }function c(a) {
    return "[object Array]" === Object.prototype.toString.call(a);
  }function d(a) {
    return a instanceof Date || "[object Date]" === Object.prototype.toString.call(a);
  }function e(a, b) {
    var c,
        d = [];for (c = 0; c < a.length; ++c) {
      d.push(b(a[c], c));
    }return d;
  }function f(a, b) {
    return Object.prototype.hasOwnProperty.call(a, b);
  }function g(a, b) {
    for (var c in b) {
      f(b, c) && (a[c] = b[c]);
    }return f(b, "toString") && (a.toString = b.toString), f(b, "valueOf") && (a.valueOf = b.valueOf), a;
  }function h(a, b, c, d) {
    return Ca(a, b, c, d, !0).utc();
  }function i() {
    return { empty: !1, unusedTokens: [], unusedInput: [], overflow: -2, charsLeftOver: 0, nullInput: !1, invalidMonth: null, invalidFormat: !1, userInvalidated: !1, iso: !1 };
  }function j(a) {
    return null == a._pf && (a._pf = i()), a._pf;
  }function k(a) {
    if (null == a._isValid) {
      var b = j(a);a._isValid = !(isNaN(a._d.getTime()) || !(b.overflow < 0) || b.empty || b.invalidMonth || b.invalidWeekday || b.nullInput || b.invalidFormat || b.userInvalidated), a._strict && (a._isValid = a._isValid && 0 === b.charsLeftOver && 0 === b.unusedTokens.length && void 0 === b.bigHour);
    }return a._isValid;
  }function l(a) {
    var b = h(NaN);return null != a ? g(j(b), a) : j(b).userInvalidated = !0, b;
  }function m(a, b) {
    var c, d, e;if ("undefined" != typeof b._isAMomentObject && (a._isAMomentObject = b._isAMomentObject), "undefined" != typeof b._i && (a._i = b._i), "undefined" != typeof b._f && (a._f = b._f), "undefined" != typeof b._l && (a._l = b._l), "undefined" != typeof b._strict && (a._strict = b._strict), "undefined" != typeof b._tzm && (a._tzm = b._tzm), "undefined" != typeof b._isUTC && (a._isUTC = b._isUTC), "undefined" != typeof b._offset && (a._offset = b._offset), "undefined" != typeof b._pf && (a._pf = j(b)), "undefined" != typeof b._locale && (a._locale = b._locale), Jc.length > 0) for (c in Jc) {
      d = Jc[c], e = b[d], "undefined" != typeof e && (a[d] = e);
    }return a;
  }function n(b) {
    m(this, b), this._d = new Date(null != b._d ? b._d.getTime() : NaN), Kc === !1 && (Kc = !0, a.updateOffset(this), Kc = !1);
  }function o(a) {
    return a instanceof n || null != a && null != a._isAMomentObject;
  }function p(a) {
    return 0 > a ? Math.ceil(a) : Math.floor(a);
  }function q(a) {
    var b = +a,
        c = 0;return 0 !== b && isFinite(b) && (c = p(b)), c;
  }function r(a, b, c) {
    var d,
        e = Math.min(a.length, b.length),
        f = Math.abs(a.length - b.length),
        g = 0;for (d = 0; e > d; d++) {
      (c && a[d] !== b[d] || !c && q(a[d]) !== q(b[d])) && g++;
    }return g + f;
  }function s() {}function t(a) {
    return a ? a.toLowerCase().replace("_", "-") : a;
  }function u(a) {
    for (var b, c, d, e, f = 0; f < a.length;) {
      for (e = t(a[f]).split("-"), b = e.length, c = t(a[f + 1]), c = c ? c.split("-") : null; b > 0;) {
        if (d = v(e.slice(0, b).join("-"))) return d;if (c && c.length >= b && r(e, c, !0) >= b - 1) break;b--;
      }f++;
    }return null;
  }function v(a) {
    var b = null;if (!Lc[a] && "undefined" != typeof module && module && module.exports) try {
      b = Ic._abbr, require("./locale/" + a), w(b);
    } catch (c) {}return Lc[a];
  }function w(a, b) {
    var c;return a && (c = "undefined" == typeof b ? y(a) : x(a, b), c && (Ic = c)), Ic._abbr;
  }function x(a, b) {
    return null !== b ? (b.abbr = a, Lc[a] = Lc[a] || new s(), Lc[a].set(b), w(a), Lc[a]) : (delete Lc[a], null);
  }function y(a) {
    var b;if (a && a._locale && a._locale._abbr && (a = a._locale._abbr), !a) return Ic;if (!c(a)) {
      if (b = v(a)) return b;a = [a];
    }return u(a);
  }function z(a, b) {
    var c = a.toLowerCase();Mc[c] = Mc[c + "s"] = Mc[b] = a;
  }function A(a) {
    return "string" == typeof a ? Mc[a] || Mc[a.toLowerCase()] : void 0;
  }function B(a) {
    var b,
        c,
        d = {};for (c in a) {
      f(a, c) && (b = A(c), b && (d[b] = a[c]));
    }return d;
  }function C(b, c) {
    return function (d) {
      return null != d ? (E(this, b, d), a.updateOffset(this, c), this) : D(this, b);
    };
  }function D(a, b) {
    return a._d["get" + (a._isUTC ? "UTC" : "") + b]();
  }function E(a, b, c) {
    return a._d["set" + (a._isUTC ? "UTC" : "") + b](c);
  }function F(a, b) {
    var c;if ("object" == (typeof a === "undefined" ? "undefined" : _typeof(a))) for (c in a) {
      this.set(c, a[c]);
    } else if (a = A(a), "function" == typeof this[a]) return this[a](b);return this;
  }function G(a, b, c) {
    var d = "" + Math.abs(a),
        e = b - d.length,
        f = a >= 0;return (f ? c ? "+" : "" : "-") + Math.pow(10, Math.max(0, e)).toString().substr(1) + d;
  }function H(a, b, c, d) {
    var e = d;"string" == typeof d && (e = function e() {
      return this[d]();
    }), a && (Qc[a] = e), b && (Qc[b[0]] = function () {
      return G(e.apply(this, arguments), b[1], b[2]);
    }), c && (Qc[c] = function () {
      return this.localeData().ordinal(e.apply(this, arguments), a);
    });
  }function I(a) {
    return a.match(/\[[\s\S]/) ? a.replace(/^\[|\]$/g, "") : a.replace(/\\/g, "");
  }function J(a) {
    var b,
        c,
        d = a.match(Nc);for (b = 0, c = d.length; c > b; b++) {
      Qc[d[b]] ? d[b] = Qc[d[b]] : d[b] = I(d[b]);
    }return function (e) {
      var f = "";for (b = 0; c > b; b++) {
        f += d[b] instanceof Function ? d[b].call(e, a) : d[b];
      }return f;
    };
  }function K(a, b) {
    return a.isValid() ? (b = L(b, a.localeData()), Pc[b] = Pc[b] || J(b), Pc[b](a)) : a.localeData().invalidDate();
  }function L(a, b) {
    function c(a) {
      return b.longDateFormat(a) || a;
    }var d = 5;for (Oc.lastIndex = 0; d >= 0 && Oc.test(a);) {
      a = a.replace(Oc, c), Oc.lastIndex = 0, d -= 1;
    }return a;
  }function M(a) {
    return "function" == typeof a && "[object Function]" === Object.prototype.toString.call(a);
  }function N(a, b, c) {
    dd[a] = M(b) ? b : function (a) {
      return a && c ? c : b;
    };
  }function O(a, b) {
    return f(dd, a) ? dd[a](b._strict, b._locale) : new RegExp(P(a));
  }function P(a) {
    return a.replace("\\", "").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g, function (a, b, c, d, e) {
      return b || c || d || e;
    }).replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
  }function Q(a, b) {
    var c,
        d = b;for ("string" == typeof a && (a = [a]), "number" == typeof b && (d = function d(a, c) {
      c[b] = q(a);
    }), c = 0; c < a.length; c++) {
      ed[a[c]] = d;
    }
  }function R(a, b) {
    Q(a, function (a, c, d, e) {
      d._w = d._w || {}, b(a, d._w, d, e);
    });
  }function S(a, b, c) {
    null != b && f(ed, a) && ed[a](b, c._a, c, a);
  }function T(a, b) {
    return new Date(Date.UTC(a, b + 1, 0)).getUTCDate();
  }function U(a) {
    return this._months[a.month()];
  }function V(a) {
    return this._monthsShort[a.month()];
  }function W(a, b, c) {
    var d, e, f;for (this._monthsParse || (this._monthsParse = [], this._longMonthsParse = [], this._shortMonthsParse = []), d = 0; 12 > d; d++) {
      if (e = h([2e3, d]), c && !this._longMonthsParse[d] && (this._longMonthsParse[d] = new RegExp("^" + this.months(e, "").replace(".", "") + "$", "i"), this._shortMonthsParse[d] = new RegExp("^" + this.monthsShort(e, "").replace(".", "") + "$", "i")), c || this._monthsParse[d] || (f = "^" + this.months(e, "") + "|^" + this.monthsShort(e, ""), this._monthsParse[d] = new RegExp(f.replace(".", ""), "i")), c && "MMMM" === b && this._longMonthsParse[d].test(a)) return d;if (c && "MMM" === b && this._shortMonthsParse[d].test(a)) return d;if (!c && this._monthsParse[d].test(a)) return d;
    }
  }function X(a, b) {
    var c;return "string" == typeof b && (b = a.localeData().monthsParse(b), "number" != typeof b) ? a : (c = Math.min(a.date(), T(a.year(), b)), a._d["set" + (a._isUTC ? "UTC" : "") + "Month"](b, c), a);
  }function Y(b) {
    return null != b ? (X(this, b), a.updateOffset(this, !0), this) : D(this, "Month");
  }function Z() {
    return T(this.year(), this.month());
  }function $(a) {
    var b,
        c = a._a;return c && -2 === j(a).overflow && (b = c[gd] < 0 || c[gd] > 11 ? gd : c[hd] < 1 || c[hd] > T(c[fd], c[gd]) ? hd : c[id] < 0 || c[id] > 24 || 24 === c[id] && (0 !== c[jd] || 0 !== c[kd] || 0 !== c[ld]) ? id : c[jd] < 0 || c[jd] > 59 ? jd : c[kd] < 0 || c[kd] > 59 ? kd : c[ld] < 0 || c[ld] > 999 ? ld : -1, j(a)._overflowDayOfYear && (fd > b || b > hd) && (b = hd), j(a).overflow = b), a;
  }function _(b) {
    a.suppressDeprecationWarnings === !1 && "undefined" != typeof console && console.warn && console.warn("Deprecation warning: " + b);
  }function aa(a, b) {
    var c = !0;return g(function () {
      return c && (_(a + "\n" + new Error().stack), c = !1), b.apply(this, arguments);
    }, b);
  }function ba(a, b) {
    od[a] || (_(b), od[a] = !0);
  }function ca(a) {
    var b,
        c,
        d = a._i,
        e = pd.exec(d);if (e) {
      for (j(a).iso = !0, b = 0, c = qd.length; c > b; b++) {
        if (qd[b][1].exec(d)) {
          a._f = qd[b][0];break;
        }
      }for (b = 0, c = rd.length; c > b; b++) {
        if (rd[b][1].exec(d)) {
          a._f += (e[6] || " ") + rd[b][0];break;
        }
      }d.match(ad) && (a._f += "Z"), va(a);
    } else a._isValid = !1;
  }function da(b) {
    var c = sd.exec(b._i);return null !== c ? void (b._d = new Date(+c[1])) : (ca(b), void (b._isValid === !1 && (delete b._isValid, a.createFromInputFallback(b))));
  }function ea(a, b, c, d, e, f, g) {
    var h = new Date(a, b, c, d, e, f, g);return 1970 > a && h.setFullYear(a), h;
  }function fa(a) {
    var b = new Date(Date.UTC.apply(null, arguments));return 1970 > a && b.setUTCFullYear(a), b;
  }function ga(a) {
    return ha(a) ? 366 : 365;
  }function ha(a) {
    return a % 4 === 0 && a % 100 !== 0 || a % 400 === 0;
  }function ia() {
    return ha(this.year());
  }function ja(a, b, c) {
    var d,
        e = c - b,
        f = c - a.day();return f > e && (f -= 7), e - 7 > f && (f += 7), d = Da(a).add(f, "d"), { week: Math.ceil(d.dayOfYear() / 7), year: d.year() };
  }function ka(a) {
    return ja(a, this._week.dow, this._week.doy).week;
  }function la() {
    return this._week.dow;
  }function ma() {
    return this._week.doy;
  }function na(a) {
    var b = this.localeData().week(this);return null == a ? b : this.add(7 * (a - b), "d");
  }function oa(a) {
    var b = ja(this, 1, 4).week;return null == a ? b : this.add(7 * (a - b), "d");
  }function pa(a, b, c, d, e) {
    var f,
        g = 6 + e - d,
        h = fa(a, 0, 1 + g),
        i = h.getUTCDay();return e > i && (i += 7), c = null != c ? 1 * c : e, f = 1 + g + 7 * (b - 1) - i + c, { year: f > 0 ? a : a - 1, dayOfYear: f > 0 ? f : ga(a - 1) + f };
  }function qa(a) {
    var b = Math.round((this.clone().startOf("day") - this.clone().startOf("year")) / 864e5) + 1;return null == a ? b : this.add(a - b, "d");
  }function ra(a, b, c) {
    return null != a ? a : null != b ? b : c;
  }function sa(a) {
    var b = new Date();return a._useUTC ? [b.getUTCFullYear(), b.getUTCMonth(), b.getUTCDate()] : [b.getFullYear(), b.getMonth(), b.getDate()];
  }function ta(a) {
    var b,
        c,
        d,
        e,
        f = [];if (!a._d) {
      for (d = sa(a), a._w && null == a._a[hd] && null == a._a[gd] && ua(a), a._dayOfYear && (e = ra(a._a[fd], d[fd]), a._dayOfYear > ga(e) && (j(a)._overflowDayOfYear = !0), c = fa(e, 0, a._dayOfYear), a._a[gd] = c.getUTCMonth(), a._a[hd] = c.getUTCDate()), b = 0; 3 > b && null == a._a[b]; ++b) {
        a._a[b] = f[b] = d[b];
      }for (; 7 > b; b++) {
        a._a[b] = f[b] = null == a._a[b] ? 2 === b ? 1 : 0 : a._a[b];
      }24 === a._a[id] && 0 === a._a[jd] && 0 === a._a[kd] && 0 === a._a[ld] && (a._nextDay = !0, a._a[id] = 0), a._d = (a._useUTC ? fa : ea).apply(null, f), null != a._tzm && a._d.setUTCMinutes(a._d.getUTCMinutes() - a._tzm), a._nextDay && (a._a[id] = 24);
    }
  }function ua(a) {
    var b, c, d, e, f, g, h;b = a._w, null != b.GG || null != b.W || null != b.E ? (f = 1, g = 4, c = ra(b.GG, a._a[fd], ja(Da(), 1, 4).year), d = ra(b.W, 1), e = ra(b.E, 1)) : (f = a._locale._week.dow, g = a._locale._week.doy, c = ra(b.gg, a._a[fd], ja(Da(), f, g).year), d = ra(b.w, 1), null != b.d ? (e = b.d, f > e && ++d) : e = null != b.e ? b.e + f : f), h = pa(c, d, e, g, f), a._a[fd] = h.year, a._dayOfYear = h.dayOfYear;
  }function va(b) {
    if (b._f === a.ISO_8601) return void ca(b);b._a = [], j(b).empty = !0;var c,
        d,
        e,
        f,
        g,
        h = "" + b._i,
        i = h.length,
        k = 0;for (e = L(b._f, b._locale).match(Nc) || [], c = 0; c < e.length; c++) {
      f = e[c], d = (h.match(O(f, b)) || [])[0], d && (g = h.substr(0, h.indexOf(d)), g.length > 0 && j(b).unusedInput.push(g), h = h.slice(h.indexOf(d) + d.length), k += d.length), Qc[f] ? (d ? j(b).empty = !1 : j(b).unusedTokens.push(f), S(f, d, b)) : b._strict && !d && j(b).unusedTokens.push(f);
    }j(b).charsLeftOver = i - k, h.length > 0 && j(b).unusedInput.push(h), j(b).bigHour === !0 && b._a[id] <= 12 && b._a[id] > 0 && (j(b).bigHour = void 0), b._a[id] = wa(b._locale, b._a[id], b._meridiem), ta(b), $(b);
  }function wa(a, b, c) {
    var d;return null == c ? b : null != a.meridiemHour ? a.meridiemHour(b, c) : null != a.isPM ? (d = a.isPM(c), d && 12 > b && (b += 12), d || 12 !== b || (b = 0), b) : b;
  }function xa(a) {
    var b, c, d, e, f;if (0 === a._f.length) return j(a).invalidFormat = !0, void (a._d = new Date(NaN));for (e = 0; e < a._f.length; e++) {
      f = 0, b = m({}, a), null != a._useUTC && (b._useUTC = a._useUTC), b._f = a._f[e], va(b), k(b) && (f += j(b).charsLeftOver, f += 10 * j(b).unusedTokens.length, j(b).score = f, (null == d || d > f) && (d = f, c = b));
    }g(a, c || b);
  }function ya(a) {
    if (!a._d) {
      var b = B(a._i);a._a = [b.year, b.month, b.day || b.date, b.hour, b.minute, b.second, b.millisecond], ta(a);
    }
  }function za(a) {
    var b = new n($(Aa(a)));return b._nextDay && (b.add(1, "d"), b._nextDay = void 0), b;
  }function Aa(a) {
    var b = a._i,
        e = a._f;return a._locale = a._locale || y(a._l), null === b || void 0 === e && "" === b ? l({ nullInput: !0 }) : ("string" == typeof b && (a._i = b = a._locale.preparse(b)), o(b) ? new n($(b)) : (c(e) ? xa(a) : e ? va(a) : d(b) ? a._d = b : Ba(a), a));
  }function Ba(b) {
    var f = b._i;void 0 === f ? b._d = new Date() : d(f) ? b._d = new Date(+f) : "string" == typeof f ? da(b) : c(f) ? (b._a = e(f.slice(0), function (a) {
      return parseInt(a, 10);
    }), ta(b)) : "object" == (typeof f === "undefined" ? "undefined" : _typeof(f)) ? ya(b) : "number" == typeof f ? b._d = new Date(f) : a.createFromInputFallback(b);
  }function Ca(a, b, c, d, e) {
    var f = {};return "boolean" == typeof c && (d = c, c = void 0), f._isAMomentObject = !0, f._useUTC = f._isUTC = e, f._l = c, f._i = a, f._f = b, f._strict = d, za(f);
  }function Da(a, b, c, d) {
    return Ca(a, b, c, d, !1);
  }function Ea(a, b) {
    var d, e;if (1 === b.length && c(b[0]) && (b = b[0]), !b.length) return Da();for (d = b[0], e = 1; e < b.length; ++e) {
      (!b[e].isValid() || b[e][a](d)) && (d = b[e]);
    }return d;
  }function Fa() {
    var a = [].slice.call(arguments, 0);return Ea("isBefore", a);
  }function Ga() {
    var a = [].slice.call(arguments, 0);return Ea("isAfter", a);
  }function Ha(a) {
    var b = B(a),
        c = b.year || 0,
        d = b.quarter || 0,
        e = b.month || 0,
        f = b.week || 0,
        g = b.day || 0,
        h = b.hour || 0,
        i = b.minute || 0,
        j = b.second || 0,
        k = b.millisecond || 0;this._milliseconds = +k + 1e3 * j + 6e4 * i + 36e5 * h, this._days = +g + 7 * f, this._months = +e + 3 * d + 12 * c, this._data = {}, this._locale = y(), this._bubble();
  }function Ia(a) {
    return a instanceof Ha;
  }function Ja(a, b) {
    H(a, 0, 0, function () {
      var a = this.utcOffset(),
          c = "+";return 0 > a && (a = -a, c = "-"), c + G(~~(a / 60), 2) + b + G(~~a % 60, 2);
    });
  }function Ka(a) {
    var b = (a || "").match(ad) || [],
        c = b[b.length - 1] || [],
        d = (c + "").match(xd) || ["-", 0, 0],
        e = +(60 * d[1]) + q(d[2]);return "+" === d[0] ? e : -e;
  }function La(b, c) {
    var e, f;return c._isUTC ? (e = c.clone(), f = (o(b) || d(b) ? +b : +Da(b)) - +e, e._d.setTime(+e._d + f), a.updateOffset(e, !1), e) : Da(b).local();
  }function Ma(a) {
    return 15 * -Math.round(a._d.getTimezoneOffset() / 15);
  }function Na(b, c) {
    var d,
        e = this._offset || 0;return null != b ? ("string" == typeof b && (b = Ka(b)), Math.abs(b) < 16 && (b = 60 * b), !this._isUTC && c && (d = Ma(this)), this._offset = b, this._isUTC = !0, null != d && this.add(d, "m"), e !== b && (!c || this._changeInProgress ? bb(this, Ya(b - e, "m"), 1, !1) : this._changeInProgress || (this._changeInProgress = !0, a.updateOffset(this, !0), this._changeInProgress = null)), this) : this._isUTC ? e : Ma(this);
  }function Oa(a, b) {
    return null != a ? ("string" != typeof a && (a = -a), this.utcOffset(a, b), this) : -this.utcOffset();
  }function Pa(a) {
    return this.utcOffset(0, a);
  }function Qa(a) {
    return this._isUTC && (this.utcOffset(0, a), this._isUTC = !1, a && this.subtract(Ma(this), "m")), this;
  }function Ra() {
    return this._tzm ? this.utcOffset(this._tzm) : "string" == typeof this._i && this.utcOffset(Ka(this._i)), this;
  }function Sa(a) {
    return a = a ? Da(a).utcOffset() : 0, (this.utcOffset() - a) % 60 === 0;
  }function Ta() {
    return this.utcOffset() > this.clone().month(0).utcOffset() || this.utcOffset() > this.clone().month(5).utcOffset();
  }function Ua() {
    if ("undefined" != typeof this._isDSTShifted) return this._isDSTShifted;var a = {};if (m(a, this), a = Aa(a), a._a) {
      var b = a._isUTC ? h(a._a) : Da(a._a);this._isDSTShifted = this.isValid() && r(a._a, b.toArray()) > 0;
    } else this._isDSTShifted = !1;return this._isDSTShifted;
  }function Va() {
    return !this._isUTC;
  }function Wa() {
    return this._isUTC;
  }function Xa() {
    return this._isUTC && 0 === this._offset;
  }function Ya(a, b) {
    var c,
        d,
        e,
        g = a,
        h = null;return Ia(a) ? g = { ms: a._milliseconds, d: a._days, M: a._months } : "number" == typeof a ? (g = {}, b ? g[b] = a : g.milliseconds = a) : (h = yd.exec(a)) ? (c = "-" === h[1] ? -1 : 1, g = { y: 0, d: q(h[hd]) * c, h: q(h[id]) * c, m: q(h[jd]) * c, s: q(h[kd]) * c, ms: q(h[ld]) * c }) : (h = zd.exec(a)) ? (c = "-" === h[1] ? -1 : 1, g = { y: Za(h[2], c), M: Za(h[3], c), d: Za(h[4], c), h: Za(h[5], c), m: Za(h[6], c), s: Za(h[7], c), w: Za(h[8], c) }) : null == g ? g = {} : "object" == (typeof g === "undefined" ? "undefined" : _typeof(g)) && ("from" in g || "to" in g) && (e = _a(Da(g.from), Da(g.to)), g = {}, g.ms = e.milliseconds, g.M = e.months), d = new Ha(g), Ia(a) && f(a, "_locale") && (d._locale = a._locale), d;
  }function Za(a, b) {
    var c = a && parseFloat(a.replace(",", "."));return (isNaN(c) ? 0 : c) * b;
  }function $a(a, b) {
    var c = { milliseconds: 0, months: 0 };return c.months = b.month() - a.month() + 12 * (b.year() - a.year()), a.clone().add(c.months, "M").isAfter(b) && --c.months, c.milliseconds = +b - +a.clone().add(c.months, "M"), c;
  }function _a(a, b) {
    var c;return b = La(b, a), a.isBefore(b) ? c = $a(a, b) : (c = $a(b, a), c.milliseconds = -c.milliseconds, c.months = -c.months), c;
  }function ab(a, b) {
    return function (c, d) {
      var e, f;return null === d || isNaN(+d) || (ba(b, "moment()." + b + "(period, number) is deprecated. Please use moment()." + b + "(number, period)."), f = c, c = d, d = f), c = "string" == typeof c ? +c : c, e = Ya(c, d), bb(this, e, a), this;
    };
  }function bb(b, c, d, e) {
    var f = c._milliseconds,
        g = c._days,
        h = c._months;e = null == e ? !0 : e, f && b._d.setTime(+b._d + f * d), g && E(b, "Date", D(b, "Date") + g * d), h && X(b, D(b, "Month") + h * d), e && a.updateOffset(b, g || h);
  }function cb(a, b) {
    var c = a || Da(),
        d = La(c, this).startOf("day"),
        e = this.diff(d, "days", !0),
        f = -6 > e ? "sameElse" : -1 > e ? "lastWeek" : 0 > e ? "lastDay" : 1 > e ? "sameDay" : 2 > e ? "nextDay" : 7 > e ? "nextWeek" : "sameElse";return this.format(b && b[f] || this.localeData().calendar(f, this, Da(c)));
  }function db() {
    return new n(this);
  }function eb(a, b) {
    var c;return b = A("undefined" != typeof b ? b : "millisecond"), "millisecond" === b ? (a = o(a) ? a : Da(a), +this > +a) : (c = o(a) ? +a : +Da(a), c < +this.clone().startOf(b));
  }function fb(a, b) {
    var c;return b = A("undefined" != typeof b ? b : "millisecond"), "millisecond" === b ? (a = o(a) ? a : Da(a), +a > +this) : (c = o(a) ? +a : +Da(a), +this.clone().endOf(b) < c);
  }function gb(a, b, c) {
    return this.isAfter(a, c) && this.isBefore(b, c);
  }function hb(a, b) {
    var c;return b = A(b || "millisecond"), "millisecond" === b ? (a = o(a) ? a : Da(a), +this === +a) : (c = +Da(a), +this.clone().startOf(b) <= c && c <= +this.clone().endOf(b));
  }function ib(a, b, c) {
    var d,
        e,
        f = La(a, this),
        g = 6e4 * (f.utcOffset() - this.utcOffset());return b = A(b), "year" === b || "month" === b || "quarter" === b ? (e = jb(this, f), "quarter" === b ? e /= 3 : "year" === b && (e /= 12)) : (d = this - f, e = "second" === b ? d / 1e3 : "minute" === b ? d / 6e4 : "hour" === b ? d / 36e5 : "day" === b ? (d - g) / 864e5 : "week" === b ? (d - g) / 6048e5 : d), c ? e : p(e);
  }function jb(a, b) {
    var c,
        d,
        e = 12 * (b.year() - a.year()) + (b.month() - a.month()),
        f = a.clone().add(e, "months");return 0 > b - f ? (c = a.clone().add(e - 1, "months"), d = (b - f) / (f - c)) : (c = a.clone().add(e + 1, "months"), d = (b - f) / (c - f)), -(e + d);
  }function kb() {
    return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ");
  }function lb() {
    var a = this.clone().utc();return 0 < a.year() && a.year() <= 9999 ? "function" == typeof Date.prototype.toISOString ? this.toDate().toISOString() : K(a, "YYYY-MM-DD[T]HH:mm:ss.SSS[Z]") : K(a, "YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]");
  }function mb(b) {
    var c = K(this, b || a.defaultFormat);return this.localeData().postformat(c);
  }function nb(a, b) {
    return this.isValid() ? Ya({ to: this, from: a }).locale(this.locale()).humanize(!b) : this.localeData().invalidDate();
  }function ob(a) {
    return this.from(Da(), a);
  }function pb(a, b) {
    return this.isValid() ? Ya({ from: this, to: a }).locale(this.locale()).humanize(!b) : this.localeData().invalidDate();
  }function qb(a) {
    return this.to(Da(), a);
  }function rb(a) {
    var b;return void 0 === a ? this._locale._abbr : (b = y(a), null != b && (this._locale = b), this);
  }function sb() {
    return this._locale;
  }function tb(a) {
    switch (a = A(a)) {case "year":
        this.month(0);case "quarter":case "month":
        this.date(1);case "week":case "isoWeek":case "day":
        this.hours(0);case "hour":
        this.minutes(0);case "minute":
        this.seconds(0);case "second":
        this.milliseconds(0);}return "week" === a && this.weekday(0), "isoWeek" === a && this.isoWeekday(1), "quarter" === a && this.month(3 * Math.floor(this.month() / 3)), this;
  }function ub(a) {
    return a = A(a), void 0 === a || "millisecond" === a ? this : this.startOf(a).add(1, "isoWeek" === a ? "week" : a).subtract(1, "ms");
  }function vb() {
    return +this._d - 6e4 * (this._offset || 0);
  }function wb() {
    return Math.floor(+this / 1e3);
  }function xb() {
    return this._offset ? new Date(+this) : this._d;
  }function yb() {
    var a = this;return [a.year(), a.month(), a.date(), a.hour(), a.minute(), a.second(), a.millisecond()];
  }function zb() {
    var a = this;return { years: a.year(), months: a.month(), date: a.date(), hours: a.hours(), minutes: a.minutes(), seconds: a.seconds(), milliseconds: a.milliseconds() };
  }function Ab() {
    return k(this);
  }function Bb() {
    return g({}, j(this));
  }function Cb() {
    return j(this).overflow;
  }function Db(a, b) {
    H(0, [a, a.length], 0, b);
  }function Eb(a, b, c) {
    return ja(Da([a, 11, 31 + b - c]), b, c).week;
  }function Fb(a) {
    var b = ja(this, this.localeData()._week.dow, this.localeData()._week.doy).year;return null == a ? b : this.add(a - b, "y");
  }function Gb(a) {
    var b = ja(this, 1, 4).year;return null == a ? b : this.add(a - b, "y");
  }function Hb() {
    return Eb(this.year(), 1, 4);
  }function Ib() {
    var a = this.localeData()._week;return Eb(this.year(), a.dow, a.doy);
  }function Jb(a) {
    return null == a ? Math.ceil((this.month() + 1) / 3) : this.month(3 * (a - 1) + this.month() % 3);
  }function Kb(a, b) {
    return "string" != typeof a ? a : isNaN(a) ? (a = b.weekdaysParse(a), "number" == typeof a ? a : null) : parseInt(a, 10);
  }function Lb(a) {
    return this._weekdays[a.day()];
  }function Mb(a) {
    return this._weekdaysShort[a.day()];
  }function Nb(a) {
    return this._weekdaysMin[a.day()];
  }function Ob(a) {
    var b, c, d;for (this._weekdaysParse = this._weekdaysParse || [], b = 0; 7 > b; b++) {
      if (this._weekdaysParse[b] || (c = Da([2e3, 1]).day(b), d = "^" + this.weekdays(c, "") + "|^" + this.weekdaysShort(c, "") + "|^" + this.weekdaysMin(c, ""), this._weekdaysParse[b] = new RegExp(d.replace(".", ""), "i")), this._weekdaysParse[b].test(a)) return b;
    }
  }function Pb(a) {
    var b = this._isUTC ? this._d.getUTCDay() : this._d.getDay();return null != a ? (a = Kb(a, this.localeData()), this.add(a - b, "d")) : b;
  }function Qb(a) {
    var b = (this.day() + 7 - this.localeData()._week.dow) % 7;return null == a ? b : this.add(a - b, "d");
  }function Rb(a) {
    return null == a ? this.day() || 7 : this.day(this.day() % 7 ? a : a - 7);
  }function Sb(a, b) {
    H(a, 0, 0, function () {
      return this.localeData().meridiem(this.hours(), this.minutes(), b);
    });
  }function Tb(a, b) {
    return b._meridiemParse;
  }function Ub(a) {
    return "p" === (a + "").toLowerCase().charAt(0);
  }function Vb(a, b, c) {
    return a > 11 ? c ? "pm" : "PM" : c ? "am" : "AM";
  }function Wb(a, b) {
    b[ld] = q(1e3 * ("0." + a));
  }function Xb() {
    return this._isUTC ? "UTC" : "";
  }function Yb() {
    return this._isUTC ? "Coordinated Universal Time" : "";
  }function Zb(a) {
    return Da(1e3 * a);
  }function $b() {
    return Da.apply(null, arguments).parseZone();
  }function _b(a, b, c) {
    var d = this._calendar[a];return "function" == typeof d ? d.call(b, c) : d;
  }function ac(a) {
    var b = this._longDateFormat[a],
        c = this._longDateFormat[a.toUpperCase()];return b || !c ? b : (this._longDateFormat[a] = c.replace(/MMMM|MM|DD|dddd/g, function (a) {
      return a.slice(1);
    }), this._longDateFormat[a]);
  }function bc() {
    return this._invalidDate;
  }function cc(a) {
    return this._ordinal.replace("%d", a);
  }function dc(a) {
    return a;
  }function ec(a, b, c, d) {
    var e = this._relativeTime[c];return "function" == typeof e ? e(a, b, c, d) : e.replace(/%d/i, a);
  }function fc(a, b) {
    var c = this._relativeTime[a > 0 ? "future" : "past"];return "function" == typeof c ? c(b) : c.replace(/%s/i, b);
  }function gc(a) {
    var b, c;for (c in a) {
      b = a[c], "function" == typeof b ? this[c] = b : this["_" + c] = b;
    }this._ordinalParseLenient = new RegExp(this._ordinalParse.source + "|" + /\d{1,2}/.source);
  }function hc(a, b, c, d) {
    var e = y(),
        f = h().set(d, b);return e[c](f, a);
  }function ic(a, b, c, d, e) {
    if ("number" == typeof a && (b = a, a = void 0), a = a || "", null != b) return hc(a, b, c, e);var f,
        g = [];for (f = 0; d > f; f++) {
      g[f] = hc(a, f, c, e);
    }return g;
  }function jc(a, b) {
    return ic(a, b, "months", 12, "month");
  }function kc(a, b) {
    return ic(a, b, "monthsShort", 12, "month");
  }function lc(a, b) {
    return ic(a, b, "weekdays", 7, "day");
  }function mc(a, b) {
    return ic(a, b, "weekdaysShort", 7, "day");
  }function nc(a, b) {
    return ic(a, b, "weekdaysMin", 7, "day");
  }function oc() {
    var a = this._data;return this._milliseconds = Wd(this._milliseconds), this._days = Wd(this._days), this._months = Wd(this._months), a.milliseconds = Wd(a.milliseconds), a.seconds = Wd(a.seconds), a.minutes = Wd(a.minutes), a.hours = Wd(a.hours), a.months = Wd(a.months), a.years = Wd(a.years), this;
  }function pc(a, b, c, d) {
    var e = Ya(b, c);return a._milliseconds += d * e._milliseconds, a._days += d * e._days, a._months += d * e._months, a._bubble();
  }function qc(a, b) {
    return pc(this, a, b, 1);
  }function rc(a, b) {
    return pc(this, a, b, -1);
  }function sc(a) {
    return 0 > a ? Math.floor(a) : Math.ceil(a);
  }function tc() {
    var a,
        b,
        c,
        d,
        e,
        f = this._milliseconds,
        g = this._days,
        h = this._months,
        i = this._data;return f >= 0 && g >= 0 && h >= 0 || 0 >= f && 0 >= g && 0 >= h || (f += 864e5 * sc(vc(h) + g), g = 0, h = 0), i.milliseconds = f % 1e3, a = p(f / 1e3), i.seconds = a % 60, b = p(a / 60), i.minutes = b % 60, c = p(b / 60), i.hours = c % 24, g += p(c / 24), e = p(uc(g)), h += e, g -= sc(vc(e)), d = p(h / 12), h %= 12, i.days = g, i.months = h, i.years = d, this;
  }function uc(a) {
    return 4800 * a / 146097;
  }function vc(a) {
    return 146097 * a / 4800;
  }function wc(a) {
    var b,
        c,
        d = this._milliseconds;if (a = A(a), "month" === a || "year" === a) return b = this._days + d / 864e5, c = this._months + uc(b), "month" === a ? c : c / 12;switch (b = this._days + Math.round(vc(this._months)), a) {case "week":
        return b / 7 + d / 6048e5;case "day":
        return b + d / 864e5;case "hour":
        return 24 * b + d / 36e5;case "minute":
        return 1440 * b + d / 6e4;case "second":
        return 86400 * b + d / 1e3;case "millisecond":
        return Math.floor(864e5 * b) + d;default:
        throw new Error("Unknown unit " + a);}
  }function xc() {
    return this._milliseconds + 864e5 * this._days + this._months % 12 * 2592e6 + 31536e6 * q(this._months / 12);
  }function yc(a) {
    return function () {
      return this.as(a);
    };
  }function zc(a) {
    return a = A(a), this[a + "s"]();
  }function Ac(a) {
    return function () {
      return this._data[a];
    };
  }function Bc() {
    return p(this.days() / 7);
  }function Cc(a, b, c, d, e) {
    return e.relativeTime(b || 1, !!c, a, d);
  }function Dc(a, b, c) {
    var d = Ya(a).abs(),
        e = ke(d.as("s")),
        f = ke(d.as("m")),
        g = ke(d.as("h")),
        h = ke(d.as("d")),
        i = ke(d.as("M")),
        j = ke(d.as("y")),
        k = e < le.s && ["s", e] || 1 === f && ["m"] || f < le.m && ["mm", f] || 1 === g && ["h"] || g < le.h && ["hh", g] || 1 === h && ["d"] || h < le.d && ["dd", h] || 1 === i && ["M"] || i < le.M && ["MM", i] || 1 === j && ["y"] || ["yy", j];return k[2] = b, k[3] = +a > 0, k[4] = c, Cc.apply(null, k);
  }function Ec(a, b) {
    return void 0 === le[a] ? !1 : void 0 === b ? le[a] : (le[a] = b, !0);
  }function Fc(a) {
    var b = this.localeData(),
        c = Dc(this, !a, b);return a && (c = b.pastFuture(+this, c)), b.postformat(c);
  }function Gc() {
    var a,
        b,
        c,
        d = me(this._milliseconds) / 1e3,
        e = me(this._days),
        f = me(this._months);a = p(d / 60), b = p(a / 60), d %= 60, a %= 60, c = p(f / 12), f %= 12;var g = c,
        h = f,
        i = e,
        j = b,
        k = a,
        l = d,
        m = this.asSeconds();return m ? (0 > m ? "-" : "") + "P" + (g ? g + "Y" : "") + (h ? h + "M" : "") + (i ? i + "D" : "") + (j || k || l ? "T" : "") + (j ? j + "H" : "") + (k ? k + "M" : "") + (l ? l + "S" : "") : "P0D";
  }var Hc,
      Ic,
      Jc = a.momentProperties = [],
      Kc = !1,
      Lc = {},
      Mc = {},
      Nc = /(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,
      Oc = /(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,
      Pc = {},
      Qc = {},
      Rc = /\d/,
      Sc = /\d\d/,
      Tc = /\d{3}/,
      Uc = /\d{4}/,
      Vc = /[+-]?\d{6}/,
      Wc = /\d\d?/,
      Xc = /\d{1,3}/,
      Yc = /\d{1,4}/,
      Zc = /[+-]?\d{1,6}/,
      $c = /\d+/,
      _c = /[+-]?\d+/,
      ad = /Z|[+-]\d\d:?\d\d/gi,
      bd = /[+-]?\d+(\.\d{1,3})?/,
      cd = /[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,
      dd = {},
      ed = {},
      fd = 0,
      gd = 1,
      hd = 2,
      id = 3,
      jd = 4,
      kd = 5,
      ld = 6;H("M", ["MM", 2], "Mo", function () {
    return this.month() + 1;
  }), H("MMM", 0, 0, function (a) {
    return this.localeData().monthsShort(this, a);
  }), H("MMMM", 0, 0, function (a) {
    return this.localeData().months(this, a);
  }), z("month", "M"), N("M", Wc), N("MM", Wc, Sc), N("MMM", cd), N("MMMM", cd), Q(["M", "MM"], function (a, b) {
    b[gd] = q(a) - 1;
  }), Q(["MMM", "MMMM"], function (a, b, c, d) {
    var e = c._locale.monthsParse(a, d, c._strict);null != e ? b[gd] = e : j(c).invalidMonth = a;
  });var md = "January_February_March_April_May_June_July_August_September_October_November_December".split("_"),
      nd = "Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),
      od = {};a.suppressDeprecationWarnings = !1;var pd = /^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,
      qd = [["YYYYYY-MM-DD", /[+-]\d{6}-\d{2}-\d{2}/], ["YYYY-MM-DD", /\d{4}-\d{2}-\d{2}/], ["GGGG-[W]WW-E", /\d{4}-W\d{2}-\d/], ["GGGG-[W]WW", /\d{4}-W\d{2}/], ["YYYY-DDD", /\d{4}-\d{3}/]],
      rd = [["HH:mm:ss.SSSS", /(T| )\d\d:\d\d:\d\d\.\d+/], ["HH:mm:ss", /(T| )\d\d:\d\d:\d\d/], ["HH:mm", /(T| )\d\d:\d\d/], ["HH", /(T| )\d\d/]],
      sd = /^\/?Date\((\-?\d+)/i;a.createFromInputFallback = aa("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.", function (a) {
    a._d = new Date(a._i + (a._useUTC ? " UTC" : ""));
  }), H(0, ["YY", 2], 0, function () {
    return this.year() % 100;
  }), H(0, ["YYYY", 4], 0, "year"), H(0, ["YYYYY", 5], 0, "year"), H(0, ["YYYYYY", 6, !0], 0, "year"), z("year", "y"), N("Y", _c), N("YY", Wc, Sc), N("YYYY", Yc, Uc), N("YYYYY", Zc, Vc), N("YYYYYY", Zc, Vc), Q(["YYYYY", "YYYYYY"], fd), Q("YYYY", function (b, c) {
    c[fd] = 2 === b.length ? a.parseTwoDigitYear(b) : q(b);
  }), Q("YY", function (b, c) {
    c[fd] = a.parseTwoDigitYear(b);
  }), a.parseTwoDigitYear = function (a) {
    return q(a) + (q(a) > 68 ? 1900 : 2e3);
  };var td = C("FullYear", !1);H("w", ["ww", 2], "wo", "week"), H("W", ["WW", 2], "Wo", "isoWeek"), z("week", "w"), z("isoWeek", "W"), N("w", Wc), N("ww", Wc, Sc), N("W", Wc), N("WW", Wc, Sc), R(["w", "ww", "W", "WW"], function (a, b, c, d) {
    b[d.substr(0, 1)] = q(a);
  });var ud = { dow: 0, doy: 6 };H("DDD", ["DDDD", 3], "DDDo", "dayOfYear"), z("dayOfYear", "DDD"), N("DDD", Xc), N("DDDD", Tc), Q(["DDD", "DDDD"], function (a, b, c) {
    c._dayOfYear = q(a);
  }), a.ISO_8601 = function () {};var vd = aa("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548", function () {
    var a = Da.apply(null, arguments);return this > a ? this : a;
  }),
      wd = aa("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548", function () {
    var a = Da.apply(null, arguments);return a > this ? this : a;
  });Ja("Z", ":"), Ja("ZZ", ""), N("Z", ad), N("ZZ", ad), Q(["Z", "ZZ"], function (a, b, c) {
    c._useUTC = !0, c._tzm = Ka(a);
  });var xd = /([\+\-]|\d\d)/gi;a.updateOffset = function () {};var yd = /(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,
      zd = /^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/;Ya.fn = Ha.prototype;var Ad = ab(1, "add"),
      Bd = ab(-1, "subtract");a.defaultFormat = "YYYY-MM-DDTHH:mm:ssZ";var Cd = aa("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.", function (a) {
    return void 0 === a ? this.localeData() : this.locale(a);
  });H(0, ["gg", 2], 0, function () {
    return this.weekYear() % 100;
  }), H(0, ["GG", 2], 0, function () {
    return this.isoWeekYear() % 100;
  }), Db("gggg", "weekYear"), Db("ggggg", "weekYear"), Db("GGGG", "isoWeekYear"), Db("GGGGG", "isoWeekYear"), z("weekYear", "gg"), z("isoWeekYear", "GG"), N("G", _c), N("g", _c), N("GG", Wc, Sc), N("gg", Wc, Sc), N("GGGG", Yc, Uc), N("gggg", Yc, Uc), N("GGGGG", Zc, Vc), N("ggggg", Zc, Vc), R(["gggg", "ggggg", "GGGG", "GGGGG"], function (a, b, c, d) {
    b[d.substr(0, 2)] = q(a);
  }), R(["gg", "GG"], function (b, c, d, e) {
    c[e] = a.parseTwoDigitYear(b);
  }), H("Q", 0, 0, "quarter"), z("quarter", "Q"), N("Q", Rc), Q("Q", function (a, b) {
    b[gd] = 3 * (q(a) - 1);
  }), H("D", ["DD", 2], "Do", "date"), z("date", "D"), N("D", Wc), N("DD", Wc, Sc), N("Do", function (a, b) {
    return a ? b._ordinalParse : b._ordinalParseLenient;
  }), Q(["D", "DD"], hd), Q("Do", function (a, b) {
    b[hd] = q(a.match(Wc)[0], 10);
  });var Dd = C("Date", !0);H("d", 0, "do", "day"), H("dd", 0, 0, function (a) {
    return this.localeData().weekdaysMin(this, a);
  }), H("ddd", 0, 0, function (a) {
    return this.localeData().weekdaysShort(this, a);
  }), H("dddd", 0, 0, function (a) {
    return this.localeData().weekdays(this, a);
  }), H("e", 0, 0, "weekday"), H("E", 0, 0, "isoWeekday"), z("day", "d"), z("weekday", "e"), z("isoWeekday", "E"), N("d", Wc), N("e", Wc), N("E", Wc), N("dd", cd), N("ddd", cd), N("dddd", cd), R(["dd", "ddd", "dddd"], function (a, b, c) {
    var d = c._locale.weekdaysParse(a);null != d ? b.d = d : j(c).invalidWeekday = a;
  }), R(["d", "e", "E"], function (a, b, c, d) {
    b[d] = q(a);
  });var Ed = "Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),
      Fd = "Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),
      Gd = "Su_Mo_Tu_We_Th_Fr_Sa".split("_");H("H", ["HH", 2], 0, "hour"), H("h", ["hh", 2], 0, function () {
    return this.hours() % 12 || 12;
  }), Sb("a", !0), Sb("A", !1), z("hour", "h"), N("a", Tb), N("A", Tb), N("H", Wc), N("h", Wc), N("HH", Wc, Sc), N("hh", Wc, Sc), Q(["H", "HH"], id), Q(["a", "A"], function (a, b, c) {
    c._isPm = c._locale.isPM(a), c._meridiem = a;
  }), Q(["h", "hh"], function (a, b, c) {
    b[id] = q(a), j(c).bigHour = !0;
  });var Hd = /[ap]\.?m?\.?/i,
      Id = C("Hours", !0);H("m", ["mm", 2], 0, "minute"), z("minute", "m"), N("m", Wc), N("mm", Wc, Sc), Q(["m", "mm"], jd);var Jd = C("Minutes", !1);H("s", ["ss", 2], 0, "second"), z("second", "s"), N("s", Wc), N("ss", Wc, Sc), Q(["s", "ss"], kd);var Kd = C("Seconds", !1);H("S", 0, 0, function () {
    return ~~(this.millisecond() / 100);
  }), H(0, ["SS", 2], 0, function () {
    return ~~(this.millisecond() / 10);
  }), H(0, ["SSS", 3], 0, "millisecond"), H(0, ["SSSS", 4], 0, function () {
    return 10 * this.millisecond();
  }), H(0, ["SSSSS", 5], 0, function () {
    return 100 * this.millisecond();
  }), H(0, ["SSSSSS", 6], 0, function () {
    return 1e3 * this.millisecond();
  }), H(0, ["SSSSSSS", 7], 0, function () {
    return 1e4 * this.millisecond();
  }), H(0, ["SSSSSSSS", 8], 0, function () {
    return 1e5 * this.millisecond();
  }), H(0, ["SSSSSSSSS", 9], 0, function () {
    return 1e6 * this.millisecond();
  }), z("millisecond", "ms"), N("S", Xc, Rc), N("SS", Xc, Sc), N("SSS", Xc, Tc);var Ld;for (Ld = "SSSS"; Ld.length <= 9; Ld += "S") {
    N(Ld, $c);
  }for (Ld = "S"; Ld.length <= 9; Ld += "S") {
    Q(Ld, Wb);
  }var Md = C("Milliseconds", !1);H("z", 0, 0, "zoneAbbr"), H("zz", 0, 0, "zoneName");var Nd = n.prototype;Nd.add = Ad, Nd.calendar = cb, Nd.clone = db, Nd.diff = ib, Nd.endOf = ub, Nd.format = mb, Nd.from = nb, Nd.fromNow = ob, Nd.to = pb, Nd.toNow = qb, Nd.get = F, Nd.invalidAt = Cb, Nd.isAfter = eb, Nd.isBefore = fb, Nd.isBetween = gb, Nd.isSame = hb, Nd.isValid = Ab, Nd.lang = Cd, Nd.locale = rb, Nd.localeData = sb, Nd.max = wd, Nd.min = vd, Nd.parsingFlags = Bb, Nd.set = F, Nd.startOf = tb, Nd.subtract = Bd, Nd.toArray = yb, Nd.toObject = zb, Nd.toDate = xb, Nd.toISOString = lb, Nd.toJSON = lb, Nd.toString = kb, Nd.unix = wb, Nd.valueOf = vb, Nd.year = td, Nd.isLeapYear = ia, Nd.weekYear = Fb, Nd.isoWeekYear = Gb, Nd.quarter = Nd.quarters = Jb, Nd.month = Y, Nd.daysInMonth = Z, Nd.week = Nd.weeks = na, Nd.isoWeek = Nd.isoWeeks = oa, Nd.weeksInYear = Ib, Nd.isoWeeksInYear = Hb, Nd.date = Dd, Nd.day = Nd.days = Pb, Nd.weekday = Qb, Nd.isoWeekday = Rb, Nd.dayOfYear = qa, Nd.hour = Nd.hours = Id, Nd.minute = Nd.minutes = Jd, Nd.second = Nd.seconds = Kd, Nd.millisecond = Nd.milliseconds = Md, Nd.utcOffset = Na, Nd.utc = Pa, Nd.local = Qa, Nd.parseZone = Ra, Nd.hasAlignedHourOffset = Sa, Nd.isDST = Ta, Nd.isDSTShifted = Ua, Nd.isLocal = Va, Nd.isUtcOffset = Wa, Nd.isUtc = Xa, Nd.isUTC = Xa, Nd.zoneAbbr = Xb, Nd.zoneName = Yb, Nd.dates = aa("dates accessor is deprecated. Use date instead.", Dd), Nd.months = aa("months accessor is deprecated. Use month instead", Y), Nd.years = aa("years accessor is deprecated. Use year instead", td), Nd.zone = aa("moment().zone is deprecated, use moment().utcOffset instead. https://github.com/moment/moment/issues/1779", Oa);var Od = Nd,
      Pd = { sameDay: "[Today at] LT", nextDay: "[Tomorrow at] LT", nextWeek: "dddd [at] LT", lastDay: "[Yesterday at] LT", lastWeek: "[Last] dddd [at] LT", sameElse: "L" },
      Qd = { LTS: "h:mm:ss A", LT: "h:mm A", L: "MM/DD/YYYY", LL: "MMMM D, YYYY", LLL: "MMMM D, YYYY h:mm A", LLLL: "dddd, MMMM D, YYYY h:mm A" },
      Rd = "Invalid date",
      Sd = "%d",
      Td = /\d{1,2}/,
      Ud = { future: "in %s", past: "%s ago", s: "a few seconds", m: "a minute", mm: "%d minutes", h: "an hour", hh: "%d hours", d: "a day", dd: "%d days", M: "a month", MM: "%d months", y: "a year", yy: "%d years" },
      Vd = s.prototype;Vd._calendar = Pd, Vd.calendar = _b, Vd._longDateFormat = Qd, Vd.longDateFormat = ac, Vd._invalidDate = Rd, Vd.invalidDate = bc, Vd._ordinal = Sd, Vd.ordinal = cc, Vd._ordinalParse = Td, Vd.preparse = dc, Vd.postformat = dc, Vd._relativeTime = Ud, Vd.relativeTime = ec, Vd.pastFuture = fc, Vd.set = gc, Vd.months = U, Vd._months = md, Vd.monthsShort = V, Vd._monthsShort = nd, Vd.monthsParse = W, Vd.week = ka, Vd._week = ud, Vd.firstDayOfYear = ma, Vd.firstDayOfWeek = la, Vd.weekdays = Lb, Vd._weekdays = Ed, Vd.weekdaysMin = Nb, Vd._weekdaysMin = Gd, Vd.weekdaysShort = Mb, Vd._weekdaysShort = Fd, Vd.weekdaysParse = Ob, Vd.isPM = Ub, Vd._meridiemParse = Hd, Vd.meridiem = Vb, w("en", { ordinalParse: /\d{1,2}(th|st|nd|rd)/, ordinal: function ordinal(a) {
      var b = a % 10,
          c = 1 === q(a % 100 / 10) ? "th" : 1 === b ? "st" : 2 === b ? "nd" : 3 === b ? "rd" : "th";return a + c;
    } }), a.lang = aa("moment.lang is deprecated. Use moment.locale instead.", w), a.langData = aa("moment.langData is deprecated. Use moment.localeData instead.", y);var Wd = Math.abs,
      Xd = yc("ms"),
      Yd = yc("s"),
      Zd = yc("m"),
      $d = yc("h"),
      _d = yc("d"),
      ae = yc("w"),
      be = yc("M"),
      ce = yc("y"),
      de = Ac("milliseconds"),
      ee = Ac("seconds"),
      fe = Ac("minutes"),
      ge = Ac("hours"),
      he = Ac("days"),
      ie = Ac("months"),
      je = Ac("years"),
      ke = Math.round,
      le = { s: 45, m: 45, h: 22, d: 26, M: 11 },
      me = Math.abs,
      ne = Ha.prototype;ne.abs = oc, ne.add = qc, ne.subtract = rc, ne.as = wc, ne.asMilliseconds = Xd, ne.asSeconds = Yd, ne.asMinutes = Zd, ne.asHours = $d, ne.asDays = _d, ne.asWeeks = ae, ne.asMonths = be, ne.asYears = ce, ne.valueOf = xc, ne._bubble = tc, ne.get = zc, ne.milliseconds = de, ne.seconds = ee, ne.minutes = fe, ne.hours = ge, ne.days = he, ne.weeks = Bc, ne.months = ie, ne.years = je, ne.humanize = Fc, ne.toISOString = Gc, ne.toString = Gc, ne.toJSON = Gc, ne.locale = rb, ne.localeData = sb, ne.toIsoString = aa("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)", Gc), ne.lang = Cd, H("X", 0, 0, "unix"), H("x", 0, 0, "valueOf"), N("x", _c), N("X", bd), Q("X", function (a, b, c) {
    c._d = new Date(1e3 * parseFloat(a, 10));
  }), Q("x", function (a, b, c) {
    c._d = new Date(q(a));
  }), a.version = "2.10.6", b(Da), a.fn = Od, a.min = Fa, a.max = Ga, a.utc = h, a.unix = Zb, a.months = jc, a.isDate = d, a.locale = w, a.invalid = l, a.duration = Ya, a.isMoment = o, a.weekdays = lc, a.parseZone = $b, a.localeData = y, a.isDuration = Ia, a.monthsShort = kc, a.weekdaysMin = nc, a.defineLocale = x, a.weekdaysShort = mc, a.normalizeUnits = A, a.relativeTimeThreshold = Ec;var oe = a;return oe;
});
/* <<< file end: js/node_modules/moment/min/moment.min.js */

//# map link was there [moment.min.js.map]
/* >>> file start: js/lib/textinputs_jquery.js */
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/**
 * @license Rangy Inputs, a jQuery plug-in for selection and caret manipulation within textareas and text inputs.
 *
 * https://github.com/timdown/rangyinputs
 *
 * For range and selection features for contenteditable, see Rangy.

 * http://code.google.com/p/rangy/
 *
 * Depends on jQuery 1.0 or later.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.1
 * Build date: 31 March 2013
 */
(function (a) {
  function l(a, b) {
    var c = _typeof(a[b]);return "function" === c || !("object" != c || !a[b]) || "unknown" == c;
  }function m(a, c) {
    return _typeof(a[c]) != b;
  }function n(a, b) {
    return !("object" != _typeof(a[b]) || !a[b]);
  }function o(a) {
    window.console && window.console.log && window.console.log("RangyInputs not supported in your browser. Reason: " + a);
  }function p(a, c, d) {
    return 0 > c && (c += a.value.length), (typeof d === "undefined" ? "undefined" : _typeof(d)) == b && (d = c), 0 > d && (d += a.value.length), { start: c, end: d };
  }function q(a, b, c) {
    return { start: b, end: c, length: c - b, text: a.value.slice(b, c) };
  }function r() {
    return n(document, "body") ? document.body : document.getElementsByTagName("body")[0];
  }var c,
      d,
      e,
      f,
      g,
      h,
      i,
      j,
      k,
      b = "undefined";a(document).ready(function () {
    function v(a, b) {
      return function () {
        var c = this.jquery ? this[0] : this,
            d = c.nodeName.toLowerCase();if (1 == c.nodeType && ("textarea" == d || "input" == d && "text" == c.type)) {
          var e = [c].concat(Array.prototype.slice.call(arguments)),
              f = a.apply(this, e);if (!b) return f;
        }return b ? this : void 0;
      };
    }var s = document.createElement("textarea");if (r().appendChild(s), m(s, "selectionStart") && m(s, "selectionEnd")) c = function c(a) {
      var b = a.selectionStart,
          c = a.selectionEnd;return q(a, b, c);
    }, d = function d(a, b, c) {
      var d = p(a, b, c);a.selectionStart = d.start, a.selectionEnd = d.end;
    }, k = function k(a, b) {
      b ? a.selectionEnd = a.selectionStart : a.selectionStart = a.selectionEnd;
    };else {
      if (!(l(s, "createTextRange") && n(document, "selection") && l(document.selection, "createRange"))) return r().removeChild(s), o("No means of finding text input caret position"), void 0;c = function c(a) {
        var d,
            e,
            f,
            g,
            b = 0,
            c = 0,
            h = document.selection.createRange();return h && h.parentElement() == a && (f = a.value.length, d = a.value.replace(/\r\n/g, "\n"), e = a.createTextRange(), e.moveToBookmark(h.getBookmark()), g = a.createTextRange(), g.collapse(!1), e.compareEndPoints("StartToEnd", g) > -1 ? b = c = f : (b = -e.moveStart("character", -f), b += d.slice(0, b).split("\n").length - 1, e.compareEndPoints("EndToEnd", g) > -1 ? c = f : (c = -e.moveEnd("character", -f), c += d.slice(0, c).split("\n").length - 1))), q(a, b, c);
      };var t = function t(a, b) {
        return b - (a.value.slice(0, b).split("\r\n").length - 1);
      };d = function d(a, b, c) {
        var d = p(a, b, c),
            e = a.createTextRange(),
            f = t(a, d.start);e.collapse(!0), d.start == d.end ? e.move("character", f) : (e.moveEnd("character", t(a, d.end)), e.moveStart("character", f)), e.select();
      }, k = function k(a, b) {
        var c = document.selection.createRange();c.collapse(b), c.select();
      };
    }r().removeChild(s), f = function f(a, b, c, e) {
      var f;b != c && (f = a.value, a.value = f.slice(0, b) + f.slice(c)), e && d(a, b, b);
    }, e = function e(a) {
      var b = c(a);f(a, b.start, b.end, !0);
    }, j = function j(a) {
      var e,
          b = c(a);return b.start != b.end && (e = a.value, a.value = e.slice(0, b.start) + e.slice(b.end)), d(a, b.start, b.start), b.text;
    };var u = function u(a, b, c, e) {
      var f = b + c.length;switch (e = "string" == typeof e ? e.toLowerCase() : "") {case "collapsetostart":
          d(a, b, b);break;case "collapsetoend":
          d(a, f, f);break;case "select":
          d(a, b, f);}
    };g = function g(a, b, c, d) {
      var e = a.value;a.value = e.slice(0, c) + b + e.slice(c), "boolean" == typeof d && (d = d ? "collapseToEnd" : ""), u(a, c, b, d);
    }, h = function h(a, b, d) {
      var e = c(a),
          f = a.value;a.value = f.slice(0, e.start) + b + f.slice(e.end), u(a, e.start, b, d || "collapseToEnd");
    }, i = function i(a, d, e, f) {
      (typeof e === "undefined" ? "undefined" : _typeof(e)) == b && (e = d);var g = c(a),
          h = a.value;a.value = h.slice(0, g.start) + d + g.text + e + h.slice(g.end);var i = g.start + d.length;u(a, i, g.text, f || "select");
    }, a.fn.extend({ getSelection: v(c, !1), setSelection: v(d, !0), collapseSelection: v(k, !0), deleteSelectedText: v(e, !0), deleteText: v(f, !0), extractSelectedText: v(j, !1), insertText: v(g, !0), replaceSelectedText: v(h, !0), surroundSelectedText: v(i, !0) });
  });
})(jQuery);
/* <<< file end: js/lib/textinputs_jquery.js */

//# map link was there [textinputs_jquery.js.map]
/* >>> file start: js/editor/editor.js */
//= require js/lib/textinputs_jquery.js
//= require js/core/angular/ljTour.js

/*
 * For all text manipulation Rangyinputs is used
 *
 * https://code.google.com/p/rangyinputs/
 */

(function ($) {

  'use strict';

  angular.module('Editor', ['LJ.Tour']).factory('Editor', function () {
    var factory = {};

    factory.getSelectedText = function () {
      var textarea = $('#body');

      return textarea.getSelection().text;
    };

    factory.htmlMode = function () {
      return $('#body').is(':visible');
    };

    /*
     * The main method to insert something to editor.
     * It handles HTML mode directly and sends events
     * to the visual editor plugins to handle.
     *
     * @param {String} type    Event type
     * @param {String} content Content for HTML mode
     * @param {Object} [data]  Data for visual editor
     */
    factory.insertContent = function (type, content, data, additional) {
      var textarea = $('#body'),

      /* selector is used on update.bml and also s2 commenting form */
      selection;

      LJ.Event.trigger('contentInsert');
      if (factory.htmlMode()) {
        var parts = content.split('{caret}');

        textarea.surroundSelectedText(parts[0], parts.length > 1 ? parts[parts.length - 1] || '' : '').trigger('input');

        selection = textarea.getSelection();

        // use text between {caret} if selection is empty,
        // move caret to the end
        if (parts.length === 3 && selection.length === 0) {
          textarea.replaceSelectedText(parts[1], 'collapseToEnd').setSelection(selection.start + parts[1].length + parts[parts.length - 1].length);
        }

        LJ.Event.trigger(type + '_htmlMode_response', content, data, additional);
        textarea.focus();
      } else {
        // @TODO: make the events consistent, selectedColor => color_response

        if (type === 'color') {
          return LJ.Event.trigger('selectedColor', data);
        }

        LJ.Event.trigger(type + '_response', data || content, additional);
      }
    };

    return factory;
  }).controller('EditorCtrl', ['$scope', 'Editor', 'Bubble', '$timeout', function ($scope, Editor, Bubble, $timeout) {

    var basicFormatting = {
      bold: '<b>{caret}</b>',
      italic: '<i>{caret}</i>',
      underline: '<u>{caret}</u>',
      strikethrough: '<s>{caret}</s>'
    };

    $scope.formattingAction = function (event, type) {
      event.preventDefault();

      if (basicFormatting[type]) {
        Editor.insertContent(type, basicFormatting[type]);
      }
    };

    $scope.userClick = function (event, type) {
      var selected = Editor.getSelectedText(),
          rxUsername = /^[A-Za-z0-9_\-]+$/;

      event.preventDefault();

      if (rxUsername.test(selected)) {
        Editor.insertContent(type, '<lj user="{caret}" />');
      } else {
        $timeout(function () {
          Bubble.open('user');
        });
      }
    };
  }]);
})(jQuery);
/* <<< file end: js/editor/editor.js */

//# map link was there [editor.js.map]
/* >>> file start: js/lib/jquery-ui/jquery.ui.sortable.min.js */
/*! jQuery UI - v1.8.24 - 2012-09-28
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.sortable.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function (a, b) {
  a.widget("ui.sortable", a.ui.mouse, { widgetEventPrefix: "sort", ready: !1, options: { appendTo: "parent", axis: !1, connectWith: !1, containment: !1, cursor: "auto", cursorAt: !1, dropOnEmpty: !0, forcePlaceholderSize: !1, forceHelperSize: !1, grid: !1, handle: !1, helper: "original", items: "> *", opacity: !1, placeholder: !1, revert: !1, scroll: !0, scrollSensitivity: 20, scrollSpeed: 20, scope: "default", tolerance: "intersect", zIndex: 1e3 }, _create: function _create() {
      var a = this.options;this.containerCache = {}, this.element.addClass("ui-sortable"), this.refresh(), this.floating = this.items.length ? a.axis === "x" || /left|right/.test(this.items[0].item.css("float")) || /inline|table-cell/.test(this.items[0].item.css("display")) : !1, this.offset = this.element.offset(), this._mouseInit(), this.ready = !0;
    }, destroy: function destroy() {
      a.Widget.prototype.destroy.call(this), this.element.removeClass("ui-sortable ui-sortable-disabled"), this._mouseDestroy();for (var b = this.items.length - 1; b >= 0; b--) {
        this.items[b].item.removeData(this.widgetName + "-item");
      }return this;
    }, _setOption: function _setOption(b, c) {
      b === "disabled" ? (this.options[b] = c, this.widget()[c ? "addClass" : "removeClass"]("ui-sortable-disabled")) : a.Widget.prototype._setOption.apply(this, arguments);
    }, _mouseCapture: function _mouseCapture(b, c) {
      var d = this;if (this.reverting) return !1;if (this.options.disabled || this.options.type == "static") return !1;this._refreshItems(b);var e = null,
          f = this,
          g = a(b.target).parents().each(function () {
        if (a.data(this, d.widgetName + "-item") == f) return e = a(this), !1;
      });a.data(b.target, d.widgetName + "-item") == f && (e = a(b.target));if (!e) return !1;if (this.options.handle && !c) {
        var h = !1;a(this.options.handle, e).find("*").andSelf().each(function () {
          this == b.target && (h = !0);
        });if (!h) return !1;
      }return this.currentItem = e, this._removeCurrentsFromItems(), !0;
    }, _mouseStart: function _mouseStart(b, c, d) {
      var e = this.options,
          f = this;this.currentContainer = this, this.refreshPositions(), this.helper = this._createHelper(b), this._cacheHelperProportions(), this._cacheMargins(), this.scrollParent = this.helper.scrollParent(), this.offset = this.currentItem.offset(), this.offset = { top: this.offset.top - this.margins.top, left: this.offset.left - this.margins.left }, a.extend(this.offset, { click: { left: b.pageX - this.offset.left, top: b.pageY - this.offset.top }, parent: this._getParentOffset(), relative: this._getRelativeOffset() }), this.helper.css("position", "absolute"), this.cssPosition = this.helper.css("position"), this.originalPosition = this._generatePosition(b), this.originalPageX = b.pageX, this.originalPageY = b.pageY, e.cursorAt && this._adjustOffsetFromHelper(e.cursorAt), this.domPosition = { prev: this.currentItem.prev()[0], parent: this.currentItem.parent()[0] }, this.helper[0] != this.currentItem[0] && this.currentItem.hide(), this._createPlaceholder(), e.containment && this._setContainment(), e.cursor && (a("body").css("cursor") && (this._storedCursor = a("body").css("cursor")), a("body").css("cursor", e.cursor)), e.opacity && (this.helper.css("opacity") && (this._storedOpacity = this.helper.css("opacity")), this.helper.css("opacity", e.opacity)), e.zIndex && (this.helper.css("zIndex") && (this._storedZIndex = this.helper.css("zIndex")), this.helper.css("zIndex", e.zIndex)), this.scrollParent[0] != document && this.scrollParent[0].tagName != "HTML" && (this.overflowOffset = this.scrollParent.offset()), this._trigger("start", b, this._uiHash()), this._preserveHelperProportions || this._cacheHelperProportions();if (!d) for (var g = this.containers.length - 1; g >= 0; g--) {
        this.containers[g]._trigger("activate", b, f._uiHash(this));
      }return a.ui.ddmanager && (a.ui.ddmanager.current = this), a.ui.ddmanager && !e.dropBehaviour && a.ui.ddmanager.prepareOffsets(this, b), this.dragging = !0, this.helper.addClass("ui-sortable-helper"), this._mouseDrag(b), !0;
    }, _mouseDrag: function _mouseDrag(b) {
      this.position = this._generatePosition(b), this.positionAbs = this._convertPositionTo("absolute"), this.lastPositionAbs || (this.lastPositionAbs = this.positionAbs);if (this.options.scroll) {
        var c = this.options,
            d = !1;this.scrollParent[0] != document && this.scrollParent[0].tagName != "HTML" ? (this.overflowOffset.top + this.scrollParent[0].offsetHeight - b.pageY < c.scrollSensitivity ? this.scrollParent[0].scrollTop = d = this.scrollParent[0].scrollTop + c.scrollSpeed : b.pageY - this.overflowOffset.top < c.scrollSensitivity && (this.scrollParent[0].scrollTop = d = this.scrollParent[0].scrollTop - c.scrollSpeed), this.overflowOffset.left + this.scrollParent[0].offsetWidth - b.pageX < c.scrollSensitivity ? this.scrollParent[0].scrollLeft = d = this.scrollParent[0].scrollLeft + c.scrollSpeed : b.pageX - this.overflowOffset.left < c.scrollSensitivity && (this.scrollParent[0].scrollLeft = d = this.scrollParent[0].scrollLeft - c.scrollSpeed)) : (b.pageY - a(document).scrollTop() < c.scrollSensitivity ? d = a(document).scrollTop(a(document).scrollTop() - c.scrollSpeed) : a(window).height() - (b.pageY - a(document).scrollTop()) < c.scrollSensitivity && (d = a(document).scrollTop(a(document).scrollTop() + c.scrollSpeed)), b.pageX - a(document).scrollLeft() < c.scrollSensitivity ? d = a(document).scrollLeft(a(document).scrollLeft() - c.scrollSpeed) : a(window).width() - (b.pageX - a(document).scrollLeft()) < c.scrollSensitivity && (d = a(document).scrollLeft(a(document).scrollLeft() + c.scrollSpeed))), d !== !1 && a.ui.ddmanager && !c.dropBehaviour && a.ui.ddmanager.prepareOffsets(this, b);
      }this.positionAbs = this._convertPositionTo("absolute");if (!this.options.axis || this.options.axis != "y") this.helper[0].style.left = this.position.left + "px";if (!this.options.axis || this.options.axis != "x") this.helper[0].style.top = this.position.top + "px";for (var e = this.items.length - 1; e >= 0; e--) {
        var f = this.items[e],
            g = f.item[0],
            h = this._intersectsWithPointer(f);if (!h) continue;if (f.instance !== this.currentContainer) continue;if (g != this.currentItem[0] && this.placeholder[h == 1 ? "next" : "prev"]()[0] != g && !a.ui.contains(this.placeholder[0], g) && (this.options.type == "semi-dynamic" ? !a.ui.contains(this.element[0], g) : !0)) {
          this.direction = h == 1 ? "down" : "up";if (this.options.tolerance == "pointer" || this._intersectsWithSides(f)) this._rearrange(b, f);else break;this._trigger("change", b, this._uiHash());break;
        }
      }return this._contactContainers(b), a.ui.ddmanager && a.ui.ddmanager.drag(this, b), this._trigger("sort", b, this._uiHash()), this.lastPositionAbs = this.positionAbs, !1;
    }, _mouseStop: function _mouseStop(b, c) {
      if (!b) return;a.ui.ddmanager && !this.options.dropBehaviour && a.ui.ddmanager.drop(this, b);if (this.options.revert) {
        var d = this,
            e = d.placeholder.offset();d.reverting = !0, a(this.helper).animate({ left: e.left - this.offset.parent.left - d.margins.left + (this.offsetParent[0] == document.body ? 0 : this.offsetParent[0].scrollLeft), top: e.top - this.offset.parent.top - d.margins.top + (this.offsetParent[0] == document.body ? 0 : this.offsetParent[0].scrollTop) }, parseInt(this.options.revert, 10) || 500, function () {
          d._clear(b);
        });
      } else this._clear(b, c);return !1;
    }, cancel: function cancel() {
      var b = this;if (this.dragging) {
        this._mouseUp({ target: null }), this.options.helper == "original" ? this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper") : this.currentItem.show();for (var c = this.containers.length - 1; c >= 0; c--) {
          this.containers[c]._trigger("deactivate", null, b._uiHash(this)), this.containers[c].containerCache.over && (this.containers[c]._trigger("out", null, b._uiHash(this)), this.containers[c].containerCache.over = 0);
        }
      }return this.placeholder && (this.placeholder[0].parentNode && this.placeholder[0].parentNode.removeChild(this.placeholder[0]), this.options.helper != "original" && this.helper && this.helper[0].parentNode && this.helper.remove(), a.extend(this, { helper: null, dragging: !1, reverting: !1, _noFinalSort: null }), this.domPosition.prev ? a(this.domPosition.prev).after(this.currentItem) : a(this.domPosition.parent).prepend(this.currentItem)), this;
    }, serialize: function serialize(b) {
      var c = this._getItemsAsjQuery(b && b.connected),
          d = [];return b = b || {}, a(c).each(function () {
        var c = (a(b.item || this).attr(b.attribute || "id") || "").match(b.expression || /(.+)[-=_](.+)/);c && d.push((b.key || c[1] + "[]") + "=" + (b.key && b.expression ? c[1] : c[2]));
      }), !d.length && b.key && d.push(b.key + "="), d.join("&");
    }, toArray: function toArray(b) {
      var c = this._getItemsAsjQuery(b && b.connected),
          d = [];return b = b || {}, c.each(function () {
        d.push(a(b.item || this).attr(b.attribute || "id") || "");
      }), d;
    }, _intersectsWith: function _intersectsWith(a) {
      var b = this.positionAbs.left,
          c = b + this.helperProportions.width,
          d = this.positionAbs.top,
          e = d + this.helperProportions.height,
          f = a.left,
          g = f + a.width,
          h = a.top,
          i = h + a.height,
          j = this.offset.click.top,
          k = this.offset.click.left,
          l = d + j > h && d + j < i && b + k > f && b + k < g;return this.options.tolerance == "pointer" || this.options.forcePointerForContainers || this.options.tolerance != "pointer" && this.helperProportions[this.floating ? "width" : "height"] > a[this.floating ? "width" : "height"] ? l : f < b + this.helperProportions.width / 2 && c - this.helperProportions.width / 2 < g && h < d + this.helperProportions.height / 2 && e - this.helperProportions.height / 2 < i;
    }, _intersectsWithPointer: function _intersectsWithPointer(b) {
      var c = this.options.axis === "x" || a.ui.isOverAxis(this.positionAbs.top + this.offset.click.top, b.top, b.height),
          d = this.options.axis === "y" || a.ui.isOverAxis(this.positionAbs.left + this.offset.click.left, b.left, b.width),
          e = c && d,
          f = this._getDragVerticalDirection(),
          g = this._getDragHorizontalDirection();return e ? this.floating ? g && g == "right" || f == "down" ? 2 : 1 : f && (f == "down" ? 2 : 1) : !1;
    }, _intersectsWithSides: function _intersectsWithSides(b) {
      var c = a.ui.isOverAxis(this.positionAbs.top + this.offset.click.top, b.top + b.height / 2, b.height),
          d = a.ui.isOverAxis(this.positionAbs.left + this.offset.click.left, b.left + b.width / 2, b.width),
          e = this._getDragVerticalDirection(),
          f = this._getDragHorizontalDirection();return this.floating && f ? f == "right" && d || f == "left" && !d : e && (e == "down" && c || e == "up" && !c);
    }, _getDragVerticalDirection: function _getDragVerticalDirection() {
      var a = this.positionAbs.top - this.lastPositionAbs.top;return a != 0 && (a > 0 ? "down" : "up");
    }, _getDragHorizontalDirection: function _getDragHorizontalDirection() {
      var a = this.positionAbs.left - this.lastPositionAbs.left;return a != 0 && (a > 0 ? "right" : "left");
    }, refresh: function refresh(a) {
      return this._refreshItems(a), this.refreshPositions(), this;
    }, _connectWith: function _connectWith() {
      var a = this.options;return a.connectWith.constructor == String ? [a.connectWith] : a.connectWith;
    }, _getItemsAsjQuery: function _getItemsAsjQuery(b) {
      var c = this,
          d = [],
          e = [],
          f = this._connectWith();if (f && b) for (var g = f.length - 1; g >= 0; g--) {
        var h = a(f[g]);for (var i = h.length - 1; i >= 0; i--) {
          var j = a.data(h[i], this.widgetName);j && j != this && !j.options.disabled && e.push([a.isFunction(j.options.items) ? j.options.items.call(j.element) : a(j.options.items, j.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), j]);
        }
      }e.push([a.isFunction(this.options.items) ? this.options.items.call(this.element, null, { options: this.options, item: this.currentItem }) : a(this.options.items, this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), this]);for (var g = e.length - 1; g >= 0; g--) {
        e[g][0].each(function () {
          d.push(this);
        });
      }return a(d);
    }, _removeCurrentsFromItems: function _removeCurrentsFromItems() {
      var a = this.currentItem.find(":data(" + this.widgetName + "-item)");for (var b = 0; b < this.items.length; b++) {
        for (var c = 0; c < a.length; c++) {
          a[c] == this.items[b].item[0] && this.items.splice(b, 1);
        }
      }
    }, _refreshItems: function _refreshItems(b) {
      this.items = [], this.containers = [this];var c = this.items,
          d = this,
          e = [[a.isFunction(this.options.items) ? this.options.items.call(this.element[0], b, { item: this.currentItem }) : a(this.options.items, this.element), this]],
          f = this._connectWith();if (f && this.ready) for (var g = f.length - 1; g >= 0; g--) {
        var h = a(f[g]);for (var i = h.length - 1; i >= 0; i--) {
          var j = a.data(h[i], this.widgetName);j && j != this && !j.options.disabled && (e.push([a.isFunction(j.options.items) ? j.options.items.call(j.element[0], b, { item: this.currentItem }) : a(j.options.items, j.element), j]), this.containers.push(j));
        }
      }for (var g = e.length - 1; g >= 0; g--) {
        var k = e[g][1],
            l = e[g][0];for (var i = 0, m = l.length; i < m; i++) {
          var n = a(l[i]);n.data(this.widgetName + "-item", k), c.push({ item: n, instance: k, width: 0, height: 0, left: 0, top: 0 });
        }
      }
    }, refreshPositions: function refreshPositions(b) {
      this.offsetParent && this.helper && (this.offset.parent = this._getParentOffset());for (var c = this.items.length - 1; c >= 0; c--) {
        var d = this.items[c];if (d.instance != this.currentContainer && this.currentContainer && d.item[0] != this.currentItem[0]) continue;var e = this.options.toleranceElement ? a(this.options.toleranceElement, d.item) : d.item;b || (d.width = e.outerWidth(), d.height = e.outerHeight());var f = e.offset();d.left = f.left, d.top = f.top;
      }if (this.options.custom && this.options.custom.refreshContainers) this.options.custom.refreshContainers.call(this);else for (var c = this.containers.length - 1; c >= 0; c--) {
        var f = this.containers[c].element.offset();this.containers[c].containerCache.left = f.left, this.containers[c].containerCache.top = f.top, this.containers[c].containerCache.width = this.containers[c].element.outerWidth(), this.containers[c].containerCache.height = this.containers[c].element.outerHeight();
      }return this;
    }, _createPlaceholder: function _createPlaceholder(b) {
      var c = b || this,
          d = c.options;if (!d.placeholder || d.placeholder.constructor == String) {
        var e = d.placeholder;d.placeholder = { element: function element() {
            var b = a(document.createElement(c.currentItem[0].nodeName)).addClass(e || c.currentItem[0].className + " ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];return e || (b.style.visibility = "hidden"), b;
          }, update: function update(a, b) {
            if (e && !d.forcePlaceholderSize) return;b.height() || b.height(c.currentItem.innerHeight() - parseInt(c.currentItem.css("paddingTop") || 0, 10) - parseInt(c.currentItem.css("paddingBottom") || 0, 10)), b.width() || b.width(c.currentItem.innerWidth() - parseInt(c.currentItem.css("paddingLeft") || 0, 10) - parseInt(c.currentItem.css("paddingRight") || 0, 10));
          } };
      }c.placeholder = a(d.placeholder.element.call(c.element, c.currentItem)), c.currentItem.after(c.placeholder), d.placeholder.update(c, c.placeholder);
    }, _contactContainers: function _contactContainers(b) {
      var c = null,
          d = null;for (var e = this.containers.length - 1; e >= 0; e--) {
        if (a.ui.contains(this.currentItem[0], this.containers[e].element[0])) continue;if (this._intersectsWith(this.containers[e].containerCache)) {
          if (c && a.ui.contains(this.containers[e].element[0], c.element[0])) continue;c = this.containers[e], d = e;
        } else this.containers[e].containerCache.over && (this.containers[e]._trigger("out", b, this._uiHash(this)), this.containers[e].containerCache.over = 0);
      }if (!c) return;if (this.containers.length === 1) this.containers[d]._trigger("over", b, this._uiHash(this)), this.containers[d].containerCache.over = 1;else if (this.currentContainer != this.containers[d]) {
        var f = 1e4,
            g = null,
            h = this.positionAbs[this.containers[d].floating ? "left" : "top"];for (var i = this.items.length - 1; i >= 0; i--) {
          if (!a.ui.contains(this.containers[d].element[0], this.items[i].item[0])) continue;var j = this.containers[d].floating ? this.items[i].item.offset().left : this.items[i].item.offset().top;Math.abs(j - h) < f && (f = Math.abs(j - h), g = this.items[i], this.direction = j - h > 0 ? "down" : "up");
        }if (!g && !this.options.dropOnEmpty) return;this.currentContainer = this.containers[d], g ? this._rearrange(b, g, null, !0) : this._rearrange(b, null, this.containers[d].element, !0), this._trigger("change", b, this._uiHash()), this.containers[d]._trigger("change", b, this._uiHash(this)), this.options.placeholder.update(this.currentContainer, this.placeholder), this.containers[d]._trigger("over", b, this._uiHash(this)), this.containers[d].containerCache.over = 1;
      }
    }, _createHelper: function _createHelper(b) {
      var c = this.options,
          d = a.isFunction(c.helper) ? a(c.helper.apply(this.element[0], [b, this.currentItem])) : c.helper == "clone" ? this.currentItem.clone() : this.currentItem;return d.parents("body").length || a(c.appendTo != "parent" ? c.appendTo : this.currentItem[0].parentNode)[0].appendChild(d[0]), d[0] == this.currentItem[0] && (this._storedCSS = { width: this.currentItem[0].style.width, height: this.currentItem[0].style.height, position: this.currentItem.css("position"), top: this.currentItem.css("top"), left: this.currentItem.css("left") }), (d[0].style.width == "" || c.forceHelperSize) && d.width(this.currentItem.width()), (d[0].style.height == "" || c.forceHelperSize) && d.height(this.currentItem.height()), d;
    }, _adjustOffsetFromHelper: function _adjustOffsetFromHelper(b) {
      typeof b == "string" && (b = b.split(" ")), a.isArray(b) && (b = { left: +b[0], top: +b[1] || 0 }), "left" in b && (this.offset.click.left = b.left + this.margins.left), "right" in b && (this.offset.click.left = this.helperProportions.width - b.right + this.margins.left), "top" in b && (this.offset.click.top = b.top + this.margins.top), "bottom" in b && (this.offset.click.top = this.helperProportions.height - b.bottom + this.margins.top);
    }, _getParentOffset: function _getParentOffset() {
      this.offsetParent = this.helper.offsetParent();var b = this.offsetParent.offset();this.cssPosition == "absolute" && this.scrollParent[0] != document && a.ui.contains(this.scrollParent[0], this.offsetParent[0]) && (b.left += this.scrollParent.scrollLeft(), b.top += this.scrollParent.scrollTop());if (this.offsetParent[0] == document.body || this.offsetParent[0].tagName && this.offsetParent[0].tagName.toLowerCase() == "html" && a.browser.msie) b = { top: 0, left: 0 };return { top: b.top + (parseInt(this.offsetParent.css("borderTopWidth"), 10) || 0), left: b.left + (parseInt(this.offsetParent.css("borderLeftWidth"), 10) || 0) };
    }, _getRelativeOffset: function _getRelativeOffset() {
      if (this.cssPosition == "relative") {
        var a = this.currentItem.position();return { top: a.top - (parseInt(this.helper.css("top"), 10) || 0) + this.scrollParent.scrollTop(), left: a.left - (parseInt(this.helper.css("left"), 10) || 0) + this.scrollParent.scrollLeft() };
      }return { top: 0, left: 0 };
    }, _cacheMargins: function _cacheMargins() {
      this.margins = { left: parseInt(this.currentItem.css("marginLeft"), 10) || 0, top: parseInt(this.currentItem.css("marginTop"), 10) || 0 };
    }, _cacheHelperProportions: function _cacheHelperProportions() {
      this.helperProportions = { width: this.helper.outerWidth(), height: this.helper.outerHeight() };
    }, _setContainment: function _setContainment() {
      var b = this.options;b.containment == "parent" && (b.containment = this.helper[0].parentNode);if (b.containment == "document" || b.containment == "window") this.containment = [0 - this.offset.relative.left - this.offset.parent.left, 0 - this.offset.relative.top - this.offset.parent.top, a(b.containment == "document" ? document : window).width() - this.helperProportions.width - this.margins.left, (a(b.containment == "document" ? document : window).height() || document.body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top];if (!/^(document|window|parent)$/.test(b.containment)) {
        var c = a(b.containment)[0],
            d = a(b.containment).offset(),
            e = a(c).css("overflow") != "hidden";this.containment = [d.left + (parseInt(a(c).css("borderLeftWidth"), 10) || 0) + (parseInt(a(c).css("paddingLeft"), 10) || 0) - this.margins.left, d.top + (parseInt(a(c).css("borderTopWidth"), 10) || 0) + (parseInt(a(c).css("paddingTop"), 10) || 0) - this.margins.top, d.left + (e ? Math.max(c.scrollWidth, c.offsetWidth) : c.offsetWidth) - (parseInt(a(c).css("borderLeftWidth"), 10) || 0) - (parseInt(a(c).css("paddingRight"), 10) || 0) - this.helperProportions.width - this.margins.left, d.top + (e ? Math.max(c.scrollHeight, c.offsetHeight) : c.offsetHeight) - (parseInt(a(c).css("borderTopWidth"), 10) || 0) - (parseInt(a(c).css("paddingBottom"), 10) || 0) - this.helperProportions.height - this.margins.top];
      }
    }, _convertPositionTo: function _convertPositionTo(b, c) {
      c || (c = this.position);var d = b == "absolute" ? 1 : -1,
          e = this.options,
          f = this.cssPosition == "absolute" && (this.scrollParent[0] == document || !a.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent,
          g = /(html|body)/i.test(f[0].tagName);return { top: c.top + this.offset.relative.top * d + this.offset.parent.top * d - (a.browser.safari && this.cssPosition == "fixed" ? 0 : (this.cssPosition == "fixed" ? -this.scrollParent.scrollTop() : g ? 0 : f.scrollTop()) * d), left: c.left + this.offset.relative.left * d + this.offset.parent.left * d - (a.browser.safari && this.cssPosition == "fixed" ? 0 : (this.cssPosition == "fixed" ? -this.scrollParent.scrollLeft() : g ? 0 : f.scrollLeft()) * d) };
    }, _generatePosition: function _generatePosition(b) {
      var c = this.options,
          d = this.cssPosition == "absolute" && (this.scrollParent[0] == document || !a.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent,
          e = /(html|body)/i.test(d[0].tagName);this.cssPosition == "relative" && (this.scrollParent[0] == document || this.scrollParent[0] == this.offsetParent[0]) && (this.offset.relative = this._getRelativeOffset());var f = b.pageX,
          g = b.pageY;if (this.originalPosition) {
        this.containment && (b.pageX - this.offset.click.left < this.containment[0] && (f = this.containment[0] + this.offset.click.left), b.pageY - this.offset.click.top < this.containment[1] && (g = this.containment[1] + this.offset.click.top), b.pageX - this.offset.click.left > this.containment[2] && (f = this.containment[2] + this.offset.click.left), b.pageY - this.offset.click.top > this.containment[3] && (g = this.containment[3] + this.offset.click.top));if (c.grid) {
          var h = this.originalPageY + Math.round((g - this.originalPageY) / c.grid[1]) * c.grid[1];g = this.containment ? h - this.offset.click.top < this.containment[1] || h - this.offset.click.top > this.containment[3] ? h - this.offset.click.top < this.containment[1] ? h + c.grid[1] : h - c.grid[1] : h : h;var i = this.originalPageX + Math.round((f - this.originalPageX) / c.grid[0]) * c.grid[0];f = this.containment ? i - this.offset.click.left < this.containment[0] || i - this.offset.click.left > this.containment[2] ? i - this.offset.click.left < this.containment[0] ? i + c.grid[0] : i - c.grid[0] : i : i;
        }
      }return { top: g - this.offset.click.top - this.offset.relative.top - this.offset.parent.top + (a.browser.safari && this.cssPosition == "fixed" ? 0 : this.cssPosition == "fixed" ? -this.scrollParent.scrollTop() : e ? 0 : d.scrollTop()), left: f - this.offset.click.left - this.offset.relative.left - this.offset.parent.left + (a.browser.safari && this.cssPosition == "fixed" ? 0 : this.cssPosition == "fixed" ? -this.scrollParent.scrollLeft() : e ? 0 : d.scrollLeft()) };
    }, _rearrange: function _rearrange(a, b, c, d) {
      c ? c[0].appendChild(this.placeholder[0]) : b.item[0].parentNode.insertBefore(this.placeholder[0], this.direction == "down" ? b.item[0] : b.item[0].nextSibling), this.counter = this.counter ? ++this.counter : 1;var e = this,
          f = this.counter;window.setTimeout(function () {
        f == e.counter && e.refreshPositions(!d);
      }, 0);
    }, _clear: function _clear(b, c) {
      this.reverting = !1;var d = [],
          e = this;!this._noFinalSort && this.currentItem.parent().length && this.placeholder.before(this.currentItem), this._noFinalSort = null;if (this.helper[0] == this.currentItem[0]) {
        for (var f in this._storedCSS) {
          if (this._storedCSS[f] == "auto" || this._storedCSS[f] == "static") this._storedCSS[f] = "";
        }this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
      } else this.currentItem.show();this.fromOutside && !c && d.push(function (a) {
        this._trigger("receive", a, this._uiHash(this.fromOutside));
      }), (this.fromOutside || this.domPosition.prev != this.currentItem.prev().not(".ui-sortable-helper")[0] || this.domPosition.parent != this.currentItem.parent()[0]) && !c && d.push(function (a) {
        this._trigger("update", a, this._uiHash());
      }), this !== this.currentContainer && (c || (d.push(function (a) {
        this._trigger("remove", a, this._uiHash());
      }), d.push(function (a) {
        return function (b) {
          a._trigger("receive", b, this._uiHash(this));
        };
      }.call(this, this.currentContainer)), d.push(function (a) {
        return function (b) {
          a._trigger("update", b, this._uiHash(this));
        };
      }.call(this, this.currentContainer))));for (var f = this.containers.length - 1; f >= 0; f--) {
        c || d.push(function (a) {
          return function (b) {
            a._trigger("deactivate", b, this._uiHash(this));
          };
        }.call(this, this.containers[f])), this.containers[f].containerCache.over && (d.push(function (a) {
          return function (b) {
            a._trigger("out", b, this._uiHash(this));
          };
        }.call(this, this.containers[f])), this.containers[f].containerCache.over = 0);
      }this._storedCursor && a("body").css("cursor", this._storedCursor), this._storedOpacity && this.helper.css("opacity", this._storedOpacity), this._storedZIndex && this.helper.css("zIndex", this._storedZIndex == "auto" ? "" : this._storedZIndex), this.dragging = !1;if (this.cancelHelperRemoval) {
        if (!c) {
          this._trigger("beforeStop", b, this._uiHash());for (var f = 0; f < d.length; f++) {
            d[f].call(this, b);
          }this._trigger("stop", b, this._uiHash());
        }return this.fromOutside = !1, !1;
      }c || this._trigger("beforeStop", b, this._uiHash()), this.placeholder[0].parentNode.removeChild(this.placeholder[0]), this.helper[0] != this.currentItem[0] && this.helper.remove(), this.helper = null;if (!c) {
        for (var f = 0; f < d.length; f++) {
          d[f].call(this, b);
        }this._trigger("stop", b, this._uiHash());
      }return this.fromOutside = !1, !0;
    }, _trigger: function _trigger() {
      a.Widget.prototype._trigger.apply(this, arguments) === !1 && this.cancel();
    }, _uiHash: function _uiHash(b) {
      var c = b || this;return { helper: c.helper, placeholder: c.placeholder || a([]), position: c.position, originalPosition: c.originalPosition, offset: c.positionAbs, item: c.currentItem, sender: b ? b.element : null };
    } }), a.extend(a.ui.sortable, { version: "1.8.24" });
})(jQuery);
/* <<< file end: js/lib/jquery-ui/jquery.ui.sortable.min.js */

//# map link was there [jquery.ui.sortable.min.js.map]
/* >>> file start: js/lib/angular/ui/sortable.js */
/*
 jQuery UI Sortable plugin wrapper

 @param [ui-sortable] {object} Options to pass to $.fn.sortable() merged onto ui.config
 */
angular.module('ui.sortable', []).value('uiSortableConfig', {}).directive('uiSortable', ['uiSortableConfig', '$timeout', '$log', function (uiSortableConfig, $timeout, $log) {
  return {
    require: '?ngModel',
    link: function link(scope, element, attrs, ngModel) {
      var savedNodes;

      function combineCallbacks(first, second) {
        if (second && typeof second === 'function') {
          return function (e, ui) {
            first(e, ui);
            second(e, ui);
          };
        }
        return first;
      }

      var opts = {},
          callbacks = {
        receive: null,
        remove: null,
        start: null,
        stop: null,
        update: null
      };

      angular.extend(opts, uiSortableConfig);

      if (ngModel) {

        // When we add or remove elements, we need the sortable to 'refresh'
        // so it can find the new/removed elements.
        scope.$watch(attrs.ngModel + '.length', function () {
          // Timeout to let ng-repeat modify the DOM
          $timeout(function () {
            element.sortable('refresh');
          });
        });

        callbacks.start = function (e, ui) {
          // Save the starting position of dragged item
          ui.item.sortable = {
            index: ui.item.index(),
            cancel: function cancel() {
              ui.item.sortable._isCanceled = true;
            },
            isCanceled: function isCanceled() {
              return ui.item.sortable._isCanceled;
            },
            _isCanceled: false
          };
        };

        callbacks.activate = function () /*e, ui*/{
          // We need to make a copy of the current element's contents so
          // we can restore it after sortable has messed it up.
          // This is inside activate (instead of start) in order to save
          // both lists when dragging between connected lists.
          savedNodes = element.contents();

          // If this list has a placeholder (the connected lists won't),
          // don't inlcude it in saved nodes.
          var placeholder = element.sortable('option', 'placeholder');

          // placeholder.element will be a function if the placeholder, has
          // been created (placeholder will be an object).  If it hasn't
          // been created, either placeholder will be false if no
          // placeholder class was given or placeholder.element will be
          // undefined if a class was given (placeholder will be a string)
          if (placeholder && placeholder.element && typeof placeholder.element === 'function') {
            var phElement = placeholder.element();
            // workaround for jquery ui 1.9.x,
            // not returning jquery collection
            if (!phElement.jquery) {
              phElement = angular.element(phElement);
            }

            // exact match with the placeholder's class attribute to handle
            // the case that multiple connected sortables exist and
            // the placehoilder option equals the class of sortable items
            var excludes = element.find('[class="' + phElement.attr('class') + '"]');

            savedNodes = savedNodes.not(excludes);
          }
        };

        callbacks.update = function (e, ui) {
          // Save current drop position but only if this is not a second
          // update that happens when moving between lists because then
          // the value will be overwritten with the old value
          if (!ui.item.sortable.received) {
            ui.item.sortable.dropindex = ui.item.index();
            ui.item.sortable.droptarget = ui.item.parent();

            // Cancel the sort (let ng-repeat do the sort for us)
            // Don't cancel if this is the received list because it has
            // already been canceled in the other list, and trying to cancel
            // here will mess up the DOM.
            element.sortable('cancel');
          }

          // Put the nodes back exactly the way they started (this is very
          // important because ng-repeat uses comment elements to delineate
          // the start and stop of repeat sections and sortable doesn't
          // respect their order (even if we cancel, the order of the
          // comments are still messed up).
          savedNodes.detach();
          if (element.sortable('option', 'helper') === 'clone') {
            // first detach all the savedNodes and then restore all of them
            // except .ui-sortable-helper element (which is placed last).
            // That way it will be garbage collected.
            savedNodes = savedNodes.not(savedNodes.last());
          }
          savedNodes.appendTo(element);

          // If received is true (an item was dropped in from another list)
          // then we add the new item to this list otherwise wait until the
          // stop event where we will know if it was a sort or item was
          // moved here from another list
          if (ui.item.sortable.received && !ui.item.sortable.isCanceled()) {
            scope.$apply(function () {
              ngModel.$modelValue.splice(ui.item.sortable.dropindex, 0, ui.item.sortable.moved);
            });
          }
        };

        callbacks.stop = function (e, ui) {
          // If the received flag hasn't be set on the item, this is a
          // normal sort, if dropindex is set, the item was moved, so move
          // the items in the list.
          if (!ui.item.sortable.received && 'dropindex' in ui.item.sortable && !ui.item.sortable.isCanceled()) {

            scope.$apply(function () {
              ngModel.$modelValue.splice(ui.item.sortable.dropindex, 0, ngModel.$modelValue.splice(ui.item.sortable.index, 1)[0]);
            });
          } else {
            // if the item was not moved, then restore the elements
            // so that the ngRepeat's comment are correct.
            if ((!('dropindex' in ui.item.sortable) || ui.item.sortable.isCanceled()) && element.sortable('option', 'helper') !== 'clone') {
              savedNodes.detach().appendTo(element);
            }
          }
        };

        callbacks.receive = function (e, ui) {
          // An item was dropped here from another list, set a flag on the
          // item.
          ui.item.sortable.received = true;
        };

        callbacks.remove = function (e, ui) {
          // Remove the item from this list's model and copy data into item,
          // so the next list can retrive it
          if (!ui.item.sortable.isCanceled()) {
            scope.$apply(function () {
              ui.item.sortable.moved = ngModel.$modelValue.splice(ui.item.sortable.index, 1)[0];
            });
          }
        };

        scope.$watch(attrs.uiSortable, function (newVal /*, oldVal*/) {
          angular.forEach(newVal, function (value, key) {
            if (callbacks[key]) {
              if (key === 'stop') {
                // call apply after stop
                value = combineCallbacks(value, function () {
                  scope.$apply();
                });
              }
              // wrap the callback
              value = combineCallbacks(callbacks[key], value);
            }
            element.sortable('option', key, value);
          });
        }, true);

        angular.forEach(callbacks, function (value, key) {
          opts[key] = combineCallbacks(value, opts[key]);
        });
      } else {
        $log.info('ui.sortable: ngModel not provided!', element);
      }

      // Create sortable
      element.sortable(opts);
    }
  };
}]);
/* <<< file end: js/lib/angular/ui/sortable.js */

//# map link was there [sortable.js.map]
/* >>> file start: js/core/angular/pills.js */
/*
 * LiveJournal pills
 *
 * Use "lj-pills-group" and "data-pill" attribute to mark the html.
 *
 * @example
 *   html:
 *     <ul lj-pills-group="menu" lj-pills-group-active="b-mainpage-menu-active">
 *       <li class="b-menu-item" data-pill="item1">Item 1</li>
 *       <li class="b-menu-item" data-pill="item2">Item 2</li>
 *     </ul>
 *
 *   js:
 *     // inside the controller, to switch an active pill
 *     Pills.group('menu', 'item1');
 */

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Pills', []).factory('Pills', function () {
    var state = {};

    return {
      group: function group(name, value) {
        if (typeof value !== 'undefined') {
          state[name] = value;
        } else {
          return state[name];
        }
      }
    };
  }).directive('ljPillsGroup', ['Pills', function (Pills) {
    return {
      restrict: 'A',

      link: function link(scope, element, attrs) {
        var activeClass = attrs.ljPillsGroupActive || 'b-menu-item-active';

        scope.$watch(function () {
          return Pills.group(attrs.ljPillsGroup);
        }, function (value) {

          // set active pill
          element.find('[data-pill]').removeClass(activeClass).filter('[data-pill="' + value + '"]').addClass(activeClass);
        });
      }
    };
  }]);
})();
/* <<< file end: js/core/angular/pills.js */

//# map link was there [pills.js.map]
/* >>> file start: js/core/angular/plupload.js */
//= require js/lib/plupload/plupload-2.1.2.full.min.js

/**!
 * AngularJS Plupload directive
 * @author Chungsub Kim <subicura@subicura.com>
 */

/* global plupload */
(function () {
  'use strict';

  angular.module('angular-plupload', []).provider('pluploadOption', function () {
    /* jshint camelcase: false */
    var opts = {
      flash_swf_url: LJ.get('siteroot') + '/js/lib/plupload/Moxie.cdn.swf',
      runtimes: 'html5,flash',
      max_file_size: '10mb',
      multipart: true,
      filters: [{ title: 'Image files', extensions: 'jpg,jpeg,gif,png' }],
      chunk_size: 0
    };
    return {
      setOptions: function setOptions(newOpts) {
        angular.extend(opts, newOpts);
      },
      $get: function $get() {
        return opts;
      }
    };
  }).directive('plupload', ['$timeout', 'pluploadOption', function ($timeout, pluploadOption) {
    function lowercaseFirstLetter(string) {
      return string.charAt(0).toLowerCase() + string.slice(1);
    }

    return {
      scope: {
        url: '=plupload',
        options: '=pluploadOptions',
        callbacks: '=pluploadCallbacks',
        disbled: '=pluploadDisableOnUpload',
        delayed: '=pluploadDelayed'
      },
      /* jshint camelcase: false */
      link: function postLink(scope, element) {
        if (scope.delayed && !scope.loaded) {
          $timeout(function () {
            postLink(scope, element);
          }, 10);
          scope.loaded = true;
          return;
        }
        var opts = pluploadOption;
        opts.url = scope.url;
        angular.extend(opts, scope.options);
        var disabled = scope.disbled,
            uploader = new plupload.Uploader(opts);

        if (scope.callbacks) {
          var callbackMethods = ['Init', 'PostInit', 'OptionChanged', 'Refresh', 'StateChanged', 'UploadFile', 'BeforeUpload', 'QueueChanged', 'UploadProgress', 'FilesRemoved', 'FileFiltered', 'FilesAdded', 'FileUploaded', 'ChunkUploaded', 'UploadComplete', 'Error', 'Destroy'];
          angular.forEach(callbackMethods, function (method) {
            var callback = scope.callbacks[lowercaseFirstLetter(method)] || angular.noop;
            uploader.bind(method, function () {
              callback.apply(null, arguments);
              if (!scope.$$phase && !scope.$root.$$phase) {
                scope.$apply();
              }
            });
          });
        }

        uploader.init();
        if (disabled) {
          uploader.bind("BeforeUpload", function () {
            uploader.addFile = angular.noop;
          });
        }
      }
    };
  }]);
})();
/* <<< file end: js/core/angular/plupload.js */

//# map link was there [plupload.js.map]
/* >>> file start: js/lib/jquery-ui/jquery.ui.position.min.js */
/*! jQuery UI - v1.8.24 - 2012-09-28
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.position.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function (a, b) {
  a.ui = a.ui || {};var c = /left|center|right/,
      d = /top|center|bottom/,
      e = "center",
      f = {},
      g = a.fn.position,
      h = a.fn.offset;a.fn.position = function (b) {
    if (!b || !b.of) return g.apply(this, arguments);b = a.extend({}, b);var h = a(b.of),
        i = h[0],
        j = (b.collision || "flip").split(" "),
        k = b.offset ? b.offset.split(" ") : [0, 0],
        l,
        m,
        n;return i.nodeType === 9 ? (l = h.width(), m = h.height(), n = { top: 0, left: 0 }) : i.setTimeout ? (l = h.width(), m = h.height(), n = { top: h.scrollTop(), left: h.scrollLeft() }) : i.preventDefault ? (b.at = "left top", l = m = 0, n = { top: b.of.pageY, left: b.of.pageX }) : (l = h.outerWidth(), m = h.outerHeight(), n = h.offset()), a.each(["my", "at"], function () {
      var a = (b[this] || "").split(" ");a.length === 1 && (a = c.test(a[0]) ? a.concat([e]) : d.test(a[0]) ? [e].concat(a) : [e, e]), a[0] = c.test(a[0]) ? a[0] : e, a[1] = d.test(a[1]) ? a[1] : e, b[this] = a;
    }), j.length === 1 && (j[1] = j[0]), k[0] = parseInt(k[0], 10) || 0, k.length === 1 && (k[1] = k[0]), k[1] = parseInt(k[1], 10) || 0, b.at[0] === "right" ? n.left += l : b.at[0] === e && (n.left += l / 2), b.at[1] === "bottom" ? n.top += m : b.at[1] === e && (n.top += m / 2), n.left += k[0], n.top += k[1], this.each(function () {
      var c = a(this),
          d = c.outerWidth(),
          g = c.outerHeight(),
          h = parseInt(a.curCSS(this, "marginLeft", !0)) || 0,
          i = parseInt(a.curCSS(this, "marginTop", !0)) || 0,
          o = d + h + (parseInt(a.curCSS(this, "marginRight", !0)) || 0),
          p = g + i + (parseInt(a.curCSS(this, "marginBottom", !0)) || 0),
          q = a.extend({}, n),
          r;b.my[0] === "right" ? q.left -= d : b.my[0] === e && (q.left -= d / 2), b.my[1] === "bottom" ? q.top -= g : b.my[1] === e && (q.top -= g / 2), f.fractions || (q.left = Math.round(q.left), q.top = Math.round(q.top)), r = { left: q.left - h, top: q.top - i }, a.each(["left", "top"], function (c, e) {
        a.ui.position[j[c]] && a.ui.position[j[c]][e](q, { targetWidth: l, targetHeight: m, elemWidth: d, elemHeight: g, collisionPosition: r, collisionWidth: o, collisionHeight: p, offset: k, my: b.my, at: b.at });
      }), a.fn.bgiframe && c.bgiframe(), c.offset(a.extend(q, { using: b.using }));
    });
  }, a.ui.position = { fit: { left: function left(b, c) {
        var d = a(window),
            e = c.collisionPosition.left + c.collisionWidth - d.width() - d.scrollLeft();b.left = e > 0 ? b.left - e : Math.max(b.left - c.collisionPosition.left, b.left);
      }, top: function top(b, c) {
        var d = a(window),
            e = c.collisionPosition.top + c.collisionHeight - d.height() - d.scrollTop();b.top = e > 0 ? b.top - e : Math.max(b.top - c.collisionPosition.top, b.top);
      } }, flip: { left: function left(b, c) {
        if (c.at[0] === e) return;var d = a(window),
            f = c.collisionPosition.left + c.collisionWidth - d.width() - d.scrollLeft(),
            g = c.my[0] === "left" ? -c.elemWidth : c.my[0] === "right" ? c.elemWidth : 0,
            h = c.at[0] === "left" ? c.targetWidth : -c.targetWidth,
            i = -2 * c.offset[0];b.left += c.collisionPosition.left < 0 ? g + h + i : f > 0 ? g + h + i : 0;
      }, top: function top(b, c) {
        if (c.at[1] === e) return;var d = a(window),
            f = c.collisionPosition.top + c.collisionHeight - d.height() - d.scrollTop(),
            g = c.my[1] === "top" ? -c.elemHeight : c.my[1] === "bottom" ? c.elemHeight : 0,
            h = c.at[1] === "top" ? c.targetHeight : -c.targetHeight,
            i = -2 * c.offset[1];b.top += c.collisionPosition.top < 0 ? g + h + i : f > 0 ? g + h + i : 0;
      } } }, a.offset.setOffset || (a.offset.setOffset = function (b, c) {
    /static/.test(a.curCSS(b, "position")) && (b.style.position = "relative");var d = a(b),
        e = d.offset(),
        f = parseInt(a.curCSS(b, "top", !0), 10) || 0,
        g = parseInt(a.curCSS(b, "left", !0), 10) || 0,
        h = { top: c.top - e.top + f, left: c.left - e.left + g };"using" in c ? c.using.call(b, h) : d.css(h);
  }, a.fn.offset = function (b) {
    var c = this[0];return !c || !c.ownerDocument ? null : b ? a.isFunction(b) ? this.each(function (c) {
      a(this).offset(b.call(this, c, a(this).offset()));
    }) : this.each(function () {
      a.offset.setOffset(this, b);
    }) : h.call(this);
  }), a.curCSS || (a.curCSS = a.css), function () {
    var b = document.getElementsByTagName("body")[0],
        c = document.createElement("div"),
        d,
        e,
        g,
        h,
        i;d = document.createElement(b ? "div" : "body"), g = { visibility: "hidden", width: 0, height: 0, border: 0, margin: 0, background: "none" }, b && a.extend(g, { position: "absolute", left: "-1000px", top: "-1000px" });for (var j in g) {
      d.style[j] = g[j];
    }d.appendChild(c), e = b || document.documentElement, e.insertBefore(d, e.firstChild), c.style.cssText = "position: absolute; left: 10.7432222px; top: 10.432325px; height: 30px; width: 201px;", h = a(c).offset(function (a, b) {
      return b;
    }).offset(), d.innerHTML = "", e.removeChild(d), i = h.top + h.left + (b ? 2e3 : 0), f.fractions = i > 21 && i < 22;
  }();
})(jQuery);
/* <<< file end: js/lib/jquery-ui/jquery.ui.position.min.js */

//# map link was there [jquery.ui.position.min.js.map]
/* >>> file start: js/lib/jquery-ui/jquery.ui.autocomplete.min.js */
/*! jQuery UI - v1.8.24 - 2012-09-28
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.autocomplete.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function (a, b) {
  var c = 0;a.widget("ui.autocomplete", { options: { appendTo: "body", autoFocus: !1, delay: 300, minLength: 1, position: { my: "left top", at: "left bottom", collision: "none" }, source: null }, pending: 0, _create: function _create() {
      var b = this,
          c = this.element[0].ownerDocument,
          d;this.isMultiLine = this.element.is("textarea"), this.element.addClass("ui-autocomplete-input").attr("autocomplete", "off").attr({ role: "textbox", "aria-autocomplete": "list", "aria-haspopup": "true" }).bind("keydown.autocomplete", function (c) {
        if (b.options.disabled || b.element.propAttr("readOnly")) return;d = !1;var e = a.ui.keyCode;switch (c.keyCode) {case e.PAGE_UP:
            b._move("previousPage", c);break;case e.PAGE_DOWN:
            b._move("nextPage", c);break;case e.UP:
            b._keyEvent("previous", c);break;case e.DOWN:
            b._keyEvent("next", c);break;case e.ENTER:case e.NUMPAD_ENTER:
            b.menu.active && (d = !0, c.preventDefault());case e.TAB:
            if (!b.menu.active) return;b.menu.select(c);break;case e.ESCAPE:
            b.element.val(b.term), b.close(c);break;default:
            clearTimeout(b.searching), b.searching = setTimeout(function () {
              b.term != b.element.val() && (b.selectedItem = null, b.search(null, c));
            }, b.options.delay);}
      }).bind("keypress.autocomplete", function (a) {
        d && (d = !1, a.preventDefault());
      }).bind("focus.autocomplete", function () {
        if (b.options.disabled) return;b.selectedItem = null, b.previous = b.element.val();
      }).bind("blur.autocomplete", function (a) {
        if (b.options.disabled) return;clearTimeout(b.searching), b.closing = setTimeout(function () {
          b.close(a), b._change(a);
        }, 150);
      }), this._initSource(), this.menu = a("<ul></ul>").addClass("ui-autocomplete").appendTo(a(this.options.appendTo || "body", c)[0]).mousedown(function (c) {
        var d = b.menu.element[0];a(c.target).closest(".ui-menu-item").length || setTimeout(function () {
          a(document).one("mousedown", function (c) {
            c.target !== b.element[0] && c.target !== d && !a.ui.contains(d, c.target) && b.close();
          });
        }, 1), setTimeout(function () {
          clearTimeout(b.closing);
        }, 13);
      }).menu({ focus: function focus(a, c) {
          var d = c.item.data("item.autocomplete");!1 !== b._trigger("focus", a, { item: d }) && /^key/.test(a.originalEvent.type) && b.element.val(d.value);
        }, selected: function selected(a, d) {
          var e = d.item.data("item.autocomplete"),
              f = b.previous;b.element[0] !== c.activeElement && (b.element.focus(), b.previous = f, setTimeout(function () {
            b.previous = f, b.selectedItem = e;
          }, 1)), !1 !== b._trigger("select", a, { item: e }) && b.element.val(e.value), b.term = b.element.val(), b.close(a), b.selectedItem = e;
        }, blur: function blur(a, c) {
          b.menu.element.is(":visible") && b.element.val() !== b.term && b.element.val(b.term);
        } }).zIndex(this.element.zIndex() + 1).css({ top: 0, left: 0 }).hide().data("menu"), a.fn.bgiframe && this.menu.element.bgiframe(), b.beforeunloadHandler = function () {
        b.element.removeAttr("autocomplete");
      }, a(window).bind("beforeunload", b.beforeunloadHandler);
    }, destroy: function destroy() {
      this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete").removeAttr("role").removeAttr("aria-autocomplete").removeAttr("aria-haspopup"), this.menu.element.remove(), a(window).unbind("beforeunload", this.beforeunloadHandler), a.Widget.prototype.destroy.call(this);
    }, _setOption: function _setOption(b, c) {
      a.Widget.prototype._setOption.apply(this, arguments), b === "source" && this._initSource(), b === "appendTo" && this.menu.element.appendTo(a(c || "body", this.element[0].ownerDocument)[0]), b === "disabled" && c && this.xhr && this.xhr.abort();
    }, _initSource: function _initSource() {
      var b = this,
          c,
          d;a.isArray(this.options.source) ? (c = this.options.source, this.source = function (b, d) {
        d(a.ui.autocomplete.filter(c, b.term));
      }) : typeof this.options.source == "string" ? (d = this.options.source, this.source = function (c, e) {
        b.xhr && b.xhr.abort(), b.xhr = a.ajax({ url: d, data: c, dataType: "json", success: function success(a, b) {
            e(a);
          }, error: function error() {
            e([]);
          } });
      }) : this.source = this.options.source;
    }, search: function search(a, b) {
      a = a != null ? a : this.element.val(), this.term = this.element.val();if (a.length < this.options.minLength) return this.close(b);clearTimeout(this.closing);if (this._trigger("search", b) === !1) return;return this._search(a);
    }, _search: function _search(a) {
      this.pending++, this.element.addClass("ui-autocomplete-loading"), this.source({ term: a }, this._response());
    }, _response: function _response() {
      var a = this,
          b = ++c;return function (d) {
        b === c && a.__response(d), a.pending--, a.pending || a.element.removeClass("ui-autocomplete-loading");
      };
    }, __response: function __response(a) {
      !this.options.disabled && a && a.length ? (a = this._normalize(a), this._suggest(a), this._trigger("open")) : this.close();
    }, close: function close(a) {
      clearTimeout(this.closing), this.menu.element.is(":visible") && (this.menu.element.hide(), this.menu.deactivate(), this._trigger("close", a));
    }, _change: function _change(a) {
      this.previous !== this.element.val() && this._trigger("change", a, { item: this.selectedItem });
    }, _normalize: function _normalize(b) {
      return b.length && b[0].label && b[0].value ? b : a.map(b, function (b) {
        return typeof b == "string" ? { label: b, value: b } : a.extend({ label: b.label || b.value, value: b.value || b.label }, b);
      });
    }, _suggest: function _suggest(b) {
      var c = this.menu.element.empty().zIndex(this.element.zIndex() + 1);this._renderMenu(c, b), this.menu.deactivate(), this.menu.refresh(), c.show(), this._resizeMenu(), c.position(a.extend({ of: this.element }, this.options.position)), this.options.autoFocus && this.menu.next(new a.Event("mouseover"));
    }, _resizeMenu: function _resizeMenu() {
      var a = this.menu.element;a.outerWidth(Math.max(a.width("").outerWidth() + 1, this.element.outerWidth()));
    }, _renderMenu: function _renderMenu(b, c) {
      var d = this;a.each(c, function (a, c) {
        d._renderItem(b, c);
      });
    }, _renderItem: function _renderItem(b, c) {
      return a("<li></li>").data("item.autocomplete", c).append(a("<a></a>").text(c.label)).appendTo(b);
    }, _move: function _move(a, b) {
      if (!this.menu.element.is(":visible")) {
        this.search(null, b);return;
      }if (this.menu.first() && /^previous/.test(a) || this.menu.last() && /^next/.test(a)) {
        this.element.val(this.term), this.menu.deactivate();return;
      }this.menu[a](b);
    }, widget: function widget() {
      return this.menu.element;
    }, _keyEvent: function _keyEvent(a, b) {
      if (!this.isMultiLine || this.menu.element.is(":visible")) this._move(a, b), b.preventDefault();
    } }), a.extend(a.ui.autocomplete, { escapeRegex: function escapeRegex(a) {
      return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
    }, filter: function filter(b, c) {
      var d = new RegExp(a.ui.autocomplete.escapeRegex(c), "i");return a.grep(b, function (a) {
        return d.test(a.label || a.value || a);
      });
    } });
})(jQuery), function (a) {
  a.widget("ui.menu", { _create: function _create() {
      var b = this;this.element.addClass("ui-menu ui-widget ui-widget-content ui-corner-all").attr({ role: "listbox", "aria-activedescendant": "ui-active-menuitem" }).click(function (c) {
        if (!a(c.target).closest(".ui-menu-item a").length) return;c.preventDefault(), b.select(c);
      }), this.refresh();
    }, refresh: function refresh() {
      var b = this,
          c = this.element.children("li:not(.ui-menu-item):has(a)").addClass("ui-menu-item").attr("role", "menuitem");c.children("a").addClass("ui-corner-all").attr("tabindex", -1).mouseenter(function (c) {
        b.activate(c, a(this).parent());
      }).mouseleave(function () {
        b.deactivate();
      });
    }, activate: function activate(a, b) {
      this.deactivate();if (this.hasScroll()) {
        var c = b.offset().top - this.element.offset().top,
            d = this.element.scrollTop(),
            e = this.element.height();c < 0 ? this.element.scrollTop(d + c) : c >= e && this.element.scrollTop(d + c - e + b.height());
      }this.active = b.eq(0).children("a").addClass("ui-state-hover").attr("id", "ui-active-menuitem").end(), this._trigger("focus", a, { item: b });
    }, deactivate: function deactivate() {
      if (!this.active) return;this.active.children("a").removeClass("ui-state-hover").removeAttr("id"), this._trigger("blur"), this.active = null;
    }, next: function next(a) {
      this.move("next", ".ui-menu-item:first", a);
    }, previous: function previous(a) {
      this.move("prev", ".ui-menu-item:last", a);
    }, first: function first() {
      return this.active && !this.active.prevAll(".ui-menu-item").length;
    }, last: function last() {
      return this.active && !this.active.nextAll(".ui-menu-item").length;
    }, move: function move(a, b, c) {
      if (!this.active) {
        this.activate(c, this.element.children(b));return;
      }var d = this.active[a + "All"](".ui-menu-item").eq(0);d.length ? this.activate(c, d) : this.activate(c, this.element.children(b));
    }, nextPage: function nextPage(b) {
      if (this.hasScroll()) {
        if (!this.active || this.last()) {
          this.activate(b, this.element.children(".ui-menu-item:first"));return;
        }var c = this.active.offset().top,
            d = this.element.height(),
            e = this.element.children(".ui-menu-item").filter(function () {
          var b = a(this).offset().top - c - d + a(this).height();return b < 10 && b > -10;
        });e.length || (e = this.element.children(".ui-menu-item:last")), this.activate(b, e);
      } else this.activate(b, this.element.children(".ui-menu-item").filter(!this.active || this.last() ? ":first" : ":last"));
    }, previousPage: function previousPage(b) {
      if (this.hasScroll()) {
        if (!this.active || this.first()) {
          this.activate(b, this.element.children(".ui-menu-item:last"));return;
        }var c = this.active.offset().top,
            d = this.element.height(),
            e = this.element.children(".ui-menu-item").filter(function () {
          var b = a(this).offset().top - c + d - a(this).height();return b < 10 && b > -10;
        });e.length || (e = this.element.children(".ui-menu-item:first")), this.activate(b, e);
      } else this.activate(b, this.element.children(".ui-menu-item").filter(!this.active || this.first() ? ":last" : ":first"));
    }, hasScroll: function hasScroll() {
      return this.element.height() < this.element[a.fn.prop ? "prop" : "attr"]("scrollHeight");
    }, select: function select(a) {
      this._trigger("selected", a, { item: this.active });
    } });
}(jQuery);
/* <<< file end: js/lib/jquery-ui/jquery.ui.autocomplete.min.js */

//# map link was there [jquery.ui.autocomplete.min.js.map]
/* >>> file start: js/core/angular/autocomplete.js */
//= require js/lib/jquery-ui/jquery.ui.position.min.js
//= require js/lib/jquery-ui/jquery.ui.autocomplete.min.js

angular.module('LJ.Autocomplete', [])
/**
 * Autocomplete directive, that extends jQuery UI autocomplete.
 *
 * More info: http://api.jqueryui.com/autocomplete
 *
 * `lj-autocomplete-options` - jquery ui autocomplete options (for widget)
 * `lj-autocomplete-limit`   - items limit to be shown in the list
 * `lj-autocomplete-submit`  - we could use it when need handle submit by enter-key
 * `lj-autocomplete-disabled` - option that improve performance. Could be turned on when you do not
 *                              need autocomplete functionality (e.g. if its hidden at the moment)
 * `lj-autocomplete-select` - we could use it when need handle select item
 * `lj-autocomplete-prop`   - if we have array of objects - set it to use completion by the prop
 *
 * @example
 *
 *   <input
 *     lj-autocomplete="getUsers()" // Function should return array of values
 *     [ lj-autocomplete-options="{ minLength: 3, delay: 50 }" ]
 *     [ lj-autocomplete-disabled="autocompleteDisabled" ]
 *     [ lj-autocomplete-limit="10" ]
 *     [ lj-autocomplete-submit="submit($value)" ]
 *     [ lj-autocomplete-select="select($value)" ]
 *     [ lj-autocomplete-multiple ]
 *     [ lj-autocomplete-prop="username" ]
 *     />
 */
.directive('ljAutocomplete', ['$parse', '$window', function ($parse, $window) {
  return {
    restrict: 'A',
    link: function link(scope, element, attrs) {
      var limit = null,
          defaultOptions,
          source,
          itemsBeforeCursor,
          itemsAfterCursor,
          options,
          disabled,
          multiple,
          keypress,
          keydown,
          submit,
          closeOnResize = LJ.Function.throttle(function () {
        return element.autocomplete('close');
      }, 500);

      scope.$on('$destroy', function () {
        if (attrs.ljAutocompleteCloseOnResize) {
          $window.removeEventListener('resize', closeOnResize);
        }
        element.autocomplete('destroy');
      });

      defaultOptions = {
        delay: 50,
        minLength: 1,

        focus: focusFn,
        select: selectFn,
        source: sourceFn
      };

      if (attrs.ljAutocompleteOptions) {
        options = scope.$eval(attrs.ljAutocompleteOptions);
      }

      if (attrs.ljAutocompleteLimit) {
        limit = scope.$eval(attrs.ljAutocompleteLimit);
      }

      options = angular.extend(defaultOptions, options || {});
      multiple = attrs.hasOwnProperty('ljAutocompleteMultiple');

      if (attrs.ljAutocompleteCustomItemRender) {
        element.autocomplete(options).data('autocomplete')._renderItem = scope.$eval(attrs.ljAutocompleteCustomItemRender);
      } else {
        element.autocomplete(options);
      }

      if (attrs.ljAutocompleteCloseOnResize) {
        $window.addEventListener('resize', closeOnResize);
      }

      if (!multiple) {
        keypress = function keypress(event) {
          // To forbit input of comma
          if (event.which === 44) {
            event.preventDefault();
          }
        };

        element.on('keypress', keypress);
      }

      // Notice: this action should be after autocomplete initialization,
      // because of key handlers order
      if (attrs.ljAutocompleteSubmit) {
        submit = $parse(attrs.ljAutocompleteSubmit);
        keydown = function keydown(event) {
          if (event.which === 13 && !event.isDefaultPrevented()) {
            event.preventDefault();

            scope.$apply(function () {
              submit(scope, { $value: element.val() });
            });
          }
        };

        element.on('keydown', keydown);

        scope.$on('$destroy', function () {
          element.off('keydown', keydown);
          element.off('keypress', keypress);
        });
      }

      // autocomplete is not active or not needed right now
      if (attrs.ljAutocompleteDisabled) {
        scope.$watch(function watchAutocompleteDisabled() {
          return scope.$eval(attrs.ljAutocompleteDisabled);
        }, function (value) {
          disabled = Boolean(value);
          element.autocomplete('option', 'disabled', disabled);

          // close autocomplete dialog
          if (disabled) {
            element.autocomplete('close');
          }
        });
      }

      if (attrs.ljAutocompleteSelect && !multiple) {
        var select = $parse(attrs.ljAutocompleteSelect);

        scope.$on('select', function () {
          scope.$apply(function () {
            select(scope, { $value: element.val() });
          });
        });
      }

      if (attrs.ljAutocompleteWatchFocus) {
        var focus = $parse(attrs.ljAutocompleteWatchFocus);

        scope.$on('focus', function (innerScope, item) {
          scope.$apply(function () {
            focus(scope, { $value: item });
          });
        });
      }

      // watch changes of source elements
      scope.$watch(function watchAutocompleteArray() {
        if (disabled) {
          return;
        }

        return scope.$eval(attrs.ljAutocomplete);
      }, function (items) {
        if (disabled || !items) {
          return;
        }

        // update sources
        source = attrs.ljAutocompleteProp ? items.map(LJ.Function.get(attrs.ljAutocompleteProp)) : items;
      }, true);

      function sourceFn(request, response) {
        var value = request.term,
            cursorPosition = LJ.DOM.getSelection(element).start,
            beforeCursor = value.slice(0, cursorPosition),
            afterCursor = value.slice(cursorPosition),
            items,
            lastCommaBeforeCursor,
            results,
            search,
            searches;

        if (afterCursor.length && afterCursor.charAt(0) !== ',') {
          // Inside of the word. Do not need completion.
          response();
          return;
        }

        // extract search string and items before cursor
        beforeCursor = beforeCursor.trim();
        lastCommaBeforeCursor = beforeCursor.lastIndexOf(',');

        if (lastCommaBeforeCursor === -1) {
          search = beforeCursor;
          itemsBeforeCursor = [];
        } else {
          search = beforeCursor.slice(lastCommaBeforeCursor + 1).trim();
          itemsBeforeCursor = beforeCursor.slice(0, lastCommaBeforeCursor).split(/\,\s*/);
        }

        // extract items after cursor
        if (afterCursor.length) {
          // remove first comma and trim
          afterCursor = afterCursor.slice(1).trim();
          itemsAfterCursor = afterCursor.split(/\,\s*/);

          // remove last empty element
          if (itemsAfterCursor[itemsAfterCursor.length - 1] === '') {
            itemsAfterCursor.pop();
          }
        } else {
          itemsAfterCursor = [];
        }

        // merge items before and after cursor and filter empty values
        items = itemsBeforeCursor.concat(itemsAfterCursor);

        // search length is less than minLength: we should not search
        if (search.length < options.minLength) {
          response();
          return;
        }

        if (attrs.ljAutocompleteAdditionalFiltering) {
          search = search.toLowerCase();
          searches = search.split(/\s/g);

          searches.forEach(function (s) {
            if (!results || results.length === 0) {
              results = filter(source, items, s);
            } else {
              results = results.filter(function (item) {
                return item.toLowerCase().indexOf(s) !== -1;
              });
            }
          });

          response(limit ? results.slice(0, limit - 1) : results);
        } else {
          search = search.toLowerCase();

          results = filter(source, items, search);

          response(limit ? results.slice(0, limit - 1) : results);
        }
      }

      function filter(lines, items, search) {
        var lowercasedItems, filterResults;
        // filter results that contain our search string
        filterResults = lines.filter(function (item) {
          return item.toLowerCase().indexOf(search) !== -1;
        });

        lowercasedItems = items.map(function (item) {
          return item.toLowerCase();
        });

        // filter previously selected items from result
        filterResults = filterResults.filter(function (item) {
          return lowercasedItems.indexOf(item.toLowerCase()) === -1;
        });
        return filterResults;
      }

      function focusFn(event, ui) {
        if (attrs.ljAutocompleteWatchFocus) {
          scope.$emit('focus', ui.item);
        }

        // prevent replacing input contents while focusing list item
        return false;
      }

      function selectFn(e, ui) {
        // prevent full replacement of input value
        e.preventDefault();

        if (multiple) {
          itemsBeforeCursor.push(ui.item.value);

          element.val(itemsBeforeCursor.concat(itemsAfterCursor).join(', ') + ', ');

          // ng-model is listening for 'input' event
          element.trigger('input');

          // set cursor position
          if (itemsAfterCursor.length === 0) {
            LJ.DOM.setCursor(element, 'end');
          } else {
            LJ.DOM.setCursor(element, itemsBeforeCursor.join(', ').length);
          }
        } else {
          element.val(ui.item.value);
          element.trigger('input');
        }

        scope.$emit('select', ui.item.value);
      }
    }
  };
}]);
/* <<< file end: js/core/angular/autocomplete.js */

//# map link was there [autocomplete.js.map]
/* >>> file start: js/core/angular/adult.js */
Site.page.template['angular/adult.ng.tmpl'] = '<label class=\"flatpopup-label\" lj-ml=\"flatmedia.adult.content\"></label>\n<select class=\"sharp-select\" ng-model=\"model\" ng-options=\"item.value as item.title for item in adult.categories\"></select>\n';

//= require_ml flatmedia.adult.content
//= require_ml flatmedia.adult.content.default
//= require_ml flatmedia.adult.content.explicit
//= require_ml flatmedia.adult.content.none

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('LJ.Adult', []).directive('ljAdult', [function () {
    return {
      scope: {
        model: '=ljAdult'
      },
      templateUrl: 'adult.ng.tmpl',
      controllerAs: 'adult',
      controller: ['$scope', '$element', '$attrs', function ($scope, $element, $attrs) {
        this.categories = [{ title: LJ.ml('flatmedia.adult.content.none'), value: false }, { title: LJ.ml('flatmedia.adult.content.explicit'), value: true }];

        if ($attrs.hasOwnProperty('ljAdultNotStrict')) {
          this.categories.unshift({ title: LJ.ml('flatmedia.adult.content.default'), value: '' });
        }
      }]
    };
  }]);
})();
/* <<< file end: js/core/angular/adult.js */

//# map link was there [adult.js.map]
/* >>> file start: js/video/video.js */
var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

//= require_ml flatmedia.adult.content.default
//= require_ml flatmedia.adult.content.none
//= require_ml flatmedia.adult.content.explicit

//= require_ml flatmedia.select.album.none

/**
 * Service that is responsible for video data
 */
(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Video.Service', []).factory('Video', ['Api', function (Api) {
    var defaults = {
      NON_SELECTED_ALBUM: {
        id: -1,
        name: LJ.ml('flatmedia.select.album.none')
      },

      // adult setting
      RECORD_ADULT: false,
      RECORD_PRIVACY: 'public',
      ALBUM_PRIVACY: 'public',
      ALBUM_NAME: ''
    },
        factory = {
      createRecord: createRecord,

      fetchAlbums: fetchAlbums,
      getAlbums: getAlbums,
      fetchAlbum: fetchAlbum,
      getAlbumById: getAlbumById,

      fetchRecords: fetchRecords,
      fetchRecordByStorageId: fetchRecordByStorageId,
      getRecordById: getRecordById,
      getRecordsByAlbumId: getRecordsByAlbumId,

      createAlbum: createAlbum,
      updateAlbum: updateAlbum,
      removeAlbum: removeAlbum,

      updateRecords: updateRecords,
      removeRecords: removeRecords,

      defaults: defaults
    },
        user = LJ.get('journal.username') || LJ.get('remote.username'),
        _albumsById = {},
        _recordById = {};

    function createRecord(obj) {
      return Api.call('video.create_record', obj).then(function (response) {
        _cacheRecords(response.record);
        return response.record;
      });
    }

    function fetchAlbums(params) {
      return Api.call('video.get_albums', _extends({ user: user }, params), { cache: true }).then(function (response) {
        response.albums.forEach(_cacheAlbum);
      });
    }

    function fetchAlbum(id) {
      return Api.call('video.get_album', { id: id, user: user }, { cache: true }).then(function (response) {
        _cacheAlbum(response.album);
      });
    }

    function fetchRecords(albumId, params) {
      return Api.call('video.get_records', _extends({ albumid: albumId, user: user }, params), { cache: true }).then(function (response) {
        var records = response.records.map(function (r) {
          // Using the fact that hoster supports https
          r.url = r.url.replace(/^http:/, 'https:');
          r.screenshot = r.screenshot.replace(/^http:/, 'https:');
          return r;
        });

        _cacheRecords(records);
        return records;
      });
    }

    function fetchRecordByStorageId(id) {
      return Api.call('video.get_record', { storageid: id }, { cache: true }).then(function (response) {
        var record = response.record;

        _cacheRecords(record);
        return record;
      });
    }

    /**
     * Update album request
     * @param  {Object} album Album object
     * @return {Promise}      Promise that will be resolved with data
     */
    function updateAlbum(album) {
      // @todo check params
      return Api.call('video.update_album', album).then(function () {
        _cacheAlbum(album);

        Api.invalidate('video.get_albums', { user: user });
        Api.invalidate('video.get_album', { id: album.id, user: user });
      });
    }

    /**
     * Create album: https://conf.sup.com/display/LJCOMAPI/video.create_album
     *
     * @param  {Object}   [params]           Album params
     * @param  {String}   [params.name]      Album name
     * @param  {String}   [params.privacy]   Album privacy: public | private | friends | custom
     * @param  {Number[]} [params.groupids]  Custom privacy groupids
     *
     * @return {Promise}       Promise that will be resolved with created album object
     */
    function createAlbum(params) {
      // @todo replace security with default security value for video album
      var requestParams = angular.extend({}, { security: 'public', user: user }, params);

      // @todo check params
      return Api.call('video.create_album', requestParams).then(function (response) {
        var result = response.album;

        _cacheAlbum(result);

        Api.invalidate('video.get_albums', { user: user });
        return result;
      });
    }

    function removeAlbum(id) {
      return Api.call('video.delete_album', { id: id }).then(function (response) {
        _removeAlbumFromCache(id);

        Api.invalidate('video.get_albums', { user: user });
        Api.invalidate('video.get_album', { user: user, id: id });
        return response;
      });
    }

    function _cacheAlbum(album) {
      _albumsById[album.id] = album;
    }

    function _removeAlbumFromCache(id) {
      delete _albumsById[id];
      getRecordsByAlbumId(id).forEach(function (record) {
        _removeRecordFromCache(record.id);
      });
    }

    function _removeRecordFromCache(id) {
      delete _recordById[id];
    }

    function getAlbums() {
      var albums = [];

      // @todo add order by timestamp
      angular.forEach(_albumsById, function (album) {
        albums.push(album);
      });

      albums.sort(function (a, b) {
        return b.id - a.id;
      });

      return albums;
    }

    function getAlbumById(id) {
      return _albumsById[id];
    }

    function getRecordById(id) {
      return _recordById[id];
    }

    function getRecordsByAlbumId(id) {
      var result = [];

      angular.forEach(_recordById, function (record) {
        if (record.albumid === id) {
          result.push(record);
        }
      });

      result.sort(function (a, b) {
        return b.timecreate - a.timecreate;
      });

      return result;
    }

    function updateRecords(data) {
      return Api.call('video.update_records', data).then(function (response) {
        var records = response.records;

        records.forEach(function (record) {
          var cache = getRecordById(record.id);

          Api.invalidate('video.get_records', { albumid: record.albumid, user: user });
          Api.invalidate('video.get_album', { user: user, id: record.albumid });
          Api.invalidate('video.get_records', { albumid: cache.albumid, user: user });
          Api.invalidate('video.get_album', { user: user, id: cache.albumid });
          Api.invalidate('video.get_albums', { user: user });
          _cacheRecords(record);
        });

        return records;
      });
    }

    function removeRecords(ids) {
      return Api.call('video.delete_records', { ids: ids }).then(function () {
        ids.forEach(function (id) {
          _removeRecordFromCache(id);
        });
      });
    }

    /**
     * Cache record(s)
     * @param  {Object|Array} records Record or records to cache
     */
    function _cacheRecords(records) {
      if (!Array.isArray(records)) {
        records = [records];
      }

      records.forEach(function (record) {
        _recordById[record.id] = record;
      });
    }

    return factory;
  }]);
})();
/* <<< file end: js/video/video.js */

//# map link was there [video.js.map]
/* >>> file start: js/video/selectAlbum.js */

//= require js/video/video.js

Site.page.template['angular/video/selectVideoAlbum.ng.tmpl'] = '<div class=\"b-ljform-field\"\n  ng-class=\"{\n    \'flatpopup-create-state\': directive.state.create\n  }\"\n  >\n\n  <div class=\"flatmedia-edit-field\">\n    <label class=\"flatpopup-label\" lj-ml=\"flatmedia.select.album\"></label>\n    <select\n      class=\"sharp-select\"\n      ng-model=\"directive.selectedAlbumId\"\n      ng-options=\"album.id as album.name for album in directive.albums\"\n      ></select>\n    <span lj-ml=\"flatmedia.or\"></span>\n    <a\n      class=\"flatmedia-action-link\"\n      href=\"javascript:void(0);\"\n      ng-click=\"directive.toggle(true)\"\n      lj-ml=\"flatmedia.album.create.new\"\n      ></a>\n  </div>\n\n  <div class=\"flatmedia-create-field\">\n    <label class=\"flatpopup-label\" lj-ml=\"flatmedia.album.name\"></label>\n    <a\n      class=\"flatpopup-action-link flatpopup-aside-link\"\n      href=\"javascript:void(0);\"\n      ng-click=\"directive.toggle(false)\"\n      lj-ml=\"flatmedia.button.back\"\n      ng-if=\"directive.albums.length\"\n      ></a>\n    <input\n      type=\"text\"\n      class=\"b-input b-input-max\"\n      ng-model=\"directive.newAlbum.name\"\n      maxlength=\"150\"\n      />\n  </div>\n</div>\n';

//= require_ml flatmedia.album.create.new
//= require_ml flatmedia.album.name
//= require_ml flatmedia.button.back
//= require_ml flatmedia.or
//= require_ml flatmedia.select.album

/**
 * Album selection directive. It is responseble for displaying an albums list
 * It is possible to select an album or create new album (without Api request)
 *
 * Options:
 *   allow-non-selected[="value"] - Allow non-selected album (is needed for mass-edit)
 *                                  If value provided - it will be watched and when it
 *                                  is `true` non-selected album will be shown
 *
 * @example
 *
 *   <div select-video-album="model.albumObj" />
 *
 *   <div
 *     select-video-album="model.albumObj"
 *     allow-non-selected="options.allowNonSelected"
 *     />
 *
 * Where,
 *   albumObj - album object or object with {name: 'New album name'}
 *
 * if after all albumObj has an <id> property - it's selection,
 * otherwice - creation of the new album
 */

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Video.SelectAlbum', ['LJ.Templates', 'Video.Service']).directive('selectVideoAlbum', ['Video', function (Video) {
    return {
      templateUrl: 'selectVideoAlbum.ng.tmpl',
      controllerAs: 'directive',
      scope: {
        album: '=selectVideoAlbum',
        allowNonSelected: '=?allowNonSelected'
      },
      controller: ['$scope', '$attrs', 'Video', function ($scope, $attrs, Video) {
        var that = this,
            state = this.state = {
          init: false,

          // create album (or select)
          create: false
        };

        // initial model of new album
        this.newAlbum = {
          name: ''
        };

        /**
         * Check if is needed to add non selected album
         */
        function isNonSelectedAllowed() {
          var attr = $attrs.allowNonSelected;

          // option is provided without value to watch
          if (typeof attr === 'string' && attr.length === 0) {
            return true;
          }

          return $scope.allowNonSelected;
        }

        // get albums for
        function getAlbums(albums) {
          var result = [];

          if (isNonSelectedAllowed()) {
            result.push(Video.defaults.NON_SELECTED_ALBUM);
          }

          return result.concat(albums ? albums : Video.getAlbums());
        }

        this.init = function () {
          state.init = true;

          that.albums = angular.copy(Video.getAlbums());

          // select album
          if ($scope.album.id) {
            this.selectedAlbumId = $scope.album.id;
          } else if (that.albums.length !== 0) {
            this.selectedAlbumId = that.albums[0].id;
          }

          // change album value when selectedAlbumId/newAlbum or state is changed
          $scope.$watch(function () {
            return that.selectedAlbumId + that.newAlbum.name + state.create;
          }, function () {
            $scope.album = state.create ? that.newAlbum : Video.getAlbumById(that.selectedAlbumId);
          });

          $scope.$watchCollection(Video.getAlbums, function (albums) {
            that.albums = getAlbums(albums);

            // switch to create state if there is no albums
            if (albums.length === 0) {
              state.create = true;
            }
          });

          if (typeof $attrs.allowNonSelected !== 'undefined') {
            $scope.$watch('allowNonSelected', function () {
              that.albums = getAlbums();
            });
          }
        };

        /**
         * Toggle state create/select
         * @param  {Boolean} _state State: true - create; false - select
         */
        this.toggle = function (_state) {
          state.create = _state;
          this.newAlbum.name = '';
        };
      }],
      link: function link($scope, $element, $attrs, ctrl) {
        if (typeof $scope.album === 'undefined') {
          throw new TypeError('You should provide album object');
        }

        Video.fetchAlbums().then(function () {
          ctrl.init();
        });
      }
    };
  }]);
})();
/* <<< file end: js/video/selectAlbum.js */

//# map link was there [selectAlbum.js.map]
/* >>> file start: js/video/uploader.js */


//= require js/core/angular/api.js
//= require js/core/angular/adult.js
//= require js/core/angular/plupload.js
//= require js/core/angular/privacy.js
//= require js/video/video.js
//= require js/video/selectAlbum.js

Site.page.template['angular/video/uploaderVideo.ng.tmpl'] = '<div\n    class=\"flatpopup__body-inner flatpopup__text\"\n    ng-if=\"directive.state.init\"\n    ng-class=\'{\n        \"flatpopup-uploading\": directive.state.uploadInProgress,\n        \"flatpopup-uploading-complete\": directive.state.uploadDone\n    }\'\n    >\n    <div\n        class=\"b-ljform-field upload__box\"\n        id=\"upload-panel-video\"\n        plupload=\"directive.uploadUrl\"\n        plupload-options=\"directive.uploadOptions\"\n        plupload-callbacks=\"directive.uploadCallbacks\"\n        >\n        <label\n            for=\"pickfiles-video\"\n            class=\"upload__box-label\"\n            lj-ml=\"{\n                \'videouploader.upload.dragOrClick\': !directive.files.length,\n                \'videouploader.upload.selectedFile\': directive.files.length\n            }\"\n            lj-ml-resolve=\"{ filename: directive.files.length && directive.files[0].name }\"\n            lj-ml-dynamic=\"directive.files.length\"\n            ></label>\n        <input\n            type=\"file\"\n            class=\"upload__input\"\n            name=\"media\"\n            id=\"pickfiles-video\"\n            ng-hide=\"directive.state.uploading\"\n            >\n    </div>\n\n    <div class=\"upload-bar\">\n        <span\n            class=\"upload-bar__inner\"\n            ng-style=\"{ width: directive.file.percent + \'%\' }\"\n            ></span>\n    </div>\n\n    <div class=\"flatpopup__msg\">\n        <span\n            class=\"\n                b-bubble\n                b-bubble-warning\n                b-bubble-noarrow\n                flatpopup__msg-warning\n                flatpopup__msg-text\n                \"\n            ></span>\n    </div>\n\n    <div class=\"b-ljform-field\">\n        <div class=\"b-ljform-field-head\">\n            <label\n                class=\"flatpopup-label\"\n                lj-ml=\"flatmedia.name\"\n                ></label>\n        </div>\n        <div class=\"b-ljform-field-body\">\n            <input\n                class=\"b-input b-input-max\"\n                type=\"text\"\n                name=\"title\"\n                ng-model=\"directive.model.name\"\n                >\n        </div>\n    </div>\n\n    <div class=\"b-ljform-field\">\n        <div select-video-album=\"directive.model.album\"></div>\n    </div>\n\n    <div class=\"b-ljform-field flatmedia-privacy__field\">\n        <label\n            class=\"flatpopup-label\"\n            lj-ml=\"flatmedia.security\"\n            ></label>\n        <span\n            lj-privacy=\"directive.model\"\n            lj-privacy-scope=\"video\"\n            ></span>\n    </div>\n\n    <div\n        class=\"b-ljform-field\"\n        lj-adult=\"directive.model.adult_content\"\n        ></div>\n\n    <div class=\"b-ljform-field b-videouploader-action-panel\">\n        <a\n            class=\"flatpopup-action-link\"\n            href=\"javascript:void(0)\"\n            ng-click=\"directive.cancel()\"\n            lj-ml=\"flatmedia.button.cancel\"\n            ></a>\n        <button\n            class=\"\n                b-flatbutton\n                b-flatbutton-simple\n                \"\n            lj-ml=\"flatmedia.upload.video\"\n            lj-disabled=\"!directive.isUploadAllowed()\"\n            ng-click=\"directive.upload()\"\n            ></button>\n    </div>\n\n</div>\n\n<div class=\"b-photouploader-initfail\" ng-if=\"!directive.state.init\">\n    <span\n        class=\"b-photouploader-initfail-flash\"\n        lj-ml=\"photouploader.upload.initFail\"\n        ></span>\n</div>\n';

//= require_ml flatmedia.button.cancel
//= require_ml flatmedia.name
//= require_ml flatmedia.upload.video
//= require_ml videouploader.upload.dragOrClick
//= require_ml videouploader.upload.selectedFile
//= require_ml photouploader.upload.initFail

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Video.Uploader', ['LJ.Templates', 'LJ.Api', 'LJ.Adult', 'LJ.Privacy', 'LJ.Messages', 'angular-plupload', 'Video.SelectAlbum', 'Video.Service'])
  /**
   * @example
   *
   *  <!-- select default album -->
   *  <div lj-video-uploader />
   *
   *  <!-- select exact album -->
   *  <div lj-video-uploader="albumId" />
   *
   *  <!-- video upload callback -->
   *  <div
   *    lj-video-uploader="albumId"
   *    [lj-video-uploader-callback="videoLoaded(record)"]
   *    [lj-video-uploader-cancel="cancelled()"]
   *    [lj-video-uploader-error="onError()"]
   *    />
   */
  .directive('ljVideoUploader', ['$timeout', function ($timeout) {
    return {
      templateUrl: 'uploaderVideo.ng.tmpl',
      scope: {
        albumId: '=ljVideoUploader',
        callback: '&ljVideoUploaderCallback',
        onError: '&ljVideoUploaderError',
        cancelUpload: '&ljVideoUploaderCancel'
      },
      controllerAs: 'directive',
      controller: ['$scope', '$q', '$rootScope', '$element', '$attrs', 'Video', 'Messages', function ($scope, $q, $rootScope, $element, $attrs, Video, Messages) {

        var that = this,
            state = this.state = {
          init: false,
          error: false,
          uploadInProgress: false,
          uploadDone: false,
          fileAdded: false
        },
            filename;


        this.isUploadAllowed = function () {
          // check file presence
          return filename && filename.trim().length !== 0 &&

          //check album name
          this.model.name.trim().length !== 0 && (

          // check album
          this.model.album.id || this.model.album.name.trim().length !== 0) &&

          // check uploader status
          !this.state.uploadInProgress;
        };

        function getDefaultModel() {
          return {
            // will be redefined; should not be empty
            // If action attribute is empty - angular prevents default behavior
            name: Video.defaults.ALBUM_NAME,
            privacy: Video.defaults.RECORD_PRIVACY,
            album: Video.getAlbumById($scope.albumId) || {},
            adult_content: Video.defaults.RECORD_ADULT
          };
        }

        this.init = function () {
          state.init = true;
          this.model = getDefaultModel();
        };

        this.upload = function () {
          that.state.uploadInProgress = true;
          this.beforeUpload().then(function (record) {
            var files = that.uploader.files;

            if (that.state.error) {
              return;
            }
            LJ.Event.trigger('video:upload:start');
            files[0].name = record.name;
            that.file.id = record.id;

            that.uploader.settings.url = record.upload_link;
            that.uploader.setOption({ chunk_size: '1000kb' });
            that.uploader.setOption({ send_chunk_number: false });
            that.uploader.start();

            // @todo handle file uploade errors
            LJ.Event.once('video:upload:done', function () {
              $scope.callback({ record: record });
            });
          });
        };

        // cancel upload
        this.cancel = function () {
          LJ.Event.trigger('video:upload:cancel');
          that.state.uploadInProgress = false;
          if (typeof $scope.cancelUpload === 'function') {
            $scope.cancelUpload();
          }
        };

        // get url, create album
        this.beforeUpload = function () {
          // @todo create album
          var params = angular.copy(that.model),
              albumCreateDefer = $q.defer(),
              albumCreatePromise = albumCreateDefer.promise;

          // create album if needed (id not provided)
          if (typeof params.album.id === 'undefined') {
            // @todo possible apply privacy settings from video
            albumCreatePromise = Video.createAlbum({ name: params.album.name });
          } else {
            albumCreateDefer.resolve(params.album);
          }

          delete params.album;

          return albumCreatePromise.then(function (album) {
            var file = that.uploader.files[0],
                param = angular.extend(params, { name: that.model.name.trim(), size: file.size });

            params.albumid = album.id;

            return Video.createRecord(param).then(function (record) {
              return record;
            }).catch(function (error) {
              processError(null, error);
            });
          });
        };

        this.uploadUrl = '/sampleUrl';
        this.uploadOptions = {
          drop_element: 'upload-panel-video',
          browse_button: 'pickfiles-video',
          multi_selection: false,
          filters: {
            max_file_size: '10240mb',
            mime_types: [{ title: 'Video files', extensions: 'avi,mp4,mov,3gp,wmv,mkv,webm' }]
          },
          multipart: true,
          file_data_name: 'media'
        };

        this.uploadCallbacks = {
          init: function init(uploader) {
            that.uploader = uploader;
          },
          filesAdded: function filesAdded(uploader, files) {
            $timeout(function () {
              that.state.uploadDone = false;
              that.file = angular.copy(files[0]);
              uploader.splice(0, uploader.files.length - 1);
              filename = that.model.name = files[0].name;
            });
          },

          uploadProgress: function uploadProgress(uploader, file) {
            that.file.percent = file.percent;
          },

          uploadComplete: function uploadComplete() {
            if (!that.state.error) {
              that.state.uploadInProgress = false;
              that.state.uploadDone = true;
              LJ.Event.trigger('video:upload:done');
            }
          },
          error: processError.bind(this)
        };

        LJ.Event.on('Uploader:filesAdded:video', function (files) {
          $timeout(function () {
            that.file = angular.copy(files[0]);
          });
        });

        function processError(uploader, err) {
          that.state.uploadInProgress = false;
          that.state.uploadDone = false;
          that.state.error = true;

          if (err.code === window.plupload.INIT_ERROR) {
            that.state.init = false;
            return;
          }

          if (err.code === window.plupload.HTTP_ERROR && that.file) {
            Video.removeRecords([that.file.id]);
          }

          $timeout(function () {
            Messages.error({ body: err.message });
          });

          if (angular.isFunction($scope.onError)) {
            $scope.onError();
          }
        }
      }],
      link: function link($scope, $element, $attrs, ctrl) {

        // Wait for linking $scope.albumId
        $timeout(function () {
          ctrl.init();
        });
      }
    };
  }]);
})();
/* <<< file end: js/video/uploader.js */

//# map link was there [uploader.js.map]
/* >>> file start: js/video/editor.js */


//= require js/editor/editor.js
//= require js/editor/media.js
//= require js/core/string.js

//!= require js/core/angular/messages.js
//= require js/core/angular/api.js
//= require js/core/angular/pills.js
//= require js/core/angular/authHelper.js

//= require js/video/uploader.js
//= require js/video/video.js

LJ.injectStyle('/* >>> file start: stc/photouploader.css */\n.b-photouploader {\n    width: 480px;\n    }\n\n/* items */\n\n.b-photouploader-items {\n    margin: 0;\n    }\n\n.b-photouploader-item {\n        margin: 0;\n        padding: 1em 0 0;\n        }\n\n/* item no albums */\n\n.b-photouploader-item-noalbums {\n        padding: 1em 0;\n        text-align: center;\n        }\n\n.b-photouploader-item-noalbums:not(.ng-hide) + .b-photouploader-item-instagram {\n        padding-top: 0;\n        }\n\n/* item upload */\n\n.b-photouploader-item-upload {\n        }\n\n/* start */\n\n.b-photouploader-item-upload-start {\n            }\n\n.b-photouploader-item-upload-start .b-photouploader-panel-pictures,\n            .b-photouploader-item-upload-start .b-photouploader-panel-controls {\n                display: none;\n                }\n\n.b-photouploader-item-upload-start .b-photouploader-panel-upload {\n                    margin-bottom: 0;\n                    }\n\n/* uploaded */\n\n.b-photouploader-item-upload-uploaded {\n            }\n\n.b-photouploader-item-upload-uploaded .b-photouploader-panel-pictures {\n                margin-bottom: 15px;\n                overflow: auto;\n                max-height: 250px;\n                }\n\n/* from flatmedia.css */\n\n/* edit media popup */\n\n.flatmedia-create-field {\n            display: none;\n            }\n\n/* states */\n\n.flatpopup-loading .flatpopup__preloader {\n            display: block;\n            }\n\n.flatpopup-loading .flatpopup__body:after {\n                display: block;\n                position: absolute;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                left: 0;\n                background: #FFF;\n                opacity: .6;\n                z-index: 1;\n                }\n\n.flatpopup-warning-state .flatpopup__msg-warning,\n        .flatpopup-success-state .flatpopup__msg-success {\n            display: block;\n            }\n\n.flatpopup-create-state .flatmedia-create-field {\n            display: block;\n            }\n\n.flatpopup-create-state .flatmedia-edit-field {\n            display: none;\n            }\n\n.flatpopup-loading-state {\n            position: relative;\n            width: 100%;\n            min-height: 34px;\n            }\n\n.flatpopup-loading-state:before {\n                display: block;\n                position: absolute;\n                z-index: 1;\n                top: 0;\n                right: 0;\n                bottom: 0;\n                left: 0;\n                opacity: .6;\n                content: \"\";\n                background: #FFF;\n                }\n\n.flatpopup-loading-state:after {\n                display: block;\n                position: absolute;\n                z-index: 2;\n                top: 50%;\n                left: 50%;\n                width: 34px;\n                height: 34px;\n                margin-top: -17px;\n                margin-left: -17px;\n                content: \"\";\n                background: url(/img/preloader/preloader-disc-blue-white.gif?v=39255) 50% 50% no-repeat;\n                }\n\n/* create-edit popups */\n\n.flatpopup-delete-btn {\n            display: none;\n            }\n\n.flatpopup-edit-state .flatpopup-delete-btn {\n            display: inline-block;\n            }\n\n/* flatpopup form elements */\n\n.flatpopup SELECT,\n        .flatpopup-label+SELECT {\n            max-width: 160px;\n            margin: 0 5px 0 0;\n            font-size: 14px;\n            vertical-align: middle;\n            }\n\n.flatpopup-label {\n            color: #004359;\n            }\n\n.b-ljform-field .flatpopup-label {\n                margin-right: 6px;\n                vertical-align: middle;\n                }\n\n/* upload container */\n\n.upload__box {\n            overflow: hidden;\n            position: relative;\n            min-height: 49px;\n            border: 4px dashed #DAE3E6;\n            background: #FFF;\n            text-align: center;\n            }\n\n.upload__box-label {\n                display: block;\n                margin: -5px;\n                padding: 15px;\n                border: 4px dashed #DAE3E6;\n                background: #FFF;\n                cursor: pointer;\n                }\n\n.upload__input {\n            position: absolute !important;\n            top: 0;\n            right: 0;\n            width: 100%;\n            height: 50px;\n            margin: 0;\n            padding: 0;\n            border: 0;\n            opacity: 0;\n            filter: alpha(opacity=0);\n            zoom: 1;\n            font-size: 10000px;\n            cursor: pointer;\n            }\n\n.upload__items {\n            position: relative;\n            margin: 25px 0 19px;\n            padding: 0;\n            list-style: none;\n            }\n\n.upload__item {\n                display: inline-block;\n                position: relative;\n                width: 144px;\n                height: 144px;\n                margin: 0 20px 30px;\n                padding: 22px;\n                cursor: pointer;\n                background-color: #FFF;\n                box-shadow: 0 7px 22px -9px #999;\n                box-sizing: border-box;\n                }\n\n.upload__item_pic {\n                    display: block;\n                    width: 100px;\n                    height: 100px;\n                    background-position: 0 0;\n                    background-repeat: no-repeat;\n                    background-size: cover;\n                    text-align: center;\n                    }\n\n.upload__item_remove {\n                    display: inline-block;\n                    position: absolute;\n                    top: -11px;\n                    right: -11px;\n                    width: 20px;\n                    height: 20px;\n                    border: 2px solid #cf0011;\n                    border-radius: 50%;\n                    cursor: pointer;\n                    background-color: #FFF;\n                    box-shadow: 0 3px 5px -3px #000000;\n                    }\n\n.upload__item_remove .svgicon {\n                        position: absolute;\n                        top: 50%;\n                        left: 50%;\n                        width: 12px;\n                        height: 12px;\n                        margin-top: -6px;\n                        margin-left: -6px;\n                        }\n\n/* uploading progress bar animation */\n\n.upload-bar {\n            opacity: 0;\n            position: relative;\n            height: 6px;\n            margin: 0 0 10px;\n            border-radius: 6px;\n            background-color: #CCC;\n            }\n\n.upload-bar__inner {\n                position: absolute;\n                left: 0;\n                top: 0;\n                height: 6px;\n                border-radius: 6px;\n                background-color: #0099CC;\n                }\n\n.upload-bar__inner:after {\n                    content: \"\";\n                    z-index: 1;\n                    position: absolute;\n                    overflow: hidden;\n                    top: 0;\n                    left: 0;\n                    bottom: 0;\n                    right: 0;\n                    background-image:\n                        linear-gradient(\n                          -45deg,\n                          rgba(255, 255, 255, .2) 25%,\n                          transparent 25%,\n                          transparent 50%,\n                          rgba(255, 255, 255, .2) 50%,\n                          rgba(255, 255, 255, .2) 75%,\n                          transparent 75%,\n                          transparent\n                       );\n                    background-size: 50px 50px;\n                    -webkit-animation: move 2s linear infinite;\n                            animation: move 2s linear infinite;\n                    }\n\n@-webkit-keyframes move {\n                        0% { background-position: 0 0; }\n                        100% { background-position: 50px 50px;}\n                        }\n\n@keyframes move {\n                        0% { background-position: 0 0; }\n                        100% { background-position: 50px 50px;}\n                        }\n\n.flatpopup-uploading .upload-bar {\n                opacity: 1;\n                }\n\n.flatpopup-uploading .upload-bar__inner,\n            .flatpopup-uploading .upload-bar {\n                transition-property: all;\n                transition-duration: .3s;\n                }\n\n.flatpopup-uploading-complete .upload-bar {\n                opacity: 0;\n                transition-property: opacity;\n                transition-duration: .3s;\n                }\n\n.flatpopup__msg-text {\n            display: none;\n            margin: 1em 0;\n            }\n\n.flatpopup-action-link {\n            font: 600 .875em/1 \'ProximaNova\', Tahoma, Arial, sans-serif;\n            margin-right: 4px;\n            white-space: nowrap;\n            text-transform: uppercase;\n            color: #00a3d9;\n            border: 0;\n            background-color: transparent;\n            }\n\n.flatpopup-aside-link {\n            float: right;\n            }\n\n.b-photouploader-item-upload .sharp-select {\n            font-size: 14px;\n            vertical-align: middle;\n            }\n\n.b-photouploader-item-upload .flatpopup-label {\n           vertical-align: middle;\n            }\n\n.b-photouploader-action-panel,\n .b-videouploader-action-panel {\n    text-align: right;\n    margin-bottom: 0;\n    }\n\n/* panel */\n\n.b-photouploader-panel {\n    margin: 0;\n    }\n\n.b-photouploader-panel:after {\n    content: \"\";\n    display: table;\n    border-collapse: collapse;\n    clear: both;\n    }\n\n/* upload */\n\n.b-photouploader-panel-upload {\n    margin: 0 0 15px;\n    }\n\n/* pictures */\n\n.b-photouploader-panel-pictures {\n    margin: 0;\n    }\n\n/* albums */\n\n.b-photouploader-panel-albums {\n    margin: 0;\n    }\n\n/* url */\n\n.b-photouploader-panel-url {\n    margin: 0 0 15px;\n    }\n\n/* dropbox login */\n\n.b-photouploader-panel-dropbox {\n    text-align: center;\n    }\n\n.b-photouploader-panel-dropbox-intro {\n        width: 75%;\n        margin: 0 auto 1em;\n        line-height: 1.4;\n        }\n\n/* instagram login */\n\n.b-photouploader-panel-instalogin {\n    text-align: center;\n    }\n\n.b-photouploader-panel-instalogin-intro {\n        width: 70%;\n        margin: 0 auto 1em;\n        text-align: left;\n        line-height: 1.4;\n        }\n\n/* by url */\n\n.b-photouploader-byurl {\n    margin: 0 0 0 110px;\n    padding: 0;\n    }\n\n.b-photouploader-byurl:after {\n    content: \"\";\n    display: table;\n    border-collapse: collapse;\n    clear: both;\n    }\n\n.b-photouploader-byurl-picture {\n        position: relative;\n        left: -110px;\n        float: left;\n        width: 100px;\n        max-height: 100px;\n        margin: 0 -100px 0 0;\n        padding: 0;\n        box-shadow: 0 0 10px #BBB;\n        background: #FFF;\n        }\n\n.b-photouploader-byurl-image {\n            max-width: 100px;\n            max-height: 100px;\n            margin: 0;\n            vertical-align: top;\n            }\n\n.b-photouploader-byurl-sub {\n            display: block;\n            margin: 0;\n            padding: 10px;\n            font-size: 86%;\n            color: #999;\n            }\n\n.b-photouploader-byurl-form {\n        margin: 0 0 1em;\n        }\n\n.b-photouploader-byurl-label {\n            display: block;\n            margin: 0 0 0.5em;\n            }\n\n.b-photouploader-byurl-br {\n            display: none;\n            }\n\n.b-photouploader-byurl-src {\n            margin: 0;\n            width: 100%;\n            box-sizing: border-box;\n            }\n\n.b-photouploader-byurl-link {\n            box-sizing: border-box;\n            width: 100%;\n            margin: 0;\n            }\n\n.b-photouploader-byurl-note {\n            display: block;\n            margin: 0.5em 0 0;\n            font-size: 86%;\n            font-style: normal;\n            color: #666;\n            }\n\n/* separator */\n\n.b-photouploader-albumsettings-separator {\n    display: none;\n    }\n\n.b-photouploader-albumsettings-wrap {\n    float: right;\n    }\n\n/* controls */\n\n.b-photouploader-panel-controls {\n    margin: 0 -15px;\n    padding: 15px 15px 0;\n    border-top: 1px solid #FFF;\n    }\n\n.b-photouploader-panel-controls .b-photouploader-albumselector {\n        width: 70%;\n        }\n\n.b-photouploader-albumselector-item {\n            margin: 0 0 0.5em;\n            }\n\n.b-photouploader-albumselector-input {\n                width: 280px;\n                }\n\n.b-photouploader-panel-controls .b-photouploader-albumsettings {\n        margin: 0 0 0.5em;\n        }\n\n.b-photouploader-albumsettings-select {\n            margin: 0 1em 0 0;\n            }\n\n.b-photouploader-panel-controls .b-photouploader-urlsettings {\n        margin: 0 0 1em;\n        }\n\n.b-photouploader-urlsettings-label {\n            margin: 0 .5em 0 0;\n            }\n\n.b-photouploader-panel-controls .b-photouploader-instasettings {\n        float: left;\n        width: 75%;\n        }\n\n.b-photouploader-instasettings-label {\n            margin: 0 1em 0 0;\n            }\n\n.b-photouploader-instasettings-annex {\n            display: block;\n            margin: 0 0 0 1.7em;\n            color: #999;\n            }\n\n.b-photouploader-panel-controls .b-ljbutton {\n        float: right;\n        }\n\n.b-photouploader-panel-controls .b-flatbutton {\n        float: right;\n        }\n\n/* show old-design buttons and show new one (LJSUP-19180) */\n\n.b-photouploader-panel-controls .b-ljbutton {\n        display: inline-block;\n        }\n\n.b-photouploader-panel-controls .b-flatbutton {\n        display: none;\n        }\n\n.s-schemius .b-photouploader-panel-controls .b-ljbutton {\n        display: none;\n        }\n\n.s-schemius .b-photouploader-panel-controls .b-flatbutton {\n        display: inline-block;\n        }\n\n/* uploader */\n\n.b-photouploader-uploader {\n    margin: 0;\n    padding: 25px 15px;\n    border: 1px solid #BBB;\n    border-radius: 5px;\n    text-align: center;\n    line-height: 2;\n    color: #666;\n    }\n\n.drag-and-drop .b-photouploader-uploader {\n    box-shadow: inset 0 0 15px #526283;\n    border: 2px dashed #999;\n    border-radius: 0;\n    background: #FFF;\n    }\n\n.b-photouploader-uploader-drop {\n        display: none;\n        margin: 0;\n        padding: 0;\n        color: #666;\n        }\n\n.b-photouploader-uploader-drop STRONG {\n            font-size: 1.5em;\n            font-weight: normal;\n            color: #666;\n            }\n\n.b-photouploader-uploader-nodrop {\n        margin: 0;\n        }\n\n.b-photouploader-uploader-nodrop STRONG {\n            font-size: 1.5em;\n            font-weight: normal;\n            color: #666;\n            }\n\n.drag-and-drop .b-photouploader-uploader-drop {\n        display: block;\n        }\n\n.drag-and-drop .b-photouploader-uploader-nodrop {\n        display: none;\n        }\n\n.b-photouploader-uploader-input {\n        color: #666;\n        }\n\n.b-photouploader-uploader-list {\n        width: 40%;\n        margin: 5px auto;\n        padding: 0;\n        list-style-type: decimal;\n        text-align: left;\n        line-height: 1.2;\n        }\n\n.b-photouploader-uploader-list-item {\n            margin: 0 0 0.5em;\n            padding: 0;\n            }\n\n/* pictures */\n\n.b-photouploader-pictures {\n    margin: 0;\n    padding: 0;\n    list-style: none;\n    }\n\n/* item */\n\n.b-photouploader-pictures-item {\n        position: relative;\n        display: inline-block;\n        width: 142px;\n        margin: 0 5px 5px 0;\n        padding: 10px;\n        vertical-align: top;\n        }\n\n.b-photouploader-pictures-pic {\n            display: table-cell;\n            width: 132px;\n            height: 132px;\n            margin: 0;\n            padding: 5px;\n            vertical-align: middle;\n            box-shadow: 0 5px 10px #CCC;\n            background: #FFF;\n            text-align: center;\n            }\n\n.b-photouploader-pictures-img {\n                max-width: 132px;\n                max-height: 132px;\n                vertical-align: top;\n                }\n\n.b-photouploader-pictures-remove {\n            display: none;\n            overflow: hidden;\n            position: absolute;\n            top: 0;\n            right: 0;\n            z-index: 1;\n            width: 21px;\n            height: 21px;\n            background: url(/img/icons/remove.png?v=37651) no-repeat 0 0;\n            font: 0/0 a;\n            cursor: pointer;\n            }\n\n.b-photouploader-pictures-title {\n            display: none;\n            overflow: hidden;\n            margin: 0;\n            padding: 5px 5px 0;\n            white-space: nowrap;\n            text-overflow: ellipsis;\n            text-align: center;\n            font-size: 90%;\n            font-weight: normal;\n            }\n\n/* selected */\n\n.b-photouploader-pictures-item.selected {\n        border-radius: 3px;\n        box-shadow: inset 0 0 4px #444;\n        background: #2C5188;\n        background: #2C5188 linear-gradient(to bottom, #2C5188 0%,#2E8FED 100%);\n        color: #FFF;\n        }\n\n.b-photouploader-pictures-item.selected .b-photouploader-pictures-pic {\n            box-shadow: 0 2px 4px #666;\n            }\n\n.b-photouploader-pictures-item.selected .b-photouploader-pictures-title {\n            color: #FFF;\n            }\n\n/* pictures with remove button */\n\n.b-photouploader-pictures-withremove {\n    }\n\n.b-photouploader-pictures-withremove .b-photouploader-pictures-remove {\n        display: block;\n        }\n\n/* pictures with title */\n\n.b-photouploader-pictures-withtitle {\n    }\n\n.b-photouploader-pictures-withtitle .b-photouploader-pictures-title {\n        display: block;\n        }\n\n/* pictures with move pointer */\n\n.b-photouploader-pictures-withmove {\n    }\n\n.b-photouploader-pictures-withmove .b-photouploader-pictures-pic {\n        cursor: move;\n        }\n\n/* nav */\n\n.b-photouploader-nav {\n    position: absolute;\n    top: 0;\n    left: 0;\n    z-index: 2;\n    width: 100%;\n    margin: 0;\n    padding: 10px 0 25px;\n    list-style: none;\n    background: linear-gradient(to bottom, rgba(247,249,250,1) 0%,rgba(247,249,250,0) 100%);\n    }\n\n.b-photouploader-nav-item {\n        display: inline;\n        margin: 0;\n        padding: 0;\n        }\n\n.b-photouploader-nav-item:before {\n        content: \"/\";\n        }\n\n.b-photouploader-nav-item:first-child:before {\n        content: \"\";\n        }\n\n.b-photouploader-nav-item A:link,\n        .b-photouploader-nav-item A:visited {\n            border-bottom: 1px dotted;\n            text-decoration: none;\n            color: #0051B7 !important;\n            }\n\n.b-photouploader-nav-item A:hover,\n        .b-photouploader-nav-item A:active {\n            border-bottom: 1px dotted;\n            text-decoration: none;\n            color: #C00 !important;\n            }\n\n.b-photouploader-nav > SELECT {\n        width: 100%;\n        }\n\n/* albums */\n\n.b-photouploader-albums {\n    position: relative;\n    }\n\n.b-photouploader-albums-inner {\n        overflow: auto;\n        height: 250px;\n        margin: 0 -25px 0 -15px;\n        padding: 10px 15px 0;\n        background: #F7F9FA;\n        }\n\n/* albums with nav */\n\n.b-photouploader-albums-withnav {\n    }\n\n.b-photouploader-albums-withnav .b-photouploader-albums-inner {\n        padding-top: 40px;\n        }\n\n/* loading */\n\n.b-photouploader-albums-loading {\n    }\n\n.b-photouploader-albums-loading .b-photouploader-albums-inner:after {\n        content: \" \";\n        position: absolute;\n        bottom: 0;\n        left: 50%;\n        width: 30px;\n        height: 30px;\n        margin: 0 0 0 -15px;\n        padding: 0;\n        background: url(/img/preloader/preloader-blue-blue.gif?v=16423) no-repeat 0 0;\n        font: 0/0 a;\n        }\n\n.b-photouploader-search {\n    margin: 0 -15px 1px;\n    padding: 0 15px 15px;\n    border-bottom: 1px solid #CCC;\n    box-shadow: 0 1px 0 #FFF;\n    }\n\n.b-photouploader-search-input {\n        width: 100%;\n        box-sizing: border-box;\n        }\n\n.b-photouploader-subhead {\n    margin: 0 0 0.5em;\n    font-weight: bold;\n    font-size: 1em;\n    }\n\n.b-photouploader-subhead-annex {\n        font-weight: normal;\n        }\n\n.b-photouploader-subtext {\n    margin: 0 0 1em;\n    font-size: 1em;\n    line-height: 1.4;\n    }\n\n.b-photouploader-logout {\n    margin: 0;\n    }\n\n.b-photouploader .b-photouploader-logout:link,\n.b-photouploader .b-photouploader-logout:visited {\n    border-bottom: 1px dotted;\n    text-decoration: none;\n    color: #0051B7 !important;\n    }\n\n.b-photouploader .b-photouploader-logout:hover,\n.b-photouploader .b-photouploader-logout:active {\n    text-decoration: none;\n    color: #C00 !important;\n    }\n\n/* subhead at instagram panel */\n\n.b-photouploader-instahead {\n    margin: 0;\n    }\n\n.b-photouploader-instahead--center {\n    text-align: center;\n    }\n\n.b-photouploader-instahead:after {\n    content: \"\";\n    display: table;\n    border-collapse: collapse;\n    clear: both;\n    }\n\n.b-photouploader-instahead .b-photouploader-subhead {\n        float: left;\n        }\n\n.b-photouploader-instahead:not(.b-photouploader-instahead--center) .b-photouploader-logout {\n        float: right;\n        }\n\n.b-photouploader-instagram-signup:link {\n    display: inline-block;\n    position: relative;\n    margin: 0 0 1px;\n    padding: 0.5em 1.75em 0.5em 1em;\n    border: 1px solid #CCC;\n    border-right: 0.25em solid #00558D;\n    border-radius: 0.25em;\n    background: #F8F8F8;\n    text-shadow: 1px 1px #FFF;\n    text-decoration: none;\n    font-size: 1.5em;\n    color: #333;\n    }\n\n:root * > .b-photouploader-instagram-signup:before,\n:root * > .b-photouploader-instagram-signup:after {\n    content: \' \';\n    display: block;\n    position: absolute;\n    }\n\n.b-photouploader-instagram-signup:before {\n    top: 0;\n    right: 0;\n    width: 0.25em;\n    height: 100%;\n    background: #FBB03B;\n    border-left: 0.25em solid #D4145A;\n    border-right: 0.25em solid #00A99D;\n    }\n\n.b-photouploader-instagram-signup:after {\n    width: 100%;\n    height: 100%;\n    top: 0;\n    left: 0;\n    border-radius: 0.25em;\n    padding-left: 0.25em;\n    box-shadow: inset 1px 1px 0px rgba(255,255,255,0.5), inset -1px -1px 0 rgba(0,0,0,0.1);\n    background: linear-gradient(to bottom, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.2) 49%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 100%);\n    }\n\n.b-photouploader-instagram-signup,\n.b-photouploader-instagram-signup:before {\n    transition-property: background, border;\n    transition: 0.1s ease-in;\n    }\n\n.b-photouploader-instagram-signup:hover,\n.b-photouploader-instagram-signup:focus  {\n    background: #FFF;\n    }\n\n.b-photouploader-instagram-signup:hover {\n    border-right: 0.25em solid #09C;\n    }\n\n.b-photouploader-instagram-signup:hover:before {\n    background: #FC6;\n    border-left: 0.25em solid #F06;\n    border-right: 0.25em solid #0CC;\n    }\n\n.b-photouploader-instagram-signup:hover:after {\n    background: linear-gradient(to bottom, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 49%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.05) 100%);\n    }\n\n.b-photouploader-instagram-signup:active {\n    margin: 1px 0 0;\n    }\n\n.b-popup .b-photouploader-instagram-signup:link,\n.b-popup .b-photouploader-instagram-signup:visited,\n.b-popup .b-photouploader-instagram-signup:hover,\n.b-popup .b-photouploader-instagram-signup:active {\n    border: 1px solid #CCC;\n    border-right: 0.25em solid #00558D;\n    text-decoration: none;\n    }\n\n@media all and (max-width: 650px) {\n    .b-photouploader {\n        width: auto;\n        }\n\n    .b-photouploader-item {\n        padding-bottom: 0;\n        }\n\n    .b-photouploader-albums-withnav .b-photouploader-albums-inner {\n        margin-right: 0;\n        }\n        .b-photouploader-nav {\n            width: calc(100% - 15px);\n            }\n\n    /* separator */\n    .b-photouploader-albumsettings-separator {\n        display: block;\n        }\n    .b-photouploader-albumsettings-wrap {\n        float: none;\n        }\n\n    .b-photouploader-byurl {\n        margin-left: 0;\n        }\n        .b-photouploader-byurl-picture {\n            left: auto;\n            float: none;\n            width: 100%;\n            max-width: 380px;\n            margin: 0 auto 20px;\n            text-align: center;\n            }\n\n    .b-photouploader-byurl-src,\n    .b-photouploader-byurl-link {\n        width: 100%;\n        }\n}\n\n/* video uploader */\n\n.b-updateform-bubble-video-button {\n    padding: 15px 0 0 15px;\n    }\n\n.b-updateform-bubble-video-button:after{\n        content: \"\";\n        display: table;\n        clear: both;\n        }\n\n.b-updateform-bubble-video-button .b-flatbutton{\n        float: right;\n        }\n\n/* <<< file end: stc/photouploader.css */\n\n/*# sourceMappingURL=photouploader.css.map */\n');
LJ.injectStyle('/* >>> file start: stc/menu_v2.css */\n/* menu */\n\n/* items */\n\n.b-menu {\n    position: relative;\n    margin: 0;\n    padding: 0;\n    list-style: none;\n    }\n\n.b-menu:after {\n    content: \"\";\n    display: table;\n    border-collapse: collapse;\n    clear: both;\n    }\n\n/* item */\n\n.b-menu-item {\n        display: block;\n        font-family: \'ProximaNova\', Helvetica, sans-serif;\n        font-weight: 600;\n        text-transform: uppercase;\n        }\n\n/* link */\n\n.b-menu-item-link {\n            position: relative;\n            margin: 0;\n            padding: 0;\n            }\n\n.b-menu-item .b-menu-item-link:not(.b-menu-item-link-external):link,\n        .b-menu-item .b-menu-item-link:not(.b-menu-item-link-external):visited {\n            color: #7A9199;\n            }\n\n.b-menu-item .b-menu-item-link:not(.b-menu-item-link-external):hover,\n        .b-menu-item .b-menu-item-link:not(.b-menu-item-link-external):active {\n            color: #242F33;\n            }\n\n/* disabled */\n\n.b-menu-item-disabled {\n        opacity: 0.5;\n        color: #7A9199;\n        }\n\n.b-menu-item-disabled .b-menu-item-link {\n            pointer-events: none;\n            }\n\n/* active item */\n\n.b-menu-item-active {\n        color: #242F33;\n        }\n\n/* unread item */\n\n.b-menu-item-unread {\n        }\n\n/* horizontal menu */\n\n.b-menu-hrz {\n    }\n\n/* item */\n\n.b-menu-hrz .b-menu-item {\n        display: inline-block;\n        }\n\n/* pills */\n\n.b-menu-pills {\n    margin: 0;\n    font-size: 0.8125rem;\n    }\n\n/* item */\n\n.b-menu-pills .b-menu-item {\n        }\n\n/* link */\n\n.b-menu-pills .b-menu-item-link {\n            display: inline-block;\n            padding: 10px 13px;\n            }\n\n.b-menu-pills .b-menu-item-link:link,\n        .b-menu-pills .b-menu-item-link:visited {\n            color: #7A9199;\n            }\n\n.b-menu-pills .b-menu-item-link:hover,\n        .b-menu-pills .b-menu-item-link:active {\n            color: #00A3D9;\n            }\n\n/* active item */\n\n.b-menu-pills .b-menu-item-active {\n        padding: 0;\n        }\n\n.b-menu-pills .b-menu-item-active .b-menu-item-link {\n            background: #DAE3E6;\n            cursor: default;\n            }\n\n.b-menu-pills .b-menu-item-active .b-menu-item-link:hover,\n        .b-menu-pills .b-menu-item-active .b-menu-item-link:active {\n            color: #7A9199;\n            }\n\n/* pills horizontal */\n\n.b-menu-pills.b-menu-hrz {\n    margin: 0;\n    }\n\n/* item */\n\n.b-menu-pills.b-menu-hrz .b-menu-item {\n        }\n\n/* active horizontal item */\n\n.b-menu-pills.b-menu-hrz .b-menu-item-active {\n        padding: 0;\n        }\n\n/* tabs */\n\n.b-menu-tabs {\n    overflow: hidden;\n    margin: 0;\n    padding: 0;\n    }\n\n.b-menu-tabs:before {\n    content: \" \";\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    height: 0px;\n    border-bottom: 1px solid #dae3e6;\n    }\n\n/* item */\n\n.b-menu-tabs .b-menu-item {\n        position: relative;\n        display: inline-block;\n        margin: 0;\n        padding: 1em 1.5em;\n        text-align: center;\n        border: 1px solid transparent;\n        border-bottom: none;\n        vertical-align: top;\n        white-space: nowrap;\n        text-transform: uppercase;\n        letter-spacing: 0.05em;\n        font-size: 13px;\n        }\n\n/* active */\n\n.b-menu-tabs .b-menu-item-active {\n        padding: 1em 2em;\n        border-color: #dae3e6;\n        border-radius: 2px 2px 0 0;\n        background: #FFF;\n        }\n\n.b-menu-tabs .b-menu-item-active .b-menu-item-link {\n            display: inline;\n            margin: 0;\n            padding: 0;\n            border-radius: 0;\n            box-shadow: none;\n            background: transparent;\n            color: #242F33;\n            }\n\n/* tabs min */\n\n.b-menu-tabs-min {\n\n    }\n\n.b-menu-tabs-min .b-menu-item {\n        padding: 0.4em 0.7em;\n        }\n\n/* little */\n\n.b-menu-little {\n    }\n\n@media screen and (max-width: 1260px) {\n    .b-menu-tabs:not(.b-menu-little)::before {\n        content: none;\n        }\n    .b-menu-tabs:not(.b-menu-little) .b-menu-item-active {\n        border: 1px solid #DAE3E6;\n        }\n}\n\n@media screen and (max-width: 1050px) {\n    .b-menu-tabs .b-menu-item {\n        padding: 1em;\n        }\n    .b-menu-tabs-min .b-menu-item {\n        padding: 0.4em 0.7em;\n        }\n}\n\n@media screen and (max-width: 880px) {\n    .b-menu-tabs .b-menu-item:last-child {\n        margin-bottom: 10px;\n        }\n    .b-menu-tabs .b-menu-item-active {\n        border-bottom: 1px solid #DAE3E6;\n        }\n}\n\n@media print {\n    .b-menu {\n        display: none;\n        }\n}\n\n/* <<< file end: stc/menu_v2.css */\n\n/*# sourceMappingURL=menu_v2.css.map */\n');

Site.page.template['angular/video.ng.tmpl'] = '<div\n    class=\"b-photouploader\"\n    ng-controller=\"VideoEditorCtrl as video\"\n    >\n\n\n\n    <!-- menu -->\n    <ul\n        class=\"\n            b-menu\n            b-menu-hrz\n            b-menu-pills\n            b-menu-pseudo\n            b-photouploader-menu\n            \"\n        lj-pills-group=\"uploadVideo\"\n        ng-init=\"video.pill()\"\n        ng-if=\"video.state.canUpload\"\n        ><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"upload\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"video.pill(\'upload\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"videouploader.upload.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"album\"\n            ng-if=\"video.albums.all.length\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"video.pill(\'album\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"videouploader.album.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"embed\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"video.pill(\'embed\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"videouploader.embed.title\"\n                ></a>\n        </li><!--\n    --></ul>\n\n\n    <!-- items -->\n    <div class=\"b-photouploader-items\">\n\n\n\n        <!-- upload from computer -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-upload\n                \"\n            ng-class=\"\'b-photouploader-item-upload-\' + upload.state()\"\n            ng-if=\"video.state.canUpload && video.state.isOpen && video.isPill(\'upload\')\"\n            >\n            <!-- insert upload directive -->\n            <div lj-video-uploader\n                 lj-video-uploader-callback=\"video.records.insertUploadedRecord(record)\"\n                 lj-video-uploader-cancel=\"video.bubble.close()\"\n                />\n\n        </div><!-- /uploads item -->\n\n\n\n        <!-- select from albums -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-albums\n                \"\n            ng-hide=\"!video.isPill(\'album\') || !video.albums.all.length\"\n            >\n\n            <!-- albums -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-albums\n                    \"\n                >\n\n                <h4\n                    class=\"b-photouploader-subhead\"\n                    lj-ml=\"videouploader.album.select\"\n                    ></h4>\n\n                <div class=\"\n                        b-photouploader-albums\n                        b-photouploader-albums-withnav\n                        \">\n                    <div\n                        class=\"b-photouploader-albums-inner\"\n                        lj-when-scrolled=\"albums.loadMore()\"\n                        >\n                        <!-- albums nav -->\n                        <div\n                            class=\"b-photouploader-nav\"\n                            >\n                            <label\n                                for=\"albums\"\n                                class=\"b-photouploader-nav-label\"\n                                lj-ml=\"photouploader.album.your\"\n                                ></label>\n                            <select\n                                id=\"albums\"\n                                class=\"b-photouploader-albums-select sharp-select\"\n                                ng-model=\"video.albums.current\"\n                                ng-options=\"item as item.name for item in video.albums.all\"\n                                >\n                            </select>\n                        </div>\n\n                        <!-- pictures -->\n                        <ul\n                            class=\"\n                                b-photouploader-pictures\n                                b-photouploader-pictures-withtitle\n                                b-photouploader-pictures-withmove\n                                \"\n                            lj-ref=\"videoUploader\"\n                            ng-model=\"video.records.current\"\n                            >\n                            <li\n                                class=\"b-photouploader-pictures-item\"\n                                ng-repeat=\"record in video.records.all\"\n                                ng-click=\"video.records.toggleRecord(record)\"\n                                ng-class=\"{ \'selected\': record.selected }\"\n                                >\n                                <span class=\"b-photouploader-pictures-pic\"><!--\n                                    --><img\n                                        class=\"b-photouploader-pictures-img\"\n                                        ng-src=\"{{ record.screenshot }}\"\n                                        ><!--\n                                --></span>\n                                <strong\n                                    class=\"b-photouploader-pictures-title\"\n                                    ng-bind=\"record.name\"\n                                    ng-show=\"record.name\"\n                                    ><!--\n                                --></strong>\n                            </li>\n                        </ul>\n\n                    </div>\n                </div><!-- /albums -->\n\n            </div>\n\n            <!-- controls -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-controls\n                    \"\n                >\n                <div\n                    class=\"\n                        b-ljbutton\n                        b-ljbutton-submit\n                        \"\n                    >\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        lj-disabled=\"video.records.noneSelected()\"\n                        lj-ml=\"videouploader.album.insert\"\n                        ></button>\n                </div>\n                <button\n                    type=\"submit\"\n                    name=\"submit\"\n                    class=\"\n                        b-flatbutton\n                        b-flatbutton-simple\n                        \"\n                    lj-disabled=\"video.records.noneSelected()\"\n                    ng-click=\"video.insert()\"\n                    lj-ml=\"videouploader.album.insert\"\n                    ></button>\n            </div>\n\n        </div><!-- /albums item -->\n\n\n        <div\n            class=\"b-photouploader-item\n                b-photouploader-item-embed\"\n            ng-hide=\"!video.isPill(\'embed\') && video.state.canUpload\"\n            ng-controller=\"MediaCtrl\">\n            <div class=\"b-updateform-bubble-video-fields\">\n\n                <label for=\"updateform-video-url\"\n                       lj-ml=\"talk.video\"></label>\n                <br>\n\n                <textarea\n                    rows=\"5\"\n                    cols=\"60\"\n                    id=\"updateform-video-url\"\n                    class=\"\n                        b-updateform-bubble-input\n                        b-input\n                        b-input-max\n                        \"\n                    ng-model=\"media\"\n                    focus-and-select=\"show\"\n                    lj-enter=\"insert()\"\n                    lj-enter-with-meta\n                    ></textarea>\n\n                <span\n                    class=\"b-updateform-bubble-hint\"\n                    ng-click=\"setHint($event)\"\n                    lj-ml=\"talk.video.paste\"\n                    ></span>\n            </div>\n\n            <div class=\"b-updateform-bubble-video-button\">\n                <div\n                    class=\"\n                        b-ljbutton\n                        b-ljbutton-submit\n                        \"\n                    >\n                    <button\n                        type=\"button\"\n                        lj-disabled=\"!media\"\n                        ng-click=\"insert()\"\n                        lj-ml=\"talk.video.insert\">\n                    </button>\n                </div>\n                <button\n                    type=\"button\"\n                    class=\"\n                        b-flatbutton\n                        b-flatbutton-simple\n                        \"\n                    lj-disabled=\"!media\"\n                    ng-click=\"insert()\"\n                    lj-ml=\"talk.video.insert\">\n                </button>\n            </div>\n        </div>\n\n    </div><!-- /items -->\n\n\n\n</div>\n';

//= require_ml videouploader.embed.title
//= require_ml videouploader.upload.title
//= require_ml videouploader.byUrl.title
//= require_ml videouploader.album.title
//= require_ml videouploader.album.select
//= require_ml videouploader.album.insert
//= require_ml videouploader.noalbum

//= require_ml tour.video_update_tour.tip

//= require_ml talk.video
//= require_ml talk.video.paste
//= require_ml talk.video.insert

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Video.Editor', ['LJ.AuthHelper', 'LJ.Messages', 'LJ.Pills', 'LJ.Api', 'Video.Uploader', 'Video.Service', 'Editor']).controller('VideoEditorCtrl', ['$scope', '$timeout', '$q', 'Api', 'Editor', 'Pills', 'Ref', 'Video', VideoEditorCtrl]);

  function VideoEditorCtrl($scope, $timeout, $q, Api, Editor, Pills, Ref, Video) {
    var that = this;

    this.state = {
      canUpload: LJ.get('remote') && !LJ.get('remote_is_identity'),
      isOpen: false
    };

    this.bubble = $scope.bubble;

    this.isPill = function (pillName) {
      return Pills.group('uploadVideo') === pillName;
    };

    this.pill = function (pillName) {
      pillName = pillName || LJ.Storage.getItem('videoUploadPill') || 'upload';

      Pills.group('uploadVideo', pillName);
      LJ.Storage.setItem('videoUploadPill', pillName);
    };

    this.albums = {
      init: function init() {
        return Video.fetchAlbums({ user: LJ.get('remote.username') }).then(function () {
          if (Video.getAlbums().length) {
            that.albums.all = Video.getAlbums();
            that.albums.current = Video.getAlbums()[0];
          }
        });
      },

      // Map album objects to album ids
      mapped: function mapped(id) {

        if (!that.albums._mappedAlbums) {
          that.albums._mappedAlbums = Video.getAlbums().reduce(function (albums, album) {
            albums[album.id] = album;
            return albums;
          }, {});
        }

        return id ? that.albums._mappedAlbums[id] : that.albums._mappedAlbums[that.albums.current.id];
      }
    };

    this.records = {
      request: function request(options) {
        options = options || {};

        if (!that.state.canUpload) {
          return $q.reject();
        }

        return Api.call('video.get_records', options).then(function (response) {
          if (response.records) {
            that.records.all = response.records.slice();
            return response.records;
          }
        });
      },
      insertRecords: function insertRecords(videoIds, options) {
        options = options || {};

        if (!Array.isArray(videoIds)) {
          videoIds = [videoIds];
        }

        options.ids = videoIds;

        return that.records.request(options).then(function (records) {
          that.records.all = records.map(function (item) {
            item.selected = true;
            return item;
          });
          that.insert();
        });
      },
      insertUploadedRecord: function insertUploadedRecord(record) {
        that.records.toggleRecord(record);
        that.records.all = [record];
        that.insert();
      },
      toggleRecord: function toggleRecord(record) {
        record.selected = !record.selected;
      },
      noneSelected: function noneSelected() {
        return (that.records.all || []).filter(LJ.Function.get('selected')).length === 0;
      }
    };

    $scope.$watch(function () {
      return that.albums.current;
    }, function (selectedAlbum, previousAlbum) {
      if (selectedAlbum && selectedAlbum !== previousAlbum) {

        Video.fetchRecords(selectedAlbum.id, { user: LJ.get('remote.username') }).then(function () {
          that.records.all = Video.getRecordsByAlbumId(selectedAlbum.id);
          Ref.scrollTo('videoUploader', { toParent: true });
        });
      }
    });

    that.insert = function () {
      if (!that.records.all) {
        return;
      }

      var embed = '<iframe data-link="{url}" data-thumbnail="{thumbnail}" frameBorder="0" height="315" src="{url}" width="560" allowfullscreen="allowfullscreen"></iframe>',
          selected = that.records.all.filter(LJ.Function.get('selected')).map(function (item) {
        item.thumbnail = item.screenshot;
        item.embed = embed.supplant(item);
        item.link = item.url;
        return item;
      });

      tryToInsert();

      function tryToInsert() {

        try {
          Editor.insertContent('video', selected.map(LJ.Function.get('embed')).join('\n'), selected.map(toPromise), selected);

          $scope.bubble.close();
        } catch (e) {
          if (that.state.isOpen) {
            $timeout(tryToInsert);
          }
        }
      }
    };

    $scope.$on('bubble:open:video', function () {
      if (that.state.canUpload) {
        that.albums.init();
      }

      that.state.isOpen = true;
    });

    $scope.$on('bubble:close:video', function () {
      if (that.state.canUpload && that.albums.all && that.records.all) {
        that.records.all.filter(LJ.Function.get('selected')).map(function (record) {
          delete record.selected;
        });
      }

      that.state.isOpen = false;
    });

    LJ.Event.on('video:upload:done', function () {
      that.bubble.close();
    });

    function toPromise(value) {
      var defer = $q.defer();

      defer.resolve(value);
      return defer.promise;
    }

    function checkUrl() {
      var videoIds = LiveJournal.parseGetArgs().video_id,
          recordId = LiveJournal.parseGetArgs().record_id;

      if (videoIds) {
        that.records.insertRecords(videoIds.split(','), { user: LiveJournal.parseGetArgs().user });
      }

      if (recordId) {
        Video.fetchRecordByStorageId(recordId).then(function (record) {
          that.records.all = [record];
          that.records.toggleRecord(record);
          that.insert();
        });
      }
    }

    // Start video tour
    function addTour() {
      angular.element('.cke_button_LJEmbedLink').attr({
        ljTour: '',
        dataTour: 'video_update_tour',
        dataStep: '1',
        dataTourText: 'tour.regionalrating.step1.tip'
      });
    }

    // On dev server CKEditor plugin are async loaded.
    if (LJ.get('is_dev_server')) {
      LJ.Event.on('rte_embed_ready', function () {
        checkUrl();
        addTour();
      });
    } else {
      $timeout(function () {
        checkUrl();
        addTour();
      });
    }
  }
})();
/* <<< file end: js/video/editor.js */

//# map link was there [editor.js.map]
/* >>> file start: js/editor/basicToolbar.js */
//= require js/core/string.js

//= require js/core/angular/api.js
//= require js/core/angular/autocomplete.js
//= require js/core/angular/bubble.js
//= require js/core/angular/users.js

//= require js/editor/editor.js
//= require js/editor/media.js

//= require js/video/editor.js
//= require js/editor/photouploader.js
//= require js/photo/editor.js

/*
 * Module is responsible for buttons:
 * - Link
 * - User
 * - Embed
 *
 * This buttons are used on both update.bml and S1 comments.
 *
 * @author
 *   Artem Tyurin (artem.tyurin@sup.com)
 */

(function (a) {
  return a;
})();

(function ($) {

  'use strict';

  angular.module('BasicToolbar', ['LJ.Api', 'LJ.Autocomplete', 'LJ.Bubble', 'LJ.Photouploader', 'Photo.Editor', 'Video.Editor', 'Editor', 'Users']).controller('MediaCtrl', ['$scope', 'Editor', function ($scope, Editor) {

    $scope.media = '';

    $scope.setHint = function ($event) {
      var target = $event.target,
          href = target.getAttribute('href');

      if (href) {
        $scope.media = href;
      }

      $event.preventDefault();
    };

    $scope.getMedia = function (input) {
      var media = LJ.Media.parse(input, { thumbnail: false }),
          dfd = $.Deferred();

      if (media) {
        // deferred
        media.then(function (result) {
          if (result && result.embed) {
            dfd.resolve(result);
            LJ.Track.event('Editor', 'Embed', result.site);
          }
        });
      } else if (/^<(embed|iframe|object).*>$/.test(input)) {
        dfd.resolve({ embed: ['<lj-embed>', input, '</lj-embed>'].join('\n') });
        LJ.Track.event('Editor', 'Embed', 'lj-embed');
      } else {
        dfd.resolve({ embed: '<a href="{link}">{caret}{link}{caret}</a>'.supplant({ link: input }) });
        LJ.Track.event('Editor', 'Embed', 'link (not parsed)');
      }

      return dfd;
    };

    $scope.insert = function () {
      $.when($scope.getMedia($scope.media)).done(function (result) {
        Editor.insertContent('video', result.embed, $scope.media);
        $scope.media = '';
      });
      $scope.bubble.close();
    };
  }]).controller('LinkCtrl', ['$scope', 'Editor', function ($scope, Editor) {

    $scope.newWindow = typeof LJ.Storage.getItem('newWindow') !== 'undefined' ? LJ.Storage.getItem('newWindow') : true;

    $scope.unlink = function () {
      LJ.Event.trigger('unlink'); // visual editor handles the event
      $scope.bubble.close();
    };

    $scope.saveOption = function () {
      LJ.Storage.setItem('newWindow', $scope.newWindow);
    };

    $scope.$on('bubble:open:link', function () {
      $scope.link = $scope.bubble.options.defaultText || '';
      $scope.showUnlink = !!($scope.bubble.options.rangeNotCollapsed || $scope.bubble.options.editMode);

      // notice, that 'new window' option could be changed
      // not only manually, but also when editing link in RTE mode

      if (typeof $scope.bubble.options.hasTarget !== 'undefined') {
        $scope.newWindow = $scope.bubble.options.hasTarget;
      } else {
        if (typeof LJ.Storage.getItem('newWindow') !== 'undefined') {
          $scope.newWindow = LJ.Storage.getItem('newWindow');
        }
      }
    });

    $scope.insertOrSave = function (event) {
      event.preventDefault();

      /*
       * If there is selected text, surround it with <a></a>,
       * otherwise use href as link text and move caret after </a>.
       */

      Editor.insertContent('link', '<a href="{text}"{target}>{caret}{text}{caret}</a>'.supplant({
        text: LJ.String.linkify($scope.link),
        target: $scope.newWindow ? ' target="_blank"' : ''
      }), {
        url: $scope.link,
        target: $scope.newWindow ? '_blank' : ''
      });

      $scope.link = '';
      $scope.bubble.close();
    };
  }]).controller('UserCtrl', ['$scope', 'Editor', 'Api', 'Users', function ($scope, Editor, Api, Users) {

    $scope.friends = null;

    $scope.$on('bubble:open:user', function () {
      $scope.user = $scope.bubble.options.user || '';

      if (LJ.get('remote') && !$scope.friends) {
        Users.fetchFriends().then(function (response) {
          $scope.friends = response.map(LJ.Function.get('username'));
        });
      }

      // title could be one of: undefined, 'undefined', or actual title string
      $scope.title = $scope.bubble.options.title === 'undefined' ? '' : $scope.bubble.options.title || '';
      $scope.error = false;
    });

    $scope.$watch('user', function () {
      $scope.error = false;
    });

    $scope.insertOrSave = function () {

      if (!$scope.user) {
        return;
      }

      var argument = arguments[0];
      if (angular.isString(argument) && argument.length > $scope.user.length) {
        $scope.user = argument;
      }
      Api.call('ljuser.get', { user: $scope.user, raw: true }, function (data) {
        if (data.error) {
          $scope.error = true;
        } else {
          Editor.insertContent('user', '<lj user="{caret}{text}{caret}" />'.supplant({
            text: $scope.user
          }), data, $scope.title);

          $scope.user = '';
          $scope.title = '';

          $scope.bubble.close();
        }
      });
    };
  }]);
})(jQuery);
/* <<< file end: js/editor/basicToolbar.js */

//# map link was there [basicToolbar.js.map]
/* >>> file start: js/editor/photouploader.js */


//= require js/lib/jquery-ui/jquery.ui.mouse.min.js
//= require js/lib/jquery-ui/jquery.ui.sortable.min.js
//= require js/lib/angular/ui/sortable.js

//= require js/core/string.js

//!= require js/core/angular/messages.js
//= require js/core/angular/pills.js
//= require js/core/angular/plupload.js
//= require js/core/angular/authHelper.js
//= require js/editor/basicToolbar.js

// error: photouploader.css is already included
// error: menu_v2.css is already included

Site.page.template['angular/photouploader.ng.tmpl'] = '<div\n    class=\"b-photouploader\"\n    ng-controller=\"PhotouploaderCtrl\"\n    >\n\n\n\n    <!-- menu -->\n    <ul\n        class=\"\n            b-menu\n            b-menu-hrz\n            b-menu-pills\n            b-menu-pseudo\n            b-photouploader-menu\n            \"\n        lj-pills-group=\"photouploader\"\n        ><!--\n        --><li\n            class=\"b-menu-item b-menu-item-active\"\n            data-pill=\"upload\"\n            ng-if=\"hasUploadAbilities\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"pills.select(\'upload\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.upload.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"album\"\n            ng-if=\"hasUploadAbilities && hasAlbums()\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"pills.select(\'album\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.album.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"paste\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"pills.select(\'paste\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.paste.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"dropbox\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"pills.select(\'dropbox\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.dropbox.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"instagram\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"pills.select(\'instagram\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.instagram.title\"\n                ></a>\n        </li><!--\n    --></ul>\n\n\n    <!-- items -->\n    <div class=\"b-photouploader-items\">\n\n\n\n        <!-- upload from computer -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-upload\n                \"\n            ng-hide=\"!pills.isActive(\'upload\')\"\n            ng-class=\"\'b-photouploader-item-upload-\' + upload.state()\"\n            ng-if=\"hasUploadAbilities && pills.isActive(\'upload\')\"\n            >\n\n            <!-- upload form -->\n            <div\n                id=\"upload-panel\"\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-upload\n                    \"\n                >\n                <div class=\"b-photouploader-uploader\"\n                     plupload=\"upload.url\"\n                     plupload-options=\"pluploadOptions\"\n                     plupload-callbacks=\"pluploadCallbacks\"\n                     ng-hide=\"!uploaderInit\"\n                     >\n                    <p\n                        class=\"b-photouploader-uploader-drop\"\n                        lj-ml=\"photouploader.upload.drop\"\n                        ></p>\n                    <p\n                        class=\"b-photouploader-uploader-nodrop\"\n                        lj-ml=\"photouploader.upload.nodrop\"\n                        ></p>\n                    <input\n                        type=\"file\"\n                        multiple=\"multiple\"\n                        id=\"pickfiles\"\n                        value=\"Choose an image to upload\"\n                        class=\"b-photouploader-uploader-input\"\n                        ng-hide=\"upload.inProgress\"\n                        >\n                    <ol class=\"b-photouploader-uploader-list\">\n                        <li\n                            class=\"b-photouploader-uploader-list-item\"\n                            ng-repeat=\"file in upload.files\"\n                            >\n                            {{ file.name }} &mdash; {{ file.percent }}% ({{ file.formattedSize }})\n\n                            <a\n                                href=\"\"\n                                ng-show=\"file.percent < 100\"\n                                ng-click=\"upload.cancel(file);\"\n                                lj-ml=\"photouploader.upload.cancel\"\n                                ></a>\n                        </li>\n                    </ol>\n                </div>\n                <div class=\"b-photouploader-initfail\" ng-if=\"!uploaderInit\">\n                    <span class=\"b-photouploader-initfail-flash\" lj-ml=\"photouploader.upload.initFail\"></span>\n                </div>\n            </div>\n\n            <!-- select pictures -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-pictures\n                    \"\n                >\n                <ul\n                    class=\"\n                        b-photouploader-pictures\n                        b-photouploader-pictures-withremove\n                        b-photouploader-pictures-withmove\n                        \"\n                    ui-sortable=\"ui.sortableOptions\"\n                    ng-model=\"albums.current.photos\"\n                    >\n                    <li\n                        class=\"b-photouploader-pictures-item\"\n                        ng-repeat=\"photo in upload.photos()\"\n                        >\n                        <span class=\"b-photouploader-pictures-pic\"><!--\n                            --><img\n                                class=\"b-photouploader-pictures-img\"\n                                ng-src=\"{{ photo.photo_src }}\"\n                                ><!--\n                        --></span>\n                        <span\n                            class=\"b-photouploader-pictures-remove\"\n                            title=\"Remove Picture\"\n                            ng-click=\"upload.removePhoto(photo);\"\n                            lj-ml=\"photouploader.upload.remove\"\n                            lj-ml-attr=\"title\"\n                            ></span>\n                    </li>\n                </ul>\n            </div>\n\n            <!-- controls -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-controls\n                    \"\n                >\n                <div class=\"b-photouploader-albumselector\">\n                    <div class=\"b-photouploader-albumselector-item\">\n                        <span\n                            class=\"b-photouploader-albumselector-albums\"\n                            ng-show=\"!newAlbum\"\n                            >\n                            <label\n                                for=\"album\"\n                                class=\"b-photouploader-albumselector-label\"\n                                lj-ml=\"photouploader.upload.addto\"\n                                ></label>\n                            <select\n                                id=\"album\"\n                                class=\"b-photouploader-albumselector-select\"\n                                ng-model=\"upload.album\"\n                                ng-options=\"item as item.album_title for item in albums.list\"\n                                >\n                            </select>\n                            <span lj-ml=\"photouploader.upload.or\"></span>\n                            <a\n                                href=\"javascript:void(0);\"\n                                ng-click=\"newAlbum = true;\"\n                                lj-ml=\"photouploader.upload.create\"\n                                ></a>\n                        </span>\n                        <span\n                            class=\"b-photouploader-albumselector-newalbum\"\n                            ng-show=\"newAlbum\"\n                            >\n                            <label\n                                for=\"album\"\n                                class=\"b-photouploader-albumselector-label\"\n                                lj-ml=\"photouploader.album.create\"\n                                ></label>\n                            <input\n                                type=\"text\"\n                                id=\"\"\n                                value=\"\"\n                                size=\"40\"\n                                class=\"b-photouploader-albumselector-input\"\n                                ng-model=\"upload.newAlbumName\"\n                                >\n                            <br>\n                            <a\n                                href=\"javascript:void(0);\"\n                                ng-click=\"newAlbum = false;\"\n                                lj-ml=\"photouploader.upload.back\"\n                                ></a>\n                        </span>\n                    </div>\n                    <div class=\"b-photouploader-albumselector-item\">\n                        <label\n                            for=\"privacy\"\n                            class=\"b-photouploader-albumselector-label\"\n                            lj-ml=\"photouploader.upload.privacy\"\n                            ></label>\n                        <select\n                            id=\"privacy\"\n                            class=\"b-photouploader-albumselector-select\"\n                            ng-model=\"upload.privacy.current\"\n                            ng-options=\"item as item.groupname for item in upload.privacy.list\"\n                            >\n                        </select>\n                    </div>\n\n                    <div class=\"b-photouploader-albumselector-item\">\n                        <label\n                            for=\"upload-size\"\n                            class=\"b-photouploader-albumselector-label\"\n                            lj-ml=\"photouploader.upload.size\"\n                            ></label>\n                        <select\n                            id=\"upload-size\"\n                            class=\"b-photouploader-albumselector-select\"\n                            ng-model=\"ui.size.current\"\n                            ng-options=\"item as item.text for item in ui.size.list\"\n                            >\n                        </select>\n                    </div>\n\n\n                    <div class=\"b-photouploader-albumselector-item\">\n                        <input\n                            type=\"checkbox\"\n                            id=\"linktoneworiginal\"\n                            class=\"b-photouploader-albumselector-check\"\n                            ng-model=\"albums.originalLink\"\n                            />\n                        <label\n                            for=\"linktoneworiginal\"\n                            class=\"b-photouploader-albumselector-label\"\n                            lj-ml=\"photouploader.upload.addlink\"\n                            ></label>\n                    </div>\n\n                </div>\n\n                <div\n                    class=\"\n                        b-ljbutton\n                        b-ljbutton-submit\n                        \"\n                    >\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        ng-click=\"upload.insert()\"\n                        lj-disabled=\"ui.insertInProgress\"\n                        lj-ml=\"photouploader.upload.insert\"\n                        ></button>\n                </div>\n\n                <!--\n                <button\n                    type=\"submit\"\n                    name=\"submit\"\n                    class=\"\n                        b-flatbutton\n                        b-flatbutton-simple\n                        \"\n                    ng-click=\"upload.insert()\"\n                    lj-disabled=\"ui.insertInProgress\"\n                    lj-ml=\"photouploader.upload.insert\"\n                    ></button> -->\n\n                <lj-flatbutton lj-flatbutton=\"[\'submit\', \'photouploader.upload.insert\', \'b-flatbutton b-flatbutton-simple\', \'ng-click\', \'upload.insert()\', \'lj-disabled\', \'ui.insertInProgress\', \'name\', \'submit\']\"></lj-flatbutton>\n\n            </div>\n\n        </div><!-- /uploads item -->\n\n\n\n        <!-- select from albums -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-albums\n                \"\n            ng-show=\"pills.isActive(\'album\')\"\n            ng-if=\"hasUploadAbilities\"\n            >\n\n            <!-- albums -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-albums\n                    \"\n                >\n\n                <h4\n                    class=\"b-photouploader-subhead\"\n                    lj-ml=\"photouploader.album.select\"\n                    ></h4>\n\n                <div class=\"\n                        b-photouploader-albums\n                        b-photouploader-albums-withnav\n                        \">\n                    <div\n                        class=\"b-photouploader-albums-inner\"\n                        lj-when-scrolled=\"albums.loadMore()\"\n                        >\n                        <!-- albums nav -->\n                        <div\n                            class=\"b-photouploader-nav\"\n                            >\n                            <label\n                                for=\"albums\"\n                                class=\"b-photouploader-nav-label\"\n                                lj-ml=\"photouploader.album.your\"\n                                ></label>\n                            <select\n                                id=\"albums\"\n                                ng-model=\"albums.current\"\n                                ng-options=\"item as item.album_title for item in albums.list\"\n                                >\n                            </select>\n                        </div>\n\n                        <!-- pictures -->\n                        <ul\n                            class=\"\n                                b-photouploader-pictures\n                                b-photouploader-pictures-withtitle\n                                b-photouploader-pictures-withmove\n                                \"\n                            ng-model=\"albums.current.photos\"\n                            >\n                            <li\n                                class=\"b-photouploader-pictures-item\"\n                                ng-repeat=\"photo in albums.current.photos\"\n                                ng-click=\"albums.togglePhoto(photo)\"\n                                ng-class=\"{ \'selected\': photo.selected }\"\n                                >\n                                <span class=\"b-photouploader-pictures-pic\"><!--\n                                    --><img\n                                        class=\"b-photouploader-pictures-img\"\n                                        ng-src=\"{{ photo.photo_url || photo.photo_src }}\"\n                                        ><!--\n                                --></span>\n                                <strong\n                                    class=\"b-photouploader-pictures-title\"\n                                    ng-bind=\"photo.photo_title\"\n                                    ng-show=\"photo.photo_title\"\n                                    ><!--\n                                --></strong>\n                            </li>\n                        </ul>\n\n                    </div>\n                </div><!-- /albums -->\n\n            </div>\n\n            <!-- controls -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-controls\n                    \"\n                >\n                <div class=\"b-photouploader-albumsettings\">\n                    <label\n                        for=\"sizepictures\"\n                        class=\"b-photouploader-albumsettings-label\"\n                        lj-ml=\"photouploader.album.size\"\n                        ></label>\n                    <select\n                        id=\"sizepictures\"\n                        class=\"b-photouploader-albumsettings-select\"\n                        ng-model=\"ui.size.current\"\n                        ng-options=\"item as item.text for item in ui.size.list\"\n                        >\n                    </select>\n                    <input\n                        type=\"checkbox\"\n                        id=\"linktooriginal\"\n                        class=\"b-photouploader-albumsettings-check\"\n                        ng-model=\"albums.originalLink\"\n                        />\n                    <label\n                        for=\"linktooriginal\"\n                        class=\"b-photouploader-albumsettings-label\"\n                        lj-ml=\"photouploader.album.addlink\"\n                        ></label>\n                </div>\n                <div\n                    class=\"\n                        b-ljbutton\n                        b-ljbutton-submit\n                        \"\n                    >\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        lj-disabled=\"albums.noneSelected() || ui.insertInProgress\"\n                        ng-click=\"albums.insert()\"\n                        lj-ml=\"photouploader.album.insert\"\n                        ></button>\n                </div>\n                <!-- \n                <button\n                    type=\"submit\"\n                    name=\"submit\"\n                    class=\"\n                        b-flatbutton\n                        b-flatbutton-simple\n                        \"\n                    lj-disabled=\"albums.noneSelected() || ui.insertInProgress\"\n                    ng-click=\"albums.insert()\"\n                    lj-ml=\"photouploader.album.insert\"\n                    ></button>\n                -->\n                <lj-flatbutton lj-flatbutton=\"[\'submit\', \'photouploader.album.insert\', \'b-flatbutton b-flatbutton-simple\', \'name\', \'submit\', \'lj-disabled\', \'albums.noneSelected() || ui.insertInProgress\', \'ng-click\', \'albums.insert()\']\">\n                </lj-flatbutton>\n            </div>\n\n        </div><!-- /albums item -->\n\n\n\n        <!-- by url -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-url\n                \"\n            ng-show=\"pills.isActive(\'paste\')\"\n            >\n\n            <form ng-submit=\"paste.insertUrl()\">\n\n                <!-- url form -->\n                <div\n                    class=\"\n                        b-photouploader-panel\n                        b-photouploader-panel-url\n                        \"\n                    >\n\n                    <dl class=\"b-photouploader-byurl\">\n\n                        <dt class=\"b-photouploader-byurl-picture\">\n                            <img\n                                ng-src=\"{{ paste.url }}\"\n                                ng-show=\"paste.url\"\n                                class=\"b-photouploader-byurl-image\"\n                                >\n                            <span\n                                ng-show=\"!paste.url\"\n                                class=\"b-photouploader-byurl-sub\"\n                                lj-ml=\"photouploader.paste.correctUrl\"\n                                ></span>\n                        </dt>\n\n                        <dd class=\"b-photouploader-byurl-form\">\n                            <label\n                                for=\"url\"\n                                class=\"b-photouploader-byurl-label\"\n                                lj-ml=\"photouploader.paste.pasteURL\"\n                                ></label>\n                            <br class=\"b-photouploader-byurl-br\">\n                            <input\n                                type=\"text\"\n                                id=\"url\"\n                                size=\"55\"\n                                class=\"b-photouploader-byurl-src\"\n                                placeholder=\"https://\"\n                                ng-model=\"paste.url\"\n                                focus-and-select=\"pills.isActive(\'paste\')\"\n                                >\n                            <br class=\"b-photouploader-byurl-br\">\n                            <em\n                                class=\"b-photouploader-byurl-note\"\n                                lj-ml=\"photouploader.paste.notice\"\n                                ></em>\n                        </dd>\n\n                        <dd class=\"b-photouploader-byurl-form\">\n                            <label\n                                for=\"imagelink\"\n                                class=\"b-photouploader-byurl-label\"\n                                lj-ml=\"photouploader.paste.link\"\n                                ></label>\n                            <br class=\"b-photouploader-byurl-br\">\n                            <input\n                                type=\"text\"\n                                id=\"imagelink\"\n                                size=\"35\"\n                                class=\"b-photouploader-byurl-link\"\n                                placeholder=\"https://\"\n                                ng-model=\"paste.link\"\n                                >\n                        </dd>\n\n                    </dl>\n\n                </div><!-- /panel -->\n\n                <!-- controls -->\n                <div\n                    class=\"\n                        b-photouploader-panel\n                        b-photouploader-panel-controls\n                        \"\n                    >\n                    <div class=\"b-photouploader-urlsettings\">\n                        <label\n                            for=\"picturesize\"\n                            class=\"b-photouploader-urlsettings-label\"\n                            lj-ml=\"photouploader.paste.size\"\n                            ></label>\n                        <select\n                            id=\"picturesize\"\n                            class=\"b-photouploader-urlsettings-select\"\n                            ng-model=\"ui.size.current\"\n                            ng-options=\"item as item.text for item in ui.size.list\"\n                            >\n                        </select>\n                    </div>\n                    <div\n                        class=\"\n                            b-ljbutton\n                            b-ljbutton-submit\n                            \"\n                        >\n                        <button\n                            type=\"submit\"\n                            name=\"submit\"\n                            lj-disabled=\"!paste.url\"\n                            lj-ml=\"photouploader.paste.insert\"\n                            ></button>\n                    </div>\n\n                    <!--\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        class=\"\n                            b-flatbutton\n                            b-flatbutton-simple\n                            \"\n                        lj-disabled=\"!paste.url\"\n                        lj-ml=\"photouploader.paste.insert\"\n                        ></button>\n                    -->\n                    <lj-flatbutton lj-flatbutton=\"[\'submit\', \'photouploader.paste.insert\', \'b-flatbutton b-flatbutton-simple\', \'lj-disabled\', \'!paste.url\', \'name\', \'submit\']\">\n                    </lj-flatbutton>\n\n\n                </div><!-- /panel -->\n\n            </form>\n\n        </div><!-- /url item -->\n\n\n\n        <!-- dropbox -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-dropbox\n                \"\n            ng-show=\"pills.isActive(\'dropbox\')\"\n            >\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-dropbox\n                    \"\n                >\n                <p\n                    class=\"b-photouploader-panel-dropbox-intro\"\n                    lj-ml=\"photouploader.dropbox.choose\"\n                    ></p>\n                <span lj-dropbox-button></span>\n            </div>\n        </div><!-- /dropbox item -->\n\n\n\n        <!-- instagram -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-instargam\n                \"\n            ng-show=\"pills.isActive(\'instagram\')\"\n            >\n\n            <!-- login to instagram -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-instalogin\n                    \"\n                ng-show=\"!instagram.token()\"\n                >\n                <p\n                    class=\"b-photouploader-panel-instalogin-intro\"\n                    lj-ml=\"photouploader.instagram.intro\"\n                    ></p>\n                <a\n                    href=\"javascript:void(0);\"\n                    class=\"b-photouploader-instagram-signup\"\n                    ng-click=\"instagram.login()\"\n                    lj-ml=\"photouploader.instagram.loginButton\"\n                    ></a>\n            </div>\n\n            <!-- select pictures from instagram -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-pictures\n                    \"\n                ng-show=\"instagram.token()\"\n                >\n\n                <div class=\"b-photouploader-instahead\">\n                    <h4 class=\"b-photouploader-subhead\">\n                        <span\n                            lj-ml=\"photouploader.instagram.select\"\n                            ></span>\n                        <span\n                            class=\"b-photouploader-subhead-annex\"\n                            lj-ml=\"photouploader.instagram.select.help\"\n                            ></span>\n                    </h4>\n\n                    <a\n                        class=\"b-photouploader-logout\"\n                        href=\"javascript:void(0);\"\n                        ng-click=\"instagram.logout()\"\n                        lj-ml=\"photouploader.instagram.logout\"\n                        ></a>\n                </div>\n\n                <div\n                    class=\"\n                        b-photouploader-albums\n                        \"\n                    ng-class=\"{ \'b-photouploader-albums-loading\': instagram.loading }\"\n                    >\n                    <div\n                        class=\"b-photouploader-albums-inner\"\n                        lj-when-scrolled=\"instagram.loadMore()\"\n                        >\n                        <ul\n                            class=\"\n                                b-photouploader-pictures\n                                b-photouploader-pictures-withtitle\n                                b-photouploader-pictures-withmove\n                                \"\n                            ng-model=\"instagram.media\"\n                            ui-sortable=\"ui.sortableOptions\"\n                            >\n                            <li\n                                class=\"b-photouploader-pictures-item\"\n                                ng-repeat=\"media in instagram.media\"\n                                ng-click=\"instagram.select(media);\"\n                                ng-class=\"{ \'selected\': media.selected }\"\n                                >\n                                <span class=\"b-photouploader-pictures-pic\"><!--\n                                    --><img\n                                        ng-src=\"{{ media.images.thumbnail.url }}\"\n                                        class=\"b-photouploader-pictures-img\"\n                                        ><!--\n                                --></span>\n                                <strong\n                                    class=\"b-photouploader-pictures-title\"\n                                    title=\"{{ media.caption.text }}\"\n                                    ng-show=\"media.caption\"\n                                    ><!--\n                                    -->{{ media.caption.text }}<!--\n                                --></strong>\n                            </li>\n                        </ul><!-- /pictures -->\n                    </div>\n                </div><!-- /albums -->\n\n            </div><!-- /panel -->\n\n            <!-- controls -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-controls\n                    \"\n                ng-show=\"instagram.token()\"\n                >\n                <div class=\"b-photouploader-instasettings\">\n                    <input\n                        type=\"checkbox\"\n                        id=\"webembeds\"\n                        class=\"b-photouploader-instasettings-check\"\n                        ng-model=\"instagram.asEmbed\"\n                        />\n                    <label\n                        for=\"webembeds\"\n                        class=\"b-photouploader-instasettings-label\"\n                        ><!--\n                        --><span\n                            lj-ml=\"photouploader.instagram.asEmbeds\"\n                            ></span>\n                        <span\n                            class=\"b-photouploader-instasettings-annex\"\n                            lj-ml=\"photouploader.instagram.asEmbeds.help\"\n                            ></span><!--\n                    --></label>\n                </div>\n                <div\n                    class=\"\n                        b-ljbutton\n                        b-ljbutton-submit\n                        \"\n                    >\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        lj-disabled=\"instagram.noneSelected()\"\n                        ng-click=\"instagram.insert()\"\n                        lj-ml=\"photouploader.instagram.insert\"\n                        ></button>\n                </div>\n                <!--\n                <button\n                    type=\"submit\"\n                    name=\"submit\"\n                    class=\"\n                        b-flatbutton\n                        b-flatbutton-simple\n                        \"\n                    lj-disabled=\"instagram.noneSelected()\"\n                    ng-click=\"instagram.insert()\"\n                    lj-ml=\"photouploader.instagram.insert\"\n                    ></button> -->\n\n                <lj-flatbutton lj-flatbutton=\"[\'submit\', \'photouploader.instagram.insert\', \'b-flatbutton b-flatbutton-simple\', \'lj-disabled\', \'instagram.noneSelected()\', \'ng-click\', \'instagram.insert()\', \'name\', \'submit\']\">\n            </lj-flatbutton>\n            </div><!-- /panel -->\n\n        </div><!-- /instagram item -->\n\n\n\n    </div><!-- /items -->\n\n\n\n</div>\n';

//= require_ml photouploader.paste.correctUrl
//= require_ml photouploader.paste.pasteURL
//= require_ml photouploader.paste.notice
//= require_ml photouploader.paste.link
//= require_ml photouploader.paste.size
//= require_ml photouploader.paste.insert
//= require_ml photouploader.paste.insert
//= require_ml photouploader.paste.title
//= require_ml photouploader.dropbox.title
//= require_ml photouploader.dropbox.choose
//= require_ml photouploader.instagram.title
//= require_ml photouploader.instagram.intro
//= require_ml photouploader.instagram.loginButton
//= require_ml photouploader.instagram.select
//= require_ml photouploader.instagram.select.help
//= require_ml photouploader.instagram.logout
//= require_ml photouploader.instagram.asEmbeds
//= require_ml photouploader.instagram.asEmbeds.help
//= require_ml photouploader.instagram.needTitle
//= require_ml photouploader.instagram.needTitle.help
//= require_ml photouploader.instagram.nophoto
//= require_ml photouploader.instagram.insert
//= require_ml photouploader.instagram.insert
//= require_ml photouploader.album.your
//= require_ml photouploader.album.size
//= require_ml photouploader.album.addlink

/*
 * LiveJournal photouploader
 *
 * Being a successor to jquery.lj.photouploader.js,
 * it has all old features and some new:
 * - HTML5 upload mode (iOS7 compatible),
 * - canceling the upload for the separate files,
 * - Instagram support.
 *
 * @author Artem Tyurin (artem.tyurin@sup.com)
 */

/*
 * @TODO: think of a general way to postpone loading of
 * resources, like album or Instagram, before it is actually
 * needed. Right now only album loading is postponed.
 */

/*globals plupload*/

(function ($) {

  'use strict';

  angular.module('LJ.Photouploader', ['ui.sortable', 'LJ.AuthHelper', 'LJ.Messages', 'LJ.Pills', 'angular-plupload']).factory('Photouploader', ['$timeout', '$log', function ($timeout, $log) {
    var factory = {};

    if (!LJ.get('fotki')) {
      $log.warn('Missing `fotki` data on page from server');
    }

    factory.albums = angular.copy(LJ.get('fotki.uploader.albumsData') || []);

    factory.sizesData = LJ.get('fotki.uploader.sizesData') || [];

    factory.space = LJ.get('fotki.uploader.availableSpace');

    factory.albums.forEach(function (album) {
      album.photos = [];
    });

    factory.album = factory.albums[0];

    factory.hasUploadAbilities = Boolean(LJ.get('remote.username') && !LJ.get('remote.is_identity'));

    factory.keys = {
      dropbox: '7ye0n6mhwlsdh9u',
      instagram: '2f36cf1bb0b74b4dbc3bf155321370b4'
    };

    factory.getUnsortedAlbum = function () {
      return factory.albums[0];
    };

    factory.fetchAlbum = function (options, callback) {
      var COUNT = 20;

      if (!factory.hasUploadAbilities || !options.album.album_id) {
        return;
      }

      if (options.album.allFetched) {
        return;
      }

      $.ajax({
        url: (LJ.get('photo_prefix') || '') + '/__rpc_fotki_imgs?func=get_photos',
        dataType: 'json',
        data: {
          album_id: options.album.album_id,
          start: options.start || 0,
          required_size: 100,
          count: COUNT
        }
      }).then(function (result) {
        // sometimes server returns photo without that field
        // If so - photo can not be viewed
        var filtered = result.filter(LJ.Function.get('photo_url'));

        if (filtered.length < COUNT) {
          options.album.allFetched = true;
        }

        $timeout(function () {
          callback(filtered);
        });
      });
    };

    /*
     * Used for updating and removing photos
     *
     * @param {Array} photos
     * @param {Object} data           Data to send
     * @param {String} [data.action]  Action: 'add_new_post' or 'upload'
     * @param {String} [data.privacy] Photos privacy to set. (one of privacy data .security fields)
     */
    factory.updatePhotos = function (photos, data, callback) {
      var params = {
        photos_data: photos
      };

      // @TODO: think of a better way to handle input object
      if (data.required_size) {
        params.required_size = data.required_size;
      }
      if (data.privacy) {
        params.privacy = data.privacy;
      }
      if (data.action) {
        params.action = data.action;
      }
      if (data.type) {
        params.type = data.type;
      }

      if (data.album) {
        if (typeof data.album === 'string') {
          params.album_title = data.album;
        } else {
          params.album_id = data.album.album_id;
        }
      }

      $.ajax({
        type: 'POST',
        url: (LJ.get('photo_prefix') || '') + '/__rpc_fotki_imgs?func=update_photos',

        data: {
          data_to_update: angular.toJson(params)
        },

        dataType: 'json'
      }).then(function (result) {
        var resizesData = result.resizes_data;

        if (data.required_size && resizesData) {

          var hash = photos.reduce(function (hash, photo) {
            return hash[photo.photo_id] = photo, hash;
          }, {});

          for (var photo_id in resizesData) {
            hash[photo_id]['size_' + data.required_size] = resizesData[photo_id].image_url;
          }
        }

        $timeout(function () {
          callback(photos);
        });
      });
    };

    factory.removePhoto = function (photo) {
      var photos = factory.getUnsortedAlbum().photos,
          index = photos.indexOf(photo);

      if (index !== -1) {
        photos.splice(index, 1);
      }

      photo.is_deleted = 1;

      // send 'is_deleted' to server and that's it
      factory.updatePhotos([photo], {}, function () {
        // whatever
      });
    };

    /**
     * Get album by id
     * @param  {Number|String} id   Album id. String is possible only
     *                              for custom albums, like 'selected'
     * @return {Object|Undefined}   Album object, if found undefined otherwise
     */
    factory.getAlbumById = function (id) {
      return factory.albums.find(function (album) {
        return album.album_id === id;
      });
    };

    /**
     * Add new album to the albums list.
     * Notice: this method does not sync with server
     *
     * @param  {Object}        params               Creation params
     * @param  {Number|String} params.album_id      Album id. String is possible only
     *                                              for custom albums, like 'selected'
     * @param {String}         params.album_title   Album title
     * @param {Array}          [params.photos]      Photos objects to store in album
     *
     * @param {Object}         [options]            Album append/prepend options
     * @param {Boolean}        [options.prepend]    If provided, album will be inserted to the begining of albums list.
     *                                              By default, album is inserted to the end
     *
     * @return {Object}        Created album object
     */
    factory.addAlbum = function (params, options) {
      if (!params.album_id) {
        throw new Error('album_id should be provided.');
      }

      if (!params.album_title) {
        throw new Error('album_title should be provided.');
      }

      album = angular.extend({ photos: [] }, params);

      if (options && options.prepend) {
        factory.albums.unshift(album);
      } else {
        factory.albums.push(album);
      }

      return album;
    };

    /**
     * Add photos to the album
     * @param {Number|String} albumId           Album id
     * @param {Array}         photos            Photos to add
     * @param {Object}        [options]         Additional options
     * @param {Object}        [options.prepend] If set, photos will be added to the begining of album
     */
    factory.addPhotos = function (albumId, photos, options) {
      var album = factory.getAlbumById(albumId);

      if (!album) {
        throw new Error('Album with id %s not found', albumId);
      }

      if (options && options.prepend) {
        Array.prototype.unshift.apply(album.photos, photos);
      } else {
        Array.prototype.push.apply(album.photos, photos);
      }

      return album;
    };

    // try to get the last selected album
    (function () {
      var id = LJ.Storage.getItem('photouploader_album_id'),
          album;

      if (id) {
        album = factory.getAlbumById(id);

        if (album) {
          factory.album = album;
        }
      }
    })();

    /*
     * Handle urls like:
     *   ?albums_id=15394
     *   ?photos_id=480215,479570
     */
    if (LJ.get('fotki.insert')) {
      var album_id = Number(LiveJournal.parseGetArgs().albums_id);

      if (album_id) {
        factory.album = factory.getAlbumById(album_id);
        factory.album.allFetched = true;
        factory.addPhotos(album_id, LJ.get('fotki.insert'));
      } else {

        // create selected album
        var album = factory.addAlbum({
          album_id: 'selected',
          album_title: LJ.ml('photouploader.album.scrapbookSelected'),
          photos: LJ.get('fotki.insert')
        });
        factory.album = album;
      }

      // select current album
      factory.album.photos.forEach(LJ.Function.set('selected', true));
    }

    return factory;
  }]).controller('PhotouploaderCtrl', ['$scope', '$q', '$timeout', 'Pills', 'Editor', 'Photouploader', 'Messages', 'AuthHelper', function ($scope, $q, $timeout, Pills, Editor, Photouploader, Messages, AuthHelper) {

    var uploaded = [];

    $scope.pluploadOptions = {
      drop_element: 'upload-panel',
      browse_button: 'pickfiles',
      multi_selection: true,
      filters: {
        max_file_size: '10mb',
        mime_types: [{ title: 'Image files', extensions: 'jpg,jpeg,gif,png' }]
      },
      multipart: true,
      multipart_params: {
        form_auth: LJ.get('fotki.uploader.guid')
      },
      file_data_name: 'file'
    };

    if (LJ.Flags.isEnabled('photo_v4')) {
      return;
    }

    $scope.hasUploadAbilities = Photouploader.hasUploadAbilities;
    // uploader init fails in browsers neither support html5 fileapi
    // nor flash player istalled
    $scope.hasAlbums = function () {
      return Photouploader.albums.length !== 0;
    };

    $scope.$on('bubble:open:photouploader', function () {
      $scope.albums.current = Photouploader.album;

      if (LJ.get('fotki.insert')) {
        Pills.group('photouploader', 'album');
      } else {
        Pills.group('photouploader', $scope.hasUploadAbilities ? LJ.Storage.getItem('photouploader2_state') || 'upload' : 'paste');

        // if user has removed last album - show "upload" section
        if (Pills.group('photouploader') === 'album' && !$scope.hasAlbums()) {
          Pills.group('photouploader', 'upload');
        }
      }
    });

    $scope.$on('bubble:close:photouploader', function () {
      // This is needed for focus-and-select directive
      // to work on "paste" tab, when we close it and open again.
      Pills.group('photouploader', null);
    });

    $scope.ui = {
      // size is used on both 'upload' and 'albums' tabs
      size: {
        list: Photouploader.sizesData,

        current: Photouploader.sizesData.find(LJ.Function.get('is_default')) || Photouploader.sizesData[0]
      },

      insertInProgress: false,

      sortableOptions: {
        // prevent Firefox from firing clicks when dragging
        helper: 'clone'
      }
    };

    var privacyData = LJ.get('fotki.uploader.privacyData') || [];
    $scope.upload = {
      files: [],
      url: (LJ.get('photo_prefix') || '') + '/up',

      privacy: {
        current: privacyData[0],
        list: privacyData
      },

      space: Photouploader.space,

      album: Photouploader.getUnsortedAlbum(),

      inProgress: false,

      insert: function insert() {
        if ($scope.ui.insertInProgress) {
          return;
        }
        $scope.ui.insertInProgress = true;

        var size = $scope.ui.size.current.size,
            uploaded = $scope.upload.photos();

        Photouploader.updatePhotos(uploaded, {
          privacy: $scope.upload.privacy.current.security,
          required_size: size,

          album: $scope.upload.newAlbumName || $scope.upload.album,

          action: 'add_new_post',
          type: 'upload'
        }, function () {
          LJ.Event.trigger('uploadInsert', size, uploaded);
        });
      },

      cancel: function cancel(file) {
        var index = $scope.upload.files.indexOf(file);

        if (index !== -1) {
          $scope.upload.files.splice(index, 1);
        }

        //Plupload.uploader.removeFile(file.id);
      },

      /*
       * Current uploaded photos
       */
      photos: function photos() {
        /*
         * Uploaded photos are always first fall into
         * unsorted album. Right now, when moving the photo,
         * the effect appears only after the reload.
         */

        if (!$scope.hasAlbums()) {
          return [];
        }

        return Photouploader.getUnsortedAlbum().photos.filter(LJ.Function.get('uploaded'));
      },

      removePhoto: function removePhoto(photo) {
        Photouploader.removePhoto(photo);
      },

      state: function state() {
        if ($scope.upload.photos().length > 0) {
          return 'uploaded';
        } else {
          return 'start';
        }
      }
    };

    $scope.pills = {
      isActive: function isActive(type) {
        return Pills.group('photouploader') === type;
      },

      select: function select(type) {
        Pills.group('photouploader', type);

        LJ.Storage.setItem('photouploader2_state', type);
      }
    };

    $scope.paste = {
      url: '',
      link: '',

      insertUrl: function insertUrl() {
        var content,
            imageWidth = Number($scope.ui.size.current.size) || '',
            image = '<img src="' + $scope.paste.url + '" width="' + imageWidth + '" />';

        if ($scope.paste.link) {
          content = '<a href="' + LJ.String.linkify($scope.paste.link) + '">' + image + '</a>';
        } else {
          content = image;
        }

        Editor.insertContent('photouploader', content, [content]);

        $scope.paste.url = '';
        $scope.paste.link = '';

        $scope.bubble.close();

        LJ.Track.event('Photouploader', 'Paste', 'Insert');
      }
    };

    $scope.albums = {
      // placeholder album for init
      current: {
        photos: []
      },

      list: Photouploader.albums,

      originalLink: false,

      noneSelected: function noneSelected() {
        if (!$scope.hasAlbums()) {
          return true;
        }

        return $scope.albums.current.photos.filter(LJ.Function.get('selected')).length === 0;
      },

      togglePhoto: function togglePhoto(photo) {
        photo.selected = !photo.selected;
      },

      insert: function insert() {
        if ($scope.ui.insertInProgress) {
          return;
        }
        $scope.ui.insertInProgress = true;

        var size = $scope.ui.size.current.size,
            selected = $scope.albums.current.photos.filter(LJ.Function.get('selected'));

        if (size !== 'custom') {
          Photouploader.updatePhotos(selected, {
            required_size: size
          }, function () {
            LJ.Event.trigger('albumInsert', size, selected);
          });
        } else {
          LJ.Event.trigger('albumInsert', size, selected);
        }
      },

      loadMore: function loadMore() {
        Photouploader.fetchAlbum({
          album: $scope.albums.current,
          start: $scope.albums.current.photos.length
        }, function (result) {
          // add photos to current album
          Photouploader.addPhotos($scope.albums.current.album_id, result);
        });
      }
    };

    $scope.$watch('albums.current', function (album) {
      if (!album || !album.album_id) {
        return;
      }

      Photouploader.album = album;

      Photouploader.fetchAlbum({ album: album }, function (result) {
        Photouploader.addPhotos(album.album_id, result);
      });

      LJ.Storage.setItem('photouploader_album_id', album.album_id);
    });

    $scope.instagram = {
      media: [],

      _token: null,
      /*
       * Getter/setter
       *
       * @param {String|Object} String or null to remove
       */
      token: function token(_token) {
        var user = LJ.get('remote.username'),
            key = 'instagram_token',
            cookieSettings = {
          domain: LJ.get('siteroot').replace(/^https?:\/\/www/, '')
        };

        if (user) {
          key = 'instagram_token_' + user;
        }

        if (typeof _token !== 'undefined') {
          $scope.instagram._token = _token;
          LJ.Cookie.set(key, _token, cookieSettings);
        } else {
          return $scope.instagram._token || LJ.Cookie.get(key);
        }
      },

      noneSelected: function noneSelected() {
        return this.media.filter(LJ.Function.get('selected')).length === 0;
      },

      select: function select(media) {
        media.selected = !media.selected;
      },

      insert: function insert() {
        var selectedImages = $scope.instagram.media.filter(LJ.Function.get('selected')),
            toInsert,
            promises;

        if ($scope.instagram.asEmbed) {
          promises = selectedImages.map(function (media) {
            return LJ.Media.parse(media.link).then(LJ.Function.get('embed'));
          });

          $q.all(promises).then(function (values) {
            Editor.insertContent('video', values.join('\n'), values);
          });
        } else {
          toInsert = selectedImages.map(function (media) {
            return '<img src="{url}" title="{caption}">'.supplant({
              url: media.images.standard_resolution.url,
              caption: LJ.String.encodeHTML(media.caption && media.caption.text || '')
            });
          });

          Editor.insertContent('photouploader', toInsert.join('\n'), toInsert);

          LJ.Track.event('Photouploader', 'Instagram', 'Insert');
        }

        $scope.instagram.media.forEach(LJ.Function.set('selected', false));

        $scope.bubble.close();
      },

      login: function login() {
        // Direct LiveJournal url is used, because it is hardcoded
        // in Instagram app manager (http://instagram.com/developer/).

        AuthHelper.open(['https://instagram.com/oauth/authorize/?client_id=', Photouploader.keys.instagram, '&amp;redirect_uri=', 'https://www.livejournal.com', '/auth_helper.html&amp;response_type=token'].join('')).then(function (token) {
          if (token) {
            LJ.Event.trigger('instagram_token', token);
          }
        });
      },

      logout: function logout() {
        // logout from Instagram, not sure if this is needed
        new Image().src = 'https://instagram.com/accounts/logout/';

        $scope.instagram.token(null);

        $scope.instagram.allFetched = false;
        $scope.instagram.media.length = 0;
      },

      /*
       * Method is used for initial loading and pagination
       */
      loadMore: function loadMore() {
        var instagram = $scope.instagram;

        if (!instagram.token() || instagram.loading || instagram.allFetched) {
          return;
        }

        instagram.loading = true;

        var url = ['https://api.instagram.com', '/v1/users/self/media/recent/?callback=?&access_token=', instagram.token()];

        if (instagram.media.length > 0) {
          var id = instagram.media[instagram.media.length - 1].id;
          url.push('&max_id=' + id);
        }

        $.getJSON(url.join('')).then(function (response) {
          $timeout(function () {
            if (response.data && response.data.length === 0) {
              instagram.allFetched = true;
            }

            Array.prototype.push.apply(instagram.media, response.data);
            instagram.loading = false;
          });
        });
      }
    };

    $scope.$watch(function () {
      return $scope.instagram.token();
    }, $scope.instagram.loadMore);

    LJ.Event.on('instagram_token', function (token) {
      $timeout(function () {
        $scope.instagram.token(token);
      });
    });

    $scope.dropbox = {
      init: function init() {
        // https://www.dropbox.com/developers/dropins/chooser/js

        if (window.Dropbox) {
          return;
        }

        LJ.injectScript('https://www.dropbox.com/static/api/2/dropins.js').done(function () {
          if (window.Dropbox) {
            window.Dropbox.appKey = Photouploader.keys.dropbox;
          }
          LJ.Event.trigger('dropbox_loaded', {
            linkType: 'preview',

            multiselect: true,

            extensions: ['images'],

            success: function success(files) {
              $timeout(function () {
                var images = files.map(function (file) {
                  return '<img src="{url}" alt="" title="">'.supplant({
                    url: file.link.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                  });
                });

                Editor.insertContent('photouploader', images.join('\n'), images);

                $scope.bubble.close();

                LJ.Track.event('Photouploader', 'Dropbox', 'Success');
              });
            }
          });
        });
      }
    };

    $scope.dropbox.init();

    $scope.uploaderInit = true;
    $scope.pluploadCallbacks = {
      filesAdded: function filesAdded(uploader, files) {
        $scope.upload.inProgress = true;
        $timeout(function () {
          $scope.upload.files.length = 0;
          Array.prototype.push.apply($scope.upload.files, angular.copy(files));
          uploader.start();
        });
      },
      fileUploaded: function fileUploaded(uploader, file, response) {
        response = JSON.parse(response.response);

        if (response.status === 'error') {
          $scope.upload.files.shift();
          $scope.pluploadCallbacks.uploadError(uploader, response);
          return;
        }

        // cut file extension if exist
        response.photo_name = file.name.lastIndexOf('.') !== -1 ? file.name.substr(0, file.name.lastIndexOf('.')) : file.name;

        uploaded.push(response);
      },
      uploadComplete: function uploadComplete() {
        if (!uploaded.length) {
          return;
        }

        $timeout(function () {
          var albumId = uploaded[0].album_id,
              album;

          $scope.upload.inProgress = false;
          uploaded.forEach(LJ.Function.set('uploaded', true));

          // by default photos are stored into "Unsorted" album
          // if it does not exist - create it dynamically
          if (!Photouploader.getAlbumById(albumId)) {
            album = Photouploader.addAlbum({
              album_id: albumId,
              album_title: LJ.ml('fotki.album.default_album_name'),

              // set flag to prevent fetching it again
              allFetched: true
            }, { prepend: true });

            $scope.albums.current = $scope.upload.album = album;
          }

          Photouploader.addPhotos(albumId, uploaded, { prepend: true });
          $scope.upload.files.length = 0;
          uploaded.length = 0;
        });
      },
      uploadProgress: function uploadProgress(uploader, progressedFile) {
        $timeout(function () {
          var file = $scope.upload.files.find(function (file) {
            return file.id === progressedFile.id;
          });

          if (file && isFinite(progressedFile.percent)) {
            file.percent = progressedFile.percent;
          }
        });
      },
      uploadError: function uploadError(uploader, err) {
        $scope.upload.inProgress = false;
        if (err.code === plupload.INIT_ERROR) {
          $scope.uploaderInit = false;
        } else {
          $timeout(function () {
            Messages.error({ body: err.message });
          });
        }
      }
    };

    LJ.Event.on('uploadInsert', function (size, uploaded) {
      $timeout(function () {
        var toInsert = uploaded.map(function (photo) {
          var img = '<img src="{url}" alt="{name}" title="{name}">'.supplant({
            url: photo['size_' + size],
            name: photo.photo_name || ''
          });

          if ($scope.albums.originalLink) {
            return '<a target="_blank" href="' + photo.photo_orig + '">' + img + '</a>';
          }

          return img;
        });

        Editor.insertContent('photouploader', toInsert.join('\n'), toInsert);
        $scope.ui.insertInProgress = false;

        uploaded.forEach(LJ.Function.set('uploaded', false));

        $scope.bubble.close();
      });
    });

    LJ.Event.on('albumInsert', function (size, selected) {
      var toInsert = selected.map(function (photo) {

        var img = '<img src="{url}" alt="{name}" title="{name}">'.supplant({
          url: photo['size_' + size],
          name: photo.photo_title || ''
        });

        if ($scope.albums.originalLink) {
          return '<a target="_blank" href="' + photo.photo_orig + '">' + img + '</a>';
        }

        return img;
      });

      Editor.insertContent('photouploader', toInsert.join('\n'), toInsert);
      $scope.ui.insertInProgress = false;

      $scope.albums.current.photos.forEach(LJ.Function.set('selected', false));

      $scope.bubble.close();

      LJ.Track.event('Photouploader', 'Albums', 'Insert');
    });
  }]).directive('ljWhenScrolled', function () {
    /*
     * Run an action when element is scrolled to the bottom
     *
     * @example
     *   <div lj-when-scrolled="albums.loadMore()"></div>
     */
    return function (scope, elem, attr) {
      var raw = elem[0];

      elem.bind('scroll', function () {
        if (raw.scrollTop + raw.offsetHeight >= raw.scrollHeight) {
          scope.$apply(attr.ljWhenScrolled);
        }
      });
    };
  });
})(jQuery);
/* <<< file end: js/editor/photouploader.js */

//# map link was there [photouploader.js.map]
/* >>> file start: js/core/array.js */
(function (a) {
  return a;
})();

(function () {
  'use strict';

  LJ.define('LJ.Array');

  /*
   * Intersections of 2 arrays, that contains
   * all elements of A that also belong to B
   */
  LJ.Array.intersection = function intersection(a, b) {
    var t;
    if (b.length > a.length) {
      t = b;
      b = a;
      a = t;
    }

    return a.filter(function (e) {
      return b.indexOf(e) !== -1;
    });
  };
})();
/* <<< file end: js/core/array.js */

//# map link was there [array.js.map]
/* >>> file start: js/angularHttps.js */
var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

//= require js/core/angular/api.js

(function () {
  ljHttpsService.$inject = ['Api', '$q'];
  angular.module('LJ.Https', ['LJ.Api']);

  angular.module('LJ.Https').factory('ljHttpsService', ljHttpsService);

  function ljHttpsService(Api, $q) {

    // Cache mechanism for Api calls
    var cachedProxies = {};
    function requestProxiedUrl(url) {
      return new Promise(function (resolve, reject) {
        var cacheRecord = cachedProxies[url];
        if (cacheRecord) {
          return resolve(cacheRecord.proxied);
        }

        Api.call('imageproxy.get_proxy_url', {
          url: url
        }).then(function (response) {
          cacheRecord = {
            proxied: response.url
          };
          cachedProxies[url] = cacheRecord;
          resolve(cacheRecord.proxied);
        }).catch(reject);
      });
    }

    var serviceAPI = {
      getSecureUrlVariation: function getSecureUrlVariation(url, httpsSupporters) {
        if (!/^http/.test(url)) {
          return null;
        }
        if (/^https:\/\//.test(url)) {
          return url;
        }
        if (angular.isArray(httpsSupporters) && httpsSupporters.length) {
          var _ret = function () {
            var urlFromSupporter = void 0,
                slashSplit = url.split('/');

            httpsSupporters.some(function (supporterDomain) {
              if (slashSplit[2] && (slashSplit[2] === supporterDomain || slashSplit[2].indexOf(supporterDomain) > -1)) {
                urlFromSupporter = url.replace(/^http/, 'https');
                return true;
              }
              return false;
            });
            if (urlFromSupporter) {
              return {
                v: urlFromSupporter
              };
            }
          }();

          if ((typeof _ret === 'undefined' ? 'undefined' : _typeof(_ret)) === "object") return _ret.v;
        }
        return null;
      },
      isSecureSrc: function isSecureSrc(src) {
        return angular.isString(serviceAPI.getSecureUrlVariation(src));
      },
      // Convert http:// url to https:// using various image-applicable methods
      getSecureImageUrl: function getSecureImageUrl(url, httpsSupporters) {
        if (!/^http/.test(url)) {
          return Promise.reject({
            url: url,
            reason: new Error('Url does not start with "http"')
          });
        }
        var secureUrlVariation = serviceAPI.getSecureUrlVariation(url, httpsSupporters);
        if (secureUrlVariation) {
          return Promise.resolve({
            secureUrl: secureUrlVariation
          });
        }
        // We use cache all the time
        return requestProxiedUrl(url).then(function (proxied) {
          return {
            secureUrl: proxied
          };
        });
      },
      // Normally clients of the service won't need to call this one
      getMetaFromHtmlString: function getMetaFromHtmlString(htmlString) {
        var rawDomTree = new DOMParser().parseFromString(htmlString, 'text/html'),
            imgArray = Array.prototype.slice.call(rawDomTree.getElementsByTagName('img'));


        // Map images to their `src`s
        return imgArray.map(function (img) {
          return img.getAttribute('src');
        }
        // Filter out duplicates
        ).filter(function (value, index, self) {
          return self.indexOf(value) === index;
        }
        // Provide as objects
        ).map(function (src) {
          return { src: src };
        });
      },
      isSecureHtmlString: function isSecureHtmlString(htmlString) {
        var srcMeta = serviceAPI.getMetaFromHtmlString(htmlString);

        return srcMeta.every(function (srcMetaItem) {
          return serviceAPI.isSecureSrc(srcMetaItem.src);
        });
      },
      // Sets secure `src` for the image, preserving original one
      secureImgSrcInString: function secureImgSrcInString(inputString, imgSrc, secureSrc) {
        if (!secureSrc || !imgSrc) {
          return inputString;
        }

        var createReg = function createReg(str) {
          return new RegExp('src=[\'"]' + str + '[\'"]', 'g');
        },
            resultSrc = 'src=\'' + secureSrc + '\' originalsrc=\'' + imgSrc + '\'',
            src = imgSrc.replace(/\?/ig, '\\?'),
            encodedSrc = src.encodeHTML(),
            regEx = createReg(src),
            encodedRegEx = createReg(encodedSrc);
        // No dash in attribute name
        // because CKEditor handles attribute names with dashes incorrectly

        if (regEx.test(inputString)) {
          return inputString.replace(regEx, resultSrc);
        }
        if (encodedRegEx.test(inputString)) {
          return inputString.replace(encodedRegEx, resultSrc);
        }
        return inputString;
      },
      // Secures all images in string via `secureImgSrcInString`
      secureHtmlString: function secureHtmlString(inputString, httpsSupporters) {
        var srcMeta = serviceAPI.getMetaFromHtmlString(inputString),
            secureSrcPromises = srcMeta.map(function (srcMetaItem) {
          return $q(function (resolve) {
            var src = srcMetaItem.src;

            serviceAPI.getSecureImageUrl(src, httpsSupporters).then(function (_ref) {
              var secureUrl = _ref.secureUrl;

              srcMetaItem.secureUrl = secureUrl;
              resolve();
            }).catch(function () {
              // Skip on errors
              resolve();
            });
          });
        });

        // Promises to get https:// version of each `src`

        return $q.all(secureSrcPromises).then(function () {
          // Modifying input text
          return srcMeta.reduce(function (currentText, srcItem) {
            return serviceAPI.secureImgSrcInString(currentText, srcItem.src, srcItem.secureUrl);
          }, inputString);
        });
      },
      // Removes all `originalSrc` attributes, restores `src`s from them
      desecureHtmlString: function desecureHtmlString(inputString) {
        var curentString = inputString,
            imageMatches = curentString.match(new RegExp('<\s*img[^>]+>', 'g'));

        if (!imageMatches || !imageMatches.length) {
          return curentString;
        }
        imageMatches.forEach(function (imageTagString) {
          /* eslint-disable quotes */
          var originalSrcMatch = imageTagString.match(new RegExp('originalsrc=[\'"]([^\'"]+)[\'"]'));
          if (!originalSrcMatch || !originalSrcMatch.length) {
            return;
          }
          var originalSrc = originalSrcMatch[1],
              modifiedImageTagString = imageTagString.replace(new RegExp('originalsrc=[\'"][^\'"]+[\'"] '), '').replace(new RegExp('src=[\'"][^\'"]+[\'"]'), 'src=\'' + originalSrc + '\'');

          curentString = curentString.replace(imageTagString, modifiedImageTagString);
          /* eslint-enable quotes */
        });
        return curentString;
      }
    };
    return serviceAPI;
  }
})();
/* <<< file end: js/angularHttps.js */

//# map link was there [angularHttps.js.map]
/* >>> file start: js/photo/photo.js */
var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

//= require_ml flatmedia.adult.content.default
//= require_ml flatmedia.adult.content.none
//= require_ml flatmedia.adult.content.explicit

//= require_ml flatmedia.select.album.none

/**
 * Service that is responsible for photo data
 */
(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Photo.Service', []).factory('Photo', ['$q', 'Api', function ($q, Api) {
    var defaults = {
      NON_SELECTED_ALBUM: {
        id: -1,
        name: LJ.ml('flatmedia.select.album.none')
      },

      // adult setting
      RECORD_ADULT: false,
      RECORD_PRIVACY: 'public',
      ALBUM_PRIVACY: 'public',
      ALBUM_NAME: ''
    },
        factory = {
      createRecord: createRecord,

      fetchAlbums: fetchAlbums,
      getAlbums: getAlbums,
      fetchAlbum: fetchAlbum,
      getAlbumById: getAlbumById,

      fetchRecords: fetchRecords,
      fetchRecordById: fetchRecordById,
      getRecordById: getRecordById,
      getRecordByIndex: getRecordByIndex,
      getRecordsByAlbumId: getRecordsByAlbumId,

      createAlbum: createAlbum,
      updateAlbum: updateAlbum,
      removeAlbum: removeAlbum,

      updateRecord: updateRecord,
      updateRecords: updateRecords,
      removeRecords: removeRecords,

      defaults: defaults
    },
        user = LJ.get('journal.username') || LJ.get('remote.username'),
        _albumsById = {},
        _recordById = {},
        fetchAlbumQueue = [];

    function createRecord(obj) {
      return Api.call('photo.create_record', obj).then(function (response) {
        _cacheRecords(response.record);
        return response.record;
      });
    }

    function fetchAlbums(params) {
      return Api.call('photo.get_albums', _extends({ user: user }, params), { cache: true }).then(function (response) {
        response.albums.forEach(_cacheAlbum);
      });
    }

    function fetchAlbum(id) {
      var fetchQueuePosition = fetchAlbumQueue.indexOf(id);

      if (fetchQueuePosition !== -1) {
        // if album is currently fetching return promise
        return $q.when(null);
      }

      fetchAlbumQueue.push(id);

      return Api.call('photo.get_album', { id: id, user: user }, { cache: true }).then(function (response) {
        fetchAlbumQueue.splice(fetchQueuePosition, 1);
        _cacheAlbum(response.album);
      });
    }

    function fetchRecords(albumId, params, cache) {
      if (typeof cache === 'undefined') {
        cache = true;
      }

      if (params.offset < 0) {
        return $q.when(null);
      }

      return Api.call('photo.get_records', _extends({ albumid: albumId, user: user }, params), { cache: cache }).then(function (response) {
        var records = response.records;

        _cacheRecords(records);
        return records;
      });
    }

    function fetchRecordById(params) {
      return Api.call('photo.get_record', _extends({ user: user }, params), { cache: true }).then(function (response) {
        return response.record;
      });
    }

    /**
     * Update album request
     * @param  {Object} album Album object
     * @return {Promise}      Promise that will be resolved with data
     */
    function updateAlbum(album) {
      // @todo check params
      return Api.call('photo.update_album', album).then(function (response) {
        _cacheAlbum(response.album);

        Api.invalidate('photo.get_albums', { user: user });
        Api.invalidate('photo.get_album', { id: album.id, user: user });

        return response.album;
      });
    }

    /**
     * Create album: https://conf.sup.com/display/LJCOMAPI/photo.create_album
     *
     * @param  {Object}   [params]           Album params
     * @param  {String}   [params.name]      Album name
     * @param  {String}   [params.privacy]   Album privacy: public | private | friends | custom
     * @param  {Number[]} [params.groupids]  Custom privacy groupids
     *
     * @return {Promise}       Promise that will be resolved with created album object
     */
    function createAlbum(params) {
      // @todo replace security with default security value for photo album
      var requestParams = angular.extend({}, { security: 'public', user: user }, params);

      // @todo check params
      return Api.call('photo.create_album', requestParams).then(function (response) {
        var result = response.album;

        _cacheAlbum(result);

        Api.invalidate('photo.get_albums', { user: user });
        return result;
      });
    }

    function removeAlbum(id) {
      return Api.call('photo.delete_album', { id: id }).then(function (response) {
        _removeAlbumFromCache(id);

        Api.invalidate('photo.get_albums', { user: user });
        Api.invalidate('photo.get_album', { user: user, id: id });
        return response;
      });
    }

    function _cacheAlbum(album) {
      _albumsById[album.id] = album;
    }

    function _removeAlbumFromCache(id) {
      delete _albumsById[id];
      getRecordsByAlbumId(id).forEach(function (record) {
        _removeRecordFromCache(record.id);
      });
    }

    function _removeRecordFromCache(id) {
      var record = getRecordById(id);

      Api.invalidate('photo.get_albums', { user: user });
      Api.invalidate('photo.get_album', { user: user, id: record.albumid });
      Api.invalidate('photo.get_records', { albumid: record.albumid, user: user, offset: Math.floor(record.index / 20), limit: 20 });

      delete _recordById[id];
    }

    function getAlbums() {
      var albums = [];

      // @todo add order by timestamp
      angular.forEach(_albumsById, function (album) {
        albums.push(album);
      });

      albums.sort(function (a, b) {
        return b.id - a.id;
      });

      return albums;
    }

    function getAlbumById(id) {
      return _albumsById[id];
    }

    function getRecordById(id) {
      return _recordById[id];
    }

    function getRecordsByAlbumId(id, options) {
      var result = [],
          start,
          end;


      angular.forEach(_recordById, function (record) {
        if (record.albumid === id) {
          result.push(record);
        }
      });

      result = result.sort(function (a, b) {
        return b.id - a.id;
      });

      if (options) {
        start = options.offset;
        end = options.offset + options.limit;

        result = result.filter(function (item) {
          return item.index >= start && item.index < end;
        });
      }

      return result;
    }

    function getRecordByIndex(albumId, index) {
      var deferred = $q.defer(),
          result,
          arr;


      if (index < 0) {
        deferred.resolve();
        return deferred.promise;
      }

      arr = Object.keys(_recordById).filter(function (id) {
        return _recordById[id].albumid === albumId;
      });

      result = arr.find(function (id) {
        var record = _recordById[id];

        return record.index === index;
      });

      if (result) {
        deferred.resolve(_recordById[result]);
        return deferred.promise;
      }

      return fetchRecords(albumId, { offset: index, limit: 1 }).then(function (data) {
        return data[0];
      });
    }

    function updateRecords(data) {
      return Api.call('photo.update_records', data).then(function (response) {
        var records = response.records;

        records.forEach(_invalidateRecord);
        return records;
      });
    }

    function updateRecord(data) {
      return Api.call('photo.update_record', data).then(function (response) {
        var record = response.record;

        _invalidateRecord(record);
        return record;
      });
    }

    function _invalidateRecord(record) {
      var cache = getRecordById(record.id);

      Api.invalidate('photo.get_records', {
        albumid: record.albumid,
        user: user,
        offset: Math.floor(record.index / 20),
        limit: 20
      });
      Api.invalidate('photo.get_album', { user: user, id: record.albumid });
      Api.invalidate('photo.get_albums', { user: user });

      if (cache) {
        Api.invalidate('photo.get_records', {
          albumid: cache.albumid,
          user: user,
          offset: Math.floor(cache.index / 20),
          limit: 20
        });
        Api.invalidate('photo.get_album', { user: user, id: cache.albumid });
      }

      fetchAlbum(record.albumid);
      _cacheRecords(record);
    }

    function removeRecords(ids, params) {
      return Api.call('photo.delete_records', { ids: ids }).then(function () {
        if (!params || !params.notCached) {
          ids.forEach(function (id) {
            _removeRecordFromCache(id);
          });
        }
      });
    }

    /**
     * Cache record(s)
     * @param  {Object|Array} records Record or records to cache
     */
    function _cacheRecords(records) {
      if (!Array.isArray(records)) {
        records = [records];
      }

      records.forEach(function (record) {
        _recordById[record.id] = record;
      });
    }

    return factory;
  }]).factory('PhotoSize', function () {
    var sizes = LJ.get('fotki.uploader.sizesData') || [{ is_default: 1, text: "Оригинал", size: "original" }];

    function _getDefaultSize() {
      var cookieSize = LJ.Cookie.get('photo_size'),
          filter = cookieSize ? LJ.Function.get('size', cookieSize.toString()) : LJ.Function.get('is_default');

      return sizes && (filter && sizes.filter(filter)[0] || sizes[0]);
    }

    function _intersect(sizesCollection) {
      var intersectedCollection = sizes.map(LJ.Function.get('size'));
      for (var i = 0, collectionLength = sizesCollection.length; i < collectionLength; i++) {
        intersectedCollection = LJ.Array.intersection(sizesCollection[i], intersectedCollection);
      }

      return sizes.filter(function (item) {
        return intersectedCollection.indexOf(item.size) !== -1;
      });
    }

    return {
      // size is used on both 'upload' and 'albums' tabs
      list: sizes,
      current: _getDefaultSize(),
      insertInProgress: false,
      sortableOptions: {
        // prevent Firefox from firing clicks when dragging
        helper: 'clone'
      },
      intersect: _intersect,
      getDefaultSize: _getDefaultSize
    };
  }).filter('decodeRecord', [function () {
    return function (record) {
      function decode(code) {
        return code === '&lt;' ? '<' : '>';
      }
      record.name = (record.name || '').replace(/(&(gt|lt);)/g, decode);
      record.description = (record.description || '').replace(/(&(gt|lt);)/g, decode);
      return record;
    };
  }]);
})();
/* <<< file end: js/photo/photo.js */

//# map link was there [photo.js.map]
/* >>> file start: js/photo/selectAlbum.js */

//= require js/photo/photo.js

Site.page.template['angular/photo/selectPhotoAlbum.ng.tmpl'] = '<div class=\"b-ljform-field\"\n  ng-class=\"{\n    \'flatpopup-create-state\': directive.state.create\n  }\"\n  >\n\n  <div class=\"flatmedia-edit-field\">\n    <label class=\"flatpopup-label\" lj-ml=\"flatmedia.select.album\"></label>\n    <select\n      class=\"sharp-select\"\n      ng-model=\"directive.selectedAlbumId\"\n      ng-options=\"album.id as album.name for album in directive.albums\"\n      ></select>\n    <span lj-ml=\"flatmedia.or\"></span>\n    <a\n      class=\"flatmedia-action-link\"\n      href=\"javascript:void(0);\"\n      ng-click=\"directive.toggle(true)\"\n      lj-ml=\"flatmedia.album.create.new\"\n      ></a>\n  </div>\n\n  <div class=\"flatmedia-create-field\">\n    <label class=\"flatpopup-label\" lj-ml=\"flatmedia.album.name\"></label>\n    <a\n      class=\"flatpopup-action-link flatpopup-aside-link\"\n      href=\"javascript:void(0);\"\n      ng-click=\"directive.toggle(false)\"\n      lj-ml=\"flatmedia.button.back\"\n      ng-if=\"directive.albums.length\"\n      ></a>\n    <input\n      type=\"text\"\n      class=\"b-input b-input-max\"\n      maxlength=\"150\"\n      ng-model=\"directive.newAlbum.name\"\n      />\n  </div>\n</div>\n';

//= require_ml flatmedia.album.create.new
//= require_ml flatmedia.album.name
//= require_ml flatmedia.button.back
//= require_ml flatmedia.or
//= require_ml flatmedia.select.album

/**
 * Album selection directive. It is responseble for displaying an albums list
 * It is possible to select an album or create new album (without Api request)
 *
 * Options:
 *   allow-non-selected[="value"] - Allow non-selected album (is needed for mass-edit)
 *                                  If value provided - it will be watched and when it
 *                                  is `true` non-selected album will be shown
 *
 * @example
 *
 *   <div select-photo-album="model.albumObj" />
 *
 *   <div
 *     select-photo-album="model.albumObj"
 *     allow-non-selected="options.allowNonSelected"
 *     />
 *
 * Where,
 *   albumObj - album object or object with {name: 'New album name'}
 *
 * if after all albumObj has an <id> property - it's selection,
 * otherwice - creation of the new album
 */

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Photo.SelectAlbum', ['LJ.Templates', 'Photo.Service']).directive('selectPhotoAlbum', ['Photo', function (Photo) {
    return {
      templateUrl: 'selectPhotoAlbum.ng.tmpl',
      controllerAs: 'directive',
      scope: {
        album: '=selectPhotoAlbum',
        allowNonSelected: '=?allowNonSelected',
        scope: '=selectPhotoAlbumScope'
      },
      controller: ['$scope', '$attrs', 'Photo', function ($scope, $attrs, Photo) {
        var that = this,
            state = this.state = {
          init: false,

          // create album (or select)
          create: false
        };

        // initial model of new album
        this.newAlbum = {
          name: ''
        };

        /**
         * Check if is needed to add non selected album
         */
        function isNonSelectedAllowed() {
          var attr = $attrs.allowNonSelected;

          // option is provided without value to watch
          if (typeof attr === 'string' && attr.length === 0) {
            return true;
          }

          return $scope.allowNonSelected;
        }

        // get albums for
        function getAlbums(albums) {
          var result = [];

          if (isNonSelectedAllowed()) {
            result.push(Photo.defaults.NON_SELECTED_ALBUM);
          }

          return result.concat(albums ? albums : Photo.getAlbums());
        }

        this.init = function () {
          state.init = true;

          that.albums = angular.copy(Photo.getAlbums());

          // select album
          if ($scope.album.id) {
            this.selectedAlbumId = $scope.album.id;
          } else if (that.albums.length !== 0) {
            this.selectedAlbumId = that.albums[0].id;
          }

          // change album value when selectedAlbumId/newAlbum or state is changed
          $scope.$watch(function () {
            return that.selectedAlbumId + that.newAlbum.name + state.create;
          }, function () {
            $scope.album = state.create ? that.newAlbum : Photo.getAlbumById(that.selectedAlbumId);
          });

          $scope.$watchCollection(Photo.getAlbums, function (albums) {
            that.albums = getAlbums(albums);

            // switch to create state if there is no albums
            if (albums.length === 0) {
              state.create = true;
            }
          });

          if (typeof $attrs.allowNonSelected !== 'undefined') {
            $scope.$watch('allowNonSelected', function () {
              that.albums = getAlbums();
            });
          }
        };

        /**
         * Toggle state create/select
         * @param  {Boolean} _state State: true - create; false - select
         */
        this.toggle = function (_state) {
          state.create = _state;
          this.newAlbum.name = '';
        };
      }],
      link: function link($scope, $element, $attrs, ctrl) {
        var params = {};
        if (typeof $scope.album === 'undefined') {
          throw new TypeError('You should provide album object');
        }

        if ($scope.scope !== 'photo') {
          params = { user: LJ.get('remote.username') };
        }

        Photo.fetchAlbums(params).then(function () {
          ctrl.init();
        });
      }
    };
  }]);
})();
/* <<< file end: js/photo/selectAlbum.js */

//# map link was there [selectAlbum.js.map]
/* >>> file start: js/photo/uploader.js */


//= require js/core/angular/api.js
//= require js/core/angular/plupload.js
//!= require js/core/angular/messages.js
//= require js/photo/photo.js
//= require js/editor/editor.js
//= require js/photo/selectAlbum.js

Site.page.template['angular/photo/uploaderPhoto.ng.tmpl'] = '<div\n    class=\"flatpopup__body-inner\"\n    ng-if=\"directive.state.init\"\n    ng-class=\'{\n       \"flatpopup-uploading\": directive.state.uploadInProgress,\n       \"flatpopup-uploading-complete\": directive.state.uploadDone\n    }\'>\n    <div\n        class=\"b-ljform-field upload__box\"\n        id=\"upload-panel-photo\"\n        plupload=\"directive.uploadUrl\"\n        plupload-options=\"directive.uploadOptions\"\n        plupload-callbacks=\"directive.uploadCallbacks\"\n        plupload-disable-on-upload=\"directive.scope === \'photo\'\"\n        >\n        <label\n            class=\"upload__box-label\"\n            for=\"pickfiles-photo\"\n            lj-ml=\"{\n                  \'photouploader.upload.dragOrClick\':   directive.modulo() === -1,\n                  \'photouploader.upload.filesAdded1\':   directive.modulo() === 1,\n                  \'photouploader.upload.filesAdded2-4\': directive.modulo() >=  2 && directive.modulo() <= 4,\n                  \'photouploader.upload.filesAdded5\':   directive.modulo() === 0 || directive.modulo() >= 5\n                }\"\n            lj-ml-resolve=\"{ number: directive.files.length }\"\n            lj-ml-dynamic=\"directive.uploaded.length || directive.files.length\"\n            ></label>\n        <input\n            type=\"file\"\n            class=\"upload__input\"\n            name=\"media\"\n            id=\"pickfiles-photo\"\n            ng-value=\"directive.model.name\"\n            ng-placeholder=\"directive.inProgress\"\n            lj-disabled=\"directive.state.uploadInProgress\"\n            >\n    </div>\n\n    <ul\n        class=\"upload__items\"\n        ng-if=\"directive.state.preview\"\n        >\n        <li\n            class=\"upload__item\"\n            ng-repeat=\"photo in directive.uploaded\"\n            >\n            <span class=\"upload__item_pic\"><!--\n                --><img\n                    class=\"b-photouploader-pictures-img\"\n                    ng-src=\"{{ photo.thumbnail_url }}\"\n                    ><!--\n            --></span>\n            <span\n                class=\"upload__item_remove\"\n                lj-svg-icon=\"flaticon--cross\"\n                lj-ml=\"photouploader.upload.remove\"\n                lj-ml-attr=\"title\"\n                ng-click=\"directive.remove(photo, $index)\"\n                ></span>\n        </li>\n    </ul>\n\n    <div class=\"upload-bar\">\n        <span\n            class=\"upload-bar__inner\"\n            ng-style=\"{ width: directive.progress + \'%\' }\"\n            ></span>\n    </div>\n\n    <div class=\"flatpopup__msg\">\n        <span\n            class=\"\n                b-bubble\n                b-bubble-warning\n                b-bubble-noarrow\n                flatpopup__msg-warning\n                flatpopup__msg-text\n                \"\n            ></span>\n    </div>\n\n    <div class=\"b-ljform-field\">\n        <div select-photo-album=\"directive.model.album\" select-photo-album-scope=\"directive.scope\"></div>\n    </div>\n\n    <div class=\"b-ljform-field flatmedia-privacy__field\">\n        <label class=\"flatpopup-label\" lj-ml=\"flatmedia.security\"></label>\n        <span\n            lj-privacy=\"directive.model\"\n            lj-privacy-scope=\"photo\"></span>\n    </div>\n\n    <div\n        class=\"b-ljform-field\"\n        ng-if=\"directive.state.selectSize && directive.sizes.list\"\n        >\n        <label\n            for=\"albums\"\n            class=\"b-photouploader-nav-label flatpopup-label\"\n            lj-ml=\"photouploader.album.size\"\n            ></label>\n        <select\n            id=\"albums\"\n            class=\"sharp-select\"\n            ng-model=\"directive.sizes.current\"\n            ng-options=\"size as size.text for size in directive.sizes.list\"\n            ></select>\n    </div>\n\n    <div\n        class=\"b-photouploader-albumselector-item\"\n        ng-if=\"directive.state.selectSize && directive.sizes.list\"\n        >\n        <input\n            type=\"checkbox\"\n            id=\"linktoneworiginal\"\n            class=\"b-photouploader-albumselector-check\"\n            ng-model=\"directive.originalLink\"\n            >\n        <label\n            for=\"linktoneworiginal\"\n            class=\"b-photouploader-albumselector-label\"\n            lj-ml=\"photouploader.upload.addlink\"\n            ></label>\n    </div>\n\n    <div class=\"b-ljform-field b-photouploader-action-panel\">\n        <a\n            class=\"flatpopup-action-link\"\n            href=\"javascript:void(0)\"\n            ng-click=\"directive.cancel()\"\n            lj-ml=\"flatmedia.button.cancel\"\n            ></a>\n        <button\n            class=\"\n                b-flatbutton\n                b-flatbutton-simple\n                \"\n            lj-ml=\"{\n                    \'flatmedia.upload.photo\': directive.scope === \'photo\',\n                    \'photouploader.upload.insert\': directive.scope !== \'photo\'\n                }\"\n            lj-disabled=\"!directive.isSaveAllowed()\"\n            ng-click=\"directive.save()\"\n            ></button>\n    </div>\n\n</div>\n\n<div class=\"b-photouploader-initfail\" ng-if=\"!directive.state.init\">\n    <span class=\"b-photouploader-initfail-flash\" lj-ml=\"photouploader.upload.initFail\"></span>\n</div>\n';

//= require_ml flatmedia.button.cancel
//= require_ml flatmedia.name
//= require_ml flatmedia.upload.photo
//= require_ml photouploader.upload.initFail
//= require_ml photouploader.upload.dragOrClick
//= require_ml photouploader.upload.filesAdded1
//= require_ml photouploader.upload.filesAdded2-4
//= require_ml photouploader.upload.filesAdded5
//= require_ml photouploader.upload.insert

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Photo.Uploader', ['LJ.Templates', 'LJ.Messages', 'LJ.Api', 'angular-plupload', 'Photo.SelectAlbum', 'Photo.Service', 'Editor'])
  /**
   * @example
   *
   *  <!-- select default album -->
   *  <div lj-photo-uploader />
   *
   *  <!-- select exact album -->
   *  <div lj-photo-uploader="albumId" />
   *
   *  <!-- photo upload callback -->
   *  <div
   *    lj-photo-uploader="albumId"
   *    [lj-photo-uploader-callback="photoLoaded(record)"]
   *    [lj-photo-uploader-cancel="cancelled()"]
   *    [lj-photo-uploader-preview]
   *    [lj-photo-uploader-size]
   *    [lj-photo-uploader-scope="photo"]
   *    [lj-photo-uploader-error="onError()"]
   *    />
   */
  .directive('ljPhotoUploader', ['$timeout', function ($timeout) {
    return {
      templateUrl: 'uploaderPhoto.ng.tmpl',
      scope: {
        albumId: '=ljPhotoUploader',
        scope: '@ljPhotoUploaderScope',
        callback: '&ljPhotoUploaderCallback',
        onError: '&ljPhotoUploaderError',
        cancelUpload: '&ljPhotoUploaderCancel'
      },
      controllerAs: 'directive',
      controller: ['$scope', '$q', '$rootScope', '$element', '$attrs', 'Photo', 'Editor', 'Bubble', 'Messages', 'PhotoSize', function ($scope, $q, $rootScope, $element, $attrs, Photo, Editor, Bubble, Messages, PhotoSize) {

        var that = this,
            filenames = [];


        _stateChange();

        that.init = init;
        that.files = [];
        that.uploaded = [];
        that.save = save;
        that.cancel = cancel;
        that.remove = remove;
        that.isSaveAllowed = isAllowed;
        that.modulo = modulo;
        that.scope = $scope.scope;
        that.sizes = PhotoSize;
        that.uploadUrl = (LJ.get('photo_prefix') || '') + '/up';

        that.uploadOptions = {
          drop_element: 'upload-panel-photo',
          browse_button: 'pickfiles-photo',
          multi_selection: true,
          filters: {
            max_file_size: '10mb',
            mime_types: [{ title: 'Image files', extensions: 'jpg,jpeg,gif,png' }]
          },
          multipart: true,
          multipart_params: {
            form_auth: LJ.get('fotki.uploader.guid') || LJ.get('page.guid')
          },
          file_data_name: 'file'
        };

        that.uploadCallbacks = {
          init: function init(uploader) {
            that.uploader = uploader;
            uploader.refresh();
          },

          filesAdded: function filesAdded(uploader, files) {
            _stateChange('init');
            that.files.lenght = 0;
            Array.prototype.push.apply(that.files, angular.copy(files));
            Array.prototype.push.apply(filenames, files.map(LJ.Function.get('name')));
            $timeout(that.scope !== 'photo' ? _uploadFiles : _waitUpload);
          },

          fileUploaded: function fileUploaded(uploader, file, response) {
            response = JSON.parse(response.response);
            that.files.shift();
            $scope.$apply();

            if (response.status === 'error') {
              _error(uploader, response);
              return;
            }

            if (!that.state.error) {
              that.uploaded.push(response);
            }
          },

          uploadProgress: function uploadProgress(uploader, file) {
            var step = 100 / (that.files.length + that.uploaded.length);

            that.progress = !isFinite(step) ? 0 : Math.floor(step * (that.uploaded.length + file.percent / 100));
          },

          uploadComplete: function uploadComplete() {
            that.progress = 0;
            _stateChange('uploaded');
          },

          error: function error(uploader, err) {
            _error(uploader, err);
          }
        };

        function init() {
          that.model = getDefaultModel();
          _stateChange('ready');
        }

        function save() {
          LJ.Event.trigger('photo:upload:save');

          _beforeSave().then(_updateRecords).then(updateSuccess);

          function updateSuccess(responses) {
            if (typeof $scope.callback === 'function') {
              $scope.callback({ photo: responses });
            }

            if (that.scope === 'photo') {
              LJ.Event.trigger('upload:photo:back');
            }

            _insertPhotos();
            _stateChange('init');
          }
        }

        // cancel upload
        function cancel() {
          if (typeof $scope.cancelUpload === 'function') {
            $scope.cancelUpload();
          }

          _stateChange('cancel');
          that.uploaded.map(remove);
          filenames.length = 0;
          Bubble.close();
        }

        function remove(record) {
          Photo.removeRecords([record.id], { notCached: true }).then(function () {
            that.uploaded.splice(that.uploaded.indexOf(record), 1);
          });
        }

        function getDefaultModel() {
          return {
            // will be redefined; should not be empty
            // If action attribute is empty - angular prevents default behavior
            name: Photo.defaults.ALBUM_NAME,
            privacy: Photo.defaults.RECORD_PRIVACY,
            album: Photo.getAlbumById($scope.albumId) || {}
          };
        }

        function isAllowed() {
          // check file presence
          return filenames.length &&

          // check all files has names
          filenames.every(function (filename) {
            return filename.trim().length !== 0;
          }) && (

          // check album
          that.model.album.id || that.model.album.name.trim().length !== 0) && !that.state.inProgress;
        }

        function modulo() {
          var filesQueueLength = that.files.length;
          if (filesQueueLength === 0) {
            return -1;
          }

          if (filesQueueLength < 10 || filesQueueLength > 20) {
            return filesQueueLength % 10;
          }

          return 0;
        }

        function _uploadFiles() {
          if (that.state.inProgress) {
            LJ.Event.once('photo:upload:done', _uploadFiles);
            return;
          }

          _stateChange('uploading');
          that.uploader.start();
        }

        function _waitUpload() {
          if (!that.state.isWaiting) {
            that.state.isWaiting = true;
            LJ.Event.once('photo:upload:save', _uploadFiles);
          }
        }

        function _updateRecords() {
          var promises = that.uploaded.map(function (file, index) {
            return Photo.updateRecord({
              id: file.id,
              albumid: that.model.album.id,
              privacy: that.model.privacy,
              groupids: that.model.groupids,
              name: filenames[index]
            });
          });

          return $q.all(promises);
        }

        // get url, create album
        function _beforeSave() {
          // if no files uploaded wait for uploaded event
          if (that.scope === 'photo' && !that.uploaded.length) {
            LJ.Event.once('photo:upload:done', save);
            return $q.reject();
          }

          if (that.scope === 'editor') {
            _stateChange('progress');
          }

          var params = angular.copy(that.model),
              albumCreateDefer = $q.defer(),
              albumCreatePromise = albumCreateDefer.promise;


          // create album if needed (id not provided)
          if (typeof params.album.id === 'undefined') {
            albumCreatePromise = Photo.createAlbum({ name: params.album.name });
          } else {
            albumCreateDefer.resolve(params.album);
          }

          delete params.album;

          return albumCreatePromise.then(function (album) {
            that.model.album.id = album.id;
          });
        }

        function _error(uploader, error) {
          _stateChange('error');

          if (error.code && error.code === window.plupload.INIT_ERROR) {
            that.state.init = false;
            return;
          }

          that.files.pop();
          Messages.error({ body: error.message });
          if (typeof $scope.onError === 'function') {
            $scope.onError();
          }
          uploader.splice(that.uploaded.length);
        }

        function _stateChange(state) {
          var initState = {
            inProgress: false,
            uploadInProgress: false,
            uploadDone: false,
            error: false,
            preview: $attrs.hasOwnProperty('ljPhotoUploaderPreview'),
            selectSize: $attrs.hasOwnProperty('ljPhotoUploaderSize')
          };

          if (!that.state || state === 'init') {
            that.state = angular.extend({}, that.state, initState);
          }

          switch (state) {
            default:
            case 'init':
              break;

            case 'progress':
              that.state.inProgress = true;
              break;

            case 'cancel':
              LJ.Event.trigger('photo:upload:cancel');
              break;

            case 'uploading':
              LJ.Event.trigger('photo:upload:start');
              that.state.inProgress = true;
              that.state.uploadInProgress = true;
              break;

            case 'uploaded':
              if (that.uploaded.length) {
                LJ.Event.trigger('photo:upload:done');
                that.state.uploadDone = true;
                that.state.inProgress = false;
                that.state.uploadInProgress = false;
              }
              break;

            case 'ready':
              that.state.init = true;
              $scope.$apply();
              break;

            case 'error':
              that.state.error = true;
              that.state.inProgress = false;
              that.state.uploadInProgress = false;
              break;
          }
        }

        function _insertPrepare() {
          var size = that.state.selectSize && that.sizes.current.size,
              insertTpl = '<img src="{url}" alt="{name}" title="{name}">',
              originalLinkTpl = '<a target="_blank" href="{originalLink}">{img}</a>';

          return that.uploaded.map(function (photo) {
            var imageTpl = insertTpl.supplant({
              url: size ? photo.url.replace('original', size) : photo.url,
              name: photo.photo_name || photo.name
            });

            return !that.originalLink ? imageTpl : originalLinkTpl.supplant({
              originalLink: photo.url,
              img: imageTpl
            });
          });
        }

        function _insertPhotos() {
          var toInsert = _insertPrepare();
          Editor.insertContent('photouploader', toInsert.join('\n'), toInsert);
          that.uploaded.length = 0;
          Bubble.close();
        }
      }],
      link: function link($scope, $element, $attrs, ctrl) {

        // Wait for linking $scope.albumId
        $timeout(ctrl.init);
      }
    };
  }]);
})();
/* <<< file end: js/photo/uploader.js */

//# map link was there [uploader.js.map]
/* >>> file start: js/photo/editor.js */
//= require js/editor/editor.js
//= require js/editor/photouploader.js
//= require js/editor/media.js
//= require js/core/string.js
//= require js/core/array.js

//= require js/core/angular/api.js
//= require js/core/angular/pills.js
//= require js/core/angular/authHelper.js
//= require js/angularHttps.js

//= require js/photo/uploader.js
//= require js/photo/photo.js

// error: photouploader.css is already included
// error: menu_v2.css is already included

Site.page.template['angular/photo.ng.tmpl'] = '<div\n    class=\"b-photouploader\"\n    ng-controller=\"PhotoEditorCtrl as photo\"\n    >\n\n\n\n    <!-- menu -->\n    <ul\n        class=\"\n            b-menu\n            b-menu-hrz\n            b-menu-pills\n            b-menu-pseudo\n            b-photouploader-menu\n            \"\n        lj-pills-group=\"uploadPhoto\"\n        ><!--\n        --><li\n            class=\"b-menu-item b-menu-item-active\"\n            data-pill=\"upload\"\n            ng-if=\"photo.state.canUpload\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"photo.pill(\'upload\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.upload.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"album\"\n            ng-if=\"photo.state.canUpload && photo.albums.list\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"photo.pill(\'album\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.album.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"paste\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"photo.pill(\'paste\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.paste.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"dropbox\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"photo.pill(\'dropbox\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.dropbox.title\"\n                ></a>\n        </li><!--\n        --><li\n            class=\"b-menu-item\"\n            data-pill=\"instagram\"\n            >\n            <a\n                href=\"javascript:void(0);\"\n                ng-click=\"photo.pill(\'instagram\')\"\n                class=\"b-menu-item-link\"\n                lj-ml=\"photouploader.instagram.title\"\n                ></a>\n        </li><!--\n    --></ul>\n\n\n    <!-- items -->\n    <div class=\"b-photouploader-items\">\n        <!-- upload from computer -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-upload\n                \"\n            ng-class=\"\'b-photouploader-item-upload-\' + upload.state()\"\n            ng-if=\"photo.state.canUpload && photo.isPill(\'upload\')\"\n            >\n                <div lj-photo-uploader\n                     lj-photo-uploader-callback=\"photo.loaded(photo)\"\n                     lj-photo-uploader-cancel=\"photoUploadCancelled()\"\n                     lj-photo-uploader-scope=\"editor\"\n                     lj-photo-uploader-preview\n                     lj-photo-uploader-size\n                     ></div>\n            </div>\n\n\n        <!-- select from albums -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-albums\n                \"\n            ng-show=\"photo.isPill(\'album\')\"\n            ng-if=\"photo.state.canUpload\"\n            >\n\n            <!-- albums -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-albums\n                    \"\n                >\n\n                <h4\n                    class=\"b-photouploader-subhead\"\n                    lj-ml=\"photouploader.album.select\"\n                    ></h4>\n\n                <div class=\"\n                        b-photouploader-albums\n                        b-photouploader-albums-withnav\n                        \">\n                    <div\n                        class=\"b-photouploader-albums-inner\"\n                        lj-when-scrolled=\"photo.albums.loadMore()\"\n                        >\n                        <!-- albums nav -->\n                        <div\n                            class=\"b-photouploader-nav\"\n                            >\n                            <label\n                                for=\"albums\"\n                                class=\"b-photouploader-nav-label\"\n                                lj-ml=\"photouploader.album.your\"\n                                ></label>\n                            <select\n                                class=\"sharp-select\"\n                                id=\"albums\"\n                                ng-model=\"photo.albums.current\"\n                                ng-options=\"item as item.name for item in photo.albums.list\"\n                                >\n                            </select>\n                        </div>\n\n                        <!-- pictures -->\n                        <ul\n                            class=\"\n                                b-photouploader-pictures\n                                b-photouploader-pictures-withtitle\n                                b-photouploader-pictures-withmove\n                                \"\n                            ng-model=\"photo.albums.current.photos\"\n                            >\n                            <li\n                                class=\"b-photouploader-pictures-item\"\n                                ng-repeat=\"item in photo.albums.current.photos\"\n                                ng-click=\"photo.albums.togglePhoto(item)\"\n                                ng-class=\"{ \'selected\': item.selected }\"\n                                >\n                                <span class=\"b-photouploader-pictures-pic\"><!--\n                                    --><img\n                                    class=\"b-photouploader-pictures-img\"\n                                    ng-src=\"{{ item.thumbnail_url || item.url }}\"\n                                    ><!--\n                                --></span>\n                                <strong\n                                    class=\"b-photouploader-pictures-title\"\n                                    ng-bind=\"item.name\"\n                                    ng-show=\"item.name\"\n                                    ><!--\n                                --></strong>\n                            </li>\n                        </ul>\n\n                    </div>\n                </div><!-- /albums -->\n\n            </div>\n\n            <!-- controls -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-controls\n                    \"\n                >\n                <div class=\"b-photouploader-albumsettings\">\n                    <label\n                        for=\"sizepictures\"\n                        class=\"b-photouploader-albumsettings-label\"\n                        lj-ml=\"photouploader.album.size\"\n                        ></label>\n                    <select\n                        id=\"sizepictures\"\n                        class=\"b-photouploader-albumsettings-select\"\n                        ng-model=\"photo.ui.current\"\n                        ng-options=\"item as item.text for item in photo.ui.list\"\n                        >\n                    </select>\n                    <div class=\"b-photouploader-albumsettings-separator\"></div>\n                    <div class=\"b-photouploader-albumsettings-wrap\">\n                        <input\n                            type=\"checkbox\"\n                            id=\"linktooriginal\"\n                            class=\"b-photouploader-albumsettings-check\"\n                            ng-model=\"photo.albums.originalLink\"\n                            />\n                        <label\n                            for=\"linktooriginal\"\n                            class=\"b-photouploader-albumsettings-label\"\n                            lj-ml=\"photouploader.album.addlink\"\n                            ></label>\n                    </div>\n                </div>\n                <div\n                    class=\"\n                        b-ljbutton\n                        b-ljbutton-submit\n                        \"\n                    >\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        lj-disabled=\"photo.albums.noneSelected() || photo.ui.insertInProgress\"\n                        ng-click=\"photo.albums.insert()\"\n                        lj-ml=\"photouploader.album.insert\"\n                        ></button>\n                </div>\n                <button\n                    type=\"submit\"\n                    name=\"submit\"\n                    class=\"\n                        b-flatbutton\n                        b-flatbutton-simple\n                        \"\n                    lj-disabled=\"photo.albums.noneSelected() || photo.ui.insertInProgress\"\n                    ng-click=\"photo.albums.insert()\"\n                    lj-ml=\"photouploader.album.insert\"\n                    ></button>\n            </div>\n\n        </div><!-- /albums item -->\n\n\n        <!-- by url -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-url\n                \"\n            ng-show=\"photo.isPill(\'paste\')\"\n            >\n\n            <form ng-submit=\"photo.paste.insertUrl()\">\n\n                <!-- url form -->\n                <div\n                    class=\"\n                        b-photouploader-panel\n                        b-photouploader-panel-url\n                        \"\n                    >\n\n                    <dl class=\"b-photouploader-byurl\">\n\n                        <dt class=\"b-photouploader-byurl-picture\">\n                            <img\n                                ng-src=\"{{ photo.paste.secureUrl }}\"\n                                ng-show=\"photo.paste.secureUrl\"\n                                class=\"b-photouploader-byurl-image\"\n                                >\n                            <span\n                                ng-show=\"!photo.paste.secureUrl\"\n                                class=\"b-photouploader-byurl-sub\"\n                                lj-ml=\"photouploader.paste.correctUrl\"\n                                ></span>\n                        </dt>\n\n                        <dd class=\"b-photouploader-byurl-form\">\n                            <label\n                                for=\"url\"\n                                class=\"b-photouploader-byurl-label\"\n                                lj-ml=\"photouploader.paste.pasteURL\"\n                                ></label>\n                            <br class=\"b-photouploader-byurl-br\">\n                            <input\n                                type=\"text\"\n                                id=\"url\"\n                                size=\"55\"\n                                class=\"b-photouploader-byurl-src\"\n                                placeholder=\"https://\"\n                                ng-model=\"photo.paste.url\"\n                                focus-and-select=\"photo.isPill(\'paste\')\"\n                                >\n                            <br class=\"b-photouploader-byurl-br\">\n                            <em\n                                class=\"b-photouploader-byurl-note\"\n                                lj-ml=\"photouploader.paste.notice\"\n                                ></em>\n                        </dd>\n\n                        <dd class=\"b-photouploader-byurl-form\">\n                            <label\n                                for=\"imagelink\"\n                                class=\"b-photouploader-byurl-label\"\n                                lj-ml=\"photouploader.paste.link\"\n                                ></label>\n                            <br class=\"b-photouploader-byurl-br\">\n                            <input\n                                type=\"text\"\n                                id=\"imagelink\"\n                                size=\"35\"\n                                class=\"b-photouploader-byurl-link\"\n                                placeholder=\"https://\"\n                                ng-model=\"photo.paste.link\"\n                                >\n                        </dd>\n\n                    </dl>\n\n                </div><!-- /panel -->\n\n                <!-- controls -->\n                <div\n                    class=\"\n                        b-photouploader-panel\n                        b-photouploader-panel-controls\n                        \"\n                    >\n                    <div class=\"b-photouploader-urlsettings\">\n                        <label\n                            for=\"picturesize\"\n                            class=\"b-photouploader-urlsettings-label\"\n                            lj-ml=\"photouploader.paste.size\"\n                            ></label>\n                        <select\n                            id=\"picturesize\"\n                            class=\"b-photouploader-urlsettings-select sharp-select\"\n                            ng-model=\"photo.ui.current\"\n                            ng-options=\"item as item.text for item in photo.ui.list\"\n                            >\n                        </select>\n                    </div>\n                    <div\n                        class=\"\n                            b-ljbutton\n                            b-ljbutton-submit\n                            \"\n                        >\n                        <button\n                            type=\"submit\"\n                            name=\"submit\"\n                            lj-disabled=\"!photo.paste.url\"\n                            lj-ml=\"photouploader.paste.insert\"\n                            ></button>\n                    </div>\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        class=\"\n                            b-flatbutton\n                            b-flatbutton-simple\n                            \"\n                        lj-disabled=\"!photo.paste.url\"\n                        lj-ml=\"photouploader.paste.insert\"\n                        ></button>\n                </div><!-- /panel -->\n\n            </form>\n\n        </div><!-- /url item -->\n\n\n\n        <!-- dropbox -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-dropbox\n                \"\n            ng-show=\"photo.isPill(\'dropbox\')\"\n            >\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-dropbox\n                    \"\n                >\n                <p\n                    class=\"b-photouploader-panel-dropbox-intro\"\n                    lj-ml=\"photouploader.dropbox.choose\"\n                    ></p>\n                <span lj-dropbox-button></span>\n            </div>\n        </div><!-- /dropbox item -->\n\n\n\n        <!-- message for empty album -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-noalbums\n                \"\n            ng-hide=\"!photo.isPill(\'instagram\') || !photo.instagram.token() || photo.instagram.media.length\"\n            lj-ml=\"photouploader.instagram.nophoto\"\n            ></div>\n\n\n\n        <!-- instagram -->\n        <div\n            class=\"\n                b-photouploader-item\n                b-photouploader-item-instagram\n                \"\n            ng-show=\"photo.isPill(\'instagram\')\"\n            >\n\n            <!-- login to instagram -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-instalogin\n                    \"\n                ng-show=\"!photo.instagram.token()\"\n                >\n                <p\n                    class=\"b-photouploader-panel-instalogin-intro\"\n                    lj-ml=\"photouploader.instagram.intro\"\n                    ></p>\n                <a\n                    href=\"javascript:void(0);\"\n                    class=\"b-photouploader-instagram-signup\"\n                    ng-click=\"photo.instagram.login()\"\n                    lj-ml=\"photouploader.instagram.loginButton\"\n                    ></a>\n            </div>\n\n            <!-- select pictures from instagram -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-pictures\n                    \"\n                ng-show=\"photo.instagram.token()\"\n                >\n\n                <div\n                    class=\"b-photouploader-instahead\"\n                    ng-class=\"{ \'b-photouploader-instahead--center\': !photo.instagram.media.length }\"\n                    >\n                    <h4\n                        class=\"b-photouploader-subhead\"\n                        ng-show=\"photo.instagram.media.length\"\n                        >\n                        <span\n                            lj-ml=\"photouploader.instagram.select\"\n                            ></span>\n                        <span\n                            class=\"b-photouploader-subhead-annex\"\n                            lj-ml=\"photouploader.instagram.select.help\"\n                            ></span>\n                    </h4>\n\n                    <a\n                        class=\"b-photouploader-logout\"\n                        href=\"javascript:void(0);\"\n                        ng-click=\"photo.instagram.logout()\"\n                        lj-ml=\"photouploader.instagram.logout\"\n                        ></a>\n                </div>\n\n                <div\n                    class=\"\n                        b-photouploader-albums\n                        \"\n                    ng-show=\"photo.instagram.media.length\"\n                    ng-class=\"{ \'b-photouploader-albums-loading\': photo.instagram.loading }\"\n                    >\n                    <div\n                        class=\"b-photouploader-albums-inner\"\n                        lj-when-scrolled=\"photo.instagram.loadMore()\"\n                        >\n                        <ul\n                            class=\"\n                                b-photouploader-pictures\n                                b-photouploader-pictures-withtitle\n                                b-photouploader-pictures-withmove\n                                \"\n                            ng-model=\"photo.instagram.media\"\n                            ui-sortable=\"photo.ui.sortableOptions\"\n                            >\n                            <li\n                                class=\"b-photouploader-pictures-item\"\n                                ng-repeat=\"media in photo.instagram.media\"\n                                ng-click=\"photo.instagram.select(media);\"\n                                ng-class=\"{ \'selected\': media.selected }\"\n                                >\n                                <span class=\"b-photouploader-pictures-pic\"><!--\n                                    --><img\n                                    ng-src=\"{{ media.images.thumbnail.url }}\"\n                                    class=\"b-photouploader-pictures-img\"\n                                    ><!--\n                                --></span>\n                                <strong\n                                    class=\"b-photouploader-pictures-title\"\n                                    title=\"{{ media.caption.text }}\"\n                                    ng-show=\"media.caption\"\n                                    ><!--\n                                    -->{{ media.caption.text }}<!--\n                                --></strong>\n                            </li>\n                        </ul><!-- /pictures -->\n                    </div>\n                </div><!-- /albums -->\n\n            </div><!-- /panel -->\n\n            <!-- controls -->\n            <div\n                class=\"\n                    b-photouploader-panel\n                    b-photouploader-panel-controls\n                    \"\n                ng-show=\"photo.instagram.token() && photo.instagram.media.length\"\n                >\n                <div class=\"b-photouploader-instasettings\">\n                    <input\n                        type=\"checkbox\"\n                        id=\"webembeds\"\n                        class=\"b-photouploader-instasettings-check\"\n                        ng-model=\"photo.instagram.asEmbed\"\n                        />\n                    <label\n                        for=\"webembeds\"\n                        class=\"b-photouploader-instasettings-label\"\n                        ><!--\n                        --><span\n                        lj-ml=\"photouploader.instagram.asEmbeds\"\n                        ></span>\n                        <span\n                            class=\"b-photouploader-instasettings-annex\"\n                            lj-ml=\"photouploader.instagram.asEmbeds.help\"\n                            ></span><!--\n                    --></label>\n                </div>\n                <div class=\"b-photouploader-instasettings\">\n                    <input\n                        lj-disabled=\"photo.instagram.asEmbed\"\n                        type=\"checkbox\"\n                        id=\"webneedtitle\"\n                        class=\"b-photouploader-instasettings-check\"\n                        ng-model=\"photo.instagram.needTitle\"\n                        />\n                    <label\n                        for=\"webneedtitle\"\n                        class=\"b-photouploader-instasettings-label\"\n                        ><!--\n                        --><span\n                            lj-ml=\"photouploader.instagram.needTitle\"\n                            ></span>\n                        <span\n                            class=\"b-photouploader-instasettings-annex\"\n                            lj-ml=\"photouploader.instagram.needTitle.help\"\n                            ></span><!--\n                    --></label>\n                </div>\n                <div\n                    class=\"\n                        b-ljbutton\n                        b-ljbutton-submit\n                        \"\n                    >\n                    <button\n                        type=\"submit\"\n                        name=\"submit\"\n                        lj-disabled=\"photo.instagram.noneSelected()\"\n                        ng-click=\"photo.instagram.insert()\"\n                        lj-ml=\"photouploader.instagram.insert\"\n                        ></button>\n                </div>\n                <button\n                    type=\"submit\"\n                    name=\"submit\"\n                    class=\"\n                        b-flatbutton\n                        b-flatbutton-simple\n                        \"\n                    lj-disabled=\"photo.instagram.noneSelected()\"\n                    ng-click=\"photo.instagram.insert()\"\n                    lj-ml=\"photouploader.instagram.insert\"\n                    ></button>\n            </div><!-- /panel -->\n\n        </div><!-- /instagram item -->\n\n\n    </div>\n</div>\n';

//= require_ml photouploader.embed.title
//= require_ml photouploader.upload.title
//= require_ml photouploader.upload.addlink
//= require_ml photouploader.byUrl.title
//= require_ml photouploader.album.title
//= require_ml photouploader.album.select
//= require_ml photouploader.album.insert
//= require_ml fotki.album.edit.empty.photo.title

//= require_ml tour.photo_update_tour.tip

//= require_ml talk.photo
//= require_ml talk.photo.paste
//= require_ml talk.photo.insert

(function (a) {
  return a;
})();

(function () {
  'use strict';

  angular.module('Photo.Editor', ['LJ.AuthHelper', 'LJ.Pills', 'LJ.Api', 'LJ.Bubble', 'Photo.Service', 'Photo.Uploader', 'LJ.Photouploader', 'Editor', 'LJ.Https']).factory('DropboxPhoto', ['$timeout', 'Editor', 'Bubble', 'Photouploader', function ($timeout, Editor, Bubble, Photouploader) {
    var factory = {};

    factory.init = function () {
      // https://www.dropbox.com/developers/dropins/chooser/js

      if (window.Dropbox) {
        return;
      }

      LJ.injectScript('https://www.dropbox.com/static/api/2/dropins.js').done(function () {
        if (window.Dropbox) {
          window.Dropbox.appKey = Photouploader.keys.dropbox;
        }
        LJ.Event.trigger('dropbox_loaded', {
          linkType: 'preview',

          multiselect: true,

          extensions: ['images'],

          success: function success(files) {
            $timeout(function () {
              var images = files.map(function (file) {
                return '<img src="{url}" alt="" title="">'.supplant({
                  url: file.link.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                });
              });

              Editor.insertContent('photouploader', images.join('\n'), images);

              Bubble.close();

              LJ.Track.event('Photouploader', 'Dropbox', 'Success');
            });
          }
        });
      });
    };

    return factory;
  }]).factory('InstagramPhoto', ['$timeout', '$q', 'Editor', 'Bubble', 'AuthHelper', 'Photouploader', function ($timeout, $q, Editor, Bubble, AuthHelper, Photouploader) {
    var factory = {
      media: []
    },
        _token = null;

    /*
     * Getter/setter
     *
     * @param {String|Object} String or null to remove
     */
    factory.token = function (token) {
      var user = LJ.get('remote.username'),
          key = 'instagram_token',
          cookieSettings = {
        domain: LJ.get('siteroot').replace(/^https?:\/\/www/, '')
      };

      if (user) {
        key = 'instagram_token_' + user;
      }

      if (typeof token !== 'undefined') {
        _token = token;
        LJ.Cookie.set(key, token, cookieSettings);
      } else {
        return _token || LJ.Cookie.get(key);
      }
    };

    factory.insert = function () {
      var selectedImages = factory.media.filter(LJ.Function.get('selected')),
          toInsert,
          promises;

      if (factory.asEmbed) {
        promises = selectedImages.map(function (media) {
          return LJ.Media.parse(media.link).then(LJ.Function.get('embed'));
        });

        $q.all(promises).then(function (values) {
          Editor.insertContent('video', values.join('\n'), values);
        });
      } else {
        toInsert = selectedImages.map(function (media) {
          var caption = LJ.String.encodeHTML(media.caption && media.caption.text || '');

          return '<div>{title}<img src="{url}" alt="{caption}" title="{caption}"></div>'.supplant({
            url: media.images.standard_resolution.url,
            caption: caption,
            title: factory.needTitle ? '<p>' + caption + '</p>' : ''
          });
        });

        Editor.insertContent('photouploader', toInsert.join('\n'), toInsert);

        LJ.Track.event('Photouploader', 'Instagram', 'Insert');
      }

      factory.media.forEach(LJ.Function.set('selected', false));

      Bubble.close();
    };

    factory.noneSelected = function () {
      return factory.media.filter(LJ.Function.get('selected')).length === 0;
    };

    factory.select = function (media) {
      media.selected = !media.selected;
    };

    factory.login = function () {
      // Direct LiveJournal url is used, because it is hardcoded
      // in Instagram app manager (http://instagram.com/developer/).

      AuthHelper.open(['https://instagram.com/oauth/authorize/?client_id=', Photouploader.keys.instagram, '&amp;redirect_uri=', 'https://www.livejournal.com', '/auth_helper.html&amp;response_type=token'].join('')).then(function (token) {
        if (token) {
          LJ.Event.trigger('instagram_token', token);
        }
      });
    };

    factory.logout = function () {
      // logout from Instagram, not sure if this is needed
      new Image().src = 'https://instagram.com/accounts/logout/';

      factory.token(null);

      factory.allFetched = false;
      factory.media.length = 0;
    };

    /*
     * Method is used for initial loading and pagination
     */
    factory.loadMore = function () {

      if (!factory.token() || factory.loading || factory.allFetched) {
        return;
      }

      factory.loading = true;

      var url = ['https://api.instagram.com', '/v1/users/self/media/recent/?callback=?&access_token=', factory.token()];

      if (factory.media.length > 0) {
        var id = factory.media[factory.media.length - 1].id;
        url.push('&max_id=' + id);
      }

      jQuery.getJSON(url.join('')).then(function (response) {
        $timeout(function () {
          if (response.data && response.data.length === 0) {
            factory.allFetched = true;
          }

          Array.prototype.push.apply(factory.media, response.data);
          factory.loading = false;
        });
      });
    };

    return factory;
  }]).factory('PastePhoto', ['$rootScope', '$timeout', '$q', 'Editor', 'Bubble', 'PhotoSize', 'ljHttpsService', function ($rootScope, $timeout, $q, Editor, Bubble, PhotoSize, ljHttpsService) {
    var factory = {
      url: '',
      link: '',
      secureUrl: ''
    },
        httpsImgSupporters = LJ.get('whitelist_https') || [];

    /**
     * Paste image by url
     * @type {{}}
     */
    factory.insertUrl = function () {
      return factory.updateSecureUrl().then(function () {
        // `secureUrl` may contain link to our https:// proxy,
        // which we shouldn't expose
        var urlToInsert = Editor.htmlMode() ? factory.url : factory.secureUrl,
            originalSrcAttr = Editor.htmlMode() ? null : 'originalSrc=\'' + factory.url + '\'',
            content,
            image = '<img src="{url}" alt="" {originalSrc}{width}/>'.supplant({
          url: urlToInsert,
          width: Number(PhotoSize.current.size) ? 'width="' + PhotoSize.current.size + '" ' : '',
          originalSrc: originalSrcAttr ? originalSrcAttr + ' ' : ''
        });


        if (factory.link) {
          content = '<a href="' + LJ.String.linkify(factory.link) + '">' + image + '</a>';
        } else {
          content = image;
        }

        Editor.insertContent('photouploader', content, [content]);

        factory.url = '';
        factory.link = '';

        Bubble.close();

        LJ.Track.event('Photouploader', 'Paste', 'Insert');
      });
    };

    factory.updateSecureUrl = function () {
      if (!factory.url) {
        factory.secureUrl = '';
        return $q.resolve();
      }
      return ljHttpsService.getSecureImageUrl(factory.url, httpsImgSupporters).then(function (_ref) {
        var secureUrl = _ref.secureUrl;

        return $timeout(function () {
          factory.secureUrl = secureUrl;
        }, 0);
        // Suppress errors
      }).catch(function () {});
    };

    return factory;
  }]).factory('AlbumPhoto', ['$q', 'Editor', 'PhotoSize', 'Photouploader', 'Bubble', 'Photo', function ($q, Editor, PhotoSize, Photouploader, Bubble, Photo) {
    var _sizeCache = PhotoSize.list,
        factory = {
      // placeholder album for init
      current: {
        photos: []
      },

      list: Photo.getAlbums(),

      originalLink: false
    };


    factory.noneSelected = function () {

      if (!factory.list.length || !factory.current.photos) {
        return true;
      }

      return factory.current.photos.filter(LJ.Function.get('selected')).length === 0;
    };

    factory.insert = function () {
      var size, selected;

      if (PhotoSize.insertInProgress) {
        return;
      }

      PhotoSize.insertInProgress = true;

      size = PhotoSize.current.size;
      selected = factory.current.photos.filter(LJ.Function.get('selected'));

      LJ.Event.trigger('albumInsert', size, selected);
    };

    factory.loadMore = function (limit) {
      var album = factory.current;

      if (!album.photos || album.photos.length === album.count || album.id === 'selected') {
        return $q.when(null);
      }

      return Photo.fetchRecords(album.id, {
        offset: album.photos.length || 0,
        limit: limit || 20,
        user: LJ.get('remote.username')
      }).then(function (records) {
        Array.prototype.push.apply(album.photos, records);
      });
    };

    factory.togglePhoto = function (photo) {
      photo.selected = !photo.selected;

      PhotoSize.list = PhotoSize.intersect(factory.current.photos.filter(LJ.Function.get('selected')).map(LJ.Function.get('available_sizes')));

      // if intersected sizes list not include previous size value
      // set biggest available or 'original'
      if (PhotoSize.list.indexOf(PhotoSize.current) === -1) {
        PhotoSize.current = PhotoSize.list.slice(-2)[0];
      }
    };

    LJ.Event.on('albumInsert', function (size, selected) {
      var toInsert = selected.map(function (photo) {

        var img = '<img src="{url}" alt="{description}" title="{name}">'.supplant({
          url: photo.url.replace('original', size),
          name: (photo.name || '').encodeHTML(),
          description: (photo.description || photo.name).encodeHTML()
        });

        if (factory.originalLink) {
          return '<a target="_blank" href="' + photo.url + '">' + img + '</a>';
        }

        return img;
      });

      Editor.insertContent('photouploader', toInsert.join('\n'), toInsert);
      PhotoSize.insertInProgress = false;
      PhotoSize.list = _sizeCache;

      factory.current.photos.forEach(LJ.Function.set('selected', false));

      Bubble.close();

      LJ.Track.event('Photouploader', 'Albums', 'Insert');
    });

    return factory;
  }]).controller('PhotoEditorCtrl', ['$scope', '$timeout', '$q', '$filter', 'Pills', 'Photo', 'Photouploader', 'DropboxPhoto', 'InstagramPhoto', 'PastePhoto', 'AlbumPhoto', 'PhotoSize', 'Bubble', PhotoEditorCtrl]).directive('ljDropboxButton', function () {
    // Render Dropbox chooser button
    return function (scope, elem) {
      LJ.Event.on('dropbox_loaded', function (options) {
        elem[0].appendChild(window.Dropbox.createChooseButton(options));
      });
    };
  });

  function PhotoEditorCtrl($scope, $timeout, $q, $filter, Pills, Photo, Photouploader, DropboxPhoto, InstagramPhoto, PastePhoto, AlbumPhoto, PhotoSize, Bubble) {
    var that = this;

    that.state = {
      canUpload: LJ.get('remote') && !LJ.get('remote_is_identity'),
      insertInProgress: false,
      uploadInProgress: false,
      isOpen: false
    };

    that.instagram = InstagramPhoto;
    that.paste = PastePhoto;
    that.albums = AlbumPhoto;
    that.ui = PhotoSize;

    that.hasAlbums = function () {
      return AlbumPhoto.length !== 0;
    };

    that.isPill = function (pillName) {
      return Pills.group('uploadPhoto') === pillName;
    };

    that.pill = function (pillName) {
      pillName = pillName || LJ.Storage.getItem('photoUploadPill') || 'paste';

      Pills.group('uploadPhoto', pillName);
      LJ.Storage.setItem('photoUploadPill', pillName);
    };

    $scope.$watch(function () {
      return that.state.isOpen;
    }, function (isOpen) {
      if (isOpen === true) {
        DropboxPhoto.init();
        fetchAlbums();
      }
    });

    var debouncedSecureUrl = LJ.Function.debounce(that.paste.updateSecureUrl, 1500);

    $scope.$watch(function () {
      return that.paste.url;
    }, function (newUrl, oldUrl) {
      if (angular.isString(newUrl) && newUrl !== oldUrl) {
        that.paste.secureUrl = '';
        debouncedSecureUrl(newUrl);
      }
    });

    $scope.$watch(function () {
      return that.instagram.asEmbed;
    }, function (asEmbed) {
      if (asEmbed) {
        that.instagram.needTitle = false;
      }
    });

    $scope.$watch(function () {
      return that.instagram.token();
    }, that.instagram.loadMore);

    LJ.Event.on('instagram_token', function (token) {
      $timeout(function () {
        that.instagram.token(token);
      });
    });

    $scope.$watch(function () {
      return that.ui && that.ui.current;
    }, function (currentSize, previousSize) {
      if (currentSize && currentSize !== previousSize) {
        LJ.Cookie.set('photo_size', currentSize.size);
      }
    });

    $scope.$watch(function () {
      return that.albums.current;
    }, function (album) {
      if (!album || !album.id || !/\d/.test(album.id)) {
        return;
      }

      if (LJ.get('fotki.insert') && album.id === that.requestAlbumId) {
        if (!that.cachedRequestPhotos) {
          var pics = LJ.get('fotki.insert').map(function (el) {
            return {
              id: el.photo_id,
              name: el.photo_title ? el.photo_title : LJ.ml('fotki.album.edit.empty.photo.title'),
              description: el.photo_desc,
              thumbnail_url: el.photo_url,
              url: el.photo_orig,
              available_sizes: el.available_sizes,
              selected: true
            };
          });
          that.cachedRequestPhotos = pics.map($filter('decodeRecord'));
        }
        that.albums.current.photos = that.cachedRequestPhotos;
      } else {
        Photo.fetchRecords(album.id, {
          offset: 0,
          limit: 20,
          user: LJ.get('remote.username')
        }).then(function (result) {
          that.albums.current.photos = result.map($filter('decodeRecord'));
        });
      }
      LJ.Storage.setItem('photouploader_album_id', album.id);
    });

    $scope.$on('bubble:open:photouploader', function () {
      var isGetArgs = LiveJournal.parseGetArgs().albums_id || LiveJournal.parseGetArgs().photo_id;
      that.state.isOpen = true;

      if (LJ.get('fotki.insert') || isGetArgs && that.state.canUpload) {
        that.pill('album');
        checkUrl();
      } else {
        that.pill(that.state.canUpload ? LJ.Storage.getItem('photouploader2_state') || 'upload' : 'paste');

        // if user has removed last album - show "upload" section
        if (that.isPill('album') && !that.hasAlbums()) {
          that.pill('upload');
        }
      }
    });

    $scope.$on('bubble:close:photouploader', function () {
      that.state.isOpen = false;
    });

    LJ.Event.on('photo:upload:start', function () {
      that.state.uploadInProgress = true;
    });

    LJ.Event.on('upload:photo:cancel', function () {
      that.state.uploadInProgress = false;
    });

    LJ.Event.on('upload:photo:done', function () {
      Bubble.close();
    });

    // add photos to post throught ?photo_id=XXXX&user=test query parameters
    function checkUrl() {
      var photoIds = LiveJournal.parseGetArgs().photo_id,
          albumId = LiveJournal.parseGetArgs().albums_id;

      if (photoIds) {
        return selectPhotos(photoIds);
      }

      if (albumId) {
        that.requestAlbumId = +albumId;
        return selectAlbum(that.requestAlbumId);
      }
    }

    function selectPhotos(photoIds) {
      var promises;

      promises = photoIds.split(',').map(function (photoId) {
        return Photo.fetchRecordById({ id: photoId });
      });
      promises.push(Photo.fetchAlbums());

      $q.all(promises).then(function (records) {
        records.splice(-1);
        that.albums.current = fakeAlbum(records.map($filter('decodeRecord')));
      });
    }

    function selectAlbum(albumId) {
      LJ.Event.on('photo:albums:loaded', function () {
        var album = that.albums.list.find(function (item) {
          return item.id === albumId;
        });
        album.selected = true;
        that.albums.current = album;
      });
    }

    function fetchAlbums() {
      if (!that.state.canUpload) {
        return;
      }

      Photo.fetchAlbums({
        user: LJ.get('remote.username')
      }).then(function () {
        that.albums.list = Photo.getAlbums();
        that.albums.current = that.albums.list[0];
        LJ.Event.trigger('photo:albums:loaded');
      });
    }

    function fakeAlbum(photos) {
      var album = {
        id: 'selected',
        name: LJ.ml('photouploader.album.scrapbookSelected'),
        photos: photos.map(LJ.Function.set('selected', true))
      };

      that.albums.list.push(album);
      return album;
    }
  }
})();
/* <<< file end: js/photo/editor.js */

//# map link was there [editor.js.map]
/* >>> file start: js/core.js */
/*
Core JavaScript Library

Copyright (c) 2005, Six Apart, Ltd.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

    * Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

    * Redistributions in binary form must reproduce the above
copyright notice, this list of conditions and the following disclaimer
in the documentation and/or other materials provided with the
distribution.

    * Neither the name of "Six Apart" nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

*/

/* stubs */

log = function log() {};
log.error = log.warn = log.debug = log;

/* utility functions */

defined = function defined(x) {
    return x === undefined ? false : true;
};

/**
 * Utility method.
 * @param x <code>any</code> Any JavaScript value, including <code>undefined</code>.
 * @return boolean <code>true</code> if the value is not <code>null</code> and is not <code>undefined</code>.
 */
exists = function exists(x) {
    return x === undefined || x === null ? false : true;
};

finite = function finite(x) {
    return isFinite(x) ? x : 0;
};

finiteInt = function finiteInt(x, base) {
    return finite(parseInt(x, base));
};

finiteFloat = function finiteFloat(x) {
    return finite(parseFloat(x));
};

max = function max() {
    var a = arguments,
        n = a[0];

    for (var i = 1; i < a.length; i++) {
        if (a[i] > n) n = a[i];
    }return n;
};

min = function min() {
    var a = arguments,
        n = a[0];

    for (var i = 1; i < a.length; i++) {
        if (a[i] < n) n = a[i];
    }return n;
};

/* try block */

Try = {
    these: function these() {
        for (var i = 0; i < arguments.length; i++) {
            try {
                return arguments[i]();
            } catch (e) {}
        }
        return undefined;
    }

    /* unique id generator */

};Unique = {
    length: 0,

    id: function id() {
        return ++this.length;
    }

    /* event methods */

};if (!defined(window.Event)) Event = {};

Event.stop = function (e) {
    // this set in Event.prep
    e = e || window.event || this;
    Event.stopPropagation(e);
    Event.preventDefault(e);
    return false;
};

Event.stopPropagation = function (e) {
    if (e && e.stopPropagation) e.stopPropagation();else window.event.cancelBubble = true;
};

Event.preventDefault = function (e) {
    e = e || window.event;
    if (e.preventDefault) e.preventDefault();
    e.returnValue = false;
};

Event.prep = function (event) {
    event = event || window.event;
    if (!defined(event.stop)) event.stop = this.stop;
    if (!defined(event.target)) event.target = event.srcElement;
    if (!defined(event.relatedTarget)) event.relatedTarget = event.toElement;
    return event;
};

/* object extensions */

Function.stub = function () {};

if (!Object.extend) Object.extend = function (d, s) {
    if (d) for (var p in s) {
        if (!d[p]) d[p] = s[p];
    }return d;
};

if (!Object.override) Object.override = function (d, s) {
    if (d) for (var p in s) {
        d[p] = s[p];
    }return d;
};

/* function extensions */

Object.extend(Function.prototype, {
    bind: function bind(object) {
        var method = this;
        return function () {
            return method.apply(object, arguments);
        };
    },

    bindEventListener: function bindEventListener(object) {
        var method = this; // Use double closure to work around IE 6 memory leak.
        return function (event) {
            try {
                event = Event.prep(event);
            } catch (e) {}
            return method.call(object, event);
        };
    }
});

/* class helpers */

indirectObjects = [];

Class = function (_Class) {
    function Class(_x) {
        return _Class.apply(this, arguments);
    }

    Class.toString = function () {
        return _Class.toString();
    };

    return Class;
}(function (superClass) {

    // Set the constructor:
    var constructor = function constructor() {
        if (arguments.length) this.init.apply(this, arguments);
    };
    //   -- Accomplish static-inheritance:
    Object.override(constructor, Class); // inherit static methods from Class

    superClass = superClass || function () {};
    superClassFunc = function superClassFunc() {};
    Object.extend(superClassFunc.prototype, superClass.prototype);
    Object.extend(superClassFunc.prototype, {
        init: function init() {},
        destroy: function destroy() {}
    });
    Object.override(constructor, superClass); // inherit static methods from the superClass
    constructor.superClass = superClassFunc.prototype;

    // Set the constructor's prototype (accomplish object-inheritance):
    constructor.prototype = new superClass();
    constructor.prototype.constructor = constructor; // rev. 0.7    
    //   -- extend prototype with Class instance methods
    Object.extend(constructor.prototype, Class.prototype);
    //   -- override prototype with interface methods
    for (var i = 1; i < arguments.length; i++) {
        Object.override(constructor.prototype, arguments[i]);
    }return constructor;
});

Object.extend(Class, {
    initSingleton: function initSingleton() {
        if (this.singleton) return this.singleton;
        this.singleton = this.singletonConstructor ? new this.singletonConstructor() : new this();
        this.singleton.init.apply(this.singleton, arguments);
        return this.singleton;
    }
});

Class.prototype = {
    destroy: function destroy() {
        try {
            if (this.indirectIndex) indirectObjects[this.indirectIndex] = undefined;
            delete this.indirectIndex;
        } catch (e) {}

        for (var property in this) {
            try {
                delete this[property];
            } catch (e) {}
        }
    },

    getBoundMethod: function getBoundMethod(methodName) {
        return this[name].bind(this);
    },

    getEventListener: function getEventListener(methodName) {
        return this[methodName].bindEventListener(this);
    },

    getIndirectIndex: function getIndirectIndex() {
        if (!defined(this.indirectIndex)) {
            this.indirectIndex = indirectObjects.length;
            indirectObjects.push(this);
        }
        return this.indirectIndex;
    },

    getIndirectMethod: function getIndirectMethod(methodName) {
        if (!this.indirectMethods) this.indirectMethods = {};
        var method = this[methodName];
        if (typeof method != "function") return undefined;
        var indirectIndex = this.getIndirectIndex();
        if (!this.indirectMethods[methodName]) {
            this.indirectMethods[methodName] = new Function("var o = indirectObjects[" + indirectIndex + "];" + "return o." + methodName + ".apply( o, arguments );");
        }
        return this.indirectMethods[methodName];
    },

    getIndirectEventListener: function getIndirectEventListener(methodName) {
        if (!this.indirectEventListeners) this.indirectEventListeners = {};
        var method = this[methodName];
        if (typeof method != "function") return undefined;
        var indirectIndex = this.getIndirectIndex();
        if (!this.indirectEventListeners[methodName]) {
            this.indirectEventListeners[methodName] = new Function("event", "try { event = Event.prep( event ); } catch( e ) {}" + "var o = indirectObjects[" + indirectIndex + "];" + "return o." + methodName + ".call( o, event );");
        }
        return this.indirectEventListeners[methodName];
    }

    /* string extensions */

};Object.extend(String, {
    escapeJSChar: function escapeJSChar(c) {
        // try simple escaping
        switch (c) {
            case "\\":
                return "\\\\";
            case "\"":
                return "\\\"";
            case "'":
                return "\\'";
            case "\b":
                return "\\b";
            case "\f":
                return "\\f";
            case "\n":
                return "\\n";
            case "\r":
                return "\\r";
            case "\t":
                return "\\t";
        }

        // return raw bytes now ... should be UTF-8
        if (c >= " ") return c;

        // try \uXXXX escaping, but shouldn't make it for case 1, 2
        c = c.charCodeAt(0).toString(16);
        switch (c.length) {
            case 1:
                return "\\u000" + c;
            case 2:
                return "\\u00" + c;
            case 3:
                return "\\u0" + c;
            case 4:
                return "\\u" + c;
        }

        // should never make it here
        return "";
    },

    encodeEntity: function encodeEntity(c) {
        switch (c) {
            case "<":
                return "&lt;";
            case ">":
                return "&gt;";
            case "&":
                return "&amp;";
            case '"':
                return "&quot;";
            case "'":
                return "&apos;";
        }
        return c;
    },

    decodeEntity: function decodeEntity(c) {
        switch (c) {
            case "amp":
                return "&";
            case "quot":
                return '"';
            case "gt":
                return ">";
            case "lt":
                return "<";
        }
        var m = c.match(/^#(\d+)$/);
        if (m && defined(m[1])) return String.fromCharCode(m[1]);
        m = c.match(/^#x([0-9a-f]+)$/i);
        if (m && defined(m[1])) return String.fromCharCode(parseInt(hex, m[1]));
        return c;
    }
});

Object.extend(String.prototype, {
    escapeJS: function escapeJS() {
        return this.replace(/([^ -!#-\[\]-~])/g, function (m, c) {
            return String.escapeJSChar(c);
        });
    },

    escapeJS2: function escapeJS2() {
        return this.replace(/([\u0000-\u0031'"\\])/g, function (m, c) {
            return String.escapeJSChar(c);
        });
    },

    escapeJS3: function escapeJS3() {
        return this.replace(/[\u0000-\u0031'"\\]/g, function (m) {
            return String.escapeJSChar(m);
        });
    },

    escapeJS4: function escapeJS4() {
        return this.replace(/./g, function (m) {
            return String.escapeJSChar(m);
        });
    },

    encodeHTML: function encodeHTML() {
        return this.replace(/([<>&"])/g, function (m, c) {
            return String.encodeEntity(c);
        });
    },

    decodeHTML: function decodeHTML() {
        return this.replace(/&(.*?);/g, function (m, c) {
            return String.decodeEntity(c);
        });
    },

    cssToJS: function cssToJS() {
        return this.replace(/-([a-z])/g, function (m, c) {
            return c.toUpperCase();
        });
    },

    jsToCSS: function jsToCSS() {
        return this.replace(/([A-Z])/g, function (m, c) {
            return "-" + c.toLowerCase();
        });
    },

    firstToLowerCase: function firstToLowerCase() {
        return this.replace(/^(.)/, function (m, c) {
            return c.toLowerCase();
        });
    },

    rgbToHex: function rgbToHex() {
        var c = this.match(/(\d+)\D+(\d+)\D+(\d+)/);
        if (!c) return undefined;
        return "#" + finiteInt(c[1]).toString(16).pad(2, "0") + finiteInt(c[2]).toString(16).pad(2, "0") + finiteInt(c[3]).toString(16).pad(2, "0");
    },

    pad: function pad(length, padChar) {
        var padding = length - this.length;
        if (padding <= 0) return this;
        if (!defined(padChar)) padChar = " ";
        var out = [];
        for (var i = 0; i < padding; i++) {
            out.push(padChar);
        }out.push(this);
        return out.join("");
    },

    trim: function trim() {
        return this.replace(/^\s+|\s+$/g, "");
    }

});

/* extend array object */

Object.extend(Array, {
    fromPseudo: function fromPseudo(args) {
        var out = [];
        for (var i = 0; i < args.length; i++) {
            out.push(args[i]);
        }return out;
    }
});

/* extend array object */

Object.extend(Array.prototype, {
    copy: function copy() {
        var out = [];
        for (var i = 0; i < this.length; i++) {
            out[i] = this[i];
        }return out;
    },

    first: function first(callback, object) {
        var length = this.length;
        for (var i = 0; i < length; i++) {
            var result = object ? callback.call(object, this[i], i, this) : callback(this[i], i, this);
            if (result) return this[i];
        }
        return null;
    },

    fitIndex: function fitIndex(fromIndex, defaultIndex) {
        if (!defined(fromIndex) || fromIndex == null) fromIndex = defaultIndex;else if (fromIndex < 0) {
            fromIndex = this.length + fromIndex;
            if (fromIndex < 0) fromIndex = 0;
        } else if (fromIndex >= this.length) fromIndex = this.length - 1;
        return fromIndex;
    },

    scramble: function scramble() {
        for (var i = 0; i < this.length; i++) {
            var j = Math.floor(Math.random() * this.length),
                temp = this[i];

            this[i] = this[j];
            this[j] = temp;
        }
    },

    add: function add() {
        var a = arguments;
        for (var i = 0; i < a.length; i++) {
            var index = this.indexOf(a[i]);
            if (index < 0) this.push(arguments[i]);
        }
        return this.length;
    },

    remove: function remove() {
        var a = arguments;
        for (var i = 0; i < a.length; i++) {
            var j = this.indexOf(a[i]);
            if (j >= 0) this.splice(j, 1);
        }
        return this.length;
    },

    /* javascript 1.5 array methods */
    /* http://developer-test.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Objects:Array#Methods */

    every: function every(callback, object) {
        var length = this.length;
        for (var i = 0; i < length; i++) {
            var result = object ? callback.call(object, this[i], i, this) : callback(this[i], i, this);
            if (!result) return false;
        }
        return true;
    },

    filter: function filter(callback, object) {
        var out = [],
            length = this.length;

        for (var i = 0; i < length; i++) {
            var result = object ? callback.call(object, this[i], i, this) : callback(this[i], i, this);
            if (result) out.push(this[i]);
        }
        return out;
    },

    forEach: function forEach(callback, object) {
        var length = this.length;
        for (var i = 0; i < length; i++) {
            object ? callback.call(object, this[i], i, this) : callback(this[i], i, this);
        }
    },

    indexOf: function indexOf(value, fromIndex) {
        fromIndex = this.fitIndex(fromIndex, 0);
        for (var i = 0; i < this.length; i++) {
            if (this[i] === value) return i;
        }
        return -1;
    },

    lastIndexOf: function lastIndexOf(value, fromIndex) {
        fromIndex = this.fitIndex(fromIndex, this.length - 1);
        for (var i = fromIndex; i >= 0; i--) {
            if (this[i] == value) return i;
        }
        return -1;
    },

    some: function some(callback, object) {
        var length = this.length;
        for (var i = 0; i < length; i++) {
            var result = object ? callback.call(object, this[i], i, this) : callback(this[i], i, this);
            if (result) return true;
        }
        return false;
    },

    /* javascript 1.2 array methods */

    concat: function concat() {
        var a = arguments,
            out = this.copy();

        for (i = 0; i < a.length; i++) {
            var b = a[i];
            for (j = 0; j < b.length; j++) {
                out.push(b[j]);
            }
        }
        return out;
    },

    push: function push() {
        var a = arguments;
        for (var i = 0; i < a.length; i++) {
            this[this.length] = a[i];
        }return this.length;
    },

    pop: function pop() {
        if (this.length == 0) return undefined;
        var out = this[this.length - 1];
        this.length--;
        return out;
    },

    unshift: function unshift() {
        var a = arguments;
        for (var i = 0; i < a.length; i++) {
            this[i + a.length] = this[i];
            this[i] = a[i];
        }
        return this.length;
    },

    shift: function shift() {
        if (this.length == 0) return undefined;
        var out = this[0];
        for (var i = 1; i < this.length; i++) {
            this[i - 1] = this[i];
        }this.length--;
        return out;
    }
});

/* date extensions */

Object.extend(Date, {
    /*  iso 8601 date format parser
        this was fun to write...
        thanks to: http://www.cl.cam.ac.uk/~mgk25/iso-time.html */

    matchISOString: new RegExp("^([0-9]{4})" + // year
    "(?:-(?=0[1-9]|1[0-2])|$)(..)?" + // month
    "(?:-(?=0[1-9]|[12][0-9]|3[01])|$)([0-9]{2})?" + // day of the month
    "(?:T(?=[01][0-9]|2[0-4])|$)T?([0-9]{2})?" + // hours
    "(?::(?=[0-5][0-9])|\\+|-|Z|$)([0-9]{2})?" + // minutes
    "(?::(?=[0-5][0-9]|60$|60[+|-|Z]|60.0+)|\\+|-|Z|$):?([0-9]{2})?" + // seconds
    "(\.[0-9]+)?" + // fractional seconds
    "(Z|\\+[01][0-9]|\\+2[0-4]|-[01][0-9]|-2[0-4])?" + // timezone hours
    ":?([0-5][0-9]|60)?$" // timezone minutes
    ),

    fromISOString: function fromISOString(string) {
        var t = this.matchISOString.exec(string);
        if (!t) return undefined;

        var year = finiteInt(t[1], 10),
            month = finiteInt(t[2], 10) - 1,
            day = finiteInt(t[3], 10),
            hours = finiteInt(t[4], 10),
            minutes = finiteInt(t[5], 10),
            seconds = finiteInt(t[6], 10),
            milliseconds = finiteInt(Math.round(parseFloat(t[7]) * 1000)),
            tzHours = finiteInt(t[8], 10),
            tzMinutes = finiteInt(t[9], 10),
            date = new this(0);

        if (defined(t[8])) {
            date.setUTCFullYear(year, month, day);
            date.setUTCHours(hours, minutes, seconds, milliseconds);
            var offset = (tzHours * 60 + tzMinutes) * 60000;
            if (offset) date = new this(date - offset);
        } else {
            date.setFullYear(year, month, day);
            date.setHours(hours, minutes, seconds, milliseconds);
        }

        return date;
    }
});

Object.extend(Date.prototype, {
    getISOTimezoneOffset: function getISOTimezoneOffset() {
        var offset = -this.getTimezoneOffset(),
            negative = false;

        if (offset < 0) {
            negative = true;
            offset *= -1;
        }
        var offsetHours = Math.floor(offset / 60).toString().pad(2, "0"),
            offsetMinutes = Math.floor(offset % 60).toString().pad(2, "0");

        return (negative ? "-" : "+") + offsetHours + ":" + offsetMinutes;
    },

    toISODateString: function toISODateString() {
        var year = this.getFullYear(),
            month = (this.getMonth() + 1).toString().pad(2, "0"),
            day = this.getDate().toString().pad(2, "0");

        return year + "-" + month + "-" + day;
    },

    toUTCISODateString: function toUTCISODateString() {
        var year = this.getUTCFullYear(),
            month = (this.getUTCMonth() + 1).toString().pad(2, "0"),
            day = this.getUTCDate().toString().pad(2, "0");

        return year + "-" + month + "-" + day;
    },

    toISOTimeString: function toISOTimeString() {
        var hours = this.getHours().toString().pad(2, "0"),
            minutes = this.getMinutes().toString().pad(2, "0"),
            seconds = this.getSeconds().toString().pad(2, "0"),
            milliseconds = this.getMilliseconds().toString().pad(3, "0"),
            timezone = this.getISOTimezoneOffset();

        return hours + ":" + minutes + ":" + seconds + "." + milliseconds + timezone;
    },

    toUTCISOTimeString: function toUTCISOTimeString() {
        var hours = this.getUTCHours().toString().pad(2, "0"),
            minutes = this.getUTCMinutes().toString().pad(2, "0"),
            seconds = this.getUTCSeconds().toString().pad(2, "0"),
            milliseconds = this.getUTCMilliseconds().toString().pad(3, "0");

        return hours + ":" + minutes + ":" + seconds + "." + milliseconds + "Z";
    },

    toISOString: function toISOString() {
        return this.toISODateString() + "T" + this.toISOTimeString();
    },

    toUTCISOString: function toUTCISOString() {
        return this.toUTCISODateString() + "T" + this.toUTCISOTimeString();
    }
});

/* ajax */

if (!defined(window.XMLHttpRequest)) {
    window.XMLHttpRequest = function () {
        var types = ["Microsoft.XMLHTTP", "MSXML2.XMLHTTP.5.0", "MSXML2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP"];

        for (var i = 0; i < types.length; i++) {
            try {
                return new ActiveXObject(types[i]);
            } catch (e) {}
        }

        return undefined;
    };
}
/* <<< file end: js/core.js */

//# map link was there [core.js.map]
/* >>> file start: js/captcha.js */
/*global grecaptcha */
/**
 * LiveJournal implementation of captcha
 * @author Valeriy Vasin (valeriy.vasin@sup.com)
 */

/* eslint-disable angular/window-service */
/* eslint-disable angular/document-service */
/* eslint-disable angular/interval-service */
/* eslint-disable angular/log */
/* eslint-disable angular/angularelement */
/* eslint-disable angular/definedundefined */
(function (a) {
  return a;
})();

(function ($) {

  LJ.define('LJ.Captcha');

  LJ.Captcha = {
    create: create,
    reload: reload,
    destroy: destroy,

    getChallenge: getChallenge,
    getResponse: getResponse,
    isDefined: _isCaptchaDefined,
    execute: execute,
    current: ['recaptcha'].filter(LJ.Flags.isEnabled).shift()
  };

  // "Is any kind of Captcha enabled sitewise and not disabled by flag?"
  LJ.Captcha.available = !!LJ.Captcha.current;

  // Popup detection methods
  var waitForPopupCreation = void 0,
      waitForPopupHide = void 0,
      waitForPopupShow = void 0,
      publicKey,
      Captcha,
      options = {
    lang: 'ru'
  };


  function _isCaptchaDefined() {
    return typeof Captcha !== 'undefined';
  }

  function _getPublicKey() {
    // eslint-disable-next-line new-cap
    var defer = $.Deferred();

    if (publicKey) {
      defer.resolve(publicKey);
    } else {
      LJ.Api.call('captcha.get_public_key', {}, function (response) {
        publicKey = response.captcha_public;
        defer.resolve(publicKey);
      });
    }

    return defer.promise();
  }

  // eslint-disable-next-line new-cap
  var recaptchaLoaded = $.Deferred();

  // eslint-disable-next-line angular/window-service
  window.onRecaptchaLoad = function () {
    recaptchaLoaded.resolve();
  };

  function _getCaptchaScriptLink() {
    return location.protocol + '//www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit';
  }

  var _loadCaptchaScript = LJ.Function.once(function () {
    // eslint-disable-next-line new-cap
    var defer = $.Deferred();

    LJ.injectScript(_getCaptchaScriptLink());
    recaptchaLoaded.then(function () {
      Captcha = grecaptcha;
      defer.resolve();
    });

    return defer.promise();
  });

  function create(containerId, opts) {
    // eslint-disable-next-line new-cap
    var defer = $.Deferred();

    opts = $.extend(options, opts || {});

    if (!LJ.Captcha.current) {
      defer.resolve();
      return defer.promise();
    }

    return $.when(_getPublicKey(), _loadCaptchaScript()).then(function () {
      if (_isCaptchaDefined()) {
        opts.sitekey = publicKey;
        waitForPopupCreation();
        return Captcha.render(containerId, opts);
      } else {
        console.error('Something went wrong. Captcha object is not defined.');
      }
    });
  }

  // The only supported captcha option (invisible reCaptcha) does not support this method.
  function destroy() {}

  function reload() {
    if (_isCaptchaDefined()) {
      waitForPopupCreation();
      return Captcha.reset.apply(null, arguments);
    }
  }

  function getChallenge() {
    return null;
  }

  function getResponse(captchaWidgetId) {
    if (_isCaptchaDefined()) {
      return Captcha.getResponse(captchaWidgetId);
    }
  }

  function execute() {
    waitForPopupShow();
    return (Captcha || grecaptcha).execute.apply(null, arguments);
  }

  LJ.Captcha.getCaptchaApiObject = function () {
    return Captcha || grecaptcha;
  };

  // Helper for Invisible ReCAPTCHA
  // Used on pages with a single simple form,
  // where captcha is inserted in template by server.
  LJ.Captcha.setOnSimpleForm = function (formNode, submitBtnNode) {
    waitForPopupCreation();
    window.onCaptchaPass = function () {
      // We may have a button[name=submit] here,
      // which shadows the method needed
      var submitFormFunction = Object.getPrototypeOf(formNode).submit;
      submitFormFunction.call(formNode);
    };
    submitBtnNode.addEventListener('click', function (event) {
      event.preventDefault();
      execute();
    });
  };

  LJ.Event.on('reCAPTCHA::popup::created', function (popupTopContainer) {
    var overlay = popupTopContainer.firstChild,
        iframeContainer = popupTopContainer.lastChild,
        iframe = iframeContainer.firstChild;

    popupTopContainer.classList.add('recaptcha-tiles');
    overlay && overlay.classList.add('recaptcha-tiles__fader');
    iframeContainer && iframeContainer.classList.add('recaptcha-tiles__iframe-wrapper');
    iframe && iframe.classList.add('recaptcha-tiles__iframe');
  });

  LJ.Event.on('reCAPTCHA::popup::shown', function () {
    document.body.classList.add('body--recaptcha-opened');
  });

  LJ.Event.on('reCAPTCHA::popup::hidden', function () {
    document.body.classList.remove('body--recaptcha-opened');
  });

  // Heuristic for Invisible reCAPTCHA challenge iframe detection,
  // May cease to work after future reCAPTCHA updates
  function isChallengeIframe(iframe) {
    var titleAttr = iframe.attributes.title,
        srcAttr = iframe.attributes.src;

    if (titleAttr) {
      var title = titleAttr.value;
      if (/испытание|challenge/.test(title) && /recaptcha/.test(title)) {
        return true;
      }
    }
    if (srcAttr) {
      var src = srcAttr.value;
      if (/google\.com.*recaptcha.*bframe/.test(src)) {
        return true;
      }
    }
    return false;
  }

  // Popup detection
  (function () {
    var creationInterval = void 0,
        popupTopContainer = void 0;


    // Tries to detect popup node
    // by checking last body child by certain criteria
    waitForPopupCreation = function waitForPopupCreation() {
      var lastChild = document.body.lastChild;
      creationInterval = setInterval(function () {
        var currentLastChild = document.body.lastChild;
        if (currentLastChild === lastChild) {
          return;
        }
        lastChild = currentLastChild;
        var iframe = lastChild.querySelector('iframe');
        if (!(iframe && isChallengeIframe(iframe))) {
          return;
        }
        popupTopContainer = lastChild;
        console.log('reCAPTCHA popup created');
        LJ.Event.trigger('reCAPTCHA::popup::created', popupTopContainer);
        clearInterval(creationInterval);
        creationInterval = null;
      }, 100);
    };

    var waitingSince = void 0,
        showHideInterval = void 0;


    waitForPopupHide = function waitForPopupHide() {
      waitingSince = new Date();
      if (showHideInterval) {
        return;
      }
      showHideInterval = setInterval(function () {
        if (popupTopContainer && +popupTopContainer.style.opacity === 0) {
          console.log('reCAPTCHA popup hidden');
          LJ.Event.trigger('reCAPTCHA::popup::hidden');
          clearInterval(showHideInterval);
          showHideInterval = null;
        }
      }, 100);
    };

    var MAX_WAIT_SHOW = 10 * 1000;

    waitForPopupShow = function waitForPopupShow() {
      waitingSince = new Date();
      if (showHideInterval) {
        return;
      }
      showHideInterval = setInterval(function () {
        if (popupTopContainer && +popupTopContainer.style.opacity === 1) {
          console.log('reCAPTCHA popup shown');
          LJ.Event.trigger('reCAPTCHA::popup::shown');
          clearInterval(showHideInterval);
          showHideInterval = null;
          waitForPopupHide();
        } else if (new Date() > waitingSince + MAX_WAIT_SHOW) {
          console.log('reCAPTCHA popup taking too long to appear, aborting wait');
          clearInterval(showHideInterval);
          showHideInterval = null;
        }
      }, 100);
    };
  })();
})(jQuery);
/* <<< file end: js/captcha.js */

//# map link was there [captcha.js.map]
/* >>> file start: js/feed/quickComments.js */
//= require js/node_modules/angular-sanitize/angular-sanitize.js
//= require js/node_modules/moment/min/moment.min.js
//= require js/core/angular/bubble.js
//= require js/core/angular/api.js
//= require js/photo/editor.js
//= require js/video/editor.js
//!= require js/core/support.js
//= require js/core.js
//= require js/editor/basicToolbar.js
//= require js/captcha.js

Site.page.template['angular/feed/quickComments.ng.tmpl'] = '<!-- QUICK COMMENTS -->\n<div\n  ng-repeat=\"comment in quickComments.existArr\"\n    class=\"\n        entryunit__quick-comments\n        quick-comments-entryunit\n        quick-comment-entryunit__item\n        \"\n    >\n    <div\n        class=\"\n            quick-comment-entryunit\n            quick-comment-entryunit--comment\n            \"\n        >\n        <figure\n            ng-style=\"{\'background-image\' : \'url(\' + quickComments.remote.userpic_url + \')\'}\"\n            title=\"{{quickComments.remote.username}}\"\n            class=\"quick-comment-entryunit__userpic\"\n            >\n            <img\n                ng-src=\"{{quickComments.remote.userpic_url}}\"\n                alt=\"{{quickComments.remote.username}}\"\n                class=\"quick-comment-entryunit__userpic--hide\"\n                >\n        </figure>\n        <section\n            class=\"quick-comment-entryunit__content\"\n            >\n            <header\n                class=\"quick-comment-entryunit__header\"\n                >\n\n\n\n                <!-- This part will be replace on variables from server -->\n                <ul\n                    class=\"meta-entryunit__items\"\n                    ><!--\n                    --><li\n                        class=\"meta-entryunit__item\"\n                        ><!--\n                        --><span\n                            class=\"\n                                entryunit__author\n                                author-entryunit\n                                js-elem-color\n                                \"\n                            ><!--\n                            --><span\n                                class=\"\n                                    ljuser\n                                    i-ljuser\n                                    i-ljuser-type-P\n                                    \"\n                                lj-user-dynamic=\"quickComments.remote.username\"\n                                ng-if=\"quickComments.remote !== null\"\n                            ></span><!--\n                            --><span\n                                lj-ml=\"talk.anonuser\"\n                                ng-if=\"quickComments.remote === null\"\n                            ></span><!--\n                        --></span><!--\n                    --></li><!--\n                    --><li\n                        class=\"meta-entryunit__item\"\n                        ><!--\n                        --><time\n                            class=\"\n                                entryunit__date\n                                js-elem-color\n                                \"\n                            datetime=\"{{comment.datetime}}\"\n                            ><!--\n                            -->{{comment.date}}<!--\n                        --></time><!--\n                    --></li><!--\n                --></ul>\n                <!-- End of replaced part -->\n\n            </header>\n            <div\n                class=\"\n                quick-comment-entryunit__comment\n                js-font-family\n                js-font-color\n                \"\n                ng-bind-html=\"comment.preview\"\n                ></div>\n            <footer\n                class=\"quick-comment-entryunit__footer\"\n                >\n                <div\n                    class=\"quick-comment-entryunit__controls\"\n                    ng-class=\"{\'quick-comment-entryunit__controls--mobile\': quickComments.mobile}\"\n                    ng-if=\"quickComments.remote !== null\"\n                    ><!--\n                    --><button\n                        lj-ml=\"talk.delete\"\n                        ng-click=\"quickComments.deleteComment(comment)\"\n                        class=\"\n                            quick-comment-entryunit__control\n                            quick-comment-entryunit__control--delete\n                            js-link-color\n                            \"\n                        ></button><!--\n                    --><span class=\"quick-comment-entryunit__control--middot\"></span><!--\n                    --><button\n                        lj-ml=\"talk.edit\"\n                        ng-if=\"!vm.commentIsBeingEdited\"\n                        ng-click=\"quickComments.editComment(comment)\"\n                        class=\"\n                            quick-comment-entryunit__control\n                            quick-comment-entryunit__control--edit\n                            js-link-color\n                            \"\n                        ></button><!--\n                --></div>\n            </footer>\n        </section>\n    </div>\n\n</div>\n<!-- /QUCIK COMMENTS -->\n\n<!-- QUCIK COMMENT FORM -->\n<form\nclass=\"\n    entryunit__quick-comment\n    quick-comment-entryunit\n    quick-comment-entryunit-form\n    quick-comment-entryunit--loading\n    quick-comment-entryunit--focus\n    \"\nng-class=\"{\n    \'quick-comment-entryunit-form--focus\': quickComments.shouldBeExpanded(),\n    \'quick-comment-entryunit--mobile\': quickComments.mobile\n    }\"\n>\n    <figure\n        ng-if=\"quickComments.remote.userpic_url\"\n        ng-style=\"{\'background-image\' : \'url(\' + quickComments.remote.userpic_url + \')\'}\"\n        title=\"{{quickComments.remote.username}}\"\n        class=\"quick-comment-entryunit__userpic\"\n        >\n        <img\n            ng-src=\"{{quickComments.remote.userpic_url}}\"\n            alt=\"{{quickComments.remote.username}}\"\n            class=\"quick-comment-entryunit__userpic--hide\"\n            >\n    </figure>\n\n    <figure\n            ng-if=\"!quickComments.remote.userpic_url\"\n            ng-style=\"{\'background-image\' : \'url(\' + quickComments.statprefix + \'/img/userpics/userpic-user.png?v=15821)\'}\"\n            title=\"{{quickComments.remote.username}}\"\n            class=\"quick-comment-entryunit__userpic\"\n    >\n        <img\n                ng-src=\"{{quickComments.statprefix}}/img/userpics/userpic-user.png?v=15821)\"\n                alt=\"{{quickComments.remote.username}}\"\n                class=\"quick-comment-entryunit__userpic--hide\"\n        >\n    </figure>\n\n    <section\n        class=\"quick-comment-entryunit__content\"\n        >\n        <a class=\"js-quick-comment-focus quick-comment-entryunit__hidden-el\" href=\"#\">_</a>\n        <div class=\"js-elem-bordercolor quick-comment-entryunit__text-wrap\">\n            <textarea\n                    id=\"body{{quickComments.itemId}}\"\n                    type=\"text\"\n                    lj-ml=\"talk.leavefastcomment\"\n                    lj-ml-attr=\"placeholder\"\n                    ng-focus=\"quickComments.onFocus()\"\n                    ng-blur=\"quickComments.onBlur()\"\n                    ng-model=\"quickComments.text\"\n                    ng-keydown=\"quickComments.key($event)\"\n                    ng-trim=\"false\"\n                    class=\"\n                    b-input\n                    b-input-max\n                    b-input-simple\n                    quick-comment-entryunit__text\n                    js-font-family\n                    js-font-color\n                    \"\n                    ng-class=\"{\'quick-comment-entryunit__text--focus\': quickComments.shouldBeExpanded(),}\"\n            ></textarea>\n            <footer\n                    class=\"quick-comment-entryunit__footer-text\"\n            >\n                <div class=\"quick-comment-entryunit__warning\">\n                    <span\n                            lj-ml=\"talk.ipalert\"\n                            class=\"quick-comment-entryunit__logcommentips\"\n                    ></span>\n                </div>\n                <div\n                        ng-if=\"!quickComments.mobile\"\n                        class=\"quick-comment-entryunit__hint\">\n                    <span\n                            lj-ml=\"talk.linebreakalert\"\n                            class=\"quick-comment-entryunit__sendingtips\"\n                    ></span>\n                    <span\n                            lj-ml=\"talk.sendingalert\"\n                            class=\"quick-comment-entryunit__sendingtips\"\n                    ></span>\n                </div>\n            </footer>\n            <span class=\"quick-comment-entryunit__text-outline\"></span>\n            <ul class=\"quick-comment-entryunit__controls quick-comment-entryunit__controls-form\"><!--\n                --><li\n                    lj-svg-icon=\"flaticon--camera\"\n                    lj-ml=\"talk.insertphoto\"\n                    lj-ml-attr=\"title\"\n                    ng-mousedown=\"quickComments.onMediaButtonMousedown($event)\"\n                    ng-click=\"quickComments.addPhoto($event)\"\n                    class=\"\n                        quick-comment-entryunit__control\n                        quick-comment-entryunit__control--camera\n                        js-elem-color--svgicon\n                        \"\n            ></li><!--\n                --><li\n                    lj-svg-icon=\"flaticon--video-camera\"\n                    lj-ml=\"talk.insertvideo\"\n                    lj-ml-attr=\"title\"\n                    ng-mousedown=\"quickComments.onMediaButtonMousedown($event)\"\n                    ng-click=\"quickComments.addVideo($event)\"\n                    class=\"\n                        quick-comment-entryunit__control\n                        quick-comment-entryunit__control--video-camera\n                        js-elem-color--svgicon\n                        \"\n            ></li><!--\n                --><li\n                    lj-svg-icon=\"flaticon--userhead\"\n                    lj-ml=\"talk.insertusertag\"\n                    lj-ml-attr=\"title\"\n                    ng-mousedown=\"quickComments.onMediaButtonMousedown($event)\"\n                    ng-click=\"quickComments.addUsertag($event)\"\n                    class=\"\n                        quick-comment-entryunit__control\n                        quick-comment-entryunit__control--userhead\n                        js-elem-color--svgicon\n                        \"\n            ></li><!--\n            --></ul>\n        </div>\n            <div\n                class=\"\n                    b-watering-captchabox\n                    b-watering-captchabox-active\n                \"\n                id=\"captcha-container\"\n                ng-keydown=\"quickComments.onCaptchaKey($event)\"\n                ng-if=\"quickComments.shouldShowCaptchaContainer()\"\n                ></div>\n            <button\n                    ng-if=\"quickComments.mobile\"\n                    ng-click=\"quickComments.submit()\"\n                    class=\"\n                                b-flatbutton\n                                b-flatbutton-simple\n                                \"\n            >\n                <span lj-ml=\"talk.postcomment\"></span>\n                <div\n                        ng-if=\"quickComments.loading\"\n                        class=\"\n                                    quick-comment-entryunit__send\n                                    svgpreloader\n                                    svgpreloader-pseudo\n                                    svgpreloader-16\n                                \"\n                ></div>\n            </button>\n            <span\n                class=\"captcha-disclaimer\"\n                ng-if=\"quickComments.shouldShowCaptchaContainer()\"\n            >\n                <span class=\"captcha-disclaimer__notice\" lj-ml=\"recaptcha.invisible.notice\"></span><br>\n                <span class=\"captcha-disclaimer__term\" lj-ml=\"recaptcha.invisible.term\"></span>\n            </span>\n    </section>\n</form>\n<!-- /QUCIK COMMENT FORM -->\n';

//= require_ml talk.delete
//= require_ml talk.edit
//= require_ml talk.leavefastcomment
//= require_ml talk.insertphoto
//= require_ml talk.insertvideo
//= require_ml talk.insertusertag
//= require_ml talk.postcomment
//= require_ml talk.ipalert
//= require_ml talk.sendingalert
//= require_ml talk.linebreakalert
//= require_ml talk.anonuser
//= require_ml recaptcha.invisible.disclaimer
//= require_ml recaptcha.invisible.notice
//= require_ml recaptcha.invisible.term

(function (a) {
  return a;
})();

(function (moment) {
  'use strict'; //eslint-disable-line strict

  quickCommentCtrl.$inject = ['$scope', 'Api', '$timeout', 'Bubble', 'Ref', '$sce', 'Messages', '$rootScope', '$element', '$q'];
  quickComments.$inject = ['$templateCache', '$compile', '$timeout'];
  angular.module('LJ.QuickComments', ['LJ.Api', 'LJ.Bubble', 'ngSanitize', 'Photo.Editor', 'Video.Editor', 'BasicToolbar', 'LJ.Ref', 'LJ.Templates', 'LJ.Messages']);
  angular.module('LJ.QuickComments').controller('quickCommentCtrl', quickCommentCtrl).directive('ljQuickComments', quickComments);

  /**
   * quickCommentCtrl
   *
   * @name quickCommentCtrl
   * @function
   * @public
   * @param {object} $scope - local scope
   * @param {object} Api - LJ.Api
   * @param {function} $timeout - setTimeout
   * @param {object} Bubble - service
   * @param {object} Ref - reference registry
   * @param {object} $sce - ng sanitization evil
   */
  function quickCommentCtrl($scope, Api, $timeout, Bubble, Ref, $sce, Messages, $rootScope, $element, $q) {
    var vm = this;

    if (!LJ.Flags.isEnabled('quick_comment')) {
      return;
    }

    vm.key = onKey;
    vm.editComment = editComment;
    vm.deleteComment = deleteComment;
    vm.itemId = $scope.item.itemid;
    vm.journalId = $scope.item.journalid;
    vm.remote = LJ.get('remote');
    vm.statprefix = LJ.get('statprefix');
    vm.mobile = LJ.Support.isMobile() || !!~navigator.userAgent.toLowerCase().indexOf('android');
    vm.existArr = [];

    var mediaBubbleStatus = {};

    vm.mediaBubbleIsShown = function () {
      return Object.values(mediaBubbleStatus).some(function (status) {
        return status.shown;
      });
    };

    vm.shouldBeExpanded = function () {
      return vm.hasFocus || angular.isString(vm.text) && vm.text.length > 0 || vm.mediaBubbleIsShown();
    };

    // By Captcha libraries' code constraints and for better performance,
    // we can have only one Captcha active on the page.
    // That forces us to show Captcha only for a single currently active `quickComment` form
    // For tracking that, we use help of this field which every `quickComment` form owns
    vm.isLatestSelectedForm = false;

    vm.setCaretPositionAndFocus = function (caretPos) {
      var bareDOMEl = vm.$textarea[0];
      if (bareDOMEl !== null) {
        if (bareDOMEl.createTextRange) {
          var range = bareDOMEl.createTextRange();
          range.move('character', caretPos);
          range.select();
        } else {
          if (bareDOMEl.selectionStart) {
            bareDOMEl.focus();
            bareDOMEl.setSelectionRange(caretPos, caretPos);
          } else {
            bareDOMEl.focus();
          }
        }
      }
    };

    vm.insertIntoTextareaAndMoveCaret = function (insert) {
      if (angular.isUndefined(vm.text)) {
        vm.text = insert;
        $timeout(function () {
          return vm.setCaretPositionAndFocus(vm.text.length);
        });
      } else {
        (function () {
          var caret = vm.$textarea.prop('selectionStart');
          vm.text = vm.text.substr(0, caret) + insert + vm.text.substring(caret);
          $timeout(function () {
            return vm.setCaretPositionAndFocus(caret + insert.length);
          });
        })();
      }
    };

    var bubbleBtnComponents = [{
      name: 'video',
      addFnName: 'addVideo',
      template: 'video.ng.tmpl',
      onInsert: function onInsert(insert) {
        return vm.setCaretPositionAndFocus(vm.$textarea.val().indexOf(insert) + insert.length);
      },

      additional: function additional(cmpnt) {
        angular.element('#body' + vm.itemId).attr('id', 'body'); // change textarea's ID to body for proper embed code generation
        $scope.$on('bubble:close:' + cmpnt.name,
        /**
         * onClose
         *
         * @name onClose
         * @function
         * @public
         */
        function onClose() {
          $timeout(function () {
            angular.element('#body').attr('id', 'body' + vm.itemId); // change textarea's ID back
            Ref.remove('videoUploader');
          }, 100);
        });
      }
    }, {
      name: 'photouploader',
      addFnName: 'addPhoto',
      template: 'photo.ng.tmpl',
      onResponse: function onResponse(data) {
        vm.insertIntoTextareaAndMoveCaret(data[0]);
      }
    }, {
      name: 'user',
      addFnName: 'addUsertag',
      template: 'user.html',
      onResponse: function onResponse(data) {
        var usertag = '<lj user="' + data.ljuser.username + '" />';
        vm.insertIntoTextareaAndMoveCaret(usertag);
      }
    }];

    bubbleBtnComponents.forEach(function (cmpnt) {
      var name = cmpnt.name,
          unregName = 'unreg' + name[0].toUpperCase() + name.slice(1) + 'BtnBubble';

      mediaBubbleStatus[name] = {
        shown: false,
        name: name
      };

      var SLIGHT_DELAY = 100;

      $scope.$on('bubble:close:' + name, function () {
        $timeout(function () {
          return mediaBubbleStatus[name].shown = false;
        }, SLIGHT_DELAY);
      });
      $scope.$on('bubble:open:' + name, function () {
        if (vm.expectingBubbleOpen) {
          mediaBubbleStatus[name].shown = true;
          vm.expectingBubbleOpen = false;
        }
      });

      vm[cmpnt.addFnName] = function (click) {
        LJ.Event.off(name + '_response');
        vm[unregName] && vm[unregName]();
        var $tempScope = $rootScope.$new();
        vm[unregName] = Bubble.register({
          name: name,
          template: cmpnt.template,
          recalculateOnScroll: !vm.mobile,
          disableResizeListener: vm.mobile,
          recalculateOnOrientationChange: vm.mobile
        }, $tempScope);
        $timeout(function () {
          // Work around issue of broken element hierarchy
          // of SVG element in IE
          var target = click.target;
          if (target.correspondingUseElement) {
            target = target.correspondingUseElement;
          }
          vm.expectingBubbleOpen = true;
          Bubble.open(name, {}, angular.element(target).closest('.quick-comment-entryunit__control'));
        });
        LJ.Event.on(name + '_response', cmpnt.onResponse || function () {});
        LJ.Event.on(name + '_htmlMode_response', cmpnt.onInsert || function () {});
        if (angular.isFunction(cmpnt.additional)) {
          cmpnt.additional(cmpnt);
        }
        // If we don't do that now, `blur` will happen on any following click,
        // which may collapse the textarea and hence displace the bubble,
        // preventing corresponding user action
        $timeout(vm.onBlur, SLIGHT_DELAY);
      };
    });

    // Prevents `blur` of `textarea`.
    // Is needed for stable opening of media bubbles.
    // In some cases, if we don't prevent the event
    // when clicking on media bubble button,
    // misclick will surely happen
    vm.onMediaButtonMousedown = function (e) {
      return e.preventDefault();
    };

    /**
     * editComment
     *
     * @name editComment
     * @function
     * @public
     */
    function editComment(comment) {
      vm.commentIsBeingEdited = true;
      vm.editable = comment;
      vm.text = comment.text;
      $timeout(function () {
        return vm.$textarea.focus();
      });
    }

    function exitEditModeAndCleanAll() {
      vm.commentIsBeingEdited = false;
      delete vm.editable;
      vm.preview = '';
      vm.text = '';
    }
    vm.exitEditModeAndCleanAll = exitEditModeAndCleanAll;

    /**
     * deleteComment
     *
     * @name deleteComment
     * @function
     * @public
     */
    function deleteComment(comment) {
      vm.loading = true;
      Api.call('comment.delete', {
        journal_id: vm.journalId, //eslint-disable-line camelcase
        dtalkid: comment.dtalkid
      }).then(
      /**
       * handleAnswer
       *
       * @name handleAnswer
       * @function
       * @public
       * @param {object} status - server response
       */
      function handleAnswer(status) {
        vm.loading = false;
        if (status.success) {
          $timeout(
          /**
           * postpone
           * to pass digest loop cycle
           *
           * @name postpone
           * @function
           * @public
           */
          function postpone() {
            $scope.$apply(function assignData() {
              if (vm.editable === comment) {
                exitEditModeAndCleanAll();
              }
              vm.existArr.splice(vm.existArr.indexOf(comment), 1);
              $scope.item.reply_count--;
            });
          }, 0);
        }
      });
    }

    function presentErrorMessageFrom(response) {
      var body = '' + response.message;
      if (response.data) {
        body += ' \u2014 ' + response.data.error;
      }
      Messages.error({ body: body });
    }

    function sendEdited(comment) {
      vm.loading = true;
      checkPreview().then(function _sendEdited() {
        Api.call('comment.edit', {
          journal_id: vm.journalId, //eslint-disable-line camelcase
          dtalkid: comment.dtalkid,
          body: vm.text.toString()
        }, {
          silent: true
        }).then(function handleAnswer() {
          vm.loading = false;
          $timeout(function postpone() {
            $scope.$apply(function assignData() {

              angular.extend(comment, {
                text: vm.text,
                preview: $sce.trustAsHtml(vm.preview),
                datetime: moment().format('YYYY-MM-DD HH:mm:ss'),
                date: moment().format('MMMM DD YYYY, HH:mm')
              });
              exitEditModeAndCleanAll();
            });
            vm.$textarea.trigger('blur');
          }, 0);
        }, function handleError(response) {
          vm.loading = false;
          presentErrorMessageFrom(response);
        });
      });
    }

    function captchaSuccess() {
      vm.send();
    }
    (function (a) {
      return a;
    })();

    // This code expects only Invisible reCAPTCHA,
    // Doesn't show much, only prepares container and popup.
    // Challenge popup may be shown later after call to `LJ.Captcha.execute`


    vm.showCaptcha = function () {
      var options = arguments.length <= 0 || arguments[0] === undefined ? { captchaContainerId: 'captcha-container' } : arguments[0],
          captchaParams = {
        lang: 'ru',
        theme: 'clean',
        size: 'invisible',
        callback: captchaSuccess
      },
          $captchaContainer = $element.find('#' + options.captchaContainerId).eq(0),
          captchaContainerEmpty = $captchaContainer.html() === '';


      if (captchaContainerEmpty || !angular.isNumber(vm.captchaWidgetId)) {
        return LJ.Captcha.create(options.captchaContainerId, captchaParams).then(function (captchaWidgetId) {
          vm.captchaWidgetId = captchaWidgetId;
        });
      } else {
        LJ.Captcha.reload(vm.captchaWidgetId);
        return $q.defer().resolve();
      }
    };

    vm.shouldShowCaptchaContainer = function () {
      if (!vm.isLatestSelectedForm) return false;
      return vm.captchaEnabledForItem || vm.captchaRequestedByServer;
    };

    vm.submitHelper = function (event) {
      if (event) {
        event.preventDefault(); // don't add new line
      }
      if (!vm.text) return;
      if (vm.commentIsBeingEdited) {
        if (vm.text.toString() === vm.editable.text.toString()) {
          vm.$textarea.blur();
          return vm.exitEditModeAndCleanAll();
        }
        return sendEdited(vm.editable);
      } else {
        return send();
      }
    };

    /**
     * onKey
     *
     * @name onKey
     * @function
     * @public
     * @param {object} event - key event
     */
    function onKey(event) {
      if (vm.loading) {
        event.preventDefault();
        return;
      }
      if (event.keyCode === 13) {
        // Enter
        if (event.shiftKey || vm.mobile) {
          return;
        }
        vm.submitHelper(event);
      }
      if (vm.commentIsBeingEdited && event.keyCode === 27) {
        // ESC
        return restoreFromBackup();
      }
    }

    /**
     * restoreFromBackup
     *
     * @name restoreFromBackup
     * @function
     * @public
     */
    function restoreFromBackup() {
      vm.commentIsBeingEdited = false;
      vm.text = '';
    }

    vm.send = send;
    vm.submit = vm.submitHelper;

    /**
     * checkPreview
     *
     * @name checkPreview
     * @function
     * @public
     * @return {promise} comment.preview response
     */
    function checkPreview() {
      return Api.call('comment.preview', { body: vm.text }).then(
      /**
       * handlePreview
       *
       * @name handlePreview
       * @function
       * @public
       * @param {object} data - server response
       */
      function handlePreview(data) {
        if (data.status === 'OK' && angular.isString(data.preview)) {
          vm.preview = data.preview;
        }
      });
    }

    vm.passedCaptchaTest = function () {
      if (!vm.shouldShowCaptchaContainer()) {
        return true;
      }
      return LJ.Captcha.getResponse(vm.captchaWidgetId) !== '';
    };

    function collectCaptchaData() {
      return {
        'g-recaptcha-response': LJ.Captcha.getResponse(vm.captchaWidgetId)
      };
    }

    vm.focusOnLastPreviewComment = function () {
      var $target = $element.find('.js-quick-comment-focus'),
          destroyHrefWatch = $scope.$watch(function () {
        return $target.attr('href');
      }, function (val) {
        if (angular.isDefined(val)) {
          $target.focus();
          destroyHrefWatch();
        }
      });
      // Have that tricky watch because Angular can
      // at some time later do stuff on <a/>,
      // rendering any current focus()'ing useless
    };

    function send() {
      if (!vm.passedCaptchaTest()) {
        return LJ.Captcha.execute(vm.captchaWidgetId);
      }
      vm.loading = true;
      checkPreview().then(function addCommentXHR() {
        var paramObject = {
          journal_id: vm.journalId, //eslint-disable-line camelcase
          ditemid: vm.itemId,
          body: vm.text.toString()
        };
        if (vm.shouldShowCaptchaContainer()) {
          angular.extend(paramObject, collectCaptchaData());
        }
        Api.call('comment.add', paramObject, {
          silent: true
        }).then(function handleAnswer(status) {
          vm.loading = false;
          if (status.success) {
            vm.captchaRequestedByServer = false;
            $timeout(function postpone() {
              vm.isLatestSelectedForm = false;
              $scope.$apply(function assignData() {
                vm.existArr.push({
                  text: vm.text,
                  preview: $sce.trustAsHtml(vm.preview),
                  datetime: moment().format('YYYY-MM-DD HH:mm:ss'),
                  date: moment().format('MMMM DD YYYY, HH:mm'),
                  dtalkid: status.comment.dtalkid
                });
                vm.preview = '';
                vm.text = '';
              });
              vm.$textarea.trigger('blur');
              vm.focusOnLastPreviewComment();
              $scope.item.reply_count++;
            }, 0);
          }
          if (status.counter_image_url) {
            LJ.Stat.addCounter(status.counter_image_url);
          }
        }, function handleError(response) {
          vm.loading = false;
          if (response.data && response.data.wrong_captcha) {
            vm.captchaRequestedByServer = true;
            $timeout(function () {
              vm.showCaptcha().then(function () {
                LJ.Captcha.execute(vm.captchaWidgetId);
              });
            });
            // Don't show message for "no Captcha" error
            return;
          }
          presentErrorMessageFrom(response);
        });
      });
    }

    function getExtraCommentingInfo() {
      $q.all([Api.call('comment.is_log_comment_ips', { journalid: vm.journalId }, {
        silent: true
      }), Api.call('comment.is_need_captcha', { journalid: vm.journalId, itemid: vm.itemId }, {
        silent: true
      })]).then(function (response) {
        vm.logsCommentIps = response[0].is_log_comment_ips;
        vm.captchaEnabledForItem = response[1].is_need_captcha;
        vm.gotExtraCommentingInfo = true;
        if (vm.isLatestSelectedForm && vm.captchaEnabledForItem) {
          $timeout(vm.showCaptcha);
        }
      });
    }

    // Added complexity due to restriction of not more than one ReCaptcha element on page
    vm.onFocus = function () {
      vm.hasFocus = true;
      if (vm.isLatestSelectedForm) {
        return;
      }
      $rootScope.$broadcast('quickcommentform:gotFocus', vm.itemId);
    };
    vm.onBlur = function () {
      return vm.hasFocus = false;
    };

    var gotFocusListener = $rootScope.$on('quickcommentform:gotFocus', function (eventProperties, activeItemId) {
      vm.isLatestSelectedForm = vm.itemId === activeItemId;

      if (vm.commentIsBeingEdited) return;
      if (vm.isLatestSelectedForm) {
        if (!vm.gotExtraCommentingInfo) {
          getExtraCommentingInfo();
        } else {
          if (vm.captchaEnabledForItem) {
            $timeout(vm.showCaptcha);
          }
        }
      }
    });
    $rootScope.$on('$destroy', gotFocusListener);
  }

  /**
   * quickComments
   *
   * @name quickComments
   * @function
   * @public
   * @param {object} $templateCache - templates
   * @param {function} $compile - ng compiler
   * @return {object} directive factory
   */
  function quickComments($templateCache, $compile, $timeout) {
    return {
      controllerAs: 'quickComments',
      controller: 'quickCommentCtrl',
      link: linkFn
    };

    /**
     * linkFn
     *
     * @name linkFn
     * @function
     * @public
     * @param {object} scope - local scope
     * @param {object} elem - html element
     */
    function linkFn(scope, elem, attr, ctrl) {
      // Checking if the feature is enabled
      if (!LJ.Flags.isEnabled('quick_comment')) {
        return;
      }
      // Checking if author allows quick comments for the post
      if (!scope.item.show_quick_comments) {
        return;
      }
      var isPromo = angular.isDefined(scope.item.is_promo) && (scope.item.is_promo === true || Number(scope.item.is_promo) === 1);
      if (isPromo) {
        var isSitePromo = scope.item.promo_type === 'site';
        // Yes, no quick comments for site promos — it is a business rule
        if (isSitePromo) return;
      }
      elem.html($compile($templateCache.get('quickComments.ng.tmpl'))(scope));
      // Wait for compilation
      $timeout(function () {
        ctrl.$textarea = elem.find('.quick-comment-entryunit__content textarea');
      });
    }
  }
  /*global moment*/
})(moment);
/* <<< file end: js/feed/quickComments.js */

//# map link was there [quickComments.js.map]
/* >>> file start: js/feed/promoControl.js */
//= require js/core/angular/api.js

Site.page.template['angular/widgets/feedPromo/promoControl.ng.tmpl'] = '<span\n    class=\"feedpromo-control\"\n    >\n    <span\n        class=\"feedpromo-control__title\"\n        lj-ml=\"feedpromo.complaint.title\"\n        >\n        </span>\n    <span\n        class=\"feedpromo-control__items\"\n        >\n        <span\n            class=\"\n                feedpromo-control__item\n                feedpromo-control__item--why\n                \"\n            lj-ml=\"feedpromo.complaint.help\"\n            ></span>\n        <span\n            ng-if=\"promoControl.profileInfo\"\n            class=\"\n                feedpromo-control__item\n                feedpromo-control__item--hide\n                \"\n            lj-ml=\"feedpromo.complaint.hide\"\n            ng-click=\"promoControl.showComplaintForm()\"\n            ></span>\n        <span\n            class=\"\n                feedpromo-control__item\n                feedpromo-control__item--buy\n                \"\n            lj-ml=\"feedpromo.complaint.buy\"\n            ></span>\n    </span>\n</span>\n';
Site.page.template['angular/widgets/feedPromo/complaintForm.ng.tmpl'] = '<div\n    class=\"\n        feedpromo-complaint\n        feedpromo-complaint--hidden\n        \"\n    ng-class=\"{\'feedpromo-complaint--hidden\': !complaintForm.shown()}\"\n    >\n    <form class=\"feedpromo-complaint__form\">\n        <span\n            class=\"feedpromo-complaint__close\"\n            ng-click=\"complaintForm.hide()\"\n            ><svg class=\"svgicon\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\" width=\"30px\" height=\"30px\" viewBox=\"0 0 30 30\"><polygon points=\"30,2.728 27.272,0 15,12.273 2.727,0 0,2.728 12.272,15 0,27.273 2.727,30 15,17.728 27.272,30 30,27.273 17.727,15\"></polygon></svg></span>\n        <h3\n            class=\"feedpromo-complaint__title\"\n            lj-ml=\"feedpromo.complaint.popup.title\"\n            ></h3>\n        <fieldset class=\"form__field\">\n            <label class=\"form__label\">\n                <input\n                    class=\"\n                        radio\n                        custom--label-input\n                        \"\n                    id=\"reason-1\"\n                    type=\"radio\"\n                    name=\"complaint\"\n                    value=\"1\"\n                    ng-model=\"complaintForm.reason\"\n                    >\n                <span\n                    class=\"\n                        custom--label\n                        custom--label-huge\n                        custom--label-blue\n                        custom--label-bold\n                        \"\n                    for=\"reason-1\"\n                    lj-ml=\"feedpromo.complaint.reason.1\"\n                    ></span>\n            </label>\n        </fieldset>\n        <fieldset class=\"form__field\">\n            <label class=\"form__label\">\n                <input\n                    class=\"\n                        radio\n                        custom--label-input\n                        \"\n                    id=\"reason-2\"\n                    type=\"radio\"\n                    name=\"complaint\"\n                    value=\"2\"\n                    ng-model=\"complaintForm.reason\"\n                    >\n                <span\n                    class=\"\n                        custom--label\n                        custom--label-huge\n                        custom--label-blue\n                        custom--label-bold\n                        \"\n                    for=\"reason-2\"\n                    lj-ml=\"feedpromo.complaint.reason.2\"\n                    ></span>\n            </label>\n        </fieldset>\n        <fieldset class=\"form__field\">\n            <label class=\"form__label\">\n                <input\n                    class=\"\n                        radio\n                        custom--label-input\n                        \"\n                    id=\"reason-3\"\n                    type=\"radio\"\n                    name=\"complaint\"\n                    value=\"3\"\n                    ng-model=\"complaintForm.reason\"\n                    >\n                <span\n                    class=\"\n                        custom--label\n                        custom--label-huge\n                        custom--label-blue\n                        custom--label-bold\n                        \"\n                    for=\"reason-3\"\n                    lj-ml=\"feedpromo.complaint.reason.3\"\n                    ></span>\n            </label>\n        </fieldset>\n        <button\n            class=\"\n                flatbutton\n                flatbutton--max\n                flatbutton--bold\n                flatbutton--large\n                flatbutton--neutral-blue\n                \"\n            ng-click=\"complaintForm.complain()\"\n            lj-ml=\"feedpromo.complaint.delete\"\n            ></button>\n    </form>\n</div>\n';
Site.page.template['angular/widgets/feedPromo/closedPromo.ng.tmpl'] = '<div\n    class=\"feedpromo-closed\"\n    lj-ml=\"feedpromo.complaint.hidden\"\n    ></div>\n';

//= require_ml feedpromo.complaint.title
//= require_ml feedpromo.complaint.buy
//= require_ml feedpromo.complaint.help
//= require_ml feedpromo.complaint.hide
//= require_ml feedpromo.complaint.popup.title
//= require_ml feedpromo.complaint.delete
//= require_ml feedpromo.complaint.reason.1
//= require_ml feedpromo.complaint.reason.2
//= require_ml feedpromo.complaint.reason.3
//= require_ml feedpromo.complaint.hidden

(function (a) {
  return a;
})();

(function () {
  'use strict';

  complaintService.$inject = ['$compile', '$templateCache', 'Api'];
  promoControlController.$inject = ['complaintService', 'Api'];
  complaintFormController.$inject = ['complaintService'];
  feedPromoControlDirective.$inject = ['complaintService'];
  feedPromoClickDirective.$inject = ['$window'];
  angular.module('Feedpromo.Control', ['LJ.Api', 'LJ.Templates']);
  angular.module('Feedpromo.Control').run(function () {
    angular.element('[ng-app]').append('<div promo-complaint-form></div>');
  }).factory('complaintService', complaintService).controller('promoControlCtrl', promoControlController).controller('complaintFormCtrl', complaintFormController).directive('feedPromoControl', feedPromoControlDirective).directive('feedPromoClick', feedPromoClickDirective).directive('promoComplaintForm', complaintFormDirective);

  function feedPromoClickDirective($window) {
    // prevent double count statistic
    var sended = {};

    return {
      link: link,
      scope: {
        promoId: '=feedPromoClickPromoId',
        journalId: '=feedPromoClickJournalId',
        // No redirects after registering a click
        noRedirects: '=feedPromoClickNoRedirects'
      }
    };

    function link(scope, element) {
      element
      // responsible only for left mouse button clicks
      .on('click', function (event) {
        if (scope.noRedirects || event.metaKey || event.ctrlKey) {
          sendStats.call(scope);
        } else {
          sendStats.call(scope, true, event);
        }
      })
      // responsible only for middle and right mouse button clicks
      .on('mousedown', function (event) {
        if (event.which !== 1) {
          sendStats.call(scope);
        }
      }).on('keydown', function (event) {
        if (event.keyCode === 13) {
          sendStats.call(scope, true, event);
        }
      });

      function sendStats(controlRedirection, event) {
        if (!this.promoId || !this.journalId) {
          return;
        }

        var uniq = this.journalId + '-' + this.promoId;
        if (sended.hasOwnProperty(uniq)) {
          return;
        }

        if (controlRedirection) {
          event.preventDefault();
        }

        sended[uniq] = true;
        LJ.Api.call('friendsfeed.add_promo_stat', {
          journal: this.journalId,
          promoid: this.promoId,
          type: 'click'
        }).done(function () {
          if (controlRedirection) {
            $window.location.href = element.attr('href');
          }
        });
      }
    }
  }

  function feedPromoControlDirective(complaintService) {
    return {
      link: link,
      scope: {
        promoId: '=feedPromoControlPromoId',
        itemId: '=feedPromoControlItemId',
        journalId: '=feedPromoControlJournalId',
        entrySelector: '@feedPromoControlEntrySelector'
      },
      templateUrl: 'promoControl.ng.tmpl',
      controller: promoControlController,
      controllerAs: 'promoControl'
    };

    function link(scope, el, attr, ctrl) {
      ctrl.setParams({
        promoId: scope.promoId,
        itemId: scope.itemId,
        journalId: scope.journalId
      });
      complaintService.addElement(scope.promoId, el.closest(scope.entrySelector));
    }
  }

  function promoControlController(complaintService, Api) {
    var vm = this;

    vm.profileInfo = Site.remote;
    vm.showComplaintForm = function () {
      return complaintService.showForm(vm.params);
    };
    vm.setParams = function (params) {
      vm.params = params;

      if (vm.params.journalId && vm.params.promoId) {
        Api.call('friendsfeed.add_promo_stat', {
          journal: vm.params.journalId,
          promoid: vm.params.promoId,
          type: 'view'
        }, {
          silent: true
        });
      }
    };
  }

  function complaintFormDirective() {
    return {
      templateUrl: 'complaintForm.ng.tmpl',
      controller: complaintFormController,
      controllerAs: 'complaintForm'
    };
  }
  (function (a) {
    return a;
  })();

  function complaintFormController(complaintService) {
    var vm = this;
    vm.reason = 1;
    vm.shown = complaintService.formShown;
    vm.complain = function () {
      return complaintService.complain(vm.reason);
    };
    vm.hide = complaintService.hideForm;
  }

  function complaintService($compile, $templateCache, Api) {
    var promoId = void 0,
        itemId = void 0,
        journalId = void 0,
        complaintFormShown = false,
        closedElement = $compile($templateCache.get('closedPromo.ng.tmpl'))({}),
        elementCache = {};


    function addElement(id, element) {
      elementCache[id] = element;
    }

    function showForm(params) {
      promoId = params.promoId;
      itemId = params.itemId;
      journalId = params.journalId;

      complaintFormShown = true;
    }

    function hideForm() {
      complaintFormShown = false;
    }

    function complain(reason) {
      hideForm();
      replacePromo();

      Promise.all([Api.call('friendsfeed.complain_promo', {
        reason: reason,
        promoid: promoId
      }), Api.call('friendsfeed.hide_promo', {
        journal: journalId,
        itemid: itemId,
        promoid: promoId
      })]);
    }

    function replacePromo() {
      var originalEl = elementCache[promoId];
      originalEl.replaceWith(closedElement);
    }
    return {
      formShown: function formShown() {
        return complaintFormShown;
      },
      showForm: showForm,
      hideForm: hideForm,
      complain: complain,
      addElement: addElement
    };
  }
})();
/* <<< file end: js/feed/promoControl.js */

//# map link was there [promoControl.js.map]
/* >>> file start: js/ljShareButton.js */
Site.page.template['angular/ljShareButton.ng.tmpl'] = '<span\n    target=\"_blank\"\n    class=\"b-sharethis-services-link\"\n    ng-click=\"LJShareButtonCtrl.onClick()\"\n    ng-class=\"{\n      \'b-sharethis-services-link--reposted\': LJShareButtonCtrl.reposted,\n      \'b-sharethis-services-link--disabled\': LJShareButtonCtrl.disabled(),\n      \'b-sharethis-services-link--loading\': LJShareButtonCtrl.loading\n    }\"\n>\n    <span\n      class=\"b-sharethis-services-link__icon-wrap\"\n    >\n        <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"svgicon flaticon flaticon--livejournal b-sharethis-services-link__icon\">\n            <use ng-href=\"#flaticon--livejournal\" xlink:href=\"\"></use>\n        </svg>\n    </span>\n    <span\n      class=\"b-sharethis-services-link__title\"\n    >{{title}}</span>\n</span>';
//= require js/core/angular/api.js

LJShareButtonCtrl.$inject = ['$scope', 'Api'];
angular.module('LJShareButtonModule', ['LJ.Api', 'LJ.Directives', 'LJ.Templates']).directive('ljShareButton', ljShareButtonDirective);

function LJShareButtonCtrl($scope, Api) {
  var vm = this;
  vm.reposted = false;

  vm.loading = true;

  Api.call('repost.get_status', { url: $scope.entryUrl }, function (data) {
    vm.reposted = !!data.reposted;
    vm.loading = false;
  });

  var entryAuthor = ($scope.entryUrl.match(/https?:\/\/([^\.]+)/) || [])[1],
      nonRootPathPart = $scope.entryUrl.split('/').length === 5;

  if (entryAuthor === 'users' && nonRootPathPart) {
    // Username contains dashes or underlines. We should get it different way
    entryAuthor = $scope.entryUrl.split('/')[3];
  }
  entryAuthor = entryAuthor.replace('-', '_');

  vm.disabled = function () {
    if (LJ.get('preview')) {
      return true;
    }
    if (!LJ.get('remoteUser')) {
      return true;
    }
    if (LJ.get('remote_is_identity')) {
      return true;
    }
    if (LJ.get('remoteUser') === entryAuthor) {
      return true;
    }
    return false;
  };

  vm.onClick = function () {
    if (vm.disabled()) {
      return;
    }

    var args = {
      url: $scope.entryUrl
    };

    if (vm.reposted) {
      Api.call('repost.delete', args, function () {
        vm.reposted = false;
        LJ.Event.trigger('afterRepostDelete', {
          postURL: $scope.entryUrl
        });
      });
    } else {
      args.timezone = LJ.Util.Date.timezone();
      Api.call('repost.create', args, function () {
        vm.reposted = true;
      });
    }
  };
}

function ljShareButtonDirective() {
  return {
    controller: LJShareButtonCtrl,
    controllerAs: 'LJShareButtonCtrl',
    restrict: 'A',
    scope: {
      entryUrl: '@ljShareButton',
      title: '@ljShareButtonTitle'
    },
    templateUrl: 'ljShareButton.ng.tmpl',
    link: function link($scope, element, $attrs) {}
  };
}
/* <<< file end: js/ljShareButton.js */

//# map link was there [ljShareButton.js.map]
/* >>> file start: js/feed/feed.v3.js */
var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

//= require js/node_modules/angular-route/angular-route.js

//= require js/node_modules/ng-infinite-scroll/build/ng-infinite-scroll.js
//= require js/core/angular/ljMemories.js
//= require js/core/angular/ljEmbed.js
//= require js/core/angular/share.js
//= require js/core/angular/api.js
//= require js/core/angular/options.js
//= require js/core/angular/ljTour.js
//= require js/core/angular/ljRemoveRepost.js
//!= require js/core/angular/common.js

//= require js/discovery/directives.js
//= require js/discovery/menu.js
//= require js/discovery/settings.js

//= require js/widgets/likus.js

//= require js/feed/feedWidget.js
//= require js/feed/rss.js
//= require js/feed/quickComments.js

//= require js/feed/promoControl.js
//= require js/ljShareButton.js

Site.page.template['angular/feed/item.ng.tmpl'] = '<article\n    ng-repeat-start=\"item in items\"\n    lj-feed-item=\"{ ditemid: item.itemid, journal: item.journal_username, promoid: item.is_promo ? item.promoid : \'\', adid: item.is_ad ? item.adid : \'\', title: item.subject }\"\n    lj-screenable=\"social:widgets:parse\"\n    lj-embed-resizer\n    ng-class=\"{\n        \'js--addmem-open\': toollbarActive,\n        \'entryunit--feedpromo\': item.is_ad,\n        \'entryunit--feedpromobeta\': isEnabledFeedPromoBeta && item.is_promo,\n        \'entryunit--feedpromo-entry\': item.is_promo && item.promo_type === \'entry\',\n        \'entryunit--feedpromo-site\': item.is_promo && item.promo_type === \'site\'\n        }\"\n    ng-cloak\n    ng-style=\"{ display: (isEnabledFeedPromoBeta && item.is_promo) ? \'none\' : \'auto\' }\"\n\n    class=\"\n        entryunit\n        entryunit--feed\n        js-elem-bordercolor\n        js-emojis\n        \"\n    >\n    <!-- userpic -->\n    <div\n        class=\"entryunit__userpic\"\n        ng-show=\"item.userpic_present\"\n        >\n        <img\n            ng-attr-width=\"item.userpic_width\"\n            ng-attr-height=\"item.userpic_height\"\n            class=\"ContextualPopup\"\n            alt=\"\"\n            ng-src=\"{{item.userpic_url}}\"\n            >\n    </div>\n\n    <!-- meta -->\n    <div class=\"entryunit__meta meta-entryunit\">\n\n        <!-- items -->\n        <ul class=\"meta-entryunit__items\">\n            <li\n                class=\"\n                    meta-entryunit__item\n                    meta-entryunit__item--partner\n                    \"\n                ng-if=\"item.is_partner\"\n                ><!--\n                --><span class=\"entryunit__partner\"><!--\n                    --><span class=\"partnermaterial\" lj-ml=\"entryunit.label.partner\"></span><!--\n                --></span><!--\n            --></li>\n\n            <li class=\"meta-entryunit__item\"><!--\n                --><span\n                    class=\"\n                        entryunit__author\n                        author-entryunit\n                        js-elem-color\n                        \"\n                    lj-html=\"item.entry_title\"\n                    ></span><!--\n            --></li>\n\n            <TMPL_UNLESS is_reposted>\n                <li\n                    class=\"meta-entryunit__item\"\n                    ng-if=\"!item.is_promo\"\n                    ><!--\n                    --><time\n                        class=\"\n                            entryunit__date\n                            js-elem-color\n                            \"\n                        ng-show=\"{{!item.is_reposted}}\"\n                        ng-bind=\"item.timestamp\"\n                        datetime=\"<TMPL_VAR time>\"\n                        ></time><!--\n                 --></li>\n                <li\n                    class=\"\n                        meta-entryunit__item\n                        meta-entryunit__item--ratingpos\n                        js-elem-color--a\n                        entry-rating\n                        \"\n                    ng-if=\"!item.is_promo && item.rating_position\"\n                    ><!--\n                    --><a\n                        ng-href=\"{{feed.siteroot}}/ratings/?country=appropriate\"\n                        class=\"entryunit__ratingpos\"\n                        >\n                        <span\n                            lj-svg-icon=\"flaticon--crown\"\n                            ng-if=\"item.rating_position <=3\"\n                            ></span>\n                        <span\n                            lj-svg-icon=\"flaticon--star\"\n                            ng-if=\"item.rating_position > 3 && item.rating_position <=100\"\n                            ></span>\n                        <span\n                            lj-ml=\"post.view-userpanel.rating_position\"\n                            lj-ml-resolve=\"{position: item.rating_position}\"\n                            ></span>\n                        </a><!--\n                 --></li>\n            </TMPL_UNLESS>\n\n            <li\n                ng-show=\"item.is_ad\"\n                ng-attr-data-adid=\"item.adid\"\n                class=\"meta-entryunit__item labels-entryunit__wrap--feedpromo\"\n                >\n                <span\n                    class=\"\n                        labels-entryunit__item\n                        labels-entryunit__item--feedpromo\n                        \"\n                    >\n                    <span lj-ml=\"friendsfeed.note.ad\"></span>\n                    <span\n                        ng-click=\"feed.removeAd(item.adid)\"\n                        ng-show=\"feed.isLoggedIn\"\n                        lj-svg-icon=\"flaticon--cross\"\n                        class=\"\n                            labels-entryunit__buttonclose\n                            i-friendsfeed-ad-close\n                            \"\n                        ></span>\n                </span>\n            </li>\n\n            <li\n                class=\"\n                    meta-entryunit__item\n                    meta-entryunit__item--feedpromo\n                    \"\n                ng-if=\"item.is_promo\"\n                >\n                <span\n                    class=\"entryunit__feedpromo\"\n                    feed-promo-control\n                    feed-promo-control-promo-id=\"item.promoid\"\n                    feed-promo-control-item-id=\"item.itemid\"\n                    feed-promo-control-journal-id=\"item.journalid\"\n                    feed-promo-control-entry-selector=\".entryunit\"\n                    ></span>\n            </li>\n        </ul>\n\n    </div>\n\n    <!-- header -->\n    <header class=\"entryunit__head\">\n        <h3 class=\"entryunit__title\"><!--\n            --><ul\n                class=\"entryunit__types types-entryunit\"\n                ng-if=\"item.show_security || item.is_reposted\"\n                ><!--\n                --><li\n                    class=\"\n                        types-entryunit__item\n                        js-elem-color--svgicon\n                        types-entryunit__item--security-{{item.security}}\n                        \"\n                    ng-show=\"item.show_security\"\n                    ng-class=\"getSecurityStyle(item)\"\n                    ng-attr-title=\"item.security_description\"\n                    ><!--\n                    --><span ng-switch=\"item.security\">\n                        <span\n                            lj-svg-icon=\"flaticon--security-protected\"\n                            ng-switch-when=\"friends\"\n                            ></span>\n                        <span\n                            lj-svg-icon=\"flaticon--security-private\"\n                            ng-switch-when=\"private\"\n                            ></span>\n                        <span\n                            lj-svg-icon=\"flaticon--security-custom\"\n                            ng-switch-when=\"friendgroups\"\n                            ></span>\n                    </span><!--\n                --></li><!--\n                --><li\n                    class=\"\n                        types-entryunit__item\n                        types-entryunit__item--repost\n                        js-elem-color--svgicon\n                        \"\n                    ng-show=\"item.is_reposted\"\n                    ><!--\n                    --><span lj-svg-icon=\"flaticon--repost\"></span><!--\n                --></li><!--\n            --></ul><!--\n            --><a\n                feed-promo-click\n                feed-promo-click-promo-id=\"item.promoid\"\n                feed-promo-click-journal-id=\"item.journalid\"\n                ng-href=\"{{item.permalink_url}}\"\n                lj-html=\"item.subject\"\n                class=\"js-link-color\"\n                ></a><!--\n        --></h3>\n        <div\n            class=\"mdspost-brief--feed\"\n            ng-if=\"item.lead\"\n            lj-html=\"item.lead\">\n        </div>\n        <div\n            class=\"mdspost-editor--feed\"\n            ng-if=\"item.lead\"\n            lj-ml=\"talk.editor\">\n        </div>\n    </header>\n\n    <!-- content -->\n    <div\n        class=\"\n            entryunit__body\n            js-font-family\n            js-font-color\n            \"\n        >\n        <img\n            class=\"entryunit__promoimage\"\n            ng-if=\"item.image && item.is_promo\"\n            ng-src=\"{{item.image}}\"\n            >\n\n        <img ng-src=\"{{item.image}}\" ng-if=\"item.image && !item.is_promo\">\n\n        <div\n            class=\"entryunit__text\"\n            lj-discovery-tags\n            lj-html=\"item.body\"\n            ng-class=\"{\n                \'post2017 post2017--feed\': item.post_version\n            }\"\n            ></div>\n        <span ng-if=\"item.fb_id\">\n            <br>\n            <a\n                href=\"{{feed.siteroot}}/support/faq/429.html\"\n                lj-ml=\"facebookdigest.migration.tag.from_facebook\"\n                ></a>\n        </span>\n    </div>\n\n    <!-- meta -->\n    <div class=\"entryunit__meta\">\n        <ul\n            class=\"\n                entryunit__tagscurrents\n                tagscurrents-entryunit\"\n            ng-show=\"{{item.mood_present || item.music_present || item.location_present || item.tags_present}}\"\n            >\n\n            <li\n                ng-show=\"item.mood_present\"\n                class=\"\n                    tagscurrents-entryunit__item\n                    tagscurrents-entryunit__item--mood\n                    \"\n                >\n                <dl class=\"tagscurrents-entryunit__list\">\n                    <dt\n                        class=\"\n                            tagscurrents-entryunit__label\n                            js-elem-color\"\n                        ng-class=\"{\'b-lenta-metatoggle-target\': toggleMeta(item) }\"\n                        lj-ml=\"friendsfeed.metaitem.mood\"\n                        ></dt>\n                    <dd\n                        class=\"tagscurrents-entryunit__content\"\n                        ng-bind=\"item.mood\"\n                        ></dd>\n                </dl>\n            </li>\n\n            <li\n                ng-show=\"item.music_present\"\n                class=\"\n                    tagscurrents-entryunit__item\n                    tagscurrents-entryunit__item--music\n                    \"\n                >\n                <dl class=\"tagscurrents-entryunit__list\">\n                    <dt\n                        class=\"\n                            tagscurrents-entryunit__label\n                            js-elem-color\"\n                        ng-class=\"{\'b-lenta-metatoggle-target\': toggleMeta(item) }\"\n                        lj-ml=\"friendsfeed.metaitem.music\"\n                        ></dt>\n                    <dd\n                        class=\"tagscurrents-entryunit__content\"\n                        lj-html=\"item.music\"\n                        ></dd>\n                </dl>\n            </li>\n\n            <li\n                ng-show=\"item.location_present\"\n                class=\"\n                    tagscurrents-entryunit__item\n                    tagscurrents-entryunit__item--location\n                    \"\n                >\n                <dl class=\"tagscurrents-entryunit__list\">\n                    <dt\n                        class=\"\n                            tagscurrents-entryunit__label\n                            js-elem-color\"\n                        ng-class=\"{\'b-lenta-metatoggle-target\': toggleMeta(item) }\"\n                        lj-ml=\"friendsfeed.metaitem.location\"\n                        ></dt>\n                    <dd\n                        class=\"tagscurrents-entryunit__content\"\n                        lj-html=\"item.location\"\n                        ></dd>\n                </dl>\n            </li>\n\n            <li\n                ng-show=\"item.tags_present\"\n                class=\"\n                    tagscurrents-entryunit__item\n                    tagscurrents-entryunit__item--tags\n                    \"\n                >\n                <dl class=\"tagscurrents-entryunit__list\">\n                    <dt\n                        class=\"\n                            tagscurrents-entryunit__label\n                            js-elem-color\"\n                        ng-class=\"{\'b-lenta-metatoggle-target\': toggleMeta(item) }\"\n                        lj-html=\"item.meta_tags_title\"\n                        ></dt>\n                    <dd class=\"tagscurrents-entryunit__content\">\n                        <a\n                            ng-repeat-start=\"tag in item.tags\"\n                            class=\"tagscurrents-entryunit__tag\"\n                            ng-href=\"{{tag.link}}\"\n                            ng-bind=\"tag.name\"\n                            ></a><!--\n                        --><span ng-repeat-end ng-show=\"{{!$last}}\">, </span>\n                    </dd>\n                </dl>\n            </li>\n\n        </ul>\n\n    </div>\n\n    <!-- footer -->\n    <footer class=\"b-lenta-meta\">\n\n        <div class=\"entryunit__actions actions-entryunit\">\n\n            <ul class=\"actions-entryunit__items\">\n\n                <li\n                    ng-if=\"likesEnabledFor(item)\"\n                    class=\"actions-entryunit__item actions-entryunit__item--likes\"\n                    lj-likus\n                    lj-likus-journal=\"{{item.journalid}}\"\n                    lj-likus-item=\"{{item.itemid}}\"\n                    lj-likus-token=\"{{item.likes_signature}}\"\n                    lj-likus-uri=\"{{item.permalink_url}}\"\n                    ></li>\n\n                <li\n                    ng-show=\"item.reply_count > 0\"\n                    class=\"\n                        actions-entryunit__item\n                        actions-entryunit__item--comments\n                        js-elem-color--svgicon\n                        \"\n                    >\n                    <a ng-href=\"{{item.comments_url}}\">\n                        <span lj-svg-icon=\"flaticon--comments-read\"></span>\n                        <span\n                            class=\"actions-entryunit__text\"\n                            ng-bind=\"item.reply_count\"\n                            ><!--\n                            -->&nbsp;<!--\n                            --><span\n                                lj-ml=\"friendsfeed.link.comments2\"\n                                lj-ml-resolve=\"{count: item.reply_count}\"\n                                ></span>\n                        </span>\n                    </a>\n                </li>\n\n                <li\n                    ng-show=\"item.posting_comments_allowed\"\n                    class=\"\n                        actions-entryunit__item\n                        actions-entryunit__item--reply\n                        js-elem-color--svgicon\n                        \"\n                    >\n                    <a ng-href=\"{{item.reply_url}}\">\n                        <span lj-svg-icon=\"flaticon--comments-add\"></span>\n                        <span\n                            class=\"actions-entryunit__text\"\n                            lj-ml=\"friendsfeed.link.reply\"\n                            ></span>\n                    </a>\n                </li>\n\n            </ul>\n\n        </div>\n\n        <div\n            class=\"\n                entryunit__controls\n                controls-entryunit\n                js-elem-bgcolor\n                js-elem-bordercolor\n                js-sticky-container\n                \"\n            >\n\n            <ul\n                class=\"\n                    controls-entryunit__items\n                    js-sticky-controls\n                    \"\n                lj-sticky\n                stick-to-screen-top-class=\"js--scrolling\"\n                sticky-bottom-stop-class=\"js--scrolling-stop\"\n                sticky-no-subcontainer=\"true\"\n                sticky-top-offset=\"-10\"\n                >\n\n                <li\n                    ng-repeat=\"link in item.linkbar | filter: { active: true }\"\n                    class=\"\n                        controls-entryunit__item\n                        controls-entryunit__item--{{link.css_class}}\n                        js-elem-color--svgicon\"\n                    ng-class=\"getActionLinkStyle(link)\"\n                    >\n\n                    <a\n                        ng-attr-title=\"link.name\"\n                        ng-href=\"{{link.url}}\"\n                        ng-attr-id=\"link.id\"\n                        ng-if=\"link.type == \'delete_repost\'\"\n                        lj-remove-repost=\"item\"\n                        class=\"\n                            controls-entryunit__link\n                            delete-repost\n                            js-elem-bordercolor--before-color\n                            js-entry-bgcolor--after-color\n                            \"\n                        >\n                        <span\n                            ng-class=\"getActionLinkStyle(link)\"\n                            ng-show=\"isSettingsEnabled\"\n                            lj-svg-icon=\"{{link.svg_icon_name}}\"\n                            class=\"controls-entryunit__icon\"\n                            ></span>\n                        <span\n                            class=\"\n                                controls-entryunit__tooltip\n                                js-entry-bgcolor\n                                js-elem-bordercolor\n                                \"\n                            ng-bind=\"link.name\"\n                            ></span>\n                    </a>\n\n                    <a\n                        ng-attr-title=\"link.name\"\n                        ng-class=\"addmem\"\n                        ng-href=\"{{link.url}}\"\n                        ng-attr-id=\"link.id\"\n                        ng-if=\"link.type == \'memories\'\"\n                        lj-memories=\"options\"\n                        class=\"\n                            controls-entryunit__link\n                            js-elem-bordercolor--before-color\n                            js-entry-bgcolor--after-color\n                            \"\n                        >\n                        <span\n                            ng-class=\"getActionLinkStyle(link)\"\n                            ng-show=\"isSettingsEnabled\"\n                            lj-svg-icon=\"{{link.svg_icon_name}}\"\n                            class=\"controls-entryunit__icon\"\n                            ></span>\n                        <span\n                            ng-bind=\"link.name\"\n                            class=\"\n                                controls-entryunit__tooltip\n                                js-entry-bgcolor\n                                js-elem-bordercolor\n                                \"\n                            ></span>\n                    </a>\n\n                    <a\n                        ng-attr-title=\"link.name\"\n                        ng-attr-id=\"link.id\"\n                        href=\"javascript:void(0)\"\n                        ng-if=\"link.type == \'share\'\"\n                        lj-share=\"{\n                            url:      link.data_url,\n                            title:    link.data_title,\n                            text:     link.data_text,\n                            hashtags: link.data_hashtags,\n                            alwaysBottom: true\n                        }\"\n                        lj-share-scrollable\n                        class=\"\n                            controls-entryunit__link\n                            js-elem-bordercolor--before-color\n                            js-entry-bgcolor--after-color\n                            \"\n                        >\n                        <span\n                            ng-class=\"getActionLinkStyle(link)\"\n                            ng-show=\"isSettingsEnabled\"\n                            lj-svg-icon=\"{{link.svg_icon_name}}\"\n                            class=\"controls-entryunit__icon\"\n                            ></span>\n                        <span\n                            ng-bind=\"link.name\"\n                            class=\"\n                                controls-entryunit__tooltip\n                                js-entry-bgcolor\n                                js-elem-bordercolor\n                                \"\n                            ></span>\n                    </a>\n\n                    <a\n                        ng-attr-title=\"link.name\"\n                        ng-class=\"track\"\n                        ng-href=\"{{link.url}}\"\n                        ng-attr-id=\"link.id\"\n                        ng-if=\"link.type == \'track\'\"\n                        class=\"\n                            controls-entryunit__link\n                            js-elem-bordercolor--before-color\n                            js-entry-bgcolor--after-color\n                            \"\n                        >\n                        <span\n                            ng-class=\"getActionLinkStyle(link)\"\n                            ng-show=\"isSettingsEnabled\"\n                            lj-svg-icon=\"{{link.svg_icon_name}}\"\n                            class=\"controls-entryunit__icon\"\n                            ></span>\n                        <span\n                            ng-bind=\"link.name\"\n                            class=\"\n                                controls-entryunit__tooltip\n                                js-entry-bgcolor\n                                js-elem-bordercolor\n                                \"\n                            ></span>\n                    </a>\n\n                    <a\n                        ng-attr-title=\"link.name\"\n                        ng-class=\"editentry\"\n                        ng-href=\"{{link.url}}\"\n                        ng-attr-id=\"link.id\"\n                        ng-if=\"link.type == \'edit\'\"\n                        class=\"\n                            controls-entryunit__link\n                            js-elem-bordercolor--before-color\n                            js-entry-bgcolor--after-color\n                            \"\n                        >\n                        <span\n                            ng-class=\"getActionLinkStyle(link)\"\n                            ng-show=\"isSettingsEnabled\"\n                            lj-svg-icon=\"{{link.svg_icon_name}}\"\n                            class=\"controls-entryunit__icon\"\n                            ></span>\n                        <span\n                            ng-bind=\"link.name\"\n                            class=\"\n                                controls-entryunit__tooltip\n                                js-entry-bgcolor\n                                js-elem-bordercolor\n                                \"\n                            ></span>\n                    </a>\n\n                    <a\n                        ng-attr-title=\"link.name\"\n                        ng-class=\"flag\"\n                        ng-href=\"{{link.url}}\"\n                        ng-attr-id=\"link.id\"\n                        ng-if=\"link.type == \'content_flag\'\"\n                        class=\"\n                            controls-entryunit__link\n                            js-elem-bordercolor--before-color\n                            js-entry-bgcolor--after-color\n                            \"\n                        >\n                        <span\n                            ng-class=\"getActionLinkStyle(link)\"\n                            ng-show=\"isSettingsEnabled\"\n                            lj-svg-icon=\"{{link.svg_icon_name}}\"\n                            class=\"controls-entryunit__icon\"\n                            ></span>\n                        <span\n                            ng-bind=\"link.name\"\n                            class=\"\n                                controls-entryunit__tooltip\n                                js-entry-bgcolor\n                                js-elem-bordercolor\n                                \"\n                            ></span>\n                    </a>\n\n                </li>\n\n            </ul>\n\n        </div>\n\n        <div\n            lj-quick-comments\n            class=\"\n                entryunit__quick-comments\n                quick-comments-entryunit\n                \"\n            ></div>\n\n    </footer>\n\n</article>\n\n<!--  adaptive - less 970px -->\n\n<div\n    ng-if=\"$index === 2\"\n    class=\"ljsale ljsale--empty\"\n    lj-sale=\"adfox_mobile_inpost_listing_1\"\n    lj-sale-close-less=\"true\"\n    lj-sale-window-min=\"320\"\n    lj-sale-window-max=\"1000\"\n    lj-sale-listing=\"listing1\"\n    ng-cloak\n    ></div>\n\n<div\n    ng-if=\"$index === 5\"\n    class=\"ljsale ljsale--empty\"\n    lj-sale=\"adfox_inread_mobile_inpost\"\n    lj-sale-type=\"in-read\"\n    lj-sale-close-less=\"true\"\n    lj-sale-on-scroll=\"true\"\n    lj-sale-window-min=\"320\"\n    lj-sale-window-max=\"1000\"\n    ng-cloak\n    ></div>\n\n<div\n    ng-if=\"$index === 8\"\n    class=\"ljsale ljsale--empty\"\n    lj-sale=\"adfox_mobile_inpost_listing_2\"\n    lj-sale-close-less=\"true\"\n    lj-sale-on-scroll=\"true\"\n    lj-sale-window-min=\"320\"\n    lj-sale-window-max=\"1000\"\n    ng-cloak\n    ></div>\n\n<div\n    ng-if=\"$index === 11\"\n    class=\"ljsale ljsale--empty\"\n    lj-sale=\"adfox_mobile_inpost_listing_3\"\n    lj-sale-close-less=\"true\"\n    lj-sale-on-scroll=\"true\"\n    lj-sale-window-min=\"320\"\n    lj-sale-window-max=\"1000\"\n    ng-cloak\n    ></div>\n\n<div\n    ng-if=\"$index >= 14 && ($index + 1) % 3 === 0\"\n    class=\"ljsale ljsale--empty\"\n    lj-sale=\"adfox_mobile_inpost_listing_4\"\n    lj-sale-close-less=\"true\"\n    lj-sale-on-scroll=\"true\"\n    lj-sale-window-min=\"320\"\n    lj-sale-window-max=\"1000\"\n    ng-cloak\n    ></div>\n\n<div\n    class=\"ljsale ljsale-google ljsale--empty\"\n    lj-sale=\"google_mobile_inpost_feed\"\n    lj-sale-close-less=\"true\"\n    lj-sale-crop-sizes=\"true\"\n    lj-sale-window-min=\"320\"\n    lj-sale-window-max=\"1000\"\n    ng-if=\"$index >= 4 && ($index + 1) % 5 === 0\"\n    ng-cloak\n    ></div>\n\n<!--  desktop - more 970px -->\n<div\n    class=\"ljsale ljsale--empty\"\n    lj-sale=\"adfox_inread_inpost\"\n    lj-sale-type=\"in-read\"\n    lj-sale-custom-id=\"in_read\"\n    lj-sale-close-less=\"true\"\n    lj-sale-window-min=\"1001\"\n    lj-sale-window-max=\"9999\"\n    ng-if=\"$index === 4\"\n    ng-cloak\n    ></div>\n\n<div\n    class=\"ljsale ljsale--empty\"\n    lj-sale=\"adfox_100x240_inpost\"\n    lj-sale-on-scroll=\"true\"\n    lj-sale-window-min=\"1001\"\n    lj-sale-window-max=\"9999\"\n    ng-if=\"$index >= 9 && ($index + 1) % 10 === 0\"\n    ng-cloak\n    ></div>\n\n<div\n    class=\"ljsale ljsale-google ljsale--empty\"\n    lj-sale=\"google_video_feed\"\n    lj-sale-type=\"google_video_inline_267277916\"\n    lj-sale-close-less=\"true\"\n    lj-sale-window-min=\"1001\"\n    lj-sale-window-max=\"9999\"\n    ng-if=\"$index === 4\"\n    ng-cloak\n    ></div>\n\n<div\n    class=\"ljsale ljsale-google ljsale--empty\"\n    lj-sale=\"google_inpost_feed\"\n    lj-sale-on-scroll=\"true\"\n    lj-sale-crop-sizes=\"true\"\n    lj-sale-window-min=\"1001\"\n    lj-sale-window-max=\"9999\"\n    lj-sale-listing=\"{{($index + 1) / 10}}\"\n    ng-if=\"$index >= 9 && ($index + 1) % 10 === 0\"\n    ng-cloak\n    ></div>\n\n<div ng-repeat-end ></div>\n';

//= require_ml talk.editor

(function (a) {
  return a;
})();

(function ($) {
  'use strict';

  initOpener();

  /**
   * @module Feed
   * Functionality for friends feed
   * @author Georgii Kats (g.kats@rambler-co.ru)
   */
  angular.module('Feed', ['ngRoute', 'LJ.Api', 'LJ.Options', 'LJ.RemoveRepost', 'LJ.Memories', 'LJ.Share', 'LJ.Sale', 'Discovery.Tags', 'Discovery.Menu', 'Discovery.Settings', 'LJ.Tour', 'Feed.Widget', 'Feed.Rss', 'LJ.Directives', 'LJ.QuickComments', 'LJ.Likus', 'LJ.Embed', 'infinite-scroll', 'Feedpromo.Control', 'LJShareButtonModule']);

  angular.module('Feed').constant('BASE', location.pathname.match(/.*\/(feed|friendsfriends|friendsactivity|friends)/)[0]).constant('PAGE', location.pathname.match(/.*\/(feed|friendsfriends|friendsactivity|friends)/)[1]).config(config).factory('Browser', Browser).directive('ljNew', ljNew).directive('ljFeedItem', ljFeedItem).directive('ljEntryWidth', ljEntryWidth).controller('FeedCtrl', FeedCtrl);

  angular.element('body').on('click', '.b-lenta-msg-close', switchToOldFeed); // switch to old feed version on /feed

  /**
   * @ngdoc config
   */
  config.$inject = ['$routeProvider', '$locationProvider', 'BASE'];
  /**
   * config
   *
   * @name config
   * @function
   * @public
   * @param {object} $routeProvider - provides route service
   * @param {object} $locationProvider - provides location service
   */
  function config($routeProvider, $locationProvider, BASE) {
    $routeProvider.when(BASE + '/?', { resolve: { main: main } }).when(BASE + '/:group/?', { resolve: { group: group } }).when(BASE + '/view/:type/?', { resolve: { type: type } }).otherwise({ redirectTo: BASE });

    /**
     * @ngdoc route /?
     * @requires $location
     * @requires Browser
     */
    main.$inject = ['$location', 'Browser'];
    /**
     * main
     *
     * @name main
     * @function
     * @public
     * @param {object} $location - ng location wrapper
     * @param {object} Browser - Browser service
     */
    function main($location, Browser) {
      Browser.options.set({
        group: null,
        view: null,
        date: $location.search().date
      });
    }

    /**
     * @ngdoc route /:group/?
     * @requires $route
     * @requires $location
     * @requires Browser
     */
    group.$inject = ['$route', '$location', 'Browser'];
    /**
     * group
     *
     * @name group
     * @function
     * @public
     * @param {object} $route - ng route service
     * @param {object} $location - location ng wrapper
     * @param {object} Browser - Browser service
     */
    function group($route, $location, Browser) {
      Browser.options.set({
        group: $route.current.params.group,
        view: null,
        date: $location.search().date
      });
    }

    /**
     * @ngdoc route /view/:type/?
     * @requires $route
     * @requires $location
     * @requires Browser
     */
    type.$inject = ['$route', '$location', 'Browser'];
    /**
     * type
     *
     * @name type
     * @function
     * @public
     * @param {object} $route - route provider
     * @param {object} $location - location ng wrapper
     * @param {object} Browser - Browser service
     */
    function type($route, $location, Browser) {
      Browser.options.set({
        group: null,
        view: $route.current.params.type,
        date: $location.search().date
      });
    }

    $locationProvider.html5Mode({ enabled: true, requireBase: false });
  }

  /**
   * @ngdoc
   * @service Browser
   * @requires Options
   */
  Browser.$inject = ['Options'];
  /**
   * Browser
   *
   * @name Browser
   * @function
   * @public
   * @param {object} Options - options service
   * @return {object} service instance
   */
  function Browser(Options) {
    var options = Options.create({
      group: null,
      view: null,
      date: null
    }),
        factory = {};

    factory.options = options;

    return factory;
  }

  /**
   * @ngdoc
   * @directive ljNew
   * @requires $rootScope
   * @requires $window
   */
  ljNew.$inject = ['$rootScope', '$window'];
  /**
   * ljNew
   *
   * @name ljNew
   * @function
   * @public
   * @param {object} $rootScope - root scope object
   * @return {object} directive factory object
   */
  function ljNew($rootScope) {
    return { link: link };
    /**
     * link
     *
     * @name link
     * @function
     * @public
     * @param {object} $scope - local scope
     */
    function link($scope) {
      var unwatch = $rootScope.$on('button:news:update', update);

      $scope.loadNews = loadNews;
      $scope.count = null;
      $scope.$on('$destroy', unwatch);

      /**
       * loadNews
       *
       * @name loadNews
       * @function
       * @public
       */
      function loadNews() {
        $rootScope.$broadcast('news:append');
        $scope.count = null;
      }

      /**
       * update
       *
       * @name update
       * @function
       * @public
       * @param {object} event - button news update event
       * @param {number} value - news count number ?
       */
      function update(event, value) {
        $scope.count = value;
      }
    }
  }

  /**
   * @ngdoc
   * @directive ljFeedItem
   * @requires $parse
   */
  ljFeedItem.$inject = ['$parse', 'Api'];
  /**
   * ljFeedItem
   *
   * @name ljFeedItem
   * @function
   * @public
   * @param {object} $parse - parse service
   * @return {object} directive factory object
   */
  function ljFeedItem($parse, Api) {
    return {
      scope: true,
      link: link
    };

    /**
     * LJFeedItem
     *
     * @name link
     * @function
     * @public
     * @param {object} scope - local directive scope
     * @param {object} element - html element
     * @param {object} attrs - attributes of target element
     */
    function link(scope, element, attrs) {
      scope.options = $parse(attrs.ljFeedItem)(scope);
      scope.toggleMeta = toggleMeta;
      scope.getSecurityStyle = getSecurityStyle;
      scope.getActionLinkStyle = getActionLinkStyle;
      scope.toollbarActive = false;

      scope.$on('bubble:open', function (event, name, options, target) {
        if (element && target && $.contains(element.get(0), target.get(0))) {
          scope.toollbarActive = true;
        }
      });

      scope.$on('bubble:close', function () {
        scope.toollbarActive = false;
      });

      scope.isSettingsEnabled = LJ.Flags.isEnabled('friendsfeed_v3_settings');

      var documentDOM = angular.element(document);
      documentDOM.on('scroll', function (event) {
        if (scope.options.adid && element.is(':screenable') && !scope.options.adFired) {
          LJ.Api.call('friendsfeed.note_ad_view', { adid: scope.options.adid });
          scope.options.adFired = true;
        }
      });
    }

    /**
     * toggleMeta
     *
     * @name toggleMeta
     * @function
     * @public
     * @param {object} item - TODO add description
     * @return {boolean} TODO add description
     */
    function toggleMeta(item) {
      return item.mood_present + item.music_present + item.location_present + item.tags_present !== 1;
    }

    /**
     * getSecurityStyle
     *
     * @name getSecurityStyle
     * @function
     * @public
     * @param {object} item - TODO add description
     * @return {string} css class name
     */
    function getSecurityStyle(item) {
      return 'b-item-type-security-' + item.security;
    }

    /**
     * getActionLinkStyle
     *
     * @name getActionLinkStyle
     * @function
     * @public
     * @param {object} link - TODO add description
     * @return {string} css class name
     */
    function getActionLinkStyle(link) {
      return 'j-e-actions-item-' + link.css_class;
    }
  }

  /**
     * @ngdoc
     * @directive ljEntryWidth
     */
  /**
   * ljEntryWidth
   *
   * @name ljEntryWidth
   * @function
   * @public
   * @return {object} directive factory object
   */
  function ljEntryWidth() {
    return {
      scope: true,
      link: link
    };

    /**
     * ljEntryWidth
     *
     * @name link
     * @function
     * @public
     * @param {object} scope - local directive scope
     * @param {object} element - html element
     */
    function link(scope, element) {
      var newPosts = element.find('.post2017'),
          entryWidthClassNarrow = 'post2017--narrow',
          entryWidthNarrow = 650;

      scope.$watch(function () {
        newPosts = element.find('.post2017');
        return newPosts.length;
      }, function (newValue, oldValue) {
        setEntryWitdhClass();
      });

      setEntryWitdhClass();
      $(window).resize(LJ.Function.debounce(setEntryWitdhClass, 300));

      function setEntryWitdhClass() {
        if (!newPosts.length) {
          return;
        }

        var entryWidth = newPosts[0].clientWidth;

        if (entryWidth <= entryWidthNarrow) {
          newPosts.map(function () {
            $(this)[0].classList.add(entryWidthClassNarrow);
          });
        } else {
          newPosts.map(function () {
            $(this)[0].classList.remove(entryWidthClassNarrow);
          });
        }
      } // setEntryWitdhClass()
    }
  }

  /**
   * @ngdoc
   * @type controller
   * @requires $scope
   * @requires $rootScope
   * @requires $timeout
   * @requires $compile
   * @requires $location
   * @requires $sce
   * @requires Api
   * @requires $route
   * @requires Browser
   * @requires PAGE
   */
  FeedCtrl.$inject = ['$scope', '$rootScope', '$timeout', '$compile', '$location', '$sce', 'Api', '$route', 'Browser', 'PAGE'];
  /**
   * FeedCtrl
   *
   * @name FeedCtrl
   * @function
   * @public
   * @param {object} $scope - local scope
   * @param {object} $rootScope - global scope
   * @param {function} $timeout - setTimeout angular version
   * @param {function} $compile - angular compiler
   * @param {object} $location - location provider service
   * @param {object} $sce - safe HTML sanitizer ?
   * @param {object} Api - LJ Api service
   * @param {object} $route - route service
   * @param {object} Browser - Browser service instance
   * @param {string} PAGE  - constant
   */
  function FeedCtrl($scope, $rootScope, $timeout, $compile, $location, $sce, Api, $route, Browser, PAGE) {
    var unwatchNews,
        unwatchFeed,
        vm = this,
        $window = angular.element(window),
        classNames = { 'page-scroll-up': 'js--page-scroll-up' },
        $slide = angular.element('.l-flatslide-menu-controls'),
        options = {
      light: false,
      locked: false,
      requestOptions: LJ.get('currentRequest'),
      ids: LJ.get('entryUniqs') || [],
      mode: PAGE
    },
        $html = angular.element('html'),
        $body = angular.element('body'),
        months = LJ.get('months');

    vm.options = angular.extend({}, options);
    vm.isLoggedIn = Boolean(LJ.get('remote'));
    vm.siteroot = LJ.get('siteroot');
    vm.spinner = false;

    vm.feedRequests = {
      feed: 'friendsfeed.get_items',
      medius: 'medius.get_feed_items',
      friendsactivity: 'friendsfeed.friends_activity_feed_items'
    };

    vm.getFeed = vm.feedRequests[LJ.get('feed_type')];

    $scope.isEnabledLikes = LJ.Flags.isEnabled('likes'); //eslint-disable-line angular/controller-as
    $scope.isEnabledFeedPromoBeta = LJ.Flags.isEnabled('feed_promo_beta'); //eslint-disable-line angular/controller-as
    $scope.items = []; //eslint-disable-line angular/controller-as
    $scope.news = []; //eslint-disable-line angular/controller-as

    $scope.likesEnabledFor = function (item) {
      //eslint-disable-line angular/controller-as
      return LJ.Flags.isEnabled('likes')
      // Not a typo. If set to "0", this flag means
      // comments are disabled for this post,
      // and likes get disabled because of it.
      && item.show_quick_comments;
    };

    vm.asideToggle = asideToggle;
    /**
     * asideToggle
     *
     * @name asideToggle
     * @function
     * @public
     */
    function asideToggle() {
      $body.toggleClass('body-state-sidebar-opened');
    }

    $body.on('click', function (event) {
      if (!angular.element(event.target).parents('.l-flatslide-aside').length) {
        $body.toggleClass('body-state-sidebar-opened', false);
      }
    });

    vm.menu = {
      positions: {},
      mobileMenu: {
        isOpen: false,
        height: 0
      },
      isOpened: false,
      isInitialize: false,
      isViewable: true,
      isSettingEnable: LJ.get('remote') && LJ.Flags.isEnabled('friendsfeed_v3_settings') && LJ.get('journal.username') === LJ.get('remote.username'),
      isBubbleOpened: false,
      tab: 'filters',
      toggle: toggle,
      update: update
    };
    /**
     * update
     *
     * @name update
     * @function
     * @public
     */
    function update() {
      var filter = Browser.options.get('group') || Browser.options.get('view'),
          $items = angular.element('.l-flatslide-menu-item');

      angular.element('.l-flatslide-menu-item').removeClass('l-flatslide-menu-active');

      if (filter === null) {
        $items.first().addClass('l-flatslide-menu-active');
        return;
      }

      $items.filter(function (index, item) {
        return angular.element(item).data('filter') === filter;
      }).addClass('l-flatslide-menu-active');
    }

    /**
     * toggle
     *
     * @name toggle
     * @function
     * @public
     * @param {object} event - toggle event
     * @param {*} tab - TODO add description
     */
    function toggle(event, tab) {
      if (angular.isUndefined(event)) {
        // this is needed because angular interpret this incorrectly when calls method from template
        if (event.metaKey || event.ctrlKey) {
          return;
        }

        event.preventDefault();
      }

      if (vm.isBubbleOpened) {
        return;
      }

      if (angular.isUndefined(tab)) {
        vm.menu.isOpened = false;
        $scope.$evalAsync();
        return;
      }

      if (tab === vm.menu.tab && vm.menu.isOpened || !vm.menu.isOpened) {
        $timeout(function () {
          $html.toggleClass('html-hidden');
          $body.toggleClass('body-state-menu-opened');
          vm.menu.isOpened = !vm.menu.isOpened;
        });
      }

      vm.menu.tab = tab;
    }

    // init mobile menu
    var menuMobileControlTitle = angular.element('.m-aside-menu__title'),
        menuMobile = angular.element('.m-aside-menu__list'),
        menuMobileItem = menuMobile.find('.m-aside-menu__item');


    angular.forEach(menuMobileItem, function (item) {
      if (angular.element(item).data('active')) {
        menuMobileControlTitle.text(angular.element(item).text());
      }
    });

    // toggle mobile menu
    vm.mobileMenuToggle = function (toggleMenuFlag) {
      vm.menu.mobileMenu.isOpen = toggleMenuFlag;
      vm.menu.mobileMenu.height = vm.menu.mobileMenu.isOpen ? 'auto' : 0;
    };

    vm.isSidebarOpened = false;
    vm.toggleSidebar = toggleSidebar;
    /**
     * toggleSidebar
     *
     * @name toggleSidebar
     * @function
     * @public
     */
    function toggleSidebar() {
      vm.isSidebarOpened = !vm.isSidebarOpened;
    }

    vm.removeAd = removeAd;
    /**
     * removeAd
     *
     * @name removeAd
     * @function
     * @public
     * @param {string|number} id - Ads ID
     */
    function removeAd(id) {
      $scope.items.some(function (item, index) {
        if (item.adid === id) {
          Api.call('friendsfeed.ban_ad', { adid: id }).then(function () {
            $scope.items.splice(index, 1);
          });
          return true;
        } else {
          return false;
        }
      });
    }
    vm.loadNewsFeeds = loadNewsFeeds;
    /**
     * loadNewsFeeds
     * Load more feeds from server and insert into the feed
     *
     * @name loadNewsFeeds
     * @function
     * @public
     */
    function loadNewsFeeds() {
      var params;

      if (vm.options.locked) {
        return;
      }

      vm.options.locked = true;
      vm._timestamp = parseInt(vm._timestamp || Date.now() / 1000);

      params = _extends({}, vm.options.requestOptions, {
        skip: 0,
        after: vm._timestamp,
        showads: 0,
        mode: PAGE
      });

      return Api.call(vm.getFeed, params).then(function (response) {
        var cache, news;

        if (response.counter_image_url) {
          // insert counter image
          LJ.Stat.addCounter(response.counter_image_url);
        }

        vm._timestamp = response.time;

        cache = $scope.news.map(function (item) {
          return item.uniq;
        });

        news = response.items.filter(function (item) {
          return cache.indexOf(item.uniq) === -1;
        });

        news.forEach(function (item) {
          item.likes_signature = response.likes_signature; //eslint-disable-line camelcase
        });

        if (news && news.length) {
          Array.prototype.unshift.apply($scope.news, news);
          $rootScope.$broadcast('button:news:update', $scope.news.length);
        }
      })['finally'](function () {
        // .finally change to ['finally'] for jshint validation
        vm.options.locked = false;
      });
    }
    (function (a) {
      return a;
    })();

    /**
     * Load more feeds from server and insert into the feed
     */


    vm.loadFeeds = function () {
      var data;

      if (vm.options.locked || vm.options.empty) {
        return;
      }

      vm.spinner = true;
      vm.options.locked = true;
      data = angular.extend({}, vm.options.requestOptions, {
        skip: $scope.items.length,
        view: Browser.options.get('view')
      });

      delete data.filtermask;

      return Api.call(vm.getFeed, data).then(function (response) {
        var items,
            cached = $scope.items.map(function (item) {
          return item.is_promo ? null : item.uniq;
        });

        if (response.counter_image_url) {
          LJ.Stat.addCounter(response.counter_image_url);
        }

        if (response.items && response.items.length) {
          items = response.items.filter(function (item) {
            return cached.indexOf(item.uniq) === -1;
          }).map(function (item) {
            item.likes_signature = response.likes_signature;

            item.isReposted = item.is_reposted;
            delete item.is_reposted;

            return item;
          });

          var freshNonpromoPosts = items.filter(function (item) {
            return !item.is_promo;
          });
          if (freshNonpromoPosts.length < 3) {
            // Filtering out promo posts
            items = freshNonpromoPosts;
          }
        }

        if (items && items.length) {
          Array.prototype.push.apply($scope.items, items);
        } else {
          vm.options.empty = true;
        }

        vm.spinner = false;
        vm.options.locked = false;
      });
    };

    vm.checkNewFeed = checkNewFeed;
    /**
     * checkNewFeed
     *
     * @name checkNewFeed
     * @function
     * @public
     */
    function checkNewFeed() {
      $timeout(_loadNewsFeeds, (LJ.get('feed_timeout') || 15) * 1000);
    }
    /**
     * _loadNewsFeeds
     *
     * @name _loadNewsFeeds
     * @function
     * @private
     */
    function _loadNewsFeeds() {
      vm.loadNewsFeeds()['finally'](vm.checkNewFeed.bind(vm)); // .finally change to ['finally'] for jshint validation
    }

    vm.start = start;
    /**
     * start
     *
     * @name start
     * @function
     * @public
     */
    function start() {
      if (LJ.get('friendsfeed_settings.paging_type') === 'endless') {
        vm.loadFeeds().then(function () {
          // Save current time (time of initial page load)
          // so the first check for new posts in `loadNewsFeeds`
          // is done with correct timestamp
          vm._timestamp = parseInt(Date.now() / 1000);
          vm.checkNewFeed.bind(vm)();
        });
      } else {
        vm.loadNewsFeeds().then(vm.checkNewFeed.bind(vm));
      }
    }

    vm.reset = reset;
    /**
     * reset
     *
     * @name reset
     * @function
     * @public
     */
    function reset() {
      vm.options = angular.extend({}, options);
      $scope.items = []; //eslint-disable-line angular/controller-as
    }

    vm.formatDate = formatDate;
    /**
     * formatDate
     *
     * @name formatDate
     * @function
     * @public
     * @param {string|number} date - date value to parse from
     * @return {string} DD MM YY
     */
    function formatDate(date) {
      date = new Date(date);

      return date.getDate() + ' ' + months[date.getMonth()] + '  ' + date.getFullYear();
    }

    // Sticky aside feed menu
    // Todo: Take out in a directive
    var $window = angular.element(window),
        $document = angular.element(document),
        $asideMenu = angular.element('.js-menu-sticky'),
        offsetTop = 116,
        offsetBottom = 210,
        randomEntryOffset = 74,
        scrollBottom = 0,
        lastScrollTop = 0,
        offsetStateTop = 0,
        offsetStateBottom = 0;


    if ($asideMenu.length) {
      $window.on('scroll resize', function () {
        var asideMenuRect = $asideMenu[0].getBoundingClientRect(),
            menuOffsetBottom = asideMenuRect.bottom + randomEntryOffset,
            asideMenuHeight = $asideMenu[0].offsetHeight;

        scrollBottom = $document.height() - $window.height() - $window.scrollTop();

        if (asideMenuHeight + randomEntryOffset > $window.height()) {
          if ($window.scrollTop() > lastScrollTop) {
            if (menuOffsetBottom <= $window.height() && scrollBottom > offsetBottom) {
              // bottom fixed
              $asideMenu.css({ position: 'fixed', top: '', bottom: randomEntryOffset, marginTop: '' });
              offsetStateTop = $window.scrollTop() - offsetTop - (asideMenuHeight - asideMenuRect.bottom);
            } else if (menuOffsetBottom <= $window.height()) {
              // bottom offset
              $asideMenu.css({ position: 'fixed', top: '', bottom: offsetBottom + randomEntryOffset - scrollBottom, marginTop: '' });
              offsetStateTop = $window.scrollTop() - offsetTop - (asideMenuHeight - asideMenuRect.bottom);
            } else {
              // bottom
              $asideMenu.css({ position: 'static', top: '', bottom: '', marginTop: offsetStateBottom });
              offsetStateTop = offsetStateBottom;
            }
          } else {
            if (asideMenuRect.top >= 0 && $window.scrollTop() > offsetTop) {
              // top fixed
              $asideMenu.css({ position: 'fixed', top: 0, bottom: '', marginTop: 0 });
              offsetStateBottom = $window.scrollTop() - offsetTop - (asideMenuHeight - asideMenuRect.bottom);
            } else if (asideMenuRect.top >= 0) {
              // top offset
              $asideMenu.css({ position: 'static', top: '', bottom: '', marginTop: 0 });
              offsetStateBottom = 0;
            } else {
              // top
              $asideMenu.css({ position: 'static', top: '', bottom: '', marginTop: offsetStateTop });
              offsetStateBottom = offsetStateTop;
            }
          }
          lastScrollTop = $window.scrollTop();
        } else {
          if ($window.scrollTop() > offsetTop && scrollBottom + ($window.height() - asideMenuHeight) >= offsetBottom + randomEntryOffset) {
            // top
            $asideMenu.css({ position: 'fixed', top: 0, bottom: '', marginTop: '' });
          } else if ($window.scrollTop() > offsetTop) {
            // bottom offset
            $asideMenu.css({ position: 'fixed', top: '', bottom: offsetBottom + randomEntryOffset - scrollBottom, marginTop: '' });
          } else {
            // top offset
            $asideMenu.css({ position: 'static', top: '', bottom: '', marginTop: '' });
          }
        }
      });
    }

    $window.on('scroll', function () {
      $slide.toggleClass(classNames['page-scroll-up'], $window.scrollTop() > $window.height() && !vm.options.light);
    });

    LJ.Event.on('afterRepostDelete', function (eventData) {
      if (!eventData.postURL) {
        return;
      }
      var shouldRemoveSomeEntries = angular.element('article').toArray().some(function (articleNode) {
        var articleScope = angular.element(articleNode).scope();
        if (!articleScope) {
          return false;
        }
        var itemData = articleScope.item;
        if (!itemData) {
          return false;
        }
        return itemData.isReposted && itemData.permalink_url === eventData.postURL;
      });

      if (shouldRemoveSomeEntries) {
        $window[0].location.reload();
      }
    });

    /**
     * onScopeDestroy
     *
     * @name onScopeDestroy
     * @function
     * @public
     */
    function onScopeDestroy() {
      unwatchNews();
      unwatchFeed();
    }
    unwatchNews = $rootScope.$on('news:append', function () {
      if (LJ.get('friendsfeed_settings.paging_type') === 'pages') {
        location.search = 'skip=0';
        location.reload();
      }

      Array.prototype.unshift.apply($scope.items, $scope.news);
      $scope.news = []; //eslint-disable-line angular/controller-as
    });

    unwatchFeed = $rootScope.$on('feed:item:remove', function (event, id) {
      var index;
      if (LJ.get('friendsfeed_settings.paging_type') === 'endless') {
        index = $scope.items.findIndex(function (item) {
          return item.itemid === id;
        });

        $scope.items.splice(index, 1);
      } else {
        location.reload();
      }
    });

    $scope.$on('$destroy', onScopeDestroy);
    $scope.$watch(function () {
      return Browser.options.get('group') + Browser.options.get('view') + Browser.options.get('date');
    }, function (current, previous) {
      if (current !== previous) {
        if (LJ.get('friendsfeed_settings.paging_type') === 'pages' && previous !== 0) {
          location.reload();
          return;
        }

        vm.reset();
        vm.options.requestOptions.view = Browser.options.get('view');
        vm.options.requestOptions.group = Browser.options.get('group');
        vm.options.requestOptions.date = Browser.options.get('date');
        vm.currentDate = Browser.options.get('date') ? vm.formatDate(Browser.options.get('date')) : null;

        vm.menu.update();
        vm.start();
      }
    });
  }

  /**
   * switchToOldFeed
   *
   * @name switchToOldFeed
   * @function
   * @public
   * @param {object} e - event
   */
  function switchToOldFeed(e) {
    e.preventDefault();

    LJ.Api.call('friendsfeed.close_friendsfeed_line', {}, function () {
      angular.element('.b-lenta-msg').remove();
      angular.element('body').addClass('b-lenta-msg-hidden');
    });
  }

  /**
   * Message receiver for friends feed style setting
   */
  function initOpener() {
    /*eslint-disable angular/window-service*/
    if (window.opener) {
      angular.element(window).on('message', onMessage);
    }
    /*eslint-enable angular/window-service*/
  }

  /**
   * @function onMessage
   * @param {Object} e
   */
  function onMessage(e) {
    var style = null;

    e = e.originalEvent; // jQuery creates event wrapper for us
    if (e.origin !== LJ.get('siteroot')) {
      // facebook also sends us postMessage
      return;
    }
    if (style === null) {
      // find and cache needed style element
      style = angular.element('head > .b-lenta-preview');
    }
    if (style.length === 0) {
      // create element if it is not on the page
      style = angular.element('<style />', { type: 'text/css' });
      style.appendTo(angular.element('head'));
    }
    style.text(e.data); // update style
  }
})(jQuery);
/* <<< file end: js/feed/feed.v3.js */

//# map link was there [feed.v3.js.map]
